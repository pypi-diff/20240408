# Comparing `tmp/skypilot-nightly-1.0.0.dev20240406.tar.gz` & `tmp/skypilot-nightly-1.0.0.dev20240407.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot-nightly-1.0.0.dev20240406.tar", last modified: Sat Apr  6 10:40:31 2024, max compression
+gzip compressed data, was "skypilot-nightly-1.0.0.dev20240407.tar", last modified: Sun Apr  7 10:40:32 2024, max compression
```

## Comparing `skypilot-nightly-1.0.0.dev20240406.tar` & `skypilot-nightly-1.0.0.dev20240407.tar`

### file list

```diff
@@ -1,334 +1,334 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.242389 skypilot-nightly-1.0.0.dev20240406/
--rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    17604 2024-04-06 10:40:31.242389 skypilot-nightly-1.0.0.dev20240406/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    11447 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      640 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-06 10:40:31.242389 skypilot-nightly-1.0.0.dev20240406/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-06 10:40:27.000000 skypilot-nightly-1.0.0.dev20240406/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.174389 skypilot-nightly-1.0.0.dev20240406/sky/
--rw-r--r--   0 runner    (1001) docker     (127)     5368 2024-04-06 10:40:31.000000 skypilot-nightly-1.0.0.dev20240406/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.178389 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/common.py
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)      468 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)     3698 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)      225 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/adaptors/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.178389 skypilot-nightly-1.0.0.dev20240406/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (127)      536 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)   118820 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   220895 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.178389 skypilot-nightly-1.0.0.dev20240406/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.178389 skypilot-nightly-1.0.0.dev20240406/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5904 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (127)   186851 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.182389 skypilot-nightly-1.0.0.dev20240406/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (127)     1302 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    43129 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    30942 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)    30816 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)      955 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/cloud_registry.py
--rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)    12508 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    46892 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)    16680 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/paperspace.py
--rw-r--r--   0 runner    (1001) docker     (127)    11042 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.186389 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      411 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/cudo_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.186389 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)     5487 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7528 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/paperspace_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/runpod_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/vsphere_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.190389 skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/gcp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/oci_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/scp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/clouds/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    39960 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.190389 skypilot-nightly-1.0.0.dev20240406/sky/data/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   119221 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8213 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (127)    31094 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    54049 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.190389 skypilot-nightly-1.0.0.dev20240406/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.194389 skypilot-nightly-1.0.0.dev20240406/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (127)      782 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    36603 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/aws/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.194389 skypilot-nightly-1.0.0.dev20240406/sky/provision/azure/
--rw-r--r--   0 runner    (1001) docker     (127)      199 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4400 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/azure/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.194389 skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/
--rw-r--r--   0 runner    (1001) docker     (127)      676 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      327 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/cudo_machine_type.py
--rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/cudo_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    16137 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/docker_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.194389 skypilot-nightly-1.0.0.dev20240406/sky/provision/fluidstack/
--rw-r--r--   0 runner    (1001) docker     (127)      592 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/fluidstack/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/fluidstack/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8694 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/fluidstack/fluidstack_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/fluidstack/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.194389 skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (127)      579 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    58975 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/instance_setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.198389 skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)      653 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14212 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    32523 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9457 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     8635 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/network_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    52429 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/logging.py
--rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/metadata_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.198389 skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      553 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/provisioner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.198389 skypilot-nightly-1.0.0.dev20240406/sky/provision/runpod/
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/runpod/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      321 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/runpod/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/runpod/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/runpod/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.198389 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.202389 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/cls_api_client.py
--rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/cls_api_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      481 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/custom_script.py
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/id_generator.py
--rw-r--r--   0 runner    (1001) docker     (127)      914 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/metadata_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/service_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)      544 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/service_manager_factory.py
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/ssl_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/vapiconnect.py
--rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/vim_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      504 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/vsphere_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    60100 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.202389 skypilot-nightly-1.0.0.dev20240406/sky/serve/
--rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    28636 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/autoscalers.py
--rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    29231 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/load_balancer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/load_balancing_policies.py
--rw-r--r--   0 runner    (1001) docker     (127)    55329 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/replica_managers.py
--rw-r--r--   0 runner    (1001) docker     (127)    18317 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/serve_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    36822 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/serve_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/service.py
--rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/serve/service_spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.206389 skypilot-nightly-1.0.0.dev20240406/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-06 10:40:27.000000 skypilot-nightly-1.0.0.dev20240406/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.206389 skypilot-nightly-1.0.0.dev20240406/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (127)     9204 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11542 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (127)    35113 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    18759 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/log_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     4292 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/log_lib.pyi
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.206389 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.206389 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    18603 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    15645 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/command_runner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.210389 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (127)       94 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.210389 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (127)      112 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.210389 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.210389 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/scp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.214389 skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      349 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      224 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      531 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      658 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      565 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)     1144 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (127)     5586 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/skypilot_config.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.214389 skypilot-nightly-1.0.0.dev20240406/sky/spot/
--rw-r--r--   0 runner    (1001) docker     (127)     1358 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/spot/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1117 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/spot/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    25524 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/spot/controller.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.214389 skypilot-nightly-1.0.0.dev20240406/sky/spot/dashboard/
--rw-r--r--   0 runner    (1001) docker     (127)     2294 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/spot/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.214389 skypilot-nightly-1.0.0.dev20240406/sky/spot/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/spot/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.214389 skypilot-nightly-1.0.0.dev20240406/sky/spot/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     6247 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/spot/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (127)    25656 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/spot/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (127)    22487 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/spot/spot_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    31559 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/spot/spot_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    46443 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.218389 skypilot-nightly-1.0.0.dev20240406/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     7290 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/cudo-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/fluidstack-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     8872 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/kubernetes-ingress.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)      376 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9851 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/kubernetes-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/paperspace-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/runpod-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/sky-serve-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1218 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/spot-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/templates/vsphere-ray.yml.j2
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.218389 skypilot-nightly-1.0.0.dev20240406/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      590 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.222389 skypilot-nightly-1.0.0.dev20240406/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.222389 skypilot-nightly-1.0.0.dev20240406/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      849 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/cluster_yaml_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    18791 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/command_runner.pyi
--rw-r--r--   0 runner    (1001) docker     (127)    21754 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25413 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/controller_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4574 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      852 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/env_options.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.222389 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     9667 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/create_cluster.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/delete_cluster.sh
--rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/generate_kind_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/gpu_labeler.py
--rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     1173 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes_enums.py
--rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/resources_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/rich_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    20387 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      701 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.230389 skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    17604 2024-04-06 10:40:31.000000 skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9145 2024-04-06 10:40:31.000000 skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-06 10:40:31.000000 skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-04-06 10:40:31.000000 skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2326 2024-04-06 10:40:31.000000 skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        4 2024-04-06 10:40:31.000000 skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-06 10:40:31.230389 skypilot-nightly-1.0.0.dev20240406/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_api.py
--rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (127)     9599 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_serve_autoscaler.py
--rw-r--r--   0 runner    (1001) docker     (127)   207403 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (127)    17581 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_spot_serve.py
--rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_wheels.py
--rw-r--r--   0 runner    (1001) docker     (127)     3224 2024-04-06 10:40:23.000000 skypilot-nightly-1.0.0.dev20240406/tests/test_yaml_parser.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.887159 skypilot-nightly-1.0.0.dev20240407/
+-rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    17604 2024-04-07 10:40:32.887159 skypilot-nightly-1.0.0.dev20240407/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    11447 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      640 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-07 10:40:32.887159 skypilot-nightly-1.0.0.dev20240407/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-07 10:40:30.000000 skypilot-nightly-1.0.0.dev20240407/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.827160 skypilot-nightly-1.0.0.dev20240407/sky/
+-rw-r--r--   0 runner    (1001) docker     (127)     5368 2024-04-07 10:40:32.000000 skypilot-nightly-1.0.0.dev20240407/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.827160 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      468 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3698 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/adaptors/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.831159 skypilot-nightly-1.0.0.dev20240407/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (127)      536 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118820 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   221923 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.831159 skypilot-nightly-1.0.0.dev20240407/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.831159 skypilot-nightly-1.0.0.dev20240407/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5904 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (127)   186851 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.831159 skypilot-nightly-1.0.0.dev20240407/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (127)     1302 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    43129 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30942 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30816 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)      955 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/cloud_registry.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12508 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46892 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16680 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/paperspace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11042 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.835159 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      411 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.839159 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5487 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7528 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.839159 skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/clouds/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    39960 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.839159 skypilot-nightly-1.0.0.dev20240407/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   119221 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8213 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31094 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54049 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.843159 skypilot-nightly-1.0.0.dev20240407/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.843159 skypilot-nightly-1.0.0.dev20240407/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (127)      782 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36603 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/aws/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.843159 skypilot-nightly-1.0.0.dev20240407/sky/provision/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)      199 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4400 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/azure/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.843159 skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/
+-rw-r--r--   0 runner    (1001) docker     (127)      676 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      327 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16137 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/docker_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.843159 skypilot-nightly-1.0.0.dev20240407/sky/provision/fluidstack/
+-rw-r--r--   0 runner    (1001) docker     (127)      592 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/fluidstack/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8694 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.847159 skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (127)      579 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/instance_setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.847159 skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)      653 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14212 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32523 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9457 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8635 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    52429 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/logging.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/metadata_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.847159 skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      553 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/provisioner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.847159 skypilot-nightly-1.0.0.dev20240407/sky/provision/runpod/
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/runpod/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      321 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/runpod/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/runpod/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/runpod/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.847159 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/
+-rw-r--r--   0 runner    (1001) docker     (127)      788 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.851159 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      481 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 runner    (1001) docker     (127)      914 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)      544 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      504 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    60100 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.851159 skypilot-nightly-1.0.0.dev20240407/sky/serve/
+-rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30137 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/autoscalers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29231 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/load_balancer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55738 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/replica_managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/serve_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36837 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/serve_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/service.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/serve/service_spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.855159 skypilot-nightly-1.0.0.dev20240407/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-07 10:40:30.000000 skypilot-nightly-1.0.0.dev20240407/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.855159 skypilot-nightly-1.0.0.dev20240407/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9204 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11542 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35113 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18788 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/log_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4292 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.855159 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.855159 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18603 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15645 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.859159 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (127)       94 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.859159 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (127)      112 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.859159 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.859159 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.859159 skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      349 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      224 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      531 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      658 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      565 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)     1144 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5586 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/skypilot_config.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.863159 skypilot-nightly-1.0.0.dev20240407/sky/spot/
+-rw-r--r--   0 runner    (1001) docker     (127)     1358 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/spot/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1117 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/spot/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25524 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/spot/controller.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.863159 skypilot-nightly-1.0.0.dev20240407/sky/spot/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (127)     2294 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/spot/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.863159 skypilot-nightly-1.0.0.dev20240407/sky/spot/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/spot/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.863159 skypilot-nightly-1.0.0.dev20240407/sky/spot/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     6247 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/spot/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (127)    25656 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/spot/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22487 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/spot/spot_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31559 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/spot/spot_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46443 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.867159 skypilot-nightly-1.0.0.dev20240407/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     7290 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     8872 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)      376 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9851 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1218 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/spot-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.867159 skypilot-nightly-1.0.0.dev20240407/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      590 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.871159 skypilot-nightly-1.0.0.dev20240407/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.871159 skypilot-nightly-1.0.0.dev20240407/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18791 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/command_runner.pyi
+-rw-r--r--   0 runner    (1001) docker     (127)    21754 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25413 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/controller_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4574 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      852 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.871159 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9667 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/generate_kind_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1173 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/resources_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/rich_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20387 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      701 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.879159 skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    17604 2024-04-07 10:40:32.000000 skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9145 2024-04-07 10:40:32.000000 skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-07 10:40:32.000000 skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-04-07 10:40:32.000000 skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2326 2024-04-07 10:40:32.000000 skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        4 2024-04-07 10:40:32.000000 skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-07 10:40:32.875159 skypilot-nightly-1.0.0.dev20240407/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_api.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9599 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_serve_autoscaler.py
+-rw-r--r--   0 runner    (1001) docker     (127)   211200 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17581 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_spot_serve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_wheels.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3224 2024-04-07 10:40:27.000000 skypilot-nightly-1.0.0.dev20240407/tests/test_yaml_parser.py
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/LICENSE` & `skypilot-nightly-1.0.0.dev20240407/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/MANIFEST.in` & `skypilot-nightly-1.0.0.dev20240407/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/PKG-INFO` & `skypilot-nightly-1.0.0.dev20240407/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240406
+Version: 1.0.0.dev20240407
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/README.md` & `skypilot-nightly-1.0.0.dev20240407/README.md`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/pyproject.toml` & `skypilot-nightly-1.0.0.dev20240407/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/setup.py` & `skypilot-nightly-1.0.0.dev20240407/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """The SkyPilot package."""
 import os
 import subprocess
 from typing import Optional
 import urllib.request
 
 # Replaced with the current commit when building the wheels.
-_SKYPILOT_COMMIT_SHA = '48b8ca978e936412db757800b58450c19ae49976'
+_SKYPILOT_COMMIT_SHA = 'c65b258acfc34e852b92b55764cd874f1cd32f27'
 
 
 def _get_git_commit():
     if 'SKYPILOT_COMMIT_SHA' not in _SKYPILOT_COMMIT_SHA:
         # This is a release build, so we don't need to get the commit hash from
         # git, as it's already been set.
         return _SKYPILOT_COMMIT_SHA
@@ -31,15 +31,15 @@
             commit_hash += '-dirty'
         return commit_hash
     except Exception:  # pylint: disable=broad-except
         return _SKYPILOT_COMMIT_SHA
 
 
 __commit__ = _get_git_commit()
-__version__ = '1.0.0.dev20240406'
+__version__ = '1.0.0.dev20240407'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 
 # ---------------------- Proxy Configuration ---------------------- #
 def _set_http_proxy_env_vars() -> None:
     urllib_proxies = dict(urllib.request.getproxies())
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/adaptors/aws.py` & `skypilot-nightly-1.0.0.dev20240407/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/adaptors/azure.py` & `skypilot-nightly-1.0.0.dev20240407/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/adaptors/cloudflare.py` & `skypilot-nightly-1.0.0.dev20240407/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/adaptors/common.py` & `skypilot-nightly-1.0.0.dev20240407/sky/adaptors/common.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/adaptors/gcp.py` & `skypilot-nightly-1.0.0.dev20240407/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/adaptors/ibm.py` & `skypilot-nightly-1.0.0.dev20240407/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/adaptors/kubernetes.py` & `skypilot-nightly-1.0.0.dev20240407/sky/adaptors/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/adaptors/oci.py` & `skypilot-nightly-1.0.0.dev20240407/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/adaptors/vsphere.py` & `skypilot-nightly-1.0.0.dev20240407/sky/adaptors/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/authentication.py` & `skypilot-nightly-1.0.0.dev20240407/sky/authentication.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/backends/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/backends/backend.py` & `skypilot-nightly-1.0.0.dev20240407/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/backends/backend_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/backends/backend_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/backends/cloud_vm_ray_backend.py` & `skypilot-nightly-1.0.0.dev20240407/sky/backends/cloud_vm_ray_backend.py`

 * *Files 0% similar despite different names*

```diff
@@ -230,17 +230,18 @@
         self._code = [
             textwrap.dedent(f"""\
             import getpass
             import hashlib
             import io
             import os
             import pathlib
-            import sys
             import selectors
+            import shlex
             import subprocess
+            import sys
             import tempfile
             import textwrap
             import time
             from typing import Dict, List, Optional, Tuple, Union
 
             import ray
             import ray.util as ray_util
@@ -3012,14 +3013,15 @@
 
         remote_setup_file_name = f'/tmp/sky_setup_{self.run_timestamp}'
         # Need this `-i` option to make sure `source ~/.bashrc` work
         setup_cmd = f'/bin/bash -i {remote_setup_file_name} 2>&1'
 
         def _setup_node(node_id: int) -> None:
             setup_envs = task.envs.copy()
+            setup_envs.update(self._skypilot_predefined_env_vars(handle))
             setup_envs['SKYPILOT_SETUP_NODE_IPS'] = '\n'.join(internal_ips)
             setup_envs['SKYPILOT_SETUP_NODE_RANK'] = str(node_id)
             runner = command_runner.SSHCommandRunner(ip_list[node_id],
                                                      port=port_list[node_id],
                                                      **ssh_credentials)
             setup_script = log_lib.make_task_bash_script(setup,
                                                          env_vars=setup_envs)
@@ -4517,26 +4519,46 @@
             # object creation to sync local source syncing to the bucket. Local
             # source specified in Storage object is synced to the bucket only
             # when it is created with 'sky launch'.
             storage_mounts[dst] = storage_lib.Storage.from_metadata(
                 storage_metadata, sync_on_reconstruction=False)
         return storage_mounts
 
+    def _skypilot_predefined_env_vars(
+            self, handle: CloudVmRayResourceHandle) -> Dict[str, str]:
+        """Returns the SkyPilot predefined environment variables.
+
+        TODO(zhwu): Check if a single variable for all the cluster info is more
+        desirable or separate variables for each piece of info.
+        NOTE: In order to avoid complication in a potential future separation
+        of the info into multiple env vars, we should not treat this json format
+        as a sink for all the cluster info.
+        """
+        return {
+            'SKYPILOT_CLUSTER_INFO': json.dumps({
+                'cluster_name': handle.cluster_name,
+                'cloud': str(handle.launched_resources.cloud),
+                'region': handle.launched_resources.region,
+                'zone': handle.launched_resources.zone,
+            })
+        }
+
     def _get_task_env_vars(self, task: task_lib.Task, job_id: int,
                            handle: CloudVmRayResourceHandle) -> Dict[str, str]:
         """Returns the environment variables for the task."""
         env_vars = task.envs.copy()
         # If it is a managed spot job, the TASK_ID_ENV_VAR will have been
         # already set by the controller.
         if constants.TASK_ID_ENV_VAR not in env_vars:
             env_vars[
                 constants.TASK_ID_ENV_VAR] = common_utils.get_global_job_id(
                     self.run_timestamp,
                     cluster_name=handle.cluster_name,
                     job_id=str(job_id))
+        env_vars.update(self._skypilot_predefined_env_vars(handle))
         return env_vars
 
     def _execute_task_one_node(self, handle: CloudVmRayResourceHandle,
                                task: task_lib.Task, job_id: int,
                                detach_run: bool) -> None:
         # Launch the command as a Ray task.
         log_dir = os.path.join(self.log_dir, 'tasks')
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/backends/docker_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/backends/local_docker_backend.py` & `skypilot-nightly-1.0.0.dev20240407/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot-nightly-1.0.0.dev20240407/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/backends/wheel_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/benchmark/benchmark_state.py` & `skypilot-nightly-1.0.0.dev20240407/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/benchmark/benchmark_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/check.py` & `skypilot-nightly-1.0.0.dev20240407/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/cli.py` & `skypilot-nightly-1.0.0.dev20240407/sky/cli.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/cloud_stores.py` & `skypilot-nightly-1.0.0.dev20240407/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/aws.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/azure.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/cloud.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/cloud_registry.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/cudo.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/fluidstack.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/gcp.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/ibm.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/kubernetes.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/lambda_cloud.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/oci.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/paperspace.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/paperspace.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/runpod.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/runpod.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/scp.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/aws_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/azure_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/common.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/config.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/kubernetes_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/kubernetes_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/oci_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/paperspace_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/paperspace_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/scp_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/gcp_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/gcp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/lambda_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/oci_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/utils/scp_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/clouds/vsphere.py` & `skypilot-nightly-1.0.0.dev20240407/sky/clouds/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/core.py` & `skypilot-nightly-1.0.0.dev20240407/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/dag.py` & `skypilot-nightly-1.0.0.dev20240407/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/data/data_transfer.py` & `skypilot-nightly-1.0.0.dev20240407/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/data/data_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/data/mounting_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/data/storage.py` & `skypilot-nightly-1.0.0.dev20240407/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/data/storage_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/exceptions.py` & `skypilot-nightly-1.0.0.dev20240407/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/execution.py` & `skypilot-nightly-1.0.0.dev20240407/sky/execution.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/global_user_state.py` & `skypilot-nightly-1.0.0.dev20240407/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/optimizer.py` & `skypilot-nightly-1.0.0.dev20240407/sky/optimizer.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/aws/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/aws/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/aws/config.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/aws/instance.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/aws/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/aws/utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/azure/instance.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/azure/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/common.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/common.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/cudo_machine_type.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/cudo_wrapper.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/cudo_wrapper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/cudo/instance.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/cudo/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/docker_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/fluidstack/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/fluidstack/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/fluidstack/instance.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/fluidstack/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/config.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/constants.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/instance.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/gcp/instance_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/gcp/instance_utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -1019,14 +1019,16 @@
             response = (cls.load_resource().projects().locations().nodes().list(
                 parent=path).execute(num_retries=GCP_MAX_RETRIES))
         except gcp.http_error_exception() as e:
             # SKY: Catch HttpError when accessing unauthorized region.
             # Return empty dict instead of raising exception to not break.
             if 'is not found or access is unauthorized.' in str(e):
                 return {}
+            if 'Permission \'tpu.nodes.list\' denied on' in str(e):
+                return {}
             logger.debug(f'filter: googleapiclient.errors.HttpError: {e}')
             raise
 
         instances = response.get('nodes', [])
 
         # filter_expr cannot be passed directly to API
         # so we need to filter the results ourselves
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/instance_setup.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/instance_setup.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/config.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/instance.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/network.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/network.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/network_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/network_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/kubernetes/utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/kubernetes/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/logging.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/metadata_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/config.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/constants.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/instance.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/paperspace/utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/paperspace/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/provisioner.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/provisioner.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/runpod/instance.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/runpod/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/runpod/utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/runpod/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/cls_api_client.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/metadata_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/service_manager.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/ssl_helper.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/vapiconnect.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/common/vim_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/instance.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/provision/vsphere/vsphere_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/resources.py` & `skypilot-nightly-1.0.0.dev20240407/sky/resources.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/autoscalers.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/autoscalers.py`

 * *Files 4% similar despite different names*

```diff
@@ -71,14 +71,18 @@
         self._service_name: str = service_name
         self.min_replicas: int = spec.min_replicas
         self.max_replicas: int = (spec.max_replicas if spec.max_replicas
                                   is not None else spec.min_replicas)
         # Target number of replicas is initialized to min replicas
         self.target_num_replicas: int = spec.min_replicas
         self.latest_version: int = constants.INITIAL_VERSION
+        # The latest_version_ever_ready should be smaller than the
+        # latest_version, so we can fail early if the initial version got
+        # unrecoverable failure.
+        self.latest_version_ever_ready: int = self.latest_version - 1
         self.update_mode = serve_utils.DEFAULT_UPDATE_MODE
 
     def update_version(self, version: int, spec: 'service_spec.SkyServiceSpec',
                        update_mode: serve_utils.UpdateMode) -> None:
         if version <= self.latest_version:
             logger.error(f'Invalid version: {version}, '
                          f'latest version: {self.latest_version}')
@@ -109,21 +113,33 @@
                   spec: 'service_spec.SkyServiceSpec') -> 'Autoscaler':
         # TODO(MaoZiming): use NAME to get the class.
         if spec.use_ondemand_fallback:
             return FallbackRequestRateAutoscaler(service_name, spec)
         else:
             return RequestRateAutoscaler(service_name, spec)
 
+    def _dump_dynamic_states(self) -> Dict[str, Any]:
+        """Dump dynamic states from autoscaler."""
+        raise NotImplementedError
+
     def dump_dynamic_states(self) -> Dict[str, Any]:
         """Dump dynamic states from autoscaler."""
+        states = {'latest_version_ever_ready': self.latest_version_ever_ready}
+        states.update(self._dump_dynamic_states())
+        return states
+
+    def _load_dynamic_states(self, dynamic_states: Dict[str, Any]) -> None:
+        """Load dynamic states to autoscaler."""
         raise NotImplementedError
 
     def load_dynamic_states(self, dynamic_states: Dict[str, Any]) -> None:
         """Load dynamic states to autoscaler."""
-        raise NotImplementedError
+        self.latest_version_ever_ready = dynamic_states.pop(
+            'latest_version_ever_ready', constants.INITIAL_VERSION)
+        self._load_dynamic_states(dynamic_states)
 
 
 class RequestRateAutoscaler(Autoscaler):
     """RequestRateAutoscaler: Autoscale according to request rate.
 
     Scales when the number of requests per replica in the given interval
     is above or below the target qps per replica. The instance can be
@@ -372,20 +388,32 @@
         Trigger a scale up. Else, trigger a scale down.
 
         For future compatibility, we return a list of AutoscalerDecision.
         Scale-up could include both spot and on-demand, each with a resource
         override dict. Active migration could require returning both SCALE_UP
         and SCALE_DOWN.
         """
+        latest_replicas: List['replica_managers.ReplicaInfo'] = []
         latest_nonterminal_replicas: List['replica_managers.ReplicaInfo'] = []
 
         for info in replica_infos:
             if info.version == self.latest_version:
+                latest_replicas.append(info)
                 if not info.is_terminal:
                     latest_nonterminal_replicas.append(info)
+                    if info.is_ready:
+                        self.latest_version_ever_ready = self.latest_version
+        if self.latest_version_ever_ready < self.latest_version:
+            for info in latest_replicas:
+                if info.status_property.unrecoverable_failure():
+                    # Stop scaling if one of replica of the latest version
+                    # failed, it is likely that a fatal error happens to the
+                    # user application and may lead to a infinte termination
+                    # and restart.
+                    return []
 
         self._set_target_num_replica_with_hysteresis()
 
         scaling_options: List[AutoscalerDecision] = []
         all_replica_ids_to_scale_down: List[int] = []
 
         # Case 1. If rolling update is in progress, we scale down old replicas
@@ -429,20 +457,20 @@
                 AutoscalerDecision(AutoscalerDecisionOperator.SCALE_DOWN,
                                    target=replica_id))
 
         if not scaling_options:
             logger.info('No scaling needed.')
         return scaling_options
 
-    def dump_dynamic_states(self) -> Dict[str, Any]:
+    def _dump_dynamic_states(self) -> Dict[str, Any]:
         return {
             'request_timestamps': self.request_timestamps,
         }
 
-    def load_dynamic_states(self, dynamic_states: Dict[str, Any]) -> None:
+    def _load_dynamic_states(self, dynamic_states: Dict[str, Any]) -> None:
         if 'request_timestamps' in dynamic_states:
             self.request_timestamps = dynamic_states.pop('request_timestamps')
         if dynamic_states:
             logger.info(f'Remaining dynamic states: {dynamic_states}')
 
 
 class FallbackRequestRateAutoscaler(RequestRateAutoscaler):
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/constants.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/controller.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/core.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/core.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/load_balancer.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/load_balancer.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/load_balancing_policies.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/load_balancing_policies.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/replica_managers.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/replica_managers.py`

 * *Files 2% similar despite different names*

```diff
@@ -231,60 +231,67 @@
         first_ready_time: The first time the service is ready.
         sky_down_status: Process status of sky.down.
     """
     # None means sky.launch is not called yet.
     sky_launch_status: Optional[ProcessStatus] = None
     user_app_failed: bool = False
     service_ready_now: bool = False
-    # None means readiness probe is not executed yet;
+    # None means readiness probe is not succeeded yet;
     # -1 means the initial delay seconds is exceeded.
     first_ready_time: Optional[float] = None
     # None means sky.down is not called yet.
     sky_down_status: Optional[ProcessStatus] = None
+    # Whether the termination is caused by autoscaler's decision
+    is_scale_down: bool = False
     # The replica's spot instance was preempted.
     preempted: bool = False
 
-    def is_scale_down_succeeded(self, initial_delay_seconds: int) -> bool:
+    def remove_terminated_replica(self) -> bool:
         """Whether to remove the replica record from the replica table.
 
         If not, the replica will stay in the replica table permanently to
         notify the user that something is wrong with the user code / setup.
         """
-        if self.sky_launch_status == ProcessStatus.INTERRUPTED:
-            return True
-        if self.sky_launch_status != ProcessStatus.SUCCEEDED:
-            # sky_launch_status == RUNNING: a scale down happened before
-            # the sky.launch finished.
-            return self.sky_launch_status != ProcessStatus.FAILED
-        if self.sky_down_status != ProcessStatus.SUCCEEDED:
+        return self.is_scale_down
+
+    def unrecoverable_failure(self) -> bool:
+        """Whether the replica fails and cannot be recovered.
+
+        Autoscaler should stop scaling if any of the replica has unrecoverable
+        failure, e.g., the user app fails before the service endpoint being
+        ready for the current version.
+        """
+        replica_status = self.to_replica_status()
+        logger.info(
+            'Check replica unrecorverable: first_ready_time '
+            f'{self.first_ready_time}, user_app_failed {self.user_app_failed}, '
+            f'status {replica_status}')
+        if replica_status not in serve_state.ReplicaStatus.terminal_statuses():
             return False
-        if self.preempted:
-            return True
-        if (self.first_ready_time is not None and
-                time.time() - self.first_ready_time > initial_delay_seconds):
-            # If the service is up for more than `initial_delay_seconds`,
-            # we assume there is no bug in the user code and the scale down
-            # is successful, thus enabling the controller to remove the
-            # replica from the replica table and auto restart the replica.
-            # Here we assume that initial_delay_seconds is larger than
-            # consecutive_failure_threshold_seconds, so if a replica is not
-            # teardown for initial_delay_seconds, it is safe to assume that
-            # it is UP for initial_delay_seconds.
-            # For replica with a failed sky.launch, it is likely due to some
-            # misconfigured resources, so we don't want to auto restart it.
-            # For replica with a failed sky.down, we cannot restart it since
-            # otherwise we will have a resource leak.
-            return True
+        if self.first_ready_time is not None:
+            if self.first_ready_time >= 0:
+                # If the service is ever up, we assume there is no bug in the
+                # user code and the scale down is successful, thus enabling the
+                # controller to remove the replica from the replica table and
+                # auto restart the replica.
+                # For replica with a failed sky.launch, it is likely due to some
+                # misconfigured resources, so we don't want to auto restart it.
+                # For replica with a failed sky.down, we cannot restart it since
+                # otherwise we will have a resource leak.
+                return False
+            else:
+                # If the initial delay exceeded, it is likely the service is not
+                # recoverable.
+                return True
         if self.user_app_failed:
-            return False
-        if self.first_ready_time is None:
             return True
-        if not self.service_ready_now:
-            return False
-        return self.first_ready_time >= 0.0
+        # TODO(zhwu): launch failures not related to resource unavailability
+        # should be considered as unrecoverable failure. (refer to
+        # `spot.recovery_strategy.StrategyExecutor::_launch`)
+        return False
 
     def should_track_service_status(self) -> bool:
         """Should we track the status of the replica.
 
         This includes:
             (1) Job status;
             (2) Readiness probe.
@@ -329,25 +336,25 @@
                 # sky.down failed
                 return serve_state.ReplicaStatus.FAILED_CLEANUP
             if self.user_app_failed:
                 # Failed on user setup/run
                 return serve_state.ReplicaStatus.FAILED
             if self.sky_launch_status == ProcessStatus.FAILED:
                 # sky.launch failed
-                return serve_state.ReplicaStatus.FAILED
+                return serve_state.ReplicaStatus.FAILED_PROVISION
             if self.first_ready_time is None:
                 # readiness probe is not executed yet, but a scale down is
                 # triggered.
                 return serve_state.ReplicaStatus.SHUTTING_DOWN
             if self.first_ready_time == -1:
                 # initial delay seconds exceeded
-                return serve_state.ReplicaStatus.FAILED
+                return serve_state.ReplicaStatus.FAILED_INITIAL_DELAY
             if not self.service_ready_now:
                 # Max continuous failure exceeded
-                return serve_state.ReplicaStatus.FAILED
+                return serve_state.ReplicaStatus.FAILED_PROBING
             # This indicate it is a scale_down with correct teardown.
             # Should have been cleaned from the replica table.
             return serve_state.ReplicaStatus.UNKNOWN
         if self.sky_launch_status == ProcessStatus.FAILED:
             # sky.launch failed
             # The down process has not been started if it reaches here,
             # due to the `if self.sky_down_status is not None`` check above.
@@ -637,16 +644,19 @@
         self._launch_process_pool[replica_id] = p
 
     def scale_up(self,
                  resources_override: Optional[Dict[str, Any]] = None) -> None:
         self._launch_replica(self._next_replica_id, resources_override)
         self._next_replica_id += 1
 
-    def _terminate_replica(self, replica_id: int, sync_down_logs: bool,
-                           replica_drain_delay_seconds: int) -> None:
+    def _terminate_replica(self,
+                           replica_id: int,
+                           sync_down_logs: bool,
+                           replica_drain_delay_seconds: int,
+                           is_scale_down: bool = False) -> None:
 
         if replica_id in self._launch_process_pool:
             info = serve_state.get_replica_info_from_id(self._service_name,
                                                         replica_id)
             assert info is not None
             info.status_property.sky_launch_status = ProcessStatus.INTERRUPTED
             serve_state.add_or_update_replica(self._service_name, replica_id,
@@ -721,23 +731,25 @@
                     f'replica_id: {replica_id}')
         p = multiprocessing.Process(
             target=ux_utils.RedirectOutputForProcess(terminate_cluster,
                                                      log_file_name, 'a').run,
             args=(info.cluster_name, replica_drain_delay_seconds),
         )
         info.status_property.sky_down_status = ProcessStatus.RUNNING
+        info.status_property.is_scale_down = is_scale_down
         serve_state.add_or_update_replica(self._service_name, replica_id, info)
         p.start()
         self._down_process_pool[replica_id] = p
 
     def scale_down(self, replica_id: int) -> None:
         self._terminate_replica(
             replica_id,
             sync_down_logs=False,
-            replica_drain_delay_seconds=_DEFAULT_DRAIN_SECONDS)
+            replica_drain_delay_seconds=_DEFAULT_DRAIN_SECONDS,
+            is_scale_down=True)
 
     def _handle_preemption(self, info: ReplicaInfo) -> bool:
         """Handle preemption of the replica if any error happened.
 
         Returns:
             bool: Whether the replica is preempted.
         """
@@ -770,15 +782,16 @@
         logger.info(
             f'Replica {info.replica_id} is preempted{cluster_status_str}.')
         info.status_property.preempted = True
         serve_state.add_or_update_replica(self._service_name, info.replica_id,
                                           info)
         self._terminate_replica(info.replica_id,
                                 sync_down_logs=False,
-                                replica_drain_delay_seconds=0)
+                                replica_drain_delay_seconds=0,
+                                is_scale_down=True)
         return True
 
     #################################
     # ReplicaManager Daemon Threads #
     #################################
 
     @with_lock
@@ -855,20 +868,18 @@
                 # assume it is just some random failure and we should restart
                 # the replica. Please refer to the implementation of
                 # `is_scale_down_succeeded` for more details.
                 # TODO(tian): Currently, restart replicas that failed within
                 # initial_delay_seconds is not supported. We should add it
                 # later when we support `sky serve update`.
                 removal_reason = None
-                if info.status_property.is_scale_down_succeeded(
-                        self._get_initial_delay_seconds(info.version)):
-                    # This means the cluster is deleted due to
-                    # a scale down or the cluster is recovering
-                    # from preemption. Delete the replica info
-                    # so it won't count as a replica.
+                if info.status_property.is_scale_down:
+                    # This means the cluster is deleted due to an autoscaler
+                    # decision or the cluster is recovering from preemption.
+                    # Delete the replica info so it won't count as a replica.
                     if info.status_property.preempted:
                         removal_reason = 'for preemption recovery'
                     else:
                         removal_reason = 'normally'
                 # Don't keep failed record for version mismatch replicas,
                 # since user should fixed the error before update.
                 elif info.version != self.latest_version:
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/serve_state.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/serve_state.py`

 * *Files 3% similar despite different names*

```diff
@@ -94,39 +94,49 @@
     # The service was ready before, but it becomes not ready now, i.e. the
     # readiness probe fails.
     NOT_READY = 'NOT_READY'
 
     # The replica VM is being shut down. i.e., the `sky down` is still running.
     SHUTTING_DOWN = 'SHUTTING_DOWN'
 
-    # The replica VM is once failed and has been deleted.
+    # The replica fails due to user's run/setup.
     FAILED = 'FAILED'
 
+    # The replica fails due to initial delay exceeded.
+    FAILED_INITIAL_DELAY = 'FAILED_INITIAL_DELAY'
+
+    # The replica fails due to healthiness check.
+    FAILED_PROBING = 'FAILED_PROBING'
+
+    # The replica fails during launching
+    FAILED_PROVISION = 'FAILED_PROVISION'
+
     # `sky.down` failed during service teardown.
     # This could mean resource leakage.
     # TODO(tian): This status should be removed in the future, at which point
     # we should guarantee no resource leakage like regular sky.
     FAILED_CLEANUP = 'FAILED_CLEANUP'
 
     # The replica is a spot VM and it is preempted by the cloud provider.
     PREEMPTED = 'PREEMPTED'
 
     # Unknown. This should never happen (used only for unexpected errors).
     UNKNOWN = 'UNKNOWN'
 
     @classmethod
     def failed_statuses(cls) -> List['ReplicaStatus']:
-        return [cls.FAILED, cls.FAILED_CLEANUP, cls.UNKNOWN]
+        return [
+            cls.FAILED, cls.FAILED_CLEANUP, cls.FAILED_INITIAL_DELAY,
+            cls.FAILED_PROBING, cls.FAILED_PROVISION, cls.UNKNOWN
+        ]
 
     @classmethod
     def terminal_statuses(cls) -> List['ReplicaStatus']:
-        return [
-            cls.SHUTTING_DOWN, cls.FAILED, cls.FAILED_CLEANUP, cls.PREEMPTED,
-            cls.UNKNOWN
-        ]
+        return [cls.SHUTTING_DOWN, cls.PREEMPTED, cls.UNKNOWN
+               ] + cls.failed_statuses()
 
     @classmethod
     def scale_down_decision_order(cls) -> List['ReplicaStatus']:
         # Scale down replicas in the order of replica initialization
         return [
             cls.PENDING, cls.PROVISIONING, cls.STARTING, cls.NOT_READY,
             cls.READY
@@ -141,14 +151,17 @@
     ReplicaStatus.PENDING: colorama.Fore.YELLOW,
     ReplicaStatus.PROVISIONING: colorama.Fore.BLUE,
     ReplicaStatus.STARTING: colorama.Fore.CYAN,
     ReplicaStatus.READY: colorama.Fore.GREEN,
     ReplicaStatus.NOT_READY: colorama.Fore.YELLOW,
     ReplicaStatus.SHUTTING_DOWN: colorama.Fore.MAGENTA,
     ReplicaStatus.FAILED: colorama.Fore.RED,
+    ReplicaStatus.FAILED_INITIAL_DELAY: colorama.Fore.RED,
+    ReplicaStatus.FAILED_PROBING: colorama.Fore.RED,
+    ReplicaStatus.FAILED_PROVISION: colorama.Fore.RED,
     ReplicaStatus.FAILED_CLEANUP: colorama.Fore.RED,
     ReplicaStatus.PREEMPTED: colorama.Fore.MAGENTA,
     ReplicaStatus.UNKNOWN: colorama.Fore.RED,
 }
 
 
 class ServiceStatus(enum.Enum):
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/serve_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/serve_utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -711,15 +711,15 @@
 
 def _get_replicas(service_record: Dict[str, Any]) -> str:
     ready_replica_num, total_replica_num = 0, 0
     for info in service_record['replica_info']:
         if info['status'] == serve_state.ReplicaStatus.READY:
             ready_replica_num += 1
         # TODO(MaoZiming): add a column showing failed replicas number.
-        if info['status'] != serve_state.ReplicaStatus.FAILED:
+        if info['status'] not in serve_state.ReplicaStatus.failed_statuses():
             total_replica_num += 1
     return f'{ready_replica_num}/{total_replica_num}'
 
 
 def get_endpoint(service_record: Dict[str, Any]) -> str:
     # Don't use backend_utils.is_controller_up since it is too slow.
     handle = global_user_state.get_handle_from_cluster_name(
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/service.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/service.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/serve/service_spec.py` & `skypilot-nightly-1.0.0.dev20240407/sky/serve/service_spec.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/setup_files/MANIFEST.in` & `skypilot-nightly-1.0.0.dev20240407/sky/setup_files/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/setup_files/setup.py` & `skypilot-nightly-1.0.0.dev20240407/sky/setup_files/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/sky_logging.py` & `skypilot-nightly-1.0.0.dev20240407/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/LICENSE` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/attempt_skylet.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/autostop_lib.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/configs.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/constants.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/events.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/job_lib.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/log_lib.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/log_lib.py`

 * *Files 0% similar despite different names*

```diff
@@ -2,14 +2,15 @@
 
 This is a remote utility module that provides logging functionality.
 """
 import copy
 import io
 import multiprocessing.pool
 import os
+import shlex
 import subprocess
 import sys
 import tempfile
 import textwrap
 import time
 from typing import Dict, Iterator, List, Optional, Tuple, Union
 
@@ -271,15 +272,15 @@
             . $(conda info --base 2> /dev/null)/etc/profile.d/conda.sh > /dev/null 2>&1 || true
             set +a
             export PYTHONUNBUFFERED=1
             cd {constants.SKY_REMOTE_WORKDIR}"""),
     ]
     if env_vars is not None:
         for k, v in env_vars.items():
-            script.append(f'export {k}="{v}"')
+            script.append(f'export {k}={shlex.quote(str(v))}')
     script += [
         codegen,
         '',  # New line at EOF.
     ]
     script = '\n'.join(script)
     return script
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/log_lib.pyi` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/log_lib.pyi`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/azure-config-template.json` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/config.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/azure/node_provider.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/command_runner.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/ibm/node_provider.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/ibm/utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/oci/node_provider.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/oci/query_helper.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/scp/config.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/providers/scp/node_provider.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/ray_patches/worker.py.patch` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/skylet.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skylet/subprocess_daemon.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/skypilot_config.py` & `skypilot-nightly-1.0.0.dev20240407/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/spot/__init__.py` & `skypilot-nightly-1.0.0.dev20240407/sky/spot/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/spot/constants.py` & `skypilot-nightly-1.0.0.dev20240407/sky/spot/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/spot/controller.py` & `skypilot-nightly-1.0.0.dev20240407/sky/spot/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/spot/dashboard/dashboard.py` & `skypilot-nightly-1.0.0.dev20240407/sky/spot/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/spot/dashboard/static/favicon.ico` & `skypilot-nightly-1.0.0.dev20240407/sky/spot/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/spot/dashboard/templates/index.html` & `skypilot-nightly-1.0.0.dev20240407/sky/spot/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/spot/recovery_strategy.py` & `skypilot-nightly-1.0.0.dev20240407/sky/spot/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/spot/spot_state.py` & `skypilot-nightly-1.0.0.dev20240407/sky/spot/spot_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/spot/spot_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/spot/spot_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/status_lib.py` & `skypilot-nightly-1.0.0.dev20240407/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/task.py` & `skypilot-nightly-1.0.0.dev20240407/sky/task.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/aws-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/aws-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/azure-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/cudo-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/cudo-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/fluidstack-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/fluidstack-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/gcp-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/ibm-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/kubernetes-ingress.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/kubernetes-ingress.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/kubernetes-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/kubernetes-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/lambda-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/local-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/oci-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/paperspace-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/paperspace-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/runpod-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/runpod-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/scp-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/sky-serve-controller.yaml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/sky-serve-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/spot-controller.yaml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/spot-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/templates/vsphere-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20240407/sky/templates/vsphere-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/usage/constants.py` & `skypilot-nightly-1.0.0.dev20240407/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/usage/usage_lib.py` & `skypilot-nightly-1.0.0.dev20240407/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/accelerator_registry.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/cli_utils/status_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/cluster_yaml_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/cluster_yaml_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/command_runner.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/command_runner.pyi` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/command_runner.pyi`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/common_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/common_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/controller_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/controller_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/dag_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/db_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/env_options.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/create_cluster.sh` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/create_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/delete_cluster.sh` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/generate_kind_config.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/generate_kind_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/gpu_labeler.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/gpu_labeler.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/kubernetes_enums.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/kubernetes_enums.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/log_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/resources_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/rich_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/schemas.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/schemas.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/subprocess_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/timeline.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/ux_utils.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/sky/utils/validator.py` & `skypilot-nightly-1.0.0.dev20240407/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/PKG-INFO` & `skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240406
+Version: 1.0.0.dev20240407
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/skypilot_nightly.egg-info/requires.txt` & `skypilot-nightly-1.0.0.dev20240407/skypilot_nightly.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_cli.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_config.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_jobs.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_list_accelerators.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_optimizer_dryruns.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_optimizer_random_dag.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_serve_autoscaler.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_smoke.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_smoke.py`

 * *Files 1% similar despite different names*

```diff
@@ -644,12320 +644,12557 @@
 00002830: 5f6e 616d 655c 2729 207c 2067 7265 7020  _name\') | grep 
 00002840: 5c27 225c 2731 3034 3835 3736 2031 3034  \'"\'1048576 104
 00002850: 3835 3736 5c27 225c 2722 272c 0a20 2020  8576\'"\'"',.   
 00002860: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
 00002870: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
 00002880: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
 00002890: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-000028a0: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-000028b0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000028c0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000028d0: 2020 2020 2020 205f 6765 745f 7469 6d65         _get_time
-000028e0: 6f75 7428 6765 6e65 7269 635f 636c 6f75  out(generic_clou
-000028f0: 6429 2c0a 2020 2020 290a 2020 2020 7275  d),.    ).    ru
-00002900: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00002910: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-00002920: 5465 7374 2072 6567 696f 6e20 2d2d 2d2d  Test region ----
-00002930: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00002940: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
-00002950: 5f61 7773 5f72 6567 696f 6e28 293a 0a20  _aws_region():. 
-00002960: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00002970: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00002980: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00002990: 2020 2020 2020 2027 6177 735f 7265 6769         'aws_regi
-000029a0: 6f6e 272c 0a20 2020 2020 2020 205b 0a20  on',.        [. 
-000029b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000029c0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-000029d0: 616d 657d 202d 2d72 6567 696f 6e20 7573  ame} --region us
-000029e0: 2d65 6173 742d 3220 6578 616d 706c 6573  -east-2 examples
-000029f0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00002a00: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00002a10: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
-00002a20: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
-00002a30: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00002a40: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00002a50: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00002a60: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00002a70: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00002a80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00002a90: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
-00002aa0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00002ab0: 7020 7573 2d65 6173 742d 3227 2c20 2023  p us-east-2',  #
-00002ac0: 2045 6e73 7572 6520 7468 6520 7265 6769   Ensure the regi
-00002ad0: 6f6e 2069 7320 636f 7272 6563 742e 0a20  on is correct.. 
-00002ae0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00002af0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00002b00: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00002b10: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00002b20: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00002b30: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
-00002b40: 745f 6763 705f 7265 6769 6f6e 5f61 6e64  t_gcp_region_and
-00002b50: 5f73 6572 7669 6365 5f61 6363 6f75 6e74  _service_account
-00002b60: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00002b70: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00002b80: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00002b90: 7374 280a 2020 2020 2020 2020 2767 6370  st(.        'gcp
-00002ba0: 5f72 6567 696f 6e27 2c0a 2020 2020 2020  _region',.      
-00002bb0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00002bc0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00002bd0: 2d63 207b 6e61 6d65 7d20 2d2d 7265 6769  -c {name} --regi
-00002be0: 6f6e 2075 732d 6365 6e74 7261 6c31 202d  on us-central1 -
-00002bf0: 2d63 6c6f 7564 2067 6370 2074 6573 7473  -cloud gcp tests
-00002c00: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00002c10: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00002c20: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00002c30: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
-00002c40: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
-00002c50: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00002c60: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00002c70: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00002c80: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00002c90: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00002ca0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00002cb0: 6b79 2065 7865 6320 7b6e 616d 657d 205c  ky exec {name} \
-00002cc0: 2763 7572 6c20 2d48 2022 4d65 7461 6461  'curl -H "Metada
-00002cd0: 7461 2d46 6c61 766f 723a 2047 6f6f 676c  ta-Flavor: Googl
-00002ce0: 6522 2022 6874 7470 3a2f 2f6d 6574 6164  e" "http://metad
-00002cf0: 6174 612e 676f 6f67 6c65 2e69 6e74 6572  ata.google.inter
-00002d00: 6e61 6c2f 636f 6d70 7574 654d 6574 6164  nal/computeMetad
-00002d10: 6174 612f 7631 2f69 6e73 7461 6e63 652f  ata/v1/instance/
-00002d20: 7365 7276 6963 652d 6163 636f 756e 7473  service-accounts
-00002d30: 2f64 6566 6175 6c74 2f69 6465 6e74 6974  /default/identit
-00002d40: 793f 666f 726d 6174 3d73 7461 6e64 6172  y?format=standar
-00002d50: 6426 6175 6469 656e 6365 3d67 6370 225c  d&audience=gcp"\
-00002d60: 2727 2c0a 2020 2020 2020 2020 2020 2020  '',.            
-00002d70: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00002d80: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
-00002d90: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00002da0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00002db0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00002dc0: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
-00002dd0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00002de0: 7573 2d63 656e 7472 616c 3127 2c20 2023  us-central1',  #
-00002df0: 2045 6e73 7572 6520 7468 6520 7265 6769   Ensure the regi
-00002e00: 6f6e 2069 7320 636f 7272 6563 742e 0a20  on is correct.. 
-00002e10: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00002e20: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00002e30: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00002e40: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00002e50: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00002e60: 6d61 726b 2e69 626d 0a64 6566 2074 6573  mark.ibm.def tes
-00002e70: 745f 6962 6d5f 7265 6769 6f6e 2829 3a0a  t_ibm_region():.
-00002e80: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00002e90: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00002ea0: 2020 2072 6567 696f 6e20 3d20 2765 752d     region = 'eu-
-00002eb0: 6465 270a 2020 2020 7465 7374 203d 2054  de'.    test = T
-00002ec0: 6573 7428 0a20 2020 2020 2020 2027 7265  est(.        're
-00002ed0: 6769 6f6e 272c 0a20 2020 2020 2020 205b  gion',.        [
-00002ee0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00002ef0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00002f00: 7b6e 616d 657d 202d 2d63 6c6f 7564 2069  {name} --cloud i
-00002f10: 626d 202d 2d72 6567 696f 6e20 7b72 6567  bm --region {reg
-00002f20: 696f 6e7d 2065 7861 6d70 6c65 732f 6d69  ion} examples/mi
-00002f30: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00002f40: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00002f50: 7865 6320 7b6e 616d 657d 202d 2d63 6c6f  xec {name} --clo
-00002f60: 7564 2069 626d 2065 7861 6d70 6c65 732f  ud ibm examples/
-00002f70: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-00002f80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00002f90: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00002fa0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-00002fb0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-00002fc0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-00002fd0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00002fe0: 2d2d 616c 6c20 7c20 6772 6570 207b 6e61  --all | grep {na
-00002ff0: 6d65 7d20 7c20 6772 6570 207b 7265 6769  me} | grep {regi
-00003000: 6f6e 7d27 2c20 2023 2045 6e73 7572 6520  on}',  # Ensure 
-00003010: 7468 6520 7265 6769 6f6e 2069 7320 636f  the region is co
-00003020: 7272 6563 742e 0a20 2020 2020 2020 205d  rrect..        ]
-00003030: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00003040: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00003050: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00003060: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00003070: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
-00003080: 7265 0a64 6566 2074 6573 745f 617a 7572  re.def test_azur
-00003090: 655f 7265 6769 6f6e 2829 3a0a 2020 2020  e_region():.    
-000030a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-000030b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-000030c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000030d0: 2020 2020 2761 7a75 7265 5f72 6567 696f      'azure_regio
-000030e0: 6e27 2c0a 2020 2020 2020 2020 5b0a 2020  n',.        [.  
-000030f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003100: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00003110: 6d65 7d20 2d2d 7265 6769 6f6e 2065 6173  me} --region eas
-00003120: 7475 7332 202d 2d63 6c6f 7564 2061 7a75  tus2 --cloud azu
-00003130: 7265 2074 6573 7473 2f74 6573 745f 7961  re tests/test_ya
-00003140: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-00003150: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00003160: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00003170: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00003180: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00003190: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000031a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-000031b0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-000031c0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-000031d0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-000031e0: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-000031f0: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
-00003200: 6e61 6d65 7d20 7c20 6772 6570 2065 6173  name} | grep eas
-00003210: 7475 7332 272c 2020 2320 456e 7375 7265  tus2',  # Ensure
-00003220: 2074 6865 2072 6567 696f 6e20 6973 2063   the region is c
-00003230: 6f72 7265 6374 2e0a 2020 2020 2020 2020  orrect..        
-00003240: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00003250: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00003260: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00003270: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00003280: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-00003290: 7374 207a 6f6e 6520 2d2d 2d2d 2d2d 2d2d  st zone --------
-000032a0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-000032b0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
-000032c0: 5f7a 6f6e 6528 293a 0a20 2020 206e 616d  _zone():.    nam
-000032d0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-000032e0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000032f0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00003300: 2027 6177 735f 7a6f 6e65 272c 0a20 2020   'aws_zone',.   
-00003310: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00003320: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00003330: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
-00003340: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
-00003350: 6d6c 202d 2d7a 6f6e 6520 7573 2d65 6173  ml --zone us-eas
-00003360: 742d 3262 272c 0a20 2020 2020 2020 2020  t-2b',.         
-00003370: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00003380: 616d 657d 2065 7861 6d70 6c65 732f 6d69  ame} examples/mi
-00003390: 6e69 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e  nimal.yaml --zon
-000033a0: 6520 7573 2d65 6173 742d 3262 272c 0a20  e us-east-2b',. 
-000033b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000033c0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-000033d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-000033e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-000033f0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-00003400: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00003410: 2d2d 616c 6c20 7c20 6772 6570 207b 6e61  --all | grep {na
-00003420: 6d65 7d20 7c20 6772 6570 2075 732d 6561  me} | grep us-ea
-00003430: 7374 2d32 6227 2c20 2023 2045 6e73 7572  st-2b',  # Ensur
-00003440: 6520 7468 6520 7a6f 6e65 2069 7320 636f  e the zone is co
-00003450: 7272 6563 742e 0a20 2020 2020 2020 205d  rrect..        ]
-00003460: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00003470: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00003480: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00003490: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000034a0: 4070 7974 6573 742e 6d61 726b 2e69 626d  @pytest.mark.ibm
-000034b0: 0a64 6566 2074 6573 745f 6962 6d5f 7a6f  .def test_ibm_zo
-000034c0: 6e65 2829 3a0a 2020 2020 6e61 6d65 203d  ne():.    name =
-000034d0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000034e0: 6d65 2829 0a20 2020 207a 6f6e 6520 3d20  me().    zone = 
-000034f0: 2765 752d 6465 2d32 270a 2020 2020 7465  'eu-de-2'.    te
-00003500: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00003510: 2020 2027 7a6f 6e65 272c 0a20 2020 2020     'zone',.     
-00003520: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00003530: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00003540: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-00003550: 7564 2069 626d 2065 7861 6d70 6c65 732f  ud ibm examples/
-00003560: 6d69 6e69 6d61 6c2e 7961 6d6c 202d 2d7a  minimal.yaml --z
-00003570: 6f6e 6520 7b7a 6f6e 657d 272c 0a20 2020  one {zone}',.   
-00003580: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00003590: 7865 6320 7b6e 616d 657d 202d 2d63 6c6f  xec {name} --clo
-000035a0: 7564 2069 626d 2065 7861 6d70 6c65 732f  ud ibm examples/
-000035b0: 6d69 6e69 6d61 6c2e 7961 6d6c 202d 2d7a  minimal.yaml --z
-000035c0: 6f6e 6520 7b7a 6f6e 657d 272c 0a20 2020  one {zone}',.   
-000035d0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000035e0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-000035f0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00003600: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00003610: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00003620: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
-00003630: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
-00003640: 7d20 7c20 6772 6570 207b 7a6f 6e65 7d27  } | grep {zone}'
-00003650: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00003660: 7a6f 6e65 2069 7320 636f 7272 6563 742e  zone is correct.
-00003670: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00003680: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00003690: 7920 7b6e 616d 657d 207b 6e61 6d65 7d2d  y {name} {name}-
-000036a0: 3220 7b6e 616d 657d 2d33 272c 0a20 2020  2 {name}-3',.   
-000036b0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-000036c0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-000036d0: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
-000036e0: 2074 6573 745f 6763 705f 7a6f 6e65 2829   test_gcp_zone()
-000036f0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00003700: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00003710: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00003720: 280a 2020 2020 2020 2020 2767 6370 5f7a  (.        'gcp_z
-00003730: 6f6e 6527 2c0a 2020 2020 2020 2020 5b0a  one',.        [.
-00003740: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003750: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00003760: 6e61 6d65 7d20 2d2d 7a6f 6e65 2075 732d  name} --zone us-
-00003770: 6365 6e74 7261 6c31 2d61 202d 2d63 6c6f  central1-a --clo
-00003780: 7564 2067 6370 2074 6573 7473 2f74 6573  ud gcp tests/tes
-00003790: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-000037a0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-000037b0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-000037c0: 616d 657d 202d 2d7a 6f6e 6520 7573 2d63  ame} --zone us-c
-000037d0: 656e 7472 616c 312d 6120 2d2d 636c 6f75  entral1-a --clou
-000037e0: 6420 6763 7020 7465 7374 732f 7465 7374  d gcp tests/test
-000037f0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-00003800: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00003810: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00003820: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00003830: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00003840: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00003850: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003860: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
-00003870: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00003880: 7020 7573 2d63 656e 7472 616c 312d 6127  p us-central1-a'
-00003890: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-000038a0: 7a6f 6e65 2069 7320 636f 7272 6563 742e  zone is correct.
-000038b0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000038c0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-000038d0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-000038e0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-000038f0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00003900: 2d2d 2d2d 2d2d 2054 6573 7420 7468 6520  ------ Test the 
-00003910: 696d 6167 6520 2d2d 2d2d 2d2d 2d2d 2d2d  image ----------
-00003920: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-00003930: 730a 6465 6620 7465 7374 5f61 7773 5f69  s.def test_aws_i
-00003940: 6d61 6765 7328 293a 0a20 2020 206e 616d  mages():.    nam
-00003950: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00003960: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00003970: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00003980: 2027 6177 735f 696d 6167 6573 272c 0a20   'aws_images',. 
-00003990: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-000039a0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-000039b0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-000039c0: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
-000039d0: 6f74 3a67 7075 2d75 6275 6e74 752d 3138  ot:gpu-ubuntu-18
-000039e0: 3034 2065 7861 6d70 6c65 732f 6d69 6e69  04 examples/mini
-000039f0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00003a00: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00003a10: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00003a20: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00003a30: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00003a40: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00003a50: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
-00003a60: 6e61 6d65 7d20 2d2d 696d 6167 652d 6964  name} --image-id
-00003a70: 2073 6b79 7069 6c6f 743a 6770 752d 7562   skypilot:gpu-ub
-00003a80: 756e 7475 2d32 3030 3420 6578 616d 706c  untu-2004 exampl
-00003a90: 6573 2f6d 696e 696d 616c 2e79 616d 6c20  es/minimal.yaml 
-00003aa0: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
-00003ab0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00003ac0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00003ad0: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
-00003ae0: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
-00003af0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00003b00: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00003b10: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-00003b20: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00003b30: 6f67 7320 7b6e 616d 657d 202d 2d73 7461  ogs {name} --sta
-00003b40: 7475 7320 7c20 6772 6570 2022 4a6f 6220  tus | grep "Job 
-00003b50: 323a 2053 5543 4345 4544 4544 2227 2c20  2: SUCCEEDED"', 
-00003b60: 2023 2045 7175 6976 616c 656e 742e 0a20   # Equivalent.. 
-00003b70: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00003b80: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00003b90: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00003ba0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00003bb0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00003bc0: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
-00003bd0: 745f 6763 705f 696d 6167 6573 2829 3a0a  t_gcp_images():.
-00003be0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00003bf0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00003c00: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00003c10: 2020 2020 2020 2020 2767 6370 5f69 6d61          'gcp_ima
-00003c20: 6765 7327 2c0a 2020 2020 2020 2020 5b0a  ges',.        [.
-00003c30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003c40: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00003c50: 6e61 6d65 7d20 2d2d 696d 6167 652d 6964  name} --image-id
-00003c60: 2073 6b79 7069 6c6f 743a 6770 752d 6465   skypilot:gpu-de
-00003c70: 6269 616e 2d31 3020 2d2d 636c 6f75 6420  bian-10 --cloud 
-00003c80: 6763 7020 7465 7374 732f 7465 7374 5f79  gcp tests/test_y
-00003c90: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-00003ca0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00003cb0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00003cc0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-00003cd0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00003ce0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00003cf0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00003d00: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
-00003d10: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
-00003d20: 6f74 3a63 7075 2d64 6562 6961 6e2d 3130  ot:cpu-debian-10
-00003d30: 202d 2d63 6c6f 7564 2067 6370 2074 6573   --cloud gcp tes
-00003d40: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00003d50: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
-00003d60: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
-00003d70: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00003d80: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00003d90: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00003da0: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
-00003db0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00003dc0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00003dd0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
-00003de0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003df0: 7920 6c6f 6773 207b 6e61 6d65 7d20 2d2d  y logs {name} --
-00003e00: 7374 6174 7573 207c 2067 7265 7020 224a  status | grep "J
-00003e10: 6f62 2032 3a20 5355 4343 4545 4445 4422  ob 2: SUCCEEDED"
-00003e20: 272c 2020 2320 4571 7569 7661 6c65 6e74  ',  # Equivalent
-00003e30: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
-00003e40: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00003e50: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00003e60: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00003e70: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00003e80: 7374 2e6d 6172 6b2e 617a 7572 650a 6465  st.mark.azure.de
-00003e90: 6620 7465 7374 5f61 7a75 7265 5f69 6d61  f test_azure_ima
-00003ea0: 6765 7328 293a 0a20 2020 206e 616d 6520  ges():.    name 
-00003eb0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00003ec0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00003ed0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00003ee0: 617a 7572 655f 696d 6167 6573 272c 0a20  azure_images',. 
-00003ef0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00003f00: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00003f10: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00003f20: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
-00003f30: 6f74 3a67 7075 2d75 6275 6e74 752d 3232  ot:gpu-ubuntu-22
-00003f40: 3034 202d 2d63 6c6f 7564 2061 7a75 7265  04 --cloud azure
-00003f50: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00003f60: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00003f70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003f80: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00003f90: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00003fa0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-00003fb0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-00003fc0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00003fd0: 6820 2d63 207b 6e61 6d65 7d20 2d2d 696d  h -c {name} --im
-00003fe0: 6167 652d 6964 2073 6b79 7069 6c6f 743a  age-id skypilot:
-00003ff0: 7631 2d75 6275 6e74 752d 3230 3034 202d  v1-ubuntu-2004 -
-00004000: 2d63 6c6f 7564 2061 7a75 7265 2074 6573  -cloud azure tes
-00004010: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00004020: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
-00004030: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
-00004040: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004050: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00004060: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00004070: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
-00004080: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00004090: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-000040a0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
-000040b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000040c0: 7920 6c6f 6773 207b 6e61 6d65 7d20 2d2d  y logs {name} --
-000040d0: 7374 6174 7573 207c 2067 7265 7020 224a  status | grep "J
-000040e0: 6f62 2032 3a20 5355 4343 4545 4445 4422  ob 2: SUCCEEDED"
-000040f0: 272c 2020 2320 4571 7569 7661 6c65 6e74  ',  # Equivalent
-00004100: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
-00004110: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00004120: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00004130: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00004140: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00004150: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
-00004160: 7465 7374 5f61 7773 5f69 6d61 6765 5f69  test_aws_image_i
-00004170: 645f 6469 6374 2829 3a0a 2020 2020 6e61  d_dict():.    na
-00004180: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00004190: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-000041a0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-000041b0: 2020 2761 7773 5f69 6d61 6765 5f69 645f    'aws_image_id_
-000041c0: 6469 6374 272c 0a20 2020 2020 2020 205b  dict',.        [
-000041d0: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
-000041e0: 7365 2069 6d61 6765 2069 6420 6469 6374  se image id dict
-000041f0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00004200: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00004210: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-00004220: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
-00004230: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
-00004240: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00004250: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-00004260: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
-00004270: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
-00004280: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00004290: 207b 6e61 6d65 7d20 226c 7320 7e22 272c   {name} "ls ~"',
-000042a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000042b0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-000042c0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-000042d0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000042e0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-000042f0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-00004300: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00004310: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
-00004320: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00004330: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00004340: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00004350: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00004360: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00004370: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
-00004380: 7465 7374 5f67 6370 5f69 6d61 6765 5f69  test_gcp_image_i
-00004390: 645f 6469 6374 2829 3a0a 2020 2020 6e61  d_dict():.    na
-000043a0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-000043b0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-000043c0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-000043d0: 2020 2767 6370 5f69 6d61 6765 5f69 645f    'gcp_image_id_
-000043e0: 6469 6374 272c 0a20 2020 2020 2020 205b  dict',.        [
-000043f0: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
-00004400: 7365 2069 6d61 6765 2069 6420 6469 6374  se image id dict
-00004410: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00004420: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00004430: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
-00004440: 7374 5f79 616d 6c73 2f67 6370 5f70 6572  st_yamls/gcp_per
-00004450: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
-00004460: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00004470: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00004480: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
-00004490: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
-000044a0: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
-000044b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000044c0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-000044d0: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
-000044e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000044f0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00004500: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00004510: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00004520: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
-00004530: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004540: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
-00004550: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00004560: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00004570: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00004580: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00004590: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000045a0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000045b0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
-000045c0: 5f69 6d61 6765 5f69 645f 6469 6374 5f72  _image_id_dict_r
-000045d0: 6567 696f 6e28 293a 0a20 2020 206e 616d  egion():.    nam
-000045e0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-000045f0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00004600: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00004610: 2027 6177 735f 696d 6167 655f 6964 5f64   'aws_image_id_d
-00004620: 6963 745f 7265 6769 6f6e 272c 0a20 2020  ict_region',.   
-00004630: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00004640: 2020 2023 2059 414d 4c20 6861 730a 2020     # YAML has.  
-00004650: 2020 2020 2020 2020 2020 2320 2020 696d            #   im
-00004660: 6167 655f 6964 3a0a 2020 2020 2020 2020  age_id:.        
-00004670: 2020 2020 2320 2020 2020 2020 7573 2d77      #       us-w
-00004680: 6573 742d 323a 2073 6b79 7069 6c6f 743a  est-2: skypilot:
-00004690: 6770 752d 7562 756e 7475 2d31 3830 340a  gpu-ubuntu-1804.
-000046a0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-000046b0: 2020 2020 7573 2d65 6173 742d 323a 2073      us-east-2: s
-000046c0: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
-000046d0: 7475 2d32 3030 340a 2020 2020 2020 2020  tu-2004.        
-000046e0: 2020 2020 2320 5573 6520 7265 6769 6f6e      # Use region
-000046f0: 2074 6f20 6669 6c74 6572 2069 6d61 6765   to filter image
-00004700: 5f69 6420 6469 6374 2e0a 2020 2020 2020  _id dict..      
-00004710: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00004720: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00004730: 2d2d 7265 6769 6f6e 2075 732d 6561 7374  --region us-east
-00004740: 2d31 2065 7861 6d70 6c65 732f 7065 725f  -1 examples/per_
-00004750: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
-00004760: 6d6c 2026 2620 6578 6974 2031 207c 7c20  ml && exit 1 || 
-00004770: 7472 7565 272c 0a20 2020 2020 2020 2020  true',.         
-00004780: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00004790: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
-000047a0: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
-000047b0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-000047c0: 636c 7573 7465 7220 6973 206e 6f74 2063  cluster is not c
-000047d0: 7265 6174 6564 2e0a 2020 2020 2020 2020  reated..        
-000047e0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-000047f0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00004800: 7265 6769 6f6e 2075 732d 6561 7374 2d32  region us-east-2
-00004810: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
-00004820: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-00004830: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00004840: 2053 686f 756c 6420 7375 6363 6573 7320   Should success 
-00004850: 6265 6361 7573 6520 7468 6520 696d 6167  because the imag
-00004860: 6520 6964 206d 6174 6368 2066 6f72 2074  e id match for t
-00004870: 6865 2072 6567 696f 6e2e 0a20 2020 2020  he region..     
-00004880: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00004890: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
-000048a0: 696d 6167 652d 6964 2073 6b79 7069 6c6f  image-id skypilo
-000048b0: 743a 6770 752d 7562 756e 7475 2d32 3030  t:gpu-ubuntu-200
-000048c0: 3420 6578 616d 706c 6573 2f6d 696e 696d  4 examples/minim
-000048d0: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
-000048e0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000048f0: 207b 6e61 6d65 7d20 2d2d 696d 6167 652d   {name} --image-
-00004900: 6964 2073 6b79 7069 6c6f 743a 6770 752d  id skypilot:gpu-
-00004910: 7562 756e 7475 2d32 3030 3420 6578 616d  ubuntu-2004 exam
-00004920: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
-00004930: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00004940: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00004950: 7d20 2d2d 696d 6167 652d 6964 2073 6b79  } --image-id sky
-00004960: 7069 6c6f 743a 6770 752d 7562 756e 7475  pilot:gpu-ubuntu
-00004970: 2d31 3830 3420 6578 616d 706c 6573 2f6d  -1804 examples/m
-00004980: 696e 696d 616c 2e79 616d 6c20 2626 2065  inimal.yaml && e
-00004990: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
-000049a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000049b0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-000049c0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-000049d0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000049e0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-000049f0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00004a00: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00004a10: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
-00004a20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004a30: 6b79 2073 7461 7475 7320 2d2d 616c 6c20  ky status --all 
-00004a40: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00004a50: 6772 6570 2075 732d 6561 7374 2d32 272c  grep us-east-2',
-00004a60: 2020 2320 456e 7375 7265 2074 6865 2072    # Ensure the r
-00004a70: 6567 696f 6e20 6973 2063 6f72 7265 6374  egion is correct
-00004a80: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00004a90: 456e 7375 7265 2065 7865 6320 776f 726b  Ensure exec work
-00004aa0: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
-00004ab0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00004ac0: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
-00004ad0: 742d 3220 6578 616d 706c 6573 2f70 6572  t-2 examples/per
-00004ae0: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
-00004af0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00004b00: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00004b10: 6d65 7d20 6578 616d 706c 6573 2f70 6572  me} examples/per
-00004b20: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
-00004b30: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00004b40: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00004b50: 6d65 7d20 2d2d 636c 6f75 6420 6177 7320  me} --cloud aws 
-00004b60: 2d2d 7265 6769 6f6e 2075 732d 6561 7374  --region us-east
-00004b70: 2d32 2022 6c73 207e 2227 2c0a 2020 2020  -2 "ls ~"',.    
-00004b80: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00004b90: 6563 207b 6e61 6d65 7d20 226c 7320 7e22  ec {name} "ls ~"
-00004ba0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00004bb0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00004bc0: 2034 202d 2d73 7461 7475 7327 2c0a 2020   4 --status',.  
-00004bd0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004be0: 6c6f 6773 207b 6e61 6d65 7d20 3520 2d2d  logs {name} 5 --
-00004bf0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00004c00: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00004c10: 7b6e 616d 657d 2036 202d 2d73 7461 7475  {name} 6 --statu
-00004c20: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00004c30: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00004c40: 7d20 3720 2d2d 7374 6174 7573 272c 0a20  } 7 --status',. 
-00004c50: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00004c60: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00004c70: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00004c80: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00004c90: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00004ca0: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
-00004cb0: 745f 6763 705f 696d 6167 655f 6964 5f64  t_gcp_image_id_d
-00004cc0: 6963 745f 7265 6769 6f6e 2829 3a0a 2020  ict_region():.  
-00004cd0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00004ce0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00004cf0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00004d00: 2020 2020 2020 2767 6370 5f69 6d61 6765        'gcp_image
-00004d10: 5f69 645f 6469 6374 5f72 6567 696f 6e27  _id_dict_region'
-00004d20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00004d30: 2020 2020 2020 2020 2320 5573 6520 7265          # Use re
-00004d40: 6769 6f6e 2074 6f20 6669 6c74 6572 2069  gion to filter i
-00004d50: 6d61 6765 5f69 6420 6469 6374 2e0a 2020  mage_id dict..  
-00004d60: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004d70: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00004d80: 6d65 7d20 2d2d 7265 6769 6f6e 2075 732d  me} --region us-
-00004d90: 6561 7374 3120 7465 7374 732f 7465 7374  east1 tests/test
-00004da0: 5f79 616d 6c73 2f67 6370 5f70 6572 5f72  _yamls/gcp_per_r
-00004db0: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
-00004dc0: 6c20 2626 2065 7869 7420 3120 7c7c 2074  l && exit 1 || t
-00004dd0: 7275 6527 2c0a 2020 2020 2020 2020 2020  rue',.          
-00004de0: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-00004df0: 2067 7265 7020 7b6e 616d 657d 2026 2620   grep {name} && 
-00004e00: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
-00004e10: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-00004e20: 6c75 7374 6572 2069 7320 6e6f 7420 6372  luster is not cr
-00004e30: 6561 7465 642e 0a20 2020 2020 2020 2020  eated..         
-00004e40: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00004e50: 2d79 202d 6320 7b6e 616d 657d 202d 2d72  -y -c {name} --r
-00004e60: 6567 696f 6e20 7573 2d77 6573 7433 2074  egion us-west3 t
-00004e70: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00004e80: 6763 705f 7065 725f 7265 6769 6f6e 5f69  gcp_per_region_i
-00004e90: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
-00004ea0: 2020 2020 2020 2020 2023 2053 686f 756c           # Shoul
-00004eb0: 6420 7375 6363 6573 7320 6265 6361 7573  d success becaus
-00004ec0: 6520 7468 6520 696d 6167 6520 6964 206d  e the image id m
-00004ed0: 6174 6368 2066 6f72 2074 6865 2072 6567  atch for the reg
-00004ee0: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
-00004ef0: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
-00004f00: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00004f10: 6763 7020 2d2d 696d 6167 652d 6964 2070  gcp --image-id p
-00004f20: 726f 6a65 6374 732f 7562 756e 7475 2d6f  rojects/ubuntu-o
-00004f30: 732d 636c 6f75 642f 676c 6f62 616c 2f69  s-cloud/global/i
-00004f40: 6d61 6765 732f 7562 756e 7475 2d31 3830  mages/ubuntu-180
-00004f50: 342d 6269 6f6e 6963 2d76 3230 3233 3031  4-bionic-v202301
-00004f60: 3132 2074 6573 7473 2f74 6573 745f 7961  12 tests/test_ya
-00004f70: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-00004f80: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00004f90: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00004fa0: 202d 2d63 6c6f 7564 2067 6370 202d 2d69   --cloud gcp --i
-00004fb0: 6d61 6765 2d69 6420 7072 6f6a 6563 7473  mage-id projects
-00004fc0: 2f75 6275 6e74 752d 6f73 2d63 6c6f 7564  /ubuntu-os-cloud
-00004fd0: 2f67 6c6f 6261 6c2f 696d 6167 6573 2f75  /global/images/u
-00004fe0: 6275 6e74 752d 3138 3034 2d62 696f 6e69  buntu-1804-bioni
-00004ff0: 632d 7632 3032 3330 3131 3220 7465 7374  c-v20230112 test
-00005000: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00005010: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00005020: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00005030: 6563 207b 6e61 6d65 7d20 2d2d 636c 6f75  ec {name} --clou
-00005040: 6420 6763 7020 2d2d 696d 6167 652d 6964  d gcp --image-id
-00005050: 2073 6b79 7069 6c6f 743a 6370 752d 6465   skypilot:cpu-de
-00005060: 6269 616e 2d31 3020 7465 7374 732f 7465  bian-10 tests/te
-00005070: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-00005080: 2e79 616d 6c20 2626 2065 7869 7420 3120  .yaml && exit 1 
-00005090: 7c7c 2074 7275 6527 2c0a 2020 2020 2020  || true',.      
-000050a0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000050b0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-000050c0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-000050d0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-000050e0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
-000050f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005100: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
-00005110: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00005120: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00005130: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
-00005140: 207b 6e61 6d65 7d20 7c20 6772 6570 2075   {name} | grep u
-00005150: 732d 7765 7374 3327 2c20 2023 2045 6e73  s-west3',  # Ens
-00005160: 7572 6520 7468 6520 7265 6769 6f6e 2069  ure the region i
-00005170: 7320 636f 7272 6563 742e 0a20 2020 2020  s correct..     
-00005180: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00005190: 6578 6563 2077 6f72 6b73 2e0a 2020 2020  exec works..    
-000051a0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-000051b0: 6563 207b 6e61 6d65 7d20 2d2d 7265 6769  ec {name} --regi
-000051c0: 6f6e 2075 732d 7765 7374 3320 7465 7374  on us-west3 test
-000051d0: 732f 7465 7374 5f79 616d 6c73 2f67 6370  s/test_yamls/gcp
-000051e0: 5f70 6572 5f72 6567 696f 6e5f 696d 6167  _per_region_imag
-000051f0: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
-00005200: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00005210: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
-00005220: 7374 5f79 616d 6c73 2f67 6370 5f70 6572  st_yamls/gcp_per
-00005230: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
-00005240: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00005250: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00005260: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
-00005270: 2d2d 7265 6769 6f6e 2075 732d 7765 7374  --region us-west
-00005280: 3320 226c 7320 7e22 272c 0a20 2020 2020  3 "ls ~"',.     
-00005290: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000052a0: 6320 7b6e 616d 657d 2022 6c73 207e 2227  c {name} "ls ~"'
-000052b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000052c0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-000052d0: 3420 2d2d 7374 6174 7573 272c 0a20 2020  4 --status',.   
-000052e0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000052f0: 6f67 7320 7b6e 616d 657d 2035 202d 2d73  ogs {name} 5 --s
-00005300: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00005310: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00005320: 6e61 6d65 7d20 3620 2d2d 7374 6174 7573  name} 6 --status
-00005330: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005340: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00005350: 2037 202d 2d73 7461 7475 7327 2c0a 2020   7 --status',.  
-00005360: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00005370: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00005380: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00005390: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-000053a0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-000053b0: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
-000053c0: 5f61 7773 5f69 6d61 6765 5f69 645f 6469  _aws_image_id_di
-000053d0: 6374 5f7a 6f6e 6528 293a 0a20 2020 206e  ct_zone():.    n
-000053e0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-000053f0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00005400: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00005410: 2020 2027 6177 735f 696d 6167 655f 6964     'aws_image_id
-00005420: 5f64 6963 745f 7a6f 6e65 272c 0a20 2020  _dict_zone',.   
-00005430: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00005440: 2020 2023 2059 414d 4c20 6861 730a 2020     # YAML has.  
-00005450: 2020 2020 2020 2020 2020 2320 2020 696d            #   im
-00005460: 6167 655f 6964 3a0a 2020 2020 2020 2020  age_id:.        
-00005470: 2020 2020 2320 2020 2020 2020 7573 2d77      #       us-w
-00005480: 6573 742d 323a 2073 6b79 7069 6c6f 743a  est-2: skypilot:
-00005490: 6770 752d 7562 756e 7475 2d31 3830 340a  gpu-ubuntu-1804.
-000054a0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-000054b0: 2020 2020 7573 2d65 6173 742d 323a 2073      us-east-2: s
-000054c0: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
-000054d0: 7475 2d32 3030 340a 2020 2020 2020 2020  tu-2004.        
-000054e0: 2020 2020 2320 5573 6520 7a6f 6e65 2074      # Use zone t
-000054f0: 6f20 6669 6c74 6572 2069 6d61 6765 5f69  o filter image_i
-00005500: 6420 6469 6374 2e0a 2020 2020 2020 2020  d dict..        
-00005510: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00005520: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00005530: 7a6f 6e65 2075 732d 6561 7374 2d31 6220  zone us-east-1b 
-00005540: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
-00005550: 696f 6e5f 696d 6167 6573 2e79 616d 6c20  ion_images.yaml 
-00005560: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
-00005570: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00005580: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
-00005590: 7265 7020 7b6e 616d 657d 2026 2620 6578  rep {name} && ex
-000055a0: 6974 2031 207c 7c20 7472 7565 272c 2020  it 1 || true',  
-000055b0: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
-000055c0: 7374 6572 2069 7320 6e6f 7420 6372 6561  ster is not crea
-000055d0: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
-000055e0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000055f0: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
-00005600: 6520 7573 2d65 6173 742d 3261 2065 7861  e us-east-2a exa
-00005610: 6d70 6c65 732f 7065 725f 7265 6769 6f6e  mples/per_region
-00005620: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
-00005630: 2020 2020 2020 2020 2020 2023 2053 686f             # Sho
-00005640: 756c 6420 7375 6363 6573 7320 6265 6361  uld success beca
-00005650: 7573 6520 7468 6520 696d 6167 6520 6964  use the image id
-00005660: 206d 6174 6368 2066 6f72 2074 6865 207a   match for the z
-00005670: 6f6e 652e 0a20 2020 2020 2020 2020 2020  one..           
-00005680: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00005690: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
-000056a0: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
-000056b0: 7075 2d75 6275 6e74 752d 3230 3034 2065  pu-ubuntu-2004 e
-000056c0: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
-000056d0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-000056e0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-000056f0: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
-00005700: 736b 7970 696c 6f74 3a67 7075 2d75 6275  skypilot:gpu-ubu
-00005710: 6e74 752d 3230 3034 2065 7861 6d70 6c65  ntu-2004 example
-00005720: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00005730: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-00005740: 6169 6c20 6475 6520 746f 2069 6d61 6765  ail due to image
-00005750: 2069 6420 6d69 736d 6174 6368 2e0a 2020   id mismatch..  
-00005760: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005770: 6578 6563 207b 6e61 6d65 7d20 2d2d 696d  exec {name} --im
-00005780: 6167 652d 6964 2073 6b79 7069 6c6f 743a  age-id skypilot:
-00005790: 6770 752d 7562 756e 7475 2d31 3830 3420  gpu-ubuntu-1804 
-000057a0: 6578 616d 706c 6573 2f6d 696e 696d 616c  examples/minimal
-000057b0: 2e79 616d 6c20 2626 2065 7869 7420 3120  .yaml && exit 1 
-000057c0: 7c7c 2074 7275 6527 2c0a 2020 2020 2020  || true',.      
-000057d0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000057e0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-000057f0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00005800: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00005810: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
-00005820: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005830: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
-00005840: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00005850: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00005860: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
-00005870: 207b 6e61 6d65 7d20 7c20 6772 6570 2075   {name} | grep u
-00005880: 732d 6561 7374 2d32 6127 2c20 2023 2045  s-east-2a',  # E
-00005890: 6e73 7572 6520 7468 6520 7a6f 6e65 2069  nsure the zone i
-000058a0: 7320 636f 7272 6563 742e 0a20 2020 2020  s correct..     
-000058b0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-000058c0: 6578 6563 2077 6f72 6b73 2e0a 2020 2020  exec works..    
-000058d0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-000058e0: 6563 207b 6e61 6d65 7d20 2d2d 7a6f 6e65  ec {name} --zone
-000058f0: 2075 732d 6561 7374 2d32 6120 6578 616d   us-east-2a exam
-00005900: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
-00005910: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
-00005920: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005930: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
-00005940: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
-00005950: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
-00005960: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005970: 6578 6563 207b 6e61 6d65 7d20 2d2d 636c  exec {name} --cl
-00005980: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
-00005990: 2075 732d 6561 7374 2d32 2022 6c73 207e   us-east-2 "ls ~
-000059a0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000059b0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-000059c0: 7d20 226c 7320 7e22 272c 0a20 2020 2020  } "ls ~"',.     
-000059d0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000059e0: 7320 7b6e 616d 657d 2034 202d 2d73 7461  s {name} 4 --sta
-000059f0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00005a00: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00005a10: 6d65 7d20 3520 2d2d 7374 6174 7573 272c  me} 5 --status',
-00005a20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005a30: 6b79 206c 6f67 7320 7b6e 616d 657d 2036  ky logs {name} 6
-00005a40: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00005a50: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00005a60: 6773 207b 6e61 6d65 7d20 3720 2d2d 7374  gs {name} 7 --st
-00005a70: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-00005a80: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00005a90: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00005aa0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00005ab0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00005ac0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-00005ad0: 0a64 6566 2074 6573 745f 6763 705f 696d  .def test_gcp_im
-00005ae0: 6167 655f 6964 5f64 6963 745f 7a6f 6e65  age_id_dict_zone
-00005af0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00005b00: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00005b10: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00005b20: 7374 280a 2020 2020 2020 2020 2767 6370  st(.        'gcp
-00005b30: 5f69 6d61 6765 5f69 645f 6469 6374 5f7a  _image_id_dict_z
-00005b40: 6f6e 6527 2c0a 2020 2020 2020 2020 5b0a  one',.        [.
-00005b50: 2020 2020 2020 2020 2020 2020 2320 5573              # Us
-00005b60: 6520 7a6f 6e65 2074 6f20 6669 6c74 6572  e zone to filter
-00005b70: 2069 6d61 6765 5f69 6420 6469 6374 2e0a   image_id dict..
-00005b80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005b90: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00005ba0: 6e61 6d65 7d20 2d2d 7a6f 6e65 2075 732d  name} --zone us-
-00005bb0: 6561 7374 312d 6120 7465 7374 732f 7465  east1-a tests/te
-00005bc0: 7374 5f79 616d 6c73 2f67 6370 5f70 6572  st_yamls/gcp_per
-00005bd0: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
-00005be0: 616d 6c20 2626 2065 7869 7420 3120 7c7c  aml && exit 1 ||
-00005bf0: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
-00005c00: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-00005c10: 207c 2067 7265 7020 7b6e 616d 657d 2026   | grep {name} &
-00005c20: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
-00005c30: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00005c40: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
-00005c50: 6372 6561 7465 642e 0a20 2020 2020 2020  created..       
-00005c60: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00005c70: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00005c80: 2d7a 6f6e 6520 7573 2d63 656e 7472 616c  -zone us-central
-00005c90: 312d 6120 7465 7374 732f 7465 7374 5f79  1-a tests/test_y
-00005ca0: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
-00005cb0: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
-00005cc0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00005cd0: 5368 6f75 6c64 2073 7563 6365 7373 2062  Should success b
-00005ce0: 6563 6175 7365 2074 6865 2069 6d61 6765  ecause the image
-00005cf0: 2069 6420 6d61 7463 6820 666f 7220 7468   id match for th
-00005d00: 6520 7a6f 6e65 2e0a 2020 2020 2020 2020  e zone..        
-00005d10: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00005d20: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00005d30: 636c 6f75 6420 6763 7020 2d2d 696d 6167  cloud gcp --imag
-00005d40: 652d 6964 2073 6b79 7069 6c6f 743a 6370  e-id skypilot:cp
-00005d50: 752d 6465 6269 616e 2d31 3020 7465 7374  u-debian-10 test
-00005d60: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00005d70: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00005d80: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00005d90: 6563 207b 6e61 6d65 7d20 2d2d 636c 6f75  ec {name} --clou
-00005da0: 6420 6763 7020 2d2d 696d 6167 652d 6964  d gcp --image-id
-00005db0: 2073 6b79 7069 6c6f 743a 6370 752d 6465   skypilot:cpu-de
-00005dc0: 6269 616e 2d31 3020 7465 7374 732f 7465  bian-10 tests/te
-00005dd0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-00005de0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00005df0: 2020 2020 2320 4661 696c 2064 7565 2074      # Fail due t
-00005e00: 6f20 696d 6167 6520 6964 206d 6973 6d61  o image id misma
-00005e10: 7463 682e 0a20 2020 2020 2020 2020 2020  tch..           
-00005e20: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00005e30: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
-00005e40: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
-00005e50: 6f74 3a67 7075 2d64 6562 6961 6e2d 3130  ot:gpu-debian-10
-00005e60: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00005e70: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 2026  s/minimal.yaml &
-00005e80: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
-00005e90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005ea0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00005eb0: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-00005ec0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005ed0: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-00005ee0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00005ef0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00005f00: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
-00005f10: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00005f20: 6627 736b 7920 7374 6174 7573 202d 2d61  f'sky status --a
-00005f30: 6c6c 207c 2067 7265 7020 7b6e 616d 657d  ll | grep {name}
-00005f40: 207c 2067 7265 7020 7573 2d63 656e 7472   | grep us-centr
-00005f50: 616c 3127 2c20 2023 2045 6e73 7572 6520  al1',  # Ensure 
-00005f60: 7468 6520 7a6f 6e65 2069 7320 636f 7272  the zone is corr
-00005f70: 6563 742e 0a20 2020 2020 2020 2020 2020  ect..           
-00005f80: 2023 2045 6e73 7572 6520 6578 6563 2077   # Ensure exec w
-00005f90: 6f72 6b73 2e0a 2020 2020 2020 2020 2020  orks..          
-00005fa0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00005fb0: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
-00005fc0: 2d2d 7a6f 6e65 2075 732d 6365 6e74 7261  --zone us-centra
-00005fd0: 6c31 2d61 2074 6573 7473 2f74 6573 745f  l1-a tests/test_
-00005fe0: 7961 6d6c 732f 6763 705f 7065 725f 7265  yamls/gcp_per_re
-00005ff0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-00006000: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006010: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00006020: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00006030: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
-00006040: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
-00006050: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00006060: 2065 7865 6320 7b6e 616d 657d 202d 2d63   exec {name} --c
-00006070: 6c6f 7564 2067 6370 202d 2d72 6567 696f  loud gcp --regio
-00006080: 6e20 7573 2d63 656e 7472 616c 3120 226c  n us-central1 "l
-00006090: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
-000060a0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-000060b0: 616d 657d 2022 6c73 207e 2227 2c0a 2020  ame} "ls ~"',.  
-000060c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000060d0: 6c6f 6773 207b 6e61 6d65 7d20 3420 2d2d  logs {name} 4 --
-000060e0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-000060f0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00006100: 7b6e 616d 657d 2035 202d 2d73 7461 7475  {name} 5 --statu
-00006110: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00006120: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00006130: 7d20 3620 2d2d 7374 6174 7573 272c 0a20  } 6 --status',. 
-00006140: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00006150: 206c 6f67 7320 7b6e 616d 657d 2037 202d   logs {name} 7 -
-00006160: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00006170: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00006180: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00006190: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-000061a0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000061b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000061c0: 6177 730a 6465 6620 7465 7374 5f63 6c6f  aws.def test_clo
-000061d0: 6e65 5f64 6973 6b5f 6177 7328 293a 0a20  ne_disk_aws():. 
-000061e0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000061f0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00006200: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00006210: 2020 2020 2020 2027 636c 6f6e 655f 6469         'clone_di
-00006220: 736b 5f61 7773 272c 0a20 2020 2020 2020  sk_aws',.       
-00006230: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00006240: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00006250: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00006260: 2061 7773 202d 2d72 6567 696f 6e20 7573   aws --region us
-00006270: 2d65 6173 742d 3220 2d2d 7265 7472 792d  -east-2 --retry-
-00006280: 756e 7469 6c2d 7570 2022 6563 686f 2068  until-up "echo h
-00006290: 656c 6c6f 203e 207e 2f75 7365 725f 6669  ello > ~/user_fi
-000062a0: 6c65 2e74 7874 2227 2c0a 2020 2020 2020  le.txt"',.      
-000062b0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000062c0: 6368 202d 2d63 6c6f 6e65 2d64 6973 6b2d  ch --clone-disk-
-000062d0: 6672 6f6d 207b 6e61 6d65 7d20 2d79 202d  from {name} -y -
-000062e0: 6320 7b6e 616d 657d 2d63 6c6f 6e65 2026  c {name}-clone &
-000062f0: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
-00006300: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006310: 2773 6b79 2073 746f 7020 7b6e 616d 657d  'sky stop {name}
-00006320: 202d 7927 2c0a 2020 2020 2020 2020 2020   -y',.          
-00006330: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-00006340: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006350: 6c61 756e 6368 202d 2d63 6c6f 6e65 2d64  launch --clone-d
-00006360: 6973 6b2d 6672 6f6d 207b 6e61 6d65 7d20  isk-from {name} 
-00006370: 2d79 202d 6320 7b6e 616d 657d 2d63 6c6f  -y -c {name}-clo
-00006380: 6e65 202d 2d63 6c6f 7564 2061 7773 202d  ne --cloud aws -
-00006390: 6420 2d2d 7265 6769 6f6e 2075 732d 6561  d --region us-ea
-000063a0: 7374 2d32 2022 6361 7420 7e2f 7573 6572  st-2 "cat ~/user
-000063b0: 5f66 696c 652e 7478 7420 7c20 6772 6570  _file.txt | grep
-000063c0: 2068 656c 6c6f 2227 2c0a 2020 2020 2020   hello"',.      
-000063d0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000063e0: 6368 202d 2d63 6c6f 6e65 2d64 6973 6b2d  ch --clone-disk-
-000063f0: 6672 6f6d 207b 6e61 6d65 7d20 2d79 202d  from {name} -y -
-00006400: 6320 7b6e 616d 657d 2d63 6c6f 6e65 2d32  c {name}-clone-2
-00006410: 202d 2d63 6c6f 7564 2061 7773 202d 6420   --cloud aws -d 
-00006420: 2d2d 7265 6769 6f6e 2075 732d 6561 7374  --region us-east
-00006430: 2d32 2022 6361 7420 7e2f 7573 6572 5f66  -2 "cat ~/user_f
-00006440: 696c 652e 7478 7420 7c20 6772 6570 2068  ile.txt | grep h
-00006450: 656c 6c6f 2227 2c0a 2020 2020 2020 2020  ello"',.        
-00006460: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00006470: 6e61 6d65 7d2d 636c 6f6e 6520 3120 2d2d  name}-clone 1 --
-00006480: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00006490: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000064a0: 7b6e 616d 657d 2d63 6c6f 6e65 2d32 2031  {name}-clone-2 1
-000064b0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-000064c0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-000064d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-000064e0: 6d65 7d20 7b6e 616d 657d 2d63 6c6f 6e65  me} {name}-clone
-000064f0: 207b 6e61 6d65 7d2d 636c 6f6e 652d 3227   {name}-clone-2'
-00006500: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00006510: 743d 3330 202a 2036 302c 0a20 2020 2029  t=30 * 60,.    )
-00006520: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00006530: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00006540: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-00006550: 6573 745f 636c 6f6e 655f 6469 736b 5f67  est_clone_disk_g
-00006560: 6370 2829 3a0a 2020 2020 6e61 6d65 203d  cp():.    name =
-00006570: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00006580: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00006590: 5465 7374 280a 2020 2020 2020 2020 2763  Test(.        'c
-000065a0: 6c6f 6e65 5f64 6973 6b5f 6763 7027 2c0a  lone_disk_gcp',.
-000065b0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-000065c0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000065d0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-000065e0: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
-000065f0: 6e65 2075 732d 6561 7374 312d 6220 2d2d  ne us-east1-b --
-00006600: 7265 7472 792d 756e 7469 6c2d 7570 2022  retry-until-up "
-00006610: 6563 686f 2068 656c 6c6f 203e 207e 2f75  echo hello > ~/u
-00006620: 7365 725f 6669 6c65 2e74 7874 2227 2c0a  ser_file.txt"',.
-00006630: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00006640: 7920 6c61 756e 6368 202d 2d63 6c6f 6e65  y launch --clone
-00006650: 2d64 6973 6b2d 6672 6f6d 207b 6e61 6d65  -disk-from {name
-00006660: 7d20 2d79 202d 6320 7b6e 616d 657d 2d63  } -y -c {name}-c
-00006670: 6c6f 6e65 2026 2620 6578 6974 2031 207c  lone && exit 1 |
-00006680: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
-00006690: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
-000066a0: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
-000066b0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-000066c0: 756e 6368 202d 2d63 6c6f 6e65 2d64 6973  unch --clone-dis
-000066d0: 6b2d 6672 6f6d 207b 6e61 6d65 7d20 2d79  k-from {name} -y
-000066e0: 202d 6320 7b6e 616d 657d 2d63 6c6f 6e65   -c {name}-clone
-000066f0: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
-00006700: 6f6e 6520 7573 2d63 656e 7472 616c 312d  one us-central1-
-00006710: 6120 2263 6174 207e 2f75 7365 725f 6669  a "cat ~/user_fi
-00006720: 6c65 2e74 7874 207c 2067 7265 7020 6865  le.txt | grep he
-00006730: 6c6c 6f22 272c 0a20 2020 2020 2020 2020  llo"',.         
-00006740: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00006750: 2d2d 636c 6f6e 652d 6469 736b 2d66 726f  --clone-disk-fro
-00006760: 6d20 7b6e 616d 657d 202d 7920 2d63 207b  m {name} -y -c {
-00006770: 6e61 6d65 7d2d 636c 6f6e 652d 3220 2d2d  name}-clone-2 --
-00006780: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
-00006790: 2075 732d 6561 7374 312d 6220 2263 6174   us-east1-b "cat
-000067a0: 207e 2f75 7365 725f 6669 6c65 2e74 7874   ~/user_file.txt
-000067b0: 207c 2067 7265 7020 6865 6c6c 6f22 272c   | grep hello"',
-000067c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000067d0: 6b79 206c 6f67 7320 7b6e 616d 657d 2d63  ky logs {name}-c
-000067e0: 6c6f 6e65 2031 202d 2d73 7461 7475 7327  lone 1 --status'
-000067f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00006800: 736b 7920 6c6f 6773 207b 6e61 6d65 7d2d  sky logs {name}-
-00006810: 636c 6f6e 652d 3220 3120 2d2d 7374 6174  clone-2 1 --stat
-00006820: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
-00006830: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00006840: 776e 202d 7920 7b6e 616d 657d 207b 6e61  wn -y {name} {na
-00006850: 6d65 7d2d 636c 6f6e 6520 7b6e 616d 657d  me}-clone {name}
-00006860: 2d63 6c6f 6e65 2d32 272c 0a20 2020 2029  -clone-2',.    )
-00006870: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00006880: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00006890: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
-000068a0: 6573 745f 696d 6167 655f 6e6f 5f63 6f6e  est_image_no_con
-000068b0: 6461 2829 3a0a 2020 2020 6e61 6d65 203d  da():.    name =
-000068c0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000068d0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-000068e0: 5465 7374 280a 2020 2020 2020 2020 2769  Test(.        'i
-000068f0: 6d61 6765 5f6e 6f5f 636f 6e64 6127 2c0a  mage_no_conda',.
-00006900: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00006910: 2020 2020 2020 2320 5573 6520 696d 6167        # Use imag
-00006920: 6520 6964 2064 6963 742e 0a20 2020 2020  e id dict..     
-00006930: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00006940: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00006950: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
-00006960: 742d 3220 6578 616d 706c 6573 2f70 6572  t-2 examples/per
-00006970: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
-00006980: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00006990: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000069a0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-000069b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000069c0: 6b79 2073 746f 7020 7b6e 616d 657d 202d  ky stop {name} -
-000069d0: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
-000069e0: 6627 736b 7920 7374 6172 7420 7b6e 616d  f'sky start {nam
-000069f0: 657d 202d 7927 2c0a 2020 2020 2020 2020  e} -y',.        
-00006a00: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00006a10: 6e61 6d65 7d20 6578 616d 706c 6573 2f70  name} examples/p
-00006a20: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-00006a30: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00006a40: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00006a50: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-00006a60: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00006a70: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00006a80: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00006a90: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00006aa0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00006ab0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-00006ac0: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
-00006ad0: 6574 6573 2064 6f65 7320 6e6f 7420 7375  etes does not su
-00006ae0: 7070 6f72 7420 7374 6f70 7069 6e67 2069  pport stopping i
-00006af0: 6e73 7461 6e63 6573 0a64 6566 2074 6573  nstances.def tes
-00006b00: 745f 6375 7374 6f6d 5f64 6566 6175 6c74  t_custom_default
-00006b10: 5f63 6f6e 6461 5f65 6e76 2867 656e 6572  _conda_env(gener
-00006b20: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
-00006b30: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00006b40: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00006b50: 2020 2074 6573 7420 3d20 5465 7374 2827     test = Test('
-00006b60: 6375 7374 6f6d 5f64 6566 6175 6c74 5f63  custom_default_c
-00006b70: 6f6e 6461 5f65 6e76 272c 205b 0a20 2020  onda_env', [.   
-00006b80: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00006b90: 6820 2d63 207b 6e61 6d65 7d20 2d79 202d  h -c {name} -y -
-00006ba0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00006bb0: 636c 6f75 647d 2074 6573 7473 2f74 6573  cloud} tests/tes
-00006bc0: 745f 7961 6d6c 732f 7465 7374 5f63 7573  t_yamls/test_cus
-00006bd0: 746f 6d5f 6465 6661 756c 745f 636f 6e64  tom_default_cond
-00006be0: 615f 656e 762e 7961 6d6c 272c 0a20 2020  a_env.yaml',.   
-00006bf0: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-00006c00: 7320 2d72 207b 6e61 6d65 7d20 7c20 6772  s -r {name} | gr
-00006c10: 6570 2022 5550 2227 2c0a 2020 2020 2020  ep "UP"',.      
-00006c20: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00006c30: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00006c40: 0a20 2020 2020 2020 2066 2773 6b79 206c  .        f'sky l
-00006c50: 6f67 7320 7b6e 616d 657d 2031 202d 2d6e  ogs {name} 1 --n
-00006c60: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
-00006c70: 2d50 2022 6d79 656e 765c 5c73 2b5c 5c2a  -P "myenv\\s+\\*
-00006c80: 2227 2c0a 2020 2020 2020 2020 6627 736b  "',.        f'sk
-00006c90: 7920 6578 6563 207b 6e61 6d65 7d20 7465  y exec {name} te
-00006ca0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-00006cb0: 6573 745f 6375 7374 6f6d 5f64 6566 6175  est_custom_defau
-00006cc0: 6c74 5f63 6f6e 6461 5f65 6e76 2e79 616d  lt_conda_env.yam
-00006cd0: 6c27 2c0a 2020 2020 2020 2020 6627 736b  l',.        f'sk
-00006ce0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-00006cf0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00006d00: 2020 2066 2773 6b79 2061 7574 6f73 746f     f'sky autosto
-00006d10: 7020 2d79 202d 6920 3020 7b6e 616d 657d  p -y -i 0 {name}
-00006d20: 272c 0a20 2020 2020 2020 2027 736c 6565  ',.        'slee
-00006d30: 7020 3630 272c 0a20 2020 2020 2020 2066  p 60',.        f
-00006d40: 2773 6b79 2073 7461 7475 7320 2d72 207b  'sky status -r {
-00006d50: 6e61 6d65 7d20 7c20 6772 6570 2022 5354  name} | grep "ST
-00006d60: 4f50 5045 4422 272c 0a20 2020 2020 2020  OPPED"',.       
-00006d70: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
-00006d80: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-00006d90: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00006da0: 657d 2032 202d 2d6e 6f2d 666f 6c6c 6f77  e} 2 --no-follow
-00006db0: 207c 2067 7265 7020 2d50 2022 6d79 656e   | grep -P "myen
-00006dc0: 765c 5c73 2b5c 5c2a 2227 2c0a 2020 2020  v\\s+\\*"',.    
-00006dd0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00006de0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00006df0: 5f79 616d 6c73 2f74 6573 745f 6375 7374  _yamls/test_cust
-00006e00: 6f6d 5f64 6566 6175 6c74 5f63 6f6e 6461  om_default_conda
-00006e10: 5f65 6e76 2e79 616d 6c27 2c0a 2020 2020  _env.yaml',.    
-00006e20: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00006e30: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
-00006e40: 272c 0a20 2020 205d 2c20 6627 736b 7920  ',.    ], f'sky 
-00006e50: 646f 776e 202d 7920 7b6e 616d 657d 2729  down -y {name}')
-00006e60: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00006e70: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00006e80: 2d2d 2d2d 2d2d 2d2d 2054 6573 7420 7374  -------- Test st
-00006e90: 616c 6520 6a6f 6220 2d2d 2d2d 2d2d 2d2d  ale job --------
-00006ea0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00006eb0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-00006ec0: 2023 2046 6c75 6964 5374 6163 6b20 646f   # FluidStack do
-00006ed0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00006ee0: 746f 7070 696e 6720 696e 7374 616e 6365  topping instance
-00006ef0: 7320 696e 2053 6b79 5069 6c6f 7420 696d  s in SkyPilot im
-00006f00: 706c 656d 656e 7461 7469 6f6e 0a40 7079  plementation.@py
-00006f10: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-00006f20: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-00006f30: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-00006f40: 6f74 2073 7570 706f 7274 2073 746f 7070  ot support stopp
-00006f50: 696e 6720 696e 7374 616e 6365 730a 4070  ing instances.@p
-00006f60: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
-00006f70: 6265 726e 6574 6573 2020 2320 4b75 6265  bernetes  # Kube
-00006f80: 726e 6574 6573 2064 6f65 7320 6e6f 7420  rnetes does not 
-00006f90: 7375 7070 6f72 7420 7374 6f70 7069 6e67  support stopping
-00006fa0: 2069 6e73 7461 6e63 6573 0a64 6566 2074   instances.def t
-00006fb0: 6573 745f 7374 616c 655f 6a6f 6228 6765  est_stale_job(ge
-00006fc0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-00006fd0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00006fe0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00006ff0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00007000: 7428 0a20 2020 2020 2020 2027 7374 616c  t(.        'stal
-00007010: 655f 6a6f 6227 2c0a 2020 2020 2020 2020  e_job',.        
-00007020: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00007030: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00007040: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00007050: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00007060: 2265 6368 6f20 6869 2227 2c0a 2020 2020  "echo hi"',.    
-00007070: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00007080: 6563 207b 6e61 6d65 7d20 2d64 2022 6563  ec {name} -d "ec
-00007090: 686f 2073 7461 7274 3b20 736c 6565 7020  ho start; sleep 
-000070a0: 3130 3030 3022 272c 0a20 2020 2020 2020  10000"',.       
-000070b0: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
-000070c0: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
-000070d0: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-000070e0: 3030 272c 2020 2320 456e 7375 7265 2074  00',  # Ensure t
-000070f0: 6869 7320 6973 206c 6172 6765 2065 6e6f  his is large eno
-00007100: 7567 682c 2065 6c73 6520 4743 5020 6c65  ugh, else GCP le
-00007110: 616b 732e 0a20 2020 2020 2020 2020 2020  aks..           
-00007120: 2066 2773 6b79 2073 7461 7274 207b 6e61   f'sky start {na
-00007130: 6d65 7d20 2d79 272c 0a20 2020 2020 2020  me} -y',.       
-00007140: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00007150: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00007160: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00007170: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
-00007180: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
-00007190: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-000071a0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-000071b0: 2046 4149 4c45 4427 2c0a 2020 2020 2020   FAILED',.      
-000071c0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000071d0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000071e0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-000071f0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00007200: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00007210: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
-00007220: 5f73 7461 6c65 5f6a 6f62 5f6d 616e 7561  _stale_job_manua
-00007230: 6c5f 7265 7374 6172 7428 293a 0a20 2020  l_restart():.   
-00007240: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00007250: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00007260: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
-00007270: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
-00007280: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
-00007290: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
-000072a0: 206e 616d 652c 2073 6b79 2e41 5753 2e6d   name, sky.AWS.m
-000072b0: 6178 5f63 6c75 7374 6572 5f6e 616d 655f  ax_cluster_name_
-000072c0: 6c65 6e67 7468 2829 290a 2020 2020 7265  length()).    re
-000072d0: 6769 6f6e 203d 2027 7573 2d65 6173 742d  gion = 'us-east-
-000072e0: 3227 0a20 2020 2074 6573 7420 3d20 5465  2'.    test = Te
-000072f0: 7374 280a 2020 2020 2020 2020 2761 7773  st(.        'aws
-00007300: 5f73 7461 6c65 5f6a 6f62 5f6d 616e 7561  _stale_job_manua
-00007310: 6c5f 7265 7374 6172 7427 2c0a 2020 2020  l_restart',.    
-00007320: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00007330: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00007340: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00007350: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
-00007360: 207b 7265 6769 6f6e 7d20 2265 6368 6f20   {region} "echo 
-00007370: 6869 2227 2c0a 2020 2020 2020 2020 2020  hi"',.          
-00007380: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00007390: 6d65 7d20 2d64 2022 6563 686f 2073 7461  me} -d "echo sta
-000073a0: 7274 3b20 736c 6565 7020 3130 3030 3022  rt; sleep 10000"
-000073b0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-000073c0: 2053 746f 7020 7468 6520 636c 7573 7465   Stop the cluste
-000073d0: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
-000073e0: 2020 2020 2020 2020 6627 6964 3d60 6177          f'id=`aw
-000073f0: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-00007400: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-00007410: 6e20 7b72 6567 696f 6e7d 202d 2d66 696c  n {region} --fil
-00007420: 7465 7273 2027 0a20 2020 2020 2020 2020  ters '.         
-00007430: 2020 2066 274e 616d 653d 7461 673a 7261     f'Name=tag:ra
-00007440: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
-00007450: 616c 7565 733d 7b6e 616d 655f 6f6e 5f63  alues={name_on_c
-00007460: 6c6f 7564 7d20 270a 2020 2020 2020 2020  loud} '.        
-00007470: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
-00007480: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-00007490: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
-000074a0: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
-000074b0: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
-000074c0: 603b 2027 0a20 2020 2020 2020 2020 2020  `; '.           
-000074d0: 2066 2761 7773 2065 6332 2073 746f 702d   f'aws ec2 stop-
-000074e0: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
-000074f0: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-00007500: 2020 2020 2020 2020 2020 272d 2d69 6e73            '--ins
-00007510: 7461 6e63 652d 6964 7320 2469 6427 2c0a  tance-ids $id',.
-00007520: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00007530: 6570 2034 3027 2c0a 2020 2020 2020 2020  ep 40',.        
-00007540: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00007550: 202d 6320 7b6e 616d 657d 202d 7920 2265   -c {name} -y "e
-00007560: 6368 6f20 6869 2227 2c0a 2020 2020 2020  cho hi"',.      
-00007570: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00007580: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-00007590: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-000075a0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-000075b0: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
-000075c0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-000075d0: 7375 7265 2074 6865 2073 6b79 6c65 7420  sure the skylet 
-000075e0: 7570 6461 7465 6420 7468 6520 7374 616c  updated the stal
-000075f0: 6520 6a6f 6220 7374 6174 7573 2e0a 2020  e job status..  
-00007600: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
-00007610: 7020 7b65 7665 6e74 732e 4a6f 6253 6368  p {events.JobSch
-00007620: 6564 756c 6572 4576 656e 742e 4556 454e  edulerEvent.EVEN
-00007630: 545f 494e 5445 5256 414c 5f53 4543 4f4e  T_INTERVAL_SECON
-00007640: 4453 7d27 2c0a 2020 2020 2020 2020 2020  DS}',.          
-00007650: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-00007660: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-00007670: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-00007680: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-00007690: 6570 2046 4149 4c45 4427 2c0a 2020 2020  ep FAILED',.    
-000076a0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-000076b0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-000076c0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-000076d0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000076e0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-000076f0: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
-00007700: 6370 5f73 7461 6c65 5f6a 6f62 5f6d 616e  cp_stale_job_man
-00007710: 7561 6c5f 7265 7374 6172 7428 293a 0a20  ual_restart():. 
-00007720: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00007730: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00007740: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
-00007750: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
-00007760: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
-00007770: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
-00007780: 2020 206e 616d 652c 2073 6b79 2e47 4350     name, sky.GCP
-00007790: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
-000077a0: 655f 6c65 6e67 7468 2829 290a 2020 2020  e_length()).    
-000077b0: 7a6f 6e65 203d 2027 7573 2d77 6573 7432  zone = 'us-west2
-000077c0: 2d61 270a 2020 2020 7175 6572 795f 636d  -a'.    query_cm
-000077d0: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
-000077e0: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
-000077f0: 6c69 7374 202d 2d66 696c 7465 723d 270a  list --filter='.
-00007800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007810: 2066 2722 286c 6162 656c 732e 7261 792d   f'"(labels.ray-
-00007820: 636c 7573 7465 722d 6e61 6d65 3d7b 6e61  cluster-name={na
-00007830: 6d65 5f6f 6e5f 636c 6f75 647d 2922 2027  me_on_cloud})" '
-00007840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007850: 2020 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e    f'--zones={zon
-00007860: 657d 202d 2d66 6f72 6d61 743d 2276 616c  e} --format="val
-00007870: 7565 286e 616d 6529 2227 290a 2020 2020  ue(name)"').    
-00007880: 7374 6f70 5f63 6d64 203d 2028 6627 6763  stop_cmd = (f'gc
-00007890: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
-000078a0: 7461 6e63 6573 2073 746f 7020 2d2d 7a6f  tances stop --zo
-000078b0: 6e65 3d7b 7a6f 6e65 7d27 0a20 2020 2020  ne={zone}'.     
-000078c0: 2020 2020 2020 2020 2020 2066 2720 2d2d             f' --
-000078d0: 7175 6965 7420 2428 7b71 7565 7279 5f63  quiet $({query_c
-000078e0: 6d64 7d29 2729 0a20 2020 2074 6573 7420  md})').    test 
-000078f0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00007900: 2767 6370 5f73 7461 6c65 5f6a 6f62 5f6d  'gcp_stale_job_m
-00007910: 616e 7561 6c5f 7265 7374 6172 7427 2c0a  anual_restart',.
-00007920: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00007930: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00007940: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00007950: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
-00007960: 6e65 207b 7a6f 6e65 7d20 2265 6368 6f20  ne {zone} "echo 
-00007970: 6869 2227 2c0a 2020 2020 2020 2020 2020  hi"',.          
-00007980: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00007990: 6d65 7d20 2d64 2022 6563 686f 2073 7461  me} -d "echo sta
-000079a0: 7274 3b20 736c 6565 7020 3130 3030 3022  rt; sleep 10000"
-000079b0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-000079c0: 2053 746f 7020 7468 6520 636c 7573 7465   Stop the cluste
-000079d0: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
-000079e0: 2020 2020 2020 2020 7374 6f70 5f63 6d64          stop_cmd
-000079f0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00007a00: 6c65 6570 2034 3027 2c0a 2020 2020 2020  leep 40',.      
-00007a10: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00007a20: 6368 202d 6320 7b6e 616d 657d 202d 7920  ch -c {name} -y 
-00007a30: 2265 6368 6f20 6869 2227 2c0a 2020 2020  "echo hi"',.    
-00007a40: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00007a50: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-00007a60: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-00007a70: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00007a80: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
-00007a90: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00007aa0: 456e 7375 7265 2074 6865 2073 6b79 6c65  Ensure the skyle
-00007ab0: 7420 7570 6461 7465 6420 7468 6520 7374  t updated the st
-00007ac0: 616c 6520 6a6f 6220 7374 6174 7573 2e0a  ale job status..
-00007ad0: 2020 2020 2020 2020 2020 2020 6627 736c              f'sl
-00007ae0: 6565 7020 7b65 7665 6e74 732e 4a6f 6253  eep {events.JobS
-00007af0: 6368 6564 756c 6572 4576 656e 742e 4556  chedulerEvent.EV
-00007b00: 454e 545f 494e 5445 5256 414c 5f53 4543  ENT_INTERVAL_SEC
-00007b10: 4f4e 4453 7d27 2c0a 2020 2020 2020 2020  ONDS}',.        
-00007b20: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-00007b30: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
-00007b40: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-00007b50: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
-00007b60: 6772 6570 2046 4149 4c45 4427 2c0a 2020  grep FAILED',.  
-00007b70: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00007b80: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00007b90: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00007ba0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00007bb0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00007bc0: 2d2d 2d20 4368 6563 6b20 536b 7927 7320  --- Check Sky's 
-00007bd0: 656e 7669 726f 6e6d 656e 7420 7661 7269  environment vari
-00007be0: 6162 6c65 733b 2077 6f72 6b64 6972 2e20  ables; workdir. 
-00007bf0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-00007c00: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-00007c10: 7374 6163 6b20 2023 2052 6571 7569 7265  stack  # Require
-00007c20: 7320 616d 617a 6f6e 2053 330a 4070 7974  s amazon S3.@pyt
-00007c30: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
-00007c40: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
-00007c50: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
-00007c60: 7320 3e20 3120 7965 740a 6465 6620 7465  s > 1 yet.def te
-00007c70: 7374 5f65 6e76 5f63 6865 636b 2867 656e  st_env_check(gen
-00007c80: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00007c90: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00007ca0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00007cb0: 0a20 2020 2074 6f74 616c 5f74 696d 656f  .    total_timeo
-00007cc0: 7574 5f6d 696e 7574 6573 203d 2032 3520  ut_minutes = 25 
-00007cd0: 6966 2067 656e 6572 6963 5f63 6c6f 7564  if generic_cloud
-00007ce0: 203d 3d20 2761 7a75 7265 2720 656c 7365   == 'azure' else
-00007cf0: 2031 350a 2020 2020 7465 7374 203d 2054   15.    test = T
-00007d00: 6573 7428 0a20 2020 2020 2020 2027 656e  est(.        'en
-00007d10: 765f 6368 6563 6b27 2c0a 2020 2020 2020  v_check',.      
-00007d20: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00007d30: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00007d40: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-00007d50: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00007d60: 7d20 2d2d 6465 7461 6368 2d73 6574 7570  } --detach-setup
-00007d70: 2065 7861 6d70 6c65 732f 656e 765f 6368   examples/env_ch
-00007d80: 6563 6b2e 7961 6d6c 272c 0a20 2020 2020  eck.yaml',.     
-00007d90: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00007da0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00007db0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00007dc0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00007dd0: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
-00007de0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00007df0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00007e00: 2020 2020 2074 696d 656f 7574 3d74 6f74       timeout=tot
-00007e10: 616c 5f74 696d 656f 7574 5f6d 696e 7574  al_timeout_minut
-00007e20: 6573 202a 2036 302c 0a20 2020 2029 0a20  es * 60,.    ). 
-00007e30: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00007e40: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00007e50: 2d2d 2d2d 2066 696c 655f 6d6f 756e 7473  ---- file_mounts
-00007e60: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-00007e70: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
-00007e80: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
-00007e90: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
-00007ea0: 7320 3e20 3120 7965 742e 2052 756e 2074  s > 1 yet. Run t
-00007eb0: 6573 745f 7363 705f 6669 6c65 5f6d 6f75  est_scp_file_mou
-00007ec0: 6e74 7320 696e 7374 6561 642e 0a64 6566  nts instead..def
-00007ed0: 2074 6573 745f 6669 6c65 5f6d 6f75 6e74   test_file_mount
-00007ee0: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
-00007ef0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-00007f00: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00007f10: 616d 6528 290a 2020 2020 6578 7472 615f  ame().    extra_
-00007f20: 666c 6167 7320 3d20 2727 0a20 2020 2069  flags = ''.    i
-00007f30: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
-00007f40: 696e 2027 6b75 6265 726e 6574 6573 273a  in 'kubernetes':
-00007f50: 0a20 2020 2020 2020 2023 204b 7562 6572  .        # Kuber
-00007f60: 6e65 7465 7320 646f 6573 206e 6f74 2073  netes does not s
-00007f70: 7570 706f 7274 206d 756c 7469 2d6e 6f64  upport multi-nod
-00007f80: 650a 2020 2020 2020 2020 2320 4e4f 5445  e.        # NOTE
-00007f90: 3a20 5468 6973 2074 6573 7420 7769 6c6c  : This test will
-00007fa0: 2066 6169 6c20 6966 2079 6f75 2068 6176   fail if you hav
-00007fb0: 6520 6120 4b75 6265 726e 6574 6573 2063  e a Kubernetes c
-00007fc0: 6c75 7374 6572 2072 756e 6e69 6e67 206f  luster running o
-00007fd0: 6e0a 2020 2020 2020 2020 2320 2061 726d  n.        #  arm
-00007fe0: 3634 2028 652e 672e 2c20 4170 706c 6520  64 (e.g., Apple 
-00007ff0: 5369 6c69 636f 6e29 2073 696e 6365 2067  Silicon) since g
-00008000: 6f6f 6679 7320 646f 6573 206e 6f74 2077  oofys does not w
-00008010: 6f72 6b20 6f6e 2061 726d 3634 2e0a 2020  ork on arm64..  
-00008020: 2020 2020 2020 6578 7472 615f 666c 6167        extra_flag
-00008030: 7320 3d20 272d 2d6e 756d 2d6e 6f64 6573  s = '--num-nodes
-00008040: 2031 270a 2020 2020 7465 7374 5f63 6f6d   1'.    test_com
-00008050: 6d61 6e64 7320 3d20 5b0a 2020 2020 2020  mands = [.      
-00008060: 2020 2a73 746f 7261 6765 5f73 6574 7570    *storage_setup
-00008070: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
-00008080: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00008090: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-000080a0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-000080b0: 6f75 647d 207b 6578 7472 615f 666c 6167  oud} {extra_flag
-000080c0: 737d 2065 7861 6d70 6c65 732f 7573 696e  s} examples/usin
-000080d0: 675f 6669 6c65 5f6d 6f75 6e74 732e 7961  g_file_mounts.ya
-000080e0: 6d6c 272c 0a20 2020 2020 2020 2066 2773  ml',.        f's
-000080f0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00008100: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00008110: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-00008120: 6363 6565 6465 642e 0a20 2020 205d 0a20  cceeded..    ]. 
-00008130: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00008140: 2020 2020 2020 2020 2775 7369 6e67 5f66          'using_f
-00008150: 696c 655f 6d6f 756e 7473 272c 0a20 2020  ile_mounts',.   
-00008160: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
-00008170: 6473 2c0a 2020 2020 2020 2020 6627 736b  ds,.        f'sk
-00008180: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-00008190: 272c 0a20 2020 2020 2020 205f 6765 745f  ',.        _get_
-000081a0: 7469 6d65 6f75 7428 6765 6e65 7269 635f  timeout(generic_
-000081b0: 636c 6f75 642c 2032 3020 2a20 3630 292c  cloud, 20 * 60),
-000081c0: 2020 2320 3230 206d 696e 730a 2020 2020    # 20 mins.    
-000081d0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-000081e0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-000081f0: 7374 2e6d 6172 6b2e 7363 700a 6465 6620  st.mark.scp.def 
-00008200: 7465 7374 5f73 6370 5f66 696c 655f 6d6f  test_scp_file_mo
-00008210: 756e 7473 2829 3a0a 2020 2020 6e61 6d65  unts():.    name
-00008220: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00008230: 6e61 6d65 2829 0a20 2020 2074 6573 745f  name().    test_
-00008240: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
-00008250: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
-00008260: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
-00008270: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00008280: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00008290: 7b53 4350 5f54 5950 457d 202d 2d6e 756d  {SCP_TYPE} --num
-000082a0: 2d6e 6f64 6573 2031 2065 7861 6d70 6c65  -nodes 1 example
-000082b0: 732f 7573 696e 675f 6669 6c65 5f6d 6f75  s/using_file_mou
-000082c0: 6e74 732e 7961 6d6c 272c 0a20 2020 2020  nts.yaml',.     
-000082d0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000082e0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-000082f0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00008300: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00008310: 2020 205d 0a20 2020 2074 6573 7420 3d20     ].    test = 
-00008320: 5465 7374 280a 2020 2020 2020 2020 2753  Test(.        'S
-00008330: 4350 5f75 7369 6e67 5f66 696c 655f 6d6f  CP_using_file_mo
-00008340: 756e 7473 272c 0a20 2020 2020 2020 2074  unts',.        t
-00008350: 6573 745f 636f 6d6d 616e 6473 2c0a 2020  est_commands,.  
-00008360: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00008370: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00008380: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-00008390: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
-000083a0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-000083b0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000083c0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000083d0: 666c 7569 6473 7461 636b 2020 2320 5265  fluidstack  # Re
-000083e0: 7175 6972 6573 2047 4350 2074 6f20 6265  quires GCP to be
-000083f0: 2065 6e61 626c 6564 0a64 6566 2074 6573   enabled.def tes
-00008400: 745f 7573 696e 675f 6669 6c65 5f6d 6f75  t_using_file_mou
-00008410: 6e74 735f 7769 7468 5f65 6e76 5f76 6172  nts_with_env_var
-00008420: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
-00008430: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-00008440: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00008450: 616d 6528 290a 2020 2020 7374 6f72 6167  ame().    storag
-00008460: 655f 6e61 6d65 203d 2054 6573 7453 746f  e_name = TestSto
-00008470: 7261 6765 5769 7468 4372 6564 656e 7469  rageWithCredenti
-00008480: 616c 732e 6765 6e65 7261 7465 5f62 7563  als.generate_buc
-00008490: 6b65 745f 6e61 6d65 2829 0a20 2020 2074  ket_name().    t
-000084a0: 6573 745f 636f 6d6d 616e 6473 203d 205b  est_commands = [
-000084b0: 0a20 2020 2020 2020 202a 7374 6f72 6167  .        *storag
-000084c0: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
-000084d0: 2c0a 2020 2020 2020 2020 2866 2773 6b79  ,.        (f'sky
-000084e0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-000084f0: 616d 657d 202d 2d63 7075 7320 322b 202d  ame} --cpus 2+ -
-00008500: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00008510: 636c 6f75 647d 2027 0a20 2020 2020 2020  cloud} '.       
-00008520: 2020 2765 7861 6d70 6c65 732f 7573 696e    'examples/usin
-00008530: 675f 6669 6c65 5f6d 6f75 6e74 735f 7769  g_file_mounts_wi
-00008540: 7468 5f65 6e76 5f76 6172 732e 7961 6d6c  th_env_vars.yaml
-00008550: 2027 0a20 2020 2020 2020 2020 6627 2d2d   '.         f'--
-00008560: 656e 7620 4d59 5f42 5543 4b45 543d 7b73  env MY_BUCKET={s
-00008570: 746f 7261 6765 5f6e 616d 657d 2729 2c0a  torage_name}'),.
-00008580: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00008590: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-000085a0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-000085b0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-000085c0: 6564 2e0a 2020 2020 2020 2020 2320 4f76  ed..        # Ov
-000085d0: 6572 7269 6465 2077 6974 6820 2d2d 656e  erride with --en
-000085e0: 763a 0a20 2020 2020 2020 2028 6627 736b  v:.        (f'sk
-000085f0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00008600: 6e61 6d65 7d2d 3220 2d2d 6370 7573 2032  name}-2 --cpus 2
-00008610: 2b20 2d2d 636c 6f75 6420 7b67 656e 6572  + --cloud {gener
-00008620: 6963 5f63 6c6f 7564 7d20 270a 2020 2020  ic_cloud} '.    
-00008630: 2020 2020 2027 6578 616d 706c 6573 2f75       'examples/u
-00008640: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
-00008650: 5f77 6974 685f 656e 765f 7661 7273 2e79  _with_env_vars.y
-00008660: 616d 6c20 270a 2020 2020 2020 2020 2066  aml '.         f
-00008670: 272d 2d65 6e76 204d 595f 4255 434b 4554  '--env MY_BUCKET
-00008680: 3d7b 7374 6f72 6167 655f 6e61 6d65 7d20  ={storage_name} 
-00008690: 270a 2020 2020 2020 2020 2027 2d2d 656e  '.         '--en
-000086a0: 7620 4d59 5f4c 4f43 414c 5f50 4154 483d  v MY_LOCAL_PATH=
-000086b0: 746d 7066 696c 6527 292c 0a20 2020 2020  tmpfile'),.     
-000086c0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000086d0: 616d 657d 2d32 2031 202d 2d73 7461 7475  ame}-2 1 --statu
-000086e0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-000086f0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00008700: 0a20 2020 205d 0a20 2020 2074 6573 7420  .    ].    test 
-00008710: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00008720: 2775 7369 6e67 5f66 696c 655f 6d6f 756e  'using_file_moun
-00008730: 7473 5f77 6974 685f 656e 765f 7661 7273  ts_with_env_vars
-00008740: 272c 0a20 2020 2020 2020 2074 6573 745f  ',.        test_
-00008750: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
-00008760: 2020 2866 2773 6b79 2064 6f77 6e20 2d79    (f'sky down -y
-00008770: 207b 6e61 6d65 7d20 7b6e 616d 657d 2d32   {name} {name}-2
-00008780: 272c 0a20 2020 2020 2020 2020 6627 736b  ',.         f'sk
-00008790: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
-000087a0: 202d 7920 7b73 746f 7261 6765 5f6e 616d   -y {storage_nam
-000087b0: 657d 207b 7374 6f72 6167 655f 6e61 6d65  e} {storage_name
-000087c0: 7d2d 3227 292c 0a20 2020 2020 2020 2074  }-2'),.        t
-000087d0: 696d 656f 7574 3d32 3020 2a20 3630 2c20  imeout=20 * 60, 
-000087e0: 2023 2032 3020 6d69 6e73 0a20 2020 2029   # 20 mins.    )
-000087f0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00008800: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00008810: 2d2d 2d2d 2d2d 2073 746f 7261 6765 202d  ------ storage -
-00008820: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-00008830: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
-00008840: 6573 745f 6177 735f 7374 6f72 6167 655f  est_aws_storage_
-00008850: 6d6f 756e 7473 5f77 6974 685f 7374 6f70  mounts_with_stop
-00008860: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00008870: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00008880: 2829 0a20 2020 2073 746f 7261 6765 5f6e  ().    storage_n
-00008890: 616d 6520 3d20 6627 736b 792d 7465 7374  ame = f'sky-test
-000088a0: 2d7b 696e 7428 7469 6d65 2e74 696d 6528  -{int(time.time(
-000088b0: 2929 7d27 0a20 2020 2074 656d 706c 6174  ))}'.    templat
-000088c0: 655f 7374 7220 3d20 7061 7468 6c69 622e  e_str = pathlib.
-000088d0: 5061 7468 280a 2020 2020 2020 2020 2774  Path(.        't
-000088e0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-000088f0: 7465 7374 5f73 746f 7261 6765 5f6d 6f75  test_storage_mou
-00008900: 6e74 696e 672e 7961 6d6c 2e6a 3227 292e  nting.yaml.j2').
-00008910: 7265 6164 5f74 6578 7428 290a 2020 2020  read_text().    
-00008920: 7465 6d70 6c61 7465 203d 206a 696e 6a61  template = jinja
-00008930: 322e 5465 6d70 6c61 7465 2874 656d 706c  2.Template(templ
-00008940: 6174 655f 7374 7229 0a20 2020 2063 6f6e  ate_str).    con
-00008950: 7465 6e74 203d 2074 656d 706c 6174 652e  tent = template.
-00008960: 7265 6e64 6572 2873 746f 7261 6765 5f6e  render(storage_n
-00008970: 616d 653d 7374 6f72 6167 655f 6e61 6d65  ame=storage_name
-00008980: 290a 2020 2020 7769 7468 2074 656d 7066  ).    with tempf
-00008990: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
-000089a0: 7279 4669 6c65 2873 7566 6669 783d 272e  ryFile(suffix='.
-000089b0: 7961 6d6c 272c 206d 6f64 653d 2777 2729  yaml', mode='w')
-000089c0: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
-000089d0: 2e77 7269 7465 2863 6f6e 7465 6e74 290a  .write(content).
-000089e0: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
-000089f0: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
-00008a00: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
-00008a10: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
-00008a20: 6473 203d 205b 0a20 2020 2020 2020 2020  ds = [.         
-00008a30: 2020 202a 7374 6f72 6167 655f 7365 7475     *storage_setu
-00008a40: 705f 636f 6d6d 616e 6473 2c0a 2020 2020  p_commands,.    
-00008a50: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00008a60: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00008a70: 7d20 2d2d 636c 6f75 6420 6177 7320 7b66  } --cloud aws {f
-00008a80: 696c 655f 7061 7468 7d27 2c0a 2020 2020  ile_path}',.    
-00008a90: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00008aa0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-00008ab0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-00008ac0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-00008ad0: 2020 2020 2020 2020 2020 2020 6627 6177              f'aw
-00008ae0: 7320 7333 206c 7320 7b73 746f 7261 6765  s s3 ls {storage
-00008af0: 5f6e 616d 657d 2f68 656c 6c6f 2e74 7874  _name}/hello.txt
-00008b00: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00008b10: 2773 6b79 2073 746f 7020 2d79 207b 6e61  'sky stop -y {na
-00008b20: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
-00008b30: 2020 6627 736b 7920 7374 6172 7420 2d79    f'sky start -y
-00008b40: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-00008b50: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
-00008b60: 2068 656c 6c6f 2e74 7874 2066 726f 6d20   hello.txt from 
-00008b70: 6d6f 756e 7469 6e67 2062 7563 6b65 7420  mounting bucket 
-00008b80: 6578 6973 7473 2061 6674 6572 2072 6573  exists after res
-00008b90: 7461 7274 2069 6e0a 2020 2020 2020 2020  tart in.        
-00008ba0: 2020 2020 2320 7468 6520 6d6f 756e 7465      # the mounte
-00008bb0: 6420 6469 7265 6374 6f72 790a 2020 2020  d directory.    
-00008bc0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00008bd0: 6563 207b 6e61 6d65 7d20 2d2d 2022 7365  ec {name} -- "se
-00008be0: 7420 2d65 783b 206c 7320 2f6d 6f75 6e74  t -ex; ls /mount
-00008bf0: 5f70 7269 7661 7465 5f6d 6f75 6e74 2f68  _private_mount/h
-00008c00: 656c 6c6f 2e74 7874 2227 0a20 2020 2020  ello.txt"'.     
-00008c10: 2020 205d 0a20 2020 2020 2020 2074 6573     ].        tes
-00008c20: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00008c30: 2020 2020 2020 2761 7773 5f73 746f 7261        'aws_stora
-00008c40: 6765 5f6d 6f75 6e74 7327 2c0a 2020 2020  ge_mounts',.    
-00008c50: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
-00008c60: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
-00008c70: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00008c80: 207b 6e61 6d65 7d3b 2073 6b79 2073 746f   {name}; sky sto
-00008c90: 7261 6765 2064 656c 6574 6520 2d79 207b  rage delete -y {
-00008ca0: 7374 6f72 6167 655f 6e61 6d65 7d27 2c0a  storage_name}',.
-00008cb0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-00008cc0: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-00008cd0: 3230 206d 696e 730a 2020 2020 2020 2020  20 mins.        
-00008ce0: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-00008cf0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00008d00: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-00008d10: 6465 6620 7465 7374 5f67 6370 5f73 746f  def test_gcp_sto
-00008d20: 7261 6765 5f6d 6f75 6e74 735f 7769 7468  rage_mounts_with
-00008d30: 5f73 746f 7028 293a 0a20 2020 206e 616d  _stop():.    nam
-00008d40: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00008d50: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
-00008d60: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
-00008d70: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
-00008d80: 7469 6d65 2829 297d 270a 2020 2020 7465  time())}'.    te
-00008d90: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
-00008da0: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
-00008db0: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
-00008dc0: 616d 6c73 2f74 6573 745f 7374 6f72 6167  amls/test_storag
-00008dd0: 655f 6d6f 756e 7469 6e67 2e79 616d 6c2e  e_mounting.yaml.
-00008de0: 6a32 2729 2e72 6561 645f 7465 7874 2829  j2').read_text()
-00008df0: 0a20 2020 2074 656d 706c 6174 6520 3d20  .    template = 
-00008e00: 6a69 6e6a 6132 2e54 656d 706c 6174 6528  jinja2.Template(
-00008e10: 7465 6d70 6c61 7465 5f73 7472 290a 2020  template_str).  
-00008e20: 2020 636f 6e74 656e 7420 3d20 7465 6d70    content = temp
-00008e30: 6c61 7465 2e72 656e 6465 7228 7374 6f72  late.render(stor
-00008e40: 6167 655f 6e61 6d65 3d73 746f 7261 6765  age_name=storage
-00008e50: 5f6e 616d 6529 0a20 2020 2077 6974 6820  _name).    with 
-00008e60: 7465 6d70 6669 6c65 2e4e 616d 6564 5465  tempfile.NamedTe
-00008e70: 6d70 6f72 6172 7946 696c 6528 7375 6666  mporaryFile(suff
-00008e80: 6978 3d27 2e79 616d 6c27 2c20 6d6f 6465  ix='.yaml', mode
-00008e90: 3d27 7727 2920 6173 2066 3a0a 2020 2020  ='w') as f:.    
-00008ea0: 2020 2020 662e 7772 6974 6528 636f 6e74      f.write(cont
-00008eb0: 656e 7429 0a20 2020 2020 2020 2066 2e66  ent).        f.f
-00008ec0: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
-00008ed0: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
-00008ee0: 650a 2020 2020 2020 2020 7465 7374 5f63  e.        test_c
-00008ef0: 6f6d 6d61 6e64 7320 3d20 5b0a 2020 2020  ommands = [.    
-00008f00: 2020 2020 2020 2020 2a73 746f 7261 6765          *storage
-00008f10: 5f73 6574 7570 5f63 6f6d 6d61 6e64 732c  _setup_commands,
-00008f20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008f30: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00008f40: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
-00008f50: 6370 207b 6669 6c65 5f70 6174 687d 272c  cp {file_path}',
-00008f60: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008f70: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00008f80: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00008f90: 6e73 7572 6520 6a6f 6220 7375 6363 6565  nsure job succee
-00008fa0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00008fb0: 2066 2767 7375 7469 6c20 6c73 2067 733a   f'gsutil ls gs:
-00008fc0: 2f2f 7b73 746f 7261 6765 5f6e 616d 657d  //{storage_name}
-00008fd0: 2f68 656c 6c6f 2e74 7874 272c 0a20 2020  /hello.txt',.   
-00008fe0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00008ff0: 746f 7020 2d79 207b 6e61 6d65 7d27 2c0a  top -y {name}',.
-00009000: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009010: 7920 7374 6172 7420 2d79 207b 6e61 6d65  y start -y {name
-00009020: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00009030: 2320 4368 6563 6b20 6966 2068 656c 6c6f  # Check if hello
-00009040: 2e74 7874 2066 726f 6d20 6d6f 756e 7469  .txt from mounti
-00009050: 6e67 2062 7563 6b65 7420 6578 6973 7473  ng bucket exists
-00009060: 2061 6674 6572 2072 6573 7461 7274 2069   after restart i
-00009070: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
-00009080: 7468 6520 6d6f 756e 7465 6420 6469 7265  the mounted dire
-00009090: 6374 6f72 790a 2020 2020 2020 2020 2020  ctory.          
-000090a0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-000090b0: 6d65 7d20 2d2d 2022 7365 7420 2d65 783b  me} -- "set -ex;
-000090c0: 206c 7320 2f6d 6f75 6e74 5f70 7269 7661   ls /mount_priva
-000090d0: 7465 5f6d 6f75 6e74 2f68 656c 6c6f 2e74  te_mount/hello.t
-000090e0: 7874 2227 0a20 2020 2020 2020 205d 0a20  xt"'.        ]. 
-000090f0: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
-00009100: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00009110: 2767 6370 5f73 746f 7261 6765 5f6d 6f75  'gcp_storage_mou
-00009120: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
-00009130: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
-00009140: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00009150: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00009160: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
-00009170: 656c 6574 6520 2d79 207b 7374 6f72 6167  elete -y {storag
-00009180: 655f 6e61 6d65 7d27 2c0a 2020 2020 2020  e_name}',.      
-00009190: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-000091a0: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
-000091b0: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
-000091c0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-000091d0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-000091e0: 2e6d 6172 6b2e 6b75 6265 726e 6574 6573  .mark.kubernetes
-000091f0: 0a64 6566 2074 6573 745f 6b75 6265 726e  .def test_kubern
-00009200: 6574 6573 5f73 746f 7261 6765 5f6d 6f75  etes_storage_mou
-00009210: 6e74 7328 293a 0a20 2020 2023 2054 6573  nts():.    # Tes
-00009220: 7473 2062 7563 6b65 7420 6d6f 756e 7469  ts bucket mounti
-00009230: 6e67 206f 6e20 6b38 732c 2061 7373 756d  ng on k8s, assum
-00009240: 696e 6720 5333 2069 7320 636f 6e66 6967  ing S3 is config
-00009250: 7572 6564 2e0a 2020 2020 2320 5468 6973  ured..    # This
-00009260: 2074 6573 7420 7769 6c6c 2066 6169 6c20   test will fail 
-00009270: 6966 2072 756e 206f 6e20 6e6f 6e20 7838  if run on non x8
-00009280: 365f 3634 2061 7263 6869 7465 6374 7572  6_64 architectur
-00009290: 652c 2073 696e 6365 2067 6f6f 6679 7320  e, since goofys 
-000092a0: 6973 0a20 2020 2023 2062 7569 6c74 2066  is.    # built f
-000092b0: 6f72 2078 3836 5f36 3420 6f6e 6c79 2e0a  or x86_64 only..
-000092c0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-000092d0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-000092e0: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
-000092f0: 3d20 6627 736b 792d 7465 7374 2d7b 696e  = f'sky-test-{in
-00009300: 7428 7469 6d65 2e74 696d 6528 2929 7d27  t(time.time())}'
-00009310: 0a20 2020 2074 656d 706c 6174 655f 7374  .    template_st
-00009320: 7220 3d20 7061 7468 6c69 622e 5061 7468  r = pathlib.Path
-00009330: 280a 2020 2020 2020 2020 2774 6573 7473  (.        'tests
-00009340: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
-00009350: 5f73 746f 7261 6765 5f6d 6f75 6e74 696e  _storage_mountin
-00009360: 672e 7961 6d6c 2e6a 3227 292e 7265 6164  g.yaml.j2').read
-00009370: 5f74 6578 7428 290a 2020 2020 7465 6d70  _text().    temp
-00009380: 6c61 7465 203d 206a 696e 6a61 322e 5465  late = jinja2.Te
-00009390: 6d70 6c61 7465 2874 656d 706c 6174 655f  mplate(template_
-000093a0: 7374 7229 0a20 2020 2063 6f6e 7465 6e74  str).    content
-000093b0: 203d 2074 656d 706c 6174 652e 7265 6e64   = template.rend
-000093c0: 6572 2873 746f 7261 6765 5f6e 616d 653d  er(storage_name=
-000093d0: 7374 6f72 6167 655f 6e61 6d65 290a 2020  storage_name).  
-000093e0: 2020 7769 7468 2074 656d 7066 696c 652e    with tempfile.
-000093f0: 4e61 6d65 6454 656d 706f 7261 7279 4669  NamedTemporaryFi
-00009400: 6c65 2873 7566 6669 783d 272e 7961 6d6c  le(suffix='.yaml
-00009410: 272c 206d 6f64 653d 2777 2729 2061 7320  ', mode='w') as 
-00009420: 663a 0a20 2020 2020 2020 2066 2e77 7269  f:.        f.wri
-00009430: 7465 2863 6f6e 7465 6e74 290a 2020 2020  te(content).    
-00009440: 2020 2020 662e 666c 7573 6828 290a 2020      f.flush().  
-00009450: 2020 2020 2020 6669 6c65 5f70 6174 6820        file_path 
-00009460: 3d20 662e 6e61 6d65 0a20 2020 2020 2020  = f.name.       
-00009470: 2074 6573 745f 636f 6d6d 616e 6473 203d   test_commands =
-00009480: 205b 0a20 2020 2020 2020 2020 2020 202a   [.            *
-00009490: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
-000094a0: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
-000094b0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-000094c0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-000094d0: 636c 6f75 6420 6b75 6265 726e 6574 6573  cloud kubernetes
-000094e0: 207b 6669 6c65 5f70 6174 687d 272c 0a20   {file_path}',. 
-000094f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00009500: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00009510: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-00009520: 7572 6520 6a6f 6220 7375 6363 6565 6465  ure job succeede
-00009530: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00009540: 2761 7773 2073 3320 6c73 207b 7374 6f72  'aws s3 ls {stor
-00009550: 6167 655f 6e61 6d65 7d2f 6865 6c6c 6f2e  age_name}/hello.
-00009560: 7478 7420 7c7c 2027 0a20 2020 2020 2020  txt || '.       
-00009570: 2020 2020 2066 2767 7375 7469 6c20 6c73       f'gsutil ls
-00009580: 2067 733a 2f2f 7b73 746f 7261 6765 5f6e   gs://{storage_n
-00009590: 616d 657d 2f68 656c 6c6f 2e74 7874 272c  ame}/hello.txt',
-000095a0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-000095b0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-000095c0: 2020 2020 2020 2020 2020 2020 276b 7562              'kub
-000095d0: 6572 6e65 7465 735f 7374 6f72 6167 655f  ernetes_storage_
-000095e0: 6d6f 756e 7473 272c 0a20 2020 2020 2020  mounts',.       
-000095f0: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
-00009600: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
-00009610: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00009620: 616d 657d 3b20 736b 7920 7374 6f72 6167  ame}; sky storag
-00009630: 6520 6465 6c65 7465 202d 7920 7b73 746f  e delete -y {sto
-00009640: 7261 6765 5f6e 616d 657d 272c 0a20 2020  rage_name}',.   
-00009650: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
-00009660: 3d32 3020 2a20 3630 2c20 2023 2032 3020  =20 * 60,  # 20 
-00009670: 6d69 6e73 0a20 2020 2020 2020 2029 0a20  mins.        ). 
-00009680: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
-00009690: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-000096a0: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-000096b0: 7269 7a65 280a 2020 2020 2269 6d61 6765  rize(.    "image
-000096c0: 5f69 6422 2c0a 2020 2020 5b0a 2020 2020  _id",.    [.    
-000096d0: 2020 2020 2264 6f63 6b65 723a 6e76 6964      "docker:nvid
-000096e0: 6961 2f63 7564 613a 3131 2e38 2e30 2d64  ia/cuda:11.8.0-d
-000096f0: 6576 656c 2d75 6275 6e74 7531 382e 3034  evel-ubuntu18.04
-00009700: 222c 0a20 2020 2020 2020 2022 646f 636b  ",.        "dock
-00009710: 6572 3a75 6275 6e74 753a 3138 2e30 3422  er:ubuntu:18.04"
-00009720: 2c0a 2020 2020 2020 2020 2320 5465 7374  ,.        # Test
-00009730: 2069 6d61 6765 2077 6974 6820 7079 7468   image with pyth
-00009740: 6f6e 2033 2e31 3120 696e 7374 616c 6c65  on 3.11 installe
-00009750: 6420 6279 2064 6566 6175 6c74 2e0a 2020  d by default..  
-00009760: 2020 2020 2020 2264 6f63 6b65 723a 636f        "docker:co
-00009770: 6e74 696e 7575 6d69 6f2f 6d69 6e69 636f  ntinuumio/minico
-00009780: 6e64 6133 222c 0a20 2020 205d 290a 6465  nda3",.    ]).de
-00009790: 6620 7465 7374 5f64 6f63 6b65 725f 7374  f test_docker_st
-000097a0: 6f72 6167 655f 6d6f 756e 7473 2867 656e  orage_mounts(gen
-000097b0: 6572 6963 5f63 6c6f 7564 3a20 7374 722c  eric_cloud: str,
-000097c0: 2069 6d61 6765 5f69 643a 2073 7472 293a   image_id: str):
-000097d0: 0a20 2020 2023 2054 6573 7473 2062 7563  .    # Tests buc
-000097e0: 6b65 7420 6d6f 756e 7469 6e67 206f 6e20  ket mounting on 
-000097f0: 646f 636b 6572 2063 6f6e 7461 696e 6572  docker container
-00009800: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00009810: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00009820: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
-00009830: 7374 7228 7469 6d65 2e74 696d 6528 2929  str(time.time())
-00009840: 2e72 6570 6c61 6365 2827 2e27 2c20 2727  .replace('.', ''
-00009850: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
-00009860: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
-00009870: 7b74 696d 6573 7461 6d70 7d27 0a20 2020  {timestamp}'.   
-00009880: 2074 656d 706c 6174 655f 7374 7220 3d20   template_str = 
-00009890: 7061 7468 6c69 622e 5061 7468 280a 2020  pathlib.Path(.  
-000098a0: 2020 2020 2020 2774 6573 7473 2f74 6573        'tests/tes
-000098b0: 745f 7961 6d6c 732f 7465 7374 5f73 746f  t_yamls/test_sto
-000098c0: 7261 6765 5f6d 6f75 6e74 696e 672e 7961  rage_mounting.ya
-000098d0: 6d6c 2e6a 3227 292e 7265 6164 5f74 6578  ml.j2').read_tex
-000098e0: 7428 290a 2020 2020 7465 6d70 6c61 7465  t().    template
-000098f0: 203d 206a 696e 6a61 322e 5465 6d70 6c61   = jinja2.Templa
-00009900: 7465 2874 656d 706c 6174 655f 7374 7229  te(template_str)
-00009910: 0a20 2020 2063 6f6e 7465 6e74 203d 2074  .    content = t
-00009920: 656d 706c 6174 652e 7265 6e64 6572 2873  emplate.render(s
-00009930: 746f 7261 6765 5f6e 616d 653d 7374 6f72  torage_name=stor
-00009940: 6167 655f 6e61 6d65 290a 2020 2020 7769  age_name).    wi
-00009950: 7468 2074 656d 7066 696c 652e 4e61 6d65  th tempfile.Name
-00009960: 6454 656d 706f 7261 7279 4669 6c65 2873  dTemporaryFile(s
-00009970: 7566 6669 783d 272e 7961 6d6c 272c 206d  uffix='.yaml', m
-00009980: 6f64 653d 2777 2729 2061 7320 663a 0a20  ode='w') as f:. 
-00009990: 2020 2020 2020 2066 2e77 7269 7465 2863         f.write(c
-000099a0: 6f6e 7465 6e74 290a 2020 2020 2020 2020  ontent).        
-000099b0: 662e 666c 7573 6828 290a 2020 2020 2020  f.flush().      
-000099c0: 2020 6669 6c65 5f70 6174 6820 3d20 662e    file_path = f.
-000099d0: 6e61 6d65 0a20 2020 2020 2020 2074 6573  name.        tes
-000099e0: 745f 636f 6d6d 616e 6473 203d 205b 0a20  t_commands = [. 
-000099f0: 2020 2020 2020 2020 2020 202a 7374 6f72             *stor
-00009a00: 6167 655f 7365 7475 705f 636f 6d6d 616e  age_setup_comman
-00009a10: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
-00009a20: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00009a30: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-00009a40: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00009a50: 7d20 2d2d 696d 6167 652d 6964 207b 696d  } --image-id {im
-00009a60: 6167 655f 6964 7d20 7b66 696c 655f 7061  age_id} {file_pa
-00009a70: 7468 7d27 2c0a 2020 2020 2020 2020 2020  th}',.          
-00009a80: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00009a90: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00009aa0: 2020 2320 456e 7375 7265 206a 6f62 2073    # Ensure job s
-00009ab0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00009ac0: 2020 2020 2020 6627 6177 7320 7333 206c        f'aws s3 l
-00009ad0: 7320 7b73 746f 7261 6765 5f6e 616d 657d  s {storage_name}
-00009ae0: 2f68 656c 6c6f 2e74 7874 207c 7c20 270a  /hello.txt || '.
-00009af0: 2020 2020 2020 2020 2020 2020 6627 6773              f'gs
-00009b00: 7574 696c 206c 7320 6773 3a2f 2f7b 7374  util ls gs://{st
-00009b10: 6f72 6167 655f 6e61 6d65 7d2f 6865 6c6c  orage_name}/hell
-00009b20: 6f2e 7478 7427 2c0a 2020 2020 2020 2020  o.txt',.        
-00009b30: 5d0a 2020 2020 2020 2020 7465 7374 203d  ].        test =
-00009b40: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
-00009b50: 2020 2027 646f 636b 6572 5f73 746f 7261     'docker_stora
-00009b60: 6765 5f6d 6f75 6e74 7327 2c0a 2020 2020  ge_mounts',.    
-00009b70: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
-00009b80: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
-00009b90: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00009ba0: 207b 6e61 6d65 7d3b 2073 6b79 2073 746f   {name}; sky sto
-00009bb0: 7261 6765 2064 656c 6574 6520 2d79 207b  rage delete -y {
-00009bc0: 7374 6f72 6167 655f 6e61 6d65 7d27 2c0a  storage_name}',.
-00009bd0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-00009be0: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-00009bf0: 3230 206d 696e 730a 2020 2020 2020 2020  20 mins.        
-00009c00: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-00009c10: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00009c20: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
-00009c30: 6466 6c61 7265 0a64 6566 2074 6573 745f  dflare.def test_
-00009c40: 636c 6f75 6466 6c61 7265 5f73 746f 7261  cloudflare_stora
-00009c50: 6765 5f6d 6f75 6e74 7328 6765 6e65 7269  ge_mounts(generi
-00009c60: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00009c70: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00009c80: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00009c90: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
-00009ca0: 2066 2773 6b79 2d74 6573 742d 7b69 6e74   f'sky-test-{int
-00009cb0: 2874 696d 652e 7469 6d65 2829 297d 270a  (time.time())}'.
-00009cc0: 2020 2020 7465 6d70 6c61 7465 5f73 7472      template_str
-00009cd0: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
-00009ce0: 0a20 2020 2020 2020 2027 7465 7374 732f  .        'tests/
-00009cf0: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
-00009d00: 7232 5f73 746f 7261 6765 5f6d 6f75 6e74  r2_storage_mount
-00009d10: 696e 672e 7961 6d6c 2729 2e72 6561 645f  ing.yaml').read_
-00009d20: 7465 7874 2829 0a20 2020 2074 656d 706c  text().    templ
-00009d30: 6174 6520 3d20 6a69 6e6a 6132 2e54 656d  ate = jinja2.Tem
-00009d40: 706c 6174 6528 7465 6d70 6c61 7465 5f73  plate(template_s
-00009d50: 7472 290a 2020 2020 636f 6e74 656e 7420  tr).    content 
-00009d60: 3d20 7465 6d70 6c61 7465 2e72 656e 6465  = template.rende
-00009d70: 7228 7374 6f72 6167 655f 6e61 6d65 3d73  r(storage_name=s
-00009d80: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
-00009d90: 2065 6e64 706f 696e 745f 7572 6c20 3d20   endpoint_url = 
-00009da0: 636c 6f75 6466 6c61 7265 2e63 7265 6174  cloudflare.creat
-00009db0: 655f 656e 6470 6f69 6e74 2829 0a20 2020  e_endpoint().   
-00009dc0: 2077 6974 6820 7465 6d70 6669 6c65 2e4e   with tempfile.N
-00009dd0: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
-00009de0: 6528 7375 6666 6978 3d27 2e79 616d 6c27  e(suffix='.yaml'
-00009df0: 2c20 6d6f 6465 3d27 7727 2920 6173 2066  , mode='w') as f
-00009e00: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
-00009e10: 6528 636f 6e74 656e 7429 0a20 2020 2020  e(content).     
-00009e20: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
-00009e30: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
-00009e40: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
-00009e50: 7465 7374 5f63 6f6d 6d61 6e64 7320 3d20  test_commands = 
-00009e60: 5b0a 2020 2020 2020 2020 2020 2020 2a73  [.            *s
-00009e70: 746f 7261 6765 5f73 6574 7570 5f63 6f6d  torage_setup_com
-00009e80: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
-00009e90: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00009ea0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-00009eb0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00009ec0: 6f75 647d 207b 6669 6c65 5f70 6174 687d  oud} {file_path}
-00009ed0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00009ee0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00009ef0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00009f00: 2045 6e73 7572 6520 6a6f 6220 7375 6363   Ensure job succ
-00009f10: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-00009f20: 2020 2066 2741 5753 5f53 4841 5245 445f     f'AWS_SHARED_
-00009f30: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
-00009f40: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
-00009f50: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
-00009f60: 7d20 6177 7320 7333 206c 7320 7333 3a2f  } aws s3 ls s3:/
-00009f70: 2f7b 7374 6f72 6167 655f 6e61 6d65 7d2f  /{storage_name}/
-00009f80: 6865 6c6c 6f2e 7478 7420 2d2d 656e 6470  hello.txt --endp
-00009f90: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-00009fa0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-00009fb0: 270a 2020 2020 2020 2020 5d0a 0a20 2020  '.        ]..   
-00009fc0: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
-00009fd0: 280a 2020 2020 2020 2020 2020 2020 2763  (.            'c
-00009fe0: 6c6f 7564 666c 6172 655f 7374 6f72 6167  loudflare_storag
-00009ff0: 655f 6d6f 756e 7473 272c 0a20 2020 2020  e_mounts',.     
-0000a000: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
-0000a010: 616e 6473 2c0a 2020 2020 2020 2020 2020  ands,.          
-0000a020: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0000a030: 7b6e 616d 657d 3b20 736b 7920 7374 6f72  {name}; sky stor
-0000a040: 6167 6520 6465 6c65 7465 202d 7920 7b73  age delete -y {s
-0000a050: 746f 7261 6765 5f6e 616d 657d 272c 0a20  torage_name}',. 
-0000a060: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-0000a070: 7574 3d32 3020 2a20 3630 2c20 2023 2032  ut=20 * 60,  # 2
-0000a080: 3020 6d69 6e73 0a20 2020 2020 2020 2029  0 mins.        )
-0000a090: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
-0000a0a0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-0000a0b0: 7974 6573 742e 6d61 726b 2e69 626d 0a64  ytest.mark.ibm.d
-0000a0c0: 6566 2074 6573 745f 6962 6d5f 7374 6f72  ef test_ibm_stor
-0000a0d0: 6167 655f 6d6f 756e 7473 2829 3a0a 2020  age_mounts():.  
-0000a0e0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0000a0f0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0000a100: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
-0000a110: 6627 736b 792d 7465 7374 2d7b 696e 7428  f'sky-test-{int(
-0000a120: 7469 6d65 2e74 696d 6528 2929 7d27 0a20  time.time())}'. 
-0000a130: 2020 2062 7563 6b65 745f 7263 6c6f 6e65     bucket_rclone
-0000a140: 5f70 726f 6669 6c65 203d 2052 636c 6f6e  _profile = Rclon
-0000a150: 652e 6765 6e65 7261 7465 5f72 636c 6f6e  e.generate_rclon
-0000a160: 655f 6275 636b 6574 5f70 726f 6669 6c65  e_bucket_profile
-0000a170: 5f6e 616d 6528 0a20 2020 2020 2020 2073  _name(.        s
-0000a180: 746f 7261 6765 5f6e 616d 652c 2052 636c  torage_name, Rcl
-0000a190: 6f6e 652e 5263 6c6f 6e65 436c 6f75 6473  one.RcloneClouds
-0000a1a0: 2e49 424d 290a 2020 2020 7465 6d70 6c61  .IBM).    templa
-0000a1b0: 7465 5f73 7472 203d 2070 6174 686c 6962  te_str = pathlib
-0000a1c0: 2e50 6174 6828 0a20 2020 2020 2020 2027  .Path(.        '
-0000a1d0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-0000a1e0: 2f74 6573 745f 6962 6d5f 636f 735f 7374  /test_ibm_cos_st
-0000a1f0: 6f72 6167 655f 6d6f 756e 7469 6e67 2e79  orage_mounting.y
-0000a200: 616d 6c27 292e 7265 6164 5f74 6578 7428  aml').read_text(
-0000a210: 290a 2020 2020 7465 6d70 6c61 7465 203d  ).    template =
-0000a220: 206a 696e 6a61 322e 5465 6d70 6c61 7465   jinja2.Template
-0000a230: 2874 656d 706c 6174 655f 7374 7229 0a20  (template_str). 
-0000a240: 2020 2063 6f6e 7465 6e74 203d 2074 656d     content = tem
-0000a250: 706c 6174 652e 7265 6e64 6572 2873 746f  plate.render(sto
-0000a260: 7261 6765 5f6e 616d 653d 7374 6f72 6167  rage_name=storag
-0000a270: 655f 6e61 6d65 290a 2020 2020 7769 7468  e_name).    with
-0000a280: 2074 656d 7066 696c 652e 4e61 6d65 6454   tempfile.NamedT
-0000a290: 656d 706f 7261 7279 4669 6c65 2873 7566  emporaryFile(suf
-0000a2a0: 6669 783d 272e 7961 6d6c 272c 206d 6f64  fix='.yaml', mod
-0000a2b0: 653d 2777 2729 2061 7320 663a 0a20 2020  e='w') as f:.   
-0000a2c0: 2020 2020 2066 2e77 7269 7465 2863 6f6e       f.write(con
-0000a2d0: 7465 6e74 290a 2020 2020 2020 2020 662e  tent).        f.
-0000a2e0: 666c 7573 6828 290a 2020 2020 2020 2020  flush().        
-0000a2f0: 6669 6c65 5f70 6174 6820 3d20 662e 6e61  file_path = f.na
-0000a300: 6d65 0a20 2020 2020 2020 2074 6573 745f  me.        test_
-0000a310: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
-0000a320: 2020 2020 2020 2020 202a 7374 6f72 6167           *storag
-0000a330: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
-0000a340: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000a350: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-0000a360: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-0000a370: 6962 6d20 7b66 696c 655f 7061 7468 7d27  ibm {file_path}'
-0000a380: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000a390: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000a3a0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-0000a3b0: 456e 7375 7265 206a 6f62 2073 7563 6365  Ensure job succe
-0000a3c0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-0000a3d0: 2020 6627 7263 6c6f 6e65 206c 7320 7b62    f'rclone ls {b
-0000a3e0: 7563 6b65 745f 7263 6c6f 6e65 5f70 726f  ucket_rclone_pro
-0000a3f0: 6669 6c65 7d3a 7b73 746f 7261 6765 5f6e  file}:{storage_n
-0000a400: 616d 657d 2f68 656c 6c6f 2e74 7874 272c  ame}/hello.txt',
-0000a410: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-0000a420: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000a430: 2020 2020 2020 2020 2020 2020 2769 626d              'ibm
-0000a440: 5f73 746f 7261 6765 5f6d 6f75 6e74 7327  _storage_mounts'
-0000a450: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
-0000a460: 7374 5f63 6f6d 6d61 6e64 732c 0a20 2020  st_commands,.   
-0000a470: 2020 2020 2020 2020 2066 2773 6b79 2064           f'sky d
-0000a480: 6f77 6e20 2d79 207b 6e61 6d65 7d3b 2073  own -y {name}; s
-0000a490: 6b79 2073 746f 7261 6765 2064 656c 6574  ky storage delet
-0000a4a0: 6520 2d79 207b 7374 6f72 6167 655f 6e61  e -y {storage_na
-0000a4b0: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
-0000a4c0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0000a4d0: 302c 2020 2320 3230 206d 696e 730a 2020  0,  # 20 mins.  
-0000a4e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000a4f0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000a500: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0000a510: 2d20 434c 4920 6c6f 6773 202d 2d2d 2d2d  - CLI logs -----
-0000a520: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0000a530: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-0000a540: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0000a550: 7420 6e75 6d5f 6e6f 6465 7320 3e20 3120  t num_nodes > 1 
-0000a560: 7965 742e 2052 756e 2074 6573 745f 7363  yet. Run test_sc
-0000a570: 705f 6c6f 6773 2069 6e73 7465 6164 2e0a  p_logs instead..
-0000a580: 6465 6620 7465 7374 5f63 6c69 5f6c 6f67  def test_cli_log
-0000a590: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
-0000a5a0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000a5b0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000a5c0: 616d 6528 290a 2020 2020 6e75 6d5f 6e6f  ame().    num_no
-0000a5d0: 6465 7320 3d20 320a 2020 2020 6966 2067  des = 2.    if g
-0000a5e0: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
-0000a5f0: 276b 7562 6572 6e65 7465 7327 3a0a 2020  'kubernetes':.  
-0000a600: 2020 2020 2020 2320 4b75 6265 726e 6574        # Kubernet
-0000a610: 6573 2064 6f65 7320 6e6f 7420 7375 7070  es does not supp
-0000a620: 6f72 7420 6d75 6c74 692d 6e6f 6465 0a20  ort multi-node. 
-0000a630: 2020 2020 2020 206e 756d 5f6e 6f64 6573         num_nodes
-0000a640: 203d 2031 0a20 2020 2074 696d 6573 7461   = 1.    timesta
-0000a650: 6d70 203d 2074 696d 652e 7469 6d65 2829  mp = time.time()
-0000a660: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0000a670: 2827 636c 695f 6c6f 6773 272c 205b 0a20  ('cli_logs', [. 
-0000a680: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000a690: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000a6a0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-0000a6b0: 635f 636c 6f75 647d 202d 2d6e 756d 2d6e  c_cloud} --num-n
-0000a6c0: 6f64 6573 207b 6e75 6d5f 6e6f 6465 737d  odes {num_nodes}
-0000a6d0: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
-0000a6e0: 707d 2031 2227 2c0a 2020 2020 2020 2020  p} 1"',.        
-0000a6f0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000a700: 7d20 2265 6368 6f20 7b74 696d 6573 7461  } "echo {timesta
-0000a710: 6d70 7d20 3222 272c 0a20 2020 2020 2020  mp} 2"',.       
-0000a720: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000a730: 657d 2022 6563 686f 207b 7469 6d65 7374  e} "echo {timest
-0000a740: 616d 707d 2033 2227 2c0a 2020 2020 2020  amp} 3"',.      
-0000a750: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000a760: 6d65 7d20 2265 6368 6f20 7b74 696d 6573  me} "echo {times
-0000a770: 7461 6d70 7d20 3422 272c 0a20 2020 2020  tamp} 4"',.     
-0000a780: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000a790: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-0000a7a0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000a7b0: 6c6f 6773 207b 6e61 6d65 7d20 3320 3420  logs {name} 3 4 
-0000a7c0: 2d2d 7379 6e63 2d64 6f77 6e27 2c0a 2020  --sync-down',.  
-0000a7d0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000a7e0: 207b 6e61 6d65 7d20 2a20 2d2d 7379 6e63   {name} * --sync
-0000a7f0: 2d64 6f77 6e27 2c0a 2020 2020 2020 2020  -down',.        
-0000a800: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000a810: 7d20 3120 7c20 6772 6570 2022 7b74 696d  } 1 | grep "{tim
-0000a820: 6573 7461 6d70 7d20 3122 272c 0a20 2020  estamp} 1"',.   
-0000a830: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000a840: 7b6e 616d 657d 207c 2067 7265 7020 227b  {name} | grep "{
-0000a850: 7469 6d65 7374 616d 707d 2034 2227 2c0a  timestamp} 4"',.
-0000a860: 2020 2020 5d2c 2066 2773 6b79 2064 6f77      ], f'sky dow
-0000a870: 6e20 2d79 207b 6e61 6d65 7d27 290a 2020  n -y {name}').  
-0000a880: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000a890: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-0000a8a0: 6172 6b2e 7363 700a 6465 6620 7465 7374  ark.scp.def test
-0000a8b0: 5f73 6370 5f6c 6f67 7328 293a 0a20 2020  _scp_logs():.   
-0000a8c0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0000a8d0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0000a8e0: 7469 6d65 7374 616d 7020 3d20 7469 6d65  timestamp = time
-0000a8f0: 2e74 696d 6528 290a 2020 2020 7465 7374  .time().    test
-0000a900: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0000a910: 2027 5343 505f 636c 695f 6c6f 6773 272c   'SCP_cli_logs',
-0000a920: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0000a930: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000a940: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000a950: 207b 5343 505f 5459 5045 7d20 2265 6368   {SCP_TYPE} "ech
-0000a960: 6f20 7b74 696d 6573 7461 6d70 7d20 3122  o {timestamp} 1"
-0000a970: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000a980: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000a990: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
-0000a9a0: 707d 2032 2227 2c0a 2020 2020 2020 2020  p} 2"',.        
-0000a9b0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000a9c0: 6e61 6d65 7d20 2265 6368 6f20 7b74 696d  name} "echo {tim
-0000a9d0: 6573 7461 6d70 7d20 3322 272c 0a20 2020  estamp} 3"',.   
-0000a9e0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0000a9f0: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
-0000aa00: 207b 7469 6d65 7374 616d 707d 2034 2227   {timestamp} 4"'
-0000aa10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000aa20: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000aa30: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-0000aa40: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000aa50: 6f67 7320 7b6e 616d 657d 2033 2034 202d  ogs {name} 3 4 -
-0000aa60: 2d73 796e 632d 646f 776e 272c 0a20 2020  -sync-down',.   
-0000aa70: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000aa80: 6f67 7320 7b6e 616d 657d 202a 202d 2d73  ogs {name} * --s
-0000aa90: 796e 632d 646f 776e 272c 0a20 2020 2020  ync-down',.     
-0000aaa0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000aab0: 7320 7b6e 616d 657d 2031 207c 2067 7265  s {name} 1 | gre
-0000aac0: 7020 227b 7469 6d65 7374 616d 707d 2031  p "{timestamp} 1
-0000aad0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0000aae0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000aaf0: 7d20 7c20 6772 6570 2022 7b74 696d 6573  } | grep "{times
-0000ab00: 7461 6d70 7d20 3422 272c 0a20 2020 2020  tamp} 4"',.     
-0000ab10: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-0000ab20: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0000ab30: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-0000ab40: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0000ab50: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0000ab60: 204a 6f62 2051 7565 7565 2e20 2d2d 2d2d   Job Queue. ----
-0000ab70: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-0000ab80: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0000ab90: 6b20 2023 2046 6c75 6964 5374 6163 6b20  k  # FluidStack 
-0000aba0: 4443 2068 6173 206c 6f77 2061 7661 696c  DC has low avail
-0000abb0: 6162 696c 6974 7920 6f66 2054 3420 4750  ability of T4 GP
-0000abc0: 5573 0a40 7079 7465 7374 2e6d 6172 6b2e  Us.@pytest.mark.
-0000abd0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-0000abe0: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-0000abf0: 646f 6573 206e 6f74 2068 6176 6520 5434  does not have T4
-0000ac00: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
-0000ac10: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
-0000ac20: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-0000ac30: 6861 7665 2054 3420 6770 7573 2e20 7275  have T4 gpus. ru
-0000ac40: 6e20 7465 7374 5f69 626d 5f6a 6f62 5f71  n test_ibm_job_q
-0000ac50: 7565 7565 2069 6e73 7465 6164 0a40 7079  ueue instead.@py
-0000ac60: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-0000ac70: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-0000ac80: 2068 6176 6520 5434 2067 7075 732e 2052   have T4 gpus. R
-0000ac90: 756e 2074 6573 745f 7363 705f 6a6f 625f  un test_scp_job_
-0000aca0: 7175 6575 6520 696e 7374 6561 640a 4070  queue instead.@p
-0000acb0: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
-0000acc0: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
-0000acd0: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
-0000ace0: 6861 7665 2054 3420 6770 7573 2e0a 4070  have T4 gpus..@p
-0000acf0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6f63  ytest.mark.no_oc
-0000ad00: 6920 2023 204f 4349 2064 6f65 7320 6e6f  i  # OCI does no
-0000ad10: 7420 6861 7665 2054 3420 6770 7573 0a64  t have T4 gpus.d
-0000ad20: 6566 2074 6573 745f 6a6f 625f 7175 6575  ef test_job_queu
-0000ad30: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-0000ad40: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000ad50: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000ad60: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000ad70: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000ad80: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
-0000ad90: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000ada0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000adb0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-0000adc0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000add0: 7564 7d20 6578 616d 706c 6573 2f6a 6f62  ud} examples/job
-0000ade0: 5f71 7565 7565 2f63 6c75 7374 6572 2e79  _queue/cluster.y
-0000adf0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000ae00: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000ae10: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
-0000ae20: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
-0000ae30: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
-0000ae40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000ae50: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-0000ae60: 6e20 7b6e 616d 657d 2d32 202d 6420 6578  n {name}-2 -d ex
-0000ae70: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-0000ae80: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
-0000ae90: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000aea0: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-0000aeb0: 6d65 7d2d 3320 2d64 2065 7861 6d70 6c65  me}-3 -d example
-0000aec0: 732f 6a6f 625f 7175 6575 652f 6a6f 622e  s/job_queue/job.
-0000aed0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000aee0: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000aef0: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
-0000af00: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000af10: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-0000af20: 7265 7020 7b6e 616d 657d 2d31 207c 2067  rep {name}-1 | g
-0000af30: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
-0000af40: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000af50: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000af60: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-0000af70: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-0000af80: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000af90: 7d2d 3220 7c20 6772 6570 2052 554e 4e49  }-2 | grep RUNNI
-0000afa0: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
-0000afb0: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-0000afc0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-0000afd0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-0000afe0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-0000aff0: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
-0000b000: 7020 5045 4e44 494e 4727 2c0a 2020 2020  p PENDING',.    
-0000b010: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-0000b020: 6e63 656c 202d 7920 7b6e 616d 657d 2032  ncel -y {name} 2
-0000b030: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0000b040: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
-0000b050: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000b060: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
-0000b070: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-0000b080: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-0000b090: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0000b0a0: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
-0000b0b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b0c0: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
-0000b0d0: 6d65 7d20 3327 2c0a 2020 2020 2020 2020  me} 3',.        
-0000b0e0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000b0f0: 6e61 6d65 7d20 2d2d 6770 7573 2054 343a  name} --gpus T4:
-0000b100: 302e 3220 225b 5b20 5c24 534b 5950 494c  0.2 "[[ \$SKYPIL
-0000b110: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
-0000b120: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
-0000b130: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0000b140: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000b150: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
-0000b160: 5434 3a31 2022 5b5b 205c 2453 4b59 5049  T4:1 "[[ \$SKYPI
-0000b170: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
-0000b180: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
-0000b190: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0000b1a0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000b1b0: 6773 207b 6e61 6d65 7d20 3420 2d2d 7374  gs {name} 4 --st
-0000b1c0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-0000b1d0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000b1e0: 616d 657d 2035 202d 2d73 7461 7475 7327  ame} 5 --status'
-0000b1f0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0000b200: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000b210: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000b220: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0000b230: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0000b240: 2d2d 2d2d 2d2d 2d20 4a6f 6220 5175 6575  ------- Job Queu
-0000b250: 6520 7769 7468 2044 6f63 6b65 722e 202d  e with Docker. -
-0000b260: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-0000b270: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-0000b280: 7461 636b 2020 2320 466c 7569 6453 7461  tack  # FluidSta
-0000b290: 636b 2064 6f65 7320 6e6f 7420 7375 7070  ck does not supp
-0000b2a0: 6f72 7420 646f 636b 6572 2066 6f72 206e  ort docker for n
-0000b2b0: 6f77 0a40 7079 7465 7374 2e6d 6172 6b2e  ow.@pytest.mark.
-0000b2c0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-0000b2d0: 2023 2044 6f65 736e 2774 2073 7570 706f   # Doesn't suppo
-0000b2e0: 7274 204c 616d 6264 6120 436c 6f75 6420  rt Lambda Cloud 
-0000b2f0: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
-0000b300: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2044  mark.no_ibm  # D
-0000b310: 6f65 736e 2774 2073 7570 706f 7274 2049  oesn't support I
-0000b320: 424d 2043 6c6f 7564 2066 6f72 206e 6f77  BM Cloud for now
-0000b330: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000b340: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-0000b350: 6170 6572 7370 6163 6520 646f 6573 6e27  aperspace doesn'
-0000b360: 7420 6861 7665 2054 3420 4750 5573 0a40  t have T4 GPUs.@
-0000b370: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
-0000b380: 6370 2020 2320 446f 6573 6e27 7420 7375  cp  # Doesn't su
-0000b390: 7070 6f72 7420 5343 5020 666f 7220 6e6f  pport SCP for no
-0000b3a0: 770a 4070 7974 6573 742e 6d61 726b 2e6e  w.@pytest.mark.n
-0000b3b0: 6f5f 6f63 6920 2023 2044 6f65 736e 2774  o_oci  # Doesn't
-0000b3c0: 2073 7570 706f 7274 204f 4349 2066 6f72   support OCI for
-0000b3d0: 206e 6f77 0a40 7079 7465 7374 2e6d 6172   now.@pytest.mar
-0000b3e0: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
-0000b3f0: 2023 2044 6f65 736e 2774 2073 7570 706f   # Doesn't suppo
-0000b400: 7274 204b 7562 6572 6e65 7465 7320 666f  rt Kubernetes fo
-0000b410: 7220 6e6f 770a 4070 7974 6573 742e 6d61  r now.@pytest.ma
-0000b420: 726b 2e70 6172 616d 6574 7269 7a65 280a  rk.parametrize(.
-0000b430: 2020 2020 2269 6d61 6765 5f69 6422 2c0a      "image_id",.
-0000b440: 2020 2020 5b0a 2020 2020 2020 2020 2264      [.        "d
-0000b450: 6f63 6b65 723a 6e76 6964 6961 2f63 7564  ocker:nvidia/cud
-0000b460: 613a 3131 2e38 2e30 2d64 6576 656c 2d75  a:11.8.0-devel-u
-0000b470: 6275 6e74 7531 382e 3034 222c 0a20 2020  buntu18.04",.   
-0000b480: 2020 2020 2022 646f 636b 6572 3a75 6275       "docker:ubu
-0000b490: 6e74 753a 3138 2e30 3422 2c0a 2020 2020  ntu:18.04",.    
-0000b4a0: 2020 2020 2320 5465 7374 2069 6d61 6765      # Test image
-0000b4b0: 2077 6974 6820 7079 7468 6f6e 2033 2e31   with python 3.1
-0000b4c0: 3120 696e 7374 616c 6c65 6420 6279 2064  1 installed by d
-0000b4d0: 6566 6175 6c74 2e0a 2020 2020 2020 2020  efault..        
-0000b4e0: 2264 6f63 6b65 723a 636f 6e74 696e 7575  "docker:continuu
-0000b4f0: 6d69 6f2f 6d69 6e69 636f 6e64 6133 222c  mio/miniconda3",
-0000b500: 0a20 2020 205d 290a 6465 6620 7465 7374  .    ]).def test
-0000b510: 5f6a 6f62 5f71 7565 7565 5f77 6974 685f  _job_queue_with_
-0000b520: 646f 636b 6572 2867 656e 6572 6963 5f63  docker(generic_c
-0000b530: 6c6f 7564 3a20 7374 722c 2069 6d61 6765  loud: str, image
-0000b540: 5f69 643a 2073 7472 293a 0a20 2020 206e  _id: str):.    n
-0000b550: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0000b560: 6572 5f6e 616d 6528 2920 2b20 696d 6167  er_name() + imag
-0000b570: 655f 6964 5b6c 656e 2827 646f 636b 6572  e_id[len('docker
-0000b580: 3a27 293a 5d5b 3a34 5d0a 2020 2020 7465  :'):][:4].    te
-0000b590: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0000b5a0: 2020 2027 6a6f 625f 7175 6575 655f 7769     'job_queue_wi
-0000b5b0: 7468 5f64 6f63 6b65 7227 2c0a 2020 2020  th_docker',.    
-0000b5c0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000b5d0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000b5e0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-0000b5f0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000b600: 7564 7d20 2d2d 696d 6167 652d 6964 207b  ud} --image-id {
-0000b610: 696d 6167 655f 6964 7d20 6578 616d 706c  image_id} exampl
-0000b620: 6573 2f6a 6f62 5f71 7565 7565 2f63 6c75  es/job_queue/clu
-0000b630: 7374 6572 5f64 6f63 6b65 722e 7961 6d6c  ster_docker.yaml
-0000b640: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000b650: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000b660: 202d 6e20 7b6e 616d 657d 2d31 202d 6420   -n {name}-1 -d 
-0000b670: 2d2d 696d 6167 652d 6964 207b 696d 6167  --image-id {imag
-0000b680: 655f 6964 7d20 6578 616d 706c 6573 2f6a  e_id} examples/j
-0000b690: 6f62 5f71 7565 7565 2f6a 6f62 5f64 6f63  ob_queue/job_doc
-0000b6a0: 6b65 722e 7961 6d6c 272c 0a20 2020 2020  ker.yaml',.     
-0000b6b0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000b6c0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-0000b6d0: 657d 2d32 202d 6420 2d2d 696d 6167 652d  e}-2 -d --image-
-0000b6e0: 6964 207b 696d 6167 655f 6964 7d20 6578  id {image_id} ex
-0000b6f0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-0000b700: 2f6a 6f62 5f64 6f63 6b65 722e 7961 6d6c  /job_docker.yaml
-0000b710: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000b720: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000b730: 202d 6e20 7b6e 616d 657d 2d33 202d 6420   -n {name}-3 -d 
-0000b740: 2d2d 696d 6167 652d 6964 207b 696d 6167  --image-id {imag
-0000b750: 655f 6964 7d20 6578 616d 706c 6573 2f6a  e_id} examples/j
-0000b760: 6f62 5f71 7565 7565 2f6a 6f62 5f64 6f63  ob_queue/job_doc
-0000b770: 6b65 722e 7961 6d6c 272c 0a20 2020 2020  ker.yaml',.     
-0000b780: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000b790: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-0000b7a0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000b7b0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000b7c0: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
-0000b7d0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
-0000b7e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000b7f0: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-0000b800: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
-0000b810: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-0000b820: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-0000b830: 6e61 6d65 7d2d 3220 7c20 6772 6570 2052  name}-2 | grep R
-0000b840: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
-0000b850: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000b860: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-0000b870: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-0000b880: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-0000b890: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-0000b8a0: 2067 7265 7020 5045 4e44 494e 4727 2c0a   grep PENDING',.
-0000b8b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000b8c0: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
-0000b8d0: 657d 2032 272c 0a20 2020 2020 2020 2020  e} 2',.         
-0000b8e0: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-0000b8f0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000b900: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000b910: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-0000b920: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-0000b930: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000b940: 7d2d 3320 7c20 6772 6570 2052 554e 4e49  }-3 | grep RUNNI
-0000b950: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
-0000b960: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000b970: 207b 6e61 6d65 7d20 3327 2c0a 2020 2020   {name} 3',.    
-0000b980: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-0000b990: 6f70 202d 7920 7b6e 616d 657d 272c 0a20  op -y {name}',. 
-0000b9a0: 2020 2020 2020 2020 2020 2023 204d 616b             # Mak
-0000b9b0: 6520 7375 7265 2074 6865 206a 6f62 2073  e sure the job s
-0000b9c0: 7461 7475 7320 7072 6573 6572 7665 2061  tatus preserve a
-0000b9d0: 6674 6572 2073 746f 7020 616e 6420 7374  fter stop and st
-0000b9e0: 6172 7420 7468 650a 2020 2020 2020 2020  art the.        
-0000b9f0: 2020 2020 2320 636c 7573 7465 722e 2054      # cluster. T
-0000ba00: 6869 7320 6973 2061 6c73 6f20 6120 7465  his is also a te
-0000ba10: 7374 2066 6f72 2074 6865 2064 6f63 6b65  st for the docke
-0000ba20: 7220 636f 6e74 6169 6e65 7220 746f 2062  r container to b
-0000ba30: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-0000ba40: 7072 6573 6572 7665 6420 6166 7465 7220  preserved after 
-0000ba50: 7374 6f70 2061 6e64 2073 7461 7274 2e0a  stop and start..
-0000ba60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000ba70: 7920 7374 6172 7420 2d79 207b 6e61 6d65  y start -y {name
-0000ba80: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-0000ba90: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
-0000baa0: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
-0000bab0: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-0000bac0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000bad0: 207b 6e61 6d65 7d2d 3120 7c20 6772 6570   {name}-1 | grep
-0000bae0: 2046 4149 4c45 4427 2c0a 2020 2020 2020   FAILED',.      
-0000baf0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000bb00: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
-0000bb10: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-0000bb20: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-0000bb30: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
-0000bb40: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
-0000bb50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000bb60: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000bb70: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-0000bb80: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
-0000bb90: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000bba0: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
-0000bbb0: 4341 4e43 454c 4c45 4427 2c0a 2020 2020  CANCELLED',.    
-0000bbc0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000bbd0: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
-0000bbe0: 2054 343a 302e 3220 225b 5b20 5c24 534b   T4:0.2 "[[ \$SK
-0000bbf0: 5950 494c 4f54 5f4e 554d 5f47 5055 535f  YPILOT_NUM_GPUS_
-0000bc00: 5045 525f 4e4f 4445 202d 6571 2031 205d  PER_NODE -eq 1 ]
-0000bc10: 5d20 7c7c 2065 7869 7420 3122 272c 0a20  ] || exit 1"',. 
-0000bc20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000bc30: 2065 7865 6320 7b6e 616d 657d 202d 2d67   exec {name} --g
-0000bc40: 7075 7320 5434 3a31 2022 5b5b 205c 2453  pus T4:1 "[[ \$S
-0000bc50: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
-0000bc60: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
-0000bc70: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
-0000bc80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000bc90: 7920 6c6f 6773 207b 6e61 6d65 7d20 3420  y logs {name} 4 
-0000bca0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-0000bcb0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000bcc0: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
-0000bcd0: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
-0000bce0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000bcf0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000bd00: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000bd10: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0000bd20: 7079 7465 7374 2e6d 6172 6b2e 6c61 6d62  pytest.mark.lamb
-0000bd30: 6461 5f63 6c6f 7564 0a64 6566 2074 6573  da_cloud.def tes
-0000bd40: 745f 6c61 6d62 6461 5f6a 6f62 5f71 7565  t_lambda_job_que
-0000bd50: 7565 2829 3a0a 2020 2020 6e61 6d65 203d  ue():.    name =
-0000bd60: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000bd70: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000bd80: 5465 7374 280a 2020 2020 2020 2020 276c  Test(.        'l
-0000bd90: 616d 6264 615f 6a6f 625f 7175 6575 6527  ambda_job_queue'
-0000bda0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0000bdb0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000bdc0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000bdd0: 7d20 7b4c 414d 4244 415f 5459 5045 7d20  } {LAMBDA_TYPE} 
-0000bde0: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
-0000bdf0: 7565 2f63 6c75 7374 6572 2e79 616d 6c27  ue/cluster.yaml'
-0000be00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000be10: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000be20: 2d6e 207b 6e61 6d65 7d2d 3120 2d2d 6770  -n {name}-1 --gp
-0000be30: 7573 2041 3130 3a30 2e35 202d 6420 6578  us A10:0.5 -d ex
-0000be40: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-0000be50: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
-0000be60: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000be70: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-0000be80: 6d65 7d2d 3220 2d2d 6770 7573 2041 3130  me}-2 --gpus A10
-0000be90: 3a30 2e35 202d 6420 6578 616d 706c 6573  :0.5 -d examples
-0000bea0: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 2e79  /job_queue/job.y
-0000beb0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000bec0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000bed0: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3320  me} -n {name}-3 
-0000bee0: 2d2d 6770 7573 2041 3130 3a30 2e35 202d  --gpus A10:0.5 -
-0000bef0: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
-0000bf00: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
-0000bf10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000bf20: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
-0000bf30: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
-0000bf40: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
-0000bf50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000bf60: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
-0000bf70: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
-0000bf80: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
-0000bf90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000bfa0: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
-0000bfb0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-0000bfc0: 2067 7265 7020 5045 4e44 494e 4727 2c0a   grep PENDING',.
-0000bfd0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000bfe0: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
-0000bff0: 657d 2032 272c 0a20 2020 2020 2020 2020  e} 2',.         
-0000c000: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-0000c010: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000c020: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
-0000c030: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
-0000c040: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
-0000c050: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000c060: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
-0000c070: 2033 272c 0a20 2020 2020 2020 205d 2c0a   3',.        ],.
-0000c080: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0000c090: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0000c0a0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000c0b0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-0000c0c0: 7974 6573 742e 6d61 726b 2e69 626d 0a64  ytest.mark.ibm.d
-0000c0d0: 6566 2074 6573 745f 6962 6d5f 6a6f 625f  ef test_ibm_job_
-0000c0e0: 7175 6575 6528 293a 0a20 2020 206e 616d  queue():.    nam
-0000c0f0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0000c100: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0000c110: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0000c120: 2027 6962 6d5f 6a6f 625f 7175 6575 6527   'ibm_job_queue'
-0000c130: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0000c140: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000c150: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000c160: 7d20 2d2d 636c 6f75 6420 6962 6d20 2d2d  } --cloud ibm --
-0000c170: 6770 7573 2076 3130 3027 2c0a 2020 2020  gpus v100',.    
-0000c180: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000c190: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-0000c1a0: 6d65 7d2d 3120 2d2d 636c 6f75 6420 6962  me}-1 --cloud ib
-0000c1b0: 6d20 2d64 2065 7861 6d70 6c65 732f 6a6f  m -d examples/jo
-0000c1c0: 625f 7175 6575 652f 6a6f 625f 6962 6d2e  b_queue/job_ibm.
-0000c1d0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000c1e0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000c1f0: 616d 657d 202d 6e20 7b6e 616d 657d 2d32  ame} -n {name}-2
-0000c200: 202d 2d63 6c6f 7564 2069 626d 202d 6420   --cloud ibm -d 
-0000c210: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
-0000c220: 7565 2f6a 6f62 5f69 626d 2e79 616d 6c27  ue/job_ibm.yaml'
-0000c230: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000c240: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000c250: 2d6e 207b 6e61 6d65 7d2d 3320 2d2d 636c  -n {name}-3 --cl
-0000c260: 6f75 6420 6962 6d20 2d64 2065 7861 6d70  oud ibm -d examp
-0000c270: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
-0000c280: 625f 6962 6d2e 7961 6d6c 272c 0a20 2020  b_ibm.yaml',.   
-0000c290: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
-0000c2a0: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
-0000c2b0: 6570 207b 6e61 6d65 7d2d 3120 7c20 6772  ep {name}-1 | gr
-0000c2c0: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
-0000c2d0: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
-0000c2e0: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
-0000c2f0: 6570 207b 6e61 6d65 7d2d 3220 7c20 6772  ep {name}-2 | gr
-0000c300: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
-0000c310: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
-0000c320: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
-0000c330: 6570 207b 6e61 6d65 7d2d 3320 7c20 6772  ep {name}-3 | gr
-0000c340: 6570 2050 454e 4449 4e47 272c 0a20 2020  ep PENDING',.   
-0000c350: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
-0000c360: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
-0000c370: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-0000c380: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0000c390: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
-0000c3a0: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
-0000c3b0: 207b 6e61 6d65 7d2d 3320 7c20 6772 6570   {name}-3 | grep
-0000c3c0: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
-0000c3d0: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000c3e0: 6365 6c20 2d79 207b 6e61 6d65 7d20 3327  cel -y {name} 3'
-0000c3f0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0000c400: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000c410: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000c420: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0000c430: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0000c440: 7374 2e6d 6172 6b2e 7363 700a 6465 6620  st.mark.scp.def 
-0000c450: 7465 7374 5f73 6370 5f6a 6f62 5f71 7565  test_scp_job_que
-0000c460: 7565 2829 3a0a 2020 2020 6e61 6d65 203d  ue():.    name =
-0000c470: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000c480: 6d65 2829 0a20 2020 206e 756d 5f6f 665f  me().    num_of_
-0000c490: 6770 755f 6c61 756e 6368 203d 2031 0a20  gpu_launch = 1. 
-0000c4a0: 2020 206e 756d 5f6f 665f 6770 755f 6578     num_of_gpu_ex
-0000c4b0: 6563 203d 2030 2e35 0a20 2020 2074 6573  ec = 0.5.    tes
-0000c4c0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000c4d0: 2020 2753 4350 5f6a 6f62 5f71 7565 7565    'SCP_job_queue
-0000c4e0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0000c4f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000c500: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-0000c510: 657d 207b 5343 505f 5459 5045 7d20 7b53  e} {SCP_TYPE} {S
-0000c520: 4350 5f47 5055 5f56 3130 307d 3a7b 6e75  CP_GPU_V100}:{nu
-0000c530: 6d5f 6f66 5f67 7075 5f6c 6175 6e63 687d  m_of_gpu_launch}
-0000c540: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-0000c550: 6575 652f 636c 7573 7465 722e 7961 6d6c  eue/cluster.yaml
-0000c560: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000c570: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000c580: 202d 6e20 7b6e 616d 657d 2d31 207b 5343   -n {name}-1 {SC
-0000c590: 505f 4750 555f 5631 3030 7d3a 7b6e 756d  P_GPU_V100}:{num
-0000c5a0: 5f6f 665f 6770 755f 6578 6563 7d20 2d64  _of_gpu_exec} -d
-0000c5b0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-0000c5c0: 6575 652f 6a6f 622e 7961 6d6c 272c 0a20  eue/job.yaml',. 
-0000c5d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000c5e0: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
-0000c5f0: 7b6e 616d 657d 2d32 207b 5343 505f 4750  {name}-2 {SCP_GP
-0000c600: 555f 5631 3030 7d3a 7b6e 756d 5f6f 665f  U_V100}:{num_of_
-0000c610: 6770 755f 6578 6563 7d20 2d64 2065 7861  gpu_exec} -d exa
-0000c620: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
-0000c630: 6a6f 622e 7961 6d6c 272c 0a20 2020 2020  job.yaml',.     
-0000c640: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000c650: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-0000c660: 657d 2d33 207b 5343 505f 4750 555f 5631  e}-3 {SCP_GPU_V1
-0000c670: 3030 7d3a 7b6e 756d 5f6f 665f 6770 755f  00}:{num_of_gpu_
-0000c680: 6578 6563 7d20 2d64 2065 7861 6d70 6c65  exec} -d example
-0000c690: 732f 6a6f 625f 7175 6575 652f 6a6f 622e  s/job_queue/job.
-0000c6a0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000c6b0: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
-0000c6c0: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
-0000c6d0: 6d65 7d2d 3120 7c20 6772 6570 2052 554e  me}-1 | grep RUN
-0000c6e0: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
-0000c6f0: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
-0000c700: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
-0000c710: 6d65 7d2d 3220 7c20 6772 6570 2052 554e  me}-2 | grep RUN
-0000c720: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
-0000c730: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
-0000c740: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
-0000c750: 6d65 7d2d 3320 7c20 6772 6570 2050 454e  me}-3 | grep PEN
-0000c760: 4449 4e47 272c 0a20 2020 2020 2020 2020  DING',.         
-0000c770: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
-0000c780: 2d79 207b 6e61 6d65 7d20 3227 2c0a 2020  -y {name} 2',.  
-0000c790: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0000c7a0: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
-0000c7b0: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
-0000c7c0: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
-0000c7d0: 7d2d 3320 7c20 6772 6570 2052 554e 4e49  }-3 | grep RUNNI
-0000c7e0: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
-0000c7f0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000c800: 207b 6e61 6d65 7d20 3327 2c0a 2020 2020   {name} 3',.    
-0000c810: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000c820: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000c830: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-0000c840: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000c850: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0000c860: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-0000c870: 2023 2046 6c75 6964 5374 6163 6b20 4443   # FluidStack DC
-0000c880: 2068 6173 206c 6f77 2061 7661 696c 6162   has low availab
-0000c890: 696c 6974 7920 6f66 2054 3420 4750 5573  ility of T4 GPUs
-0000c8a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000c8b0: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
-0000c8c0: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
-0000c8d0: 6573 206e 6f74 2068 6176 6520 5434 2067  es not have T4 g
-0000c8e0: 7075 730a 4070 7974 6573 742e 6d61 726b  pus.@pytest.mark
-0000c8f0: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
-0000c900: 6c6f 7564 2064 6f65 7320 6e6f 7420 6861  loud does not ha
-0000c910: 7665 2054 3420 6770 7573 2e20 7275 6e20  ve T4 gpus. run 
-0000c920: 7465 7374 5f69 626d 5f6a 6f62 5f71 7565  test_ibm_job_que
-0000c930: 7565 5f6d 756c 7469 6e6f 6465 2069 6e73  ue_multinode ins
-0000c940: 7465 6164 0a40 7079 7465 7374 2e6d 6172  tead.@pytest.mar
-0000c950: 6b2e 6e6f 5f70 6170 6572 7370 6163 6520  k.no_paperspace 
-0000c960: 2023 2050 6170 6572 7370 6163 6520 646f   # Paperspace do
-0000c970: 6573 206e 6f74 2068 6176 6520 5434 2067  es not have T4 g
-0000c980: 7075 732e 0a40 7079 7465 7374 2e6d 6172  pus..@pytest.mar
-0000c990: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
-0000c9a0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0000c9b0: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
-0000c9c0: 6574 0a40 7079 7465 7374 2e6d 6172 6b2e  et.@pytest.mark.
-0000c9d0: 6e6f 5f6f 6369 2020 2320 4f43 4920 436c  no_oci  # OCI Cl
-0000c9e0: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
-0000c9f0: 6520 5434 2067 7075 732e 0a40 7079 7465  e T4 gpus..@pyte
-0000ca00: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
-0000ca10: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
-0000ca20: 7465 7320 6e6f 7420 7375 7070 6f72 7420  tes not support 
-0000ca30: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
-0000ca40: 740a 6465 6620 7465 7374 5f6a 6f62 5f71  t.def test_job_q
-0000ca50: 7565 7565 5f6d 756c 7469 6e6f 6465 2867  ueue_multinode(g
-0000ca60: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-0000ca70: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-0000ca80: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000ca90: 2829 0a20 2020 2074 6f74 616c 5f74 696d  ().    total_tim
-0000caa0: 656f 7574 5f6d 696e 7574 6573 203d 2033  eout_minutes = 3
-0000cab0: 3020 6966 2067 656e 6572 6963 5f63 6c6f  0 if generic_clo
-0000cac0: 7564 203d 3d20 2761 7a75 7265 2720 656c  ud == 'azure' el
-0000cad0: 7365 2031 350a 2020 2020 7465 7374 203d  se 15.    test =
-0000cae0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000caf0: 6a6f 625f 7175 6575 655f 6d75 6c74 696e  job_queue_multin
-0000cb00: 6f64 6527 2c0a 2020 2020 2020 2020 5b0a  ode',.        [.
-0000cb10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000cb20: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0000cb30: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-0000cb40: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
-0000cb50: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-0000cb60: 2f63 6c75 7374 6572 5f6d 756c 7469 6e6f  /cluster_multino
-0000cb70: 6465 2e79 616d 6c27 2c0a 2020 2020 2020  de.yaml',.      
-0000cb80: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0000cb90: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
-0000cba0: 7d2d 3120 2d64 2065 7861 6d70 6c65 732f  }-1 -d examples/
-0000cbb0: 6a6f 625f 7175 6575 652f 6a6f 625f 6d75  job_queue/job_mu
-0000cbc0: 6c74 696e 6f64 652e 7961 6d6c 272c 0a20  ltinode.yaml',. 
-0000cbd0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000cbe0: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
-0000cbf0: 7b6e 616d 657d 2d32 202d 6420 6578 616d  {name}-2 -d exam
-0000cc00: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
-0000cc10: 6f62 5f6d 756c 7469 6e6f 6465 2e79 616d  ob_multinode.yam
-0000cc20: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000cc30: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
-0000cc40: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
-0000cc50: 2d33 202d 2d64 6574 6163 682d 7365 7475  -3 --detach-setu
-0000cc60: 7020 2d64 2065 7861 6d70 6c65 732f 6a6f  p -d examples/jo
-0000cc70: 625f 7175 6575 652f 6a6f 625f 6d75 6c74  b_queue/job_mult
-0000cc80: 696e 6f64 652e 7961 6d6c 272c 0a20 2020  inode.yaml',.   
-0000cc90: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000cca0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-0000ccb0: 2026 2620 6563 686f 2022 2473 2220 2626   && echo "$s" &&
-0000ccc0: 2028 6563 686f 2022 2473 2220 7c20 6772   (echo "$s" | gr
-0000ccd0: 6570 207b 6e61 6d65 7d2d 3120 7c20 6772  ep {name}-1 | gr
-0000cce0: 6570 2052 554e 4e49 4e47 2927 2c0a 2020  ep RUNNING)',.  
-0000ccf0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000cd00: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000cd10: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-0000cd20: 2620 2865 6368 6f20 2224 7322 207c 2067  & (echo "$s" | g
-0000cd30: 7265 7020 7b6e 616d 657d 2d32 207c 2067  rep {name}-2 | g
-0000cd40: 7265 7020 5255 4e4e 494e 4729 272c 0a20  rep RUNNING)',. 
-0000cd50: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000cd60: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-0000cd70: 7d29 2026 2620 6563 686f 2022 2473 2220  }) && echo "$s" 
-0000cd80: 2626 2028 6563 686f 2022 2473 2220 7c20  && (echo "$s" | 
-0000cd90: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-0000cda0: 6772 6570 2050 454e 4449 4e47 2927 2c0a  grep PENDING)',.
-0000cdb0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000cdc0: 6570 2039 3027 2c0a 2020 2020 2020 2020  ep 90',.        
-0000cdd0: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
-0000cde0: 202d 7920 7b6e 616d 657d 2031 272c 0a20   -y {name} 1',. 
-0000cdf0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0000ce00: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
-0000ce10: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000ce20: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-0000ce30: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-0000ce40: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-0000ce50: 6570 207b 6e61 6d65 7d2d 3320 7c20 6772  ep {name}-3 | gr
-0000ce60: 6570 2053 4554 5449 4e47 5f55 5027 2c0a  ep SETTING_UP',.
-0000ce70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000ce80: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
-0000ce90: 657d 2031 2032 2033 272c 0a20 2020 2020  e} 1 2 3',.     
-0000cea0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000ceb0: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d6e  nch -c {name} -n
-0000cec0: 207b 6e61 6d65 7d2d 3420 2d2d 6465 7461   {name}-4 --deta
-0000ced0: 6368 2d73 6574 7570 202d 6420 6578 616d  ch-setup -d exam
-0000cee0: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
-0000cef0: 6f62 5f6d 756c 7469 6e6f 6465 2e79 616d  ob_multinode.yam
-0000cf00: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000cf10: 2320 5465 7374 2074 6865 206a 6f62 2073  # Test the job s
-0000cf20: 7461 7475 7320 6973 2063 6f72 7265 6374  tatus is correct
-0000cf30: 6c79 2073 6574 2074 6f20 5345 5454 494e  ly set to SETTIN
-0000cf40: 475f 5550 2c20 6475 7269 6e67 2074 6865  G_UP, during the
-0000cf50: 2073 6574 7570 2069 7320 7275 6e6e 696e   setup is runnin
-0000cf60: 672c 0a20 2020 2020 2020 2020 2020 2023  g,.            #
-0000cf70: 2061 6e64 2074 6865 206a 6f62 2063 616e   and the job can
-0000cf80: 2062 6520 6361 6e63 656c 6c65 6420 6475   be cancelled du
-0000cf90: 7269 6e67 2074 6865 2073 6574 7570 2e0a  ring the setup..
-0000cfa0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000cfb0: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-0000cfc0: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000cfd0: 7565 207b 6e61 6d65 7d29 2026 2620 6563  ue {name}) && ec
-0000cfe0: 686f 2022 2473 2220 2626 2028 6563 686f  ho "$s" && (echo
-0000cff0: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-0000d000: 6d65 7d2d 3420 7c20 6772 6570 2053 4554  me}-4 | grep SET
-0000d010: 5449 4e47 5f55 5029 272c 0a20 2020 2020  TING_UP)',.     
-0000d020: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000d030: 6365 6c20 2d79 207b 6e61 6d65 7d20 3427  cel -y {name} 4'
-0000d040: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000d050: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-0000d060: 616d 657d 2920 2626 2065 6368 6f20 2224  ame}) && echo "$
-0000d070: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
-0000d080: 207c 2067 7265 7020 7b6e 616d 657d 2d34   | grep {name}-4
-0000d090: 207c 2067 7265 7020 4341 4e43 454c 4c45   | grep CANCELLE
-0000d0a0: 4429 272c 0a20 2020 2020 2020 2020 2020  D)',.           
-0000d0b0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000d0c0: 657d 202d 2d67 7075 7320 5434 3a30 2e32  e} --gpus T4:0.2
-0000d0d0: 2022 5b5b 205c 2453 4b59 5049 4c4f 545f   "[[ \$SKYPILOT_
-0000d0e0: 4e55 4d5f 4750 5553 5f50 4552 5f4e 4f44  NUM_GPUS_PER_NOD
-0000d0f0: 4520 2d65 7120 3120 5d5d 207c 7c20 6578  E -eq 1 ]] || ex
-0000d100: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-0000d110: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000d120: 6e61 6d65 7d20 2d2d 6770 7573 2054 343a  name} --gpus T4:
-0000d130: 302e 3220 2d2d 6e75 6d2d 6e6f 6465 7320  0.2 --num-nodes 
-0000d140: 3220 225b 5b20 5c24 534b 5950 494c 4f54  2 "[[ \$SKYPILOT
-0000d150: 5f4e 554d 5f47 5055 535f 5045 525f 4e4f  _NUM_GPUS_PER_NO
-0000d160: 4445 202d 6571 2031 205d 5d20 7c7c 2065  DE -eq 1 ]] || e
-0000d170: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
-0000d180: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000d190: 7b6e 616d 657d 202d 2d67 7075 7320 5434  {name} --gpus T4
-0000d1a0: 3a31 202d 2d6e 756d 2d6e 6f64 6573 2032  :1 --num-nodes 2
-0000d1b0: 2022 5b5b 205c 2453 4b59 5049 4c4f 545f   "[[ \$SKYPILOT_
-0000d1c0: 4e55 4d5f 4750 5553 5f50 4552 5f4e 4f44  NUM_GPUS_PER_NOD
-0000d1d0: 4520 2d65 7120 3120 5d5d 207c 7c20 6578  E -eq 1 ]] || ex
-0000d1e0: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-0000d1f0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000d200: 6e61 6d65 7d20 3520 2d2d 7374 6174 7573  name} 5 --status
-0000d210: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000d220: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000d230: 2036 202d 2d73 7461 7475 7327 2c0a 2020   6 --status',.  
-0000d240: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000d250: 6c6f 6773 207b 6e61 6d65 7d20 3720 2d2d  logs {name} 7 --
-0000d260: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-0000d270: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-0000d280: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0000d290: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
-0000d2a0: 7574 3d74 6f74 616c 5f74 696d 656f 7574  ut=total_timeout
-0000d2b0: 5f6d 696e 7574 6573 202a 2036 302c 0a20  _minutes * 60,. 
-0000d2c0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000d2d0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-0000d2e0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-0000d2f0: 6d62 6461 5f63 6c6f 7564 2020 2320 4e6f  mbda_cloud  # No
-0000d300: 204c 616d 6264 6120 436c 6f75 6420 564d   Lambda Cloud VM
-0000d310: 2068 6173 2038 2043 5055 730a 6465 6620   has 8 CPUs.def 
-0000d320: 7465 7374 5f6c 6172 6765 5f6a 6f62 5f71  test_large_job_q
-0000d330: 7565 7565 2867 656e 6572 6963 5f63 6c6f  ueue(generic_clo
-0000d340: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-0000d350: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000d360: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0000d370: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000d380: 2020 276c 6172 6765 5f6a 6f62 5f71 7565    'large_job_que
-0000d390: 7565 272c 0a20 2020 2020 2020 205b 0a20  ue',.        [. 
-0000d3a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000d3b0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-0000d3c0: 616d 657d 202d 2d63 7075 7320 3820 2d2d  ame} --cpus 8 --
-0000d3d0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-0000d3e0: 6c6f 7564 7d27 2c0a 2020 2020 2020 2020  loud}',.        
-0000d3f0: 2020 2020 6627 666f 7220 6920 696e 2060      f'for i in `
-0000d400: 7365 7120 3120 3735 603b 2064 6f20 736b  seq 1 75`; do sk
-0000d410: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-0000d420: 207b 6e61 6d65 7d2d 2469 202d 6420 2265   {name}-$i -d "e
-0000d430: 6368 6f20 2469 3b20 736c 6565 7020 3130  cho $i; sleep 10
-0000d440: 3030 3030 3030 3022 3b20 646f 6e65 272c  0000000"; done',
-0000d450: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000d460: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
-0000d470: 6d65 7d20 3120 3220 3320 3420 3520 3620  me} 1 2 3 4 5 6 
-0000d480: 3720 3820 3920 3130 2031 3120 3132 2031  7 8 9 10 11 12 1
-0000d490: 3320 3134 2031 3520 3136 272c 0a20 2020  3 14 15 16',.   
-0000d4a0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0000d4b0: 3930 272c 0a20 2020 2020 2020 2020 2020  90',.           
-0000d4c0: 2023 2045 6163 6820 6a6f 6220 7461 6b65   # Each job take
-0000d4d0: 7320 302e 3520 4350 5520 616e 6420 7468  s 0.5 CPU and th
-0000d4e0: 6520 6465 6661 756c 7420 564d 2068 6173  e default VM has
-0000d4f0: 2038 2043 5055 732c 2073 6f20 7468 6572   8 CPUs, so ther
-0000d500: 6520 7368 6f75 6c64 2062 6520 3820 2f20  e should be 8 / 
-0000d510: 302e 3520 3d20 3136 206a 6f62 7320 7275  0.5 = 16 jobs ru
-0000d520: 6e6e 696e 672e 0a20 2020 2020 2020 2020  nning..         
-0000d530: 2020 2023 2054 6865 2066 6972 7374 2031     # The first 1
-0000d540: 3620 6a6f 6273 2061 7265 2063 616e 6365  6 jobs are cance
-0000d550: 6c65 642c 2073 6f20 7468 6572 6520 7368  led, so there sh
-0000d560: 6f75 6c64 2062 6520 3735 202d 2033 3220  ould be 75 - 32 
-0000d570: 3d20 3433 206a 6f62 7320 5045 4e44 494e  = 43 jobs PENDIN
-0000d580: 472e 0a20 2020 2020 2020 2020 2020 2066  G..            f
-0000d590: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000d5a0: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-0000d5b0: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
-0000d5c0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000d5d0: 2d76 2067 7265 7020 7c20 6772 6570 2050  -v grep | grep P
-0000d5e0: 454e 4449 4e47 207c 2077 6320 2d6c 207c  ENDING | wc -l |
-0000d5f0: 2067 7265 7020 3433 272c 0a20 2020 2020   grep 43',.     
-0000d600: 2020 2020 2020 2023 204d 616b 6520 7375         # Make su
-0000d610: 7265 2074 6865 206a 6f62 7320 6172 6520  re the jobs are 
-0000d620: 7363 6865 6475 6c65 6420 696e 2046 4946  scheduled in FIF
-0000d630: 4f20 6f72 6465 720a 2020 2020 2020 2020  O order.        
-0000d640: 2020 2020 2a5b 0a20 2020 2020 2020 2020      *[.         
-0000d650: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000d660: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-0000d670: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000d680: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000d690: 207c 2067 7265 7020 7b6e 616d 657d 2d7b   | grep {name}-{
-0000d6a0: 697d 207c 2067 7265 7020 4341 4e43 454c  i} | grep CANCEL
-0000d6b0: 4c45 4427 0a20 2020 2020 2020 2020 2020  LED'.           
-0000d6c0: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-0000d6d0: 6e67 6528 312c 2031 3729 0a20 2020 2020  nge(1, 17).     
-0000d6e0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000d6f0: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
-0000d700: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000d710: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-0000d720: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-0000d730: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-0000d740: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-0000d750: 2d7b 697d 207c 2067 7265 7020 5255 4e4e  -{i} | grep RUNN
-0000d760: 494e 4727 0a20 2020 2020 2020 2020 2020  ING'.           
-0000d770: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-0000d780: 6e67 6528 3137 2c20 3333 290a 2020 2020  nge(17, 33).    
-0000d790: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000d7a0: 2020 2020 2020 202a 5b0a 2020 2020 2020         *[.      
-0000d7b0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000d7c0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000d7d0: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-0000d7e0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-0000d7f0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000d800: 7d2d 7b69 7d20 7c20 6772 6570 2050 454e  }-{i} | grep PEN
-0000d810: 4449 4e47 270a 2020 2020 2020 2020 2020  DING'.          
-0000d820: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
-0000d830: 616e 6765 2833 332c 2037 3529 0a20 2020  ange(33, 75).   
-0000d840: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-0000d850: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-0000d860: 6e63 656c 202d 7920 7b6e 616d 657d 2033  ncel -y {name} 3
-0000d870: 3320 3335 2033 3720 3339 2031 3720 3138  3 35 37 39 17 18
-0000d880: 2031 3927 2c0a 2020 2020 2020 2020 2020   19',.          
-0000d890: 2020 2a5b 0a20 2020 2020 2020 2020 2020    *[.           
-0000d8a0: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000d8b0: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-0000d8c0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-0000d8d0: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-0000d8e0: 2067 7265 7020 7b6e 616d 657d 2d7b 697d   grep {name}-{i}
-0000d8f0: 207c 2067 7265 7020 4341 4e43 454c 4c45   | grep CANCELLE
-0000d900: 4427 0a20 2020 2020 2020 2020 2020 2020  D'.             
-0000d910: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0000d920: 6528 3333 2c20 3430 2c20 3229 0a20 2020  e(33, 40, 2).   
-0000d930: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-0000d940: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-0000d950: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0000d960: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
-0000d970: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000d980: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
-0000d990: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000d9a0: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-0000d9b0: 7265 7020 7b6e 616d 657d 2d7b 697d 207c  rep {name}-{i} |
-0000d9c0: 2067 7265 7020 5255 4e4e 494e 4727 0a20   grep RUNNING'. 
-0000d9d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000d9e0: 6f72 2069 2069 6e20 5b33 342c 2033 362c  or i in [34, 36,
-0000d9f0: 2033 385d 0a20 2020 2020 2020 2020 2020   38].           
-0000da00: 205d 2c0a 2020 2020 2020 2020 5d2c 0a20   ],.        ],. 
-0000da10: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-0000da20: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-0000da30: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-0000da40: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-0000da50: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0000da60: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-0000da70: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
-0000da80: 7564 2020 2320 4e6f 204c 616d 6264 6120  ud  # No Lambda 
-0000da90: 436c 6f75 6420 564d 2068 6173 2038 2043  Cloud VM has 8 C
-0000daa0: 5055 730a 6465 6620 7465 7374 5f66 6173  PUs.def test_fas
-0000dab0: 745f 6c61 7267 655f 6a6f 625f 7175 6575  t_large_job_queu
-0000dac0: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-0000dad0: 2073 7472 293a 0a20 2020 2023 2054 6869   str):.    # Thi
-0000dae0: 7320 6973 2074 6f20 7465 7374 2074 6865  s is to test the
-0000daf0: 206a 6f62 7320 6361 6e20 6265 2073 6368   jobs can be sch
-0000db00: 6564 756c 6564 2071 7569 636b 6c79 2077  eduled quickly w
-0000db10: 6865 6e20 7468 6572 6520 6172 6520 6d61  hen there are ma
-0000db20: 6e79 206a 6f62 7320 696e 2074 6865 2071  ny jobs in the q
-0000db30: 7565 7565 2e0a 2020 2020 6e61 6d65 203d  ueue..    name =
-0000db40: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000db50: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000db60: 5465 7374 280a 2020 2020 2020 2020 2766  Test(.        'f
-0000db70: 6173 745f 6c61 7267 655f 6a6f 625f 7175  ast_large_job_qu
-0000db80: 6575 6527 2c0a 2020 2020 2020 2020 5b0a  eue',.        [.
-0000db90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000dba0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0000dbb0: 6e61 6d65 7d20 2d2d 6370 7573 2038 202d  name} --cpus 8 -
-0000dbc0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-0000dbd0: 636c 6f75 647d 272c 0a20 2020 2020 2020  cloud}',.       
-0000dbe0: 2020 2020 2066 2766 6f72 2069 2069 6e20       f'for i in 
-0000dbf0: 6073 6571 2031 2033 3260 3b20 646f 2073  `seq 1 32`; do s
-0000dc00: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-0000dc10: 6e20 7b6e 616d 657d 2d24 6920 2d64 2022  n {name}-$i -d "
-0000dc20: 6563 686f 2024 6922 3b20 646f 6e65 272c  echo $i"; done',
-0000dc30: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0000dc40: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-0000dc50: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000dc60: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-0000dc70: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-0000dc80: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-0000dc90: 2067 7265 7020 2d76 2067 7265 7020 7c20   grep -v grep | 
-0000dca0: 6772 6570 2053 5543 4345 4544 4544 207c  grep SUCCEEDED |
-0000dcb0: 2077 6320 2d6c 207c 2067 7265 7020 3332   wc -l | grep 32
-0000dcc0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0000dcd0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0000dce0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0000dcf0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-0000dd00: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-0000dd10: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000dd20: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0000dd30: 6b2e 6962 6d0a 6465 6620 7465 7374 5f69  k.ibm.def test_i
-0000dd40: 626d 5f6a 6f62 5f71 7565 7565 5f6d 756c  bm_job_queue_mul
-0000dd50: 7469 6e6f 6465 2829 3a0a 2020 2020 6e61  tinode():.    na
-0000dd60: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000dd70: 725f 6e61 6d65 2829 0a20 2020 2074 6173  r_name().    tas
-0000dd80: 6b5f 6669 6c65 203d 2027 6578 616d 706c  k_file = 'exampl
-0000dd90: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
-0000dda0: 5f6d 756c 7469 6e6f 6465 5f69 626d 2e79  _multinode_ibm.y
-0000ddb0: 616d 6c27 0a20 2020 2074 6573 7420 3d20  aml'.    test = 
-0000ddc0: 5465 7374 280a 2020 2020 2020 2020 2769  Test(.        'i
-0000ddd0: 626d 5f6a 6f62 5f71 7565 7565 5f6d 756c  bm_job_queue_mul
-0000dde0: 7469 6e6f 6465 272c 0a20 2020 2020 2020  tinode',.       
-0000ddf0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000de00: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000de10: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-0000de20: 2069 626d 202d 2d67 7075 7320 7631 3030   ibm --gpus v100
-0000de30: 202d 2d6e 756d 2d6e 6f64 6573 2032 272c   --num-nodes 2',
+000028a0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+000028b0: 2023 2043 6865 636b 2074 6865 2063 6c75   # Check the clu
+000028c0: 7374 6572 2069 6e66 6f0a 2020 2020 2020  ster info.      
+000028d0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+000028e0: 207b 6e61 6d65 7d20 5c27 6563 686f 2024   {name} \'echo $
+000028f0: 534b 5950 494c 4f54 5f43 4c55 5354 4552  SKYPILOT_CLUSTER
+00002900: 5f49 4e46 4f20 7c20 6a71 202e 636c 7573  _INFO | jq .clus
+00002910: 7465 725f 6e61 6d65 207c 2067 7265 7020  ter_name | grep 
+00002920: 7b6e 616d 657d 5c27 272c 0a20 2020 2020  {name}\'',.     
+00002930: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00002940: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
+00002950: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00002960: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00002970: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00002980: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00002990: 205c 2765 6368 6f20 2453 4b59 5049 4c4f   \'echo $SKYPILO
+000029a0: 545f 434c 5553 5445 525f 494e 464f 207c  T_CLUSTER_INFO |
+000029b0: 206a 7120 2e63 6c6f 7564 207c 2067 7265   jq .cloud | gre
+000029c0: 7020 2d69 207b 6765 6e65 7269 635f 636c  p -i {generic_cl
+000029d0: 6f75 647d 5c27 272c 0a20 2020 2020 2020  oud}\'',.       
+000029e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000029f0: 7b6e 616d 657d 2034 202d 2d73 7461 7475  {name} 4 --statu
+00002a00: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00002a10: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00002a20: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00002a30: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00002a40: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00002a50: 2020 205f 6765 745f 7469 6d65 6f75 7428     _get_timeout(
+00002a60: 6765 6e65 7269 635f 636c 6f75 6429 2c0a  generic_cloud),.
+00002a70: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00002a80: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+00002a90: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+00002aa0: 2072 6567 696f 6e20 2d2d 2d2d 2d2d 2d2d   region --------
+00002ab0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00002ac0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+00002ad0: 5f72 6567 696f 6e28 293a 0a20 2020 206e  _region():.    n
+00002ae0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00002af0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00002b00: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00002b10: 2020 2027 6177 735f 7265 6769 6f6e 272c     'aws_region',
+00002b20: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00002b30: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00002b40: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00002b50: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
+00002b60: 742d 3220 6578 616d 706c 6573 2f6d 696e  t-2 examples/min
+00002b70: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00002b80: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00002b90: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
+00002ba0: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
+00002bb0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00002bc0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00002bd0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+00002be0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+00002bf0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+00002c00: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
+00002c10: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
+00002c20: 7b6e 616d 657d 207c 2067 7265 7020 7573  {name} | grep us
+00002c30: 2d65 6173 742d 3227 2c20 2023 2045 6e73  -east-2',  # Ens
+00002c40: 7572 6520 7468 6520 7265 6769 6f6e 2069  ure the region i
+00002c50: 7320 636f 7272 6563 742e 0a20 2020 2020  s correct..     
+00002c60: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00002c70: 6320 7b6e 616d 657d 205c 2765 6368 6f20  c {name} \'echo 
+00002c80: 2453 4b59 5049 4c4f 545f 434c 5553 5445  $SKYPILOT_CLUSTE
+00002c90: 525f 494e 464f 207c 206a 7120 2e72 6567  R_INFO | jq .reg
+00002ca0: 696f 6e20 7c20 6772 6570 2075 732d 6561  ion | grep us-ea
+00002cb0: 7374 2d32 5c27 272c 0a20 2020 2020 2020  st-2\'',.       
+00002cc0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00002cd0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+00002ce0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00002cf0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00002d00: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00002d10: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00002d20: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00002d30: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00002d40: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00002d50: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
+00002d60: 6573 745f 6763 705f 7265 6769 6f6e 5f61  est_gcp_region_a
+00002d70: 6e64 5f73 6572 7669 6365 5f61 6363 6f75  nd_service_accou
+00002d80: 6e74 2829 3a0a 2020 2020 6e61 6d65 203d  nt():.    name =
+00002d90: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00002da0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00002db0: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
+00002dc0: 6370 5f72 6567 696f 6e27 2c0a 2020 2020  cp_region',.    
+00002dd0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00002de0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00002df0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 7265  y -c {name} --re
+00002e00: 6769 6f6e 2075 732d 6365 6e74 7261 6c31  gion us-central1
+00002e10: 202d 2d63 6c6f 7564 2067 6370 2074 6573   --cloud gcp tes
+00002e20: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+00002e30: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00002e40: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00002e50: 7865 6320 7b6e 616d 657d 2074 6573 7473  xec {name} tests
+00002e60: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+00002e70: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+00002e80: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00002e90: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00002ea0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00002eb0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00002ec0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00002ed0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00002ee0: 205c 2763 7572 6c20 2d48 2022 4d65 7461   \'curl -H "Meta
+00002ef0: 6461 7461 2d46 6c61 766f 723a 2047 6f6f  data-Flavor: Goo
+00002f00: 676c 6522 2022 6874 7470 3a2f 2f6d 6574  gle" "http://met
+00002f10: 6164 6174 612e 676f 6f67 6c65 2e69 6e74  adata.google.int
+00002f20: 6572 6e61 6c2f 636f 6d70 7574 654d 6574  ernal/computeMet
+00002f30: 6164 6174 612f 7631 2f69 6e73 7461 6e63  adata/v1/instanc
+00002f40: 652f 7365 7276 6963 652d 6163 636f 756e  e/service-accoun
+00002f50: 7473 2f64 6566 6175 6c74 2f69 6465 6e74  ts/default/ident
+00002f60: 6974 793f 666f 726d 6174 3d73 7461 6e64  ity?format=stand
+00002f70: 6172 6426 6175 6469 656e 6365 3d67 6370  ard&audience=gcp
+00002f80: 225c 2727 2c0a 2020 2020 2020 2020 2020  "\'',.          
+00002f90: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00002fa0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+00002fb0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00002fc0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00002fd0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00002fe0: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
+00002ff0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00003000: 7020 7573 2d63 656e 7472 616c 3127 2c20  p us-central1', 
+00003010: 2023 2045 6e73 7572 6520 7468 6520 7265   # Ensure the re
+00003020: 6769 6f6e 2069 7320 636f 7272 6563 742e  gion is correct.
+00003030: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00003040: 6b79 2065 7865 6320 7b6e 616d 657d 205c  ky exec {name} \
+00003050: 2765 6368 6f20 2453 4b59 5049 4c4f 545f  'echo $SKYPILOT_
+00003060: 434c 5553 5445 525f 494e 464f 207c 206a  CLUSTER_INFO | j
+00003070: 7120 2e72 6567 696f 6e20 7c20 6772 6570  q .region | grep
+00003080: 2075 732d 6365 6e74 7261 6c31 5c27 272c   us-central1\'',
+00003090: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000030a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
+000030b0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000030c0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+000030d0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+000030e0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+000030f0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00003100: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00003110: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00003120: 0a0a 4070 7974 6573 742e 6d61 726b 2e69  ..@pytest.mark.i
+00003130: 626d 0a64 6566 2074 6573 745f 6962 6d5f  bm.def test_ibm_
+00003140: 7265 6769 6f6e 2829 3a0a 2020 2020 6e61  region():.    na
+00003150: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00003160: 725f 6e61 6d65 2829 0a20 2020 2072 6567  r_name().    reg
+00003170: 696f 6e20 3d20 2765 752d 6465 270a 2020  ion = 'eu-de'.  
+00003180: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00003190: 2020 2020 2020 2027 7265 6769 6f6e 272c         'region',
+000031a0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+000031b0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+000031c0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+000031d0: 202d 2d63 6c6f 7564 2069 626d 202d 2d72   --cloud ibm --r
+000031e0: 6567 696f 6e20 7b72 6567 696f 6e7d 2065  egion {region} e
+000031f0: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00003200: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00003210: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00003220: 616d 657d 202d 2d63 6c6f 7564 2069 626d  ame} --cloud ibm
+00003230: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
+00003240: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00003250: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00003260: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00003270: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00003280: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00003290: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000032a0: 6b79 2073 7461 7475 7320 2d2d 616c 6c20  ky status --all 
+000032b0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+000032c0: 6772 6570 207b 7265 6769 6f6e 7d27 2c20  grep {region}', 
+000032d0: 2023 2045 6e73 7572 6520 7468 6520 7265   # Ensure the re
+000032e0: 6769 6f6e 2069 7320 636f 7272 6563 742e  gion is correct.
+000032f0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00003300: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00003310: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00003320: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00003330: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00003340: 742e 6d61 726b 2e61 7a75 7265 0a64 6566  t.mark.azure.def
+00003350: 2074 6573 745f 617a 7572 655f 7265 6769   test_azure_regi
+00003360: 6f6e 2829 3a0a 2020 2020 6e61 6d65 203d  on():.    name =
+00003370: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00003380: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00003390: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+000033a0: 7a75 7265 5f72 6567 696f 6e27 2c0a 2020  zure_region',.  
+000033b0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000033c0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000033d0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+000033e0: 7265 6769 6f6e 2065 6173 7475 7332 202d  region eastus2 -
+000033f0: 2d63 6c6f 7564 2061 7a75 7265 2074 6573  -cloud azure tes
+00003400: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+00003410: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00003420: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00003430: 7865 6320 7b6e 616d 657d 2074 6573 7473  xec {name} tests
+00003440: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+00003450: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+00003460: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00003470: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00003480: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00003490: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+000034a0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+000034b0: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
+000034c0: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
+000034d0: 7c20 6772 6570 2065 6173 7475 7332 272c  | grep eastus2',
+000034e0: 2020 2320 456e 7375 7265 2074 6865 2072    # Ensure the r
+000034f0: 6567 696f 6e20 6973 2063 6f72 7265 6374  egion is correct
+00003500: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00003510: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00003520: 5c27 6563 686f 2024 534b 5950 494c 4f54  \'echo $SKYPILOT
+00003530: 5f43 4c55 5354 4552 5f49 4e46 4f20 7c20  _CLUSTER_INFO | 
+00003540: 6a71 202e 7265 6769 6f6e 207c 2067 7265  jq .region | gre
+00003550: 7020 6561 7374 7573 325c 2727 2c0a 2020  p eastus2\'',.  
+00003560: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003570: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
+00003580: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00003590: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+000035a0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+000035b0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+000035c0: 6d65 7d20 5c27 6563 686f 2024 534b 5950  me} \'echo $SKYP
+000035d0: 494c 4f54 5f43 4c55 5354 4552 5f49 4e46  ILOT_CLUSTER_INF
+000035e0: 4f20 7c20 6a71 202e 7a6f 6e65 207c 2067  O | jq .zone | g
+000035f0: 7265 7020 6e75 6c6c 5c27 272c 0a20 2020  rep null\'',.   
+00003600: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00003610: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+00003620: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00003630: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00003640: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
+00003650: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00003660: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00003670: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00003680: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00003690: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7420  ---------- Test 
+000036a0: 7a6f 6e65 202d 2d2d 2d2d 2d2d 2d2d 2d0a  zone ----------.
+000036b0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+000036c0: 0a64 6566 2074 6573 745f 6177 735f 7a6f  .def test_aws_zo
+000036d0: 6e65 2829 3a0a 2020 2020 6e61 6d65 203d  ne():.    name =
+000036e0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+000036f0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00003700: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+00003710: 7773 5f7a 6f6e 6527 2c0a 2020 2020 2020  ws_zone',.      
+00003720: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00003730: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00003740: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
+00003750: 6573 2f6d 696e 696d 616c 2e79 616d 6c20  es/minimal.yaml 
+00003760: 2d2d 7a6f 6e65 2075 732d 6561 7374 2d32  --zone us-east-2
+00003770: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
+00003780: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00003790: 7d20 6578 616d 706c 6573 2f6d 696e 696d  } examples/minim
+000037a0: 616c 2e79 616d 6c20 2d2d 7a6f 6e65 2075  al.yaml --zone u
+000037b0: 732d 6561 7374 2d32 6227 2c0a 2020 2020  s-east-2b',.    
+000037c0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000037d0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+000037e0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+000037f0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00003800: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00003810: 6627 736b 7920 7374 6174 7573 202d 2d61  f'sky status --a
+00003820: 6c6c 207c 2067 7265 7020 7b6e 616d 657d  ll | grep {name}
+00003830: 207c 2067 7265 7020 7573 2d65 6173 742d   | grep us-east-
+00003840: 3262 272c 2020 2320 456e 7375 7265 2074  2b',  # Ensure t
+00003850: 6865 207a 6f6e 6520 6973 2063 6f72 7265  he zone is corre
+00003860: 6374 2e0a 2020 2020 2020 2020 5d2c 0a20  ct..        ],. 
+00003870: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00003880: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00003890: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+000038a0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+000038b0: 7465 7374 2e6d 6172 6b2e 6962 6d0a 6465  test.mark.ibm.de
+000038c0: 6620 7465 7374 5f69 626d 5f7a 6f6e 6528  f test_ibm_zone(
+000038d0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+000038e0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+000038f0: 290a 2020 2020 7a6f 6e65 203d 2027 6575  ).    zone = 'eu
+00003900: 2d64 652d 3227 0a20 2020 2074 6573 7420  -de-2'.    test 
+00003910: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00003920: 277a 6f6e 6527 2c0a 2020 2020 2020 2020  'zone',.        
+00003930: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00003940: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00003950: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00003960: 6962 6d20 6578 616d 706c 6573 2f6d 696e  ibm examples/min
+00003970: 696d 616c 2e79 616d 6c20 2d2d 7a6f 6e65  imal.yaml --zone
+00003980: 207b 7a6f 6e65 7d27 2c0a 2020 2020 2020   {zone}',.      
+00003990: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+000039a0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+000039b0: 6962 6d20 6578 616d 706c 6573 2f6d 696e  ibm examples/min
+000039c0: 696d 616c 2e79 616d 6c20 2d2d 7a6f 6e65  imal.yaml --zone
+000039d0: 207b 7a6f 6e65 7d27 2c0a 2020 2020 2020   {zone}',.      
+000039e0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000039f0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00003a00: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+00003a10: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+00003a20: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00003a30: 736b 7920 7374 6174 7573 202d 2d61 6c6c  sky status --all
+00003a40: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00003a50: 2067 7265 7020 7b7a 6f6e 657d 272c 2020   grep {zone}',  
+00003a60: 2320 456e 7375 7265 2074 6865 207a 6f6e  # Ensure the zon
+00003a70: 6520 6973 2063 6f72 7265 6374 2e0a 2020  e is correct..  
+00003a80: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00003a90: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00003aa0: 6e61 6d65 7d20 7b6e 616d 657d 2d32 207b  name} {name}-2 {
+00003ab0: 6e61 6d65 7d2d 3327 2c0a 2020 2020 290a  name}-3',.    ).
+00003ac0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00003ad0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00003ae0: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
+00003af0: 7374 5f67 6370 5f7a 6f6e 6528 293a 0a20  st_gcp_zone():. 
+00003b00: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00003b10: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00003b20: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00003b30: 2020 2020 2020 2027 6763 705f 7a6f 6e65         'gcp_zone
+00003b40: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00003b50: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00003b60: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00003b70: 657d 202d 2d7a 6f6e 6520 7573 2d63 656e  e} --zone us-cen
+00003b80: 7472 616c 312d 6120 2d2d 636c 6f75 6420  tral1-a --cloud 
+00003b90: 6763 7020 7465 7374 732f 7465 7374 5f79  gcp tests/test_y
+00003ba0: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00003bb0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00003bc0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00003bd0: 7d20 2d2d 7a6f 6e65 2075 732d 6365 6e74  } --zone us-cent
+00003be0: 7261 6c31 2d61 202d 2d63 6c6f 7564 2067  ral1-a --cloud g
+00003bf0: 6370 2074 6573 7473 2f74 6573 745f 7961  cp tests/test_ya
+00003c00: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00003c10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00003c20: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00003c30: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00003c40: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00003c50: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00003c60: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00003c70: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
+00003c80: 207b 6e61 6d65 7d20 7c20 6772 6570 2075   {name} | grep u
+00003c90: 732d 6365 6e74 7261 6c31 2d61 272c 2020  s-central1-a',  
+00003ca0: 2320 456e 7375 7265 2074 6865 207a 6f6e  # Ensure the zon
+00003cb0: 6520 6973 2063 6f72 7265 6374 2e0a 2020  e is correct..  
+00003cc0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00003cd0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00003ce0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00003cf0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00003d00: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00003d10: 2d2d 2d20 5465 7374 2074 6865 2069 6d61  --- Test the ima
+00003d20: 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ge ----------.@p
+00003d30: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
+00003d40: 6566 2074 6573 745f 6177 735f 696d 6167  ef test_aws_imag
+00003d50: 6573 2829 3a0a 2020 2020 6e61 6d65 203d  es():.    name =
+00003d60: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00003d70: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00003d80: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+00003d90: 7773 5f69 6d61 6765 7327 2c0a 2020 2020  ws_images',.    
+00003da0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00003db0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00003dc0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 696d  y -c {name} --im
+00003dd0: 6167 652d 6964 2073 6b79 7069 6c6f 743a  age-id skypilot:
+00003de0: 6770 752d 7562 756e 7475 2d31 3830 3420  gpu-ubuntu-1804 
+00003df0: 6578 616d 706c 6573 2f6d 696e 696d 616c  examples/minimal
+00003e00: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00003e10: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00003e20: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+00003e30: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00003e40: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00003e50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003e60: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+00003e70: 657d 202d 2d69 6d61 6765 2d69 6420 736b  e} --image-id sk
+00003e80: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
+00003e90: 752d 3230 3034 2065 7861 6d70 6c65 732f  u-2004 examples/
+00003ea0: 6d69 6e69 6d61 6c2e 7961 6d6c 2026 2620  minimal.yaml && 
+00003eb0: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
+00003ec0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00003ed0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00003ee0: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+00003ef0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+00003f00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003f10: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+00003f20: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00003f30: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00003f40: 207b 6e61 6d65 7d20 2d2d 7374 6174 7573   {name} --status
+00003f50: 207c 2067 7265 7020 224a 6f62 2032 3a20   | grep "Job 2: 
+00003f60: 5355 4343 4545 4445 4422 272c 2020 2320  SUCCEEDED"',  # 
+00003f70: 4571 7569 7661 6c65 6e74 2e0a 2020 2020  Equivalent..    
+00003f80: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00003f90: 6563 207b 6e61 6d65 7d20 5c27 6563 686f  ec {name} \'echo
+00003fa0: 2024 534b 5950 494c 4f54 5f43 4c55 5354   $SKYPILOT_CLUST
+00003fb0: 4552 5f49 4e46 4f20 7c20 6a71 202e 636c  ER_INFO | jq .cl
+00003fc0: 6f75 6420 7c20 6772 6570 202d 6920 6177  oud | grep -i aw
+00003fd0: 735c 2727 2c0a 2020 2020 2020 2020 2020  s\'',.          
+00003fe0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00003ff0: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
+00004000: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00004010: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00004020: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00004030: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00004040: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00004050: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00004060: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00004070: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
+00004080: 5f67 6370 5f69 6d61 6765 7328 293a 0a20  _gcp_images():. 
+00004090: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+000040a0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+000040b0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000040c0: 2020 2020 2020 2027 6763 705f 696d 6167         'gcp_imag
+000040d0: 6573 272c 0a20 2020 2020 2020 205b 0a20  es',.        [. 
+000040e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000040f0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00004100: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
+00004110: 736b 7970 696c 6f74 3a67 7075 2d64 6562  skypilot:gpu-deb
+00004120: 6961 6e2d 3130 202d 2d63 6c6f 7564 2067  ian-10 --cloud g
+00004130: 6370 2074 6573 7473 2f74 6573 745f 7961  cp tests/test_ya
+00004140: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00004150: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00004160: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00004170: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00004180: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00004190: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+000041a0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+000041b0: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
+000041c0: 696d 6167 652d 6964 2073 6b79 7069 6c6f  image-id skypilo
+000041d0: 743a 6370 752d 6465 6269 616e 2d31 3020  t:cpu-debian-10 
+000041e0: 2d2d 636c 6f75 6420 6763 7020 7465 7374  --cloud gcp test
+000041f0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+00004200: 696d 616c 2e79 616d 6c20 2626 2065 7869  imal.yaml && exi
+00004210: 7420 3120 7c7c 2074 7275 6527 2c0a 2020  t 1 || true',.  
+00004220: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00004230: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00004240: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
+00004250: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00004260: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00004270: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00004280: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00004290: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000042a0: 206c 6f67 7320 7b6e 616d 657d 202d 2d73   logs {name} --s
+000042b0: 7461 7475 7320 7c20 6772 6570 2022 4a6f  tatus | grep "Jo
+000042c0: 6220 323a 2053 5543 4345 4544 4544 2227  b 2: SUCCEEDED"'
+000042d0: 2c20 2023 2045 7175 6976 616c 656e 742e  ,  # Equivalent.
+000042e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000042f0: 6b79 2065 7865 6320 7b6e 616d 657d 205c  ky exec {name} \
+00004300: 2765 6368 6f20 2453 4b59 5049 4c4f 545f  'echo $SKYPILOT_
+00004310: 434c 5553 5445 525f 494e 464f 207c 206a  CLUSTER_INFO | j
+00004320: 7120 2e63 6c6f 7564 207c 2067 7265 7020  q .cloud | grep 
+00004330: 2d69 2067 6370 5c27 272c 0a20 2020 2020  -i gcp\'',.     
+00004340: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00004350: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
+00004360: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00004370: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00004380: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+00004390: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+000043a0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+000043b0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+000043c0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+000043d0: 6573 742e 6d61 726b 2e61 7a75 7265 0a64  est.mark.azure.d
+000043e0: 6566 2074 6573 745f 617a 7572 655f 696d  ef test_azure_im
+000043f0: 6167 6573 2829 3a0a 2020 2020 6e61 6d65  ages():.    name
+00004400: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00004410: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00004420: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00004430: 2761 7a75 7265 5f69 6d61 6765 7327 2c0a  'azure_images',.
+00004440: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00004450: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00004460: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00004470: 2d2d 696d 6167 652d 6964 2073 6b79 7069  --image-id skypi
+00004480: 6c6f 743a 6770 752d 7562 756e 7475 2d32  lot:gpu-ubuntu-2
+00004490: 3230 3420 2d2d 636c 6f75 6420 617a 7572  204 --cloud azur
+000044a0: 6520 7465 7374 732f 7465 7374 5f79 616d  e tests/test_yam
+000044b0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+000044c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000044d0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+000044e0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+000044f0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+00004500: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+00004510: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00004520: 6368 202d 6320 7b6e 616d 657d 202d 2d69  ch -c {name} --i
+00004530: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
+00004540: 3a76 312d 7562 756e 7475 2d32 3030 3420  :v1-ubuntu-2004 
+00004550: 2d2d 636c 6f75 6420 617a 7572 6520 7465  --cloud azure te
+00004560: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+00004570: 696e 696d 616c 2e79 616d 6c20 2626 2065  inimal.yaml && e
+00004580: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
+00004590: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000045a0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+000045b0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+000045c0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+000045d0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000045e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000045f0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+00004600: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004610: 6b79 206c 6f67 7320 7b6e 616d 657d 202d  ky logs {name} -
+00004620: 2d73 7461 7475 7320 7c20 6772 6570 2022  -status | grep "
+00004630: 4a6f 6220 323a 2053 5543 4345 4544 4544  Job 2: SUCCEEDED
+00004640: 2227 2c20 2023 2045 7175 6976 616c 656e  "',  # Equivalen
+00004650: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
+00004660: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00004670: 205c 2765 6368 6f20 2453 4b59 5049 4c4f   \'echo $SKYPILO
+00004680: 545f 434c 5553 5445 525f 494e 464f 207c  T_CLUSTER_INFO |
+00004690: 206a 7120 2e63 6c6f 7564 207c 2067 7265   jq .cloud | gre
+000046a0: 7020 2d69 2061 7a75 7265 5c27 272c 0a20  p -i azure\'',. 
+000046b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000046c0: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
+000046d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000046e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000046f0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+00004700: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00004710: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00004720: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00004730: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00004740: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+00004750: 0a64 6566 2074 6573 745f 6177 735f 696d  .def test_aws_im
+00004760: 6167 655f 6964 5f64 6963 7428 293a 0a20  age_id_dict():. 
+00004770: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00004780: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00004790: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000047a0: 2020 2020 2020 2027 6177 735f 696d 6167         'aws_imag
+000047b0: 655f 6964 5f64 6963 7427 2c0a 2020 2020  e_id_dict',.    
+000047c0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+000047d0: 2020 2320 5573 6520 696d 6167 6520 6964    # Use image id
+000047e0: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
+000047f0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00004800: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
+00004810: 6d70 6c65 732f 7065 725f 7265 6769 6f6e  mples/per_region
+00004820: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
+00004830: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004840: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+00004850: 6d70 6c65 732f 7065 725f 7265 6769 6f6e  mples/per_region
+00004860: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
+00004870: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004880: 2065 7865 6320 7b6e 616d 657d 2022 6c73   exec {name} "ls
+00004890: 207e 2227 2c0a 2020 2020 2020 2020 2020   ~"',.          
+000048a0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000048b0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+000048c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000048d0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+000048e0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+000048f0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00004900: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
+00004910: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+00004920: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00004930: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00004940: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00004950: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00004960: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+00004970: 0a64 6566 2074 6573 745f 6763 705f 696d  .def test_gcp_im
+00004980: 6167 655f 6964 5f64 6963 7428 293a 0a20  age_id_dict():. 
+00004990: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+000049a0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+000049b0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000049c0: 2020 2020 2020 2027 6763 705f 696d 6167         'gcp_imag
+000049d0: 655f 6964 5f64 6963 7427 2c0a 2020 2020  e_id_dict',.    
+000049e0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+000049f0: 2020 2320 5573 6520 696d 6167 6520 6964    # Use image id
+00004a00: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
+00004a10: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00004a20: 2d79 202d 6320 7b6e 616d 657d 2074 6573  -y -c {name} tes
+00004a30: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
+00004a40: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
+00004a50: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00004a60: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00004a70: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
+00004a80: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
+00004a90: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
+00004aa0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00004ab0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00004ac0: 616d 657d 2022 6c73 207e 2227 2c0a 2020  ame} "ls ~"',.  
+00004ad0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00004ae0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00004af0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00004b00: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00004b10: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+00004b20: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00004b30: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00004b40: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
+00004b50: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00004b60: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00004b70: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00004b80: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00004b90: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00004ba0: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+00004bb0: 745f 6177 735f 696d 6167 655f 6964 5f64  t_aws_image_id_d
+00004bc0: 6963 745f 7265 6769 6f6e 2829 3a0a 2020  ict_region():.  
+00004bd0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00004be0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00004bf0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00004c00: 2020 2020 2020 2761 7773 5f69 6d61 6765        'aws_image
+00004c10: 5f69 645f 6469 6374 5f72 6567 696f 6e27  _id_dict_region'
+00004c20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00004c30: 2020 2020 2020 2020 2320 5941 4d4c 2068          # YAML h
+00004c40: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
+00004c50: 2020 2069 6d61 6765 5f69 643a 0a20 2020     image_id:.   
+00004c60: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+00004c70: 2075 732d 7765 7374 2d32 3a20 736b 7970   us-west-2: skyp
+00004c80: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
+00004c90: 3138 3034 0a20 2020 2020 2020 2020 2020  1804.           
+00004ca0: 2023 2020 2020 2020 2075 732d 6561 7374   #       us-east
+00004cb0: 2d32 3a20 736b 7970 696c 6f74 3a67 7075  -2: skypilot:gpu
+00004cc0: 2d75 6275 6e74 752d 3230 3034 0a20 2020  -ubuntu-2004.   
+00004cd0: 2020 2020 2020 2020 2023 2055 7365 2072           # Use r
+00004ce0: 6567 696f 6e20 746f 2066 696c 7465 7220  egion to filter 
+00004cf0: 696d 6167 655f 6964 2064 6963 742e 0a20  image_id dict.. 
+00004d00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004d10: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00004d20: 616d 657d 202d 2d72 6567 696f 6e20 7573  ame} --region us
+00004d30: 2d65 6173 742d 3120 6578 616d 706c 6573  -east-1 examples
+00004d40: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
+00004d50: 6573 2e79 616d 6c20 2626 2065 7869 7420  es.yaml && exit 
+00004d60: 3120 7c7c 2074 7275 6527 2c0a 2020 2020  1 || true',.    
+00004d70: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00004d80: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
+00004d90: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
+00004da0: 7472 7565 272c 2020 2320 456e 7375 7265  true',  # Ensure
+00004db0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+00004dc0: 6e6f 7420 6372 6561 7465 642e 0a20 2020  not created..   
+00004dd0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00004de0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00004df0: 657d 202d 2d72 6567 696f 6e20 7573 2d65  e} --region us-e
+00004e00: 6173 742d 3220 6578 616d 706c 6573 2f70  ast-2 examples/p
+00004e10: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
+00004e20: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00004e30: 2020 2020 2320 5368 6f75 6c64 2073 7563      # Should suc
+00004e40: 6365 7373 2062 6563 6175 7365 2074 6865  cess because the
+00004e50: 2069 6d61 6765 2069 6420 6d61 7463 6820   image id match 
+00004e60: 666f 7220 7468 6520 7265 6769 6f6e 2e0a  for the region..
+00004e70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00004e80: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+00004e90: 657d 202d 2d69 6d61 6765 2d69 6420 736b  e} --image-id sk
+00004ea0: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
+00004eb0: 752d 3230 3034 2065 7861 6d70 6c65 732f  u-2004 examples/
+00004ec0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+00004ed0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004ee0: 2065 7865 6320 7b6e 616d 657d 202d 2d69   exec {name} --i
+00004ef0: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
+00004f00: 3a67 7075 2d75 6275 6e74 752d 3230 3034  :gpu-ubuntu-2004
+00004f10: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
+00004f20: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00004f30: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00004f40: 7b6e 616d 657d 202d 2d69 6d61 6765 2d69  {name} --image-i
+00004f50: 6420 736b 7970 696c 6f74 3a67 7075 2d75  d skypilot:gpu-u
+00004f60: 6275 6e74 752d 3138 3034 2065 7861 6d70  buntu-1804 examp
+00004f70: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
+00004f80: 2026 2620 6578 6974 2031 207c 7c20 7472   && exit 1 || tr
+00004f90: 7565 272c 0a20 2020 2020 2020 2020 2020  ue',.           
+00004fa0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00004fb0: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
+00004fc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00004fd0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+00004fe0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00004ff0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00005000: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
+00005010: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00005020: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
+00005030: 2d61 6c6c 207c 2067 7265 7020 7b6e 616d  -all | grep {nam
+00005040: 657d 207c 2067 7265 7020 7573 2d65 6173  e} | grep us-eas
+00005050: 742d 3227 2c20 2023 2045 6e73 7572 6520  t-2',  # Ensure 
+00005060: 7468 6520 7265 6769 6f6e 2069 7320 636f  the region is co
+00005070: 7272 6563 742e 0a20 2020 2020 2020 2020  rrect..         
+00005080: 2020 2023 2045 6e73 7572 6520 6578 6563     # Ensure exec
+00005090: 2077 6f72 6b73 2e0a 2020 2020 2020 2020   works..        
+000050a0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+000050b0: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2075  name} --region u
+000050c0: 732d 6561 7374 2d32 2065 7861 6d70 6c65  s-east-2 example
+000050d0: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
+000050e0: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+000050f0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00005100: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
+00005110: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
+00005120: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00005130: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00005140: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00005150: 2061 7773 202d 2d72 6567 696f 6e20 7573   aws --region us
+00005160: 2d65 6173 742d 3220 226c 7320 7e22 272c  -east-2 "ls ~"',
+00005170: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005180: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
+00005190: 6c73 207e 2227 2c0a 2020 2020 2020 2020  ls ~"',.        
+000051a0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+000051b0: 6e61 6d65 7d20 3420 2d2d 7374 6174 7573  name} 4 --status
+000051c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000051d0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000051e0: 2035 202d 2d73 7461 7475 7327 2c0a 2020   5 --status',.  
+000051f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005200: 6c6f 6773 207b 6e61 6d65 7d20 3620 2d2d  logs {name} 6 --
+00005210: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00005220: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00005230: 7b6e 616d 657d 2037 202d 2d73 7461 7475  {name} 7 --statu
+00005240: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
+00005250: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00005260: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00005270: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00005280: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00005290: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
+000052a0: 6620 7465 7374 5f67 6370 5f69 6d61 6765  f test_gcp_image
+000052b0: 5f69 645f 6469 6374 5f72 6567 696f 6e28  _id_dict_region(
+000052c0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+000052d0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+000052e0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+000052f0: 7428 0a20 2020 2020 2020 2027 6763 705f  t(.        'gcp_
+00005300: 696d 6167 655f 6964 5f64 6963 745f 7265  image_id_dict_re
+00005310: 6769 6f6e 272c 0a20 2020 2020 2020 205b  gion',.        [
+00005320: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+00005330: 7365 2072 6567 696f 6e20 746f 2066 696c  se region to fil
+00005340: 7465 7220 696d 6167 655f 6964 2064 6963  ter image_id dic
+00005350: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
+00005360: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00005370: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
+00005380: 6e20 7573 2d65 6173 7431 2074 6573 7473  n us-east1 tests
+00005390: 2f74 6573 745f 7961 6d6c 732f 6763 705f  /test_yamls/gcp_
+000053a0: 7065 725f 7265 6769 6f6e 5f69 6d61 6765  per_region_image
+000053b0: 732e 7961 6d6c 2026 2620 6578 6974 2031  s.yaml && exit 1
+000053c0: 207c 7c20 7472 7565 272c 0a20 2020 2020   || true',.     
+000053d0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+000053e0: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
+000053f0: 7d20 2626 2065 7869 7420 3120 7c7c 2074  } && exit 1 || t
+00005400: 7275 6527 2c20 2023 2045 6e73 7572 6520  rue',  # Ensure 
+00005410: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
+00005420: 6f74 2063 7265 6174 6564 2e0a 2020 2020  ot created..    
+00005430: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00005440: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00005450: 7d20 2d2d 7265 6769 6f6e 2075 732d 7765  } --region us-we
+00005460: 7374 3320 7465 7374 732f 7465 7374 5f79  st3 tests/test_y
+00005470: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
+00005480: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
+00005490: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000054a0: 5368 6f75 6c64 2073 7563 6365 7373 2062  Should success b
+000054b0: 6563 6175 7365 2074 6865 2069 6d61 6765  ecause the image
+000054c0: 2069 6420 6d61 7463 6820 666f 7220 7468   id match for th
+000054d0: 6520 7265 6769 6f6e 2e0a 2020 2020 2020  e region..      
+000054e0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+000054f0: 6368 202d 6320 7b6e 616d 657d 202d 2d63  ch -c {name} --c
+00005500: 6c6f 7564 2067 6370 202d 2d69 6d61 6765  loud gcp --image
+00005510: 2d69 6420 7072 6f6a 6563 7473 2f75 6275  -id projects/ubu
+00005520: 6e74 752d 6f73 2d63 6c6f 7564 2f67 6c6f  ntu-os-cloud/glo
+00005530: 6261 6c2f 696d 6167 6573 2f75 6275 6e74  bal/images/ubunt
+00005540: 752d 3138 3034 2d62 696f 6e69 632d 7632  u-1804-bionic-v2
+00005550: 3032 3330 3131 3220 7465 7374 732f 7465  0230112 tests/te
+00005560: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+00005570: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00005580: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00005590: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
+000055a0: 7020 2d2d 696d 6167 652d 6964 2070 726f  p --image-id pro
+000055b0: 6a65 6374 732f 7562 756e 7475 2d6f 732d  jects/ubuntu-os-
+000055c0: 636c 6f75 642f 676c 6f62 616c 2f69 6d61  cloud/global/ima
+000055d0: 6765 732f 7562 756e 7475 2d31 3830 342d  ges/ubuntu-1804-
+000055e0: 6269 6f6e 6963 2d76 3230 3233 3031 3132  bionic-v20230112
+000055f0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00005600: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00005610: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005620: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00005630: 2d63 6c6f 7564 2067 6370 202d 2d69 6d61  -cloud gcp --ima
+00005640: 6765 2d69 6420 736b 7970 696c 6f74 3a63  ge-id skypilot:c
+00005650: 7075 2d64 6562 6961 6e2d 3130 2074 6573  pu-debian-10 tes
+00005660: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+00005670: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
+00005680: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
+00005690: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000056a0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+000056b0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+000056c0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000056d0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+000056e0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+000056f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00005700: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
+00005710: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005720: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
+00005730: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00005740: 7265 7020 7573 2d77 6573 7433 272c 2020  rep us-west3',  
+00005750: 2320 456e 7375 7265 2074 6865 2072 6567  # Ensure the reg
+00005760: 696f 6e20 6973 2063 6f72 7265 6374 2e0a  ion is correct..
+00005770: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00005780: 7375 7265 2065 7865 6320 776f 726b 732e  sure exec works.
+00005790: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000057a0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+000057b0: 2d72 6567 696f 6e20 7573 2d77 6573 7433  -region us-west3
+000057c0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+000057d0: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
+000057e0: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
+000057f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00005800: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
+00005810: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
+00005820: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
+00005830: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00005840: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00005850: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00005860: 2067 6370 202d 2d72 6567 696f 6e20 7573   gcp --region us
+00005870: 2d77 6573 7433 2022 6c73 207e 2227 2c0a  -west3 "ls ~"',.
+00005880: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005890: 7920 6578 6563 207b 6e61 6d65 7d20 226c  y exec {name} "l
+000058a0: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
+000058b0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000058c0: 616d 657d 2034 202d 2d73 7461 7475 7327  ame} 4 --status'
+000058d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000058e0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+000058f0: 3520 2d2d 7374 6174 7573 272c 0a20 2020  5 --status',.   
+00005900: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00005910: 6f67 7320 7b6e 616d 657d 2036 202d 2d73  ogs {name} 6 --s
+00005920: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00005930: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00005940: 6e61 6d65 7d20 3720 2d2d 7374 6174 7573  name} 7 --status
+00005950: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00005960: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00005970: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00005980: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00005990: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+000059a0: 6573 742e 6d61 726b 2e61 7773 0a64 6566  est.mark.aws.def
+000059b0: 2074 6573 745f 6177 735f 696d 6167 655f   test_aws_image_
+000059c0: 6964 5f64 6963 745f 7a6f 6e65 2829 3a0a  id_dict_zone():.
+000059d0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+000059e0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+000059f0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00005a00: 2020 2020 2020 2020 2761 7773 5f69 6d61          'aws_ima
+00005a10: 6765 5f69 645f 6469 6374 5f7a 6f6e 6527  ge_id_dict_zone'
+00005a20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00005a30: 2020 2020 2020 2020 2320 5941 4d4c 2068          # YAML h
+00005a40: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
+00005a50: 2020 2069 6d61 6765 5f69 643a 0a20 2020     image_id:.   
+00005a60: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+00005a70: 2075 732d 7765 7374 2d32 3a20 736b 7970   us-west-2: skyp
+00005a80: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
+00005a90: 3138 3034 0a20 2020 2020 2020 2020 2020  1804.           
+00005aa0: 2023 2020 2020 2020 2075 732d 6561 7374   #       us-east
+00005ab0: 2d32 3a20 736b 7970 696c 6f74 3a67 7075  -2: skypilot:gpu
+00005ac0: 2d75 6275 6e74 752d 3230 3034 0a20 2020  -ubuntu-2004.   
+00005ad0: 2020 2020 2020 2020 2023 2055 7365 207a           # Use z
+00005ae0: 6f6e 6520 746f 2066 696c 7465 7220 696d  one to filter im
+00005af0: 6167 655f 6964 2064 6963 742e 0a20 2020  age_id dict..   
+00005b00: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00005b10: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00005b20: 657d 202d 2d7a 6f6e 6520 7573 2d65 6173  e} --zone us-eas
+00005b30: 742d 3162 2065 7861 6d70 6c65 732f 7065  t-1b examples/pe
+00005b40: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
+00005b50: 7961 6d6c 2026 2620 6578 6974 2031 207c  yaml && exit 1 |
+00005b60: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
+00005b70: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00005b80: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
+00005b90: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
+00005ba0: 6527 2c20 2023 2045 6e73 7572 6520 7468  e',  # Ensure th
+00005bb0: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
+00005bc0: 2063 7265 6174 6564 2e0a 2020 2020 2020   created..      
+00005bd0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00005be0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00005bf0: 2d2d 7a6f 6e65 2075 732d 6561 7374 2d32  --zone us-east-2
+00005c00: 6120 6578 616d 706c 6573 2f70 6572 5f72  a examples/per_r
+00005c10: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
+00005c20: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00005c30: 2320 5368 6f75 6c64 2073 7563 6365 7373  # Should success
+00005c40: 2062 6563 6175 7365 2074 6865 2069 6d61   because the ima
+00005c50: 6765 2069 6420 6d61 7463 6820 666f 7220  ge id match for 
+00005c60: 7468 6520 7a6f 6e65 2e0a 2020 2020 2020  the zone..      
+00005c70: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00005c80: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00005c90: 2d2d 696d 6167 652d 6964 2073 6b79 7069  --image-id skypi
+00005ca0: 6c6f 743a 6770 752d 7562 756e 7475 2d32  lot:gpu-ubuntu-2
+00005cb0: 3030 3420 6578 616d 706c 6573 2f6d 696e  004 examples/min
+00005cc0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00005cd0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00005ce0: 6563 207b 6e61 6d65 7d20 2d2d 696d 6167  ec {name} --imag
+00005cf0: 652d 6964 2073 6b79 7069 6c6f 743a 6770  e-id skypilot:gp
+00005d00: 752d 7562 756e 7475 2d32 3030 3420 6578  u-ubuntu-2004 ex
+00005d10: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
+00005d20: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00005d30: 2020 2320 4661 696c 2064 7565 2074 6f20    # Fail due to 
+00005d40: 696d 6167 6520 6964 206d 6973 6d61 7463  image id mismatc
+00005d50: 682e 0a20 2020 2020 2020 2020 2020 2066  h..            f
+00005d60: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00005d70: 202d 2d69 6d61 6765 2d69 6420 736b 7970   --image-id skyp
+00005d80: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
+00005d90: 3138 3034 2065 7861 6d70 6c65 732f 6d69  1804 examples/mi
+00005da0: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
+00005db0: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
+00005dc0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00005dd0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00005de0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00005df0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00005e00: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+00005e10: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00005e20: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00005e30: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
+00005e40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005e50: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
+00005e60: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00005e70: 7265 7020 7573 2d65 6173 742d 3261 272c  rep us-east-2a',
+00005e80: 2020 2320 456e 7375 7265 2074 6865 207a    # Ensure the z
+00005e90: 6f6e 6520 6973 2063 6f72 7265 6374 2e0a  one is correct..
+00005ea0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00005eb0: 7375 7265 2065 7865 6320 776f 726b 732e  sure exec works.
+00005ec0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005ed0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00005ee0: 2d7a 6f6e 6520 7573 2d65 6173 742d 3261  -zone us-east-2a
+00005ef0: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
+00005f00: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+00005f10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005f20: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00005f30: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
+00005f40: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+00005f50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005f60: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00005f70: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+00005f80: 6567 696f 6e20 7573 2d65 6173 742d 3220  egion us-east-2 
+00005f90: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
+00005fa0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00005fb0: 7b6e 616d 657d 2022 6c73 207e 2227 2c0a  {name} "ls ~"',.
+00005fc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005fd0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3420  y logs {name} 4 
+00005fe0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00005ff0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00006000: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
+00006010: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00006020: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00006030: 6d65 7d20 3620 2d2d 7374 6174 7573 272c  me} 6 --status',
+00006040: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006050: 6b79 206c 6f67 7320 7b6e 616d 657d 2037  ky logs {name} 7
+00006060: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00006070: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00006080: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00006090: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+000060a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000060b0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+000060c0: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
+000060d0: 6370 5f69 6d61 6765 5f69 645f 6469 6374  cp_image_id_dict
+000060e0: 5f7a 6f6e 6528 293a 0a20 2020 206e 616d  _zone():.    nam
+000060f0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00006100: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00006110: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00006120: 2027 6763 705f 696d 6167 655f 6964 5f64   'gcp_image_id_d
+00006130: 6963 745f 7a6f 6e65 272c 0a20 2020 2020  ict_zone',.     
+00006140: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00006150: 2023 2055 7365 207a 6f6e 6520 746f 2066   # Use zone to f
+00006160: 696c 7465 7220 696d 6167 655f 6964 2064  ilter image_id d
+00006170: 6963 742e 0a20 2020 2020 2020 2020 2020  ict..           
+00006180: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00006190: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
+000061a0: 6520 7573 2d65 6173 7431 2d61 2074 6573  e us-east1-a tes
+000061b0: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
+000061c0: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
+000061d0: 6765 732e 7961 6d6c 2026 2620 6578 6974  ges.yaml && exit
+000061e0: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
+000061f0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00006200: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
+00006210: 6d65 7d20 2626 2065 7869 7420 3120 7c7c  me} && exit 1 ||
+00006220: 2074 7275 6527 2c20 2023 2045 6e73 7572   true',  # Ensur
+00006230: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+00006240: 206e 6f74 2063 7265 6174 6564 2e0a 2020   not created..  
+00006250: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00006260: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00006270: 6d65 7d20 2d2d 7a6f 6e65 2075 732d 6365  me} --zone us-ce
+00006280: 6e74 7261 6c31 2d61 2074 6573 7473 2f74  ntral1-a tests/t
+00006290: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
+000062a0: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
+000062b0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000062c0: 2020 2023 2053 686f 756c 6420 7375 6363     # Should succ
+000062d0: 6573 7320 6265 6361 7573 6520 7468 6520  ess because the 
+000062e0: 696d 6167 6520 6964 206d 6174 6368 2066  image id match f
+000062f0: 6f72 2074 6865 207a 6f6e 652e 0a20 2020  or the zone..   
+00006300: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00006310: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00006320: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
+00006330: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
+00006340: 6f74 3a63 7075 2d64 6562 6961 6e2d 3130  ot:cpu-debian-10
+00006350: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00006360: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00006370: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006380: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00006390: 2d63 6c6f 7564 2067 6370 202d 2d69 6d61  -cloud gcp --ima
+000063a0: 6765 2d69 6420 736b 7970 696c 6f74 3a63  ge-id skypilot:c
+000063b0: 7075 2d64 6562 6961 6e2d 3130 2074 6573  pu-debian-10 tes
+000063c0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+000063d0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+000063e0: 2020 2020 2020 2020 2023 2046 6169 6c20           # Fail 
+000063f0: 6475 6520 746f 2069 6d61 6765 2069 6420  due to image id 
+00006400: 6d69 736d 6174 6368 2e0a 2020 2020 2020  mismatch..      
+00006410: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00006420: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00006430: 6763 7020 2d2d 696d 6167 652d 6964 2073  gcp --image-id s
+00006440: 6b79 7069 6c6f 743a 6770 752d 6465 6269  kypilot:gpu-debi
+00006450: 616e 2d31 3020 7465 7374 732f 7465 7374  an-10 tests/test
+00006460: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+00006470: 616d 6c20 2626 2065 7869 7420 3120 7c7c  aml && exit 1 ||
+00006480: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
+00006490: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+000064a0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+000064b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000064c0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000064d0: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
+000064e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000064f0: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
+00006500: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00006510: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00006520: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
+00006530: 6e61 6d65 7d20 7c20 6772 6570 2075 732d  name} | grep us-
+00006540: 6365 6e74 7261 6c31 272c 2020 2320 456e  central1',  # En
+00006550: 7375 7265 2074 6865 207a 6f6e 6520 6973  sure the zone is
+00006560: 2063 6f72 7265 6374 2e0a 2020 2020 2020   correct..      
+00006570: 2020 2020 2020 2320 456e 7375 7265 2065        # Ensure e
+00006580: 7865 6320 776f 726b 732e 0a20 2020 2020  xec works..     
+00006590: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+000065a0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+000065b0: 2067 6370 202d 2d7a 6f6e 6520 7573 2d63   gcp --zone us-c
+000065c0: 656e 7472 616c 312d 6120 7465 7374 732f  entral1-a tests/
+000065d0: 7465 7374 5f79 616d 6c73 2f67 6370 5f70  test_yamls/gcp_p
+000065e0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
+000065f0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00006600: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00006610: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+00006620: 5f79 616d 6c73 2f67 6370 5f70 6572 5f72  _yamls/gcp_per_r
+00006630: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
+00006640: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00006650: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00006660: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
+00006670: 7265 6769 6f6e 2075 732d 6365 6e74 7261  region us-centra
+00006680: 6c31 2022 6c73 207e 2227 2c0a 2020 2020  l1 "ls ~"',.    
+00006690: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000066a0: 6563 207b 6e61 6d65 7d20 226c 7320 7e22  ec {name} "ls ~"
+000066b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000066c0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000066d0: 2034 202d 2d73 7461 7475 7327 2c0a 2020   4 --status',.  
+000066e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000066f0: 6c6f 6773 207b 6e61 6d65 7d20 3520 2d2d  logs {name} 5 --
+00006700: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00006710: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00006720: 7b6e 616d 657d 2036 202d 2d73 7461 7475  {name} 6 --statu
+00006730: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00006740: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00006750: 7d20 3720 2d2d 7374 6174 7573 272c 0a20  } 7 --status',. 
+00006760: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00006770: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00006780: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00006790: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000067a0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+000067b0: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+000067c0: 745f 636c 6f6e 655f 6469 736b 5f61 7773  t_clone_disk_aws
+000067d0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+000067e0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+000067f0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00006800: 7374 280a 2020 2020 2020 2020 2763 6c6f  st(.        'clo
+00006810: 6e65 5f64 6973 6b5f 6177 7327 2c0a 2020  ne_disk_aws',.  
+00006820: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00006830: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00006840: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00006850: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+00006860: 6f6e 2075 732d 6561 7374 2d32 202d 2d72  on us-east-2 --r
+00006870: 6574 7279 2d75 6e74 696c 2d75 7020 2265  etry-until-up "e
+00006880: 6368 6f20 6865 6c6c 6f20 3e20 7e2f 7573  cho hello > ~/us
+00006890: 6572 5f66 696c 652e 7478 7422 272c 0a20  er_file.txt"',. 
+000068a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000068b0: 206c 6175 6e63 6820 2d2d 636c 6f6e 652d   launch --clone-
+000068c0: 6469 736b 2d66 726f 6d20 7b6e 616d 657d  disk-from {name}
+000068d0: 202d 7920 2d63 207b 6e61 6d65 7d2d 636c   -y -c {name}-cl
+000068e0: 6f6e 6520 2626 2065 7869 7420 3120 7c7c  one && exit 1 ||
+000068f0: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
+00006900: 2020 2020 6627 736b 7920 7374 6f70 207b      f'sky stop {
+00006910: 6e61 6d65 7d20 2d79 272c 0a20 2020 2020  name} -y',.     
+00006920: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
+00006930: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00006940: 2773 6b79 206c 6175 6e63 6820 2d2d 636c  'sky launch --cl
+00006950: 6f6e 652d 6469 736b 2d66 726f 6d20 7b6e  one-disk-from {n
+00006960: 616d 657d 202d 7920 2d63 207b 6e61 6d65  ame} -y -c {name
+00006970: 7d2d 636c 6f6e 6520 2d2d 636c 6f75 6420  }-clone --cloud 
+00006980: 6177 7320 2d64 202d 2d72 6567 696f 6e20  aws -d --region 
+00006990: 7573 2d65 6173 742d 3220 2263 6174 207e  us-east-2 "cat ~
+000069a0: 2f75 7365 725f 6669 6c65 2e74 7874 207c  /user_file.txt |
+000069b0: 2067 7265 7020 6865 6c6c 6f22 272c 0a20   grep hello"',. 
+000069c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000069d0: 206c 6175 6e63 6820 2d2d 636c 6f6e 652d   launch --clone-
+000069e0: 6469 736b 2d66 726f 6d20 7b6e 616d 657d  disk-from {name}
+000069f0: 202d 7920 2d63 207b 6e61 6d65 7d2d 636c   -y -c {name}-cl
+00006a00: 6f6e 652d 3220 2d2d 636c 6f75 6420 6177  one-2 --cloud aw
+00006a10: 7320 2d64 202d 2d72 6567 696f 6e20 7573  s -d --region us
+00006a20: 2d65 6173 742d 3220 2263 6174 207e 2f75  -east-2 "cat ~/u
+00006a30: 7365 725f 6669 6c65 2e74 7874 207c 2067  ser_file.txt | g
+00006a40: 7265 7020 6865 6c6c 6f22 272c 0a20 2020  rep hello"',.   
+00006a50: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00006a60: 6f67 7320 7b6e 616d 657d 2d63 6c6f 6e65  ogs {name}-clone
+00006a70: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
+00006a80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00006a90: 6c6f 6773 207b 6e61 6d65 7d2d 636c 6f6e  logs {name}-clon
+00006aa0: 652d 3220 3120 2d2d 7374 6174 7573 272c  e-2 1 --status',
+00006ab0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00006ac0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00006ad0: 7920 7b6e 616d 657d 207b 6e61 6d65 7d2d  y {name} {name}-
+00006ae0: 636c 6f6e 6520 7b6e 616d 657d 2d63 6c6f  clone {name}-clo
+00006af0: 6e65 2d32 272c 0a20 2020 2020 2020 2074  ne-2',.        t
+00006b00: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
+00006b10: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00006b20: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00006b30: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00006b40: 6465 6620 7465 7374 5f63 6c6f 6e65 5f64  def test_clone_d
+00006b50: 6973 6b5f 6763 7028 293a 0a20 2020 206e  isk_gcp():.    n
+00006b60: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00006b70: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00006b80: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00006b90: 2020 2027 636c 6f6e 655f 6469 736b 5f67     'clone_disk_g
+00006ba0: 6370 272c 0a20 2020 2020 2020 205b 0a20  cp',.        [. 
+00006bb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00006bc0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00006bd0: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
+00006be0: 202d 2d7a 6f6e 6520 7573 2d65 6173 7431   --zone us-east1
+00006bf0: 2d62 202d 2d72 6574 7279 2d75 6e74 696c  -b --retry-until
+00006c00: 2d75 7020 2265 6368 6f20 6865 6c6c 6f20  -up "echo hello 
+00006c10: 3e20 7e2f 7573 6572 5f66 696c 652e 7478  > ~/user_file.tx
+00006c20: 7422 272c 0a20 2020 2020 2020 2020 2020  t"',.           
+00006c30: 2066 2773 6b79 206c 6175 6e63 6820 2d2d   f'sky launch --
+00006c40: 636c 6f6e 652d 6469 736b 2d66 726f 6d20  clone-disk-from 
+00006c50: 7b6e 616d 657d 202d 7920 2d63 207b 6e61  {name} -y -c {na
+00006c60: 6d65 7d2d 636c 6f6e 6520 2626 2065 7869  me}-clone && exi
+00006c70: 7420 3120 7c7c 2074 7275 6527 2c0a 2020  t 1 || true',.  
+00006c80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00006c90: 7374 6f70 207b 6e61 6d65 7d20 2d79 272c  stop {name} -y',
+00006ca0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006cb0: 6b79 206c 6175 6e63 6820 2d2d 636c 6f6e  ky launch --clon
+00006cc0: 652d 6469 736b 2d66 726f 6d20 7b6e 616d  e-disk-from {nam
+00006cd0: 657d 202d 7920 2d63 207b 6e61 6d65 7d2d  e} -y -c {name}-
+00006ce0: 636c 6f6e 6520 2d2d 636c 6f75 6420 6763  clone --cloud gc
+00006cf0: 7020 2d2d 7a6f 6e65 2075 732d 6365 6e74  p --zone us-cent
+00006d00: 7261 6c31 2d61 2022 6361 7420 7e2f 7573  ral1-a "cat ~/us
+00006d10: 6572 5f66 696c 652e 7478 7420 7c20 6772  er_file.txt | gr
+00006d20: 6570 2068 656c 6c6f 2227 2c0a 2020 2020  ep hello"',.    
+00006d30: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00006d40: 756e 6368 202d 2d63 6c6f 6e65 2d64 6973  unch --clone-dis
+00006d50: 6b2d 6672 6f6d 207b 6e61 6d65 7d20 2d79  k-from {name} -y
+00006d60: 202d 6320 7b6e 616d 657d 2d63 6c6f 6e65   -c {name}-clone
+00006d70: 2d32 202d 2d63 6c6f 7564 2067 6370 202d  -2 --cloud gcp -
+00006d80: 2d7a 6f6e 6520 7573 2d65 6173 7431 2d62  -zone us-east1-b
+00006d90: 2022 6361 7420 7e2f 7573 6572 5f66 696c   "cat ~/user_fil
+00006da0: 652e 7478 7420 7c20 6772 6570 2068 656c  e.txt | grep hel
+00006db0: 6c6f 2227 2c0a 2020 2020 2020 2020 2020  lo"',.          
+00006dc0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00006dd0: 6d65 7d2d 636c 6f6e 6520 3120 2d2d 7374  me}-clone 1 --st
+00006de0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00006df0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00006e00: 616d 657d 2d63 6c6f 6e65 2d32 2031 202d  ame}-clone-2 1 -
+00006e10: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00006e20: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00006e30: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00006e40: 7d20 7b6e 616d 657d 2d63 6c6f 6e65 207b  } {name}-clone {
+00006e50: 6e61 6d65 7d2d 636c 6f6e 652d 3227 2c0a  name}-clone-2',.
+00006e60: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00006e70: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00006e80: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
+00006e90: 6465 6620 7465 7374 5f69 6d61 6765 5f6e  def test_image_n
+00006ea0: 6f5f 636f 6e64 6128 293a 0a20 2020 206e  o_conda():.    n
+00006eb0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00006ec0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00006ed0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00006ee0: 2020 2027 696d 6167 655f 6e6f 5f63 6f6e     'image_no_con
+00006ef0: 6461 272c 0a20 2020 2020 2020 205b 0a20  da',.        [. 
+00006f00: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
+00006f10: 2069 6d61 6765 2069 6420 6469 6374 2e0a   image id dict..
+00006f20: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006f30: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00006f40: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2075  name} --region u
+00006f50: 732d 6561 7374 2d32 2065 7861 6d70 6c65  s-east-2 example
+00006f60: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
+00006f70: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00006f80: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00006f90: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00006fa0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00006fb0: 2020 6627 736b 7920 7374 6f70 207b 6e61    f'sky stop {na
+00006fc0: 6d65 7d20 2d79 272c 0a20 2020 2020 2020  me} -y',.       
+00006fd0: 2020 2020 2066 2773 6b79 2073 7461 7274       f'sky start
+00006fe0: 207b 6e61 6d65 7d20 2d79 272c 0a20 2020   {name} -y',.   
+00006ff0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00007000: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
+00007010: 6c65 732f 7065 725f 7265 6769 6f6e 5f69  les/per_region_i
+00007020: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
+00007030: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00007040: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+00007050: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00007060: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00007070: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00007080: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00007090: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+000070a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+000070b0: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
+000070c0: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
+000070d0: 6f74 2073 7570 706f 7274 2073 746f 7070  ot support stopp
+000070e0: 696e 6720 696e 7374 616e 6365 730a 6465  ing instances.de
+000070f0: 6620 7465 7374 5f63 7573 746f 6d5f 6465  f test_custom_de
+00007100: 6661 756c 745f 636f 6e64 615f 656e 7628  fault_conda_env(
+00007110: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+00007120: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
+00007130: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00007140: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00007150: 6573 7428 2763 7573 746f 6d5f 6465 6661  est('custom_defa
+00007160: 756c 745f 636f 6e64 615f 656e 7627 2c20  ult_conda_env', 
+00007170: 5b0a 2020 2020 2020 2020 6627 736b 7920  [.        f'sky 
+00007180: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+00007190: 202d 7920 2d2d 636c 6f75 6420 7b67 656e   -y --cloud {gen
+000071a0: 6572 6963 5f63 6c6f 7564 7d20 7465 7374  eric_cloud} test
+000071b0: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
+000071c0: 745f 6375 7374 6f6d 5f64 6566 6175 6c74  t_custom_default
+000071d0: 5f63 6f6e 6461 5f65 6e76 2e79 616d 6c27  _conda_env.yaml'
+000071e0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+000071f0: 7374 6174 7573 202d 7220 7b6e 616d 657d  status -r {name}
+00007200: 207c 2067 7265 7020 2255 5022 272c 0a20   | grep "UP"',. 
+00007210: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00007220: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00007230: 7475 7327 2c0a 2020 2020 2020 2020 6627  tus',.        f'
+00007240: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00007250: 3120 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  1 --no-follow | 
+00007260: 6772 6570 202d 5020 226d 7965 6e76 5c5c  grep -P "myenv\\
+00007270: 732b 5c5c 2a22 272c 0a20 2020 2020 2020  s+\\*"',.       
+00007280: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00007290: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+000072a0: 6d6c 732f 7465 7374 5f63 7573 746f 6d5f  mls/test_custom_
+000072b0: 6465 6661 756c 745f 636f 6e64 615f 656e  default_conda_en
+000072c0: 762e 7961 6d6c 272c 0a20 2020 2020 2020  v.yaml',.       
+000072d0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000072e0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
+000072f0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
+00007300: 746f 7374 6f70 202d 7920 2d69 2030 207b  tostop -y -i 0 {
+00007310: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+00007320: 2773 6c65 6570 2036 3027 2c0a 2020 2020  'sleep 60',.    
+00007330: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+00007340: 202d 7220 7b6e 616d 657d 207c 2067 7265   -r {name} | gre
+00007350: 7020 2253 544f 5050 4544 2227 2c0a 2020  p "STOPPED"',.  
+00007360: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
+00007370: 7420 2d79 207b 6e61 6d65 7d27 2c0a 2020  t -y {name}',.  
+00007380: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00007390: 207b 6e61 6d65 7d20 3220 2d2d 6e6f 2d66   {name} 2 --no-f
+000073a0: 6f6c 6c6f 7720 7c20 6772 6570 202d 5020  ollow | grep -P 
+000073b0: 226d 7965 6e76 5c5c 732b 5c5c 2a22 272c  "myenv\\s+\\*"',
+000073c0: 0a20 2020 2020 2020 2066 2773 6b79 2065  .        f'sky e
+000073d0: 7865 6320 7b6e 616d 657d 2074 6573 7473  xec {name} tests
+000073e0: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
+000073f0: 5f63 7573 746f 6d5f 6465 6661 756c 745f  _custom_default_
+00007400: 636f 6e64 615f 656e 762e 7961 6d6c 272c  conda_env.yaml',
+00007410: 0a20 2020 2020 2020 2066 2773 6b79 206c  .        f'sky l
+00007420: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+00007430: 7461 7475 7327 2c0a 2020 2020 5d2c 2066  tatus',.    ], f
+00007440: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00007450: 6d65 7d27 290a 2020 2020 7275 6e5f 6f6e  me}').    run_on
+00007460: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+00007470: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d20 5465   ------------ Te
+00007480: 7374 2073 7461 6c65 206a 6f62 202d 2d2d  st stale job ---
+00007490: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+000074a0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+000074b0: 7461 636b 2020 2320 466c 7569 6453 7461  tack  # FluidSta
+000074c0: 636b 2064 6f65 7320 6e6f 7420 7375 7070  ck does not supp
+000074d0: 6f72 7420 7374 6f70 7069 6e67 2069 6e73  ort stopping ins
+000074e0: 7461 6e63 6573 2069 6e20 536b 7950 696c  tances in SkyPil
+000074f0: 6f74 2069 6d70 6c65 6d65 6e74 6174 696f  ot implementatio
+00007500: 6e0a 4070 7974 6573 742e 6d61 726b 2e6e  n.@pytest.mark.n
+00007510: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
+00007520: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
+00007530: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00007540: 7374 6f70 7069 6e67 2069 6e73 7461 6e63  stopping instanc
+00007550: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00007560: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
+00007570: 204b 7562 6572 6e65 7465 7320 646f 6573   Kubernetes does
+00007580: 206e 6f74 2073 7570 706f 7274 2073 746f   not support sto
+00007590: 7070 696e 6720 696e 7374 616e 6365 730a  pping instances.
+000075a0: 6465 6620 7465 7374 5f73 7461 6c65 5f6a  def test_stale_j
+000075b0: 6f62 2867 656e 6572 6963 5f63 6c6f 7564  ob(generic_cloud
+000075c0: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+000075d0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000075e0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000075f0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00007600: 2773 7461 6c65 5f6a 6f62 272c 0a20 2020  'stale_job',.   
+00007610: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00007620: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00007630: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00007640: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00007650: 6f75 647d 2022 6563 686f 2068 6922 272c  oud} "echo hi"',
+00007660: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00007670: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00007680: 6420 2265 6368 6f20 7374 6172 743b 2073  d "echo start; s
+00007690: 6c65 6570 2031 3030 3030 2227 2c0a 2020  leep 10000"',.  
+000076a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000076b0: 7374 6f70 207b 6e61 6d65 7d20 2d79 272c  stop {name} -y',
+000076c0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000076d0: 6565 7020 3130 3027 2c20 2023 2045 6e73  eep 100',  # Ens
+000076e0: 7572 6520 7468 6973 2069 7320 6c61 7267  ure this is larg
+000076f0: 6520 656e 6f75 6768 2c20 656c 7365 2047  e enough, else G
+00007700: 4350 206c 6561 6b73 2e0a 2020 2020 2020  CP leaks..      
+00007710: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
+00007720: 7420 7b6e 616d 657d 202d 7927 2c0a 2020  t {name} -y',.  
+00007730: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00007740: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00007750: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00007760: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+00007770: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
+00007780: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+00007790: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+000077a0: 2067 7265 7020 4641 494c 4544 272c 0a20   grep FAILED',. 
+000077b0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000077c0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+000077d0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+000077e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000077f0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00007800: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+00007810: 745f 6177 735f 7374 616c 655f 6a6f 625f  t_aws_stale_job_
+00007820: 6d61 6e75 616c 5f72 6573 7461 7274 2829  manual_restart()
+00007830: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00007840: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00007850: 0a20 2020 206e 616d 655f 6f6e 5f63 6c6f  .    name_on_clo
+00007860: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
+00007870: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
+00007880: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
+00007890: 2020 2020 2020 6e61 6d65 2c20 736b 792e        name, sky.
+000078a0: 4157 532e 6d61 785f 636c 7573 7465 725f  AWS.max_cluster_
+000078b0: 6e61 6d65 5f6c 656e 6774 6828 2929 0a20  name_length()). 
+000078c0: 2020 2072 6567 696f 6e20 3d20 2775 732d     region = 'us-
+000078d0: 6561 7374 2d32 270a 2020 2020 7465 7374  east-2'.    test
+000078e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+000078f0: 2027 6177 735f 7374 616c 655f 6a6f 625f   'aws_stale_job_
+00007900: 6d61 6e75 616c 5f72 6573 7461 7274 272c  manual_restart',
+00007910: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00007920: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00007930: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00007940: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+00007950: 6567 696f 6e20 7b72 6567 696f 6e7d 2022  egion {region} "
+00007960: 6563 686f 2068 6922 272c 0a20 2020 2020  echo hi"',.     
+00007970: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00007980: 6320 7b6e 616d 657d 202d 6420 2265 6368  c {name} -d "ech
+00007990: 6f20 7374 6172 743b 2073 6c65 6570 2031  o start; sleep 1
+000079a0: 3030 3030 2227 2c0a 2020 2020 2020 2020  0000"',.        
+000079b0: 2020 2020 2320 5374 6f70 2074 6865 2063      # Stop the c
+000079c0: 6c75 7374 6572 206d 616e 7561 6c6c 792e  luster manually.
+000079d0: 0a20 2020 2020 2020 2020 2020 2066 2769  .            f'i
+000079e0: 643d 6061 7773 2065 6332 2064 6573 6372  d=`aws ec2 descr
+000079f0: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
+00007a00: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+00007a10: 2d2d 6669 6c74 6572 7320 270a 2020 2020  --filters '.    
+00007a20: 2020 2020 2020 2020 6627 4e61 6d65 3d74          f'Name=t
+00007a30: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
+00007a40: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
+00007a50: 5f6f 6e5f 636c 6f75 647d 2027 0a20 2020  _on_cloud} '.   
+00007a60: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
+00007a70: 7279 2052 6573 6572 7661 7469 6f6e 735b  ry Reservations[
+00007a80: 5d2e 496e 7374 616e 6365 735b 5d2e 496e  ].Instances[].In
+00007a90: 7374 616e 6365 4964 2027 0a20 2020 2020  stanceId '.     
+00007aa0: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
+00007ab0: 2074 6578 7460 3b20 270a 2020 2020 2020   text`; '.      
+00007ac0: 2020 2020 2020 6627 6177 7320 6563 3220        f'aws ec2 
+00007ad0: 7374 6f70 2d69 6e73 7461 6e63 6573 202d  stop-instances -
+00007ae0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+00007af0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00007b00: 2d2d 696e 7374 616e 6365 2d69 6473 2024  --instance-ids $
+00007b10: 6964 272c 0a20 2020 2020 2020 2020 2020  id',.           
+00007b20: 2027 736c 6565 7020 3430 272c 0a20 2020   'sleep 40',.   
+00007b30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00007b40: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+00007b50: 2d79 2022 6563 686f 2068 6922 272c 0a20  -y "echo hi"',. 
+00007b60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00007b70: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00007b80: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00007b90: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00007ba0: 207b 6e61 6d65 7d20 3320 2d2d 7374 6174   {name} 3 --stat
+00007bb0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00007bc0: 2023 2045 6e73 7572 6520 7468 6520 736b   # Ensure the sk
+00007bd0: 796c 6574 2075 7064 6174 6564 2074 6865  ylet updated the
+00007be0: 2073 7461 6c65 206a 6f62 2073 7461 7475   stale job statu
+00007bf0: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
+00007c00: 2773 6c65 6570 207b 6576 656e 7473 2e4a  'sleep {events.J
+00007c10: 6f62 5363 6865 6475 6c65 7245 7665 6e74  obSchedulerEvent
+00007c20: 2e45 5645 4e54 5f49 4e54 4552 5641 4c5f  .EVENT_INTERVAL_
+00007c30: 5345 434f 4e44 537d 272c 0a20 2020 2020  SECONDS}',.     
+00007c40: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00007c50: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+00007c60: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+00007c70: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+00007c80: 207c 2067 7265 7020 4641 494c 4544 272c   | grep FAILED',
+00007c90: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00007ca0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00007cb0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00007cc0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00007cd0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00007ce0: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
+00007cf0: 6573 745f 6763 705f 7374 616c 655f 6a6f  est_gcp_stale_jo
+00007d00: 625f 6d61 6e75 616c 5f72 6573 7461 7274  b_manual_restart
+00007d10: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+00007d20: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00007d30: 2829 0a20 2020 206e 616d 655f 6f6e 5f63  ().    name_on_c
+00007d40: 6c6f 7564 203d 2063 6f6d 6d6f 6e5f 7574  loud = common_ut
+00007d50: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
+00007d60: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 280a  _name_on_cloud(.
+00007d70: 2020 2020 2020 2020 6e61 6d65 2c20 736b          name, sk
+00007d80: 792e 4743 502e 6d61 785f 636c 7573 7465  y.GCP.max_cluste
+00007d90: 725f 6e61 6d65 5f6c 656e 6774 6828 2929  r_name_length())
+00007da0: 0a20 2020 207a 6f6e 6520 3d20 2775 732d  .    zone = 'us-
+00007db0: 7765 7374 322d 6127 0a20 2020 2071 7565  west2-a'.    que
+00007dc0: 7279 5f63 6d64 203d 2028 6627 6763 6c6f  ry_cmd = (f'gclo
+00007dd0: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
+00007de0: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
+00007df0: 6572 3d27 0a20 2020 2020 2020 2020 2020  er='.           
+00007e00: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
+00007e10: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+00007e20: 653d 7b6e 616d 655f 6f6e 5f63 6c6f 7564  e={name_on_cloud
+00007e30: 7d29 2220 270a 2020 2020 2020 2020 2020  })" '.          
+00007e40: 2020 2020 2020 2066 272d 2d7a 6f6e 6573         f'--zones
+00007e50: 3d7b 7a6f 6e65 7d20 2d2d 666f 726d 6174  ={zone} --format
+00007e60: 3d22 7661 6c75 6528 6e61 6d65 2922 2729  ="value(name)"')
+00007e70: 0a20 2020 2073 746f 705f 636d 6420 3d20  .    stop_cmd = 
+00007e80: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
+00007e90: 6520 696e 7374 616e 6365 7320 7374 6f70  e instances stop
+00007ea0: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
+00007eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ec0: 6627 202d 2d71 7569 6574 2024 287b 7175  f' --quiet $({qu
+00007ed0: 6572 795f 636d 647d 2927 290a 2020 2020  ery_cmd})').    
+00007ee0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00007ef0: 2020 2020 2027 6763 705f 7374 616c 655f       'gcp_stale_
+00007f00: 6a6f 625f 6d61 6e75 616c 5f72 6573 7461  job_manual_resta
+00007f10: 7274 272c 0a20 2020 2020 2020 205b 0a20  rt',.        [. 
+00007f20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00007f30: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00007f40: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
+00007f50: 202d 2d7a 6f6e 6520 7b7a 6f6e 657d 2022   --zone {zone} "
+00007f60: 6563 686f 2068 6922 272c 0a20 2020 2020  echo hi"',.     
+00007f70: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00007f80: 6320 7b6e 616d 657d 202d 6420 2265 6368  c {name} -d "ech
+00007f90: 6f20 7374 6172 743b 2073 6c65 6570 2031  o start; sleep 1
+00007fa0: 3030 3030 2227 2c0a 2020 2020 2020 2020  0000"',.        
+00007fb0: 2020 2020 2320 5374 6f70 2074 6865 2063      # Stop the c
+00007fc0: 6c75 7374 6572 206d 616e 7561 6c6c 792e  luster manually.
+00007fd0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+00007fe0: 705f 636d 642c 0a20 2020 2020 2020 2020  p_cmd,.         
+00007ff0: 2020 2027 736c 6565 7020 3430 272c 0a20     'sleep 40',. 
+00008000: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00008010: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
+00008020: 7d20 2d79 2022 6563 686f 2068 6922 272c  } -y "echo hi"',
+00008030: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008040: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00008050: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00008060: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00008070: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
+00008080: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00008090: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
+000080a0: 736b 796c 6574 2075 7064 6174 6564 2074  skylet updated t
+000080b0: 6865 2073 7461 6c65 206a 6f62 2073 7461  he stale job sta
+000080c0: 7475 732e 0a20 2020 2020 2020 2020 2020  tus..           
+000080d0: 2066 2773 6c65 6570 207b 6576 656e 7473   f'sleep {events
+000080e0: 2e4a 6f62 5363 6865 6475 6c65 7245 7665  .JobSchedulerEve
+000080f0: 6e74 2e45 5645 4e54 5f49 4e54 4552 5641  nt.EVENT_INTERVA
+00008100: 4c5f 5345 434f 4e44 537d 272c 0a20 2020  L_SECONDS}',.   
+00008110: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+00008120: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
+00008130: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+00008140: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+00008150: 7322 207c 2067 7265 7020 4641 494c 4544  s" | grep FAILED
+00008160: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00008170: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00008180: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00008190: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+000081a0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+000081b0: 2d2d 2d2d 2d2d 2d2d 2043 6865 636b 2053  -------- Check S
+000081c0: 6b79 2773 2065 6e76 6972 6f6e 6d65 6e74  ky's environment
+000081d0: 2076 6172 6961 626c 6573 3b20 776f 726b   variables; work
+000081e0: 6469 722e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  dir. ----------.
+000081f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00008200: 666c 7569 6473 7461 636b 2020 2320 5265  fluidstack  # Re
+00008210: 7175 6972 6573 2061 6d61 7a6f 6e20 5333  quires amazon S3
+00008220: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00008230: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+00008240: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
+00008250: 5f6e 6f64 6573 203e 2031 2079 6574 0a64  _nodes > 1 yet.d
+00008260: 6566 2074 6573 745f 656e 765f 6368 6563  ef test_env_chec
+00008270: 6b28 6765 6e65 7269 635f 636c 6f75 643a  k(generic_cloud:
+00008280: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
+00008290: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+000082a0: 616d 6528 290a 2020 2020 746f 7461 6c5f  ame().    total_
+000082b0: 7469 6d65 6f75 745f 6d69 6e75 7465 7320  timeout_minutes 
+000082c0: 3d20 3235 2069 6620 6765 6e65 7269 635f  = 25 if generic_
+000082d0: 636c 6f75 6420 3d3d 2027 617a 7572 6527  cloud == 'azure'
+000082e0: 2065 6c73 6520 3135 0a20 2020 2074 6573   else 15.    tes
+000082f0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00008300: 2020 2765 6e76 5f63 6865 636b 272c 0a20    'env_check',. 
+00008310: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00008320: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00008330: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+00008340: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00008350: 636c 6f75 647d 202d 2d64 6574 6163 682d  cloud} --detach-
+00008360: 7365 7475 7020 6578 616d 706c 6573 2f65  setup examples/e
+00008370: 6e76 5f63 6865 636b 2e79 616d 6c27 2c0a  nv_check.yaml',.
+00008380: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008390: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+000083a0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+000083b0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+000083c0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+000083d0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+000083e0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000083f0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00008400: 743d 746f 7461 6c5f 7469 6d65 6f75 745f  t=total_timeout_
+00008410: 6d69 6e75 7465 7320 2a20 3630 2c0a 2020  minutes * 60,.  
+00008420: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00008430: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+00008440: 2d2d 2d2d 2d2d 2d2d 2d20 6669 6c65 5f6d  --------- file_m
+00008450: 6f75 6e74 7320 2d2d 2d2d 2d2d 2d2d 2d2d  ounts ----------
+00008460: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00008470: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+00008480: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
+00008490: 5f6e 6f64 6573 203e 2031 2079 6574 2e20  _nodes > 1 yet. 
+000084a0: 5275 6e20 7465 7374 5f73 6370 5f66 696c  Run test_scp_fil
+000084b0: 655f 6d6f 756e 7473 2069 6e73 7465 6164  e_mounts instead
+000084c0: 2e0a 6465 6620 7465 7374 5f66 696c 655f  ..def test_file_
+000084d0: 6d6f 756e 7473 2867 656e 6572 6963 5f63  mounts(generic_c
+000084e0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+000084f0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00008500: 7465 725f 6e61 6d65 2829 0a20 2020 2065  ter_name().    e
+00008510: 7874 7261 5f66 6c61 6773 203d 2027 270a  xtra_flags = ''.
+00008520: 2020 2020 6966 2067 656e 6572 6963 5f63      if generic_c
+00008530: 6c6f 7564 2069 6e20 276b 7562 6572 6e65  loud in 'kuberne
+00008540: 7465 7327 3a0a 2020 2020 2020 2020 2320  tes':.        # 
+00008550: 4b75 6265 726e 6574 6573 2064 6f65 7320  Kubernetes does 
+00008560: 6e6f 7420 7375 7070 6f72 7420 6d75 6c74  not support mult
+00008570: 692d 6e6f 6465 0a20 2020 2020 2020 2023  i-node.        #
+00008580: 204e 4f54 453a 2054 6869 7320 7465 7374   NOTE: This test
+00008590: 2077 696c 6c20 6661 696c 2069 6620 796f   will fail if yo
+000085a0: 7520 6861 7665 2061 204b 7562 6572 6e65  u have a Kuberne
+000085b0: 7465 7320 636c 7573 7465 7220 7275 6e6e  tes cluster runn
+000085c0: 696e 6720 6f6e 0a20 2020 2020 2020 2023  ing on.        #
+000085d0: 2020 6172 6d36 3420 2865 2e67 2e2c 2041    arm64 (e.g., A
+000085e0: 7070 6c65 2053 696c 6963 6f6e 2920 7369  pple Silicon) si
+000085f0: 6e63 6520 676f 6f66 7973 2064 6f65 7320  nce goofys does 
+00008600: 6e6f 7420 776f 726b 206f 6e20 6172 6d36  not work on arm6
+00008610: 342e 0a20 2020 2020 2020 2065 7874 7261  4..        extra
+00008620: 5f66 6c61 6773 203d 2027 2d2d 6e75 6d2d  _flags = '--num-
+00008630: 6e6f 6465 7320 3127 0a20 2020 2074 6573  nodes 1'.    tes
+00008640: 745f 636f 6d6d 616e 6473 203d 205b 0a20  t_commands = [. 
+00008650: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
+00008660: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
+00008670: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00008680: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00008690: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+000086a0: 6963 5f63 6c6f 7564 7d20 7b65 7874 7261  ic_cloud} {extra
+000086b0: 5f66 6c61 6773 7d20 6578 616d 706c 6573  _flags} examples
+000086c0: 2f75 7369 6e67 5f66 696c 655f 6d6f 756e  /using_file_moun
+000086d0: 7473 2e79 616d 6c27 2c0a 2020 2020 2020  ts.yaml',.      
+000086e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000086f0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00008700: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00008710: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00008720: 2020 5d0a 2020 2020 7465 7374 203d 2054    ].    test = T
+00008730: 6573 7428 0a20 2020 2020 2020 2027 7573  est(.        'us
+00008740: 696e 675f 6669 6c65 5f6d 6f75 6e74 7327  ing_file_mounts'
+00008750: 2c0a 2020 2020 2020 2020 7465 7374 5f63  ,.        test_c
+00008760: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
+00008770: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00008780: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+00008790: 5f67 6574 5f74 696d 656f 7574 2867 656e  _get_timeout(gen
+000087a0: 6572 6963 5f63 6c6f 7564 2c20 3230 202a  eric_cloud, 20 *
+000087b0: 2036 3029 2c20 2023 2032 3020 6d69 6e73   60),  # 20 mins
+000087c0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000087d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000087e0: 4070 7974 6573 742e 6d61 726b 2e73 6370  @pytest.mark.scp
+000087f0: 0a64 6566 2074 6573 745f 7363 705f 6669  .def test_scp_fi
+00008800: 6c65 5f6d 6f75 6e74 7328 293a 0a20 2020  le_mounts():.   
+00008810: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00008820: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00008830: 7465 7374 5f63 6f6d 6d61 6e64 7320 3d20  test_commands = 
+00008840: 5b0a 2020 2020 2020 2020 2a73 746f 7261  [.        *stora
+00008850: 6765 5f73 6574 7570 5f63 6f6d 6d61 6e64  ge_setup_command
+00008860: 732c 0a20 2020 2020 2020 2066 2773 6b79  s,.        f'sky
+00008870: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00008880: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
+00008890: 2d2d 6e75 6d2d 6e6f 6465 7320 3120 6578  --num-nodes 1 ex
+000088a0: 616d 706c 6573 2f75 7369 6e67 5f66 696c  amples/using_fil
+000088b0: 655f 6d6f 756e 7473 2e79 616d 6c27 2c0a  e_mounts.yaml',.
+000088c0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000088d0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+000088e0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+000088f0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00008900: 6564 2e0a 2020 2020 5d0a 2020 2020 7465  ed..    ].    te
+00008910: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00008920: 2020 2027 5343 505f 7573 696e 675f 6669     'SCP_using_fi
+00008930: 6c65 5f6d 6f75 6e74 7327 2c0a 2020 2020  le_mounts',.    
+00008940: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
+00008950: 732c 0a20 2020 2020 2020 2066 2773 6b79  s,.        f'sky
+00008960: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00008970: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00008980: 743d 3230 202a 2036 302c 2020 2320 3230  t=20 * 60,  # 20
+00008990: 206d 696e 730a 2020 2020 290a 2020 2020   mins.    ).    
+000089a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000089b0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+000089c0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+000089d0: 2023 2052 6571 7569 7265 7320 4743 5020   # Requires GCP 
+000089e0: 746f 2062 6520 656e 6162 6c65 640a 6465  to be enabled.de
+000089f0: 6620 7465 7374 5f75 7369 6e67 5f66 696c  f test_using_fil
+00008a00: 655f 6d6f 756e 7473 5f77 6974 685f 656e  e_mounts_with_en
+00008a10: 765f 7661 7273 2867 656e 6572 6963 5f63  v_vars(generic_c
+00008a20: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00008a30: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00008a40: 7465 725f 6e61 6d65 2829 0a20 2020 2073  ter_name().    s
+00008a50: 746f 7261 6765 5f6e 616d 6520 3d20 5465  torage_name = Te
+00008a60: 7374 5374 6f72 6167 6557 6974 6843 7265  stStorageWithCre
+00008a70: 6465 6e74 6961 6c73 2e67 656e 6572 6174  dentials.generat
+00008a80: 655f 6275 636b 6574 5f6e 616d 6528 290a  e_bucket_name().
+00008a90: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
+00008aa0: 7320 3d20 5b0a 2020 2020 2020 2020 2a73  s = [.        *s
+00008ab0: 746f 7261 6765 5f73 6574 7570 5f63 6f6d  torage_setup_com
+00008ac0: 6d61 6e64 732c 0a20 2020 2020 2020 2028  mands,.        (
+00008ad0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00008ae0: 2d63 207b 6e61 6d65 7d20 2d2d 6370 7573  -c {name} --cpus
+00008af0: 2032 2b20 2d2d 636c 6f75 6420 7b67 656e   2+ --cloud {gen
+00008b00: 6572 6963 5f63 6c6f 7564 7d20 270a 2020  eric_cloud} '.  
+00008b10: 2020 2020 2020 2027 6578 616d 706c 6573         'examples
+00008b20: 2f75 7369 6e67 5f66 696c 655f 6d6f 756e  /using_file_moun
+00008b30: 7473 5f77 6974 685f 656e 765f 7661 7273  ts_with_env_vars
+00008b40: 2e79 616d 6c20 270a 2020 2020 2020 2020  .yaml '.        
+00008b50: 2066 272d 2d65 6e76 204d 595f 4255 434b   f'--env MY_BUCK
+00008b60: 4554 3d7b 7374 6f72 6167 655f 6e61 6d65  ET={storage_name
+00008b70: 7d27 292c 0a20 2020 2020 2020 2066 2773  }'),.        f's
+00008b80: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00008b90: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00008ba0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00008bb0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00008bc0: 2023 204f 7665 7272 6964 6520 7769 7468   # Override with
+00008bd0: 202d 2d65 6e76 3a0a 2020 2020 2020 2020   --env:.        
+00008be0: 2866 2773 6b79 206c 6175 6e63 6820 2d79  (f'sky launch -y
+00008bf0: 202d 6320 7b6e 616d 657d 2d32 202d 2d63   -c {name}-2 --c
+00008c00: 7075 7320 322b 202d 2d63 6c6f 7564 207b  pus 2+ --cloud {
+00008c10: 6765 6e65 7269 635f 636c 6f75 647d 2027  generic_cloud} '
+00008c20: 0a20 2020 2020 2020 2020 2765 7861 6d70  .         'examp
+00008c30: 6c65 732f 7573 696e 675f 6669 6c65 5f6d  les/using_file_m
+00008c40: 6f75 6e74 735f 7769 7468 5f65 6e76 5f76  ounts_with_env_v
+00008c50: 6172 732e 7961 6d6c 2027 0a20 2020 2020  ars.yaml '.     
+00008c60: 2020 2020 6627 2d2d 656e 7620 4d59 5f42      f'--env MY_B
+00008c70: 5543 4b45 543d 7b73 746f 7261 6765 5f6e  UCKET={storage_n
+00008c80: 616d 657d 2027 0a20 2020 2020 2020 2020  ame} '.         
+00008c90: 272d 2d65 6e76 204d 595f 4c4f 4341 4c5f  '--env MY_LOCAL_
+00008ca0: 5041 5448 3d74 6d70 6669 6c65 2729 2c0a  PATH=tmpfile'),.
+00008cb0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00008cc0: 6773 207b 6e61 6d65 7d2d 3220 3120 2d2d  gs {name}-2 1 --
+00008cd0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00008ce0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00008cf0: 6564 6564 2e0a 2020 2020 5d0a 2020 2020  eded..    ].    
+00008d00: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00008d10: 2020 2020 2027 7573 696e 675f 6669 6c65       'using_file
+00008d20: 5f6d 6f75 6e74 735f 7769 7468 5f65 6e76  _mounts_with_env
+00008d30: 5f76 6172 7327 2c0a 2020 2020 2020 2020  _vars',.        
+00008d40: 7465 7374 5f63 6f6d 6d61 6e64 732c 0a20  test_commands,. 
+00008d50: 2020 2020 2020 2028 6627 736b 7920 646f         (f'sky do
+00008d60: 776e 202d 7920 7b6e 616d 657d 207b 6e61  wn -y {name} {na
+00008d70: 6d65 7d2d 3227 2c0a 2020 2020 2020 2020  me}-2',.        
+00008d80: 2066 2773 6b79 2073 746f 7261 6765 2064   f'sky storage d
+00008d90: 656c 6574 6520 2d79 207b 7374 6f72 6167  elete -y {storag
+00008da0: 655f 6e61 6d65 7d20 7b73 746f 7261 6765  e_name} {storage
+00008db0: 5f6e 616d 657d 2d32 2729 2c0a 2020 2020  _name}-2'),.    
+00008dc0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00008dd0: 2036 302c 2020 2320 3230 206d 696e 730a   60,  # 20 mins.
+00008de0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00008df0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+00008e00: 202d 2d2d 2d2d 2d2d 2d2d 2d20 7374 6f72   ---------- stor
+00008e10: 6167 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  age ----------.@
+00008e20: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
+00008e30: 6465 6620 7465 7374 5f61 7773 5f73 746f  def test_aws_sto
+00008e40: 7261 6765 5f6d 6f75 6e74 735f 7769 7468  rage_mounts_with
+00008e50: 5f73 746f 7028 293a 0a20 2020 206e 616d  _stop():.    nam
+00008e60: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00008e70: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
+00008e80: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
+00008e90: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
+00008ea0: 7469 6d65 2829 297d 270a 2020 2020 7465  time())}'.    te
+00008eb0: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
+00008ec0: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
+00008ed0: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
+00008ee0: 616d 6c73 2f74 6573 745f 7374 6f72 6167  amls/test_storag
+00008ef0: 655f 6d6f 756e 7469 6e67 2e79 616d 6c2e  e_mounting.yaml.
+00008f00: 6a32 2729 2e72 6561 645f 7465 7874 2829  j2').read_text()
+00008f10: 0a20 2020 2074 656d 706c 6174 6520 3d20  .    template = 
+00008f20: 6a69 6e6a 6132 2e54 656d 706c 6174 6528  jinja2.Template(
+00008f30: 7465 6d70 6c61 7465 5f73 7472 290a 2020  template_str).  
+00008f40: 2020 636f 6e74 656e 7420 3d20 7465 6d70    content = temp
+00008f50: 6c61 7465 2e72 656e 6465 7228 7374 6f72  late.render(stor
+00008f60: 6167 655f 6e61 6d65 3d73 746f 7261 6765  age_name=storage
+00008f70: 5f6e 616d 6529 0a20 2020 2077 6974 6820  _name).    with 
+00008f80: 7465 6d70 6669 6c65 2e4e 616d 6564 5465  tempfile.NamedTe
+00008f90: 6d70 6f72 6172 7946 696c 6528 7375 6666  mporaryFile(suff
+00008fa0: 6978 3d27 2e79 616d 6c27 2c20 6d6f 6465  ix='.yaml', mode
+00008fb0: 3d27 7727 2920 6173 2066 3a0a 2020 2020  ='w') as f:.    
+00008fc0: 2020 2020 662e 7772 6974 6528 636f 6e74      f.write(cont
+00008fd0: 656e 7429 0a20 2020 2020 2020 2066 2e66  ent).        f.f
+00008fe0: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
+00008ff0: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
+00009000: 650a 2020 2020 2020 2020 7465 7374 5f63  e.        test_c
+00009010: 6f6d 6d61 6e64 7320 3d20 5b0a 2020 2020  ommands = [.    
+00009020: 2020 2020 2020 2020 2a73 746f 7261 6765          *storage
+00009030: 5f73 6574 7570 5f63 6f6d 6d61 6e64 732c  _setup_commands,
+00009040: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00009050: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00009060: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
+00009070: 7773 207b 6669 6c65 5f70 6174 687d 272c  ws {file_path}',
+00009080: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00009090: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+000090a0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000090b0: 6e73 7572 6520 6a6f 6220 7375 6363 6565  nsure job succee
+000090c0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+000090d0: 2066 2761 7773 2073 3320 6c73 207b 7374   f'aws s3 ls {st
+000090e0: 6f72 6167 655f 6e61 6d65 7d2f 6865 6c6c  orage_name}/hell
+000090f0: 6f2e 7478 7427 2c0a 2020 2020 2020 2020  o.txt',.        
+00009100: 2020 2020 6627 736b 7920 7374 6f70 202d      f'sky stop -
+00009110: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00009120: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00009130: 7274 202d 7920 7b6e 616d 657d 272c 0a20  rt -y {name}',. 
+00009140: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
+00009150: 636b 2069 6620 6865 6c6c 6f2e 7478 7420  ck if hello.txt 
+00009160: 6672 6f6d 206d 6f75 6e74 696e 6720 6275  from mounting bu
+00009170: 636b 6574 2065 7869 7374 7320 6166 7465  cket exists afte
+00009180: 7220 7265 7374 6172 7420 696e 0a20 2020  r restart in.   
+00009190: 2020 2020 2020 2020 2023 2074 6865 206d           # the m
+000091a0: 6f75 6e74 6564 2064 6972 6563 746f 7279  ounted directory
+000091b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000091c0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+000091d0: 2d20 2273 6574 202d 6578 3b20 6c73 202f  - "set -ex; ls /
+000091e0: 6d6f 756e 745f 7072 6976 6174 655f 6d6f  mount_private_mo
+000091f0: 756e 742f 6865 6c6c 6f2e 7478 7422 270a  unt/hello.txt"'.
+00009200: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00009210: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00009220: 2020 2020 2020 2020 2020 2027 6177 735f             'aws_
+00009230: 7374 6f72 6167 655f 6d6f 756e 7473 272c  storage_mounts',
+00009240: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
+00009250: 745f 636f 6d6d 616e 6473 2c0a 2020 2020  t_commands,.    
+00009260: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00009270: 776e 202d 7920 7b6e 616d 657d 3b20 736b  wn -y {name}; sk
+00009280: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
+00009290: 202d 7920 7b73 746f 7261 6765 5f6e 616d   -y {storage_nam
+000092a0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+000092b0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+000092c0: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
+000092d0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+000092e0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+000092f0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00009300: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
+00009310: 705f 7374 6f72 6167 655f 6d6f 756e 7473  p_storage_mounts
+00009320: 5f77 6974 685f 7374 6f70 2829 3a0a 2020  _with_stop():.  
+00009330: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00009340: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00009350: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
+00009360: 6627 736b 792d 7465 7374 2d7b 696e 7428  f'sky-test-{int(
+00009370: 7469 6d65 2e74 696d 6528 2929 7d27 0a20  time.time())}'. 
+00009380: 2020 2074 656d 706c 6174 655f 7374 7220     template_str 
+00009390: 3d20 7061 7468 6c69 622e 5061 7468 280a  = pathlib.Path(.
+000093a0: 2020 2020 2020 2020 2774 6573 7473 2f74          'tests/t
+000093b0: 6573 745f 7961 6d6c 732f 7465 7374 5f73  est_yamls/test_s
+000093c0: 746f 7261 6765 5f6d 6f75 6e74 696e 672e  torage_mounting.
+000093d0: 7961 6d6c 2e6a 3227 292e 7265 6164 5f74  yaml.j2').read_t
+000093e0: 6578 7428 290a 2020 2020 7465 6d70 6c61  ext().    templa
+000093f0: 7465 203d 206a 696e 6a61 322e 5465 6d70  te = jinja2.Temp
+00009400: 6c61 7465 2874 656d 706c 6174 655f 7374  late(template_st
+00009410: 7229 0a20 2020 2063 6f6e 7465 6e74 203d  r).    content =
+00009420: 2074 656d 706c 6174 652e 7265 6e64 6572   template.render
+00009430: 2873 746f 7261 6765 5f6e 616d 653d 7374  (storage_name=st
+00009440: 6f72 6167 655f 6e61 6d65 290a 2020 2020  orage_name).    
+00009450: 7769 7468 2074 656d 7066 696c 652e 4e61  with tempfile.Na
+00009460: 6d65 6454 656d 706f 7261 7279 4669 6c65  medTemporaryFile
+00009470: 2873 7566 6669 783d 272e 7961 6d6c 272c  (suffix='.yaml',
+00009480: 206d 6f64 653d 2777 2729 2061 7320 663a   mode='w') as f:
+00009490: 0a20 2020 2020 2020 2066 2e77 7269 7465  .        f.write
+000094a0: 2863 6f6e 7465 6e74 290a 2020 2020 2020  (content).      
+000094b0: 2020 662e 666c 7573 6828 290a 2020 2020    f.flush().    
+000094c0: 2020 2020 6669 6c65 5f70 6174 6820 3d20      file_path = 
+000094d0: 662e 6e61 6d65 0a20 2020 2020 2020 2074  f.name.        t
+000094e0: 6573 745f 636f 6d6d 616e 6473 203d 205b  est_commands = [
+000094f0: 0a20 2020 2020 2020 2020 2020 202a 7374  .            *st
+00009500: 6f72 6167 655f 7365 7475 705f 636f 6d6d  orage_setup_comm
+00009510: 616e 6473 2c0a 2020 2020 2020 2020 2020  ands,.          
+00009520: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00009530: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+00009540: 6f75 6420 6763 7020 7b66 696c 655f 7061  oud gcp {file_pa
+00009550: 7468 7d27 2c0a 2020 2020 2020 2020 2020  th}',.          
+00009560: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00009570: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00009580: 2020 2320 456e 7375 7265 206a 6f62 2073    # Ensure job s
+00009590: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+000095a0: 2020 2020 2020 6627 6773 7574 696c 206c        f'gsutil l
+000095b0: 7320 6773 3a2f 2f7b 7374 6f72 6167 655f  s gs://{storage_
+000095c0: 6e61 6d65 7d2f 6865 6c6c 6f2e 7478 7427  name}/hello.txt'
+000095d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000095e0: 736b 7920 7374 6f70 202d 7920 7b6e 616d  sky stop -y {nam
+000095f0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+00009600: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
+00009610: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+00009620: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
+00009630: 6865 6c6c 6f2e 7478 7420 6672 6f6d 206d  hello.txt from m
+00009640: 6f75 6e74 696e 6720 6275 636b 6574 2065  ounting bucket e
+00009650: 7869 7374 7320 6166 7465 7220 7265 7374  xists after rest
+00009660: 6172 7420 696e 0a20 2020 2020 2020 2020  art in.         
+00009670: 2020 2023 2074 6865 206d 6f75 6e74 6564     # the mounted
+00009680: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
+00009690: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+000096a0: 6320 7b6e 616d 657d 202d 2d20 2273 6574  c {name} -- "set
+000096b0: 202d 6578 3b20 6c73 202f 6d6f 756e 745f   -ex; ls /mount_
+000096c0: 7072 6976 6174 655f 6d6f 756e 742f 6865  private_mount/he
+000096d0: 6c6c 6f2e 7478 7422 270a 2020 2020 2020  llo.txt"'.      
+000096e0: 2020 5d0a 2020 2020 2020 2020 7465 7374    ].        test
+000096f0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00009700: 2020 2020 2027 6763 705f 7374 6f72 6167       'gcp_storag
+00009710: 655f 6d6f 756e 7473 272c 0a20 2020 2020  e_mounts',.     
+00009720: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
+00009730: 616e 6473 2c0a 2020 2020 2020 2020 2020  ands,.          
+00009740: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00009750: 7b6e 616d 657d 3b20 736b 7920 7374 6f72  {name}; sky stor
+00009760: 6167 6520 6465 6c65 7465 202d 7920 7b73  age delete -y {s
+00009770: 746f 7261 6765 5f6e 616d 657d 272c 0a20  torage_name}',. 
+00009780: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
+00009790: 7574 3d32 3020 2a20 3630 2c20 2023 2032  ut=20 * 60,  # 2
+000097a0: 3020 6d69 6e73 0a20 2020 2020 2020 2029  0 mins.        )
+000097b0: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
+000097c0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+000097d0: 7974 6573 742e 6d61 726b 2e6b 7562 6572  ytest.mark.kuber
+000097e0: 6e65 7465 730a 6465 6620 7465 7374 5f6b  netes.def test_k
+000097f0: 7562 6572 6e65 7465 735f 7374 6f72 6167  ubernetes_storag
+00009800: 655f 6d6f 756e 7473 2829 3a0a 2020 2020  e_mounts():.    
+00009810: 2320 5465 7374 7320 6275 636b 6574 206d  # Tests bucket m
+00009820: 6f75 6e74 696e 6720 6f6e 206b 3873 2c20  ounting on k8s, 
+00009830: 6173 7375 6d69 6e67 2053 3320 6973 2063  assuming S3 is c
+00009840: 6f6e 6669 6775 7265 642e 0a20 2020 2023  onfigured..    #
+00009850: 2054 6869 7320 7465 7374 2077 696c 6c20   This test will 
+00009860: 6661 696c 2069 6620 7275 6e20 6f6e 206e  fail if run on n
+00009870: 6f6e 2078 3836 5f36 3420 6172 6368 6974  on x86_64 archit
+00009880: 6563 7475 7265 2c20 7369 6e63 6520 676f  ecture, since go
+00009890: 6f66 7973 2069 730a 2020 2020 2320 6275  ofys is.    # bu
+000098a0: 696c 7420 666f 7220 7838 365f 3634 206f  ilt for x86_64 o
+000098b0: 6e6c 792e 0a20 2020 206e 616d 6520 3d20  nly..    name = 
+000098c0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000098d0: 6528 290a 2020 2020 7374 6f72 6167 655f  e().    storage_
+000098e0: 6e61 6d65 203d 2066 2773 6b79 2d74 6573  name = f'sky-tes
+000098f0: 742d 7b69 6e74 2874 696d 652e 7469 6d65  t-{int(time.time
+00009900: 2829 297d 270a 2020 2020 7465 6d70 6c61  ())}'.    templa
+00009910: 7465 5f73 7472 203d 2070 6174 686c 6962  te_str = pathlib
+00009920: 2e50 6174 6828 0a20 2020 2020 2020 2027  .Path(.        '
+00009930: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00009940: 2f74 6573 745f 7374 6f72 6167 655f 6d6f  /test_storage_mo
+00009950: 756e 7469 6e67 2e79 616d 6c2e 6a32 2729  unting.yaml.j2')
+00009960: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
+00009970: 2074 656d 706c 6174 6520 3d20 6a69 6e6a   template = jinj
+00009980: 6132 2e54 656d 706c 6174 6528 7465 6d70  a2.Template(temp
+00009990: 6c61 7465 5f73 7472 290a 2020 2020 636f  late_str).    co
+000099a0: 6e74 656e 7420 3d20 7465 6d70 6c61 7465  ntent = template
+000099b0: 2e72 656e 6465 7228 7374 6f72 6167 655f  .render(storage_
+000099c0: 6e61 6d65 3d73 746f 7261 6765 5f6e 616d  name=storage_nam
+000099d0: 6529 0a20 2020 2077 6974 6820 7465 6d70  e).    with temp
+000099e0: 6669 6c65 2e4e 616d 6564 5465 6d70 6f72  file.NamedTempor
+000099f0: 6172 7946 696c 6528 7375 6666 6978 3d27  aryFile(suffix='
+00009a00: 2e79 616d 6c27 2c20 6d6f 6465 3d27 7727  .yaml', mode='w'
+00009a10: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00009a20: 662e 7772 6974 6528 636f 6e74 656e 7429  f.write(content)
+00009a30: 0a20 2020 2020 2020 2066 2e66 6c75 7368  .        f.flush
+00009a40: 2829 0a20 2020 2020 2020 2066 696c 655f  ().        file_
+00009a50: 7061 7468 203d 2066 2e6e 616d 650a 2020  path = f.name.  
+00009a60: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
+00009a70: 6e64 7320 3d20 5b0a 2020 2020 2020 2020  nds = [.        
+00009a80: 2020 2020 2a73 746f 7261 6765 5f73 6574      *storage_set
+00009a90: 7570 5f63 6f6d 6d61 6e64 732c 0a20 2020  up_commands,.   
+00009aa0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00009ab0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00009ac0: 657d 202d 2d63 6c6f 7564 206b 7562 6572  e} --cloud kuber
+00009ad0: 6e65 7465 7320 7b66 696c 655f 7061 7468  netes {file_path
+00009ae0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00009af0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00009b00: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00009b10: 2320 456e 7375 7265 206a 6f62 2073 7563  # Ensure job suc
+00009b20: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00009b30: 2020 2020 6627 6177 7320 7333 206c 7320      f'aws s3 ls 
+00009b40: 7b73 746f 7261 6765 5f6e 616d 657d 2f68  {storage_name}/h
+00009b50: 656c 6c6f 2e74 7874 207c 7c20 270a 2020  ello.txt || '.  
+00009b60: 2020 2020 2020 2020 2020 6627 6773 7574            f'gsut
+00009b70: 696c 206c 7320 6773 3a2f 2f7b 7374 6f72  il ls gs://{stor
+00009b80: 6167 655f 6e61 6d65 7d2f 6865 6c6c 6f2e  age_name}/hello.
+00009b90: 7478 7427 2c0a 2020 2020 2020 2020 5d0a  txt',.        ].
+00009ba0: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
+00009bb0: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
+00009bc0: 2027 6b75 6265 726e 6574 6573 5f73 746f   'kubernetes_sto
+00009bd0: 7261 6765 5f6d 6f75 6e74 7327 2c0a 2020  rage_mounts',.  
+00009be0: 2020 2020 2020 2020 2020 7465 7374 5f63            test_c
+00009bf0: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
+00009c00: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00009c10: 2d79 207b 6e61 6d65 7d3b 2073 6b79 2073  -y {name}; sky s
+00009c20: 746f 7261 6765 2064 656c 6574 6520 2d79  torage delete -y
+00009c30: 207b 7374 6f72 6167 655f 6e61 6d65 7d27   {storage_name}'
+00009c40: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
+00009c50: 6d65 6f75 743d 3230 202a 2036 302c 2020  meout=20 * 60,  
+00009c60: 2320 3230 206d 696e 730a 2020 2020 2020  # 20 mins.      
+00009c70: 2020 290a 2020 2020 2020 2020 7275 6e5f    ).        run_
+00009c80: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00009c90: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
+00009ca0: 7261 6d65 7472 697a 6528 0a20 2020 2022  rametrize(.    "
+00009cb0: 696d 6167 655f 6964 222c 0a20 2020 205b  image_id",.    [
+00009cc0: 0a20 2020 2020 2020 2022 646f 636b 6572  .        "docker
+00009cd0: 3a6e 7669 6469 612f 6375 6461 3a31 312e  :nvidia/cuda:11.
+00009ce0: 382e 302d 6465 7665 6c2d 7562 756e 7475  8.0-devel-ubuntu
+00009cf0: 3138 2e30 3422 2c0a 2020 2020 2020 2020  18.04",.        
+00009d00: 2264 6f63 6b65 723a 7562 756e 7475 3a31  "docker:ubuntu:1
+00009d10: 382e 3034 222c 0a20 2020 2020 2020 2023  8.04",.        #
+00009d20: 2054 6573 7420 696d 6167 6520 7769 7468   Test image with
+00009d30: 2070 7974 686f 6e20 332e 3131 2069 6e73   python 3.11 ins
+00009d40: 7461 6c6c 6564 2062 7920 6465 6661 756c  talled by defaul
+00009d50: 742e 0a20 2020 2020 2020 2022 646f 636b  t..        "dock
+00009d60: 6572 3a63 6f6e 7469 6e75 756d 696f 2f6d  er:continuumio/m
+00009d70: 696e 6963 6f6e 6461 3322 2c0a 2020 2020  iniconda3",.    
+00009d80: 5d29 0a64 6566 2074 6573 745f 646f 636b  ]).def test_dock
+00009d90: 6572 5f73 746f 7261 6765 5f6d 6f75 6e74  er_storage_mount
+00009da0: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
+00009db0: 2073 7472 2c20 696d 6167 655f 6964 3a20   str, image_id: 
+00009dc0: 7374 7229 3a0a 2020 2020 2320 5465 7374  str):.    # Test
+00009dd0: 7320 6275 636b 6574 206d 6f75 6e74 696e  s bucket mountin
+00009de0: 6720 6f6e 2064 6f63 6b65 7220 636f 6e74  g on docker cont
+00009df0: 6169 6e65 720a 2020 2020 6e61 6d65 203d  ainer.    name =
+00009e00: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00009e10: 6d65 2829 0a20 2020 2074 696d 6573 7461  me().    timesta
+00009e20: 6d70 203d 2073 7472 2874 696d 652e 7469  mp = str(time.ti
+00009e30: 6d65 2829 292e 7265 706c 6163 6528 272e  me()).replace('.
+00009e40: 272c 2027 2729 0a20 2020 2073 746f 7261  ', '').    stora
+00009e50: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
+00009e60: 7465 7374 2d7b 7469 6d65 7374 616d 707d  test-{timestamp}
+00009e70: 270a 2020 2020 7465 6d70 6c61 7465 5f73  '.    template_s
+00009e80: 7472 203d 2070 6174 686c 6962 2e50 6174  tr = pathlib.Pat
+00009e90: 6828 0a20 2020 2020 2020 2027 7465 7374  h(.        'test
+00009ea0: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
+00009eb0: 745f 7374 6f72 6167 655f 6d6f 756e 7469  t_storage_mounti
+00009ec0: 6e67 2e79 616d 6c2e 6a32 2729 2e72 6561  ng.yaml.j2').rea
+00009ed0: 645f 7465 7874 2829 0a20 2020 2074 656d  d_text().    tem
+00009ee0: 706c 6174 6520 3d20 6a69 6e6a 6132 2e54  plate = jinja2.T
+00009ef0: 656d 706c 6174 6528 7465 6d70 6c61 7465  emplate(template
+00009f00: 5f73 7472 290a 2020 2020 636f 6e74 656e  _str).    conten
+00009f10: 7420 3d20 7465 6d70 6c61 7465 2e72 656e  t = template.ren
+00009f20: 6465 7228 7374 6f72 6167 655f 6e61 6d65  der(storage_name
+00009f30: 3d73 746f 7261 6765 5f6e 616d 6529 0a20  =storage_name). 
+00009f40: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
+00009f50: 2e4e 616d 6564 5465 6d70 6f72 6172 7946  .NamedTemporaryF
+00009f60: 696c 6528 7375 6666 6978 3d27 2e79 616d  ile(suffix='.yam
+00009f70: 6c27 2c20 6d6f 6465 3d27 7727 2920 6173  l', mode='w') as
+00009f80: 2066 3a0a 2020 2020 2020 2020 662e 7772   f:.        f.wr
+00009f90: 6974 6528 636f 6e74 656e 7429 0a20 2020  ite(content).   
+00009fa0: 2020 2020 2066 2e66 6c75 7368 2829 0a20       f.flush(). 
+00009fb0: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
+00009fc0: 203d 2066 2e6e 616d 650a 2020 2020 2020   = f.name.      
+00009fd0: 2020 7465 7374 5f63 6f6d 6d61 6e64 7320    test_commands 
+00009fe0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00009ff0: 2a73 746f 7261 6765 5f73 6574 7570 5f63  *storage_setup_c
+0000a000: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
+0000a010: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000a020: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0000a030: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+0000a040: 636c 6f75 647d 202d 2d69 6d61 6765 2d69  cloud} --image-i
+0000a050: 6420 7b69 6d61 6765 5f69 647d 207b 6669  d {image_id} {fi
+0000a060: 6c65 5f70 6174 687d 272c 0a20 2020 2020  le_path}',.     
+0000a070: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0000a080: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+0000a090: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+0000a0a0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+0000a0b0: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
+0000a0c0: 2073 3320 6c73 207b 7374 6f72 6167 655f   s3 ls {storage_
+0000a0d0: 6e61 6d65 7d2f 6865 6c6c 6f2e 7478 7420  name}/hello.txt 
+0000a0e0: 7c7c 2027 0a20 2020 2020 2020 2020 2020  || '.           
+0000a0f0: 2066 2767 7375 7469 6c20 6c73 2067 733a   f'gsutil ls gs:
+0000a100: 2f2f 7b73 746f 7261 6765 5f6e 616d 657d  //{storage_name}
+0000a110: 2f68 656c 6c6f 2e74 7874 272c 0a20 2020  /hello.txt',.   
+0000a120: 2020 2020 205d 0a20 2020 2020 2020 2074       ].        t
+0000a130: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000a140: 2020 2020 2020 2020 2764 6f63 6b65 725f          'docker_
+0000a150: 7374 6f72 6167 655f 6d6f 756e 7473 272c  storage_mounts',
+0000a160: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
+0000a170: 745f 636f 6d6d 616e 6473 2c0a 2020 2020  t_commands,.    
+0000a180: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000a190: 776e 202d 7920 7b6e 616d 657d 3b20 736b  wn -y {name}; sk
+0000a1a0: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
+0000a1b0: 202d 7920 7b73 746f 7261 6765 5f6e 616d   -y {storage_nam
+0000a1c0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+0000a1d0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+0000a1e0: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
+0000a1f0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0000a200: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000a210: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0000a220: 2e63 6c6f 7564 666c 6172 650a 6465 6620  .cloudflare.def 
+0000a230: 7465 7374 5f63 6c6f 7564 666c 6172 655f  test_cloudflare_
+0000a240: 7374 6f72 6167 655f 6d6f 756e 7473 2867  storage_mounts(g
+0000a250: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+0000a260: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+0000a270: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000a280: 2829 0a20 2020 2073 746f 7261 6765 5f6e  ().    storage_n
+0000a290: 616d 6520 3d20 6627 736b 792d 7465 7374  ame = f'sky-test
+0000a2a0: 2d7b 696e 7428 7469 6d65 2e74 696d 6528  -{int(time.time(
+0000a2b0: 2929 7d27 0a20 2020 2074 656d 706c 6174  ))}'.    templat
+0000a2c0: 655f 7374 7220 3d20 7061 7468 6c69 622e  e_str = pathlib.
+0000a2d0: 5061 7468 280a 2020 2020 2020 2020 2774  Path(.        't
+0000a2e0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+0000a2f0: 7465 7374 5f72 325f 7374 6f72 6167 655f  test_r2_storage_
+0000a300: 6d6f 756e 7469 6e67 2e79 616d 6c27 292e  mounting.yaml').
+0000a310: 7265 6164 5f74 6578 7428 290a 2020 2020  read_text().    
+0000a320: 7465 6d70 6c61 7465 203d 206a 696e 6a61  template = jinja
+0000a330: 322e 5465 6d70 6c61 7465 2874 656d 706c  2.Template(templ
+0000a340: 6174 655f 7374 7229 0a20 2020 2063 6f6e  ate_str).    con
+0000a350: 7465 6e74 203d 2074 656d 706c 6174 652e  tent = template.
+0000a360: 7265 6e64 6572 2873 746f 7261 6765 5f6e  render(storage_n
+0000a370: 616d 653d 7374 6f72 6167 655f 6e61 6d65  ame=storage_name
+0000a380: 290a 2020 2020 656e 6470 6f69 6e74 5f75  ).    endpoint_u
+0000a390: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
+0000a3a0: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
+0000a3b0: 290a 2020 2020 7769 7468 2074 656d 7066  ).    with tempf
+0000a3c0: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
+0000a3d0: 7279 4669 6c65 2873 7566 6669 783d 272e  ryFile(suffix='.
+0000a3e0: 7961 6d6c 272c 206d 6f64 653d 2777 2729  yaml', mode='w')
+0000a3f0: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
+0000a400: 2e77 7269 7465 2863 6f6e 7465 6e74 290a  .write(content).
+0000a410: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
+0000a420: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
+0000a430: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
+0000a440: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
+0000a450: 6473 203d 205b 0a20 2020 2020 2020 2020  ds = [.         
+0000a460: 2020 202a 7374 6f72 6167 655f 7365 7475     *storage_setu
+0000a470: 705f 636f 6d6d 616e 6473 2c0a 2020 2020  p_commands,.    
+0000a480: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000a490: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000a4a0: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+0000a4b0: 6963 5f63 6c6f 7564 7d20 7b66 696c 655f  ic_cloud} {file_
+0000a4c0: 7061 7468 7d27 2c0a 2020 2020 2020 2020  path}',.        
+0000a4d0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000a4e0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0000a4f0: 272c 2020 2320 456e 7375 7265 206a 6f62  ',  # Ensure job
+0000a500: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+0000a510: 2020 2020 2020 2020 6627 4157 535f 5348          f'AWS_SH
+0000a520: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
+0000a530: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
+0000a540: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
+0000a550: 5f50 4154 487d 2061 7773 2073 3320 6c73  _PATH} aws s3 ls
+0000a560: 2073 333a 2f2f 7b73 746f 7261 6765 5f6e   s3://{storage_n
+0000a570: 616d 657d 2f68 656c 6c6f 2e74 7874 202d  ame}/hello.txt -
+0000a580: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+0000a590: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+0000a5a0: 6c65 3d72 3227 0a20 2020 2020 2020 205d  le=r2'.        ]
+0000a5b0: 0a0a 2020 2020 2020 2020 7465 7374 203d  ..        test =
+0000a5c0: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+0000a5d0: 2020 2027 636c 6f75 6466 6c61 7265 5f73     'cloudflare_s
+0000a5e0: 746f 7261 6765 5f6d 6f75 6e74 7327 2c0a  torage_mounts',.
+0000a5f0: 2020 2020 2020 2020 2020 2020 7465 7374              test
+0000a600: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
+0000a610: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0000a620: 6e20 2d79 207b 6e61 6d65 7d3b 2073 6b79  n -y {name}; sky
+0000a630: 2073 746f 7261 6765 2064 656c 6574 6520   storage delete 
+0000a640: 2d79 207b 7374 6f72 6167 655f 6e61 6d65  -y {storage_name
+0000a650: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0000a660: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+0000a670: 2020 2320 3230 206d 696e 730a 2020 2020    # 20 mins.    
+0000a680: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+0000a690: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000a6a0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+0000a6b0: 6962 6d0a 6465 6620 7465 7374 5f69 626d  ibm.def test_ibm
+0000a6c0: 5f73 746f 7261 6765 5f6d 6f75 6e74 7328  _storage_mounts(
+0000a6d0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+0000a6e0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0000a6f0: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
+0000a700: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
+0000a710: 7b69 6e74 2874 696d 652e 7469 6d65 2829  {int(time.time()
+0000a720: 297d 270a 2020 2020 6275 636b 6574 5f72  )}'.    bucket_r
+0000a730: 636c 6f6e 655f 7072 6f66 696c 6520 3d20  clone_profile = 
+0000a740: 5263 6c6f 6e65 2e67 656e 6572 6174 655f  Rclone.generate_
+0000a750: 7263 6c6f 6e65 5f62 7563 6b65 745f 7072  rclone_bucket_pr
+0000a760: 6f66 696c 655f 6e61 6d65 280a 2020 2020  ofile_name(.    
+0000a770: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
+0000a780: 2c20 5263 6c6f 6e65 2e52 636c 6f6e 6543  , Rclone.RcloneC
+0000a790: 6c6f 7564 732e 4942 4d29 0a20 2020 2074  louds.IBM).    t
+0000a7a0: 656d 706c 6174 655f 7374 7220 3d20 7061  emplate_str = pa
+0000a7b0: 7468 6c69 622e 5061 7468 280a 2020 2020  thlib.Path(.    
+0000a7c0: 2020 2020 2774 6573 7473 2f74 6573 745f      'tests/test_
+0000a7d0: 7961 6d6c 732f 7465 7374 5f69 626d 5f63  yamls/test_ibm_c
+0000a7e0: 6f73 5f73 746f 7261 6765 5f6d 6f75 6e74  os_storage_mount
+0000a7f0: 696e 672e 7961 6d6c 2729 2e72 6561 645f  ing.yaml').read_
+0000a800: 7465 7874 2829 0a20 2020 2074 656d 706c  text().    templ
+0000a810: 6174 6520 3d20 6a69 6e6a 6132 2e54 656d  ate = jinja2.Tem
+0000a820: 706c 6174 6528 7465 6d70 6c61 7465 5f73  plate(template_s
+0000a830: 7472 290a 2020 2020 636f 6e74 656e 7420  tr).    content 
+0000a840: 3d20 7465 6d70 6c61 7465 2e72 656e 6465  = template.rende
+0000a850: 7228 7374 6f72 6167 655f 6e61 6d65 3d73  r(storage_name=s
+0000a860: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
+0000a870: 2077 6974 6820 7465 6d70 6669 6c65 2e4e   with tempfile.N
+0000a880: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
+0000a890: 6528 7375 6666 6978 3d27 2e79 616d 6c27  e(suffix='.yaml'
+0000a8a0: 2c20 6d6f 6465 3d27 7727 2920 6173 2066  , mode='w') as f
+0000a8b0: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
+0000a8c0: 6528 636f 6e74 656e 7429 0a20 2020 2020  e(content).     
+0000a8d0: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
+0000a8e0: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
+0000a8f0: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
+0000a900: 7465 7374 5f63 6f6d 6d61 6e64 7320 3d20  test_commands = 
+0000a910: 5b0a 2020 2020 2020 2020 2020 2020 2a73  [.            *s
+0000a920: 746f 7261 6765 5f73 6574 7570 5f63 6f6d  torage_setup_com
+0000a930: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
+0000a940: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000a950: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+0000a960: 6c6f 7564 2069 626d 207b 6669 6c65 5f70  loud ibm {file_p
+0000a970: 6174 687d 272c 0a20 2020 2020 2020 2020  ath}',.         
+0000a980: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000a990: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+0000a9a0: 2c20 2023 2045 6e73 7572 6520 6a6f 6220  ,  # Ensure job 
+0000a9b0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+0000a9c0: 2020 2020 2020 2066 2772 636c 6f6e 6520         f'rclone 
+0000a9d0: 6c73 207b 6275 636b 6574 5f72 636c 6f6e  ls {bucket_rclon
+0000a9e0: 655f 7072 6f66 696c 657d 3a7b 7374 6f72  e_profile}:{stor
+0000a9f0: 6167 655f 6e61 6d65 7d2f 6865 6c6c 6f2e  age_name}/hello.
+0000aa00: 7478 7427 2c0a 2020 2020 2020 2020 5d0a  txt',.        ].
+0000aa10: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
+0000aa20: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
+0000aa30: 2027 6962 6d5f 7374 6f72 6167 655f 6d6f   'ibm_storage_mo
+0000aa40: 756e 7473 272c 0a20 2020 2020 2020 2020  unts',.         
+0000aa50: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
+0000aa60: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000aa70: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0000aa80: 657d 3b20 736b 7920 7374 6f72 6167 6520  e}; sky storage 
+0000aa90: 6465 6c65 7465 202d 7920 7b73 746f 7261  delete -y {stora
+0000aaa0: 6765 5f6e 616d 657d 272c 0a20 2020 2020  ge_name}',.     
+0000aab0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0000aac0: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+0000aad0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
+0000aae0: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+0000aaf0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+0000ab00: 2d2d 2d2d 2d2d 2043 4c49 206c 6f67 7320  ------ CLI logs 
+0000ab10: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+0000ab20: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+0000ab30: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+0000ab40: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
+0000ab50: 203e 2031 2079 6574 2e20 5275 6e20 7465   > 1 yet. Run te
+0000ab60: 7374 5f73 6370 5f6c 6f67 7320 696e 7374  st_scp_logs inst
+0000ab70: 6561 642e 0a64 6566 2074 6573 745f 636c  ead..def test_cl
+0000ab80: 695f 6c6f 6773 2867 656e 6572 6963 5f63  i_logs(generic_c
+0000ab90: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000aba0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000abb0: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
+0000abc0: 756d 5f6e 6f64 6573 203d 2032 0a20 2020  um_nodes = 2.   
+0000abd0: 2069 6620 6765 6e65 7269 635f 636c 6f75   if generic_clou
+0000abe0: 6420 3d3d 2027 6b75 6265 726e 6574 6573  d == 'kubernetes
+0000abf0: 273a 0a20 2020 2020 2020 2023 204b 7562  ':.        # Kub
+0000ac00: 6572 6e65 7465 7320 646f 6573 206e 6f74  ernetes does not
+0000ac10: 2073 7570 706f 7274 206d 756c 7469 2d6e   support multi-n
+0000ac20: 6f64 650a 2020 2020 2020 2020 6e75 6d5f  ode.        num_
+0000ac30: 6e6f 6465 7320 3d20 310a 2020 2020 7469  nodes = 1.    ti
+0000ac40: 6d65 7374 616d 7020 3d20 7469 6d65 2e74  mestamp = time.t
+0000ac50: 696d 6528 290a 2020 2020 7465 7374 203d  ime().    test =
+0000ac60: 2054 6573 7428 2763 6c69 5f6c 6f67 7327   Test('cli_logs'
+0000ac70: 2c20 5b0a 2020 2020 2020 2020 6627 736b  , [.        f'sk
+0000ac80: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000ac90: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+0000aca0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+0000acb0: 6e75 6d2d 6e6f 6465 7320 7b6e 756d 5f6e  num-nodes {num_n
+0000acc0: 6f64 6573 7d20 2265 6368 6f20 7b74 696d  odes} "echo {tim
+0000acd0: 6573 7461 6d70 7d20 3122 272c 0a20 2020  estamp} 1"',.   
+0000ace0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000acf0: 7b6e 616d 657d 2022 6563 686f 207b 7469  {name} "echo {ti
+0000ad00: 6d65 7374 616d 707d 2032 2227 2c0a 2020  mestamp} 2"',.  
+0000ad10: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000ad20: 207b 6e61 6d65 7d20 2265 6368 6f20 7b74   {name} "echo {t
+0000ad30: 696d 6573 7461 6d70 7d20 3322 272c 0a20  imestamp} 3"',. 
+0000ad40: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000ad50: 6320 7b6e 616d 657d 2022 6563 686f 207b  c {name} "echo {
+0000ad60: 7469 6d65 7374 616d 707d 2034 2227 2c0a  timestamp} 4"',.
+0000ad70: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000ad80: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+0000ad90: 6174 7573 272c 0a20 2020 2020 2020 2066  atus',.        f
+0000ada0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000adb0: 2033 2034 202d 2d73 796e 632d 646f 776e   3 4 --sync-down
+0000adc0: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
+0000add0: 206c 6f67 7320 7b6e 616d 657d 202a 202d   logs {name} * -
+0000ade0: 2d73 796e 632d 646f 776e 272c 0a20 2020  -sync-down',.   
+0000adf0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000ae00: 7b6e 616d 657d 2031 207c 2067 7265 7020  {name} 1 | grep 
+0000ae10: 227b 7469 6d65 7374 616d 707d 2031 2227  "{timestamp} 1"'
+0000ae20: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000ae30: 6c6f 6773 207b 6e61 6d65 7d20 7c20 6772  logs {name} | gr
+0000ae40: 6570 2022 7b74 696d 6573 7461 6d70 7d20  ep "{timestamp} 
+0000ae50: 3422 272c 0a20 2020 205d 2c20 6627 736b  4"',.    ], f'sk
+0000ae60: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0000ae70: 2729 0a20 2020 2072 756e 5f6f 6e65 5f74  ').    run_one_t
+0000ae80: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+0000ae90: 6573 742e 6d61 726b 2e73 6370 0a64 6566  est.mark.scp.def
+0000aea0: 2074 6573 745f 7363 705f 6c6f 6773 2829   test_scp_logs()
+0000aeb0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000aec0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000aed0: 0a20 2020 2074 696d 6573 7461 6d70 203d  .    timestamp =
+0000aee0: 2074 696d 652e 7469 6d65 2829 0a20 2020   time.time().   
+0000aef0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000af00: 2020 2020 2020 2753 4350 5f63 6c69 5f6c        'SCP_cli_l
+0000af10: 6f67 7327 2c0a 2020 2020 2020 2020 5b0a  ogs',.        [.
+0000af20: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000af30: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000af40: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+0000af50: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
+0000af60: 707d 2031 2227 2c0a 2020 2020 2020 2020  p} 1"',.        
+0000af70: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000af80: 6e61 6d65 7d20 2265 6368 6f20 7b74 696d  name} "echo {tim
+0000af90: 6573 7461 6d70 7d20 3222 272c 0a20 2020  estamp} 2"',.   
+0000afa0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000afb0: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
+0000afc0: 207b 7469 6d65 7374 616d 707d 2033 2227   {timestamp} 3"'
+0000afd0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000afe0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000aff0: 2265 6368 6f20 7b74 696d 6573 7461 6d70  "echo {timestamp
+0000b000: 7d20 3422 272c 0a20 2020 2020 2020 2020  } 4"',.         
+0000b010: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000b020: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+0000b030: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000b040: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000b050: 3320 3420 2d2d 7379 6e63 2d64 6f77 6e27  3 4 --sync-down'
+0000b060: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000b070: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000b080: 2a20 2d2d 7379 6e63 2d64 6f77 6e27 2c0a  * --sync-down',.
+0000b090: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000b0a0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+0000b0b0: 7c20 6772 6570 2022 7b74 696d 6573 7461  | grep "{timesta
+0000b0c0: 6d70 7d20 3122 272c 0a20 2020 2020 2020  mp} 1"',.       
+0000b0d0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000b0e0: 7b6e 616d 657d 207c 2067 7265 7020 227b  {name} | grep "{
+0000b0f0: 7469 6d65 7374 616d 707d 2034 2227 2c0a  timestamp} 4"',.
+0000b100: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000b110: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0000b120: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+0000b130: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0000b140: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+0000b150: 2d2d 2d2d 2d20 4a6f 6220 5175 6575 652e  ----- Job Queue.
+0000b160: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+0000b170: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+0000b180: 6473 7461 636b 2020 2320 466c 7569 6453  dstack  # FluidS
+0000b190: 7461 636b 2044 4320 6861 7320 6c6f 7720  tack DC has low 
+0000b1a0: 6176 6169 6c61 6269 6c69 7479 206f 6620  availability of 
+0000b1b0: 5434 2047 5055 730a 4070 7974 6573 742e  T4 GPUs.@pytest.
+0000b1c0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+0000b1d0: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+0000b1e0: 6c6f 7564 2064 6f65 7320 6e6f 7420 6861  loud does not ha
+0000b1f0: 7665 2054 3420 6770 7573 0a40 7079 7465  ve T4 gpus.@pyte
+0000b200: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
+0000b210: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
+0000b220: 206e 6f74 2068 6176 6520 5434 2067 7075   not have T4 gpu
+0000b230: 732e 2072 756e 2074 6573 745f 6962 6d5f  s. run test_ibm_
+0000b240: 6a6f 625f 7175 6575 6520 696e 7374 6561  job_queue instea
+0000b250: 640a 4070 7974 6573 742e 6d61 726b 2e6e  d.@pytest.mark.n
+0000b260: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+0000b270: 7320 6e6f 7420 6861 7665 2054 3420 6770  s not have T4 gp
+0000b280: 7573 2e20 5275 6e20 7465 7374 5f73 6370  us. Run test_scp
+0000b290: 5f6a 6f62 5f71 7565 7565 2069 6e73 7465  _job_queue inste
+0000b2a0: 6164 0a40 7079 7465 7374 2e6d 6172 6b2e  ad.@pytest.mark.
+0000b2b0: 6e6f 5f70 6170 6572 7370 6163 6520 2023  no_paperspace  #
+0000b2c0: 2050 6170 6572 7370 6163 6520 646f 6573   Paperspace does
+0000b2d0: 206e 6f74 2068 6176 6520 5434 2067 7075   not have T4 gpu
+0000b2e0: 732e 0a40 7079 7465 7374 2e6d 6172 6b2e  s..@pytest.mark.
+0000b2f0: 6e6f 5f6f 6369 2020 2320 4f43 4920 646f  no_oci  # OCI do
+0000b300: 6573 206e 6f74 2068 6176 6520 5434 2067  es not have T4 g
+0000b310: 7075 730a 6465 6620 7465 7374 5f6a 6f62  pus.def test_job
+0000b320: 5f71 7565 7565 2867 656e 6572 6963 5f63  _queue(generic_c
+0000b330: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000b340: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000b350: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000b360: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000b370: 2020 2020 276a 6f62 5f71 7565 7565 272c      'job_queue',
+0000b380: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0000b390: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0000b3a0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+0000b3b0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+0000b3c0: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
+0000b3d0: 732f 6a6f 625f 7175 6575 652f 636c 7573  s/job_queue/clus
+0000b3e0: 7465 722e 7961 6d6c 272c 0a20 2020 2020  ter.yaml',.     
+0000b3f0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000b400: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+0000b410: 657d 2d31 202d 6420 6578 616d 706c 6573  e}-1 -d examples
+0000b420: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 2e79  /job_queue/job.y
+0000b430: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000b440: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000b450: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3220  me} -n {name}-2 
+0000b460: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
+0000b470: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
+0000b480: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000b490: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000b4a0: 6e20 7b6e 616d 657d 2d33 202d 6420 6578  n {name}-3 -d ex
+0000b4b0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+0000b4c0: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
+0000b4d0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+0000b4e0: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
+0000b4f0: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+0000b500: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+0000b510: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000b520: 3120 7c20 6772 6570 2052 554e 4e49 4e47  1 | grep RUNNING
+0000b530: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b540: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000b550: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+0000b560: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+0000b570: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000b580: 7b6e 616d 657d 2d32 207c 2067 7265 7020  {name}-2 | grep 
+0000b590: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
+0000b5a0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000b5b0: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
+0000b5c0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+0000b5d0: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+0000b5e0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0000b5f0: 7c20 6772 6570 2050 454e 4449 4e47 272c  | grep PENDING',
+0000b600: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000b610: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
+0000b620: 6d65 7d20 3227 2c0a 2020 2020 2020 2020  me} 2',.        
+0000b630: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+0000b640: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000b650: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000b660: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+0000b670: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+0000b680: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000b690: 657d 2d33 207c 2067 7265 7020 5255 4e4e  e}-3 | grep RUNN
+0000b6a0: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+0000b6b0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
+0000b6c0: 7920 7b6e 616d 657d 2033 272c 0a20 2020  y {name} 3',.   
+0000b6d0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000b6e0: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
+0000b6f0: 7320 5434 3a30 2e32 2022 5b5b 205c 2453  s T4:0.2 "[[ \$S
+0000b700: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
+0000b710: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
+0000b720: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
+0000b730: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000b740: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+0000b750: 6770 7573 2054 343a 3120 225b 5b20 5c24  gpus T4:1 "[[ \$
+0000b760: 534b 5950 494c 4f54 5f4e 554d 5f47 5055  SKYPILOT_NUM_GPU
+0000b770: 535f 5045 525f 4e4f 4445 202d 6571 2031  S_PER_NODE -eq 1
+0000b780: 205d 5d20 7c7c 2065 7869 7420 3122 272c   ]] || exit 1"',
+0000b790: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000b7a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2034  ky logs {name} 4
+0000b7b0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0000b7c0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000b7d0: 6773 207b 6e61 6d65 7d20 3520 2d2d 7374  gs {name} 5 --st
+0000b7e0: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+0000b7f0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000b800: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000b810: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0000b820: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000b830: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 204a 6f62  # ---------- Job
+0000b840: 2051 7565 7565 2077 6974 6820 446f 636b   Queue with Dock
+0000b850: 6572 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  er. ----------.@
+0000b860: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+0000b870: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
+0000b880: 6964 5374 6163 6b20 646f 6573 206e 6f74  idStack does not
+0000b890: 2073 7570 706f 7274 2064 6f63 6b65 7220   support docker 
+0000b8a0: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
+0000b8b0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+0000b8c0: 6c6f 7564 2020 2320 446f 6573 6e27 7420  loud  # Doesn't 
+0000b8d0: 7375 7070 6f72 7420 4c61 6d62 6461 2043  support Lambda C
+0000b8e0: 6c6f 7564 2066 6f72 206e 6f77 0a40 7079  loud for now.@py
+0000b8f0: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
+0000b900: 2020 2320 446f 6573 6e27 7420 7375 7070    # Doesn't supp
+0000b910: 6f72 7420 4942 4d20 436c 6f75 6420 666f  ort IBM Cloud fo
+0000b920: 7220 6e6f 770a 4070 7974 6573 742e 6d61  r now.@pytest.ma
+0000b930: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+0000b940: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
+0000b950: 6f65 736e 2774 2068 6176 6520 5434 2047  oesn't have T4 G
+0000b960: 5055 730a 4070 7974 6573 742e 6d61 726b  PUs.@pytest.mark
+0000b970: 2e6e 6f5f 7363 7020 2023 2044 6f65 736e  .no_scp  # Doesn
+0000b980: 2774 2073 7570 706f 7274 2053 4350 2066  't support SCP f
+0000b990: 6f72 206e 6f77 0a40 7079 7465 7374 2e6d  or now.@pytest.m
+0000b9a0: 6172 6b2e 6e6f 5f6f 6369 2020 2320 446f  ark.no_oci  # Do
+0000b9b0: 6573 6e27 7420 7375 7070 6f72 7420 4f43  esn't support OC
+0000b9c0: 4920 666f 7220 6e6f 770a 4070 7974 6573  I for now.@pytes
+0000b9d0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+0000b9e0: 6574 6573 2020 2320 446f 6573 6e27 7420  etes  # Doesn't 
+0000b9f0: 7375 7070 6f72 7420 4b75 6265 726e 6574  support Kubernet
+0000ba00: 6573 2066 6f72 206e 6f77 0a40 7079 7465  es for now.@pyte
+0000ba10: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+0000ba20: 697a 6528 0a20 2020 2022 696d 6167 655f  ize(.    "image_
+0000ba30: 6964 222c 0a20 2020 205b 0a20 2020 2020  id",.    [.     
+0000ba40: 2020 2022 646f 636b 6572 3a6e 7669 6469     "docker:nvidi
+0000ba50: 612f 6375 6461 3a31 312e 382e 302d 6465  a/cuda:11.8.0-de
+0000ba60: 7665 6c2d 7562 756e 7475 3138 2e30 3422  vel-ubuntu18.04"
+0000ba70: 2c0a 2020 2020 2020 2020 2264 6f63 6b65  ,.        "docke
+0000ba80: 723a 7562 756e 7475 3a31 382e 3034 222c  r:ubuntu:18.04",
+0000ba90: 0a20 2020 2020 2020 2023 2054 6573 7420  .        # Test 
+0000baa0: 696d 6167 6520 7769 7468 2070 7974 686f  image with pytho
+0000bab0: 6e20 332e 3131 2069 6e73 7461 6c6c 6564  n 3.11 installed
+0000bac0: 2062 7920 6465 6661 756c 742e 0a20 2020   by default..   
+0000bad0: 2020 2020 2022 646f 636b 6572 3a63 6f6e       "docker:con
+0000bae0: 7469 6e75 756d 696f 2f6d 696e 6963 6f6e  tinuumio/minicon
+0000baf0: 6461 3322 2c0a 2020 2020 5d29 0a64 6566  da3",.    ]).def
+0000bb00: 2074 6573 745f 6a6f 625f 7175 6575 655f   test_job_queue_
+0000bb10: 7769 7468 5f64 6f63 6b65 7228 6765 6e65  with_docker(gene
+0000bb20: 7269 635f 636c 6f75 643a 2073 7472 2c20  ric_cloud: str, 
+0000bb30: 696d 6167 655f 6964 3a20 7374 7229 3a0a  image_id: str):.
+0000bb40: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0000bb50: 636c 7573 7465 725f 6e61 6d65 2829 202b  cluster_name() +
+0000bb60: 2069 6d61 6765 5f69 645b 6c65 6e28 2764   image_id[len('d
+0000bb70: 6f63 6b65 723a 2729 3a5d 5b3a 345d 0a20  ocker:'):][:4]. 
+0000bb80: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0000bb90: 2020 2020 2020 2020 276a 6f62 5f71 7565          'job_que
+0000bba0: 7565 5f77 6974 685f 646f 636b 6572 272c  ue_with_docker',
+0000bbb0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0000bbc0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0000bbd0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+0000bbe0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+0000bbf0: 635f 636c 6f75 647d 202d 2d69 6d61 6765  c_cloud} --image
+0000bc00: 2d69 6420 7b69 6d61 6765 5f69 647d 2065  -id {image_id} e
+0000bc10: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000bc20: 652f 636c 7573 7465 725f 646f 636b 6572  e/cluster_docker
+0000bc30: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000bc40: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000bc50: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000bc60: 3120 2d64 202d 2d69 6d61 6765 2d69 6420  1 -d --image-id 
+0000bc70: 7b69 6d61 6765 5f69 647d 2065 7861 6d70  {image_id} examp
+0000bc80: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
+0000bc90: 625f 646f 636b 6572 2e79 616d 6c27 2c0a  b_docker.yaml',.
+0000bca0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000bcb0: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
+0000bcc0: 207b 6e61 6d65 7d2d 3220 2d64 202d 2d69   {name}-2 -d --i
+0000bcd0: 6d61 6765 2d69 6420 7b69 6d61 6765 5f69  mage-id {image_i
+0000bce0: 647d 2065 7861 6d70 6c65 732f 6a6f 625f  d} examples/job_
+0000bcf0: 7175 6575 652f 6a6f 625f 646f 636b 6572  queue/job_docker
+0000bd00: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000bd10: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000bd20: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000bd30: 3320 2d64 202d 2d69 6d61 6765 2d69 6420  3 -d --image-id 
+0000bd40: 7b69 6d61 6765 5f69 647d 2065 7861 6d70  {image_id} examp
+0000bd50: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
+0000bd60: 625f 646f 636b 6572 2e79 616d 6c27 2c0a  b_docker.yaml',.
+0000bd70: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000bd80: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000bd90: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+0000bda0: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+0000bdb0: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000bdc0: 6d65 7d2d 3120 7c20 6772 6570 2052 554e  me}-1 | grep RUN
+0000bdd0: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
+0000bde0: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
+0000bdf0: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
+0000be00: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
+0000be10: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
+0000be20: 7265 7020 7b6e 616d 657d 2d32 207c 2067  rep {name}-2 | g
+0000be30: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
+0000be40: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000be50: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000be60: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+0000be70: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+0000be80: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000be90: 7d2d 3320 7c20 6772 6570 2050 454e 4449  }-3 | grep PENDI
+0000bea0: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0000beb0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000bec0: 207b 6e61 6d65 7d20 3227 2c0a 2020 2020   {name} 2',.    
+0000bed0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0000bee0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000bef0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000bf00: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+0000bf10: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+0000bf20: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000bf30: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
+0000bf40: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
+0000bf50: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
+0000bf60: 656c 202d 7920 7b6e 616d 657d 2033 272c  el -y {name} 3',
+0000bf70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000bf80: 6b79 2073 746f 7020 2d79 207b 6e61 6d65  ky stop -y {name
+0000bf90: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0000bfa0: 2320 4d61 6b65 2073 7572 6520 7468 6520  # Make sure the 
+0000bfb0: 6a6f 6220 7374 6174 7573 2070 7265 7365  job status prese
+0000bfc0: 7276 6520 6166 7465 7220 7374 6f70 2061  rve after stop a
+0000bfd0: 6e64 2073 7461 7274 2074 6865 0a20 2020  nd start the.   
+0000bfe0: 2020 2020 2020 2020 2023 2063 6c75 7374           # clust
+0000bff0: 6572 2e20 5468 6973 2069 7320 616c 736f  er. This is also
+0000c000: 2061 2074 6573 7420 666f 7220 7468 6520   a test for the 
+0000c010: 646f 636b 6572 2063 6f6e 7461 696e 6572  docker container
+0000c020: 2074 6f20 6265 0a20 2020 2020 2020 2020   to be.         
+0000c030: 2020 2023 2070 7265 7365 7276 6564 2061     # preserved a
+0000c040: 6674 6572 2073 746f 7020 616e 6420 7374  fter stop and st
+0000c050: 6172 742e 0a20 2020 2020 2020 2020 2020  art..           
+0000c060: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
+0000c070: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+0000c080: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000c090: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
+0000c0a0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000c0b0: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+0000c0c0: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+0000c0d0: 2067 7265 7020 4641 494c 4544 272c 0a20   grep FAILED',. 
+0000c0e0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000c0f0: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000c100: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+0000c110: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+0000c120: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000c130: 657d 2d32 207c 2067 7265 7020 4341 4e43  e}-2 | grep CANC
+0000c140: 454c 4c45 4427 2c0a 2020 2020 2020 2020  ELLED',.        
+0000c150: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000c160: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
+0000c170: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+0000c180: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
+0000c190: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
+0000c1a0: 6772 6570 2043 414e 4345 4c4c 4544 272c  grep CANCELLED',
+0000c1b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c1c0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000c1d0: 2d67 7075 7320 5434 3a30 2e32 2022 5b5b  -gpus T4:0.2 "[[
+0000c1e0: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
+0000c1f0: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
+0000c200: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
+0000c210: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000c220: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000c230: 7d20 2d2d 6770 7573 2054 343a 3120 225b  } --gpus T4:1 "[
+0000c240: 5b20 5c24 534b 5950 494c 4f54 5f4e 554d  [ \$SKYPILOT_NUM
+0000c250: 5f47 5055 535f 5045 525f 4e4f 4445 202d  _GPUS_PER_NODE -
+0000c260: 6571 2031 205d 5d20 7c7c 2065 7869 7420  eq 1 ]] || exit 
+0000c270: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
+0000c280: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000c290: 657d 2034 202d 2d73 7461 7475 7327 2c0a  e} 4 --status',.
+0000c2a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000c2b0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3520  y logs {name} 5 
+0000c2c0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+0000c2d0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+0000c2e0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0000c2f0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+0000c300: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000c310: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0000c320: 2e6c 616d 6264 615f 636c 6f75 640a 6465  .lambda_cloud.de
+0000c330: 6620 7465 7374 5f6c 616d 6264 615f 6a6f  f test_lambda_jo
+0000c340: 625f 7175 6575 6528 293a 0a20 2020 206e  b_queue():.    n
+0000c350: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0000c360: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+0000c370: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0000c380: 2020 2027 6c61 6d62 6461 5f6a 6f62 5f71     'lambda_job_q
+0000c390: 7565 7565 272c 0a20 2020 2020 2020 205b  ueue',.        [
+0000c3a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c3b0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000c3c0: 7b6e 616d 657d 207b 4c41 4d42 4441 5f54  {name} {LAMBDA_T
+0000c3d0: 5950 457d 2065 7861 6d70 6c65 732f 6a6f  YPE} examples/jo
+0000c3e0: 625f 7175 6575 652f 636c 7573 7465 722e  b_queue/cluster.
+0000c3f0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000c400: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000c410: 616d 657d 202d 6e20 7b6e 616d 657d 2d31  ame} -n {name}-1
+0000c420: 202d 2d67 7075 7320 4131 303a 302e 3520   --gpus A10:0.5 
+0000c430: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
+0000c440: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
+0000c450: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c460: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000c470: 6e20 7b6e 616d 657d 2d32 202d 2d67 7075  n {name}-2 --gpu
+0000c480: 7320 4131 303a 302e 3520 2d64 2065 7861  s A10:0.5 -d exa
+0000c490: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
+0000c4a0: 6a6f 622e 7961 6d6c 272c 0a20 2020 2020  job.yaml',.     
+0000c4b0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000c4c0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+0000c4d0: 657d 2d33 202d 2d67 7075 7320 4131 303a  e}-3 --gpus A10:
+0000c4e0: 302e 3520 2d64 2065 7861 6d70 6c65 732f  0.5 -d examples/
+0000c4f0: 6a6f 625f 7175 6575 652f 6a6f 622e 7961  job_queue/job.ya
+0000c500: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000c510: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
+0000c520: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
+0000c530: 7d2d 3120 7c20 6772 6570 2052 554e 4e49  }-1 | grep RUNNI
+0000c540: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0000c550: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
+0000c560: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
+0000c570: 7d2d 3220 7c20 6772 6570 2052 554e 4e49  }-2 | grep RUNNI
+0000c580: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0000c590: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
+0000c5a0: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
+0000c5b0: 7d2d 3320 7c20 6772 6570 2050 454e 4449  }-3 | grep PENDI
+0000c5c0: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0000c5d0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000c5e0: 207b 6e61 6d65 7d20 3227 2c0a 2020 2020   {name} 2',.    
+0000c5f0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0000c600: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000c610: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
+0000c620: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
+0000c630: 3320 7c20 6772 6570 2052 554e 4e49 4e47  3 | grep RUNNING
+0000c640: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000c650: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000c660: 6e61 6d65 7d20 3327 2c0a 2020 2020 2020  name} 3',.      
+0000c670: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+0000c680: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+0000c690: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+0000c6a0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000c6b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+0000c6c0: 6962 6d0a 6465 6620 7465 7374 5f69 626d  ibm.def test_ibm
+0000c6d0: 5f6a 6f62 5f71 7565 7565 2829 3a0a 2020  _job_queue():.  
+0000c6e0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0000c6f0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0000c700: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000c710: 2020 2020 2020 2769 626d 5f6a 6f62 5f71        'ibm_job_q
+0000c720: 7565 7565 272c 0a20 2020 2020 2020 205b  ueue',.        [
+0000c730: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c740: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000c750: 7b6e 616d 657d 202d 2d63 6c6f 7564 2069  {name} --cloud i
+0000c760: 626d 202d 2d67 7075 7320 7631 3030 272c  bm --gpus v100',
+0000c770: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c780: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000c790: 6e20 7b6e 616d 657d 2d31 202d 2d63 6c6f  n {name}-1 --clo
+0000c7a0: 7564 2069 626d 202d 6420 6578 616d 706c  ud ibm -d exampl
+0000c7b0: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
+0000c7c0: 5f69 626d 2e79 616d 6c27 2c0a 2020 2020  _ibm.yaml',.    
+0000c7d0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000c7e0: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
+0000c7f0: 6d65 7d2d 3220 2d2d 636c 6f75 6420 6962  me}-2 --cloud ib
+0000c800: 6d20 2d64 2065 7861 6d70 6c65 732f 6a6f  m -d examples/jo
+0000c810: 625f 7175 6575 652f 6a6f 625f 6962 6d2e  b_queue/job_ibm.
+0000c820: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000c830: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000c840: 616d 657d 202d 6e20 7b6e 616d 657d 2d33  ame} -n {name}-3
+0000c850: 202d 2d63 6c6f 7564 2069 626d 202d 6420   --cloud ibm -d 
+0000c860: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+0000c870: 7565 2f6a 6f62 5f69 626d 2e79 616d 6c27  ue/job_ibm.yaml'
+0000c880: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c890: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000c8a0: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+0000c8b0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+0000c8c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c8d0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000c8e0: 207c 2067 7265 7020 7b6e 616d 657d 2d32   | grep {name}-2
+0000c8f0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+0000c900: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c910: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000c920: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
+0000c930: 207c 2067 7265 7020 5045 4e44 494e 4727   | grep PENDING'
+0000c940: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c950: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+0000c960: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
+0000c970: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+0000c980: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000c990: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+0000c9a0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0000c9b0: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+0000c9c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000c9d0: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+0000c9e0: 657d 2033 272c 0a20 2020 2020 2020 205d  e} 3',.        ]
+0000c9f0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000ca00: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000ca10: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0000ca20: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000ca30: 4070 7974 6573 742e 6d61 726b 2e73 6370  @pytest.mark.scp
+0000ca40: 0a64 6566 2074 6573 745f 7363 705f 6a6f  .def test_scp_jo
+0000ca50: 625f 7175 6575 6528 293a 0a20 2020 206e  b_queue():.    n
+0000ca60: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0000ca70: 6572 5f6e 616d 6528 290a 2020 2020 6e75  er_name().    nu
+0000ca80: 6d5f 6f66 5f67 7075 5f6c 6175 6e63 6820  m_of_gpu_launch 
+0000ca90: 3d20 310a 2020 2020 6e75 6d5f 6f66 5f67  = 1.    num_of_g
+0000caa0: 7075 5f65 7865 6320 3d20 302e 350a 2020  pu_exec = 0.5.  
+0000cab0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000cac0: 2020 2020 2020 2027 5343 505f 6a6f 625f         'SCP_job_
+0000cad0: 7175 6575 6527 2c0a 2020 2020 2020 2020  queue',.        
+0000cae0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0000caf0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0000cb00: 207b 6e61 6d65 7d20 7b53 4350 5f54 5950   {name} {SCP_TYP
+0000cb10: 457d 207b 5343 505f 4750 555f 5631 3030  E} {SCP_GPU_V100
+0000cb20: 7d3a 7b6e 756d 5f6f 665f 6770 755f 6c61  }:{num_of_gpu_la
+0000cb30: 756e 6368 7d20 6578 616d 706c 6573 2f6a  unch} examples/j
+0000cb40: 6f62 5f71 7565 7565 2f63 6c75 7374 6572  ob_queue/cluster
+0000cb50: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000cb60: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000cb70: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000cb80: 3120 7b53 4350 5f47 5055 5f56 3130 307d  1 {SCP_GPU_V100}
+0000cb90: 3a7b 6e75 6d5f 6f66 5f67 7075 5f65 7865  :{num_of_gpu_exe
+0000cba0: 637d 202d 6420 6578 616d 706c 6573 2f6a  c} -d examples/j
+0000cbb0: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
+0000cbc0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000cbd0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000cbe0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 7b53  } -n {name}-2 {S
+0000cbf0: 4350 5f47 5055 5f56 3130 307d 3a7b 6e75  CP_GPU_V100}:{nu
+0000cc00: 6d5f 6f66 5f67 7075 5f65 7865 637d 202d  m_of_gpu_exec} -
+0000cc10: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
+0000cc20: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
+0000cc30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000cc40: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
+0000cc50: 207b 6e61 6d65 7d2d 3320 7b53 4350 5f47   {name}-3 {SCP_G
+0000cc60: 5055 5f56 3130 307d 3a7b 6e75 6d5f 6f66  PU_V100}:{num_of
+0000cc70: 5f67 7075 5f65 7865 637d 202d 6420 6578  _gpu_exec} -d ex
+0000cc80: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+0000cc90: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
+0000cca0: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
+0000ccb0: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
+0000ccc0: 7020 7b6e 616d 657d 2d31 207c 2067 7265  p {name}-1 | gre
+0000ccd0: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
+0000cce0: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
+0000ccf0: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
+0000cd00: 7020 7b6e 616d 657d 2d32 207c 2067 7265  p {name}-2 | gre
+0000cd10: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
+0000cd20: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
+0000cd30: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
+0000cd40: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
+0000cd50: 7020 5045 4e44 494e 4727 2c0a 2020 2020  p PENDING',.    
+0000cd60: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
+0000cd70: 6e63 656c 202d 7920 7b6e 616d 657d 2032  ncel -y {name} 2
+0000cd80: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0000cd90: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
+0000cda0: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
+0000cdb0: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
+0000cdc0: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
+0000cdd0: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
+0000cde0: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
+0000cdf0: 656c 202d 7920 7b6e 616d 657d 2033 272c  el -y {name} 3',
+0000ce00: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0000ce10: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+0000ce20: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+0000ce30: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0000ce40: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+0000ce50: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+0000ce60: 7461 636b 2020 2320 466c 7569 6453 7461  tack  # FluidSta
+0000ce70: 636b 2044 4320 6861 7320 6c6f 7720 6176  ck DC has low av
+0000ce80: 6169 6c61 6269 6c69 7479 206f 6620 5434  ailability of T4
+0000ce90: 2047 5055 730a 4070 7974 6573 742e 6d61   GPUs.@pytest.ma
+0000cea0: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
+0000ceb0: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
+0000cec0: 7564 2064 6f65 7320 6e6f 7420 6861 7665  ud does not have
+0000ced0: 2054 3420 6770 7573 0a40 7079 7465 7374   T4 gpus.@pytest
+0000cee0: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
+0000cef0: 4942 4d20 436c 6f75 6420 646f 6573 206e  IBM Cloud does n
+0000cf00: 6f74 2068 6176 6520 5434 2067 7075 732e  ot have T4 gpus.
+0000cf10: 2072 756e 2074 6573 745f 6962 6d5f 6a6f   run test_ibm_jo
+0000cf20: 625f 7175 6575 655f 6d75 6c74 696e 6f64  b_queue_multinod
+0000cf30: 6520 696e 7374 6561 640a 4070 7974 6573  e instead.@pytes
+0000cf40: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
+0000cf50: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
+0000cf60: 6365 2064 6f65 7320 6e6f 7420 6861 7665  ce does not have
+0000cf70: 2054 3420 6770 7573 2e0a 4070 7974 6573   T4 gpus..@pytes
+0000cf80: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+0000cf90: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
+0000cfa0: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
+0000cfb0: 3e20 3120 7965 740a 4070 7974 6573 742e  > 1 yet.@pytest.
+0000cfc0: 6d61 726b 2e6e 6f5f 6f63 6920 2023 204f  mark.no_oci  # O
+0000cfd0: 4349 2043 6c6f 7564 2064 6f65 7320 6e6f  CI Cloud does no
+0000cfe0: 7420 6861 7665 2054 3420 6770 7573 2e0a  t have T4 gpus..
+0000cff0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000d000: 6b75 6265 726e 6574 6573 2020 2320 4b75  kubernetes  # Ku
+0000d010: 6265 726e 6574 6573 206e 6f74 2073 7570  bernetes not sup
+0000d020: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
+0000d030: 2031 2079 6574 0a64 6566 2074 6573 745f   1 yet.def test_
+0000d040: 6a6f 625f 7175 6575 655f 6d75 6c74 696e  job_queue_multin
+0000d050: 6f64 6528 6765 6e65 7269 635f 636c 6f75  ode(generic_clou
+0000d060: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+0000d070: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0000d080: 5f6e 616d 6528 290a 2020 2020 746f 7461  _name().    tota
+0000d090: 6c5f 7469 6d65 6f75 745f 6d69 6e75 7465  l_timeout_minute
+0000d0a0: 7320 3d20 3330 2069 6620 6765 6e65 7269  s = 30 if generi
+0000d0b0: 635f 636c 6f75 6420 3d3d 2027 617a 7572  c_cloud == 'azur
+0000d0c0: 6527 2065 6c73 6520 3135 0a20 2020 2074  e' else 15.    t
+0000d0d0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000d0e0: 2020 2020 276a 6f62 5f71 7565 7565 5f6d      'job_queue_m
+0000d0f0: 756c 7469 6e6f 6465 272c 0a20 2020 2020  ultinode',.     
+0000d100: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0000d110: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000d120: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+0000d130: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+0000d140: 647d 2065 7861 6d70 6c65 732f 6a6f 625f  d} examples/job_
+0000d150: 7175 6575 652f 636c 7573 7465 725f 6d75  queue/cluster_mu
+0000d160: 6c74 696e 6f64 652e 7961 6d6c 272c 0a20  ltinode.yaml',. 
+0000d170: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000d180: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
+0000d190: 7b6e 616d 657d 2d31 202d 6420 6578 616d  {name}-1 -d exam
+0000d1a0: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
+0000d1b0: 6f62 5f6d 756c 7469 6e6f 6465 2e79 616d  ob_multinode.yam
+0000d1c0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000d1d0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000d1e0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 2d64  } -n {name}-2 -d
+0000d1f0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+0000d200: 6575 652f 6a6f 625f 6d75 6c74 696e 6f64  eue/job_multinod
+0000d210: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
+0000d220: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000d230: 6820 2d63 207b 6e61 6d65 7d20 2d6e 207b  h -c {name} -n {
+0000d240: 6e61 6d65 7d2d 3320 2d2d 6465 7461 6368  name}-3 --detach
+0000d250: 2d73 6574 7570 202d 6420 6578 616d 706c  -setup -d exampl
+0000d260: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
+0000d270: 5f6d 756c 7469 6e6f 6465 2e79 616d 6c27  _multinode.yaml'
+0000d280: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000d290: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000d2a0: 616d 657d 2920 2626 2065 6368 6f20 2224  ame}) && echo "$
+0000d2b0: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
+0000d2c0: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+0000d2d0: 207c 2067 7265 7020 5255 4e4e 494e 4729   | grep RUNNING)
+0000d2e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000d2f0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000d300: 6e61 6d65 7d29 2026 2620 6563 686f 2022  name}) && echo "
+0000d310: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
+0000d320: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000d330: 3220 7c20 6772 6570 2052 554e 4e49 4e47  2 | grep RUNNING
+0000d340: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
+0000d350: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000d360: 7b6e 616d 657d 2920 2626 2065 6368 6f20  {name}) && echo 
+0000d370: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
+0000d380: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000d390: 2d33 207c 2067 7265 7020 5045 4e44 494e  -3 | grep PENDIN
+0000d3a0: 4729 272c 0a20 2020 2020 2020 2020 2020  G)',.           
+0000d3b0: 2027 736c 6565 7020 3930 272c 0a20 2020   'sleep 90',.   
+0000d3c0: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
+0000d3d0: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
+0000d3e0: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
+0000d3f0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+0000d400: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000d410: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+0000d420: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+0000d430: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+0000d440: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
+0000d450: 207c 2067 7265 7020 5345 5454 494e 475f   | grep SETTING_
+0000d460: 5550 272c 0a20 2020 2020 2020 2020 2020  UP',.           
+0000d470: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000d480: 207b 6e61 6d65 7d20 3120 3220 3327 2c0a   {name} 1 2 3',.
+0000d490: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000d4a0: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+0000d4b0: 657d 202d 6e20 7b6e 616d 657d 2d34 202d  e} -n {name}-4 -
+0000d4c0: 2d64 6574 6163 682d 7365 7475 7020 2d64  -detach-setup -d
+0000d4d0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+0000d4e0: 6575 652f 6a6f 625f 6d75 6c74 696e 6f64  eue/job_multinod
+0000d4f0: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
+0000d500: 2020 2020 2023 2054 6573 7420 7468 6520       # Test the 
+0000d510: 6a6f 6220 7374 6174 7573 2069 7320 636f  job status is co
+0000d520: 7272 6563 746c 7920 7365 7420 746f 2053  rrectly set to S
+0000d530: 4554 5449 4e47 5f55 502c 2064 7572 696e  ETTING_UP, durin
+0000d540: 6720 7468 6520 7365 7475 7020 6973 2072  g the setup is r
+0000d550: 756e 6e69 6e67 2c0a 2020 2020 2020 2020  unning,.        
+0000d560: 2020 2020 2320 616e 6420 7468 6520 6a6f      # and the jo
+0000d570: 6220 6361 6e20 6265 2063 616e 6365 6c6c  b can be cancell
+0000d580: 6564 2064 7572 696e 6720 7468 6520 7365  ed during the se
+0000d590: 7475 702e 0a20 2020 2020 2020 2020 2020  tup..           
+0000d5a0: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+0000d5b0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+0000d5c0: 7920 7175 6575 6520 7b6e 616d 657d 2920  y queue {name}) 
+0000d5d0: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
+0000d5e0: 2865 6368 6f20 2224 7322 207c 2067 7265  (echo "$s" | gre
+0000d5f0: 7020 7b6e 616d 657d 2d34 207c 2067 7265  p {name}-4 | gre
+0000d600: 7020 5345 5454 494e 475f 5550 2927 2c0a  p SETTING_UP)',.
+0000d610: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000d620: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+0000d630: 657d 2034 272c 0a20 2020 2020 2020 2020  e} 4',.         
+0000d640: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
+0000d650: 7565 207b 6e61 6d65 7d29 2026 2620 6563  ue {name}) && ec
+0000d660: 686f 2022 2473 2220 2626 2028 6563 686f  ho "$s" && (echo
+0000d670: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000d680: 6d65 7d2d 3420 7c20 6772 6570 2043 414e  me}-4 | grep CAN
+0000d690: 4345 4c4c 4544 2927 2c0a 2020 2020 2020  CELLED)',.      
+0000d6a0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000d6b0: 207b 6e61 6d65 7d20 2d2d 6770 7573 2054   {name} --gpus T
+0000d6c0: 343a 302e 3220 225b 5b20 5c24 534b 5950  4:0.2 "[[ \$SKYP
+0000d6d0: 494c 4f54 5f4e 554d 5f47 5055 535f 5045  ILOT_NUM_GPUS_PE
+0000d6e0: 525f 4e4f 4445 202d 6571 2031 205d 5d20  R_NODE -eq 1 ]] 
+0000d6f0: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
+0000d700: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000d710: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
+0000d720: 7320 5434 3a30 2e32 202d 2d6e 756d 2d6e  s T4:0.2 --num-n
+0000d730: 6f64 6573 2032 2022 5b5b 205c 2453 4b59  odes 2 "[[ \$SKY
+0000d740: 5049 4c4f 545f 4e55 4d5f 4750 5553 5f50  PILOT_NUM_GPUS_P
+0000d750: 4552 5f4e 4f44 4520 2d65 7120 3120 5d5d  ER_NODE -eq 1 ]]
+0000d760: 207c 7c20 6578 6974 2031 2227 2c0a 2020   || exit 1"',.  
+0000d770: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000d780: 6578 6563 207b 6e61 6d65 7d20 2d2d 6770  exec {name} --gp
+0000d790: 7573 2054 343a 3120 2d2d 6e75 6d2d 6e6f  us T4:1 --num-no
+0000d7a0: 6465 7320 3220 225b 5b20 5c24 534b 5950  des 2 "[[ \$SKYP
+0000d7b0: 494c 4f54 5f4e 554d 5f47 5055 535f 5045  ILOT_NUM_GPUS_PE
+0000d7c0: 525f 4e4f 4445 202d 6571 2031 205d 5d20  R_NODE -eq 1 ]] 
+0000d7d0: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
+0000d7e0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000d7f0: 6f67 7320 7b6e 616d 657d 2035 202d 2d73  ogs {name} 5 --s
+0000d800: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+0000d810: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000d820: 6e61 6d65 7d20 3620 2d2d 7374 6174 7573  name} 6 --status
+0000d830: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000d840: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000d850: 2037 202d 2d73 7461 7475 7327 2c0a 2020   7 --status',.  
+0000d860: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000d870: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000d880: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+0000d890: 7469 6d65 6f75 743d 746f 7461 6c5f 7469  timeout=total_ti
+0000d8a0: 6d65 6f75 745f 6d69 6e75 7465 7320 2a20  meout_minutes * 
+0000d8b0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+0000d8c0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000d8d0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+0000d8e0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+0000d8f0: 2023 204e 6f20 4c61 6d62 6461 2043 6c6f   # No Lambda Clo
+0000d900: 7564 2056 4d20 6861 7320 3820 4350 5573  ud VM has 8 CPUs
+0000d910: 0a64 6566 2074 6573 745f 6c61 7267 655f  .def test_large_
+0000d920: 6a6f 625f 7175 6575 6528 6765 6e65 7269  job_queue(generi
+0000d930: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+0000d940: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000d950: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000d960: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000d970: 2020 2020 2020 2027 6c61 7267 655f 6a6f         'large_jo
+0000d980: 625f 7175 6575 6527 2c0a 2020 2020 2020  b_queue',.      
+0000d990: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000d9a0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+0000d9b0: 2d63 207b 6e61 6d65 7d20 2d2d 6370 7573  -c {name} --cpus
+0000d9c0: 2038 202d 2d63 6c6f 7564 207b 6765 6e65   8 --cloud {gene
+0000d9d0: 7269 635f 636c 6f75 647d 272c 0a20 2020  ric_cloud}',.   
+0000d9e0: 2020 2020 2020 2020 2066 2766 6f72 2069           f'for i
+0000d9f0: 2069 6e20 6073 6571 2031 2037 3560 3b20   in `seq 1 75`; 
+0000da00: 646f 2073 6b79 2065 7865 6320 7b6e 616d  do sky exec {nam
+0000da10: 657d 202d 6e20 7b6e 616d 657d 2d24 6920  e} -n {name}-$i 
+0000da20: 2d64 2022 6563 686f 2024 693b 2073 6c65  -d "echo $i; sle
+0000da30: 6570 2031 3030 3030 3030 3030 223b 2064  ep 100000000"; d
+0000da40: 6f6e 6527 2c0a 2020 2020 2020 2020 2020  one',.          
+0000da50: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
+0000da60: 7920 7b6e 616d 657d 2031 2032 2033 2034  y {name} 1 2 3 4
+0000da70: 2035 2036 2037 2038 2039 2031 3020 3131   5 6 7 8 9 10 11
+0000da80: 2031 3220 3133 2031 3420 3135 2031 3627   12 13 14 15 16'
+0000da90: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0000daa0: 6c65 6570 2039 3027 2c0a 2020 2020 2020  leep 90',.      
+0000dab0: 2020 2020 2020 2320 4561 6368 206a 6f62        # Each job
+0000dac0: 2074 616b 6573 2030 2e35 2043 5055 2061   takes 0.5 CPU a
+0000dad0: 6e64 2074 6865 2064 6566 6175 6c74 2056  nd the default V
+0000dae0: 4d20 6861 7320 3820 4350 5573 2c20 736f  M has 8 CPUs, so
+0000daf0: 2074 6865 7265 2073 686f 756c 6420 6265   there should be
+0000db00: 2038 202f 2030 2e35 203d 2031 3620 6a6f   8 / 0.5 = 16 jo
+0000db10: 6273 2072 756e 6e69 6e67 2e0a 2020 2020  bs running..    
+0000db20: 2020 2020 2020 2020 2320 5468 6520 6669          # The fi
+0000db30: 7273 7420 3136 206a 6f62 7320 6172 6520  rst 16 jobs are 
+0000db40: 6361 6e63 656c 6564 2c20 736f 2074 6865  canceled, so the
+0000db50: 7265 2073 686f 756c 6420 6265 2037 3520  re should be 75 
+0000db60: 2d20 3332 203d 2034 3320 6a6f 6273 2050  - 32 = 43 jobs P
+0000db70: 454e 4449 4e47 2e0a 2020 2020 2020 2020  ENDING..        
+0000db80: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000db90: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
+0000dba0: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+0000dbb0: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
+0000dbc0: 6772 6570 202d 7620 6772 6570 207c 2067  grep -v grep | g
+0000dbd0: 7265 7020 5045 4e44 494e 4720 7c20 7763  rep PENDING | wc
+0000dbe0: 202d 6c20 7c20 6772 6570 2034 3327 2c0a   -l | grep 43',.
+0000dbf0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+0000dc00: 6b65 2073 7572 6520 7468 6520 6a6f 6273  ke sure the jobs
+0000dc10: 2061 7265 2073 6368 6564 756c 6564 2069   are scheduled i
+0000dc20: 6e20 4649 464f 206f 7264 6572 0a20 2020  n FIFO order.   
+0000dc30: 2020 2020 2020 2020 202a 5b0a 2020 2020           *[.    
+0000dc40: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000dc50: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000dc60: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+0000dc70: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+0000dc80: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000dc90: 6d65 7d2d 7b69 7d20 7c20 6772 6570 2043  me}-{i} | grep C
+0000dca0: 414e 4345 4c4c 4544 270a 2020 2020 2020  ANCELLED'.      
+0000dcb0: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+0000dcc0: 696e 2072 616e 6765 2831 2c20 3137 290a  in range(1, 17).
+0000dcd0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+0000dce0: 2020 2020 2020 2020 2020 202a 5b0a 2020             *[.  
+0000dcf0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000dd00: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000dd10: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+0000dd20: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+0000dd30: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000dd40: 6e61 6d65 7d2d 7b69 7d20 7c20 6772 6570  name}-{i} | grep
+0000dd50: 2052 554e 4e49 4e47 270a 2020 2020 2020   RUNNING'.      
+0000dd60: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+0000dd70: 696e 2072 616e 6765 2831 372c 2033 3329  in range(17, 33)
+0000dd80: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+0000dd90: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
+0000dda0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ddb0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000ddc0: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+0000ddd0: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+0000dde0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000ddf0: 7b6e 616d 657d 2d7b 697d 207c 2067 7265  {name}-{i} | gre
+0000de00: 7020 5045 4e44 494e 4727 0a20 2020 2020  p PENDING'.     
+0000de10: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0000de20: 2069 6e20 7261 6e67 6528 3333 2c20 3735   in range(33, 75
+0000de30: 290a 2020 2020 2020 2020 2020 2020 5d2c  ).            ],
 0000de40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000de50: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-0000de60: 6e20 7b6e 616d 657d 2d31 202d 6420 7b74  n {name}-1 -d {t
-0000de70: 6173 6b5f 6669 6c65 7d27 2c0a 2020 2020  ask_file}',.    
-0000de80: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000de90: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-0000dea0: 6d65 7d2d 3220 2d64 207b 7461 736b 5f66  me}-2 -d {task_f
-0000deb0: 696c 657d 272c 0a20 2020 2020 2020 2020  ile}',.         
-0000dec0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0000ded0: 2d79 202d 6320 7b6e 616d 657d 202d 6e20  -y -c {name} -n 
-0000dee0: 7b6e 616d 657d 2d33 202d 2d64 6574 6163  {name}-3 --detac
-0000def0: 682d 7365 7475 7020 2d64 207b 7461 736b  h-setup -d {task
-0000df00: 5f66 696c 657d 272c 0a20 2020 2020 2020  _file}',.       
-0000df10: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000df20: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
-0000df30: 7072 696e 7466 2022 2473 2220 2626 2028  printf "$s" && (
-0000df40: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000df50: 207b 6e61 6d65 7d2d 3120 7c20 6772 6570   {name}-1 | grep
-0000df60: 2052 554e 4e49 4e47 2927 2c0a 2020 2020   RUNNING)',.    
-0000df70: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000df80: 7920 7175 6575 6520 7b6e 616d 657d 2920  y queue {name}) 
-0000df90: 2626 2070 7269 6e74 6620 2224 7322 2026  && printf "$s" &
-0000dfa0: 2620 2865 6368 6f20 2224 7322 207c 2067  & (echo "$s" | g
-0000dfb0: 7265 7020 7b6e 616d 657d 2d32 207c 2067  rep {name}-2 | g
-0000dfc0: 7265 7020 5255 4e4e 494e 4729 272c 0a20  rep RUNNING)',. 
-0000dfd0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000dfe0: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-0000dff0: 7d29 2026 2620 7072 696e 7466 2022 2473  }) && printf "$s
-0000e000: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
-0000e010: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0000e020: 7c20 6772 6570 2053 4554 5449 4e47 5f55  | grep SETTING_U
-0000e030: 5029 272c 0a20 2020 2020 2020 2020 2020  P)',.           
-0000e040: 2027 736c 6565 7020 3930 272c 0a20 2020   'sleep 90',.   
-0000e050: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000e060: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-0000e070: 2026 2620 7072 696e 7466 2022 2473 2220   && printf "$s" 
-0000e080: 2626 2028 6563 686f 2022 2473 2220 7c20  && (echo "$s" | 
-0000e090: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-0000e0a0: 6772 6570 2050 454e 4449 4e47 2927 2c0a  grep PENDING)',.
-0000e0b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000e0c0: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
-0000e0d0: 657d 2031 272c 0a20 2020 2020 2020 2020  e} 1',.         
-0000e0e0: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-0000e0f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000e100: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
-0000e110: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
-0000e120: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
-0000e130: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000e140: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
-0000e150: 2031 2032 2033 272c 0a20 2020 2020 2020   1 2 3',.       
-0000e160: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000e170: 6820 2d63 207b 6e61 6d65 7d20 2d6e 207b  h -c {name} -n {
-0000e180: 6e61 6d65 7d2d 3420 2d2d 6465 7461 6368  name}-4 --detach
-0000e190: 2d73 6574 7570 202d 6420 7b74 6173 6b5f  -setup -d {task_
-0000e1a0: 6669 6c65 7d27 2c0a 2020 2020 2020 2020  file}',.        
-0000e1b0: 2020 2020 2320 5465 7374 2074 6865 206a      # Test the j
-0000e1c0: 6f62 2073 7461 7475 7320 6973 2063 6f72  ob status is cor
-0000e1d0: 7265 6374 6c79 2073 6574 2074 6f20 5345  rectly set to SE
-0000e1e0: 5454 494e 475f 5550 2c20 6475 7269 6e67  TTING_UP, during
-0000e1f0: 2074 6865 2073 6574 7570 2069 7320 7275   the setup is ru
-0000e200: 6e6e 696e 672c 0a20 2020 2020 2020 2020  nning,.         
-0000e210: 2020 2023 2061 6e64 2074 6865 206a 6f62     # and the job
-0000e220: 2063 616e 2062 6520 6361 6e63 656c 6c65   can be cancelle
-0000e230: 6420 6475 7269 6e67 2074 6865 2073 6574  d during the set
-0000e240: 7570 2e0a 2020 2020 2020 2020 2020 2020  up..            
-0000e250: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
-0000e260: 7b6e 616d 657d 2920 2626 2070 7269 6e74  {name}) && print
-0000e270: 6620 2224 7322 2026 2620 2865 6368 6f20  f "$s" && (echo 
-0000e280: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-0000e290: 657d 2d34 207c 2067 7265 7020 5345 5454  e}-4 | grep SETT
-0000e2a0: 494e 475f 5550 2927 2c0a 2020 2020 2020  ING_UP)',.      
-0000e2b0: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-0000e2c0: 656c 202d 7920 7b6e 616d 657d 2034 272c  el -y {name} 4',
-0000e2d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000e2e0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000e2f0: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
-0000e300: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
-0000e310: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000e320: 3420 7c20 6772 6570 2043 414e 4345 4c4c  4 | grep CANCELL
-0000e330: 4544 2927 2c0a 2020 2020 2020 2020 2020  ED)',.          
-0000e340: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000e350: 6d65 7d20 2d2d 6770 7573 2076 3130 303a  me} --gpus v100:
-0000e360: 302e 3220 225b 5b20 5c24 534b 5950 494c  0.2 "[[ \$SKYPIL
-0000e370: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
-0000e380: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
-0000e390: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0000e3a0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000e3b0: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
-0000e3c0: 7631 3030 3a30 2e32 202d 2d6e 756d 2d6e  v100:0.2 --num-n
-0000e3d0: 6f64 6573 2032 2022 5b5b 205c 2453 4b59  odes 2 "[[ \$SKY
-0000e3e0: 5049 4c4f 545f 4e55 4d5f 4750 5553 5f50  PILOT_NUM_GPUS_P
-0000e3f0: 4552 5f4e 4f44 4520 2d65 7120 3120 5d5d  ER_NODE -eq 1 ]]
-0000e400: 207c 7c20 6578 6974 2031 2227 2c0a 2020   || exit 1"',.  
-0000e410: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000e420: 6578 6563 207b 6e61 6d65 7d20 2d2d 6770  exec {name} --gp
-0000e430: 7573 2076 3130 303a 3120 2d2d 6e75 6d2d  us v100:1 --num-
-0000e440: 6e6f 6465 7320 3220 225b 5b20 5c24 534b  nodes 2 "[[ \$SK
-0000e450: 5950 494c 4f54 5f4e 554d 5f47 5055 535f  YPILOT_NUM_GPUS_
-0000e460: 5045 525f 4e4f 4445 202d 6571 2031 205d  PER_NODE -eq 1 ]
-0000e470: 5d20 7c7c 2065 7869 7420 3122 272c 0a20  ] || exit 1"',. 
-0000e480: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000e490: 206c 6f67 7320 7b6e 616d 657d 2035 202d   logs {name} 5 -
-0000e4a0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-0000e4b0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000e4c0: 207b 6e61 6d65 7d20 3620 2d2d 7374 6174   {name} 6 --stat
-0000e4d0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-0000e4e0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0000e4f0: 657d 2037 202d 2d73 7461 7475 7327 2c0a  e} 7 --status',.
-0000e500: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000e510: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000e520: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0000e530: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0000e540: 302c 2020 2320 3230 206d 696e 730a 2020  0,  # 20 mins.  
-0000e550: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0000e560: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-0000e570: 2d2d 2d2d 2d2d 2d2d 2d20 446f 636b 6572  --------- Docker
-0000e580: 2077 6974 6820 7072 6569 6e73 7461 6c6c   with preinstall
-0000e590: 6564 2070 6163 6b61 6765 2e20 2d2d 2d2d  ed package. ----
-0000e5a0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-0000e5b0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0000e5c0: 6b20 2023 2044 6f65 736e 2774 2073 7570  k  # Doesn't sup
-0000e5d0: 706f 7274 2046 6c75 6964 7374 6163 6b20  port Fluidstack 
-0000e5e0: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
-0000e5f0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-0000e600: 6c6f 7564 2020 2320 446f 6573 6e27 7420  loud  # Doesn't 
-0000e610: 7375 7070 6f72 7420 4c61 6d62 6461 2043  support Lambda C
-0000e620: 6c6f 7564 2066 6f72 206e 6f77 0a40 7079  loud for now.@py
-0000e630: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
-0000e640: 2020 2320 446f 6573 6e27 7420 7375 7070    # Doesn't supp
-0000e650: 6f72 7420 4942 4d20 436c 6f75 6420 666f  ort IBM Cloud fo
-0000e660: 7220 6e6f 770a 4070 7974 6573 742e 6d61  r now.@pytest.ma
-0000e670: 726b 2e6e 6f5f 7363 7020 2023 2044 6f65  rk.no_scp  # Doe
-0000e680: 736e 2774 2073 7570 706f 7274 2053 4350  sn't support SCP
-0000e690: 2066 6f72 206e 6f77 0a40 7079 7465 7374   for now.@pytest
-0000e6a0: 2e6d 6172 6b2e 6e6f 5f6f 6369 2020 2320  .mark.no_oci  # 
-0000e6b0: 446f 6573 6e27 7420 7375 7070 6f72 7420  Doesn't support 
-0000e6c0: 4f43 4920 666f 7220 6e6f 770a 4070 7974  OCI for now.@pyt
-0000e6d0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-0000e6e0: 726e 6574 6573 2020 2320 446f 6573 6e27  rnetes  # Doesn'
-0000e6f0: 7420 7375 7070 6f72 7420 4b75 6265 726e  t support Kubern
-0000e700: 6574 6573 2066 6f72 206e 6f77 0a64 6566  etes for now.def
-0000e710: 2074 6573 745f 646f 636b 6572 5f70 7265   test_docker_pre
-0000e720: 696e 7374 616c 6c65 645f 7061 636b 6167  installed_packag
-0000e730: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-0000e740: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000e750: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000e760: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000e770: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000e780: 646f 636b 6572 5f77 6974 685f 7072 6569  docker_with_prei
-0000e790: 6e73 7461 6c6c 6564 5f70 6163 6b61 6765  nstalled_package
-0000e7a0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0000e7b0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000e7c0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-0000e7d0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-0000e7e0: 7269 635f 636c 6f75 647d 202d 2d69 6d61  ric_cloud} --ima
-0000e7f0: 6765 2d69 6420 646f 636b 6572 3a6e 6769  ge-id docker:ngi
-0000e800: 6e78 272c 0a20 2020 2020 2020 2020 2020  nx',.           
-0000e810: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000e820: 657d 2022 6e67 696e 7820 2d56 2227 2c0a  e} "nginx -V"',.
-0000e830: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000e840: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0000e850: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-0000e860: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000e870: 6320 7b6e 616d 657d 2077 686f 616d 6920  c {name} whoami 
-0000e880: 7c20 6772 6570 2072 6f6f 7427 2c0a 2020  | grep root',.  
-0000e890: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000e8a0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000e8b0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-0000e8c0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000e8d0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-0000e8e0: 2d2d 2d20 5375 626d 6974 7469 6e67 206d  --- Submitting m
-0000e8f0: 756c 7469 706c 6520 7461 736b 7320 746f  ultiple tasks to
-0000e900: 2074 6865 2073 616d 6520 636c 7573 7465   the same cluste
-0000e910: 722e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  r. ----------.@p
-0000e920: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-0000e930: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
-0000e940: 6453 7461 636b 2044 4320 6861 7320 6c6f  dStack DC has lo
-0000e950: 7720 6176 6169 6c61 6269 6c69 7479 206f  w availability o
-0000e960: 6620 5434 2047 5055 730a 4070 7974 6573  f T4 GPUs.@pytes
-0000e970: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
-0000e980: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
-0000e990: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-0000e9a0: 6861 7665 2054 3420 6770 7573 0a40 7079  have T4 gpus.@py
-0000e9b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
-0000e9c0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
-0000e9d0: 7370 6163 6520 646f 6573 206e 6f74 2068  space does not h
-0000e9e0: 6176 6520 5434 2067 7075 730a 4070 7974  ave T4 gpus.@pyt
-0000e9f0: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
-0000ea00: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
-0000ea10: 7320 6e6f 7420 6861 7665 2054 3420 6770  s not have T4 gp
-0000ea20: 7573 0a40 7079 7465 7374 2e6d 6172 6b2e  us.@pytest.mark.
-0000ea30: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-0000ea40: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
-0000ea50: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
-0000ea60: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000ea70: 5f6f 6369 2020 2320 4f43 4920 436c 6f75  _oci  # OCI Clou
-0000ea80: 6420 646f 6573 206e 6f74 2068 6176 6520  d does not have 
-0000ea90: 5434 2067 7075 730a 6465 6620 7465 7374  T4 gpus.def test
-0000eaa0: 5f6d 756c 7469 5f65 6368 6f28 6765 6e65  _multi_echo(gene
-0000eab0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0000eac0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000ead0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000eae0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000eaf0: 0a20 2020 2020 2020 2027 6d75 6c74 695f  .        'multi_
-0000eb00: 6563 686f 272c 0a20 2020 2020 2020 205b  echo',.        [
-0000eb10: 0a20 2020 2020 2020 2020 2020 2066 2770  .            f'p
-0000eb20: 7974 686f 6e20 6578 616d 706c 6573 2f6d  ython examples/m
-0000eb30: 756c 7469 5f65 6368 6f2e 7079 207b 6e61  ulti_echo.py {na
-0000eb40: 6d65 7d20 7b67 656e 6572 6963 5f63 6c6f  me} {generic_clo
-0000eb50: 7564 7d27 2c0a 2020 2020 2020 2020 2020  ud}',.          
-0000eb60: 2020 2773 6c65 6570 2031 3230 272c 0a20    'sleep 120',. 
-0000eb70: 2020 2020 2020 205d 202b 0a20 2020 2020         ] +.     
-0000eb80: 2020 2023 2045 6e73 7572 6520 6a6f 6273     # Ensure jobs
-0000eb90: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-0000eba0: 2020 2020 5b66 2773 6b79 206c 6f67 7320      [f'sky logs 
-0000ebb0: 7b6e 616d 657d 207b 6920 2b20 317d 202d  {name} {i + 1} -
-0000ebc0: 2d73 7461 7475 7327 2066 6f72 2069 2069  -status' for i i
-0000ebd0: 6e20 7261 6e67 6528 3332 295d 202b 0a20  n range(32)] +. 
-0000ebe0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-0000ebf0: 6d6f 6e69 746f 722f 6175 746f 7363 616c  monitor/autoscal
-0000ec00: 6572 2064 6964 6e27 7420 6372 6173 6820  er didn't crash 
-0000ec10: 6f6e 2074 6865 2027 6173 7365 7274 206e  on the 'assert n
-0000ec20: 6f74 0a20 2020 2020 2020 2023 2075 6e66  ot.        # unf
-0000ec30: 756c 6669 6c6c 6564 2720 6572 726f 722e  ulfilled' error.
-0000ec40: 2020 4966 2070 726f 6365 7373 206e 6f74    If process not
-0000ec50: 2066 6f75 6e64 2c20 6772 6570 2d3e 7373   found, grep->ss
-0000ec60: 6820 7265 7475 726e 7320 312e 0a20 2020  h returns 1..   
-0000ec70: 2020 2020 205b 6627 7373 6820 7b6e 616d       [f'ssh {nam
-0000ec80: 657d 205c 2770 7320 6175 7820 7c20 6772  e} \'ps aux | gr
-0000ec90: 6570 2022 5b2f 5d22 6d6f 6e69 746f 722e  ep "[/]"monitor.
-0000eca0: 7079 5c27 275d 2c0a 2020 2020 2020 2020  py\''],.        
-0000ecb0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0000ecc0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-0000ecd0: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-0000ece0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000ecf0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-0000ed00: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5461 736b   ---------- Task
-0000ed10: 3a20 3120 6e6f 6465 2074 7261 696e 696e  : 1 node trainin
-0000ed20: 672e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  g. ----------.@p
-0000ed30: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-0000ed40: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
-0000ed50: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
-0000ed60: 6e6f 7420 6861 7665 2056 3130 3020 6770  not have V100 gp
-0000ed70: 7573 0a40 7079 7465 7374 2e6d 6172 6b2e  us.@pytest.mark.
-0000ed80: 6e6f 5f69 626d 2020 2320 4942 4d20 636c  no_ibm  # IBM cl
-0000ed90: 6f75 6420 6375 7272 656e 746c 7920 646f  oud currently do
-0000eda0: 6573 6e27 7420 7072 6f76 6964 6520 7075  esn't provide pu
-0000edb0: 626c 6963 2069 6d61 6765 2077 6974 6820  blic image with 
-0000edc0: 4355 4441 0a40 7079 7465 7374 2e6d 6172  CUDA.@pytest.mar
-0000edd0: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
-0000ede0: 646f 6573 206e 6f74 2068 6176 6520 5631  does not have V1
-0000edf0: 3030 2028 3136 4742 2920 4750 5573 2e20  00 (16GB) GPUs. 
-0000ee00: 5275 6e20 7465 7374 5f73 6370 5f68 7567  Run test_scp_hug
-0000ee10: 6769 6e67 6661 6365 2069 6e73 7465 6164  gingface instead
-0000ee20: 2e0a 6465 6620 7465 7374 5f68 7567 6769  ..def test_huggi
-0000ee30: 6e67 6661 6365 2867 656e 6572 6963 5f63  ngface(generic_c
-0000ee40: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-0000ee50: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0000ee60: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0000ee70: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0000ee80: 2020 2020 2768 7567 6769 6e67 6661 6365      'huggingface
-0000ee90: 5f67 6c75 655f 696d 6462 5f61 7070 272c  _glue_imdb_app',
-0000eea0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0000eeb0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000eec0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000eed0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-0000eee0: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
-0000eef0: 732f 6875 6767 696e 6766 6163 655f 676c  s/huggingface_gl
-0000ef00: 7565 5f69 6d64 625f 6170 702e 7961 6d6c  ue_imdb_app.yaml
-0000ef10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000ef20: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000ef30: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-0000ef40: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0000ef50: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0000ef60: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000ef70: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-0000ef80: 732f 6875 6767 696e 6766 6163 655f 676c  s/huggingface_gl
-0000ef90: 7565 5f69 6d64 625f 6170 702e 7961 6d6c  ue_imdb_app.yaml
-0000efa0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000efb0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000efc0: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
-0000efd0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0000efe0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0000eff0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-0000f000: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0000f010: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-0000f020: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0000f030: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-0000f040: 2e6c 616d 6264 615f 636c 6f75 640a 6465  .lambda_cloud.de
-0000f050: 6620 7465 7374 5f6c 616d 6264 615f 6875  f test_lambda_hu
-0000f060: 6767 696e 6766 6163 6528 6765 6e65 7269  ggingface(generi
-0000f070: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-0000f080: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000f090: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000f0a0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0000f0b0: 2020 2020 2020 2027 6c61 6d62 6461 5f68         'lambda_h
-0000f0c0: 7567 6769 6e67 6661 6365 5f67 6c75 655f  uggingface_glue_
-0000f0d0: 696d 6462 5f61 7070 272c 0a20 2020 2020  imdb_app',.     
-0000f0e0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0000f0f0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-0000f100: 202d 6320 7b6e 616d 657d 207b 4c41 4d42   -c {name} {LAMB
-0000f110: 4441 5f54 5950 457d 2065 7861 6d70 6c65  DA_TYPE} example
-0000f120: 732f 6875 6767 696e 6766 6163 655f 676c  s/huggingface_gl
-0000f130: 7565 5f69 6d64 625f 6170 702e 7961 6d6c  ue_imdb_app.yaml
-0000f140: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000f150: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000f160: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-0000f170: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0000f180: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0000f190: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000f1a0: 6320 7b6e 616d 657d 207b 4c41 4d42 4441  c {name} {LAMBDA
-0000f1b0: 5f54 5950 457d 2065 7861 6d70 6c65 732f  _TYPE} examples/
-0000f1c0: 6875 6767 696e 6766 6163 655f 676c 7565  huggingface_glue
-0000f1d0: 5f69 6d64 625f 6170 702e 7961 6d6c 272c  _imdb_app.yaml',
-0000f1e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000f1f0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-0000f200: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-0000f210: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-0000f220: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-0000f230: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-0000f240: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0000f250: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-0000f260: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000f270: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
-0000f280: 6370 0a64 6566 2074 6573 745f 7363 705f  cp.def test_scp_
-0000f290: 6875 6767 696e 6766 6163 6528 6765 6e65  huggingface(gene
-0000f2a0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0000f2b0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000f2c0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000f2d0: 2020 2020 6e75 6d5f 6f66 5f67 7075 5f6c      num_of_gpu_l
-0000f2e0: 6175 6e63 6820 3d20 310a 2020 2020 7465  aunch = 1.    te
-0000f2f0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0000f300: 2020 2027 5343 505f 6875 6767 696e 6766     'SCP_huggingf
-0000f310: 6163 655f 676c 7565 5f69 6d64 625f 6170  ace_glue_imdb_ap
-0000f320: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
-0000f330: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000f340: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-0000f350: 6d65 7d20 7b53 4350 5f54 5950 457d 207b  me} {SCP_TYPE} {
-0000f360: 5343 505f 4750 555f 5631 3030 7d3a 7b6e  SCP_GPU_V100}:{n
-0000f370: 756d 5f6f 665f 6770 755f 6c61 756e 6368  um_of_gpu_launch
-0000f380: 7d20 6578 616d 706c 6573 2f68 7567 6769  } examples/huggi
-0000f390: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
-0000f3a0: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
-0000f3b0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000f3c0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-0000f3d0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-0000f3e0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-0000f3f0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-0000f400: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000f410: 7d20 7b53 4350 5f54 5950 457d 207b 5343  } {SCP_TYPE} {SC
-0000f420: 505f 4750 555f 5631 3030 7d3a 7b6e 756d  P_GPU_V100}:{num
-0000f430: 5f6f 665f 6770 755f 6c61 756e 6368 7d20  _of_gpu_launch} 
-0000f440: 6578 616d 706c 6573 2f68 7567 6769 6e67  examples/hugging
-0000f450: 6661 6365 5f67 6c75 655f 696d 6462 5f61  face_glue_imdb_a
-0000f460: 7070 2e79 616d 6c27 2c0a 2020 2020 2020  pp.yaml',.      
-0000f470: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000f480: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-0000f490: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-0000f4a0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-0000f4b0: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
-0000f4c0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000f4d0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000f4e0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0000f4f0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0000f500: 2d2d 2d2d 2d2d 2d20 496e 6665 7265 6e74  ------- Inferent
-0000f510: 6961 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  ia. ----------.@
-0000f520: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-0000f530: 6465 6620 7465 7374 5f69 6e66 6572 656e  def test_inferen
-0000f540: 7469 6128 293a 0a20 2020 206e 616d 6520  tia():.    name 
-0000f550: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000f560: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000f570: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000f580: 7465 7374 5f69 6e66 6572 656e 7469 6127  test_inferentia'
-0000f590: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0000f5a0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000f5b0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000f5c0: 7d20 2d74 2069 6e66 322e 786c 6172 6765  } -t inf2.xlarge
-0000f5d0: 202d 2d20 6563 686f 2068 6927 2c0a 2020   -- echo hi',.  
-0000f5e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000f5f0: 6578 6563 207b 6e61 6d65 7d20 2d2d 6770  exec {name} --gp
-0000f600: 7573 2049 6e66 6572 656e 7469 613a 3120  us Inferentia:1 
-0000f610: 6563 686f 2068 6927 2c0a 2020 2020 2020  echo hi',.      
-0000f620: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000f630: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-0000f640: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-0000f650: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-0000f660: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0000f670: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000f680: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
-0000f690: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-0000f6a0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0000f6b0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-0000f6c0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-0000f6d0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-0000f6e0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0000f6f0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-0000f700: 5450 552e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  TPU. ----------.
-0000f710: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-0000f720: 0a40 7079 7465 7374 2e6d 6172 6b2e 7470  .@pytest.mark.tp
-0000f730: 750a 6465 6620 7465 7374 5f74 7075 2829  u.def test_tpu()
-0000f740: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-0000f750: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0000f760: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0000f770: 280a 2020 2020 2020 2020 2774 7075 5f61  (.        'tpu_a
-0000f780: 7070 272c 0a20 2020 2020 2020 205b 0a20  pp',.        [. 
-0000f790: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000f7a0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-0000f7b0: 616d 657d 2065 7861 6d70 6c65 732f 7470  ame} examples/tp
-0000f7c0: 752f 7470 755f 6170 702e 7961 6d6c 272c  u/tpu_app.yaml',
-0000f7d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000f7e0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-0000f7f0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000f800: 206a 6f62 2066 696e 6973 6865 642e 0a20   job finished.. 
-0000f810: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000f820: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-0000f830: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-0000f840: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-0000f850: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-0000f860: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0000f870: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
-0000f880: 6d70 6c65 732f 7470 752f 7470 755f 6170  mples/tpu/tpu_ap
-0000f890: 702e 7961 6d6c 207c 2067 7265 7020 2254  p.yaml | grep "T
-0000f8a0: 5055 202e 2a20 616c 7265 6164 7920 6578  PU .* already ex
-0000f8b0: 6973 7473 2227 2c20 2023 2045 6e73 7572  ists"',  # Ensur
-0000f8c0: 6520 736b 7920 6c61 756e 6368 2077 6f6e  e sky launch won
-0000f8d0: 2774 2063 7265 6174 6520 616e 6f74 6865  't create anothe
-0000f8e0: 7220 5450 552e 0a20 2020 2020 2020 205d  r TPU..        ]
-0000f8f0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000f900: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0000f910: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0000f920: 3d33 3020 2a20 3630 2c20 2023 2063 616e  =30 * 60,  # can
-0000f930: 2074 616b 6520 3e32 3020 6d69 6e73 0a20   take >20 mins. 
-0000f940: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000f950: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0000f960: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055 2056  ---------- TPU V
-0000f970: 4d2e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  M. ----------.@p
-0000f980: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
-0000f990: 7079 7465 7374 2e6d 6172 6b2e 7470 750a  pytest.mark.tpu.
-0000f9a0: 6465 6620 7465 7374 5f74 7075 5f76 6d28  def test_tpu_vm(
-0000f9b0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-0000f9c0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0000f9d0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0000f9e0: 7428 0a20 2020 2020 2020 2027 7470 755f  t(.        'tpu_
-0000f9f0: 766d 5f61 7070 272c 0a20 2020 2020 2020  vm_app',.       
-0000fa00: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000fa10: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000fa20: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-0000fa30: 732f 7470 752f 7470 7576 6d5f 6d6e 6973  s/tpu/tpuvm_mnis
-0000fa40: 742e 7961 6d6c 272c 0a20 2020 2020 2020  t.yaml',.       
-0000fa50: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000fa60: 7b6e 616d 657d 2031 272c 2020 2320 456e  {name} 1',  # En
-0000fa70: 7375 7265 2074 6865 206a 6f62 2066 696e  sure the job fin
-0000fa80: 6973 6865 642e 0a20 2020 2020 2020 2020  ished..         
-0000fa90: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000faa0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-0000fab0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-0000fac0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-0000fad0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000fae0: 2073 746f 7020 2d79 207b 6e61 6d65 7d27   stop -y {name}'
-0000faf0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000fb00: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
-0000fb10: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
-0000fb20: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-0000fb30: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-0000fb40: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
-0000fb50: 7d20 7c20 6772 6570 2053 544f 5050 4544  } | grep STOPPED
-0000fb60: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000fb70: 2063 6c75 7374 6572 2069 7320 5354 4f50   cluster is STOP
-0000fb80: 5045 442e 0a20 2020 2020 2020 2020 2020  PED..           
-0000fb90: 2023 2055 7365 2072 6574 7279 3a20 6775   # Use retry: gu
-0000fba0: 6172 6420 6167 6169 6e73 7420 7472 616e  ard against tran
-0000fbb0: 7369 656e 7420 6572 726f 7273 206f 6273  sient errors obs
-0000fbc0: 6572 7665 6420 666f 720a 2020 2020 2020  erved for.      
-0000fbd0: 2020 2020 2020 2320 6a75 7374 2d73 746f        # just-sto
-0000fbe0: 7070 6564 2054 5055 2056 4d73 2028 2339  pped TPU VMs (#9
-0000fbf0: 3632 292e 0a20 2020 2020 2020 2020 2020  62)..           
-0000fc00: 2066 2773 6b79 2073 7461 7274 202d 2d72   f'sky start --r
-0000fc10: 6574 7279 2d75 6e74 696c 2d75 7020 2d79  etry-until-up -y
-0000fc20: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0000fc30: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0000fc40: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-0000fc50: 2f74 7075 2f74 7075 766d 5f6d 6e69 7374  /tpu/tpuvm_mnist
-0000fc60: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000fc70: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000fc80: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-0000fc90: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000fca0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0000fcb0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000fcc0: 7920 7374 6f70 202d 7920 7b6e 616d 657d  y stop -y {name}
-0000fcd0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0000fce0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0000fcf0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0000fd00: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
-0000fd10: 2a20 3630 2c20 2023 2063 616e 2074 616b  * 60,  # can tak
-0000fd20: 6520 3330 206d 696e 730a 2020 2020 290a  e 30 mins.    ).
-0000fd30: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000fd40: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0000fd50: 2d2d 2d2d 2d20 5450 5520 564d 2050 6f64  ----- TPU VM Pod
-0000fd60: 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  . ----------.@py
-0000fd70: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
-0000fd80: 7974 6573 742e 6d61 726b 2e74 7075 0a64  ytest.mark.tpu.d
-0000fd90: 6566 2074 6573 745f 7470 755f 766d 5f70  ef test_tpu_vm_p
-0000fda0: 6f64 2829 3a0a 2020 2020 6e61 6d65 203d  od():.    name =
-0000fdb0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000fdc0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000fdd0: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
-0000fde0: 7075 5f70 6f64 272c 0a20 2020 2020 2020  pu_pod',.       
-0000fdf0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000fe00: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000fe10: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-0000fe20: 732f 7470 752f 7470 7576 6d5f 6d6e 6973  s/tpu/tpuvm_mnis
-0000fe30: 742e 7961 6d6c 202d 2d67 7075 7320 7470  t.yaml --gpus tp
-0000fe40: 752d 7632 2d33 3220 2d2d 7573 652d 7370  u-v2-32 --use-sp
-0000fe50: 6f74 202d 2d7a 6f6e 6520 6575 726f 7065  ot --zone europe
-0000fe60: 2d77 6573 7434 2d61 272c 0a20 2020 2020  -west4-a',.     
-0000fe70: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000fe80: 7320 7b6e 616d 657d 2031 272c 2020 2320  s {name} 1',  # 
-0000fe90: 456e 7375 7265 2074 6865 206a 6f62 2066  Ensure the job f
-0000fea0: 696e 6973 6865 642e 0a20 2020 2020 2020  inished..       
-0000feb0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000fec0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-0000fed0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-0000fee0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0000fef0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0000ff00: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-0000ff10: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-0000ff20: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
-0000ff30: 3630 2c20 2023 2063 616e 2074 616b 6520  60,  # can take 
-0000ff40: 3330 206d 696e 730a 2020 2020 290a 2020  30 mins.    ).  
-0000ff50: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000ff60: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-0000ff70: 2d2d 2d20 5369 6d70 6c65 2061 7070 732e  --- Simple apps.
-0000ff80: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-0000ff90: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
-0000ffa0: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
-0000ffb0: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
-0000ffc0: 7320 3e20 3120 7965 740a 6465 6620 7465  s > 1 yet.def te
-0000ffd0: 7374 5f6d 756c 7469 5f68 6f73 746e 616d  st_multi_hostnam
-0000ffe0: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-0000fff0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-00010000: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00010010: 616d 6528 290a 2020 2020 746f 7461 6c5f  ame().    total_
-00010020: 7469 6d65 6f75 745f 6d69 6e75 7465 7320  timeout_minutes 
-00010030: 3d20 3235 2069 6620 6765 6e65 7269 635f  = 25 if generic_
-00010040: 636c 6f75 6420 3d3d 2027 617a 7572 6527  cloud == 'azure'
-00010050: 2065 6c73 6520 3135 0a20 2020 2074 6573   else 15.    tes
-00010060: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00010070: 2020 276d 756c 7469 5f68 6f73 746e 616d    'multi_hostnam
-00010080: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-00010090: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000100a0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-000100b0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-000100c0: 6572 6963 5f63 6c6f 7564 7d20 6578 616d  eric_cloud} exam
-000100d0: 706c 6573 2f6d 756c 7469 5f68 6f73 746e  ples/multi_hostn
-000100e0: 616d 652e 7961 6d6c 272c 0a20 2020 2020  ame.yaml',.     
-000100f0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00010100: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00010110: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00010120: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00010130: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00010140: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00010150: 2031 207c 2067 7265 7020 224d 7920 686f   1 | grep "My ho
-00010160: 7374 6e61 6d65 3a22 207c 2077 6320 2d6c  stname:" | wc -l
-00010170: 207c 2067 7265 7020 3227 2c20 2023 2045   | grep 2',  # E
-00010180: 6e73 7572 6520 7468 6572 6520 6172 6520  nsure there are 
-00010190: 3220 686f 7374 732e 0a20 2020 2020 2020  2 hosts..       
-000101a0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-000101b0: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-000101c0: 6d75 6c74 695f 686f 7374 6e61 6d65 2e79  multi_hostname.y
-000101d0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-000101e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000101f0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-00010200: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00010210: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00010220: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00010230: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00010240: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00010250: 7469 6d65 6f75 743d 5f67 6574 5f74 696d  timeout=_get_tim
-00010260: 656f 7574 2867 656e 6572 6963 5f63 6c6f  eout(generic_clo
-00010270: 7564 2c20 746f 7461 6c5f 7469 6d65 6f75  ud, total_timeou
-00010280: 745f 6d69 6e75 7465 7320 2a20 3630 292c  t_minutes * 60),
-00010290: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-000102a0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000102b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000102c0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-000102d0: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
-000102e0: 6e6f 6465 7320 3e20 3120 7965 740a 6465  nodes > 1 yet.de
-000102f0: 6620 7465 7374 5f6d 756c 7469 5f6e 6f64  f test_multi_nod
-00010300: 655f 6661 696c 7572 6528 6765 6e65 7269  e_failure(generi
-00010310: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00010320: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00010330: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00010340: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00010350: 2020 2020 2020 2027 6d75 6c74 695f 6e6f         'multi_no
-00010360: 6465 5f66 6169 6c75 7265 272c 0a20 2020  de_failure',.   
-00010370: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00010380: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
-00010390: 2077 6520 7573 6520 6d75 6c74 692d 7468   we use multi-th
-000103a0: 7265 6164 2074 6f20 7275 6e20 7468 6520  read to run the 
-000103b0: 636f 6d6d 616e 6473 2069 6e20 7365 7475  commands in setu
-000103c0: 700a 2020 2020 2020 2020 2020 2020 2320  p.            # 
-000103d0: 636f 6d6d 616e 6473 2069 6e20 7061 7261  commands in para
-000103e0: 6c6c 656c 2c20 7768 6963 6820 6d61 6b65  llel, which make
-000103f0: 7320 6974 2069 6d70 6f73 7369 626c 6520  s it impossible 
-00010400: 746f 2066 6169 6c20 6661 7374 0a20 2020  to fail fast.   
-00010410: 2020 2020 2020 2020 2023 2077 6865 6e20           # when 
-00010420: 6f6e 6520 6f66 2074 6865 206e 6f64 6573  one of the nodes
-00010430: 2066 6169 6c73 2e20 5765 2073 686f 756c   fails. We shoul
-00010440: 6420 6669 7820 7468 6973 2069 6e20 7468  d fix this in th
-00010450: 6520 6675 7475 7265 2e0a 2020 2020 2020  e future..      
-00010460: 2020 2020 2020 2320 5468 6520 2d2d 6465        # The --de
-00010470: 7461 6368 2d73 6574 7570 2076 6572 7369  tach-setup versi
-00010480: 6f6e 2063 616e 2066 6169 6c20 6661 7374  on can fail fast
-00010490: 2c20 6173 2074 6865 2073 6574 7570 2069  , as the setup i
-000104a0: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
-000104b0: 7375 626d 6974 7465 6420 746f 2074 6865  submitted to the
-000104c0: 2072 656d 6f74 6520 6d61 6368 696e 652c   remote machine,
-000104d0: 2077 6869 6368 2064 6f65 7320 6e6f 7420   which does not 
-000104e0: 7573 6520 6d75 6c74 692d 7468 7265 6164  use multi-thread
-000104f0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00010500: 5265 6665 7220 746f 2074 6865 2063 6f6d  Refer to the com
-00010510: 6d65 6e74 2069 6e20 6073 7562 7072 6f63  ment in `subproc
-00010520: 6573 735f 7574 696c 732e 7275 6e5f 696e  ess_utils.run_in
-00010530: 5f70 6172 616c 6c65 6c60 2e0a 2020 2020  _parallel`..    
-00010540: 2020 2020 2020 2020 2320 6627 736b 7920          # f'sky 
-00010550: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00010560: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00010570: 6572 6963 5f63 6c6f 7564 7d20 7465 7374  eric_cloud} test
-00010580: 732f 7465 7374 5f79 616d 6c73 2f66 6169  s/test_yamls/fai
-00010590: 6c65 645f 776f 726b 6572 5f73 6574 7570  led_worker_setup
-000105a0: 2e79 616d 6c20 2626 2065 7869 7420 3127  .yaml && exit 1'
-000105b0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-000105c0: 6a6f 6220 7365 7475 7020 6661 696c 6564  job setup failed
-000105d0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-000105e0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-000105f0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00010600: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00010610: 2d2d 6465 7461 6368 2d73 6574 7570 2074  --detach-setup t
-00010620: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00010630: 6661 696c 6564 5f77 6f72 6b65 725f 7365  failed_worker_se
-00010640: 7475 702e 7961 6d6c 272c 0a20 2020 2020  tup.yaml',.     
-00010650: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00010660: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00010670: 7475 7320 7c20 6772 6570 2046 4149 4c45  tus | grep FAILE
-00010680: 445f 5345 5455 5027 2c20 2023 2045 6e73  D_SETUP',  # Ens
-00010690: 7572 6520 7468 6520 6a6f 6220 7365 7475  ure the job setu
-000106a0: 7020 6661 696c 6564 2e0a 2020 2020 2020  p failed..      
-000106b0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000106c0: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
-000106d0: 7374 5f79 616d 6c73 2f66 6169 6c65 645f  st_yamls/failed_
-000106e0: 776f 726b 6572 5f72 756e 2e79 616d 6c27  worker_run.yaml'
-000106f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010700: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00010710: 3220 2d2d 7374 6174 7573 207c 2067 7265  2 --status | gre
-00010720: 7020 4641 494c 4544 272c 2020 2320 456e  p FAILED',  # En
-00010730: 7375 7265 2074 6865 206a 6f62 2066 6169  sure the job fai
-00010740: 6c65 642e 0a20 2020 2020 2020 2020 2020  led..           
-00010750: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00010760: 657d 2032 207c 2067 7265 7020 224d 7920  e} 2 | grep "My 
-00010770: 686f 7374 6e61 6d65 3a22 207c 2077 6320  hostname:" | wc 
-00010780: 2d6c 207c 2067 7265 7020 3227 2c20 2023  -l | grep 2',  #
-00010790: 2045 6e73 7572 6520 7468 6572 6520 3220   Ensure there 2 
-000107a0: 6f66 2074 6865 2068 6f73 7473 2070 7269  of the hosts pri
-000107b0: 6e74 6564 2074 6865 6972 2068 6f73 746e  nted their hostn
-000107c0: 616d 652e 0a20 2020 2020 2020 205d 2c0a  ame..        ],.
-000107d0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000107e0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000107f0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00010800: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-00010810: 2d2d 2d2d 2d2d 2d2d 2d2d 2057 6562 2061  ---------- Web a
-00010820: 7070 7320 7769 7468 2063 7573 746f 6d20  pps with custom 
-00010830: 706f 7274 7320 6f6e 2047 4350 2e20 2d2d  ports on GCP. --
-00010840: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-00010850: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
-00010860: 7374 5f67 6370 5f68 7474 705f 7365 7276  st_gcp_http_serv
-00010870: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
-00010880: 6f72 7473 2829 3a0a 2020 2020 6e61 6d65  orts():.    name
-00010890: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000108a0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-000108b0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-000108c0: 2767 6370 5f68 7474 705f 7365 7276 6572  'gcp_http_server
-000108d0: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
-000108e0: 7473 272c 0a20 2020 2020 2020 205b 0a20  ts',.        [. 
-000108f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00010900: 206c 6175 6e63 6820 2d79 202d 6420 2d63   launch -y -d -c
-00010910: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00010920: 6763 7020 6578 616d 706c 6573 2f68 7474  gcp examples/htt
-00010930: 705f 7365 7276 6572 5f77 6974 685f 6375  p_server_with_cu
-00010940: 7374 6f6d 5f70 6f72 7473 2f74 6173 6b2e  stom_ports/task.
-00010950: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00010960: 2020 2066 2775 6e74 696c 2053 4b59 5049     f'until SKYPI
-00010970: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
-00010980: 7374 6174 7573 202d 2d65 6e64 706f 696e  status --endpoin
-00010990: 7420 3333 3832 3820 7b6e 616d 657d 3b20  t 33828 {name}; 
-000109a0: 646f 2073 6c65 6570 2031 303b 2064 6f6e  do sleep 10; don
-000109b0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-000109c0: 2320 5265 7472 7920 6120 6665 7720 7469  # Retry a few ti
-000109d0: 6d65 7320 746f 2061 766f 6964 2066 6c61  mes to avoid fla
-000109e0: 6b69 6e65 7373 2069 6e20 706f 7274 7320  kiness in ports 
-000109f0: 6265 696e 6720 6f70 656e 2e0a 2020 2020  being open..    
-00010a00: 2020 2020 2020 2020 6627 6970 3d24 2853          f'ip=$(S
-00010a10: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
-00010a20: 736b 7920 7374 6174 7573 202d 2d65 6e64  sky status --end
-00010a30: 706f 696e 7420 3333 3832 3820 7b6e 616d  point 33828 {nam
-00010a40: 657d 293b 2073 7563 6365 7373 3d66 616c  e}); success=fal
-00010a50: 7365 3b20 666f 7220 6920 696e 2024 2873  se; for i in $(s
-00010a60: 6571 2031 2035 293b 2064 6f20 6966 2063  eq 1 5); do if c
-00010a70: 7572 6c20 2469 7020 7c20 6772 6570 2022  url $ip | grep "
-00010a80: 3c68 313e 5468 6973 2069 7320 6120 6465  <h1>This is a de
-00010a90: 6d6f 2048 544d 4c20 7061 6765 2e3c 2f68  mo HTML page.</h
-00010aa0: 313e 223b 2074 6865 6e20 7375 6363 6573  1>"; then succes
-00010ab0: 733d 7472 7565 3b20 6272 6561 6b3b 2066  s=true; break; f
-00010ac0: 693b 2073 6c65 6570 2031 303b 2064 6f6e  i; sleep 10; don
-00010ad0: 653b 2069 6620 5b20 2224 7375 6363 6573  e; if [ "$succes
-00010ae0: 7322 203d 2066 616c 7365 205d 3b20 7468  s" = false ]; th
-00010af0: 656e 2065 7869 7420 313b 2066 6927 2c0a  en exit 1; fi',.
-00010b00: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00010b10: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00010b20: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-00010b30: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00010b40: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00010b50: 2d2d 2d2d 2d20 5765 6220 6170 7073 2077  ----- Web apps w
-00010b60: 6974 6820 6375 7374 6f6d 2070 6f72 7473  ith custom ports
-00010b70: 206f 6e20 4157 532e 202d 2d2d 2d2d 2d2d   on AWS. -------
-00010b80: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00010b90: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
-00010ba0: 735f 6874 7470 5f73 6572 7665 725f 7769  s_http_server_wi
-00010bb0: 7468 5f63 7573 746f 6d5f 706f 7274 7328  th_custom_ports(
-00010bc0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00010bd0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00010be0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00010bf0: 7428 0a20 2020 2020 2020 2027 6177 735f  t(.        'aws_
-00010c00: 6874 7470 5f73 6572 7665 725f 7769 7468  http_server_with
-00010c10: 5f63 7573 746f 6d5f 706f 7274 7327 2c0a  _custom_ports',.
-00010c20: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00010c30: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00010c40: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
-00010c50: 657d 202d 2d63 6c6f 7564 2061 7773 2065  e} --cloud aws e
-00010c60: 7861 6d70 6c65 732f 6874 7470 5f73 6572  xamples/http_ser
-00010c70: 7665 725f 7769 7468 5f63 7573 746f 6d5f  ver_with_custom_
-00010c80: 706f 7274 732f 7461 736b 2e79 616d 6c27  ports/task.yaml'
-00010c90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010ca0: 756e 7469 6c20 534b 5950 494c 4f54 5f44  until SKYPILOT_D
-00010cb0: 4542 5547 3d30 2073 6b79 2073 7461 7475  EBUG=0 sky statu
-00010cc0: 7320 2d2d 656e 6470 6f69 6e74 2033 3338  s --endpoint 338
-00010cd0: 3238 207b 6e61 6d65 7d3b 2064 6f20 736c  28 {name}; do sl
-00010ce0: 6565 7020 3130 3b20 646f 6e65 272c 0a20  eep 10; done',. 
-00010cf0: 2020 2020 2020 2020 2020 2023 2052 6574             # Ret
-00010d00: 7279 2061 2066 6577 2074 696d 6573 2074  ry a few times t
-00010d10: 6f20 6176 6f69 6420 666c 616b 696e 6573  o avoid flakines
-00010d20: 7320 696e 2070 6f72 7473 2062 6569 6e67  s in ports being
-00010d30: 206f 7065 6e2e 0a20 2020 2020 2020 2020   open..         
-00010d40: 2020 2066 2769 703d 2428 534b 5950 494c     f'ip=$(SKYPIL
-00010d50: 4f54 5f44 4542 5547 3d30 2073 6b79 2073  OT_DEBUG=0 sky s
-00010d60: 7461 7475 7320 2d2d 656e 6470 6f69 6e74  tatus --endpoint
-00010d70: 2033 3338 3238 207b 6e61 6d65 7d29 3b20   33828 {name}); 
-00010d80: 7375 6363 6573 733d 6661 6c73 653b 2066  success=false; f
-00010d90: 6f72 2069 2069 6e20 2428 7365 7120 3120  or i in $(seq 1 
-00010da0: 3529 3b20 646f 2069 6620 6375 726c 2024  5); do if curl $
-00010db0: 6970 207c 2067 7265 7020 223c 6831 3e54  ip | grep "<h1>T
-00010dc0: 6869 7320 6973 2061 2064 656d 6f20 4854  his is a demo HT
-00010dd0: 4d4c 2070 6167 652e 3c2f 6831 3e22 3b20  ML page.</h1>"; 
-00010de0: 7468 656e 2073 7563 6365 7373 3d74 7275  then success=tru
-00010df0: 653b 2062 7265 616b 3b20 6669 3b20 736c  e; break; fi; sl
-00010e00: 6565 7020 3130 3b20 646f 6e65 3b20 6966  eep 10; done; if
-00010e10: 205b 2022 2473 7563 6365 7373 2220 3d20   [ "$success" = 
-00010e20: 6661 6c73 6520 5d3b 2074 6865 6e20 6578  false ]; then ex
-00010e30: 6974 2031 3b20 6669 270a 2020 2020 2020  it 1; fi'.      
-00010e40: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00010e50: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00010e60: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00010e70: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00010e80: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-00010e90: 5765 6220 6170 7073 2077 6974 6820 6375  Web apps with cu
-00010ea0: 7374 6f6d 2070 6f72 7473 206f 6e20 417a  stom ports on Az
-00010eb0: 7572 652e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ure. ----------.
-00010ec0: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
-00010ed0: 7265 0a64 6566 2074 6573 745f 617a 7572  re.def test_azur
-00010ee0: 655f 6874 7470 5f73 6572 7665 725f 7769  e_http_server_wi
-00010ef0: 7468 5f63 7573 746f 6d5f 706f 7274 7328  th_custom_ports(
-00010f00: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00010f10: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00010f20: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00010f30: 7428 0a20 2020 2020 2020 2027 617a 7572  t(.        'azur
-00010f40: 655f 6874 7470 5f73 6572 7665 725f 7769  e_http_server_wi
-00010f50: 7468 5f63 7573 746f 6d5f 706f 7274 7327  th_custom_ports'
-00010f60: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00010f70: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00010f80: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
-00010f90: 616d 657d 202d 2d63 6c6f 7564 2061 7a75  ame} --cloud azu
-00010fa0: 7265 2065 7861 6d70 6c65 732f 6874 7470  re examples/http
-00010fb0: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
-00010fc0: 746f 6d5f 706f 7274 732f 7461 736b 2e79  tom_ports/task.y
-00010fd0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00010fe0: 2020 6627 756e 7469 6c20 534b 5950 494c    f'until SKYPIL
-00010ff0: 4f54 5f44 4542 5547 3d30 2073 6b79 2073  OT_DEBUG=0 sky s
-00011000: 7461 7475 7320 2d2d 656e 6470 6f69 6e74  tatus --endpoint
-00011010: 2033 3338 3238 207b 6e61 6d65 7d3b 2064   33828 {name}; d
-00011020: 6f20 736c 6565 7020 3130 3b20 646f 6e65  o sleep 10; done
-00011030: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00011040: 2052 6574 7279 2061 2066 6577 2074 696d   Retry a few tim
-00011050: 6573 2074 6f20 6176 6f69 6420 666c 616b  es to avoid flak
-00011060: 696e 6573 7320 696e 2070 6f72 7473 2062  iness in ports b
-00011070: 6569 6e67 206f 7065 6e2e 0a20 2020 2020  eing open..     
-00011080: 2020 2020 2020 2066 2769 703d 2428 534b         f'ip=$(SK
-00011090: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
-000110a0: 6b79 2073 7461 7475 7320 2d2d 656e 6470  ky status --endp
-000110b0: 6f69 6e74 2033 3338 3238 207b 6e61 6d65  oint 33828 {name
-000110c0: 7d29 3b20 7375 6363 6573 733d 6661 6c73  }); success=fals
-000110d0: 653b 2066 6f72 2069 2069 6e20 2428 7365  e; for i in $(se
-000110e0: 7120 3120 3529 3b20 646f 2069 6620 6375  q 1 5); do if cu
-000110f0: 726c 2024 6970 207c 2067 7265 7020 223c  rl $ip | grep "<
-00011100: 6831 3e54 6869 7320 6973 2061 2064 656d  h1>This is a dem
-00011110: 6f20 4854 4d4c 2070 6167 652e 3c2f 6831  o HTML page.</h1
-00011120: 3e22 3b20 7468 656e 2073 7563 6365 7373  >"; then success
-00011130: 3d74 7275 653b 2062 7265 616b 3b20 6669  =true; break; fi
-00011140: 3b20 736c 6565 7020 3130 3b20 646f 6e65  ; sleep 10; done
-00011150: 3b20 6966 205b 2022 2473 7563 6365 7373  ; if [ "$success
-00011160: 2220 3d20 6661 6c73 6520 5d3b 2074 6865  " = false ]; the
-00011170: 6e20 6578 6974 2031 3b20 6669 270a 2020  n exit 1; fi'.  
-00011180: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00011190: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-000111a0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-000111b0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-000111c0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-000111d0: 2d2d 2d20 5765 6220 6170 7073 2077 6974  --- Web apps wit
-000111e0: 6820 6375 7374 6f6d 2070 6f72 7473 206f  h custom ports o
-000111f0: 6e20 4b75 6265 726e 6574 6573 2e20 2d2d  n Kubernetes. --
-00011200: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-00011210: 2e6d 6172 6b2e 6b75 6265 726e 6574 6573  .mark.kubernetes
-00011220: 0a64 6566 2074 6573 745f 6b75 6265 726e  .def test_kubern
-00011230: 6574 6573 5f68 7474 705f 7365 7276 6572  etes_http_server
-00011240: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
-00011250: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
-00011260: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00011270: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00011280: 5465 7374 280a 2020 2020 2020 2020 276b  Test(.        'k
-00011290: 7562 6572 6e65 7465 735f 6874 7470 5f73  ubernetes_http_s
-000112a0: 6572 7665 725f 7769 7468 5f63 7573 746f  erver_with_custo
-000112b0: 6d5f 706f 7274 7327 2c0a 2020 2020 2020  m_ports',.      
-000112c0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-000112d0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-000112e0: 2d64 202d 6320 7b6e 616d 657d 202d 2d63  -d -c {name} --c
-000112f0: 6c6f 7564 206b 7562 6572 6e65 7465 7320  loud kubernetes 
-00011300: 6578 616d 706c 6573 2f68 7474 705f 7365  examples/http_se
-00011310: 7276 6572 5f77 6974 685f 6375 7374 6f6d  rver_with_custom
-00011320: 5f70 6f72 7473 2f74 6173 6b2e 7961 6d6c  _ports/task.yaml
-00011330: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00011340: 2775 6e74 696c 2053 4b59 5049 4c4f 545f  'until SKYPILOT_
-00011350: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
-00011360: 7573 202d 2d65 6e64 706f 696e 7420 3333  us --endpoint 33
-00011370: 3832 3820 7b6e 616d 657d 3b20 646f 2073  828 {name}; do s
-00011380: 6c65 6570 2031 303b 2064 6f6e 6527 2c0a  leep 10; done',.
-00011390: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-000113a0: 7472 7920 6120 6665 7720 7469 6d65 7320  try a few times 
-000113b0: 746f 2061 766f 6964 2066 6c61 6b69 6e65  to avoid flakine
-000113c0: 7373 2069 6e20 706f 7274 7320 6265 696e  ss in ports bein
-000113d0: 6720 6f70 656e 2e0a 2020 2020 2020 2020  g open..        
-000113e0: 2020 2020 6627 6970 3d24 2853 4b59 5049      f'ip=$(SKYPI
-000113f0: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
-00011400: 7374 6174 7573 202d 2d65 6e64 706f 696e  status --endpoin
-00011410: 7420 3333 3832 3820 7b6e 616d 657d 293b  t 33828 {name});
-00011420: 2073 7563 6365 7373 3d66 616c 7365 3b20   success=false; 
-00011430: 666f 7220 6920 696e 2024 2873 6571 2031  for i in $(seq 1
-00011440: 2031 3030 293b 2064 6f20 6966 2063 7572   100); do if cur
-00011450: 6c20 2469 7020 7c20 6772 6570 2022 3c68  l $ip | grep "<h
-00011460: 313e 5468 6973 2069 7320 6120 6465 6d6f  1>This is a demo
-00011470: 2048 544d 4c20 7061 6765 2e3c 2f68 313e   HTML page.</h1>
-00011480: 223b 2074 6865 6e20 7375 6363 6573 733d  "; then success=
-00011490: 7472 7565 3b20 6272 6561 6b3b 2066 693b  true; break; fi;
-000114a0: 2073 6c65 6570 2035 3b20 646f 6e65 3b20   sleep 5; done; 
-000114b0: 6966 205b 2022 2473 7563 6365 7373 2220  if [ "$success" 
-000114c0: 3d20 6661 6c73 6520 5d3b 2074 6865 6e20  = false ]; then 
-000114d0: 6578 6974 2031 3b20 6669 270a 2020 2020  exit 1; fi'.    
-000114e0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-000114f0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00011500: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00011510: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00011520: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-00011530: 2d20 5765 6220 6170 7073 2077 6974 6820  - Web apps with 
-00011540: 6375 7374 6f6d 2070 6f72 7473 206f 6e20  custom ports on 
-00011550: 5061 7065 7273 7061 6365 2e20 2d2d 2d2d  Paperspace. ----
-00011560: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00011570: 6172 6b2e 7061 7065 7273 7061 6365 0a64  ark.paperspace.d
-00011580: 6566 2074 6573 745f 7061 7065 7273 7061  ef test_paperspa
-00011590: 6365 5f68 7474 705f 7365 7276 6572 5f77  ce_http_server_w
-000115a0: 6974 685f 6375 7374 6f6d 5f70 6f72 7473  ith_custom_ports
-000115b0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-000115c0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000115d0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-000115e0: 7374 280a 2020 2020 2020 2020 2770 6170  st(.        'pap
-000115f0: 6572 7370 6163 655f 6874 7470 5f73 6572  erspace_http_ser
-00011600: 7665 725f 7769 7468 5f63 7573 746f 6d5f  ver_with_custom_
-00011610: 706f 7274 7327 2c0a 2020 2020 2020 2020  ports',.        
-00011620: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00011630: 736b 7920 6c61 756e 6368 202d 7920 2d64  sky launch -y -d
-00011640: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-00011650: 7564 2070 6170 6572 7370 6163 6520 6578  ud paperspace ex
-00011660: 616d 706c 6573 2f68 7474 705f 7365 7276  amples/http_serv
-00011670: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
-00011680: 6f72 7473 2f74 6173 6b2e 7961 6d6c 272c  orts/task.yaml',
-00011690: 0a20 2020 2020 2020 2020 2020 2066 2775  .            f'u
-000116a0: 6e74 696c 2053 4b59 5049 4c4f 545f 4445  ntil SKYPILOT_DE
-000116b0: 4255 473d 3020 736b 7920 7374 6174 7573  BUG=0 sky status
-000116c0: 202d 2d65 6e64 706f 696e 7420 3333 3832   --endpoint 3382
-000116d0: 3820 7b6e 616d 657d 3b20 646f 2073 6c65  8 {name}; do sle
-000116e0: 6570 2031 303b 2064 6f6e 6527 2c0a 2020  ep 10; done',.  
-000116f0: 2020 2020 2020 2020 2020 2320 5265 7472            # Retr
-00011700: 7920 6120 6665 7720 7469 6d65 7320 746f  y a few times to
-00011710: 2061 766f 6964 2066 6c61 6b69 6e65 7373   avoid flakiness
-00011720: 2069 6e20 706f 7274 7320 6265 696e 6720   in ports being 
-00011730: 6f70 656e 2e0a 2020 2020 2020 2020 2020  open..          
-00011740: 2020 6627 6970 3d24 2853 4b59 5049 4c4f    f'ip=$(SKYPILO
-00011750: 545f 4445 4255 473d 3020 736b 7920 7374  T_DEBUG=0 sky st
-00011760: 6174 7573 202d 2d65 6e64 706f 696e 7420  atus --endpoint 
-00011770: 3333 3832 3820 7b6e 616d 657d 293b 2073  33828 {name}); s
-00011780: 7563 6365 7373 3d66 616c 7365 3b20 666f  uccess=false; fo
-00011790: 7220 6920 696e 2024 2873 6571 2031 2035  r i in $(seq 1 5
-000117a0: 293b 2064 6f20 6966 2063 7572 6c20 2469  ); do if curl $i
-000117b0: 7020 7c20 6772 6570 2022 3c68 313e 5468  p | grep "<h1>Th
-000117c0: 6973 2069 7320 6120 6465 6d6f 2048 544d  is is a demo HTM
-000117d0: 4c20 7061 6765 2e3c 2f68 313e 223b 2074  L page.</h1>"; t
-000117e0: 6865 6e20 7375 6363 6573 733d 7472 7565  hen success=true
-000117f0: 3b20 6272 6561 6b3b 2066 693b 2073 6c65  ; break; fi; sle
-00011800: 6570 2031 303b 2064 6f6e 653b 2069 6620  ep 10; done; if 
-00011810: 5b20 2224 7375 6363 6573 7322 203d 2066  [ "$success" = f
-00011820: 616c 7365 205d 3b20 7468 656e 2065 7869  alse ]; then exi
-00011830: 7420 313b 2066 6927 2c0a 2020 2020 2020  t 1; fi',.      
-00011840: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00011850: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00011860: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00011870: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00011880: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-00011890: 5461 736b 3a20 6e3d 3220 6e6f 6465 7320  Task: n=2 nodes 
-000118a0: 7769 7468 2073 6574 7570 732e 202d 2d2d  with setups. ---
-000118b0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-000118c0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-000118d0: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-000118e0: 6c6f 7564 2064 6f65 7320 6e6f 7420 6861  loud does not ha
-000118f0: 7665 2056 3130 3020 6770 7573 0a40 7079  ve V100 gpus.@py
-00011900: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
-00011910: 2020 2320 4942 4d20 636c 6f75 6420 6375    # IBM cloud cu
-00011920: 7272 656e 746c 7920 646f 6573 6e27 7420  rrently doesn't 
-00011930: 7072 6f76 6964 6520 7075 626c 6963 2069  provide public i
-00011940: 6d61 6765 2077 6974 6820 4355 4441 0a40  mage with CUDA.@
-00011950: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
-00011960: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
-00011970: 6f74 2073 7570 706f 7274 206e 756d 5f6e  ot support num_n
-00011980: 6f64 6573 203e 2031 2079 6574 0a40 7079  odes > 1 yet.@py
-00011990: 7465 7374 2e6d 6172 6b2e 736b 6970 280a  test.mark.skip(.
-000119a0: 2020 2020 7265 6173 6f6e 3d0a 2020 2020      reason=.    
-000119b0: 2754 6865 2072 6573 6e65 745f 6469 7374  'The resnet_dist
-000119c0: 7269 6275 7465 645f 7466 5f61 7070 2069  ributed_tf_app i
-000119d0: 7320 666c 616b 792c 2064 7565 2074 6f20  s flaky, due to 
-000119e0: 6974 2066 6169 6c69 6e67 2074 6f20 6465  it failing to de
-000119f0: 7465 6374 2047 5055 732e 2729 0a64 6566  tect GPUs.').def
-00011a00: 2074 6573 745f 6469 7374 7269 6275 7465   test_distribute
-00011a10: 645f 7466 2867 656e 6572 6963 5f63 6c6f  d_tf(generic_clo
-00011a20: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-00011a30: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00011a40: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00011a50: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00011a60: 2020 2772 6573 6e65 745f 6469 7374 7269    'resnet_distri
-00011a70: 6275 7465 645f 7466 5f61 7070 272c 0a20  buted_tf_app',. 
-00011a80: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00011a90: 2020 2020 2023 204e 4f54 453a 2072 756e       # NOTE: run
-00011aa0: 6e69 6e67 2069 7420 7477 6963 6520 7769  ning it twice wi
-00011ab0: 6c6c 2068 616e 6720 2873 6f6d 6574 696d  ll hang (sometim
-00011ac0: 6573 3f29 202d 2061 6e20 6170 702d 6c65  es?) - an app-le
-00011ad0: 7665 6c20 6275 672e 0a20 2020 2020 2020  vel bug..       
-00011ae0: 2020 2020 2066 2770 7974 686f 6e20 6578       f'python ex
-00011af0: 616d 706c 6573 2f72 6573 6e65 745f 6469  amples/resnet_di
-00011b00: 7374 7269 6275 7465 645f 7466 5f61 7070  stributed_tf_app
-00011b10: 2e70 7920 7b6e 616d 657d 207b 6765 6e65  .py {name} {gene
-00011b20: 7269 635f 636c 6f75 647d 272c 0a20 2020  ric_cloud}',.   
-00011b30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00011b40: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00011b50: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00011b60: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00011b70: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-00011b80: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00011b90: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00011ba0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-00011bb0: 3520 2a20 3630 2c20 2023 2032 3520 6d69  5 * 60,  # 25 mi
-00011bc0: 6e73 2028 6974 2074 616b 6573 2061 726f  ns (it takes aro
-00011bd0: 756e 6420 7e31 3920 6d69 6e73 290a 2020  und ~19 mins).  
-00011be0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00011bf0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00011c00: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
-00011c10: 6720 4743 5020 7374 6172 7420 616e 6420  g GCP start and 
-00011c20: 7374 6f70 2069 6e73 7461 6e63 6573 202d  stop instances -
-00011c30: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-00011c40: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-00011c50: 6573 745f 6763 705f 7374 6172 745f 7374  est_gcp_start_st
-00011c60: 6f70 2829 3a0a 2020 2020 6e61 6d65 203d  op():.    name =
-00011c70: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00011c80: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00011c90: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
-00011ca0: 6370 2d73 7461 7274 2d73 746f 7027 2c0a  cp-start-stop',.
-00011cb0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00011cc0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00011cd0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00011ce0: 6578 616d 706c 6573 2f67 6370 5f73 7461  examples/gcp_sta
-00011cf0: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
-00011d00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00011d10: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00011d20: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-00011d30: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-00011d40: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-00011d50: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00011d60: 616d 657d 2065 7861 6d70 6c65 732f 6763  ame} examples/gc
-00011d70: 705f 7374 6172 745f 7374 6f70 2e79 616d  p_start_stop.yam
-00011d80: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00011d90: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00011da0: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
-00011db0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00011dc0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00011dd0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00011de0: 6563 207b 6e61 6d65 7d20 2270 726c 696d  ec {name} "prlim
-00011df0: 6974 202d 6e20 2d2d 7069 643d 5c24 2870  it -n --pid=\$(p
-00011e00: 6772 6570 202d 6620 5c27 7261 796c 6574  grep -f \'raylet
-00011e10: 2f72 6179 6c65 7420 2d2d 7261 796c 6574  /raylet --raylet
-00011e20: 5f73 6f63 6b65 745f 6e61 6d65 5c27 2920  _socket_name\') 
-00011e30: 7c20 6772 6570 205c 2722 5c27 3130 3438  | grep \'"\'1048
-00011e40: 3537 3620 3130 3438 3537 365c 2722 5c27  576 1048576\'"\'
-00011e50: 2227 2c20 2023 2045 6e73 7572 6520 7468  "',  # Ensure th
-00011e60: 6520 7261 796c 6574 2070 726f 6365 7373  e raylet process
-00011e70: 2068 6173 2074 6865 2063 6f72 7265 6374   has the correct
-00011e80: 2066 696c 6520 6465 7363 7269 7074 6f72   file descriptor
-00011e90: 206c 696d 6974 2e0a 2020 2020 2020 2020   limit..        
-00011ea0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00011eb0: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
-00011ec0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00011ed0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-00011ee0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00011ef0: 7920 7374 6f70 202d 7920 7b6e 616d 657d  y stop -y {name}
-00011f00: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00011f10: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
-00011f20: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00011f30: 6172 7420 2d79 207b 6e61 6d65 7d20 2d69  art -y {name} -i
-00011f40: 2031 272c 0a20 2020 2020 2020 2020 2020   1',.           
-00011f50: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00011f60: 657d 2065 7861 6d70 6c65 732f 6763 705f  e} examples/gcp_
-00011f70: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
-00011f80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00011f90: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00011fa0: 3420 2d2d 7374 6174 7573 272c 2020 2320  4 --status',  # 
-00011fb0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00011fc0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00011fd0: 2020 2020 2020 2773 6c65 6570 2031 3830        'sleep 180
-00011fe0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00011ff0: 2773 6b79 2073 7461 7475 7320 2d72 207b  'sky status -r {
-00012000: 6e61 6d65 7d20 7c20 6772 6570 2022 494e  name} | grep "IN
-00012010: 4954 5c7c 5354 4f50 5045 4422 272c 0a20  IT\|STOPPED"',. 
-00012020: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00012030: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00012040: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00012050: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00012060: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00012070: 2d2d 2d2d 2054 6573 7469 6e67 2041 7a75  ---- Testing Azu
-00012080: 7265 2073 7461 7274 2061 6e64 2073 746f  re start and sto
-00012090: 7020 696e 7374 616e 6365 7320 2d2d 2d2d  p instances ----
-000120a0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-000120b0: 6172 6b2e 617a 7572 650a 6465 6620 7465  ark.azure.def te
-000120c0: 7374 5f61 7a75 7265 5f73 7461 7274 5f73  st_azure_start_s
-000120d0: 746f 7028 293a 0a20 2020 206e 616d 6520  top():.    name 
-000120e0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-000120f0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00012100: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00012110: 617a 7572 652d 7374 6172 742d 7374 6f70  azure-start-stop
-00012120: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00012130: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00012140: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00012150: 657d 2065 7861 6d70 6c65 732f 617a 7572  e} examples/azur
-00012160: 655f 7374 6172 745f 7374 6f70 2e79 616d  e_start_stop.yam
-00012170: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00012180: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00012190: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
-000121a0: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
-000121b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000121c0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000121d0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-000121e0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-000121f0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00012200: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00012210: 6320 7b6e 616d 657d 2022 7072 6c69 6d69  c {name} "prlimi
-00012220: 7420 2d6e 202d 2d70 6964 3d5c 2428 7067  t -n --pid=\$(pg
-00012230: 7265 7020 2d66 205c 2772 6179 6c65 742f  rep -f \'raylet/
-00012240: 7261 796c 6574 202d 2d72 6179 6c65 745f  raylet --raylet_
-00012250: 736f 636b 6574 5f6e 616d 655c 2729 207c  socket_name\') |
-00012260: 2067 7265 7020 5c27 225c 2731 3034 3835   grep \'"\'10485
-00012270: 3736 2031 3034 3835 3736 5c27 225c 2722  76 1048576\'"\'"
-00012280: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00012290: 2072 6179 6c65 7420 7072 6f63 6573 7320   raylet process 
-000122a0: 6861 7320 7468 6520 636f 7272 6563 7420  has the correct 
-000122b0: 6669 6c65 2064 6573 6372 6970 746f 7220  file descriptor 
-000122c0: 6c69 6d69 742e 0a20 2020 2020 2020 2020  limit..         
-000122d0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000122e0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-000122f0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00012300: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00012310: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00012320: 2073 746f 7020 2d79 207b 6e61 6d65 7d27   stop -y {name}'
-00012330: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00012340: 736b 7920 7374 6172 7420 2d79 207b 6e61  sky start -y {na
-00012350: 6d65 7d20 2d69 2031 272c 0a20 2020 2020  me} -i 1',.     
-00012360: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00012370: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-00012380: 732f 617a 7572 655f 7374 6172 745f 7374  s/azure_start_st
-00012390: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
-000123a0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000123b0: 207b 6e61 6d65 7d20 3320 2d2d 7374 6174   {name} 3 --stat
-000123c0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-000123d0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-000123e0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-000123f0: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
-00012400: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00012410: 2073 7461 7475 7320 2d72 207b 6e61 6d65   status -r {name
-00012420: 7d29 2026 2620 6563 686f 2024 7320 2626  }) && echo $s &&
-00012430: 2065 6368 6f20 2473 207c 2067 7265 7020   echo $s | grep 
-00012440: 2249 4e49 545c 7c53 544f 5050 4544 2227  "INIT\|STOPPED"'
-00012450: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00012460: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00012470: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00012480: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
-00012490: 3630 2c20 2023 2033 3020 6d69 6e73 0a20  60,  # 30 mins. 
-000124a0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-000124b0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-000124c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-000124d0: 6e67 2041 7574 6f73 746f 7070 696e 6720  ng Autostopping 
-000124e0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-000124f0: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-00012500: 7374 6163 6b20 2023 2046 6c75 6964 5374  stack  # FluidSt
-00012510: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
-00012520: 706f 7274 2073 746f 7070 696e 6720 696e  port stopping in
-00012530: 2053 6b79 5069 6c6f 7420 696d 706c 656d   SkyPilot implem
-00012540: 656e 7461 7469 6f6e 0a40 7079 7465 7374  entation.@pytest
-00012550: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
-00012560: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
-00012570: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-00012580: 7570 706f 7274 2073 746f 7070 696e 6720  upport stopping 
-00012590: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-000125a0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-000125b0: 2046 4958 2849 424d 2920 7370 6f72 6164   FIX(IBM) sporad
-000125c0: 6963 616c 6c79 2066 6169 6c73 2c20 6173  ically fails, as
-000125d0: 2072 6573 7461 7274 6564 2077 6f72 6b65   restarted worke
-000125e0: 7273 2073 7461 7920 756e 696e 6974 6961  rs stay uninitia
-000125f0: 6c69 7a65 6420 696e 6465 6669 6e69 7465  lized indefinite
-00012600: 6c79 0a40 7079 7465 7374 2e6d 6172 6b2e  ly.@pytest.mark.
-00012610: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-00012620: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
-00012630: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
-00012640: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00012650: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
-00012660: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
-00012670: 6f74 2061 7574 6f73 746f 7020 7965 740a  ot autostop yet.
-00012680: 6465 6620 7465 7374 5f61 7574 6f73 746f  def test_autosto
-00012690: 7028 6765 6e65 7269 635f 636c 6f75 643a  p(generic_cloud:
-000126a0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-000126b0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-000126c0: 616d 6528 290a 2020 2020 2320 417a 7572  ame().    # Azur
-000126d0: 6520 7461 6b65 7320 7e20 376d 3135 7320  e takes ~ 7m15s 
-000126e0: 2834 3335 7329 2074 6f20 6175 746f 7374  (435s) to autost
-000126f0: 6f70 2061 2056 4d2c 2073 6f20 6865 7265  op a VM, so here
-00012700: 2077 6520 7573 6520 3630 3020 746f 2065   we use 600 to e
-00012710: 6e73 7572 650a 2020 2020 2320 7468 6520  nsure.    # the 
-00012720: 564d 2069 7320 7374 6f70 7065 642e 0a20  VM is stopped.. 
-00012730: 2020 2061 7574 6f73 746f 705f 7469 6d65     autostop_time
-00012740: 6f75 7420 3d20 3630 3020 6966 2067 656e  out = 600 if gen
-00012750: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
-00012760: 7a75 7265 2720 656c 7365 2032 3530 0a20  zure' else 250. 
-00012770: 2020 2023 204c 6175 6e63 6869 6e67 2061     # Launching a
-00012780: 6e64 2073 7461 7274 696e 6720 417a 7572  nd starting Azur
-00012790: 6520 636c 7573 7465 7273 2063 616e 2074  e clusters can t
-000127a0: 616b 6520 6120 6c6f 6e67 2074 696d 6520  ake a long time 
-000127b0: 746f 6f2e 2065 2e67 2e2c 2072 6573 7461  too. e.g., resta
-000127c0: 7274 0a20 2020 2023 2061 2073 746f 7070  rt.    # a stopp
-000127d0: 6564 2041 7a75 7265 2063 6c75 7374 6572  ed Azure cluster
-000127e0: 2063 616e 2074 616b 6520 376d 2e20 536f   can take 7m. So
-000127f0: 2077 6520 7365 7420 7468 6520 746f 7461   we set the tota
-00012800: 6c20 7469 6d65 6f75 7420 746f 2037 306d  l timeout to 70m
-00012810: 2e0a 2020 2020 746f 7461 6c5f 7469 6d65  ..    total_time
-00012820: 6f75 745f 6d69 6e75 7465 7320 3d20 3730  out_minutes = 70
-00012830: 2069 6620 6765 6e65 7269 635f 636c 6f75   if generic_clou
-00012840: 6420 3d3d 2027 617a 7572 6527 2065 6c73  d == 'azure' els
-00012850: 6520 3230 0a20 2020 2074 6573 7420 3d20  e 20.    test = 
-00012860: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-00012870: 7574 6f73 746f 7027 2c0a 2020 2020 2020  utostop',.      
-00012880: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00012890: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-000128a0: 2d64 202d 6320 7b6e 616d 657d 202d 2d6e  -d -c {name} --n
-000128b0: 756d 2d6e 6f64 6573 2032 202d 2d63 6c6f  um-nodes 2 --clo
-000128c0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-000128d0: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
-000128e0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-000128f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00012900: 2773 6b79 2061 7574 6f73 746f 7020 2d79  'sky autostop -y
-00012910: 207b 6e61 6d65 7d20 2d69 2031 272c 0a0a   {name} -i 1',..
-00012920: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-00012930: 7375 7265 2061 7574 6f73 746f 7020 6973  sure autostop is
-00012940: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
-00012950: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-00012960: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00012970: 7265 7020 2231 6d22 272c 0a0a 2020 2020  rep "1m"',..    
-00012980: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-00012990: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-000129a0: 6e6f 7420 7374 6f70 7065 6420 6561 726c  not stopped earl
-000129b0: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
-000129c0: 736c 6565 7020 3430 272c 0a20 2020 2020  sleep 40',.     
-000129d0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-000129e0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-000129f0: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-00012a00: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-00012a10: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
-00012a20: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00012a30: 7020 5550 272c 0a0a 2020 2020 2020 2020  p UP',..        
-00012a40: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
-00012a50: 2063 6c75 7374 6572 2069 7320 5354 4f50   cluster is STOP
-00012a60: 5045 442e 0a20 2020 2020 2020 2020 2020  PED..           
-00012a70: 2066 2773 6c65 6570 207b 6175 746f 7374   f'sleep {autost
-00012a80: 6f70 5f74 696d 656f 7574 7d27 2c0a 2020  op_timeout}',.  
-00012a90: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00012aa0: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
-00012ab0: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
-00012ac0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-00012ad0: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
-00012ae0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00012af0: 6772 6570 2053 544f 5050 4544 272c 0a0a  grep STOPPED',..
-00012b00: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-00012b10: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
-00012b20: 2069 7320 5550 2061 6e64 2074 6865 2061   is UP and the a
-00012b30: 7574 6f73 746f 7020 7365 7474 696e 6720  utostop setting 
-00012b40: 6973 2072 6573 6574 2028 272d 2729 2e0a  is reset ('-')..
-00012b50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00012b60: 7920 7374 6172 7420 2d79 207b 6e61 6d65  y start -y {name
-00012b70: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00012b80: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
-00012b90: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00012ba0: 7020 2d45 2022 5550 5c73 2b2d 2227 2c0a  p -E "UP\s+-"',.
-00012bb0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-00012bc0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-00012bd0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-00012be0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00012bf0: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
-00012c00: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-00012c10: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00012c20: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00012c30: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-00012c40: 2c0a 0a20 2020 2020 2020 2020 2020 2023  ,..            #
-00012c50: 2054 6573 7420 7265 7374 6172 7469 6e67   Test restarting
-00012c60: 2074 6865 2069 646c 656e 6573 7320 7469   the idleness ti
-00012c70: 6d65 7220 7669 6120 7265 7365 743a 0a20  mer via reset:. 
-00012c80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00012c90: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
-00012ca0: 6d65 7d20 2d69 2031 272c 2020 2320 4964  me} -i 1',  # Id
-00012cb0: 6c65 6e65 7373 2073 7461 7274 7320 636f  leness starts co
-00012cc0: 756e 7469 6e67 2e0a 2020 2020 2020 2020  unting..        
-00012cd0: 2020 2020 2773 6c65 6570 2034 3027 2c20      'sleep 40', 
-00012ce0: 2023 2041 6c6d 6f73 7420 7265 6163 6865   # Almost reache
-00012cf0: 6420 7468 6520 7468 7265 7368 6f6c 642e  d the threshold.
-00012d00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00012d10: 6b79 2061 7574 6f73 746f 7020 2d79 207b  ky autostop -y {
-00012d20: 6e61 6d65 7d20 2d69 2031 272c 2020 2320  name} -i 1',  # 
-00012d30: 5368 6f75 6c64 2072 6573 7461 7274 2074  Should restart t
-00012d40: 6865 2074 696d 6572 2e0a 2020 2020 2020  he timer..      
-00012d50: 2020 2020 2020 2773 6c65 6570 2034 3027        'sleep 40'
-00012d60: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00012d70: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
-00012d80: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
-00012d90: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00012da0: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00012db0: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-00012dc0: 207c 2067 7265 7020 5550 272c 0a20 2020   | grep UP',.   
-00012dd0: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-00012de0: 207b 6175 746f 7374 6f70 5f74 696d 656f   {autostop_timeo
-00012df0: 7574 7d27 2c0a 2020 2020 2020 2020 2020  ut}',.          
-00012e00: 2020 6627 733d 2428 736b 7920 7374 6174    f's=$(sky stat
-00012e10: 7573 207b 6e61 6d65 7d20 2d2d 7265 6672  us {name} --refr
-00012e20: 6573 6829 3b20 6563 686f 2022 2473 223b  esh); echo "$s";
-00012e30: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-00012e40: 6f20 2224 7322 2020 7c20 6772 6570 207b  o "$s"  | grep {
-00012e50: 6e61 6d65 7d20 7c20 6772 6570 2053 544f  name} | grep STO
-00012e60: 5050 4544 272c 0a0a 2020 2020 2020 2020  PPED',..        
-00012e70: 2020 2020 2320 5465 7374 2072 6573 7461      # Test resta
-00012e80: 7274 696e 6720 7468 6520 6964 6c65 6e65  rting the idlene
-00012e90: 7373 2074 696d 6572 2076 6961 2065 7865  ss timer via exe
-00012ea0: 633a 0a20 2020 2020 2020 2020 2020 2066  c:.            f
-00012eb0: 2773 6b79 2073 7461 7274 202d 7920 7b6e  'sky start -y {n
-00012ec0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-00012ed0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00012ee0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00012ef0: 6772 6570 202d 4520 2255 505c 732b 2d22  grep -E "UP\s+-"
-00012f00: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00012f10: 2773 6b79 2061 7574 6f73 746f 7020 2d79  'sky autostop -y
-00012f20: 207b 6e61 6d65 7d20 2d69 2031 272c 2020   {name} -i 1',  
-00012f30: 2320 4964 6c65 6e65 7373 2073 7461 7274  # Idleness start
-00012f40: 7320 636f 756e 7469 6e67 2e0a 2020 2020  s counting..    
-00012f50: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
-00012f60: 3527 2c20 2023 2041 6c6d 6f73 7420 7265  5',  # Almost re
-00012f70: 6163 6865 6420 7468 6520 7468 7265 7368  ached the thresh
-00012f80: 6f6c 642e 0a20 2020 2020 2020 2020 2020  old..           
-00012f90: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00012fa0: 657d 2065 6368 6f20 6869 272c 2020 2320  e} echo hi',  # 
-00012fb0: 5368 6f75 6c64 2072 6573 7461 7274 2074  Should restart t
-00012fc0: 6865 2074 696d 6572 2e0a 2020 2020 2020  he timer..      
-00012fd0: 2020 2020 2020 2773 6c65 6570 2034 3527        'sleep 45'
-00012fe0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00012ff0: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
-00013000: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
-00013010: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00013020: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00013030: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
-00013040: 7d20 7c20 6772 6570 2055 5027 2c0a 2020  } | grep UP',.  
-00013050: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
-00013060: 7020 7b61 7574 6f73 746f 705f 7469 6d65  p {autostop_time
-00013070: 6f75 747d 272c 0a20 2020 2020 2020 2020  out}',.         
-00013080: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
-00013090: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
-000130a0: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
-000130b0: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-000130c0: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
-000130d0: 7b6e 616d 657d 207c 2067 7265 7020 5354  {name} | grep ST
-000130e0: 4f50 5045 4427 2c0a 2020 2020 2020 2020  OPPED',.        
-000130f0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00013100: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00013110: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00013120: 743d 746f 7461 6c5f 7469 6d65 6f75 745f  t=total_timeout_
-00013130: 6d69 6e75 7465 7320 2a20 3630 2c0a 2020  minutes * 60,.  
-00013140: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00013150: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00013160: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
-00013170: 6720 4175 746f 646f 776e 696e 6720 2d2d  g Autodowning --
-00013180: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-00013190: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-000131a0: 6163 6b20 2023 2046 6c75 6964 5374 6163  ack  # FluidStac
-000131b0: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
-000131c0: 7274 2073 746f 7070 696e 6720 696e 2053  rt stopping in S
-000131d0: 6b79 5069 6c6f 7420 696d 706c 656d 656e  kyPilot implemen
-000131e0: 7461 7469 6f6e 0a40 7079 7465 7374 2e6d  tation.@pytest.m
-000131f0: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
-00013200: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
-00013210: 7274 206e 756d 5f6e 6f64 6573 203e 2031  rt num_nodes > 1
-00013220: 2079 6574 2e20 5275 6e20 7465 7374 5f73   yet. Run test_s
-00013230: 6370 5f61 7574 6f64 6f77 6e20 696e 7374  cp_autodown inst
-00013240: 6561 642e 0a64 6566 2074 6573 745f 6175  ead..def test_au
-00013250: 746f 646f 776e 2867 656e 6572 6963 5f63  todown(generic_c
-00013260: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00013270: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00013280: 7465 725f 6e61 6d65 2829 0a20 2020 2023  ter_name().    #
-00013290: 2041 7a75 7265 2074 616b 6573 207e 2031   Azure takes ~ 1
-000132a0: 336d 3330 7320 2838 3130 7329 2074 6f20  3m30s (810s) to 
-000132b0: 6175 746f 646f 776e 2061 2056 4d2c 2073  autodown a VM, s
-000132c0: 6f20 6865 7265 2077 6520 7573 6520 3930  o here we use 90
-000132d0: 3020 746f 2065 6e73 7572 650a 2020 2020  0 to ensure.    
-000132e0: 2320 7468 6520 564d 2069 7320 7465 726d  # the VM is term
-000132f0: 696e 6174 6564 2e0a 2020 2020 6175 746f  inated..    auto
-00013300: 646f 776e 5f74 696d 656f 7574 203d 2039  down_timeout = 9
-00013310: 3030 2069 6620 6765 6e65 7269 635f 636c  00 if generic_cl
-00013320: 6f75 6420 3d3d 2027 617a 7572 6527 2065  oud == 'azure' e
-00013330: 6c73 6520 3234 300a 2020 2020 746f 7461  lse 240.    tota
-00013340: 6c5f 7469 6d65 6f75 745f 6d69 6e75 7465  l_timeout_minute
-00013350: 7320 3d20 3930 2069 6620 6765 6e65 7269  s = 90 if generi
-00013360: 635f 636c 6f75 6420 3d3d 2027 617a 7572  c_cloud == 'azur
-00013370: 6527 2065 6c73 6520 3230 0a20 2020 2074  e' else 20.    t
-00013380: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00013390: 2020 2020 2761 7574 6f64 6f77 6e27 2c0a      'autodown',.
-000133a0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-000133b0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000133c0: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
-000133d0: 657d 202d 2d6e 756d 2d6e 6f64 6573 2032  e} --num-nodes 2
-000133e0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-000133f0: 635f 636c 6f75 647d 2074 6573 7473 2f74  c_cloud} tests/t
-00013400: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
-00013410: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00013420: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
-00013430: 746f 7020 2d79 207b 6e61 6d65 7d20 2d2d  top -y {name} --
-00013440: 646f 776e 202d 6920 3127 2c0a 2020 2020  down -i 1',.    
-00013450: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-00013460: 2061 7574 6f73 746f 7020 6973 2073 6574   autostop is set
-00013470: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00013480: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
-00013490: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-000134a0: 2231 6d20 2864 6f77 6e29 2227 2c0a 2020  "1m (down)"',.  
-000134b0: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
-000134c0: 7265 2074 6865 2063 6c75 7374 6572 2069  re the cluster i
-000134d0: 7320 6e6f 7420 7465 726d 696e 6174 6564  s not terminated
-000134e0: 2065 6172 6c79 2e0a 2020 2020 2020 2020   early..        
-000134f0: 2020 2020 2773 6c65 6570 2034 3027 2c0a      'sleep 40',.
-00013500: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-00013510: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-00013520: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-00013530: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-00013540: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-00013550: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
-00013560: 7c20 6772 6570 2055 5027 2c0a 2020 2020  | grep UP',.    
-00013570: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-00013580: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-00013590: 7465 726d 696e 6174 6564 2e0a 2020 2020  terminated..    
-000135a0: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
-000135b0: 7b61 7574 6f64 6f77 6e5f 7469 6d65 6f75  {autodown_timeou
-000135c0: 747d 272c 0a20 2020 2020 2020 2020 2020  t}',.           
-000135d0: 2066 2773 3d24 2853 4b59 5049 4c4f 545f   f's=$(SKYPILOT_
-000135e0: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
-000135f0: 7573 207b 6e61 6d65 7d20 2d2d 7265 6672  us {name} --refr
-00013600: 6573 6829 2026 2620 6563 686f 2022 2473  esh) && echo "$s
-00013610: 2220 2626 207b 7b20 6563 686f 2022 2473  " && {{ echo "$s
-00013620: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
-00013630: 7c20 6772 6570 2022 4175 746f 646f 776e  | grep "Autodown
-00013640: 6564 2063 6c75 7374 6572 5c7c 7465 726d  ed cluster\|term
-00013650: 696e 6174 6564 206f 6e20 7468 6520 636c  inated on the cl
-00013660: 6f75 6422 3b20 7d7d 207c 7c20 7b7b 2065  oud"; }} || {{ e
-00013670: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00013680: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
-00013690: 207c 7c20 6578 6974 2030 3b20 7d7d 272c   || exit 0; }}',
-000136a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000136b0: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
-000136c0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-000136d0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-000136e0: 7d20 2d2d 6e75 6d2d 6e6f 6465 7320 3220  } --num-nodes 2 
-000136f0: 2d2d 646f 776e 2074 6573 7473 2f74 6573  --down tests/tes
-00013700: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-00013710: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00013720: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00013730: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00013740: 6772 6570 2055 5027 2c20 2023 2045 6e73  grep UP',  # Ens
-00013750: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
-00013760: 6973 2055 502e 0a20 2020 2020 2020 2020  is UP..         
-00013770: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00013780: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00013790: 6e65 7269 635f 636c 6f75 647d 2074 6573  neric_cloud} tes
-000137a0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-000137b0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-000137c0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000137d0: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
-000137e0: 6d65 7d20 7c20 6772 6570 2022 316d 2028  me} | grep "1m (
-000137f0: 646f 776e 2922 272c 0a20 2020 2020 2020  down)"',.       
-00013800: 2020 2020 2066 2773 6c65 6570 207b 6175       f'sleep {au
-00013810: 746f 646f 776e 5f74 696d 656f 7574 7d27  todown_timeout}'
-00013820: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00013830: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
-00013840: 6572 2069 7320 7465 726d 696e 6174 6564  er is terminated
-00013850: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00013860: 733d 2428 534b 5950 494c 4f54 5f44 4542  s=$(SKYPILOT_DEB
-00013870: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
-00013880: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
-00013890: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-000138a0: 2620 7b7b 2065 6368 6f20 2224 7322 207c  & {{ echo "$s" |
-000138b0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-000138c0: 7265 7020 2241 7574 6f64 6f77 6e65 6420  rep "Autodowned 
-000138d0: 636c 7573 7465 725c 7c74 6572 6d69 6e61  cluster\|termina
-000138e0: 7465 6420 6f6e 2074 6865 2063 6c6f 7564  ted on the cloud
-000138f0: 223b 207d 7d20 7c7c 207b 7b20 6563 686f  "; }} || {{ echo
-00013900: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-00013910: 6d65 7d20 2626 2065 7869 7420 3120 7c7c  me} && exit 1 ||
-00013920: 2065 7869 7420 303b 207d 7d27 2c0a 2020   exit 0; }}',.  
-00013930: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00013940: 6c61 756e 6368 202d 7920 2d64 202d 6320  launch -y -d -c 
-00013950: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-00013960: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-00013970: 2d6e 756d 2d6e 6f64 6573 2032 202d 2d64  -num-nodes 2 --d
-00013980: 6f77 6e20 7465 7374 732f 7465 7374 5f79  own tests/test_y
-00013990: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-000139a0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000139b0: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
-000139c0: 7920 7b6e 616d 657d 202d 2d63 616e 6365  y {name} --cance
-000139d0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000139e0: 6627 736c 6565 7020 7b61 7574 6f64 6f77  f'sleep {autodow
-000139f0: 6e5f 7469 6d65 6f75 747d 272c 0a20 2020  n_timeout}',.   
-00013a00: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-00013a10: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
-00013a20: 2073 7469 6c6c 2055 502e 0a20 2020 2020   still UP..     
-00013a30: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
-00013a40: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
-00013a50: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-00013a60: 2d2d 7265 6672 6573 6829 2026 2620 6563  --refresh) && ec
-00013a70: 686f 2022 2473 2220 2626 2065 6368 6f20  ho "$s" && echo 
-00013a80: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-00013a90: 657d 207c 2067 7265 7020 5550 272c 0a20  e} | grep UP',. 
-00013aa0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00013ab0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00013ac0: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-00013ad0: 2074 696d 656f 7574 3d74 6f74 616c 5f74   timeout=total_t
-00013ae0: 696d 656f 7574 5f6d 696e 7574 6573 202a  imeout_minutes *
-00013af0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00013b00: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00013b10: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00013b20: 2e73 6370 0a64 6566 2074 6573 745f 7363  .scp.def test_sc
-00013b30: 705f 6175 746f 646f 776e 2829 3a0a 2020  p_autodown():.  
-00013b40: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00013b50: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00013b60: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00013b70: 2020 2020 2020 2753 4350 5f61 7574 6f64        'SCP_autod
-00013b80: 6f77 6e27 2c0a 2020 2020 2020 2020 5b0a  own',.        [.
-00013b90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00013ba0: 7920 6c61 756e 6368 202d 7920 2d64 202d  y launch -y -d -
-00013bb0: 6320 7b6e 616d 657d 207b 5343 505f 5459  c {name} {SCP_TY
-00013bc0: 5045 7d20 7465 7374 732f 7465 7374 5f79  PE} tests/test_y
-00013bd0: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-00013be0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00013bf0: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
-00013c00: 7920 7b6e 616d 657d 202d 2d64 6f77 6e20  y {name} --down 
-00013c10: 2d69 2031 272c 0a20 2020 2020 2020 2020  -i 1',.         
-00013c20: 2020 2023 2045 6e73 7572 6520 6175 746f     # Ensure auto
-00013c30: 7374 6f70 2069 7320 7365 742e 0a20 2020  stop is set..   
-00013c40: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00013c50: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
-00013c60: 6d65 7d20 7c20 6772 6570 2022 316d 2028  me} | grep "1m (
-00013c70: 646f 776e 2922 272c 0a20 2020 2020 2020  down)"',.       
-00013c80: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
-00013c90: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
-00013ca0: 2074 6572 6d69 6e61 7465 6420 6561 726c   terminated earl
-00013cb0: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
-00013cc0: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
-00013cd0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00013ce0: 7475 7320 2d2d 7265 6672 6573 6820 7c20  tus --refresh | 
-00013cf0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-00013d00: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
-00013d10: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
-00013d20: 2063 6c75 7374 6572 2069 7320 7465 726d   cluster is term
-00013d30: 696e 6174 6564 2e0a 2020 2020 2020 2020  inated..        
-00013d40: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
-00013d50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00013d60: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
-00013d70: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
-00013d80: 2d72 6566 7265 7368 2920 2626 2070 7269  -refresh) && pri
-00013d90: 6e74 6620 2224 7322 2026 2620 7b7b 2065  ntf "$s" && {{ e
-00013da0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00013db0: 7b6e 616d 657d 207c 2067 7265 7020 2241  {name} | grep "A
-00013dc0: 7574 6f64 6f77 6e65 6420 636c 7573 7465  utodowned cluste
-00013dd0: 725c 7c74 6572 6d69 6e61 7465 6420 6f6e  r\|terminated on
-00013de0: 2074 6865 2063 6c6f 7564 223b 207d 7d20   the cloud"; }} 
-00013df0: 7c7c 207b 7b20 6563 686f 2022 2473 2220  || {{ echo "$s" 
-00013e00: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
-00013e10: 2065 7869 7420 3120 7c7c 2065 7869 7420   exit 1 || exit 
-00013e20: 303b 207d 7d27 2c0a 2020 2020 2020 2020  0; }}',.        
-00013e30: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00013e40: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
-00013e50: 207b 5343 505f 5459 5045 7d20 2d2d 646f   {SCP_TYPE} --do
-00013e60: 776e 2074 6573 7473 2f74 6573 745f 7961  wn tests/test_ya
-00013e70: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-00013e80: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00013e90: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
-00013ea0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-00013eb0: 2055 5027 2c20 2023 2045 6e73 7572 6520   UP',  # Ensure 
-00013ec0: 7468 6520 636c 7573 7465 7220 6973 2055  the cluster is U
-00013ed0: 502e 0a20 2020 2020 2020 2020 2020 2066  P..            f
-00013ee0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00013ef0: 207b 5343 505f 5459 5045 7d20 7465 7374   {SCP_TYPE} test
-00013f00: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00013f10: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00013f20: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00013f30: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
-00013f40: 657d 207c 2067 7265 7020 2231 6d20 2864  e} | grep "1m (d
-00013f50: 6f77 6e29 2227 2c0a 2020 2020 2020 2020  own)"',.        
-00013f60: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
-00013f70: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-00013f80: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
-00013f90: 7220 6973 2074 6572 6d69 6e61 7465 642e  r is terminated.
-00013fa0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00013fb0: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
-00013fc0: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
-00013fd0: 2d72 6566 7265 7368 2920 2626 2070 7269  -refresh) && pri
-00013fe0: 6e74 6620 2224 7322 2026 2620 7b7b 2065  ntf "$s" && {{ e
-00013ff0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00014000: 7b6e 616d 657d 207c 2067 7265 7020 2241  {name} | grep "A
-00014010: 7574 6f64 6f77 6e65 6420 636c 7573 7465  utodowned cluste
-00014020: 725c 7c74 6572 6d69 6e61 7465 6420 6f6e  r\|terminated on
-00014030: 2074 6865 2063 6c6f 7564 223b 207d 7d20   the cloud"; }} 
-00014040: 7c7c 207b 7b20 6563 686f 2022 2473 2220  || {{ echo "$s" 
-00014050: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
-00014060: 2065 7869 7420 3120 7c7c 2065 7869 7420   exit 1 || exit 
-00014070: 303b 207d 7d27 2c0a 2020 2020 2020 2020  0; }}',.        
-00014080: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00014090: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
-000140a0: 207b 5343 505f 5459 5045 7d20 2d2d 646f   {SCP_TYPE} --do
-000140b0: 776e 2074 6573 7473 2f74 6573 745f 7961  wn tests/test_ya
-000140c0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-000140d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000140e0: 2773 6b79 2061 7574 6f73 746f 7020 2d79  'sky autostop -y
-000140f0: 207b 6e61 6d65 7d20 2d2d 6361 6e63 656c   {name} --cancel
-00014100: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00014110: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
-00014120: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-00014130: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-00014140: 7374 696c 6c20 5550 2e0a 2020 2020 2020  still UP..      
-00014150: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
-00014160: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
-00014170: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
-00014180: 6829 2026 2620 7072 696e 7466 2022 2473  h) && printf "$s
-00014190: 2220 2626 2065 6368 6f20 2224 7322 207c  " && echo "$s" |
-000141a0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-000141b0: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
-000141c0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-000141d0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-000141e0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
-000141f0: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
-00014200: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00014210: 7374 2874 6573 7429 0a0a 0a64 6566 205f  st(test)...def _
-00014220: 6765 745f 6361 6e63 656c 5f74 6173 6b5f  get_cancel_task_
-00014230: 7769 7468 5f63 6c6f 7564 286e 616d 652c  with_cloud(name,
-00014240: 2063 6c6f 7564 2c20 7469 6d65 6f75 743d   cloud, timeout=
-00014250: 3135 202a 2036 3029 3a0a 2020 2020 7465  15 * 60):.    te
-00014260: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00014270: 2020 2066 277b 636c 6f75 647d 2d63 616e     f'{cloud}-can
-00014280: 6365 6c2d 7461 736b 272c 0a20 2020 2020  cel-task',.     
-00014290: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-000142a0: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
-000142b0: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-000142c0: 2f72 6573 6e65 745f 6170 702e 7961 6d6c  /resnet_app.yaml
-000142d0: 202d 2d63 6c6f 7564 207b 636c 6f75 647d   --cloud {cloud}
-000142e0: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
-000142f0: 2020 2020 2023 2057 6169 7420 7468 6520       # Wait the 
-00014300: 4750 5520 7072 6f63 6573 7320 746f 2073  GPU process to s
-00014310: 7461 7274 2e0a 2020 2020 2020 2020 2020  tart..          
-00014320: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-00014330: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00014340: 6578 6563 207b 6e61 6d65 7d20 226e 7669  exec {name} "nvi
-00014350: 6469 612d 736d 6920 7c20 6772 6570 2070  dia-smi | grep p
-00014360: 7974 686f 6e22 272c 0a20 2020 2020 2020  ython"',.       
-00014370: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00014380: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-00014390: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-000143a0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-000143b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000143c0: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
-000143d0: 6d65 7d20 3127 2c0a 2020 2020 2020 2020  me} 1',.        
-000143e0: 2020 2020 2773 6c65 6570 2036 3027 2c0a      'sleep 60',.
-000143f0: 2020 2020 2020 2020 2020 2020 2320 6368              # ch
-00014400: 6563 6b20 6966 2074 6865 2070 7974 686f  eck if the pytho
-00014410: 6e20 6a6f 6220 6973 2067 6f6e 652e 0a20  n job is gone.. 
-00014420: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00014430: 2065 7865 6320 7b6e 616d 657d 2022 2120   exec {name} "! 
-00014440: 6e76 6964 6961 2d73 6d69 207c 2067 7265  nvidia-smi | gre
-00014450: 7020 7079 7468 6f6e 2227 2c0a 2020 2020  p python"',.    
-00014460: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00014470: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
-00014480: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-00014490: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-000144a0: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
-000144b0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-000144c0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-000144d0: 2020 2020 2020 7469 6d65 6f75 743d 7469        timeout=ti
-000144e0: 6d65 6f75 742c 0a20 2020 2029 0a20 2020  meout,.    ).   
-000144f0: 2072 6574 7572 6e20 7465 7374 0a0a 0a23   return test...#
-00014500: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-00014510: 696e 6720 6073 6b79 2063 616e 6365 6c60  ing `sky cancel`
-00014520: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-00014530: 6573 742e 6d61 726b 2e61 7773 0a40 7079  est.mark.aws.@py
-00014540: 7465 7374 2e6d 6172 6b2e 736b 6970 280a  test.mark.skip(.
-00014550: 2020 2020 7265 6173 6f6e 3d27 5468 6520      reason='The 
-00014560: 7265 736e 6574 5f61 7070 2069 7320 666c  resnet_app is fl
-00014570: 616b 792c 2064 7565 2074 6f20 5446 2066  aky, due to TF f
-00014580: 6169 6c69 6e67 2074 6f20 6465 7465 6374  ailing to detect
-00014590: 2047 5055 732e 2729 0a64 6566 2074 6573   GPUs.').def tes
-000145a0: 745f 6361 6e63 656c 5f61 7773 2829 3a0a  t_cancel_aws():.
-000145b0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-000145c0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-000145d0: 2020 2074 6573 7420 3d20 5f67 6574 5f63     test = _get_c
-000145e0: 616e 6365 6c5f 7461 736b 5f77 6974 685f  ancel_task_with_
-000145f0: 636c 6f75 6428 6e61 6d65 2c20 2761 7773  cloud(name, 'aws
-00014600: 2729 0a20 2020 2072 756e 5f6f 6e65 5f74  ').    run_one_t
-00014610: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00014620: 6573 742e 6d61 726b 2e67 6370 0a40 7079  est.mark.gcp.@py
-00014630: 7465 7374 2e6d 6172 6b2e 736b 6970 280a  test.mark.skip(.
-00014640: 2020 2020 7265 6173 6f6e 3d27 5468 6520      reason='The 
-00014650: 7265 736e 6574 5f61 7070 2069 7320 666c  resnet_app is fl
-00014660: 616b 792c 2064 7565 2074 6f20 5446 2066  aky, due to TF f
-00014670: 6169 6c69 6e67 2074 6f20 6465 7465 6374  ailing to detect
-00014680: 2047 5055 732e 2729 0a64 6566 2074 6573   GPUs.').def tes
-00014690: 745f 6361 6e63 656c 5f67 6370 2829 3a0a  t_cancel_gcp():.
-000146a0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-000146b0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-000146c0: 2020 2074 6573 7420 3d20 5f67 6574 5f63     test = _get_c
-000146d0: 616e 6365 6c5f 7461 736b 5f77 6974 685f  ancel_task_with_
-000146e0: 636c 6f75 6428 6e61 6d65 2c20 2767 6370  cloud(name, 'gcp
-000146f0: 2729 0a20 2020 2072 756e 5f6f 6e65 5f74  ').    run_one_t
-00014700: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00014710: 6573 742e 6d61 726b 2e61 7a75 7265 0a40  est.mark.azure.@
-00014720: 7079 7465 7374 2e6d 6172 6b2e 736b 6970  pytest.mark.skip
-00014730: 280a 2020 2020 7265 6173 6f6e 3d27 5468  (.    reason='Th
-00014740: 6520 7265 736e 6574 5f61 7070 2069 7320  e resnet_app is 
-00014750: 666c 616b 792c 2064 7565 2074 6f20 5446  flaky, due to TF
-00014760: 2066 6169 6c69 6e67 2074 6f20 6465 7465   failing to dete
-00014770: 6374 2047 5055 732e 2729 0a64 6566 2074  ct GPUs.').def t
-00014780: 6573 745f 6361 6e63 656c 5f61 7a75 7265  est_cancel_azure
-00014790: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-000147a0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000147b0: 2829 0a20 2020 2074 6573 7420 3d20 5f67  ().    test = _g
-000147c0: 6574 5f63 616e 6365 6c5f 7461 736b 5f77  et_cancel_task_w
-000147d0: 6974 685f 636c 6f75 6428 6e61 6d65 2c20  ith_cloud(name, 
-000147e0: 2761 7a75 7265 272c 2074 696d 656f 7574  'azure', timeout
-000147f0: 3d33 3020 2a20 3630 290a 2020 2020 7275  =30 * 60).    ru
-00014800: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00014810: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00014820: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-00014830: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-00014840: 646f 6573 206e 6f74 2068 6176 6520 5631  does not have V1
-00014850: 3030 2067 7075 730a 4070 7974 6573 742e  00 gpus.@pytest.
-00014860: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
-00014870: 424d 2063 6c6f 7564 2063 7572 7265 6e74  BM cloud current
-00014880: 6c79 2064 6f65 736e 2774 2070 726f 7669  ly doesn't provi
-00014890: 6465 2070 7562 6c69 6320 696d 6167 6520  de public image 
-000148a0: 7769 7468 2043 5544 410a 4070 7974 6573  with CUDA.@pytes
-000148b0: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
-000148c0: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
-000148d0: 6365 2068 6173 2060 676e 6f6d 652d 7368  ce has `gnome-sh
-000148e0: 656c 6c60 206f 6e20 6e76 6964 6961 2d73  ell` on nvidia-s
-000148f0: 6d69 0a40 7079 7465 7374 2e6d 6172 6b2e  mi.@pytest.mark.
-00014900: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-00014910: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
-00014920: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
-00014930: 0a64 6566 2074 6573 745f 6361 6e63 656c  .def test_cancel
-00014940: 5f70 7974 6f72 6368 2867 656e 6572 6963  _pytorch(generic
-00014950: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00014960: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00014970: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00014980: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00014990: 2020 2020 2020 2763 616e 6365 6c2d 7079        'cancel-py
-000149a0: 746f 7263 6827 2c0a 2020 2020 2020 2020  torch',.        
-000149b0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-000149c0: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
-000149d0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-000149e0: 6e65 7269 635f 636c 6f75 647d 2065 7861  neric_cloud} exa
-000149f0: 6d70 6c65 732f 7265 736e 6574 5f64 6973  mples/resnet_dis
-00014a00: 7472 6962 7574 6564 5f74 6f72 6368 2e79  tributed_torch.y
-00014a10: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
-00014a20: 2020 2020 2020 2020 2320 5761 6974 2074          # Wait t
-00014a30: 6865 2047 5055 2070 726f 6365 7373 2074  he GPU process t
-00014a40: 6f20 7374 6172 742e 0a20 2020 2020 2020  o start..       
-00014a50: 2020 2020 2027 736c 6565 7020 3930 272c       'sleep 90',
-00014a60: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00014a70: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00014a80: 286e 7669 6469 612d 736d 6920 7c20 6772  (nvidia-smi | gr
-00014a90: 6570 2070 7974 686f 6e29 207c 7c20 270a  ep python) || '.
-00014aa0: 2020 2020 2020 2020 2020 2020 2320 5768              # Wh
-00014ab0: 656e 2072 756e 2069 6e73 6964 6520 636f  en run inside co
-00014ac0: 6e74 6169 6e65 722f 6b38 732c 206e 7669  ntainer/k8s, nvi
-00014ad0: 6469 612d 736d 6920 6361 6e6e 6f74 2073  dia-smi cannot s
-00014ae0: 686f 7720 7072 6f63 6573 7320 6964 732e  how process ids.
-00014af0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-00014b00: 6565 2068 7474 7073 3a2f 2f67 6974 6875  ee https://githu
-00014b10: 622e 636f 6d2f 4e56 4944 4941 2f6e 7669  b.com/NVIDIA/nvi
-00014b20: 6469 612d 646f 636b 6572 2f69 7373 7565  dia-docker/issue
-00014b30: 732f 3137 390a 2020 2020 2020 2020 2020  s/179.          
-00014b40: 2020 2320 546f 2077 6f72 6b20 6172 6f75    # To work arou
-00014b50: 6e64 2c20 7765 2063 6865 636b 2069 6620  nd, we check if 
-00014b60: 4750 5520 7574 696c 697a 6174 696f 6e20  GPU utilization 
-00014b70: 6973 2067 7265 6174 6572 2074 6861 6e20  is greater than 
-00014b80: 302e 0a20 2020 2020 2020 2020 2020 2066  0..            f
-00014b90: 275b 205c 2428 6e76 6964 6961 2d73 6d69  '[ \$(nvidia-smi
-00014ba0: 202d 2d71 7565 7279 2d67 7075 3d75 7469   --query-gpu=uti
-00014bb0: 6c69 7a61 7469 6f6e 2e67 7075 202d 2d66  lization.gpu --f
-00014bc0: 6f72 6d61 743d 6373 762c 6e6f 6865 6164  ormat=csv,nohead
-00014bd0: 6572 2c6e 6f75 6e69 7473 2920 2d67 7420  er,nounits) -gt 
-00014be0: 3020 5d22 272c 0a20 2020 2020 2020 2020  0 ]"',.         
-00014bf0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00014c00: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-00014c10: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00014c20: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00014c30: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00014c40: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-00014c50: 7d20 3127 2c0a 2020 2020 2020 2020 2020  } 1',.          
-00014c60: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-00014c70: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00014c80: 6578 6563 207b 6e61 6d65 7d20 2228 6e76  exec {name} "(nv
-00014c90: 6964 6961 2d73 6d69 207c 2067 7265 7020  idia-smi | grep 
-00014ca0: 5c27 4e6f 2072 756e 6e69 6e67 2070 726f  \'No running pro
-00014cb0: 6365 7373 5c27 2920 7c7c 2027 0a20 2020  cess\') || '.   
-00014cc0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-00014cd0: 6520 586f 7267 2069 7320 7468 6520 6f6e  e Xorg is the on
-00014ce0: 6c79 2070 726f 6365 7373 2072 756e 6e69  ly process runni
-00014cf0: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-00014d00: 275b 205c 2428 6e76 6964 6961 2d73 6d69  '[ \$(nvidia-smi
-00014d10: 207c 2067 7265 7020 2d41 2031 3020 5072   | grep -A 10 Pr
-00014d20: 6f63 6573 7365 7320 7c20 6772 6570 202d  ocesses | grep -
-00014d30: 4120 3130 203d 3d3d 207c 2067 7265 7020  A 10 === | grep 
-00014d40: 2d76 2058 6f72 6729 202d 6571 2032 205d  -v Xorg) -eq 2 ]
-00014d50: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00014d60: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00014d70: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
-00014d80: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00014d90: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00014da0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00014db0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00014dc0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-00014dd0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-00014de0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00014df0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-00014e00: 6361 6e27 7420 7573 6520 605f 6765 745f  can't use `_get_
-00014e10: 6361 6e63 656c 5f74 6173 6b5f 7769 7468  cancel_task_with
-00014e20: 5f63 6c6f 7564 2829 602c 2061 7320 636f  _cloud()`, as co
-00014e30: 6d6d 616e 6420 606e 7669 6469 612d 736d  mmand `nvidia-sm
-00014e40: 6960 0a23 2072 6571 7569 7265 7320 6120  i`.# requires a 
-00014e50: 4355 4441 2070 7562 6c69 6320 696d 6167  CUDA public imag
-00014e60: 652c 2077 6869 6368 2049 424d 2064 6f65  e, which IBM doe
-00014e70: 736e 2774 206f 6666 6572 0a40 7079 7465  sn't offer.@pyte
-00014e80: 7374 2e6d 6172 6b2e 6962 6d0a 6465 6620  st.mark.ibm.def 
-00014e90: 7465 7374 5f63 616e 6365 6c5f 6962 6d28  test_cancel_ibm(
-00014ea0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00014eb0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00014ec0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00014ed0: 7428 0a20 2020 2020 2020 2027 6962 6d2d  t(.        'ibm-
-00014ee0: 6361 6e63 656c 2d74 6173 6b27 2c0a 2020  cancel-task',.  
-00014ef0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00014f00: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00014f10: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00014f20: 636c 6f75 6420 6962 6d20 6578 616d 706c  cloud ibm exampl
-00014f30: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
-00014f40: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00014f50: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00014f60: 2d6e 207b 6e61 6d65 7d2d 3120 2d64 2020  -n {name}-1 -d  
-00014f70: 2277 6869 6c65 2074 7275 653b 2064 6f20  "while true; do 
-00014f80: 6563 686f 205c 2748 656c 6c6f 2053 6b79  echo \'Hello Sky
-00014f90: 5069 6c6f 745c 273b 2073 6c65 6570 2032  Pilot\'; sleep 2
-00014fa0: 3b20 646f 6e65 2227 2c0a 2020 2020 2020  ; done"',.      
-00014fb0: 2020 2020 2020 2773 6c65 6570 2032 3027        'sleep 20'
-00014fc0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00014fd0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-00014fe0: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
-00014ff0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
-00015000: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00015010: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-00015020: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
-00015030: 2020 2020 2066 2773 6c65 6570 2035 272c       f'sleep 5',
-00015040: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00015050: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-00015060: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
-00015070: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
-00015080: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00015090: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-000150a0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-000150b0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-000150c0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-000150d0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-000150e0: 2075 7365 2d73 706f 7420 6f70 7469 6f6e   use-spot option
-000150f0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-00015100: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-00015110: 6473 7461 636b 2020 2320 466c 7569 6453  dstack  # FluidS
-00015120: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
-00015130: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00015140: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00015150: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
-00015160: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
-00015170: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00015180: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00015190: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-000151a0: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
-000151b0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-000151c0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-000151d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-000151e0: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-000151f0: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
-00015200: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00015210: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00015220: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-00015230: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-00015240: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00015250: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00015260: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-00015270: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-00015280: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00015290: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-000152a0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-000152b0: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
-000152c0: 6f65 7320 6e6f 7420 6861 7665 2061 206e  oes not have a n
-000152d0: 6f74 696f 6e20 6f66 2073 706f 7420 696e  otion of spot in
-000152e0: 7374 616e 6365 730a 6465 6620 7465 7374  stances.def test
-000152f0: 5f75 7365 5f73 706f 7428 6765 6e65 7269  _use_spot(generi
-00015300: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00015310: 2020 2022 2222 5465 7374 2075 7365 2d73     """Test use-s
-00015320: 706f 7420 616e 6420 736b 7920 6578 6563  pot and sky exec
-00015330: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-00015340: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00015350: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00015360: 6573 7428 0a20 2020 2020 2020 2027 7573  est(.        'us
-00015370: 652d 7370 6f74 272c 0a20 2020 2020 2020  e-spot',.       
-00015380: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00015390: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
-000153a0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-000153b0: 656e 6572 6963 5f63 6c6f 7564 7d20 7465  eneric_cloud} te
-000153c0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-000153d0: 696e 696d 616c 2e79 616d 6c20 2d2d 7573  inimal.yaml --us
-000153e0: 652d 7370 6f74 202d 7927 2c0a 2020 2020  e-spot -y',.    
-000153f0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00015400: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-00015410: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-00015420: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00015430: 616d 657d 2065 6368 6f20 6869 272c 0a20  ame} echo hi',. 
-00015440: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00015450: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-00015460: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00015470: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00015480: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00015490: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-000154a0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000154b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000154c0: 6763 700a 6465 6620 7465 7374 5f73 746f  gcp.def test_sto
-000154d0: 705f 6763 705f 7370 6f74 2829 3a0a 2020  p_gcp_spot():.  
-000154e0: 2020 2222 2254 6573 7420 4743 5020 7370    """Test GCP sp
-000154f0: 6f74 2063 616e 2062 6520 7374 6f70 7065  ot can be stoppe
-00015500: 642c 2061 7574 6f73 746f 7070 6564 2c20  d, autostopped, 
-00015510: 7265 7374 6172 7465 642e 2222 220a 2020  restarted.""".  
-00015520: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00015530: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00015540: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00015550: 2020 2020 2020 2773 746f 705f 6763 705f        'stop_gcp_
-00015560: 7370 6f74 272c 0a20 2020 2020 2020 205b  spot',.        [
-00015570: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00015580: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-00015590: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
-000155a0: 2d2d 7573 652d 7370 6f74 202d 2d63 7075  --use-spot --cpu
-000155b0: 7320 322b 202d 7920 2d2d 2074 6f75 6368  s 2+ -y -- touch
-000155c0: 206d 7966 696c 6527 2c0a 2020 2020 2020   myfile',.      
-000155d0: 2020 2020 2020 2320 7374 6f70 2073 686f        # stop sho
-000155e0: 756c 6420 676f 2074 6872 6f75 6768 3a0a  uld go through:.
-000155f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00015600: 7920 7374 6f70 207b 6e61 6d65 7d20 2d79  y stop {name} -y
-00015610: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00015620: 2773 6b79 2073 7461 7274 207b 6e61 6d65  'sky start {name
-00015630: 7d20 2d79 272c 0a20 2020 2020 2020 2020  } -y',.         
-00015640: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00015650: 616d 657d 202d 2d20 6c73 206d 7966 696c  ame} -- ls myfil
-00015660: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00015670: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00015680: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
-00015690: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000156a0: 2061 7574 6f73 746f 7020 7b6e 616d 657d   autostop {name}
-000156b0: 202d 6930 202d 7927 2c0a 2020 2020 2020   -i0 -y',.      
-000156c0: 2020 2020 2020 2773 6c65 6570 2039 3027        'sleep 90'
-000156d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000156e0: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
-000156f0: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
-00015700: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00015710: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00015720: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
-00015730: 7d20 7c20 6772 6570 2053 544f 5050 4544  } | grep STOPPED
-00015740: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00015750: 2773 6b79 2073 7461 7274 207b 6e61 6d65  'sky start {name
-00015760: 7d20 2d79 272c 0a20 2020 2020 2020 2020  } -y',.         
-00015770: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00015780: 616d 657d 202d 2d20 6c73 206d 7966 696c  ame} -- ls myfil
-00015790: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-000157a0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-000157b0: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
-000157c0: 2020 2020 2020 2020 2020 2023 202d 6920             # -i 
-000157d0: 6f70 7469 6f6e 2061 7420 6c61 756e 6368  option at launch
-000157e0: 2073 686f 756c 6420 676f 2074 6872 6f75   should go throu
-000157f0: 6768 3a0a 2020 2020 2020 2020 2020 2020  gh:.            
-00015800: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
-00015810: 7b6e 616d 657d 202d 6930 202d 7927 2c0a  {name} -i0 -y',.
-00015820: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00015830: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
-00015840: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
-00015850: 7461 7475 7320 7b6e 616d 657d 202d 2d72  tatus {name} --r
-00015860: 6566 7265 7368 293b 2065 6368 6f20 2224  efresh); echo "$
-00015870: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-00015880: 6563 686f 2022 2473 2220 207c 2067 7265  echo "$s"  | gre
-00015890: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-000158a0: 5354 4f50 5045 4427 2c0a 2020 2020 2020  STOPPED',.      
-000158b0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000158c0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000158d0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-000158e0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000158f0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-00015900: 5465 7374 696e 6720 6d61 6e61 6765 6420  Testing managed 
-00015910: 7370 6f74 202d 2d2d 2d2d 2d2d 2d2d 2d0a  spot ----------.
-00015920: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00015930: 666c 7569 6473 7461 636b 2020 2320 466c  fluidstack  # Fl
-00015940: 7569 6453 7461 636b 2064 6f65 7320 6e6f  uidStack does no
-00015950: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-00015960: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00015970: 2e6d 6172 6b2e 6e6f 5f61 7a75 7265 2020  .mark.no_azure  
-00015980: 2320 417a 7572 6520 646f 6573 206e 6f74  # Azure does not
-00015990: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-000159a0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-000159b0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-000159c0: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-000159d0: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-000159e0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-000159f0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00015a00: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-00015a10: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-00015a20: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00015a30: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00015a40: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-00015a50: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00015a60: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00015a70: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00015a80: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-00015a90: 6170 7065 7273 7061 6365 2064 6f65 7320  apperspace does 
-00015aa0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00015ab0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00015ac0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
-00015ad0: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
-00015ae0: 7465 7320 646f 6573 206e 6f74 2068 6176  tes does not hav
-00015af0: 6520 6120 6e6f 7469 6f6e 206f 6620 7370  e a notion of sp
-00015b00: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00015b10: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
-00015b20: 645f 7370 6f74 0a64 6566 2074 6573 745f  d_spot.def test_
-00015b30: 7370 6f74 2867 656e 6572 6963 5f63 6c6f  spot(generic_clo
-00015b40: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
-00015b50: 2254 6573 7420 7468 6520 7370 6f74 2079  "Test the spot y
-00015b60: 616d 6c2e 2222 220a 2020 2020 6e61 6d65  aml.""".    name
-00015b70: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00015b80: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00015b90: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00015ba0: 276d 616e 6167 6564 2d73 706f 7427 2c0a  'managed-spot',.
-00015bb0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00015bc0: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
-00015bd0: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
-00015be0: 7d2d 3120 2d2d 636c 6f75 6420 7b67 656e  }-1 --cloud {gen
-00015bf0: 6572 6963 5f63 6c6f 7564 7d20 6578 616d  eric_cloud} exam
-00015c00: 706c 6573 2f6d 616e 6167 6564 5f73 706f  ples/managed_spo
-00015c10: 742e 7961 6d6c 202d 7920 2d64 272c 0a20  t.yaml -y -d',. 
-00015c20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00015c30: 2073 706f 7420 6c61 756e 6368 202d 6e20   spot launch -n 
-00015c40: 7b6e 616d 657d 2d32 202d 2d63 6c6f 7564  {name}-2 --cloud
-00015c50: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00015c60: 2065 7861 6d70 6c65 732f 6d61 6e61 6765   examples/manage
-00015c70: 645f 7370 6f74 2e79 616d 6c20 2d79 202d  d_spot.yaml -y -
-00015c80: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00015c90: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-00015ca0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00015cb0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00015cc0: 7020 7b6e 616d 657d 2d31 207c 2068 6561  p {name}-1 | hea
-00015cd0: 6420 2d6e 3120 7c20 6772 6570 2022 5354  d -n1 | grep "ST
-00015ce0: 4152 5449 4e47 5c7c 5255 4e4e 494e 4722  ARTING\|RUNNING"
-00015cf0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00015d00: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00015d10: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00015d20: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
-00015d30: 6772 6570 2022 5354 4152 5449 4e47 5c7c  grep "STARTING\|
-00015d40: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-00015d50: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-00015d60: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-00015d70: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
-00015d80: 7d2d 3127 292c 0a20 2020 2020 2020 2020  }-1'),.         
-00015d90: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-00015da0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00015db0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00015dc0: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
-00015dd0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00015de0: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-00015df0: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-00015e00: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
-00015e10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00015e20: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00015e30: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00015e40: 2d31 207c 2068 6561 6420 2d6e 3120 7c20  -1 | head -n1 | 
-00015e50: 6772 6570 2043 414e 4345 4c4c 4544 272c  grep CANCELLED',
-00015e60: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00015e70: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00015e80: 7d7c 2067 7265 7020 7b6e 616d 657d 2d32  }| grep {name}-2
-00015e90: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00015ea0: 6570 2022 5255 4e4e 494e 475c 7c53 5543  ep "RUNNING\|SUC
-00015eb0: 4345 4544 4544 2227 2c0a 2020 2020 2020  CEEDED"',.      
-00015ec0: 2020 5d2c 0a20 2020 2020 2020 2023 2054    ],.        # T
-00015ed0: 4f44 4f28 7a68 7775 293a 2043 6861 6e67  ODO(zhwu): Chang
-00015ee0: 6520 746f 205f 5350 4f54 5f43 414e 4345  e to _SPOT_CANCE
-00015ef0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-00015f00: 625f 6e61 6d65 3d66 277b 6e61 6d65 7d2d  b_name=f'{name}-
-00015f10: 3120 2d6e 207b 6e61 6d65 7d2d 3227 2920  1 -n {name}-2') 
-00015f20: 7768 656e 0a20 2020 2020 2020 2023 2063  when.        # c
-00015f30: 616e 6365 6c69 6e67 206d 756c 7469 706c  anceling multipl
-00015f40: 6520 6a6f 6220 6e61 6d65 7320 6973 2073  e job names is s
-00015f50: 7570 706f 7274 6564 2e0a 2020 2020 2020  upported..      
-00015f60: 2020 285f 5350 4f54 5f43 414e 4345 4c5f    (_SPOT_CANCEL_
-00015f70: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00015f80: 6e61 6d65 3d66 277b 6e61 6d65 7d2d 3127  name=f'{name}-1'
-00015f90: 2920 2b20 273b 2027 202b 0a20 2020 2020  ) + '; ' +.     
-00015fa0: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-00015fb0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-00015fc0: 5f6e 616d 653d 6627 7b6e 616d 657d 2d32  _name=f'{name}-2
-00015fd0: 2729 292c 0a20 2020 2020 2020 2023 2049  ')),.        # I
-00015fe0: 6e63 7265 6173 6520 7469 6d65 6f75 7420  ncrease timeout 
-00015ff0: 7369 6e63 6520 736b 7920 7370 6f74 2071  since sky spot q
-00016000: 7565 7565 202d 7220 6361 6e20 6265 2062  ueue -r can be b
-00016010: 6c6f 636b 6564 2062 7920 6f74 6865 7220  locked by other 
-00016020: 7370 6f74 2074 6573 7473 2e0a 2020 2020  spot tests..    
-00016030: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00016040: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00016050: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00016060: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00016070: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-00016080: 2366 6c75 6964 7374 6163 6b20 646f 6573  #fluidstack does
-00016090: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-000160a0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-000160b0: 6573 742e 6d61 726b 2e6e 6f5f 617a 7572  est.mark.no_azur
-000160c0: 6520 2023 2041 7a75 7265 2064 6f65 7320  e  # Azure does 
-000160d0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-000160e0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-000160f0: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
-00016100: 615f 636c 6f75 6420 2023 204c 616d 6264  a_cloud  # Lambd
-00016110: 6120 436c 6f75 6420 646f 6573 206e 6f74  a Cloud does not
-00016120: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00016130: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00016140: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
-00016150: 424d 2043 6c6f 7564 2064 6f65 7320 6e6f  BM Cloud does no
-00016160: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-00016170: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00016180: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
-00016190: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
-000161a0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-000161b0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-000161c0: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
-000161d0: 2320 5061 7065 7273 7061 6365 2064 6f65  # Paperspace doe
-000161e0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-000161f0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00016200: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
-00016210: 6572 6e65 7465 7320 2023 204b 7562 6572  ernetes  # Kuber
-00016220: 6e65 7465 7320 646f 6573 206e 6f74 2068  netes does not h
-00016230: 6176 6520 6120 6e6f 7469 6f6e 206f 6620  ave a notion of 
-00016240: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00016250: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
-00016260: 6765 645f 7370 6f74 0a64 6566 2074 6573  ged_spot.def tes
-00016270: 745f 7370 6f74 5f70 6970 656c 696e 6528  t_spot_pipeline(
-00016280: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00016290: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-000162a0: 2061 2073 706f 74c2 a070 6970 656c 696e   a spot..pipelin
-000162b0: 652e 2222 220a 2020 2020 6e61 6d65 203d  e.""".    name =
-000162c0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000162d0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-000162e0: 5465 7374 280a 2020 2020 2020 2020 2773  Test(.        's
-000162f0: 706f 742d 7069 7065 6c69 6e65 272c 0a20  pot-pipeline',. 
-00016300: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00016310: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-00016320: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
-00016330: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00016340: 732f 7069 7065 6c69 6e65 2e79 616d 6c20  s/pipeline.yaml 
-00016350: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00016360: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-00016370: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00016380: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00016390: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-000163a0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-000163b0: 5354 4152 5449 4e47 5c7c 5255 4e4e 494e  STARTING\|RUNNIN
-000163c0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-000163d0: 2023 2060 6772 6570 202d 4120 3420 7b6e   # `grep -A 4 {n
-000163e0: 616d 657d 6020 6669 6e64 7320 7468 6520  ame}` finds the 
-000163f0: 6a6f 6220 7769 7468 207b 6e61 6d65 7d20  job with {name} 
-00016400: 616e 6420 7468 6520 3420 6c69 6e65 730a  and the 4 lines.
-00016410: 2020 2020 2020 2020 2020 2020 2320 6166              # af
-00016420: 7465 7220 6974 2c20 692e 652e 2074 6865  ter it, i.e. the
-00016430: 2034 2074 6173 6b73 2077 6974 6869 6e20   4 tasks within 
-00016440: 7468 6520 6a6f 622e 0a20 2020 2020 2020  the job..       
-00016450: 2020 2020 2023 2060 7365 6420 2d6e 2032       # `sed -n 2
-00016460: 7060 2067 6574 7320 7468 6520 7365 636f  p` gets the seco
-00016470: 6e64 206c 696e 6520 6f66 2074 6865 2034  nd line of the 4
-00016480: 206c 696e 6573 2c20 692e 652e 2074 6865   lines, i.e. the
-00016490: 2066 6972 7374 0a20 2020 2020 2020 2020   first.         
-000164a0: 2020 2023 2074 6173 6b20 7769 7468 696e     # task within
-000164b0: 2074 6865 206a 6f62 2e0a 2020 2020 2020   the job..      
-000164c0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-000164d0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-000164e0: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
-000164f0: 6420 2d6e 2032 7020 7c20 6772 6570 2022  d -n 2p | grep "
-00016500: 5354 4152 5449 4e47 5c7c 5255 4e4e 494e  STARTING\|RUNNIN
-00016510: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-00016520: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00016530: 5741 4954 7d7c 2067 7265 7020 2d41 2034  WAIT}| grep -A 4
-00016540: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
-00016550: 3370 207c 2067 7265 7020 2250 454e 4449  3p | grep "PENDI
-00016560: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-00016570: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-00016580: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00016590: 616d 653d 6627 7b6e 616d 657d 2729 2c0a  ame=f'{name}'),.
-000165a0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-000165b0: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-000165c0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-000165d0: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
-000165e0: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
-000165f0: 6e20 3270 207c 2067 7265 7020 2243 414e  n 2p | grep "CAN
-00016600: 4345 4c4c 494e 475c 7c43 414e 4345 4c4c  CELLING\|CANCELL
-00016610: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-00016620: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00016630: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
-00016640: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
-00016650: 2033 7020 7c20 6772 6570 2022 4341 4e43   3p | grep "CANC
-00016660: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
-00016670: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-00016680: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00016690: 5741 4954 7d7c 2067 7265 7020 2d41 2034  WAIT}| grep -A 4
-000166a0: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
-000166b0: 3470 207c 2067 7265 7020 2243 414e 4345  4p | grep "CANCE
-000166c0: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
-000166d0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000166e0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-000166f0: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
-00016700: 7b6e 616d 657d 7c20 7365 6420 2d6e 2035  {name}| sed -n 5
-00016710: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
-00016720: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-00016730: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00016740: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
-00016750: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00016760: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00016770: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-00016780: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
-00016790: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
-000167a0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-000167b0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-000167c0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
-000167d0: 7d7c 2073 6564 202d 6e20 3370 207c 2067  }| sed -n 3p | g
-000167e0: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
-000167f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00016800: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00016810: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
-00016820: 616d 657d 7c20 7365 6420 2d6e 2034 7020  ame}| sed -n 4p 
-00016830: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
-00016840: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-00016850: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00016860: 5741 4954 7d7c 2067 7265 7020 2d41 2034  WAIT}| grep -A 4
-00016870: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
-00016880: 3570 207c 2067 7265 7020 2243 414e 4345  5p | grep "CANCE
-00016890: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-000168a0: 5d2c 0a20 2020 2020 2020 205f 5350 4f54  ],.        _SPOT
-000168b0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-000168c0: 6d61 7428 6a6f 625f 6e61 6d65 3d66 277b  mat(job_name=f'{
-000168d0: 6e61 6d65 7d27 292c 0a20 2020 2020 2020  name}'),.       
-000168e0: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
-000168f0: 6f75 7420 7369 6e63 6520 736b 7920 7370  out since sky sp
-00016900: 6f74 2071 7565 7565 202d 7220 6361 6e20  ot queue -r can 
-00016910: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
-00016920: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
-00016930: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00016940: 3330 202a 2036 302c 0a20 2020 2029 0a20  30 * 60,.    ). 
-00016950: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00016960: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00016970: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-00016980: 636b 2020 2366 6c75 6964 7374 6163 6b20  ck  #fluidstack 
-00016990: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-000169a0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-000169b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000169c0: 617a 7572 6520 2023 2041 7a75 7265 2064  azure  # Azure d
-000169d0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-000169e0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-000169f0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
-00016a00: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
-00016a10: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
-00016a20: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00016a30: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00016a40: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
-00016a50: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
-00016a60: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-00016a70: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00016a80: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-00016a90: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-00016aa0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00016ab0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00016ac0: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
-00016ad0: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
-00016ae0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00016af0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00016b00: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00016b10: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
-00016b20: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
-00016b30: 6f74 2068 6176 6520 6120 6e6f 7469 6f6e  ot have a notion
-00016b40: 206f 6620 7370 6f74 2069 6e73 7461 6e63   of spot instanc
-00016b50: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00016b60: 6d61 6e61 6765 645f 7370 6f74 0a64 6566  managed_spot.def
-00016b70: 2074 6573 745f 7370 6f74 5f66 6169 6c65   test_spot_faile
-00016b80: 645f 7365 7475 7028 6765 6e65 7269 635f  d_setup(generic_
-00016b90: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-00016ba0: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
-00016bb0: 2073 706f 7420 6a6f 6220 7769 7468 2066   spot job with f
-00016bc0: 6169 6c65 6420 7365 7475 702e 2222 220a  ailed setup.""".
-00016bd0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00016be0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00016bf0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00016c00: 2020 2020 2020 2020 2773 706f 745f 6661          'spot_fa
-00016c10: 696c 6564 5f73 6574 7570 272c 0a20 2020  iled_setup',.   
-00016c20: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00016c30: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-00016c40: 756e 6368 202d 6e20 7b6e 616d 657d 202d  unch -n {name} -
-00016c50: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00016c60: 636c 6f75 647d 202d 7920 2d64 2074 6573  cloud} -y -d tes
-00016c70: 7473 2f74 6573 745f 7961 6d6c 732f 6661  ts/test_yamls/fa
-00016c80: 696c 6564 5f73 6574 7570 2e79 616d 6c27  iled_setup.yaml'
-00016c90: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00016ca0: 6c65 6570 2033 3330 272c 0a20 2020 2020  leep 330',.     
-00016cb0: 2020 2020 2020 2023 204d 616b 6520 7375         # Make su
-00016cc0: 7265 2074 6865 206a 6f62 2066 6169 6c65  re the job faile
-00016cd0: 6420 7175 6963 6b6c 792e 0a20 2020 2020  d quickly..     
-00016ce0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00016cf0: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
-00016d00: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-00016d10: 202d 6e31 207c 2067 7265 7020 2246 4149   -n1 | grep "FAI
-00016d20: 4c45 445f 5345 5455 5022 272c 0a20 2020  LED_SETUP"',.   
-00016d30: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00016d40: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-00016d50: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-00016d60: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00016d70: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
-00016d80: 6f75 7420 7369 6e63 6520 736b 7920 7370  out since sky sp
-00016d90: 6f74 2071 7565 7565 202d 7220 6361 6e20  ot queue -r can 
-00016da0: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
-00016db0: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
-00016dc0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00016dd0: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-00016de0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00016df0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00016e00: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-00016e10: 636b 2020 2366 6c75 6964 7374 6163 6b20  ck  #fluidstack 
-00016e20: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00016e30: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-00016e40: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00016e50: 617a 7572 6520 2023 2041 7a75 7265 2064  azure  # Azure d
-00016e60: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00016e70: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00016e80: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
-00016e90: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
-00016ea0: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
-00016eb0: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00016ec0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00016ed0: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
-00016ee0: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
-00016ef0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-00016f00: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00016f10: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-00016f20: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-00016f30: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00016f40: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00016f50: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
-00016f60: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
-00016f70: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00016f80: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00016f90: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00016fa0: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
-00016fb0: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
-00016fc0: 6f74 2068 6176 6520 6120 6e6f 7469 6f6e  ot have a notion
-00016fd0: 206f 6620 7370 6f74 2069 6e73 7461 6e63   of spot instanc
-00016fe0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00016ff0: 6d61 6e61 6765 645f 7370 6f74 0a64 6566  managed_spot.def
-00017000: 2074 6573 745f 7370 6f74 5f70 6970 656c   test_spot_pipel
-00017010: 696e 655f 6661 696c 6564 5f73 6574 7570  ine_failed_setup
-00017020: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00017030: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
-00017040: 7420 6d61 6e61 6765 6420 7370 6f74 206a  t managed spot j
-00017050: 6f62 2077 6974 6820 6661 696c 6564 2073  ob with failed s
-00017060: 6574 7570 2066 6f72 2061 2070 6970 656c  etup for a pipel
-00017070: 696e 652e 2222 220a 2020 2020 6e61 6d65  ine.""".    name
-00017080: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00017090: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-000170a0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-000170b0: 2773 706f 745f 7069 7065 6c69 6e65 5f66  'spot_pipeline_f
-000170c0: 6169 6c65 645f 7365 7475 7027 2c0a 2020  ailed_setup',.  
-000170d0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000170e0: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
-000170f0: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d20  aunch -n {name} 
-00017100: 2d79 202d 6420 7465 7374 732f 7465 7374  -y -d tests/test
-00017110: 5f79 616d 6c73 2f66 6169 6c65 645f 7365  _yamls/failed_se
-00017120: 7475 705f 7069 7065 6c69 6e65 2e79 616d  tup_pipeline.yam
-00017130: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00017140: 2773 6c65 6570 2038 3030 272c 0a20 2020  'sleep 800',.   
-00017150: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
-00017160: 7375 7265 2074 6865 206a 6f62 2066 6169  sure the job fai
-00017170: 6c65 6420 7175 6963 6b6c 792e 0a20 2020  led quickly..   
-00017180: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00017190: 545f 5155 4555 455f 5741 4954 7d20 7c20  T_QUEUE_WAIT} | 
-000171a0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-000171b0: 6164 202d 6e31 207c 2067 7265 7020 2246  ad -n1 | grep "F
-000171c0: 4149 4c45 445f 5345 5455 5022 272c 0a20  AILED_SETUP"',. 
-000171d0: 2020 2020 2020 2020 2020 2023 2054 6173             # Tas
-000171e0: 6b20 3020 7368 6f75 6c64 2062 6520 5355  k 0 should be SU
-000171f0: 4343 4545 4445 442e 0a20 2020 2020 2020  CCEEDED..       
-00017200: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00017210: 4555 455f 5741 4954 7d20 7c20 6772 6570  EUE_WAIT} | grep
-00017220: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
-00017230: 6420 2d6e 2032 7020 7c20 6772 6570 2022  d -n 2p | grep "
-00017240: 5355 4343 4545 4445 4422 272c 0a20 2020  SUCCEEDED"',.   
-00017250: 2020 2020 2020 2020 2023 2054 6173 6b20           # Task 
-00017260: 3120 7368 6f75 6c64 2062 6520 4641 494c  1 should be FAIL
-00017270: 4544 5f53 4554 5550 2e0a 2020 2020 2020  ED_SETUP..      
-00017280: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00017290: 5545 5545 5f57 4149 547d 207c 2067 7265  UEUE_WAIT} | gre
-000172a0: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
-000172b0: 6564 202d 6e20 3370 207c 2067 7265 7020  ed -n 3p | grep 
-000172c0: 2246 4149 4c45 445f 5345 5455 5022 272c  "FAILED_SETUP"',
-000172d0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-000172e0: 6173 6b20 3220 7368 6f75 6c64 2062 6520  ask 2 should be 
-000172f0: 4341 4e43 454c 4c45 442e 0a20 2020 2020  CANCELLED..     
-00017300: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00017310: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
-00017320: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-00017330: 7365 6420 2d6e 2034 7020 7c20 6772 6570  sed -n 4p | grep
-00017340: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
-00017350: 2020 2020 2020 2020 2020 2023 2054 6173             # Tas
-00017360: 6b20 3320 7368 6f75 6c64 2062 6520 4341  k 3 should be CA
-00017370: 4e43 454c 4c45 442e 0a20 2020 2020 2020  NCELLED..       
-00017380: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00017390: 4555 455f 5741 4954 7d20 7c20 6772 6570  EUE_WAIT} | grep
-000173a0: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
-000173b0: 6420 2d6e 2035 7020 7c20 6772 6570 2022  d -n 5p | grep "
-000173c0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-000173d0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000173e0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-000173f0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-00017400: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00017410: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
-00017420: 6f75 7420 7369 6e63 6520 736b 7920 7370  out since sky sp
-00017430: 6f74 2071 7565 7565 202d 7220 6361 6e20  ot queue -r can 
-00017440: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
-00017450: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
-00017460: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00017470: 3330 202a 2036 302c 0a20 2020 2029 0a20  30 * 60,.    ). 
-00017480: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00017490: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-000174a0: 2d2d 2d2d 2054 6573 7469 6e67 206d 616e  ---- Testing man
-000174b0: 6167 6564 2073 706f 7420 7265 636f 7665  aged spot recove
-000174c0: 7279 202d 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a  ry ----------...
-000174d0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-000174e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-000174f0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-00017500: 6573 745f 7370 6f74 5f72 6563 6f76 6572  est_spot_recover
-00017510: 795f 6177 7328 6177 735f 636f 6e66 6967  y_aws(aws_config
-00017520: 5f72 6567 696f 6e29 3a0a 2020 2020 2222  _region):.    ""
-00017530: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
-00017540: 6f74 2072 6563 6f76 6572 792e 2222 220a  ot recovery.""".
-00017550: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00017560: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00017570: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
-00017580: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-00017590: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
-000175a0: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
-000175b0: 2020 2020 6e61 6d65 2c20 7370 6f74 2e53      name, spot.S
-000175c0: 504f 545f 434c 5553 5445 525f 4e41 4d45  POT_CLUSTER_NAME
-000175d0: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
-000175e0: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
-000175f0: 6c73 6529 0a20 2020 2072 6567 696f 6e20  lse).    region 
-00017600: 3d20 6177 735f 636f 6e66 6967 5f72 6567  = aws_config_reg
-00017610: 696f 6e0a 2020 2020 7465 7374 203d 2054  ion.    test = T
-00017620: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
-00017630: 6f74 5f72 6563 6f76 6572 795f 6177 7327  ot_recovery_aws'
-00017640: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00017650: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
-00017660: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
-00017670: 6420 6177 7320 2d2d 7265 6769 6f6e 207b  d aws --region {
-00017680: 7265 6769 6f6e 7d20 2d6e 207b 6e61 6d65  region} -n {name
-00017690: 7d20 2265 6368 6f20 534b 5950 494c 4f54  } "echo SKYPILOT
-000176a0: 5f54 4153 4b5f 4944 3a20 5c24 534b 5950  _TASK_ID: \$SKYP
-000176b0: 494c 4f54 5f54 4153 4b5f 4944 3b20 736c  ILOT_TASK_ID; sl
-000176c0: 6565 7020 3138 3030 2220 202d 7920 2d64  eep 1800"  -y -d
-000176d0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-000176e0: 736c 6565 7020 3336 3027 2c0a 2020 2020  sleep 360',.    
-000176f0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00017700: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00017710: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-00017720: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-00017730: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-00017740: 2020 2020 6627 5255 4e5f 4944 3d24 2873      f'RUN_ID=$(s
-00017750: 6b79 2073 706f 7420 6c6f 6773 202d 6e20  ky spot logs -n 
-00017760: 7b6e 616d 657d 202d 2d6e 6f2d 666f 6c6c  {name} --no-foll
-00017770: 6f77 207c 2067 7265 7020 534b 5950 494c  ow | grep SKYPIL
-00017780: 4f54 5f54 4153 4b5f 4944 207c 2063 7574  OT_TASK_ID | cut
-00017790: 202d 643a 202d 6632 293b 2065 6368 6f20   -d: -f2); echo 
-000177a0: 2224 5255 4e5f 4944 2220 7c20 7465 6520  "$RUN_ID" | tee 
-000177b0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-000177c0: 6964 272c 0a20 2020 2020 2020 2020 2020  id',.           
-000177d0: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
-000177e0: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
-000177f0: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
-00017800: 6627 6177 7320 6563 3220 7465 726d 696e  f'aws ec2 termin
-00017810: 6174 652d 696e 7374 616e 6365 7320 2d2d  ate-instances --
-00017820: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-00017830: 2d2d 696e 7374 616e 6365 2d69 6473 2024  --instance-ids $
-00017840: 2827 0a20 2020 2020 2020 2020 2020 2020  ('.             
-00017850: 6627 6177 7320 6563 3220 6465 7363 7269  f'aws ec2 descri
-00017860: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
-00017870: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
-00017880: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
-00017890: 2d2d 6669 6c74 6572 7320 4e61 6d65 3d74  --filters Name=t
-000178a0: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
-000178b0: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
-000178c0: 5f6f 6e5f 636c 6f75 647d 2a20 270a 2020  _on_cloud}* '.  
-000178d0: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
-000178e0: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
-000178f0: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
-00017900: 496e 7374 616e 6365 4964 2027 0a20 2020  InstanceId '.   
-00017910: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
-00017920: 7075 7420 7465 7874 2927 292c 0a20 2020  put text)'),.   
-00017930: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00017940: 3130 3027 2c0a 2020 2020 2020 2020 2020  100',.          
-00017950: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00017960: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00017970: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00017980: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
-00017990: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-000179a0: 2027 736c 6565 7020 3230 3027 2c0a 2020   'sleep 200',.  
-000179b0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-000179c0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-000179d0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-000179e0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-000179f0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-00017a00: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-00017a10: 2863 6174 202f 746d 702f 7b6e 616d 657d  (cat /tmp/{name}
-00017a20: 2d72 756e 2d69 6429 3b20 6563 686f 2024  -run-id); echo $
-00017a30: 5255 4e5f 4944 3b20 736b 7920 7370 6f74  RUN_ID; sky spot
-00017a40: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-00017a50: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-00017a60: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-00017a70: 5f49 4420 7c20 6772 6570 2022 2452 554e  _ID | grep "$RUN
-00017a80: 5f49 4422 272c 0a20 2020 2020 2020 205d  _ID"',.        ]
-00017a90: 2c0a 2020 2020 2020 2020 5f53 504f 545f  ,.        _SPOT_
-00017aa0: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
-00017ab0: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
-00017ac0: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-00017ad0: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
-00017ae0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00017af0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00017b00: 7374 2e6d 6172 6b2e 6763 700a 4070 7974  st.mark.gcp.@pyt
-00017b10: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-00017b20: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-00017b30: 706f 745f 7265 636f 7665 7279 5f67 6370  pot_recovery_gcp
-00017b40: 2829 3a0a 2020 2020 2222 2254 6573 7420  ():.    """Test 
-00017b50: 6d61 6e61 6765 6420 7370 6f74 2072 6563  managed spot rec
-00017b60: 6f76 6572 792e 2222 220a 2020 2020 6e61  overy.""".    na
-00017b70: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00017b80: 725f 6e61 6d65 2829 0a20 2020 206e 616d  r_name().    nam
-00017b90: 655f 6f6e 5f63 6c6f 7564 203d 2063 6f6d  e_on_cloud = com
-00017ba0: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
-00017bb0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
-00017bc0: 6c6f 7564 280a 2020 2020 2020 2020 6e61  loud(.        na
-00017bd0: 6d65 2c20 7370 6f74 2e53 504f 545f 434c  me, spot.SPOT_CL
-00017be0: 5553 5445 525f 4e41 4d45 5f50 5245 4649  USTER_NAME_PREFI
-00017bf0: 585f 4c45 4e47 5448 2c20 6164 645f 7573  X_LENGTH, add_us
-00017c00: 6572 5f68 6173 683d 4661 6c73 6529 0a20  er_hash=False). 
-00017c10: 2020 207a 6f6e 6520 3d20 2775 732d 6561     zone = 'us-ea
-00017c20: 7374 342d 6227 0a20 2020 2071 7565 7279  st4-b'.    query
-00017c30: 5f63 6d64 203d 2028 0a20 2020 2020 2020  _cmd = (.       
-00017c40: 2066 2767 636c 6f75 6420 636f 6d70 7574   f'gcloud comput
-00017c50: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
-00017c60: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
-00017c70: 2020 2020 2320 603a 6020 6d65 616e 7320      # `:` means 
-00017c80: 7072 6566 6978 206d 6174 6368 2e0a 2020  prefix match..  
-00017c90: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
-00017ca0: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
-00017cb0: 653a 7b6e 616d 655f 6f6e 5f63 6c6f 7564  e:{name_on_cloud
-00017cc0: 7d29 2220 270a 2020 2020 2020 2020 6627  })" '.        f'
-00017cd0: 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d 202d  --zones={zone} -
-00017ce0: 2d66 6f72 6d61 743d 2276 616c 7565 286e  -format="value(n
-00017cf0: 616d 6529 2227 290a 2020 2020 7465 726d  ame)"').    term
-00017d00: 696e 6174 655f 636d 6420 3d20 2866 2767  inate_cmd = (f'g
-00017d10: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
-00017d20: 7374 616e 6365 7320 6465 6c65 7465 202d  stances delete -
-00017d30: 2d7a 6f6e 653d 7b7a 6f6e 657d 270a 2020  -zone={zone}'.  
-00017d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d50: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
-00017d60: 7b71 7565 7279 5f63 6d64 7d29 2729 0a20  {query_cmd})'). 
-00017d70: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00017d80: 2020 2020 2020 2020 2773 706f 745f 7265          'spot_re
-00017d90: 636f 7665 7279 5f67 6370 272c 0a20 2020  covery_gcp',.   
-00017da0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00017db0: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-00017dc0: 756e 6368 202d 2d63 6c6f 7564 2067 6370  unch --cloud gcp
-00017dd0: 202d 2d7a 6f6e 6520 7b7a 6f6e 657d 202d   --zone {zone} -
-00017de0: 6e20 7b6e 616d 657d 202d 2d63 7075 7320  n {name} --cpus 
-00017df0: 3220 2265 6368 6f20 534b 5950 494c 4f54  2 "echo SKYPILOT
-00017e00: 5f54 4153 4b5f 4944 3a20 5c24 534b 5950  _TASK_ID: \$SKYP
-00017e10: 494c 4f54 5f54 4153 4b5f 4944 3b20 736c  ILOT_TASK_ID; sl
-00017e20: 6565 7020 3138 3030 2220 202d 7920 2d64  eep 1800"  -y -d
-00017e30: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00017e40: 736c 6565 7020 3336 3027 2c0a 2020 2020  sleep 360',.    
-00017e50: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00017e60: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00017e70: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-00017e80: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-00017e90: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-00017ea0: 2020 2020 6627 5255 4e5f 4944 3d24 2873      f'RUN_ID=$(s
-00017eb0: 6b79 2073 706f 7420 6c6f 6773 202d 6e20  ky spot logs -n 
-00017ec0: 7b6e 616d 657d 202d 2d6e 6f2d 666f 6c6c  {name} --no-foll
-00017ed0: 6f77 207c 2067 7265 7020 534b 5950 494c  ow | grep SKYPIL
-00017ee0: 4f54 5f54 4153 4b5f 4944 207c 2063 7574  OT_TASK_ID | cut
-00017ef0: 202d 643a 202d 6632 293b 2065 6368 6f20   -d: -f2); echo 
-00017f00: 2224 5255 4e5f 4944 2220 7c20 7465 6520  "$RUN_ID" | tee 
-00017f10: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00017f20: 6964 272c 0a20 2020 2020 2020 2020 2020  id',.           
-00017f30: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
-00017f40: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
-00017f50: 792e 0a20 2020 2020 2020 2020 2020 2074  y..            t
-00017f60: 6572 6d69 6e61 7465 5f63 6d64 2c0a 2020  erminate_cmd,.  
-00017f70: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00017f80: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
-00017f90: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00017fa0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00017fb0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00017fc0: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
-00017fd0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-00017fe0: 2027 736c 6565 7020 3230 3027 2c0a 2020   'sleep 200',.  
-00017ff0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00018000: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00018010: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-00018020: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-00018030: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-00018040: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-00018050: 2863 6174 202f 746d 702f 7b6e 616d 657d  (cat /tmp/{name}
-00018060: 2d72 756e 2d69 6429 3b20 6563 686f 2024  -run-id); echo $
-00018070: 5255 4e5f 4944 3b20 736b 7920 7370 6f74  RUN_ID; sky spot
-00018080: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-00018090: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-000180a0: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-000180b0: 5f49 443a 207c 2067 7265 7020 2224 5255  _ID: | grep "$RU
-000180c0: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
-000180d0: 5d2c 0a20 2020 2020 2020 205f 5350 4f54  ],.        _SPOT
-000180e0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-000180f0: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
-00018100: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
-00018110: 6f75 743d 3235 202a 2036 302c 0a20 2020  out=25 * 60,.   
-00018120: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00018130: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00018140: 6573 742e 6d61 726b 2e61 7773 0a40 7079  est.mark.aws.@py
-00018150: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
-00018160: 645f 7370 6f74 0a64 6566 2074 6573 745f  d_spot.def test_
-00018170: 7370 6f74 5f70 6970 656c 696e 655f 7265  spot_pipeline_re
-00018180: 636f 7665 7279 5f61 7773 2861 7773 5f63  covery_aws(aws_c
-00018190: 6f6e 6669 675f 7265 6769 6f6e 293a 0a20  onfig_region):. 
-000181a0: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
-000181b0: 6564 2073 706f 7420 7265 636f 7665 7279  ed spot recovery
-000181c0: 2066 6f72 2061 2070 6970 656c 696e 652e   for a pipeline.
-000181d0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-000181e0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000181f0: 2829 0a20 2020 2075 7365 725f 6861 7368  ().    user_hash
-00018200: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-00018210: 6765 745f 7573 6572 5f68 6173 6828 290a  get_user_hash().
-00018220: 2020 2020 7573 6572 5f68 6173 6820 3d20      user_hash = 
-00018230: 7573 6572 5f68 6173 685b 3a63 6f6d 6d6f  user_hash[:commo
-00018240: 6e5f 7574 696c 732e 5553 4552 5f48 4153  n_utils.USER_HAS
-00018250: 485f 4c45 4e47 5448 5f49 4e5f 434c 5553  H_LENGTH_IN_CLUS
-00018260: 5445 525f 4e41 4d45 5d0a 2020 2020 7265  TER_NAME].    re
-00018270: 6769 6f6e 203d 2061 7773 5f63 6f6e 6669  gion = aws_confi
-00018280: 675f 7265 6769 6f6e 0a20 2020 2069 6620  g_region.    if 
-00018290: 7265 6769 6f6e 2021 3d20 2775 732d 6561  region != 'us-ea
-000182a0: 7374 2d32 273a 0a20 2020 2020 2020 2070  st-2':.        p
-000182b0: 7974 6573 742e 736b 6970 2827 4f6e 6c79  ytest.skip('Only
-000182c0: 2072 756e 2073 706f 7420 7069 7065 6c69   run spot pipeli
-000182d0: 6e65 2072 6563 6f76 6572 7920 7465 7374  ne recovery test
-000182e0: 2069 6e20 7573 2d65 6173 742d 3227 290a   in us-east-2').
-000182f0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00018300: 0a20 2020 2020 2020 2027 7370 6f74 5f70  .        'spot_p
-00018310: 6970 656c 696e 655f 7265 636f 7665 7279  ipeline_recovery
-00018320: 5f61 7773 272c 0a20 2020 2020 2020 205b  _aws',.        [
-00018330: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00018340: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-00018350: 6e20 7b6e 616d 657d 2074 6573 7473 2f74  n {name} tests/t
-00018360: 6573 745f 7961 6d6c 732f 7069 7065 6c69  est_yamls/pipeli
-00018370: 6e65 5f61 7773 2e79 616d 6c20 202d 7920  ne_aws.yaml  -y 
-00018380: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-00018390: 2027 736c 6565 7020 3430 3027 2c0a 2020   'sleep 400',.  
-000183a0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-000183b0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-000183c0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-000183d0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-000183e0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-000183f0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-00018400: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-00018410: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00018420: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-00018430: 494c 4f54 5f54 4153 4b5f 4944 3a20 7c20  ILOT_TASK_ID: | 
-00018440: 6375 7420 2d64 3a20 2d66 3229 3b20 6563  cut -d: -f2); ec
-00018450: 686f 2022 2452 554e 5f49 4422 207c 2074  ho "$RUN_ID" | t
-00018460: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
-00018470: 756e 2d69 6427 2c0a 2020 2020 2020 2020  un-id',.        
-00018480: 2020 2020 6627 5255 4e5f 4944 533d 2428      f'RUN_IDS=$(
-00018490: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-000184a0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-000184b0: 6c6f 7720 7c20 6772 6570 202d 4120 3420  low | grep -A 4 
-000184c0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-000184d0: 5320 7c20 6375 7420 2d64 2229 2220 2d66  S | cut -d")" -f
-000184e0: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
-000184f0: 4453 2220 7c20 7465 6520 2f74 6d70 2f7b  DS" | tee /tmp/{
-00018500: 6e61 6d65 7d2d 7275 6e2d 6964 7327 2c0a  name}-run-ids',.
-00018510: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-00018520: 726d 696e 6174 6520 7468 6520 636c 7573  rminate the clus
-00018530: 7465 7220 6d61 6e75 616c 6c79 2e0a 2020  ter manually..  
-00018540: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00018550: 6063 6174 202e 2e2e 7c20 7265 7660 2069  `cat ...| rev` i
-00018560: 7320 746f 2072 6574 7269 6576 6520 7468  s to retrieve th
-00018570: 6520 6a6f 625f 6964 2066 726f 6d20 7468  e job_id from th
-00018580: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00018590: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-000185a0: 2c20 7768 6963 6820 6765 7473 2074 6865  , which gets the
-000185b0: 2073 6563 6f6e 6420 746f 206c 6173 7420   second to last 
-000185c0: 6669 656c 640a 2020 2020 2020 2020 2020  field.          
-000185d0: 2020 2320 7365 7061 7261 7465 6420 6279    # separated by
-000185e0: 2060 2d60 2e0a 2020 2020 2020 2020 2020   `-`..          
-000185f0: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
-00018600: 2020 2020 6627 5350 4f54 5f4a 4f42 5f49      f'SPOT_JOB_I
-00018610: 443d 6063 6174 202f 746d 702f 7b6e 616d  D=`cat /tmp/{nam
-00018620: 657d 2d72 756e 2d69 6420 7c20 7265 7620  e}-run-id | rev 
-00018630: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
-00018640: 2020 2020 2763 7574 202d 645c 272d 5c27      'cut -d\'-\'
-00018650: 202d 6632 207c 2072 6576 603b 270a 2020   -f2 | rev`;'.  
-00018660: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00018670: 6177 7320 6563 3220 7465 726d 696e 6174  aws ec2 terminat
-00018680: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
-00018690: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d2d  gion {region} --
-000186a0: 696e 7374 616e 6365 2d69 6473 2024 2827  instance-ids $('
-000186b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000186c0: 2066 2761 7773 2065 6332 2064 6573 6372   f'aws ec2 descr
-000186d0: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
-000186e0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-000186f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00018700: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
-00018710: 6669 7820 7468 6520 6e61 6d65 2066 6f72  fix the name for
-00018720: 2073 706f 7420 636c 7573 7465 722e 0a20   spot cluster.. 
-00018730: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00018740: 2d2d 6669 6c74 6572 7320 4e61 6d65 3d74  --filters Name=t
-00018750: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
-00018760: 616d 652c 5661 6c75 6573 3d2a 2d24 7b53  ame,Values=*-${S
-00018770: 504f 545f 4a4f 425f 4944 7d27 0a20 2020  POT_JOB_ID}'.   
-00018780: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-00018790: 7b75 7365 725f 6861 7368 7d20 270a 2020  {user_hash} '.  
-000187a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000187b0: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
-000187c0: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
-000187d0: 5b5d 2e49 6e73 7461 6e63 6549 6420 270a  [].InstanceId '.
-000187e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187f0: 272d 2d6f 7574 7075 7420 7465 7874 2927  '--output text)'
-00018800: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
-00018810: 736c 6565 7020 3130 3027 2c0a 2020 2020  sleep 100',.    
-00018820: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00018830: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00018840: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-00018850: 202d 6e31 207c 2067 7265 7020 2252 4543   -n1 | grep "REC
-00018860: 4f56 4552 494e 4722 272c 0a20 2020 2020  OVERING"',.     
-00018870: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
-00018880: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00018890: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-000188a0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-000188b0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-000188c0: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
-000188d0: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
-000188e0: 4e5f 4944 3d24 2863 6174 202f 746d 702f  N_ID=$(cat /tmp/
-000188f0: 7b6e 616d 657d 2d72 756e 2d69 6429 3b20  {name}-run-id); 
-00018900: 6563 686f 2024 5255 4e5f 4944 3b20 736b  echo $RUN_ID; sk
-00018910: 7920 7370 6f74 206c 6f67 7320 2d6e 207b  y spot logs -n {
-00018920: 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f  name} --no-follo
-00018930: 7720 7c20 6772 6570 2053 4b59 5049 4c4f  w | grep SKYPILO
-00018940: 545f 5441 534b 5f49 443a 207c 2067 7265  T_TASK_ID: | gre
-00018950: 7020 2224 5255 4e5f 4944 2227 2c0a 2020  p "$RUN_ID"',.  
-00018960: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
-00018970: 4944 533d 2428 736b 7920 7370 6f74 206c  IDS=$(sky spot l
-00018980: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
-00018990: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
-000189a0: 202d 4120 3420 534b 5950 494c 4f54 5f54   -A 4 SKYPILOT_T
-000189b0: 4153 4b5f 4944 5320 7c20 6375 7420 2d64  ASK_IDS | cut -d
-000189c0: 2229 2220 2d66 3229 3b20 6563 686f 2022  ")" -f2); echo "
-000189d0: 2452 554e 5f49 4453 2220 7c20 7465 6520  $RUN_IDS" | tee 
-000189e0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-000189f0: 6964 732d 6e65 7727 2c0a 2020 2020 2020  ids-new',.      
-00018a00: 2020 2020 2020 6627 6469 6666 202f 746d        f'diff /tm
-00018a10: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
-00018a20: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
-00018a30: 2d69 6473 2d6e 6577 272c 0a20 2020 2020  -ids-new',.     
-00018a40: 2020 2020 2020 2066 2763 6174 202f 746d         f'cat /tm
-00018a50: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
-00018a60: 207c 2073 6564 202d 6e20 3270 207c 2067   | sed -n 2p | g
-00018a70: 7265 7020 6063 6174 202f 746d 702f 7b6e  rep `cat /tmp/{n
-00018a80: 616d 657d 2d72 756e 2d69 6460 272c 0a20  ame}-run-id`',. 
-00018a90: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00018aa0: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-00018ab0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00018ac0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00018ad0: 2020 2074 696d 656f 7574 3d32 3520 2a20     timeout=25 * 
-00018ae0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00018af0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00018b00: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00018b10: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
-00018b20: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
-00018b30: 6620 7465 7374 5f73 706f 745f 7069 7065  f test_spot_pipe
-00018b40: 6c69 6e65 5f72 6563 6f76 6572 795f 6763  line_recovery_gc
-00018b50: 7028 293a 0a20 2020 2022 2222 5465 7374  p():.    """Test
-00018b60: 206d 616e 6167 6564 2073 706f 7420 7265   managed spot re
-00018b70: 636f 7665 7279 2066 6f72 2061 2070 6970  covery for a pip
-00018b80: 656c 696e 652e 2222 220a 2020 2020 6e61  eline.""".    na
-00018b90: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00018ba0: 725f 6e61 6d65 2829 0a20 2020 207a 6f6e  r_name().    zon
-00018bb0: 6520 3d20 2775 732d 6561 7374 342d 6227  e = 'us-east4-b'
-00018bc0: 0a20 2020 2075 7365 725f 6861 7368 203d  .    user_hash =
-00018bd0: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6765   common_utils.ge
-00018be0: 745f 7573 6572 5f68 6173 6828 290a 2020  t_user_hash().  
-00018bf0: 2020 7573 6572 5f68 6173 6820 3d20 7573    user_hash = us
-00018c00: 6572 5f68 6173 685b 3a63 6f6d 6d6f 6e5f  er_hash[:common_
-00018c10: 7574 696c 732e 5553 4552 5f48 4153 485f  utils.USER_HASH_
-00018c20: 4c45 4e47 5448 5f49 4e5f 434c 5553 5445  LENGTH_IN_CLUSTE
-00018c30: 525f 4e41 4d45 5d0a 2020 2020 7175 6572  R_NAME].    quer
-00018c40: 795f 636d 6420 3d20 2827 6763 6c6f 7564  y_cmd = ('gcloud
-00018c50: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
-00018c60: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
-00018c70: 3d27 0a20 2020 2020 2020 2020 2020 2020  ='.             
-00018c80: 2020 2020 6627 2228 6c61 6265 6c73 2e72      f'"(labels.r
-00018c90: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
-00018ca0: 2a2d 247b 7b53 504f 545f 4a4f 425f 4944  *-${{SPOT_JOB_ID
-00018cb0: 7d7d 2d7b 7573 6572 5f68 6173 687d 2922  }}-{user_hash})"
-00018cc0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00018cd0: 2020 2020 6627 2d2d 7a6f 6e65 733d 7b7a      f'--zones={z
-00018ce0: 6f6e 657d 202d 2d66 6f72 6d61 743d 2276  one} --format="v
-00018cf0: 616c 7565 286e 616d 6529 2227 290a 2020  alue(name)"').  
-00018d00: 2020 7465 726d 696e 6174 655f 636d 6420    terminate_cmd 
-00018d10: 3d20 2866 2767 636c 6f75 6420 636f 6d70  = (f'gcloud comp
-00018d20: 7574 6520 696e 7374 616e 6365 7320 6465  ute instances de
-00018d30: 6c65 7465 202d 2d7a 6f6e 653d 7b7a 6f6e  lete --zone={zon
-00018d40: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
-00018d50: 2020 2020 2020 2020 2066 2720 2d2d 7175           f' --qu
-00018d60: 6965 7420 2428 7b71 7565 7279 5f63 6d64  iet $({query_cmd
-00018d70: 7d29 2729 0a20 2020 2074 6573 7420 3d20  })').    test = 
-00018d80: 5465 7374 280a 2020 2020 2020 2020 2773  Test(.        's
-00018d90: 706f 745f 7069 7065 6c69 6e65 5f72 6563  pot_pipeline_rec
-00018da0: 6f76 6572 795f 6763 7027 2c0a 2020 2020  overy_gcp',.    
-00018db0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00018dc0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-00018dd0: 6e63 6820 2d6e 207b 6e61 6d65 7d20 7465  nch -n {name} te
-00018de0: 7374 732f 7465 7374 5f79 616d 6c73 2f70  sts/test_yamls/p
-00018df0: 6970 656c 696e 655f 6763 702e 7961 6d6c  ipeline_gcp.yaml
-00018e00: 2020 2d79 202d 6427 2c0a 2020 2020 2020    -y -d',.      
-00018e10: 2020 2020 2020 2773 6c65 6570 2034 3030        'sleep 400
-00018e20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00018e30: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00018e40: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00018e50: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00018e60: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
-00018e70: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
-00018e80: 5f49 443d 2428 736b 7920 7370 6f74 206c  _ID=$(sky spot l
-00018e90: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
-00018ea0: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
-00018eb0: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-00018ec0: 443a 207c 2063 7574 202d 643a 202d 6632  D: | cut -d: -f2
-00018ed0: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
-00018ee0: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
-00018ef0: 6d65 7d2d 7275 6e2d 6964 272c 0a20 2020  me}-run-id',.   
-00018f00: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-00018f10: 4453 3d24 2873 6b79 2073 706f 7420 6c6f  DS=$(sky spot lo
-00018f20: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
-00018f30: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
-00018f40: 2d41 2034 2053 4b59 5049 4c4f 545f 5441  -A 4 SKYPILOT_TA
-00018f50: 534b 5f49 4453 207c 2063 7574 202d 6422  SK_IDS | cut -d"
-00018f60: 2922 202d 6632 293b 2065 6368 6f20 2224  )" -f2); echo "$
-00018f70: 5255 4e5f 4944 5322 207c 2074 6565 202f  RUN_IDS" | tee /
-00018f80: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-00018f90: 6473 272c 0a20 2020 2020 2020 2020 2020  ds',.           
-00018fa0: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
-00018fb0: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
-00018fc0: 792e 0a20 2020 2020 2020 2020 2020 2023  y..            #
-00018fd0: 2054 6865 2060 6361 7420 2e2e 2e7c 2072   The `cat ...| r
-00018fe0: 6576 6020 6973 2074 6f20 7265 7472 6965  ev` is to retrie
-00018ff0: 7665 2074 6865 206a 6f62 5f69 6420 6672  ve the job_id fr
-00019000: 6f6d 2074 6865 0a20 2020 2020 2020 2020  om the.         
-00019010: 2020 2023 2053 4b59 5049 4c4f 545f 5441     # SKYPILOT_TA
-00019020: 534b 5f49 442c 2077 6869 6368 2067 6574  SK_ID, which get
-00019030: 7320 7468 6520 7365 636f 6e64 2074 6f20  s the second to 
-00019040: 6c61 7374 2066 6965 6c64 0a20 2020 2020  last field.     
-00019050: 2020 2020 2020 2023 2073 6570 6172 6174         # separat
-00019060: 6564 2062 7920 602d 602e 0a20 2020 2020  ed by `-`..     
-00019070: 2020 2020 2020 2028 6627 5350 4f54 5f4a         (f'SPOT_J
-00019080: 4f42 5f49 443d 6063 6174 202f 746d 702f  OB_ID=`cat /tmp/
-00019090: 7b6e 616d 657d 2d72 756e 2d69 6420 7c20  {name}-run-id | 
-000190a0: 7265 7620 7c20 270a 2020 2020 2020 2020  rev | '.        
-000190b0: 2020 2020 2066 2763 7574 202d 645c 272d       f'cut -d\'-
-000190c0: 5c27 202d 6632 207c 2072 6576 603b 7b74  \' -f2 | rev`;{t
-000190d0: 6572 6d69 6e61 7465 5f63 6d64 7d27 292c  erminate_cmd}'),
-000190e0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000190f0: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-00019100: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00019110: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00019120: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-00019130: 3120 7c20 6772 6570 2022 5245 434f 5645  1 | grep "RECOVE
-00019140: 5249 4e47 2227 2c0a 2020 2020 2020 2020  RING"',.        
-00019150: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
-00019160: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00019170: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00019180: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00019190: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-000191a0: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-000191b0: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-000191c0: 443d 2428 6361 7420 2f74 6d70 2f7b 6e61  D=$(cat /tmp/{na
-000191d0: 6d65 7d2d 7275 6e2d 6964 293b 2065 6368  me}-run-id); ech
-000191e0: 6f20 2452 554e 5f49 443b 2073 6b79 2073  o $RUN_ID; sky s
-000191f0: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
-00019200: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
-00019210: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
-00019220: 4153 4b5f 4944 3a20 7c20 6772 6570 2022  ASK_ID: | grep "
-00019230: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
-00019240: 2020 2020 2020 2066 2752 554e 5f49 4453         f'RUN_IDS
-00019250: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
-00019260: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-00019270: 666f 6c6c 6f77 207c 2067 7265 7020 2d41  follow | grep -A
-00019280: 2034 2053 4b59 5049 4c4f 545f 5441 534b   4 SKYPILOT_TASK
-00019290: 5f49 4453 207c 2063 7574 202d 6422 2922  _IDS | cut -d")"
-000192a0: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
-000192b0: 4e5f 4944 5322 207c 2074 6565 202f 746d  N_IDS" | tee /tm
-000192c0: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
-000192d0: 2d6e 6577 272c 0a20 2020 2020 2020 2020  -new',.         
-000192e0: 2020 2066 2764 6966 6620 2f74 6d70 2f7b     f'diff /tmp/{
-000192f0: 6e61 6d65 7d2d 7275 6e2d 6964 7320 2f74  name}-run-ids /t
-00019300: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-00019310: 732d 6e65 7727 2c0a 2020 2020 2020 2020  s-new',.        
-00019320: 2020 2020 6627 6361 7420 2f74 6d70 2f7b      f'cat /tmp/{
-00019330: 6e61 6d65 7d2d 7275 6e2d 6964 7320 7c20  name}-run-ids | 
-00019340: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
-00019350: 2060 6361 7420 2f74 6d70 2f7b 6e61 6d65   `cat /tmp/{name
-00019360: 7d2d 7275 6e2d 6964 6027 2c0a 2020 2020  }-run-id`',.    
-00019370: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
-00019380: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-00019390: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-000193a0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-000193b0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
-000193c0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-000193d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000193e0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000193f0: 666c 7569 6473 7461 636b 2020 2320 466c  fluidstack  # Fl
-00019400: 7569 6473 7461 636b 2064 6f65 7320 6e6f  uidstack does no
-00019410: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-00019420: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00019430: 2e6d 6172 6b2e 6e6f 5f61 7a75 7265 2020  .mark.no_azure  
-00019440: 2320 417a 7572 6520 646f 6573 206e 6f74  # Azure does not
-00019450: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00019460: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00019470: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-00019480: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-00019490: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-000194a0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-000194b0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-000194c0: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-000194d0: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-000194e0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-000194f0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00019500: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-00019510: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00019520: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00019530: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00019540: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-00019550: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
-00019560: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00019570: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00019580: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00019590: 6574 6573 2020 2320 4b75 6265 726e 6574  etes  # Kubernet
-000195a0: 6573 2064 6f65 7320 6e6f 7420 6861 7665  es does not have
-000195b0: 2061 206e 6f74 696f 6e20 6f66 2073 706f   a notion of spo
-000195c0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-000195d0: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-000195e0: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-000195f0: 706f 745f 7265 636f 7665 7279 5f64 6566  pot_recovery_def
-00019600: 6175 6c74 5f72 6573 6f75 7263 6573 2867  ault_resources(g
-00019610: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-00019620: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
-00019630: 6d61 6e61 6765 6420 7370 6f74 2072 6563  managed spot rec
-00019640: 6f76 6572 7920 666f 7220 6465 6661 756c  overy for defaul
-00019650: 7420 7265 736f 7572 6365 732e 2222 220a  t resources.""".
-00019660: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00019670: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00019680: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00019690: 2020 2020 2020 2020 276d 616e 6167 6564          'managed
-000196a0: 2d73 706f 742d 7265 636f 7665 7279 2d64  -spot-recovery-d
-000196b0: 6566 6175 6c74 2d72 6573 6f75 7263 6573  efault-resources
-000196c0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000196d0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000196e0: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
-000196f0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00019700: 6e65 7269 635f 636c 6f75 647d 2022 736c  neric_cloud} "sl
-00019710: 6565 7020 3330 2026 2620 7375 646f 2073  eep 30 && sudo s
-00019720: 6875 7464 6f77 6e20 6e6f 7720 2626 2073  hutdown now && s
-00019730: 6c65 6570 2031 3030 3022 202d 7920 2d64  leep 1000" -y -d
-00019740: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00019750: 736c 6565 7020 3336 3027 2c0a 2020 2020  sleep 360',.    
-00019760: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00019770: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00019780: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-00019790: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-000197a0: 4e49 4e47 5c7c 5245 434f 5645 5249 4e47  NING\|RECOVERING
-000197b0: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
-000197c0: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-000197d0: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-000197e0: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
-000197f0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00019800: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
-00019810: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00019820: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00019830: 6d61 726b 2e61 7773 0a40 7079 7465 7374  mark.aws.@pytest
-00019840: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-00019850: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-00019860: 5f72 6563 6f76 6572 795f 6d75 6c74 695f  _recovery_multi_
-00019870: 6e6f 6465 5f61 7773 2861 7773 5f63 6f6e  node_aws(aws_con
-00019880: 6669 675f 7265 6769 6f6e 293a 0a20 2020  fig_region):.   
-00019890: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
-000198a0: 2073 706f 7420 7265 636f 7665 7279 2e22   spot recovery."
-000198b0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-000198c0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-000198d0: 290a 2020 2020 6e61 6d65 5f6f 6e5f 636c  ).    name_on_cl
-000198e0: 6f75 6420 3d20 636f 6d6d 6f6e 5f75 7469  oud = common_uti
-000198f0: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
-00019900: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 0a20  name_on_cloud(. 
-00019910: 2020 2020 2020 206e 616d 652c 2073 706f         name, spo
-00019920: 742e 5350 4f54 5f43 4c55 5354 4552 5f4e  t.SPOT_CLUSTER_N
-00019930: 414d 455f 5052 4546 4958 5f4c 454e 4754  AME_PREFIX_LENGT
-00019940: 482c 2061 6464 5f75 7365 725f 6861 7368  H, add_user_hash
-00019950: 3d46 616c 7365 290a 2020 2020 7265 6769  =False).    regi
-00019960: 6f6e 203d 2061 7773 5f63 6f6e 6669 675f  on = aws_config_
-00019970: 7265 6769 6f6e 0a20 2020 2074 6573 7420  region.    test 
-00019980: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00019990: 2773 706f 745f 7265 636f 7665 7279 5f6d  'spot_recovery_m
-000199a0: 756c 7469 5f6e 6f64 655f 6177 7327 2c0a  ulti_node_aws',.
-000199b0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-000199c0: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
-000199d0: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
-000199e0: 6177 7320 2d2d 7265 6769 6f6e 207b 7265  aws --region {re
-000199f0: 6769 6f6e 7d20 2d6e 207b 6e61 6d65 7d20  gion} -n {name} 
-00019a00: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 2265  --num-nodes 2 "e
-00019a10: 6368 6f20 534b 5950 494c 4f54 5f54 4153  cho SKYPILOT_TAS
-00019a20: 4b5f 4944 3a20 5c24 534b 5950 494c 4f54  K_ID: \$SKYPILOT
-00019a30: 5f54 4153 4b5f 4944 3b20 736c 6565 7020  _TASK_ID; sleep 
-00019a40: 3138 3030 2220 202d 7920 2d64 272c 0a20  1800"  -y -d',. 
-00019a50: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00019a60: 7020 3435 3027 2c0a 2020 2020 2020 2020  p 450',.        
-00019a70: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00019a80: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00019a90: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00019aa0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
-00019ab0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00019ac0: 6627 5255 4e5f 4944 3d24 2873 6b79 2073  f'RUN_ID=$(sky s
-00019ad0: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
-00019ae0: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
-00019af0: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
-00019b00: 4153 4b5f 4944 207c 2063 7574 202d 643a  ASK_ID | cut -d:
-00019b10: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
-00019b20: 4e5f 4944 2220 7c20 7465 6520 2f74 6d70  N_ID" | tee /tmp
-00019b30: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 272c  /{name}-run-id',
-00019b40: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00019b50: 6572 6d69 6e61 7465 2074 6865 2077 6f72  erminate the wor
-00019b60: 6b65 7220 6d61 6e75 616c 6c79 2e0a 2020  ker manually..  
-00019b70: 2020 2020 2020 2020 2020 2866 2761 7773            (f'aws
-00019b80: 2065 6332 2074 6572 6d69 6e61 7465 2d69   ec2 terminate-i
-00019b90: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-00019ba0: 6e20 7b72 6567 696f 6e7d 202d 2d69 6e73  n {region} --ins
-00019bb0: 7461 6e63 652d 6964 7320 2428 270a 2020  tance-ids $('.  
-00019bc0: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
-00019bd0: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
-00019be0: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
-00019bf0: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
-00019c00: 2020 2020 2020 2020 2066 272d 2d66 696c           f'--fil
-00019c10: 7465 7273 204e 616d 653d 7461 673a 7261  ters Name=tag:ra
-00019c20: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
-00019c30: 616c 7565 733d 7b6e 616d 655f 6f6e 5f63  alues={name_on_c
-00019c40: 6c6f 7564 7d2a 2027 0a20 2020 2020 2020  loud}* '.       
-00019c50: 2020 2020 2020 274e 616d 653d 7461 673a        'Name=tag:
-00019c60: 7261 792d 6e6f 6465 2d74 7970 652c 5661  ray-node-type,Va
-00019c70: 6c75 6573 3d77 6f72 6b65 7220 270a 2020  lues=worker '.  
-00019c80: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
-00019c90: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
-00019ca0: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
-00019cb0: 496e 7374 616e 6365 4964 2027 0a20 2020  InstanceId '.   
-00019cc0: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
-00019cd0: 7075 7420 7465 7874 2927 292c 0a20 2020  put text)'),.   
-00019ce0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00019cf0: 3530 272c 0a20 2020 2020 2020 2020 2020  50',.           
-00019d00: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00019d10: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00019d20: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-00019d30: 6772 6570 2022 5245 434f 5645 5249 4e47  grep "RECOVERING
-00019d40: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00019d50: 2773 6c65 6570 2035 3630 272c 0a20 2020  'sleep 560',.   
-00019d60: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00019d70: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-00019d80: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-00019d90: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-00019da0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
-00019db0: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
-00019dc0: 6361 7420 2f74 6d70 2f7b 6e61 6d65 7d2d  cat /tmp/{name}-
-00019dd0: 7275 6e2d 6964 293b 2065 6368 6f20 2452  run-id); echo $R
-00019de0: 554e 5f49 443b 2073 6b79 2073 706f 7420  UN_ID; sky spot 
-00019df0: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
-00019e00: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
-00019e10: 7020 534b 5950 494c 4f54 5f54 4153 4b5f  p SKYPILOT_TASK_
-00019e20: 4944 207c 2063 7574 202d 643a 202d 6632  ID | cut -d: -f2
-00019e30: 207c 2067 7265 7020 2224 5255 4e5f 4944   | grep "$RUN_ID
-00019e40: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
-00019e50: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-00019e60: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-00019e70: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
-00019e80: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00019e90: 3330 202a 2036 302c 0a20 2020 2029 0a20  30 * 60,.    ). 
-00019ea0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00019eb0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00019ec0: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-00019ed0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-00019ee0: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-00019ef0: 5f72 6563 6f76 6572 795f 6d75 6c74 695f  _recovery_multi_
-00019f00: 6e6f 6465 5f67 6370 2829 3a0a 2020 2020  node_gcp():.    
-00019f10: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
-00019f20: 7370 6f74 2072 6563 6f76 6572 792e 2222  spot recovery.""
-00019f30: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-00019f40: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00019f50: 0a20 2020 206e 616d 655f 6f6e 5f63 6c6f  .    name_on_clo
-00019f60: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
-00019f70: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
-00019f80: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
-00019f90: 2020 2020 2020 6e61 6d65 2c20 7370 6f74        name, spot
-00019fa0: 2e53 504f 545f 434c 5553 5445 525f 4e41  .SPOT_CLUSTER_NA
-00019fb0: 4d45 5f50 5245 4649 585f 4c45 4e47 5448  ME_PREFIX_LENGTH
-00019fc0: 2c20 6164 645f 7573 6572 5f68 6173 683d  , add_user_hash=
-00019fd0: 4661 6c73 6529 0a20 2020 207a 6f6e 6520  False).    zone 
-00019fe0: 3d20 2775 732d 7765 7374 322d 6127 0a20  = 'us-west2-a'. 
-00019ff0: 2020 2023 2055 7365 2027 3a27 2074 6f20     # Use ':' to 
-0001a000: 6d61 7463 6820 6173 2074 6865 2063 6c75  match as the clu
-0001a010: 7374 6572 206e 616d 6520 7769 6c6c 2063  ster name will c
-0001a020: 6f6e 7461 696e 2074 6865 2073 7566 6669  ontain the suffi
-0001a030: 7820 7769 7468 206a 6f62 2069 640a 2020  x with job id.  
-0001a040: 2020 7175 6572 795f 636d 6420 3d20 280a    query_cmd = (.
-0001a050: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
-0001a060: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
-0001a070: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
-0001a080: 3d27 0a20 2020 2020 2020 2066 2722 286c  ='.        f'"(l
-0001a090: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
-0001a0a0: 722d 6e61 6d65 3a7b 6e61 6d65 5f6f 6e5f  r-name:{name_on_
-0001a0b0: 636c 6f75 647d 2041 4e44 2027 0a20 2020  cloud} AND '.   
-0001a0c0: 2020 2020 2066 276c 6162 656c 732e 7261       f'labels.ra
-0001a0d0: 792d 6e6f 6465 2d74 7970 653d 776f 726b  y-node-type=work
-0001a0e0: 6572 2922 202d 2d7a 6f6e 6573 3d7b 7a6f  er)" --zones={zo
-0001a0f0: 6e65 7d20 2d2d 666f 726d 6174 3d22 7661  ne} --format="va
-0001a100: 6c75 6528 6e61 6d65 2922 2729 0a20 2020  lue(name)"').   
-0001a110: 2074 6572 6d69 6e61 7465 5f63 6d64 203d   terminate_cmd =
-0001a120: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
-0001a130: 7465 2069 6e73 7461 6e63 6573 2064 656c  te instances del
-0001a140: 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65  ete --zone={zone
-0001a150: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-0001a160: 2020 2020 2020 2020 6627 202d 2d71 7569          f' --qui
-0001a170: 6574 2024 287b 7175 6572 795f 636d 647d  et $({query_cmd}
-0001a180: 2927 290a 2020 2020 7465 7374 203d 2054  )').    test = T
-0001a190: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
-0001a1a0: 6f74 5f72 6563 6f76 6572 795f 6d75 6c74  ot_recovery_mult
-0001a1b0: 695f 6e6f 6465 5f67 6370 272c 0a20 2020  i_node_gcp',.   
-0001a1c0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001a1d0: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-0001a1e0: 756e 6368 202d 2d63 6c6f 7564 2067 6370  unch --cloud gcp
-0001a1f0: 202d 2d7a 6f6e 6520 7b7a 6f6e 657d 202d   --zone {zone} -
-0001a200: 6e20 7b6e 616d 657d 202d 2d6e 756d 2d6e  n {name} --num-n
-0001a210: 6f64 6573 2032 2022 6563 686f 2053 4b59  odes 2 "echo SKY
-0001a220: 5049 4c4f 545f 5441 534b 5f49 443a 205c  PILOT_TASK_ID: \
-0001a230: 2453 4b59 5049 4c4f 545f 5441 534b 5f49  $SKYPILOT_TASK_I
-0001a240: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
-0001a250: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-0001a260: 2020 2020 2773 6c65 6570 2034 3030 272c      'sleep 400',
-0001a270: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0001a280: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0001a290: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001a2a0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001a2b0: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-0001a2c0: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-0001a2d0: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
-0001a2e0: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-0001a2f0: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
-0001a300: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
-0001a310: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
-0001a320: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
-0001a330: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-0001a340: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
-0001a350: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
-0001a360: 6520 7468 6520 776f 726b 6572 206d 616e  e the worker man
-0001a370: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
-0001a380: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
-0001a390: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001a3a0: 6c65 6570 2035 3027 2c0a 2020 2020 2020  leep 50',.      
-0001a3b0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0001a3c0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001a3d0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001a3e0: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
-0001a3f0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-0001a400: 2020 2020 2027 736c 6565 7020 3432 3027       'sleep 420'
-0001a410: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001a420: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-0001a430: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-0001a440: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001a450: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
-0001a460: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
-0001a470: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
-0001a480: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
-0001a490: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
-0001a4a0: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
-0001a4b0: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
-0001a4c0: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
-0001a4d0: 5441 534b 5f49 4420 7c20 6375 7420 2d64  TASK_ID | cut -d
-0001a4e0: 3a20 2d66 3220 7c20 6772 6570 2022 2452  : -f2 | grep "$R
-0001a4f0: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
-0001a500: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
-0001a510: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-0001a520: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-0001a530: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-0001a540: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
-0001a550: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0001a560: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-0001a570: 7465 7374 2e6d 6172 6b2e 6177 730a 4070  test.mark.aws.@p
-0001a580: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-0001a590: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
-0001a5a0: 5f73 706f 745f 6361 6e63 656c 6c61 7469  _spot_cancellati
-0001a5b0: 6f6e 5f61 7773 2861 7773 5f63 6f6e 6669  on_aws(aws_confi
-0001a5c0: 675f 7265 6769 6f6e 293a 0a20 2020 206e  g_region):.    n
-0001a5d0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0001a5e0: 6572 5f6e 616d 6528 290a 2020 2020 6e61  er_name().    na
-0001a5f0: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
-0001a600: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
-0001a610: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-0001a620: 636c 6f75 6428 0a20 2020 2020 2020 206e  cloud(.        n
-0001a630: 616d 652c 2073 706f 742e 5350 4f54 5f43  ame, spot.SPOT_C
-0001a640: 4c55 5354 4552 5f4e 414d 455f 5052 4546  LUSTER_NAME_PREF
-0001a650: 4958 5f4c 454e 4754 482c 2061 6464 5f75  IX_LENGTH, add_u
-0001a660: 7365 725f 6861 7368 3d46 616c 7365 290a  ser_hash=False).
-0001a670: 2020 2020 6e61 6d65 5f32 5f6f 6e5f 636c      name_2_on_cl
-0001a680: 6f75 6420 3d20 636f 6d6d 6f6e 5f75 7469  oud = common_uti
-0001a690: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
-0001a6a0: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 0a20  name_on_cloud(. 
-0001a6b0: 2020 2020 2020 2066 277b 6e61 6d65 7d2d         f'{name}-
-0001a6c0: 3227 2c20 7370 6f74 2e53 504f 545f 434c  2', spot.SPOT_CL
-0001a6d0: 5553 5445 525f 4e41 4d45 5f50 5245 4649  USTER_NAME_PREFI
-0001a6e0: 585f 4c45 4e47 5448 2c20 6164 645f 7573  X_LENGTH, add_us
-0001a6f0: 6572 5f68 6173 683d 4661 6c73 6529 0a20  er_hash=False). 
-0001a700: 2020 206e 616d 655f 335f 6f6e 5f63 6c6f     name_3_on_clo
-0001a710: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
-0001a720: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
-0001a730: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
-0001a740: 2020 2020 2020 6627 7b6e 616d 657d 2d33        f'{name}-3
-0001a750: 272c 2073 706f 742e 5350 4f54 5f43 4c55  ', spot.SPOT_CLU
-0001a760: 5354 4552 5f4e 414d 455f 5052 4546 4958  STER_NAME_PREFIX
-0001a770: 5f4c 454e 4754 482c 2061 6464 5f75 7365  _LENGTH, add_use
-0001a780: 725f 6861 7368 3d46 616c 7365 290a 2020  r_hash=False).  
-0001a790: 2020 7265 6769 6f6e 203d 2061 7773 5f63    region = aws_c
-0001a7a0: 6f6e 6669 675f 7265 6769 6f6e 0a20 2020  onfig_region.   
-0001a7b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001a7c0: 2020 2020 2020 2773 706f 745f 6361 6e63        'spot_canc
-0001a7d0: 656c 6c61 7469 6f6e 5f61 7773 272c 0a20  ellation_aws',. 
-0001a7e0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001a7f0: 2020 2020 2023 2054 6573 7420 6361 6e63       # Test canc
-0001a800: 656c 6c61 7469 6f6e 2064 7572 696e 6720  ellation during 
-0001a810: 7370 6f74 2063 6c75 7374 6572 2062 6569  spot cluster bei
-0001a820: 6e67 206c 6175 6e63 6865 642e 0a20 2020  ng launched..   
-0001a830: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0001a840: 706f 7420 6c61 756e 6368 202d 2d63 6c6f  pot launch --clo
-0001a850: 7564 2061 7773 202d 2d72 6567 696f 6e20  ud aws --region 
-0001a860: 7b72 6567 696f 6e7d 202d 6e20 7b6e 616d  {region} -n {nam
-0001a870: 657d 2022 736c 6565 7020 3130 3030 2220  e} "sleep 1000" 
-0001a880: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
-0001a890: 2020 2020 2027 736c 6565 7020 3630 272c       'sleep 60',
-0001a8a0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0001a8b0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0001a8c0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001a8d0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001a8e0: 2022 5354 4152 5449 4e47 2227 2c0a 2020   "STARTING"',.  
-0001a8f0: 2020 2020 2020 2020 2020 5f53 504f 545f            _SPOT_
-0001a900: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
-0001a910: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
-0001a920: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
-0001a930: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
-0001a940: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0001a950: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001a960: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001a970: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
-0001a980: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
-0001a990: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001a9a0: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
-0001a9b0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-0001a9c0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-0001a9d0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0001a9e0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-0001a9f0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-0001aa00: 2020 2020 2020 2028 6627 733d 2428 6177         (f's=$(aw
-0001aa10: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-0001aa20: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-0001aa30: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-0001aa40: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
-0001aa50: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
-0001aa60: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-0001aa70: 5661 6c75 6573 3d7b 6e61 6d65 5f6f 6e5f  Values={name_on_
-0001aa80: 636c 6f75 647d 2d2a 2027 0a20 2020 2020  cloud}-* '.     
-0001aa90: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-0001aaa0: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
-0001aab0: 2e49 6e73 7461 6e63 6573 5b5d 2e53 7461  .Instances[].Sta
-0001aac0: 7465 5b5d 2e4e 616d 6520 270a 2020 2020  te[].Name '.    
-0001aad0: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
-0001aae0: 7574 2074 6578 7429 2026 2620 6563 686f  ut text) && echo
-0001aaf0: 2022 2473 2220 2626 2065 6368 6f3b 205b   "$s" && echo; [
-0001ab00: 5b20 2d7a 2022 2473 2220 5d5d 207c 7c20  [ -z "$s" ]] || 
-0001ab10: 5b5b 2022 2473 2220 3d20 2274 6572 6d69  [[ "$s" = "termi
-0001ab20: 6e61 7465 6422 205d 5d20 7c7c 205b 5b20  nated" ]] || [[ 
-0001ab30: 2224 7322 203d 2022 7368 7574 7469 6e67  "$s" = "shutting
-0001ab40: 2d64 6f77 6e22 205d 5d27 0a20 2020 2020  -down" ]]'.     
-0001ab50: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-0001ab60: 2020 2020 2020 2320 5465 7374 2063 616e        # Test can
-0001ab70: 6365 6c6c 696e 6720 7468 6520 7370 6f74  celling the spot
-0001ab80: 2063 6c75 7374 6572 2064 7572 696e 6720   cluster during 
-0001ab90: 7370 6f74 206a 6f62 2062 6569 6e67 2073  spot job being s
-0001aba0: 6574 7570 2e0a 2020 2020 2020 2020 2020  etup..          
-0001abb0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-0001abc0: 6e63 6820 2d2d 636c 6f75 6420 6177 7320  nch --cloud aws 
-0001abd0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0001abe0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 7465  } -n {name}-2 te
-0001abf0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-0001ac00: 6573 745f 6c6f 6e67 5f73 6574 7570 2e79  est_long_setup.y
-0001ac10: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
-0001ac20: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001ac30: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
-0001ac40: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-0001ac50: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-0001ac60: 616d 653d 6627 7b6e 616d 657d 2d32 2729  ame=f'{name}-2')
-0001ac70: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001ac80: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
-0001ac90: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-0001aca0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-0001acb0: 7b6e 616d 657d 2d32 207c 2068 6561 6420  {name}-2 | head 
-0001acc0: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
-0001acd0: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
-0001ace0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-0001acf0: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
-0001ad00: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001ad10: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001ad20: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
-0001ad30: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001ad40: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-0001ad50: 2020 2020 2020 2020 2020 2866 2773 3d24            (f's=$
-0001ad60: 2861 7773 2065 6332 2064 6573 6372 6962  (aws ec2 describ
-0001ad70: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
-0001ad80: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
-0001ad90: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-0001ada0: 2d66 696c 7465 7273 204e 616d 653d 7461  -filters Name=ta
-0001adb0: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
-0001adc0: 6d65 2c56 616c 7565 733d 7b6e 616d 655f  me,Values={name_
-0001add0: 325f 6f6e 5f63 6c6f 7564 7d2d 2a20 270a  2_on_cloud}-* '.
-0001ade0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-0001adf0: 2d71 7565 7279 2052 6573 6572 7661 7469  -query Reservati
-0001ae00: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
-0001ae10: 5d2e 5374 6174 655b 5d2e 4e61 6d65 2027  ].State[].Name '
-0001ae20: 0a20 2020 2020 2020 2020 2020 2020 272d  .             '-
-0001ae30: 2d6f 7574 7075 7420 7465 7874 2920 2626  -output text) &&
-0001ae40: 2065 6368 6f20 2224 7322 2026 2620 6563   echo "$s" && ec
-0001ae50: 686f 3b20 5b5b 202d 7a20 2224 7322 205d  ho; [[ -z "$s" ]
-0001ae60: 5d20 7c7c 205b 5b20 2224 7322 203d 2022  ] || [[ "$s" = "
-0001ae70: 7465 726d 696e 6174 6564 2220 5d5d 207c  terminated" ]] |
-0001ae80: 7c20 5b5b 2022 2473 2220 3d20 2273 6875  | [[ "$s" = "shu
-0001ae90: 7474 696e 672d 646f 776e 2220 5d5d 270a  tting-down" ]]'.
-0001aea0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-0001aeb0: 2020 2020 2020 2020 2020 2023 2054 6573             # Tes
-0001aec0: 7420 6361 6e63 656c 6c61 7469 6f6e 2064  t cancellation d
-0001aed0: 7572 696e 6720 7370 6f74 206a 6f62 2069  uring spot job i
-0001aee0: 7320 7265 636f 7665 7269 6e67 2e0a 2020  s recovering..  
-0001aef0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001af00: 7370 6f74 206c 6175 6e63 6820 2d2d 636c  spot launch --cl
-0001af10: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
-0001af20: 207b 7265 6769 6f6e 7d20 2d6e 207b 6e61   {region} -n {na
-0001af30: 6d65 7d2d 3320 2273 6c65 6570 2031 3030  me}-3 "sleep 100
-0001af40: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-0001af50: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
-0001af60: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-0001af70: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-0001af80: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001af90: 657d 2d33 207c 2068 6561 6420 2d6e 3120  e}-3 | head -n1 
-0001afa0: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-0001afb0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0001afc0: 2054 6572 6d69 6e61 7465 2074 6865 2063   Terminate the c
-0001afd0: 6c75 7374 6572 206d 616e 7561 6c6c 792e  luster manually.
-0001afe0: 0a20 2020 2020 2020 2020 2020 2028 6627  .            (f'
-0001aff0: 6177 7320 6563 3220 7465 726d 696e 6174  aws ec2 terminat
-0001b000: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
-0001b010: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d2d  gion {region} --
-0001b020: 696e 7374 616e 6365 2d69 6473 2024 2827  instance-ids $('
-0001b030: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
-0001b040: 6177 7320 6563 3220 6465 7363 7269 6265  aws ec2 describe
-0001b050: 2d69 6e73 7461 6e63 6573 202d 2d72 6567  -instances --reg
-0001b060: 696f 6e20 7b72 6567 696f 6e7d 2027 0a20  ion {region} '. 
-0001b070: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-0001b080: 6669 6c74 6572 7320 4e61 6d65 3d74 6167  filters Name=tag
-0001b090: 3a72 6179 2d63 6c75 7374 6572 2d6e 616d  :ray-cluster-nam
-0001b0a0: 652c 5661 6c75 6573 3d7b 6e61 6d65 5f33  e,Values={name_3
-0001b0b0: 5f6f 6e5f 636c 6f75 647d 2d2a 2027 0a20  _on_cloud}-* '. 
-0001b0c0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-0001b0d0: 7175 6572 7920 5265 7365 7276 6174 696f  query Reservatio
-0001b0e0: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
-0001b0f0: 2e49 6e73 7461 6e63 6549 6420 270a 2020  .InstanceId '.  
-0001b100: 2020 2020 2020 2020 2020 2027 2d2d 6f75             '--ou
-0001b110: 7470 7574 2074 6578 7429 2729 2c0a 2020  tput text)'),.  
-0001b120: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001b130: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
-0001b140: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0001b150: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001b160: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
-0001b170: 3120 7c20 6772 6570 2022 5245 434f 5645  1 | grep "RECOVE
-0001b180: 5249 4e47 2227 2c0a 2020 2020 2020 2020  RING"',.        
-0001b190: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-0001b1a0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-0001b1b0: 5f6e 616d 653d 6627 7b6e 616d 657d 2d33  _name=f'{name}-3
-0001b1c0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-0001b1d0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0001b1e0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001b1f0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001b200: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
-0001b210: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-0001b220: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
-0001b230: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-0001b240: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
-0001b250: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001b260: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-0001b270: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0001b280: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001b290: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
-0001b2a0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-0001b2b0: 6520 636c 7573 7465 7220 7368 6f75 6c64  e cluster should
-0001b2c0: 2062 6520 7465 726d 696e 6174 6564 2028   be terminated (
-0001b2d0: 7368 7574 7469 6e67 2d64 6f77 6e29 2061  shutting-down) a
-0001b2e0: 6674 6572 2063 616e 6365 6c6c 6174 696f  fter cancellatio
-0001b2f0: 6e2e 2057 6520 646f 6e27 7420 7573 6520  n. We don't use 
-0001b300: 7468 6520 603d 6020 6f70 6572 6174 6f72  the `=` operator
-0001b310: 2068 6572 6520 6265 6361 7573 650a 2020   here because.  
-0001b320: 2020 2020 2020 2020 2020 2320 7468 6572            # ther
-0001b330: 6520 6361 6e20 6265 206d 756c 7469 706c  e can be multipl
-0001b340: 6520 564d 2077 6974 6820 7468 6520 7361  e VM with the sa
-0001b350: 6d65 206e 616d 6520 6475 6520 746f 2074  me name due to t
-0001b360: 6865 2072 6563 6f76 6572 792e 0a20 2020  he recovery..   
-0001b370: 2020 2020 2020 2020 2028 6627 733d 2428           (f's=$(
-0001b380: 6177 7320 6563 3220 6465 7363 7269 6265  aws ec2 describe
-0001b390: 2d69 6e73 7461 6e63 6573 202d 2d72 6567  -instances --reg
-0001b3a0: 696f 6e20 7b72 6567 696f 6e7d 2027 0a20  ion {region} '. 
-0001b3b0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-0001b3c0: 6669 6c74 6572 7320 4e61 6d65 3d74 6167  filters Name=tag
-0001b3d0: 3a72 6179 2d63 6c75 7374 6572 2d6e 616d  :ray-cluster-nam
-0001b3e0: 652c 5661 6c75 6573 3d7b 6e61 6d65 5f33  e,Values={name_3
-0001b3f0: 5f6f 6e5f 636c 6f75 647d 2d2a 2027 0a20  _on_cloud}-* '. 
-0001b400: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-0001b410: 7175 6572 7920 5265 7365 7276 6174 696f  query Reservatio
-0001b420: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
-0001b430: 2e53 7461 7465 5b5d 2e4e 616d 6520 270a  .State[].Name '.
-0001b440: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
-0001b450: 6f75 7470 7574 2074 6578 7429 2026 2620  output text) && 
-0001b460: 6563 686f 2022 2473 2220 2626 2065 6368  echo "$s" && ech
-0001b470: 6f3b 205b 5b20 2d7a 2022 2473 2220 5d5d  o; [[ -z "$s" ]]
-0001b480: 207c 7c20 6563 686f 2022 2473 2220 7c20   || echo "$s" | 
-0001b490: 6772 6570 202d 7620 2d45 2022 7065 6e64  grep -v -E "pend
-0001b4a0: 696e 677c 7275 6e6e 696e 677c 7374 6f70  ing|running|stop
-0001b4b0: 7065 647c 7374 6f70 7069 6e67 2227 0a20  ped|stopping"'. 
-0001b4c0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0001b4d0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001b4e0: 2074 696d 656f 7574 3d32 3520 2a20 3630   timeout=25 * 60
-0001b4f0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001b500: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0001b510: 7374 2e6d 6172 6b2e 6763 700a 4070 7974  st.mark.gcp.@pyt
-0001b520: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-0001b530: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-0001b540: 706f 745f 6361 6e63 656c 6c61 7469 6f6e  pot_cancellation
-0001b550: 5f67 6370 2829 3a0a 2020 2020 6e61 6d65  _gcp():.    name
-0001b560: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0001b570: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
-0001b580: 3320 3d20 6627 7b6e 616d 657d 2d33 270a  3 = f'{name}-3'.
-0001b590: 2020 2020 6e61 6d65 5f33 5f6f 6e5f 636c      name_3_on_cl
-0001b5a0: 6f75 6420 3d20 636f 6d6d 6f6e 5f75 7469  oud = common_uti
-0001b5b0: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
-0001b5c0: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 0a20  name_on_cloud(. 
-0001b5d0: 2020 2020 2020 206e 616d 655f 332c 2073         name_3, s
-0001b5e0: 706f 742e 5350 4f54 5f43 4c55 5354 4552  pot.SPOT_CLUSTER
-0001b5f0: 5f4e 414d 455f 5052 4546 4958 5f4c 454e  _NAME_PREFIX_LEN
-0001b600: 4754 482c 2061 6464 5f75 7365 725f 6861  GTH, add_user_ha
-0001b610: 7368 3d46 616c 7365 290a 2020 2020 7a6f  sh=False).    zo
-0001b620: 6e65 203d 2027 7573 2d77 6573 7433 2d62  ne = 'us-west3-b
-0001b630: 270a 2020 2020 7175 6572 795f 7374 6174  '.    query_stat
-0001b640: 655f 636d 6420 3d20 280a 2020 2020 2020  e_cmd = (.      
-0001b650: 2020 2767 636c 6f75 6420 636f 6d70 7574    'gcloud comput
-0001b660: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
-0001b670: 2027 0a20 2020 2020 2020 2066 272d 2d66   '.        f'--f
-0001b680: 696c 7465 723d 2228 6c61 6265 6c73 2e72  ilter="(labels.r
-0001b690: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
-0001b6a0: 7b6e 616d 655f 335f 6f6e 5f63 6c6f 7564  {name_3_on_cloud
-0001b6b0: 7d29 2220 270a 2020 2020 2020 2020 272d  })" '.        '-
-0001b6c0: 2d66 6f72 6d61 743d 2276 616c 7565 2873  -format="value(s
-0001b6d0: 7461 7475 7329 2227 290a 2020 2020 7175  tatus)"').    qu
-0001b6e0: 6572 795f 636d 6420 3d20 2866 2767 636c  ery_cmd = (f'gcl
-0001b6f0: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
-0001b700: 616e 6365 7320 6c69 7374 202d 2d66 696c  ances list --fil
-0001b710: 7465 723d 270a 2020 2020 2020 2020 2020  ter='.          
-0001b720: 2020 2020 2020 2066 2722 286c 6162 656c         f'"(label
-0001b730: 732e 7261 792d 636c 7573 7465 722d 6e61  s.ray-cluster-na
-0001b740: 6d65 3a7b 6e61 6d65 5f33 5f6f 6e5f 636c  me:{name_3_on_cl
-0001b750: 6f75 647d 2922 2027 0a20 2020 2020 2020  oud})" '.       
-0001b760: 2020 2020 2020 2020 2020 6627 2d2d 7a6f            f'--zo
-0001b770: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
-0001b780: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
-0001b790: 2227 290a 2020 2020 7465 726d 696e 6174  "').    terminat
-0001b7a0: 655f 636d 6420 3d20 2866 2767 636c 6f75  e_cmd = (f'gclou
-0001b7b0: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
-0001b7c0: 6365 7320 6465 6c65 7465 202d 2d7a 6f6e  ces delete --zon
-0001b7d0: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
-0001b7e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001b7f0: 2720 2d2d 7175 6965 7420 2428 7b71 7565  ' --quiet $({que
-0001b800: 7279 5f63 6d64 7d29 2729 0a20 2020 2074  ry_cmd})').    t
-0001b810: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0001b820: 2020 2020 2773 706f 745f 6361 6e63 656c      'spot_cancel
-0001b830: 6c61 7469 6f6e 5f67 6370 272c 0a20 2020  lation_gcp',.   
-0001b840: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001b850: 2020 2023 2054 6573 7420 6361 6e63 656c     # Test cancel
-0001b860: 6c61 7469 6f6e 2064 7572 696e 6720 7370  lation during sp
-0001b870: 6f74 2063 6c75 7374 6572 2062 6569 6e67  ot cluster being
-0001b880: 206c 6175 6e63 6865 642e 0a20 2020 2020   launched..     
-0001b890: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
-0001b8a0: 7420 6c61 756e 6368 202d 2d63 6c6f 7564  t launch --cloud
-0001b8b0: 2067 6370 202d 2d7a 6f6e 6520 7b7a 6f6e   gcp --zone {zon
-0001b8c0: 657d 202d 6e20 7b6e 616d 657d 2022 736c  e} -n {name} "sl
-0001b8d0: 6565 7020 3130 3030 2220 202d 7920 2d64  eep 1000"  -y -d
-0001b8e0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0001b8f0: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
-0001b900: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001b910: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001b920: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-0001b930: 2d6e 3120 7c20 6772 6570 2022 5354 4152  -n1 | grep "STAR
-0001b940: 5449 4e47 2227 2c0a 2020 2020 2020 2020  TING"',.        
-0001b950: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-0001b960: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-0001b970: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
-0001b980: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001b990: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-0001b9a0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-0001b9b0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0001b9c0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-0001b9d0: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
-0001b9e0: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
-0001b9f0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001ba00: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
-0001ba10: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0001ba20: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001ba30: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-0001ba40: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
-0001ba50: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-0001ba60: 2023 2054 6573 7420 6361 6e63 656c 6c69   # Test cancelli
-0001ba70: 6e67 2074 6865 2073 706f 7420 636c 7573  ng the spot clus
-0001ba80: 7465 7220 6475 7269 6e67 2073 706f 7420  ter during spot 
-0001ba90: 6a6f 6220 6265 696e 6720 7365 7475 702e  job being setup.
-0001baa0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001bab0: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-0001bac0: 2d63 6c6f 7564 2067 6370 202d 2d7a 6f6e  -cloud gcp --zon
-0001bad0: 6520 7b7a 6f6e 657d 202d 6e20 7b6e 616d  e {zone} -n {nam
-0001bae0: 657d 2d32 2074 6573 7473 2f74 6573 745f  e}-2 tests/test_
-0001baf0: 7961 6d6c 732f 7465 7374 5f6c 6f6e 675f  yamls/test_long_
-0001bb00: 7365 7475 702e 7961 6d6c 2020 2d79 202d  setup.yaml  -y -
-0001bb10: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-0001bb20: 2773 6c65 6570 2033 3030 272c 0a20 2020  'sleep 300',.   
-0001bb30: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
-0001bb40: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-0001bb50: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
-0001bb60: 6d65 7d2d 3227 292c 0a20 2020 2020 2020  me}-2'),.       
-0001bb70: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
-0001bb80: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001bb90: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-0001bba0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
-0001bbb0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001bbc0: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
-0001bbd0: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-0001bbe0: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-0001bbf0: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-0001bc00: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-0001bc10: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001bc20: 657d 2d32 207c 2068 6561 6420 2d6e 3120  e}-2 | head -n1 
-0001bc30: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
-0001bc40: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-0001bc50: 2023 2054 6573 7420 6361 6e63 656c 6c61   # Test cancella
-0001bc60: 7469 6f6e 2064 7572 696e 6720 7370 6f74  tion during spot
-0001bc70: 206a 6f62 2069 7320 7265 636f 7665 7269   job is recoveri
-0001bc80: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-0001bc90: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-0001bca0: 6820 2d2d 636c 6f75 6420 6763 7020 2d2d  h --cloud gcp --
-0001bcb0: 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e 207b  zone {zone} -n {
-0001bcc0: 6e61 6d65 7d2d 3320 2273 6c65 6570 2031  name}-3 "sleep 1
-0001bcd0: 3030 3022 2020 2d79 202d 6427 2c0a 2020  000"  -y -d',.  
-0001bce0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001bcf0: 2033 3030 272c 0a20 2020 2020 2020 2020   300',.         
-0001bd00: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0001bd10: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001bd20: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
-0001bd30: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-0001bd40: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-0001bd50: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
-0001bd60: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
-0001bd70: 792e 0a20 2020 2020 2020 2020 2020 2074  y..            t
-0001bd80: 6572 6d69 6e61 7465 5f63 6d64 2c0a 2020  erminate_cmd,.  
-0001bd90: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001bda0: 2038 3027 2c0a 2020 2020 2020 2020 2020   80',.          
-0001bdb0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-0001bdc0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001bdd0: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
-0001bde0: 207c 2067 7265 7020 2252 4543 4f56 4552   | grep "RECOVER
-0001bdf0: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-0001be00: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-0001be10: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-0001be20: 6e61 6d65 3d66 277b 6e61 6d65 7d2d 3327  name=f'{name}-3'
-0001be30: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
-0001be40: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
-0001be50: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0001be60: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001be70: 207b 6e61 6d65 7d2d 3320 7c20 6865 6164   {name}-3 | head
-0001be80: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
-0001be90: 4345 4c4c 494e 475c 7c43 414e 4345 4c4c  CELLING\|CANCELL
-0001bea0: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-0001beb0: 2020 2773 6c65 6570 2031 3230 272c 0a20    'sleep 120',. 
-0001bec0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0001bed0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0001bee0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-0001bef0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001bf00: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
-0001bf10: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-0001bf20: 2063 6c75 7374 6572 2073 686f 756c 6420   cluster should 
-0001bf30: 6265 2074 6572 6d69 6e61 7465 6420 2853  be terminated (S
-0001bf40: 544f 5050 494e 4729 2061 6674 6572 2063  TOPPING) after c
-0001bf50: 616e 6365 6c6c 6174 696f 6e2e 2057 6520  ancellation. We 
-0001bf60: 646f 6e27 7420 7573 6520 7468 6520 603d  don't use the `=
-0001bf70: 6020 6f70 6572 6174 6f72 2068 6572 6520  ` operator here 
-0001bf80: 6265 6361 7573 650a 2020 2020 2020 2020  because.        
-0001bf90: 2020 2020 2320 7468 6572 6520 6361 6e20      # there can 
-0001bfa0: 6265 206d 756c 7469 706c 6520 564d 2077  be multiple VM w
-0001bfb0: 6974 6820 7468 6520 7361 6d65 206e 616d  ith the same nam
-0001bfc0: 6520 6475 6520 746f 2074 6865 2072 6563  e due to the rec
-0001bfd0: 6f76 6572 792e 0a20 2020 2020 2020 2020  overy..         
-0001bfe0: 2020 2028 6627 733d 2428 7b71 7565 7279     (f's=$({query
-0001bff0: 5f73 7461 7465 5f63 6d64 7d29 2026 2620  _state_cmd}) && 
-0001c000: 6563 686f 2022 2473 2220 2626 2065 6368  echo "$s" && ech
-0001c010: 6f3b 205b 5b20 2d7a 2022 2473 2220 5d5d  o; [[ -z "$s" ]]
-0001c020: 207c 7c20 6563 686f 2022 2473 2220 7c20   || echo "$s" | 
-0001c030: 6772 6570 202d 7620 2d45 2022 5052 4f56  grep -v -E "PROV
-0001c040: 4953 494f 4e49 4e47 7c53 5441 4749 4e47  ISIONING|STAGING
-0001c050: 7c52 554e 4e49 4e47 7c52 4550 4149 5249  |RUNNING|REPAIRI
-0001c060: 4e47 7c54 4552 4d49 4e41 5445 447c 5355  NG|TERMINATED|SU
-0001c070: 5350 454e 4449 4e47 7c53 5553 5045 4e44  SPENDING|SUSPEND
-0001c080: 4544 7c53 5553 5045 4e44 4544 2227 0a20  ED|SUSPENDED"'. 
-0001c090: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0001c0a0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001c0b0: 2074 696d 656f 7574 3d32 3520 2a20 3630   timeout=25 * 60
-0001c0c0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001c0d0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0001c0e0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-0001c0f0: 7374 6f72 6167 6520 666f 7220 6d61 6e61  storage for mana
-0001c100: 6765 6420 7370 6f74 202d 2d2d 2d2d 2d2d  ged spot -------
-0001c110: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-0001c120: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-0001c130: 2320 466c 7569 6473 7461 636b 2064 6f65  # Fluidstack doe
-0001c140: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-0001c150: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-0001c160: 7465 7374 2e6d 6172 6b2e 6e6f 5f61 7a75  test.mark.no_azu
-0001c170: 7265 2020 2320 417a 7572 6520 646f 6573  re  # Azure does
-0001c180: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-0001c190: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-0001c1a0: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-0001c1b0: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
-0001c1c0: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
-0001c1d0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-0001c1e0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-0001c1f0: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
-0001c200: 4942 4d20 436c 6f75 6420 646f 6573 206e  IBM Cloud does n
-0001c210: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-0001c220: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-0001c230: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
-0001c240: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
-0001c250: 6365 2064 6f65 7320 6e6f 7420 7375 7070  ce does not supp
-0001c260: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-0001c270: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001c280: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-0001c290: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-0001c2a0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001c2b0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
-0001c2c0: 6265 726e 6574 6573 2020 2320 4b75 6265  bernetes  # Kube
-0001c2d0: 726e 6574 6573 2064 6f65 7320 6e6f 7420  rnetes does not 
-0001c2e0: 6861 7665 2061 206e 6f74 696f 6e20 6f66  have a notion of
-0001c2f0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-0001c300: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
-0001c310: 6167 6564 5f73 706f 740a 6465 6620 7465  aged_spot.def te
-0001c320: 7374 5f73 706f 745f 7374 6f72 6167 6528  st_spot_storage(
-0001c330: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0001c340: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-0001c350: 2073 746f 7261 6765 2077 6974 6820 6d61   storage with ma
-0001c360: 6e61 6765 6420 7370 6f74 2222 220a 2020  naged spot""".  
-0001c370: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001c380: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001c390: 2079 616d 6c5f 7374 7220 3d20 7061 7468   yaml_str = path
-0001c3a0: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
-0001c3b0: 2020 2765 7861 6d70 6c65 732f 6d61 6e61    'examples/mana
-0001c3c0: 6765 645f 7370 6f74 5f77 6974 685f 7374  ged_spot_with_st
-0001c3d0: 6f72 6167 652e 7961 6d6c 2729 2e72 6561  orage.yaml').rea
-0001c3e0: 645f 7465 7874 2829 0a20 2020 2073 746f  d_text().    sto
-0001c3f0: 7261 6765 5f6e 616d 6520 3d20 6627 736b  rage_name = f'sk
-0001c400: 792d 7465 7374 2d7b 696e 7428 7469 6d65  y-test-{int(time
-0001c410: 2e74 696d 6528 2929 7d27 0a0a 2020 2020  .time())}'..    
-0001c420: 2320 416c 736f 2070 6572 666f 726d 2072  # Also perform r
-0001c430: 6567 696f 6e20 7465 7374 696e 6720 666f  egion testing fo
-0001c440: 7220 6275 636b 6574 2063 7265 6174 696f  r bucket creatio
-0001c450: 6e20 746f 2076 616c 6964 6174 6520 6966  n to validate if
-0001c460: 2062 7563 6b65 7473 2061 7265 0a20 2020   buckets are.   
-0001c470: 2023 2063 7265 6174 6564 2069 6e20 7468   # created in th
-0001c480: 6520 636f 7272 6563 7420 7265 6769 6f6e  e correct region
-0001c490: 2061 6e64 2063 6f72 7265 6374 6c79 206d   and correctly m
-0001c4a0: 6f75 6e74 6564 2069 6e20 7370 6f74 206a  ounted in spot j
-0001c4b0: 6f62 732e 0a20 2020 2023 2048 6f77 6576  obs..    # Howev
-0001c4c0: 6572 2c20 7765 2069 6e6a 6563 7420 7468  er, we inject th
-0001c4d0: 6973 2074 6573 7469 6e67 206f 6e6c 7920  is testing only 
-0001c4e0: 666f 7220 4157 5320 616e 6420 4743 5020  for AWS and GCP 
-0001c4f0: 7369 6e63 6520 7468 6579 2061 7265 2074  since they are t
-0001c500: 6865 0a20 2020 2023 2073 7570 706f 7274  he.    # support
-0001c510: 6564 206f 626a 6563 7420 7374 6f72 6167  ed object storag
-0001c520: 6520 7072 6f76 6964 6572 7320 696e 2053  e providers in S
-0001c530: 6b79 5069 6c6f 742e 0a20 2020 2072 6567  kyPilot..    reg
-0001c540: 696f 6e5f 666c 6167 203d 2027 270a 2020  ion_flag = ''.  
-0001c550: 2020 7265 6769 6f6e 5f76 616c 6964 6174    region_validat
-0001c560: 696f 6e5f 636d 6420 3d20 2774 7275 6527  ion_cmd = 'true'
-0001c570: 0a20 2020 2069 6620 6765 6e65 7269 635f  .    if generic_
-0001c580: 636c 6f75 6420 3d3d 2027 6177 7327 3a0a  cloud == 'aws':.
-0001c590: 2020 2020 2020 2020 7265 6769 6f6e 203d          region =
-0001c5a0: 2027 6575 2d63 656e 7472 616c 2d31 270a   'eu-central-1'.
-0001c5b0: 2020 2020 2020 2020 7265 6769 6f6e 5f66          region_f
-0001c5c0: 6c61 6720 3d20 6627 202d 2d72 6567 696f  lag = f' --regio
-0001c5d0: 6e20 7b72 6567 696f 6e7d 270a 2020 2020  n {region}'.    
-0001c5e0: 2020 2020 7265 6769 6f6e 5f63 6d64 203d      region_cmd =
-0001c5f0: 2054 6573 7453 746f 7261 6765 5769 7468   TestStorageWith
-0001c600: 4372 6564 656e 7469 616c 732e 636c 695f  Credentials.cli_
-0001c610: 7265 6769 6f6e 5f63 6d64 280a 2020 2020  region_cmd(.    
-0001c620: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0001c630: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0001c640: 2c20 7374 6f72 6167 655f 6e61 6d65 290a  , storage_name).
-0001c650: 2020 2020 2020 2020 7265 6769 6f6e 5f76          region_v
-0001c660: 616c 6964 6174 696f 6e5f 636d 6420 3d20  alidation_cmd = 
-0001c670: 6627 7b72 6567 696f 6e5f 636d 647d 207c  f'{region_cmd} |
-0001c680: 2067 7265 7020 7b72 6567 696f 6e7d 270a   grep {region}'.
-0001c690: 2020 2020 656c 6966 2067 656e 6572 6963      elif generic
-0001c6a0: 5f63 6c6f 7564 203d 3d20 2767 6370 273a  _cloud == 'gcp':
-0001c6b0: 0a20 2020 2020 2020 2072 6567 696f 6e20  .        region 
-0001c6c0: 3d20 2775 732d 7765 7374 3227 0a20 2020  = 'us-west2'.   
-0001c6d0: 2020 2020 2072 6567 696f 6e5f 666c 6167       region_flag
-0001c6e0: 203d 2066 2720 2d2d 7265 6769 6f6e 207b   = f' --region {
-0001c6f0: 7265 6769 6f6e 7d27 0a20 2020 2020 2020  region}'.       
-0001c700: 2072 6567 696f 6e5f 636d 6420 3d20 5465   region_cmd = Te
-0001c710: 7374 5374 6f72 6167 6557 6974 6843 7265  stStorageWithCre
-0001c720: 6465 6e74 6961 6c73 2e63 6c69 5f72 6567  dentials.cli_reg
-0001c730: 696f 6e5f 636d 6428 0a20 2020 2020 2020  ion_cmd(.       
-0001c740: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
-0001c750: 2e53 746f 7265 5479 7065 2e47 4353 2c20  .StoreType.GCS, 
-0001c760: 7374 6f72 6167 655f 6e61 6d65 290a 2020  storage_name).  
-0001c770: 2020 2020 2020 7265 6769 6f6e 5f76 616c        region_val
-0001c780: 6964 6174 696f 6e5f 636d 6420 3d20 6627  idation_cmd = f'
-0001c790: 7b72 6567 696f 6e5f 636d 647d 207c 2067  {region_cmd} | g
-0001c7a0: 7265 7020 7b72 6567 696f 6e7d 270a 0a20  rep {region}'.. 
-0001c7b0: 2020 2079 616d 6c5f 7374 7220 3d20 7961     yaml_str = ya
-0001c7c0: 6d6c 5f73 7472 2e72 6570 6c61 6365 2827  ml_str.replace('
-0001c7d0: 736b 792d 776f 726b 6469 722d 7a68 7775  sky-workdir-zhwu
-0001c7e0: 272c 2073 746f 7261 6765 5f6e 616d 6529  ', storage_name)
-0001c7f0: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
-0001c800: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
-0001c810: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
-0001c820: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
-0001c830: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
-0001c840: 7772 6974 6528 7961 6d6c 5f73 7472 290a  write(yaml_str).
-0001c850: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
-0001c860: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
-0001c870: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
-0001c880: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
-0001c890: 280a 2020 2020 2020 2020 2020 2020 2773  (.            's
-0001c8a0: 706f 745f 7374 6f72 6167 6527 2c0a 2020  pot_storage',.  
-0001c8b0: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
-0001c8c0: 2020 2020 2020 2020 2020 2020 2a73 746f              *sto
-0001c8d0: 7261 6765 5f73 6574 7570 5f63 6f6d 6d61  rage_setup_comma
-0001c8e0: 6e64 732c 0a20 2020 2020 2020 2020 2020  nds,.           
-0001c8f0: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-0001c900: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
-0001c910: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-0001c920: 635f 636c 6f75 647d 7b72 6567 696f 6e5f  c_cloud}{region_
-0001c930: 666c 6167 7d20 7b66 696c 655f 7061 7468  flag} {file_path
-0001c940: 7d20 2d79 272c 0a20 2020 2020 2020 2020  } -y',.         
-0001c950: 2020 2020 2020 2072 6567 696f 6e5f 7661         region_va
-0001c960: 6c69 6461 7469 6f6e 5f63 6d64 2c20 2023  lidation_cmd,  #
-0001c970: 2043 6865 636b 2069 6620 7468 6520 6275   Check if the bu
-0001c980: 636b 6574 2069 7320 6372 6561 7465 6420  cket is created 
-0001c990: 696e 2074 6865 2063 6f72 7265 6374 2072  in the correct r
-0001c9a0: 6567 696f 6e0a 2020 2020 2020 2020 2020  egion.          
-0001c9b0: 2020 2020 2020 2773 6c65 6570 2036 3027        'sleep 60'
-0001c9c0: 2c20 2023 2057 6169 7420 7468 6520 7370  ,  # Wait the sp
-0001c9d0: 6f74 2071 7565 7565 2074 6f20 6265 2075  ot queue to be u
-0001c9e0: 7064 6174 6564 0a20 2020 2020 2020 2020  pdated.         
-0001c9f0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001ca00: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001ca10: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-0001ca20: 5355 4343 4545 4445 4427 2c0a 2020 2020  SUCCEEDED',.    
-0001ca30: 2020 2020 2020 2020 2020 2020 6627 5b20              f'[ 
-0001ca40: 2428 6177 7320 7333 6170 6920 6c69 7374  $(aws s3api list
-0001ca50: 2d62 7563 6b65 7473 202d 2d71 7565 7279  -buckets --query
-0001ca60: 2022 4275 636b 6574 735b 3f63 6f6e 7461   "Buckets[?conta
-0001ca70: 696e 7328 4e61 6d65 2c20 5c27 7b73 746f  ins(Name, \'{sto
-0001ca80: 7261 6765 5f6e 616d 657d 5c27 295d 2e4e  rage_name}\')].N
-0001ca90: 616d 6522 202d 2d6f 7574 7075 7420 7465  ame" --output te
-0001caa0: 7874 207c 2077 6320 2d6c 2920 2d65 7120  xt | wc -l) -eq 
-0001cab0: 3020 5d27 0a20 2020 2020 2020 2020 2020  0 ]'.           
-0001cac0: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-0001cad0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-0001cae0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0001caf0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-0001cb00: 2020 2020 2023 2049 6e63 7265 6173 6520       # Increase 
-0001cb10: 7469 6d65 6f75 7420 7369 6e63 6520 736b  timeout since sk
-0001cb20: 7920 7370 6f74 2071 7565 7565 202d 7220  y spot queue -r 
-0001cb30: 6361 6e20 6265 2062 6c6f 636b 6564 2062  can be blocked b
-0001cb40: 7920 6f74 6865 7220 7370 6f74 2074 6573  y other spot tes
-0001cb50: 7473 2e0a 2020 2020 2020 2020 2020 2020  ts..            
-0001cb60: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-0001cb70: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001cb80: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001cb90: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0001cba0: 2d2d 2d2d 2054 6573 7469 6e67 2073 706f  ---- Testing spo
-0001cbb0: 7420 5450 5520 2d2d 2d2d 2d2d 2d2d 2d2d  t TPU ----------
-0001cbc0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-0001cbd0: 700a 4070 7974 6573 742e 6d61 726b 2e6d  p.@pytest.mark.m
-0001cbe0: 616e 6167 6564 5f73 706f 740a 4070 7974  anaged_spot.@pyt
-0001cbf0: 6573 742e 6d61 726b 2e74 7075 0a64 6566  est.mark.tpu.def
-0001cc00: 2074 6573 745f 7370 6f74 5f74 7075 2829   test_spot_tpu()
-0001cc10: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-0001cc20: 6e61 6765 6420 7370 6f74 206f 6e20 5450  naged spot on TP
-0001cc30: 552e 2222 220a 2020 2020 6e61 6d65 203d  U.""".    name =
-0001cc40: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0001cc50: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0001cc60: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
-0001cc70: 6573 742d 7370 6f74 2d74 7075 272c 0a20  est-spot-tpu',. 
-0001cc80: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001cc90: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-0001cca0: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
-0001ccb0: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
-0001ccc0: 7576 6d5f 6d6e 6973 742e 7961 6d6c 202d  uvm_mnist.yaml -
-0001ccd0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-0001cce0: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-0001ccf0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001cd00: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001cd10: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-0001cd20: 6164 202d 6e31 207c 2067 7265 7020 5354  ad -n1 | grep ST
-0001cd30: 4152 5449 4e47 272c 0a20 2020 2020 2020  ARTING',.       
-0001cd40: 2020 2020 2027 736c 6565 7020 3834 3027       'sleep 840'
-0001cd50: 2c20 2023 2054 5055 2074 616b 6573 2061  ,  # TPU takes a
-0001cd60: 2077 6869 6c65 2074 6f20 6c61 756e 6368   while to launch
-0001cd70: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0001cd80: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0001cd90: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001cda0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001cdb0: 2022 5255 4e4e 494e 475c 7c53 5543 4345   "RUNNING\|SUCCE
-0001cdc0: 4544 4544 2227 2c0a 2020 2020 2020 2020  EDED"',.        
-0001cdd0: 5d2c 0a20 2020 2020 2020 205f 5350 4f54  ],.        _SPOT
-0001cde0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-0001cdf0: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
-0001ce00: 6529 2c0a 2020 2020 2020 2020 2320 496e  e),.        # In
-0001ce10: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
-0001ce20: 696e 6365 2073 6b79 2073 706f 7420 7175  ince sky spot qu
-0001ce30: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
-0001ce40: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
-0001ce50: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
-0001ce60: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-0001ce70: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-0001ce80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0001ce90: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-0001cea0: 5465 7374 696e 6720 656e 7620 666f 7220  Testing env for 
-0001ceb0: 7370 6f74 202d 2d2d 2d2d 2d2d 2d2d 2d0a  spot ----------.
-0001cec0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0001ced0: 666c 7569 6473 7461 636b 2020 2320 466c  fluidstack  # Fl
-0001cee0: 7569 6473 7461 636b 2064 6f65 7320 6e6f  uidstack does no
-0001cef0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-0001cf00: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-0001cf10: 2e6d 6172 6b2e 6e6f 5f61 7a75 7265 2020  .mark.no_azure  
-0001cf20: 2320 417a 7572 6520 646f 6573 206e 6f74  # Azure does not
-0001cf30: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-0001cf40: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-0001cf50: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-0001cf60: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-0001cf70: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-0001cf80: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-0001cf90: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-0001cfa0: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-0001cfb0: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-0001cfc0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-0001cfd0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-0001cfe0: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-0001cff0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0001d000: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-0001d010: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0001d020: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-0001d030: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
-0001d040: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-0001d050: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-0001d060: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-0001d070: 6574 6573 2020 2320 4b75 6265 726e 6574  etes  # Kubernet
-0001d080: 6573 2064 6f65 7320 6e6f 7420 6861 7665  es does not have
-0001d090: 2061 206e 6f74 696f 6e20 6f66 2073 706f   a notion of spo
-0001d0a0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-0001d0b0: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-0001d0c0: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-0001d0d0: 706f 745f 696e 6c69 6e65 5f65 6e76 2867  pot_inline_env(g
-0001d0e0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-0001d0f0: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
-0001d100: 7370 6f74 2065 6e76 2222 220a 2020 2020  spot env""".    
-0001d110: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0001d120: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0001d130: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0001d140: 2020 2020 2774 6573 742d 7370 6f74 2d69      'test-spot-i
-0001d150: 6e6c 696e 652d 656e 7627 2c0a 2020 2020  nline-env',.    
-0001d160: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001d170: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-0001d180: 6e63 6820 2d6e 207b 6e61 6d65 7d20 2d79  nch -n {name} -y
-0001d190: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-0001d1a0: 635f 636c 6f75 647d 202d 2d65 6e76 2054  c_cloud} --env T
-0001d1b0: 4553 545f 454e 563d 2268 656c 6c6f 2077  EST_ENV="hello w
-0001d1c0: 6f72 6c64 2220 2d2d 2022 285b 5b20 2120  orld" -- "([[ ! 
-0001d1d0: 2d7a 205c 5c22 5c24 5445 5354 5f45 4e56  -z \\"\$TEST_ENV
-0001d1e0: 5c5c 2220 5d5d 2026 2620 5b5b 2021 202d  \\" ]] && [[ ! -
-0001d1f0: 7a20 5c5c 225c 2453 4b59 5049 4c4f 545f  z \\"\$SKYPILOT_
-0001d200: 4e4f 4445 5f49 5053 5c5c 2220 5d5d 2026  NODE_IPS\\" ]] &
-0001d210: 2620 5b5b 2021 202d 7a20 5c5c 225c 2453  & [[ ! -z \\"\$S
-0001d220: 4b59 5049 4c4f 545f 4e4f 4445 5f52 414e  KYPILOT_NODE_RAN
-0001d230: 4b5c 5c22 205d 5d29 207c 7c20 6578 6974  K\\" ]]) || exit
-0001d240: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
-0001d250: 2020 2773 6c65 6570 2032 3027 2c0a 2020    'sleep 20',.  
-0001d260: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001d270: 4f54 5f51 5545 5545 5f57 4149 547d 207c  OT_QUEUE_WAIT} |
-0001d280: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-0001d290: 7265 7020 5355 4343 4545 4445 4427 2c0a  rep SUCCEEDED',.
-0001d2a0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0001d2b0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-0001d2c0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-0001d2d0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-0001d2e0: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
-0001d2f0: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
-0001d300: 2073 706f 7420 7175 6575 6520 2d72 2063   spot queue -r c
-0001d310: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
-0001d320: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
-0001d330: 732e 0a20 2020 2020 2020 2074 696d 656f  s..        timeo
-0001d340: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
-0001d350: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001d360: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0001d370: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-0001d380: 656e 7620 2d2d 2d2d 2d2d 2d2d 2d2d 0a64  env ----------.d
-0001d390: 6566 2074 6573 745f 696e 6c69 6e65 5f65  ef test_inline_e
-0001d3a0: 6e76 2867 656e 6572 6963 5f63 6c6f 7564  nv(generic_cloud
-0001d3b0: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
-0001d3c0: 6573 7420 656e 7622 2222 0a20 2020 206e  est env""".    n
-0001d3d0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0001d3e0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-0001d3f0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0001d400: 2020 2027 7465 7374 2d69 6e6c 696e 652d     'test-inline-
-0001d410: 656e 7627 2c0a 2020 2020 2020 2020 5b0a  env',.        [.
-0001d420: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001d430: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
-0001d440: 657d 202d 7920 2d2d 636c 6f75 6420 7b67  e} -y --cloud {g
-0001d450: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
-0001d460: 656e 7620 5445 5354 5f45 4e56 3d22 6865  env TEST_ENV="he
-0001d470: 6c6c 6f20 776f 726c 6422 202d 2d20 2228  llo world" -- "(
-0001d480: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
-0001d490: 545f 454e 565c 5c22 205d 5d20 2626 205b  T_ENV\\" ]] && [
-0001d4a0: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-0001d4b0: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
-0001d4c0: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-0001d4d0: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-0001d4e0: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
-0001d4f0: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0001d500: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
-0001d510: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001d520: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0001d530: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-0001d540: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001d550: 6578 6563 207b 6e61 6d65 7d20 2d2d 656e  exec {name} --en
-0001d560: 7620 5445 5354 5f45 4e56 323d 2273 7563  v TEST_ENV2="suc
-0001d570: 6365 7373 2220 2228 5b5b 2021 202d 7a20  cess" "([[ ! -z 
-0001d580: 5c5c 225c 2454 4553 545f 454e 5632 5c5c  \\"\$TEST_ENV2\\
-0001d590: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
-0001d5a0: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
-0001d5b0: 4445 5f49 5053 5c5c 2220 5d5d 2026 2620  DE_IPS\\" ]] && 
-0001d5c0: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
-0001d5d0: 5049 4c4f 545f 4e4f 4445 5f52 414e 4b5c  PILOT_NODE_RANK\
-0001d5e0: 5c22 205d 5d29 207c 7c20 6578 6974 2031  \" ]]) || exit 1
-0001d5f0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001d600: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0001d610: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
-0001d620: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0001d630: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0001d640: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-0001d650: 205f 6765 745f 7469 6d65 6f75 7428 6765   _get_timeout(ge
-0001d660: 6e65 7269 635f 636c 6f75 6429 2c0a 2020  neric_cloud),.  
-0001d670: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0001d680: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-0001d690: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
-0001d6a0: 6720 656e 7620 6669 6c65 202d 2d2d 2d2d  g env file -----
-0001d6b0: 2d2d 2d2d 2d0a 6465 6620 7465 7374 5f69  -----.def test_i
-0001d6c0: 6e6c 696e 655f 656e 765f 6669 6c65 2867  nline_env_file(g
-0001d6d0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-0001d6e0: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
-0001d6f0: 656e 7622 2222 0a20 2020 206e 616d 6520  env""".    name 
-0001d700: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001d710: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0001d720: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0001d730: 7465 7374 2d69 6e6c 696e 652d 656e 762d  test-inline-env-
-0001d740: 6669 6c65 272c 0a20 2020 2020 2020 205b  file',.        [
-0001d750: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001d760: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-0001d770: 6d65 7d20 2d79 202d 2d63 6c6f 7564 207b  me} -y --cloud {
-0001d780: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-0001d790: 2d65 6e76 2054 4553 545f 454e 563d 2268  -env TEST_ENV="h
-0001d7a0: 656c 6c6f 2077 6f72 6c64 2220 2d2d 2022  ello world" -- "
-0001d7b0: 285b 5b20 2120 2d7a 205c 5c22 5c24 5445  ([[ ! -z \\"\$TE
-0001d7c0: 5354 5f45 4e56 5c5c 2220 5d5d 2026 2620  ST_ENV\\" ]] && 
-0001d7d0: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
-0001d7e0: 5049 4c4f 545f 4e4f 4445 5f49 5053 5c5c  PILOT_NODE_IPS\\
-0001d7f0: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
-0001d800: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
-0001d810: 4445 5f52 414e 4b5c 5c22 205d 5d29 207c  DE_RANK\\" ]]) |
-0001d820: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0001d830: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0001d840: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-0001d850: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-0001d860: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0001d870: 616d 657d 202d 2d65 6e76 2d66 696c 6520  ame} --env-file 
-0001d880: 6578 616d 706c 6573 2f73 616d 706c 655f  examples/sample_
-0001d890: 646f 7465 6e76 2022 285b 5b20 2120 2d7a  dotenv "([[ ! -z
-0001d8a0: 205c 5c22 5c24 5445 5354 5f45 4e56 325c   \\"\$TEST_ENV2\
-0001d8b0: 5c22 205d 5d20 2626 205b 5b20 2120 2d7a  \" ]] && [[ ! -z
-0001d8c0: 205c 5c22 5c24 534b 5950 494c 4f54 5f4e   \\"\$SKYPILOT_N
-0001d8d0: 4f44 455f 4950 535c 5c22 205d 5d20 2626  ODE_IPS\\" ]] &&
-0001d8e0: 205b 5b20 2120 2d7a 205c 5c22 5c24 534b   [[ ! -z \\"\$SK
-0001d8f0: 5950 494c 4f54 5f4e 4f44 455f 5241 4e4b  YPILOT_NODE_RANK
-0001d900: 5c5c 2220 5d5d 2920 7c7c 2065 7869 7420  \\" ]]) || exit 
-0001d910: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
-0001d920: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0001d930: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
-0001d940: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0001d950: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0001d960: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0001d970: 2020 5f67 6574 5f74 696d 656f 7574 2867    _get_timeout(g
-0001d980: 656e 6572 6963 5f63 6c6f 7564 292c 0a20  eneric_cloud),. 
-0001d990: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0001d9a0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0001d9b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-0001d9c0: 6e67 2063 7573 746f 6d20 696d 6167 6520  ng custom image 
-0001d9d0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-0001d9e0: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
-0001d9f0: 7465 7374 5f61 7773 5f63 7573 746f 6d5f  test_aws_custom_
-0001da00: 696d 6167 6528 293a 0a20 2020 2022 2222  image():.    """
-0001da10: 5465 7374 2041 5753 2063 7573 746f 6d20  Test AWS custom 
-0001da20: 696d 6167 6522 2222 0a20 2020 206e 616d  image""".    nam
-0001da30: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0001da40: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0001da50: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001da60: 2027 7465 7374 2d61 7773 2d63 7573 746f   'test-aws-custo
-0001da70: 6d2d 696d 6167 6527 2c0a 2020 2020 2020  m-image',.      
-0001da80: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0001da90: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
-0001daa0: 7b6e 616d 657d 202d 2d72 6574 7279 2d75  {name} --retry-u
-0001dab0: 6e74 696c 2d75 7020 2d79 2074 6573 7473  ntil-up -y tests
-0001dac0: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
-0001dad0: 5f63 7573 746f 6d5f 696d 6167 652e 7961  _custom_image.ya
-0001dae0: 6d6c 202d 2d63 6c6f 7564 2061 7773 202d  ml --cloud aws -
-0001daf0: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
-0001db00: 3220 2d2d 696d 6167 652d 6964 2061 6d69  2 --image-id ami
-0001db10: 2d30 3632 6464 6439 3066 6236 6638 3236  -062ddd90fb6f826
-0001db20: 3761 272c 2020 2320 4e76 6964 6961 2069  7a',  # Nvidia i
-0001db30: 6d61 6765 0a20 2020 2020 2020 2020 2020  mage.           
-0001db40: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0001db50: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-0001db60: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0001db70: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0001db80: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0001db90: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
-0001dba0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0001dbb0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0001dbc0: 0a0a 4070 7974 6573 742e 6d61 726b 2e6b  ..@pytest.mark.k
-0001dbd0: 7562 6572 6e65 7465 730a 4070 7974 6573  ubernetes.@pytes
-0001dbe0: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
-0001dbf0: 7a65 280a 2020 2020 2269 6d61 6765 5f69  ze(.    "image_i
-0001dc00: 6422 2c0a 2020 2020 5b0a 2020 2020 2020  d",.    [.      
-0001dc10: 2020 2264 6f63 6b65 723a 6e76 6964 6961    "docker:nvidia
-0001dc20: 2f63 7564 613a 3131 2e38 2e30 2d64 6576  /cuda:11.8.0-dev
-0001dc30: 656c 2d75 6275 6e74 7531 382e 3034 222c  el-ubuntu18.04",
-0001dc40: 0a20 2020 2020 2020 2022 646f 636b 6572  .        "docker
-0001dc50: 3a75 6275 6e74 753a 3138 2e30 3422 2c0a  :ubuntu:18.04",.
-0001dc60: 2020 2020 2020 2020 2320 5465 7374 2069          # Test i
-0001dc70: 6d61 6765 2077 6974 6820 7079 7468 6f6e  mage with python
-0001dc80: 2033 2e31 3120 696e 7374 616c 6c65 6420   3.11 installed 
-0001dc90: 6279 2064 6566 6175 6c74 2e0a 2020 2020  by default..    
-0001dca0: 2020 2020 2264 6f63 6b65 723a 636f 6e74      "docker:cont
-0001dcb0: 696e 7575 6d69 6f2f 6d69 6e69 636f 6e64  inuumio/minicond
-0001dcc0: 6133 222c 0a20 2020 205d 290a 6465 6620  a3",.    ]).def 
-0001dcd0: 7465 7374 5f6b 7562 6572 6e65 7465 735f  test_kubernetes_
-0001dce0: 6375 7374 6f6d 5f69 6d61 6765 2869 6d61  custom_image(ima
-0001dcf0: 6765 5f69 6429 3a0a 2020 2020 2222 2254  ge_id):.    """T
-0001dd00: 6573 7420 4b75 6265 726e 6574 6573 2063  est Kubernetes c
-0001dd10: 7573 746f 6d20 696d 6167 6522 2222 0a20  ustom image""". 
-0001dd20: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0001dd30: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0001dd40: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0001dd50: 2020 2020 2020 2027 7465 7374 2d6b 7562         'test-kub
-0001dd60: 6572 6e65 7465 732d 6375 7374 6f6d 2d69  ernetes-custom-i
-0001dd70: 6d61 6765 272c 0a20 2020 2020 2020 205b  mage',.        [
-0001dd80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001dd90: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-0001dda0: 6d65 7d20 2d2d 7265 7472 792d 756e 7469  me} --retry-unti
-0001ddb0: 6c2d 7570 202d 7920 7465 7374 732f 7465  l-up -y tests/te
-0001ddc0: 7374 5f79 616d 6c73 2f74 6573 745f 6375  st_yamls/test_cu
-0001ddd0: 7374 6f6d 5f69 6d61 6765 2e79 616d 6c20  stom_image.yaml 
-0001dde0: 2d2d 636c 6f75 6420 6b75 6265 726e 6574  --cloud kubernet
-0001ddf0: 6573 202d 2d69 6d61 6765 2d69 6420 7b69  es --image-id {i
-0001de00: 6d61 6765 5f69 647d 202d 2d72 6567 696f  mage_id} --regio
-0001de10: 6e20 4e6f 6e65 202d 2d67 7075 7320 5434  n None --gpus T4
-0001de20: 3a31 272c 0a20 2020 2020 2020 2020 2020  :1',.           
-0001de30: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0001de40: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-0001de50: 2020 2020 2020 2020 2020 2020 2320 5472              # Tr
-0001de60: 7920 6578 6563 2074 6f20 7275 6e20 6167  y exec to run ag
-0001de70: 6169 6e20 616e 6420 6368 6563 6b20 6966  ain and check if
-0001de80: 2074 6865 206c 6f67 7320 6172 6520 7072   the logs are pr
-0001de90: 696e 7465 640a 2020 2020 2020 2020 2020  inted.          
-0001dea0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0001deb0: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
-0001dec0: 616d 6c73 2f74 6573 745f 6375 7374 6f6d  amls/test_custom
-0001ded0: 5f69 6d61 6765 2e79 616d 6c20 2d2d 636c  _image.yaml --cl
-0001dee0: 6f75 6420 6b75 6265 726e 6574 6573 202d  oud kubernetes -
-0001def0: 2d69 6d61 6765 2d69 6420 7b69 6d61 6765  -image-id {image
-0001df00: 5f69 647d 202d 2d72 6567 696f 6e20 4e6f  _id} --region No
-0001df10: 6e65 202d 2d67 7075 7320 5434 3a31 207c  ne --gpus T4:1 |
-0001df20: 2067 7265 7020 2248 656c 6c6f 2031 3030   grep "Hello 100
-0001df30: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001df40: 2320 4d61 6b65 2073 7572 6520 7373 6820  # Make sure ssh 
-0001df50: 6973 2077 6f72 6b69 6e67 2077 6974 6820  is working with 
-0001df60: 6375 7374 6f6d 2075 7365 726e 616d 650a  custom username.
-0001df70: 2020 2020 2020 2020 2020 2020 6627 7373              f'ss
-0001df80: 6820 7b6e 616d 657d 2065 6368 6f20 6869  h {name} echo hi
-0001df90: 207c 2067 7265 7020 6869 272c 0a20 2020   | grep hi',.   
-0001dfa0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001dfb0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0001dfc0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-0001dfd0: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
-0001dfe0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0001dff0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0001e000: 7079 7465 7374 2e6d 6172 6b2e 736c 6f77  pytest.mark.slow
-0001e010: 0a64 6566 2074 6573 745f 617a 7572 655f  .def test_azure_
-0001e020: 7374 6172 745f 7374 6f70 5f74 776f 5f6e  start_stop_two_n
-0001e030: 6f64 6573 2829 3a0a 2020 2020 6e61 6d65  odes():.    name
-0001e040: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0001e050: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-0001e060: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-0001e070: 2761 7a75 7265 2d73 7461 7274 2d73 746f  'azure-start-sto
-0001e080: 702d 7477 6f2d 6e6f 6465 7327 2c0a 2020  p-two-nodes',.  
-0001e090: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0001e0a0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0001e0b0: 202d 2d6e 756d 2d6e 6f64 6573 3d32 202d   --num-nodes=2 -
-0001e0c0: 7920 2d63 207b 6e61 6d65 7d20 6578 616d  y -c {name} exam
-0001e0d0: 706c 6573 2f61 7a75 7265 5f73 7461 7274  ples/azure_start
-0001e0e0: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
-0001e0f0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0001e100: 7865 6320 2d2d 6e75 6d2d 6e6f 6465 733d  xec --num-nodes=
-0001e110: 3220 7b6e 616d 657d 2065 7861 6d70 6c65  2 {name} example
-0001e120: 732f 617a 7572 655f 7374 6172 745f 7374  s/azure_start_st
-0001e130: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
-0001e140: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0001e150: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-0001e160: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-0001e170: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-0001e180: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0001e190: 736b 7920 7374 6f70 202d 7920 7b6e 616d  sky stop -y {nam
-0001e1a0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-0001e1b0: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
-0001e1c0: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-0001e1d0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0001e1e0: 2d2d 6e75 6d2d 6e6f 6465 733d 3220 7b6e  --num-nodes=2 {n
-0001e1f0: 616d 657d 2065 7861 6d70 6c65 732f 617a  ame} examples/az
-0001e200: 7572 655f 7374 6172 745f 7374 6f70 2e79  ure_start_stop.y
-0001e210: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0001e220: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0001e230: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-0001e240: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0001e250: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0001e260: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001e270: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0001e280: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0001e290: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
-0001e2a0: 2020 2320 3330 206d 696e 7320 2028 6974    # 30 mins  (it
-0001e2b0: 2074 616b 6573 2061 726f 756e 6420 7e32   takes around ~2
-0001e2c0: 3320 6d69 6e73 290a 2020 2020 290a 2020  3 mins).    ).  
-0001e2d0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0001e2e0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-0001e2f0: 2d2d 2d20 5465 7374 696e 6720 656e 7620  --- Testing env 
-0001e300: 666f 7220 6469 736b 2074 6965 7220 2d2d  for disk tier --
-0001e310: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-0001e320: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
-0001e330: 7374 5f61 7773 5f64 6973 6b5f 7469 6572  st_aws_disk_tier
-0001e340: 2829 3a0a 0a20 2020 2064 6566 205f 6765  ():..    def _ge
-0001e350: 745f 6177 735f 7175 6572 795f 636f 6d6d  t_aws_query_comm
-0001e360: 616e 6428 7265 6769 6f6e 2c20 696e 7374  and(region, inst
-0001e370: 616e 6365 5f69 642c 2066 6965 6c64 2c20  ance_id, field, 
-0001e380: 6578 7065 6374 6564 293a 0a20 2020 2020  expected):.     
-0001e390: 2020 2072 6574 7572 6e20 2866 2761 7773     return (f'aws
-0001e3a0: 2065 6332 2064 6573 6372 6962 652d 766f   ec2 describe-vo
-0001e3b0: 6c75 6d65 7320 2d2d 7265 6769 6f6e 207b  lumes --region {
-0001e3c0: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
-0001e3d0: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
-0001e3e0: 6c74 6572 7320 4e61 6d65 3d61 7474 6163  lters Name=attac
-0001e3f0: 686d 656e 742e 696e 7374 616e 6365 2d69  hment.instance-i
-0001e400: 642c 5661 6c75 6573 3d7b 696e 7374 616e  d,Values={instan
-0001e410: 6365 5f69 647d 2027 0a20 2020 2020 2020  ce_id} '.       
-0001e420: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
-0001e430: 7279 2056 6f6c 756d 6573 5b2a 5d2e 7b66  ry Volumes[*].{f
-0001e440: 6965 6c64 7d20 7c20 6772 6570 207b 6578  ield} | grep {ex
-0001e450: 7065 6374 6564 7d20 3b20 2729 0a0a 2020  pected} ; ')..  
-0001e460: 2020 666f 7220 6469 736b 5f74 6965 7220    for disk_tier 
-0001e470: 696e 206c 6973 7428 7265 736f 7572 6365  in list(resource
-0001e480: 735f 7574 696c 732e 4469 736b 5469 6572  s_utils.DiskTier
-0001e490: 293a 0a20 2020 2020 2020 2073 7065 6373  ):.        specs
-0001e4a0: 203d 2041 5753 2e5f 6765 745f 6469 736b   = AWS._get_disk
-0001e4b0: 5f73 7065 6373 2864 6973 6b5f 7469 6572  _specs(disk_tier
-0001e4c0: 290a 2020 2020 2020 2020 6e61 6d65 203d  ).        name =
-0001e4d0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0001e4e0: 6d65 2829 202b 2027 2d27 202b 2064 6973  me() + '-' + dis
-0001e4f0: 6b5f 7469 6572 2e76 616c 7565 0a20 2020  k_tier.value.   
-0001e500: 2020 2020 206e 616d 655f 6f6e 5f63 6c6f       name_on_clo
-0001e510: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
-0001e520: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
-0001e530: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
-0001e540: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
-0001e550: 736b 792e 4157 532e 6d61 785f 636c 7573  sky.AWS.max_clus
-0001e560: 7465 725f 6e61 6d65 5f6c 656e 6774 6828  ter_name_length(
-0001e570: 2929 0a20 2020 2020 2020 2072 6567 696f  )).        regio
-0001e580: 6e20 3d20 2775 732d 6561 7374 2d32 270a  n = 'us-east-2'.
-0001e590: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
-0001e5a0: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
-0001e5b0: 2027 6177 732d 6469 736b 2d74 6965 722d   'aws-disk-tier-
-0001e5c0: 2720 2b20 6469 736b 5f74 6965 722e 7661  ' + disk_tier.va
-0001e5d0: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-0001e5e0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0001e5f0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0001e600: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-0001e610: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
-0001e620: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-0001e630: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-0001e640: 2d64 6973 6b2d 7469 6572 207b 6469 736b  -disk-tier {disk
-0001e650: 5f74 6965 722e 7661 6c75 657d 2065 6368  _tier.value} ech
-0001e660: 6f20 2268 656c 6c6f 2073 6b79 2227 2c0a  o "hello sky"',.
-0001e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e680: 6627 6964 3d60 6177 7320 6563 3220 6465  f'id=`aws ec2 de
-0001e690: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
-0001e6a0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0001e6b0: 6e7d 202d 2d66 696c 7465 7273 2027 0a20  n} --filters '. 
-0001e6c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001e6d0: 274e 616d 653d 7461 673a 7261 792d 636c  'Name=tag:ray-cl
-0001e6e0: 7573 7465 722d 6e61 6d65 2c56 616c 7565  uster-name,Value
-0001e6f0: 733d 7b6e 616d 655f 6f6e 5f63 6c6f 7564  s={name_on_cloud
-0001e700: 7d20 2d2d 7175 6572 7920 270a 2020 2020  } --query '.    
-0001e710: 2020 2020 2020 2020 2020 2020 6627 5265              f'Re
-0001e720: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-0001e730: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
-0001e740: 6549 6420 2d2d 6f75 7470 7574 2074 6578  eId --output tex
-0001e750: 7460 3b20 2720 2b0a 2020 2020 2020 2020  t`; ' +.        
-0001e760: 2020 2020 2020 2020 5f67 6574 5f61 7773          _get_aws
-0001e770: 5f71 7565 7279 5f63 6f6d 6d61 6e64 2872  _query_command(r
-0001e780: 6567 696f 6e2c 2027 2469 6427 2c20 2756  egion, '$id', 'V
-0001e790: 6f6c 756d 6554 7970 6527 2c0a 2020 2020  olumeType',.    
-0001e7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7c0: 2020 2073 7065 6373 5b27 6469 736b 5f74     specs['disk_t
-0001e7d0: 6965 7227 5d29 202b 0a20 2020 2020 2020  ier']) +.       
-0001e7e0: 2020 2020 2020 2020 2028 2727 2069 6620           ('' if 
-0001e7f0: 6469 736b 5f74 6965 7220 3d3d 2072 6573  disk_tier == res
-0001e800: 6f75 7263 6573 5f75 7469 6c73 2e44 6973  ources_utils.Dis
-0001e810: 6b54 6965 722e 4c4f 5720 656c 7365 0a20  kTier.LOW else. 
-0001e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e830: 285f 6765 745f 6177 735f 7175 6572 795f  (_get_aws_query_
-0001e840: 636f 6d6d 616e 6428 7265 6769 6f6e 2c20  command(region, 
-0001e850: 2724 6964 272c 2027 496f 7073 272c 0a20  '$id', 'Iops',. 
-0001e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e880: 2020 2020 2020 2020 7370 6563 735b 2764          specs['d
-0001e890: 6973 6b5f 696f 7073 275d 2920 2b0a 2020  isk_iops']) +.  
-0001e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8b0: 5f67 6574 5f61 7773 5f71 7565 7279 5f63  _get_aws_query_c
-0001e8c0: 6f6d 6d61 6e64 2872 6567 696f 6e2c 2027  ommand(region, '
-0001e8d0: 2469 6427 2c20 2754 6872 6f75 6768 7075  $id', 'Throughpu
-0001e8e0: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-0001e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e900: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-0001e910: 6373 5b27 6469 736b 5f74 6872 6f75 6768  cs['disk_through
-0001e920: 7075 7427 5d29 2929 2c0a 2020 2020 2020  put']))),.      
-0001e930: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001e940: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0001e950: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0001e960: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0001e970: 3130 202a 2036 302c 2020 2320 3130 206d  10 * 60,  # 10 m
-0001e980: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
-0001e990: 726f 756e 6420 7e36 206d 696e 7329 0a20  round ~6 mins). 
-0001e9a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001e9b0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0001e9c0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-0001e9d0: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
-0001e9e0: 6763 705f 6469 736b 5f74 6965 7228 293a  gcp_disk_tier():
-0001e9f0: 0a20 2020 2066 6f72 2064 6973 6b5f 7469  .    for disk_ti
-0001ea00: 6572 2069 6e20 6c69 7374 2872 6573 6f75  er in list(resou
-0001ea10: 7263 6573 5f75 7469 6c73 2e44 6973 6b54  rces_utils.DiskT
-0001ea20: 6965 7229 3a0a 2020 2020 2020 2020 7479  ier):.        ty
-0001ea30: 7065 203d 2047 4350 2e5f 6765 745f 6469  pe = GCP._get_di
-0001ea40: 736b 5f74 7970 6528 6469 736b 5f74 6965  sk_type(disk_tie
-0001ea50: 7229 0a20 2020 2020 2020 206e 616d 6520  r).        name 
-0001ea60: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001ea70: 616d 6528 2920 2b20 272d 2720 2b20 6469  ame() + '-' + di
-0001ea80: 736b 5f74 6965 722e 7661 6c75 650a 2020  sk_tier.value.  
-0001ea90: 2020 2020 2020 6e61 6d65 5f6f 6e5f 636c        name_on_cl
-0001eaa0: 6f75 6420 3d20 636f 6d6d 6f6e 5f75 7469  oud = common_uti
-0001eab0: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
-0001eac0: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 0a20  name_on_cloud(. 
-0001ead0: 2020 2020 2020 2020 2020 206e 616d 652c             name,
-0001eae0: 2073 6b79 2e47 4350 2e6d 6178 5f63 6c75   sky.GCP.max_clu
-0001eaf0: 7374 6572 5f6e 616d 655f 6c65 6e67 7468  ster_name_length
-0001eb00: 2829 290a 2020 2020 2020 2020 7265 6769  ()).        regi
-0001eb10: 6f6e 203d 2027 7573 2d77 6573 7432 270a  on = 'us-west2'.
-0001eb20: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
-0001eb30: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
-0001eb40: 2027 6763 702d 6469 736b 2d74 6965 722d   'gcp-disk-tier-
-0001eb50: 2720 2b20 6469 736b 5f74 6965 722e 7661  ' + disk_tier.va
-0001eb60: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-0001eb70: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0001eb80: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0001eb90: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-0001eba0: 6c6f 7564 2067 6370 202d 2d72 6567 696f  loud gcp --regio
-0001ebb0: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-0001ebc0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-0001ebd0: 2d64 6973 6b2d 7469 6572 207b 6469 736b  -disk-tier {disk
-0001ebe0: 5f74 6965 722e 7661 6c75 657d 2065 6368  _tier.value} ech
-0001ebf0: 6f20 2268 656c 6c6f 2073 6b79 2227 2c0a  o "hello sky"',.
-0001ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec10: 6627 6e61 6d65 3d60 6763 6c6f 7564 2063  f'name=`gcloud c
-0001ec20: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
-0001ec30: 206c 6973 7420 2d2d 6669 6c74 6572 3d27   list --filter='
-0001ec40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ec50: 2066 2722 6c61 6265 6c73 2e72 6179 2d63   f'"labels.ray-c
-0001ec60: 6c75 7374 6572 2d6e 616d 653a 7b6e 616d  luster-name:{nam
-0001ec70: 655f 6f6e 5f63 6c6f 7564 7d22 2027 0a20  e_on_cloud}" '. 
-0001ec80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001ec90: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
-0001eca0: 6e61 6d65 2922 603b 2027 0a20 2020 2020  name)"`; '.     
-0001ecb0: 2020 2020 2020 2020 2020 2066 2767 636c             f'gcl
-0001ecc0: 6f75 6420 636f 6d70 7574 6520 6469 736b  oud compute disk
-0001ecd0: 7320 6c69 7374 202d 2d66 696c 7465 723d  s list --filter=
-0001ece0: 226e 616d 653d 246e 616d 6522 2027 0a20  "name=$name" '. 
-0001ecf0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001ed00: 272d 2d66 6f72 6d61 743d 2276 616c 7565  '--format="value
-0001ed10: 2874 7970 6529 2220 7c20 6772 6570 207b  (type)" | grep {
-0001ed20: 7479 7065 7d20 270a 2020 2020 2020 2020  type} '.        
-0001ed30: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
-0001ed40: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0001ed50: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0001ed60: 2020 2020 2020 7469 6d65 6f75 743d 3620        timeout=6 
-0001ed70: 2a20 3630 2c20 2023 2036 206d 696e 7320  * 60,  # 6 mins 
-0001ed80: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
-0001ed90: 6420 7e33 206d 696e 7329 0a20 2020 2020  d ~3 mins).     
-0001eda0: 2020 2029 0a20 2020 2020 2020 2072 756e     ).        run
-0001edb0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0001edc0: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
-0001edd0: 7a75 7265 0a64 6566 2074 6573 745f 617a  zure.def test_az
-0001ede0: 7572 655f 6469 736b 5f74 6965 7228 293a  ure_disk_tier():
-0001edf0: 0a20 2020 2066 6f72 2064 6973 6b5f 7469  .    for disk_ti
-0001ee00: 6572 2069 6e20 6c69 7374 2872 6573 6f75  er in list(resou
-0001ee10: 7263 6573 5f75 7469 6c73 2e44 6973 6b54  rces_utils.DiskT
-0001ee20: 6965 7229 3a0a 2020 2020 2020 2020 6966  ier):.        if
-0001ee30: 2064 6973 6b5f 7469 6572 203d 3d20 7265   disk_tier == re
-0001ee40: 736f 7572 6365 735f 7574 696c 732e 4469  sources_utils.Di
-0001ee50: 736b 5469 6572 2e48 4947 483a 0a20 2020  skTier.HIGH:.   
-0001ee60: 2020 2020 2020 2020 2023 2041 7a75 7265           # Azure
-0001ee70: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0001ee80: 7420 6869 6768 2064 6973 6b20 7469 6572  t high disk tier
-0001ee90: 2e0a 2020 2020 2020 2020 2020 2020 636f  ..            co
-0001eea0: 6e74 696e 7565 0a20 2020 2020 2020 2074  ntinue.        t
-0001eeb0: 7970 6520 3d20 417a 7572 652e 5f67 6574  ype = Azure._get
-0001eec0: 5f64 6973 6b5f 7479 7065 2864 6973 6b5f  _disk_type(disk_
-0001eed0: 7469 6572 290a 2020 2020 2020 2020 6e61  tier).        na
-0001eee0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0001eef0: 725f 6e61 6d65 2829 202b 2027 2d27 202b  r_name() + '-' +
-0001ef00: 2064 6973 6b5f 7469 6572 2e76 616c 7565   disk_tier.value
-0001ef10: 0a20 2020 2020 2020 206e 616d 655f 6f6e  .        name_on
-0001ef20: 5f63 6c6f 7564 203d 2063 6f6d 6d6f 6e5f  _cloud = common_
-0001ef30: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
-0001ef40: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
-0001ef50: 280a 2020 2020 2020 2020 2020 2020 6e61  (.            na
-0001ef60: 6d65 2c20 736b 792e 417a 7572 652e 6d61  me, sky.Azure.ma
-0001ef70: 785f 636c 7573 7465 725f 6e61 6d65 5f6c  x_cluster_name_l
-0001ef80: 656e 6774 6828 2929 0a20 2020 2020 2020  ength()).       
-0001ef90: 2072 6567 696f 6e20 3d20 2777 6573 7475   region = 'westu
-0001efa0: 7332 270a 2020 2020 2020 2020 7465 7374  s2'.        test
-0001efb0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001efc0: 2020 2020 2027 617a 7572 652d 6469 736b       'azure-disk
-0001efd0: 2d74 6965 722d 2720 2b20 6469 736b 5f74  -tier-' + disk_t
-0001efe0: 6965 722e 7661 6c75 652c 0a20 2020 2020  ier.value,.     
-0001eff0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001f000: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0001f010: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-0001f020: 657d 202d 2d63 6c6f 7564 2061 7a75 7265  e} --cloud azure
-0001f030: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0001f040: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-0001f050: 2020 2020 2066 272d 2d64 6973 6b2d 7469       f'--disk-ti
-0001f060: 6572 207b 6469 736b 5f74 6965 722e 7661  er {disk_tier.va
-0001f070: 6c75 657d 2065 6368 6f20 2268 656c 6c6f  lue} echo "hello
-0001f080: 2073 6b79 2227 2c0a 2020 2020 2020 2020   sky"',.        
-0001f090: 2020 2020 2020 2020 6627 617a 2072 6573          f'az res
-0001f0a0: 6f75 7263 6520 6c69 7374 202d 2d74 6167  ource list --tag
-0001f0b0: 2072 6179 2d63 6c75 7374 6572 2d6e 616d   ray-cluster-nam
-0001f0c0: 653d 7b6e 616d 655f 6f6e 5f63 6c6f 7564  e={name_on_cloud
-0001f0d0: 7d20 2d2d 7175 6572 7920 270a 2020 2020  } --query '.    
-0001f0e0: 2020 2020 2020 2020 2020 2020 6627 225b              f'"[
-0001f0f0: 3f74 7970 653d 3d5c 274d 6963 726f 736f  ?type==\'Microso
-0001f100: 6674 2e43 6f6d 7075 7465 2f64 6973 6b73  ft.Compute/disks
-0001f110: 5c27 5d2e 736b 752e 6e61 6d65 2220 270a  \'].sku.name" '.
-0001f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f130: 6627 2d2d 6f75 7470 7574 2074 7376 207c  f'--output tsv |
-0001f140: 2067 7265 7020 7b74 7970 657d 270a 2020   grep {type}'.  
-0001f150: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-0001f160: 2020 2020 2020 2020 2066 2773 6b79 2064           f'sky d
-0001f170: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0001f180: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0001f190: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-0001f1a0: 3230 206d 696e 7320 2028 6974 2074 616b  20 mins  (it tak
-0001f1b0: 6573 2061 726f 756e 6420 7e31 3220 6d69  es around ~12 mi
-0001f1c0: 6e73 290a 2020 2020 2020 2020 290a 2020  ns).        ).  
-0001f1d0: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
-0001f1e0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0001f1f0: 7374 2e6d 6172 6b2e 617a 7572 650a 6465  st.mark.azure.de
-0001f200: 6620 7465 7374 5f61 7a75 7265 5f62 6573  f test_azure_bes
-0001f210: 745f 7469 6572 5f66 6169 6c6f 7665 7228  t_tier_failover(
-0001f220: 293a 0a20 2020 2074 7970 6520 3d20 417a  ):.    type = Az
-0001f230: 7572 652e 5f67 6574 5f64 6973 6b5f 7479  ure._get_disk_ty
-0001f240: 7065 2872 6573 6f75 7263 6573 5f75 7469  pe(resources_uti
-0001f250: 6c73 2e44 6973 6b54 6965 722e 4c4f 5729  ls.DiskTier.LOW)
-0001f260: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0001f270: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0001f280: 2020 2020 6e61 6d65 5f6f 6e5f 636c 6f75      name_on_clou
-0001f290: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
-0001f2a0: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
-0001f2b0: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
-0001f2c0: 2020 2020 206e 616d 652c 2073 6b79 2e41       name, sky.A
-0001f2d0: 7a75 7265 2e6d 6178 5f63 6c75 7374 6572  zure.max_cluster
-0001f2e0: 5f6e 616d 655f 6c65 6e67 7468 2829 290a  _name_length()).
-0001f2f0: 2020 2020 7265 6769 6f6e 203d 2027 7765      region = 'we
-0001f300: 7374 7573 3227 0a20 2020 2074 6573 7420  stus2'.    test 
-0001f310: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-0001f320: 2761 7a75 7265 2d62 6573 742d 7469 6572  'azure-best-tier
-0001f330: 2d66 6169 6c6f 7665 7227 2c0a 2020 2020  -failover',.    
-0001f340: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001f350: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0001f360: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-0001f370: 6f75 6420 617a 7572 6520 2d2d 7265 6769  oud azure --regi
-0001f380: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-0001f390: 2020 2020 2020 2020 2020 6627 2d2d 6469            f'--di
-0001f3a0: 736b 2d74 6965 7220 6265 7374 202d 2d69  sk-tier best --i
-0001f3b0: 6e73 7461 6e63 652d 7479 7065 2053 7461  nstance-type Sta
-0001f3c0: 6e64 6172 645f 4438 5f76 3520 6563 686f  ndard_D8_v5 echo
-0001f3d0: 2022 6865 6c6c 6f20 736b 7922 272c 0a20   "hello sky"',. 
-0001f3e0: 2020 2020 2020 2020 2020 2066 2761 7a20             f'az 
-0001f3f0: 7265 736f 7572 6365 206c 6973 7420 2d2d  resource list --
-0001f400: 7461 6720 7261 792d 636c 7573 7465 722d  tag ray-cluster-
-0001f410: 6e61 6d65 3d7b 6e61 6d65 5f6f 6e5f 636c  name={name_on_cl
-0001f420: 6f75 647d 202d 2d71 7565 7279 2027 0a20  oud} --query '. 
-0001f430: 2020 2020 2020 2020 2020 2066 2722 5b3f             f'"[?
-0001f440: 7479 7065 3d3d 5c27 4d69 6372 6f73 6f66  type==\'Microsof
-0001f450: 742e 436f 6d70 7574 652f 6469 736b 735c  t.Compute/disks\
-0001f460: 275d 2e73 6b75 2e6e 616d 6522 2027 0a20  '].sku.name" '. 
-0001f470: 2020 2020 2020 2020 2020 2066 272d 2d6f             f'--o
-0001f480: 7574 7075 7420 7473 7620 7c20 6772 6570  utput tsv | grep
-0001f490: 207b 7479 7065 7d27 2c0a 2020 2020 2020   {type}',.      
-0001f4a0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-0001f4b0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-0001f4c0: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-0001f4d0: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-0001f4e0: 3230 206d 696e 7320 2028 6974 2074 616b  20 mins  (it tak
-0001f4f0: 6573 2061 726f 756e 6420 7e31 3220 6d69  es around ~12 mi
-0001f500: 6e73 290a 2020 2020 290a 2020 2020 7275  ns).    ).    ru
-0001f510: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0001f520: 0a0a 0a23 202d 2d2d 2d2d 2d20 5465 7374  ...# ------ Test
-0001f530: 696e 6720 5a65 726f 2051 756f 7461 2046  ing Zero Quota F
-0001f540: 6169 6c6f 7665 7220 2d2d 2d2d 2d2d 0a40  ailover ------.@
-0001f550: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-0001f560: 6465 6620 7465 7374 5f61 7773 5f7a 6572  def test_aws_zer
-0001f570: 6f5f 7175 6f74 615f 6661 696c 6f76 6572  o_quota_failover
-0001f580: 2829 3a0a 0a20 2020 206e 616d 6520 3d20  ():..    name = 
-0001f590: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0001f5a0: 6528 290a 2020 2020 7265 6769 6f6e 203d  e().    region =
-0001f5b0: 2067 6574 5f61 7773 5f72 6567 696f 6e5f   get_aws_region_
-0001f5c0: 666f 725f 7175 6f74 615f 6661 696c 6f76  for_quota_failov
-0001f5d0: 6572 2829 0a0a 2020 2020 6966 206e 6f74  er()..    if not
-0001f5e0: 2072 6567 696f 6e3a 0a20 2020 2020 2020   region:.       
-0001f5f0: 2070 7974 6573 742e 7866 6169 6c28 0a20   pytest.xfail(. 
-0001f600: 2020 2020 2020 2020 2020 2027 556e 6162             'Unab
-0001f610: 6c65 2074 6f20 7465 7374 207a 6572 6f20  le to test zero 
-0001f620: 7175 6f74 6120 6661 696c 6f76 6572 206f  quota failover o
-0001f630: 7074 696d 697a 6174 696f 6e20 e280 9420  ptimization ... 
-0001f640: 7175 6f74 6173 2027 0a20 2020 2020 2020  quotas '.       
-0001f650: 2020 2020 2027 666f 7220 4543 3220 5033       'for EC2 P3
-0001f660: 2069 6e73 7461 6e63 6573 2077 6572 6520   instances were 
-0001f670: 666f 756e 6420 6f6e 2061 6c6c 2041 5753  found on all AWS
-0001f680: 2072 6567 696f 6e73 2e20 4973 2074 6869   regions. Is thi
-0001f690: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
-0001f6a0: 2765 7870 6563 7465 6420 666f 7220 796f  'expected for yo
-0001f6b0: 7572 2061 6363 6f75 6e74 3f27 290a 2020  ur account?').  
-0001f6c0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-0001f6d0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0001f6e0: 2020 2020 2020 2027 6177 732d 7a65 726f         'aws-zero
-0001f6f0: 2d71 756f 7461 2d66 6169 6c6f 7665 7227  -quota-failover'
-0001f700: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0001f710: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0001f720: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0001f730: 7d20 2d2d 636c 6f75 6420 6177 7320 2d2d  } --cloud aws --
-0001f740: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001f750: 2d2d 6770 7573 2056 3130 303a 3820 2d2d  --gpus V100:8 --
-0001f760: 7573 652d 7370 6f74 207c 2067 7265 7020  use-spot | grep 
-0001f770: 2246 6f75 6e64 206e 6f20 7175 6f74 6122  "Found no quota"
-0001f780: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0001f790: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0001f7a0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0001f7b0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0001f7c0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-0001f7d0: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
-0001f7e0: 2074 6573 745f 6763 705f 7a65 726f 5f71   test_gcp_zero_q
-0001f7f0: 756f 7461 5f66 6169 6c6f 7665 7228 293a  uota_failover():
-0001f800: 0a0a 2020 2020 6e61 6d65 203d 205f 6765  ..    name = _ge
-0001f810: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0001f820: 0a20 2020 2072 6567 696f 6e20 3d20 6765  .    region = ge
-0001f830: 745f 6763 705f 7265 6769 6f6e 5f66 6f72  t_gcp_region_for
-0001f840: 5f71 756f 7461 5f66 6169 6c6f 7665 7228  _quota_failover(
-0001f850: 290a 0a20 2020 2069 6620 6e6f 7420 7265  )..    if not re
-0001f860: 6769 6f6e 3a0a 2020 2020 2020 2020 7079  gion:.        py
-0001f870: 7465 7374 2e78 6661 696c 280a 2020 2020  test.xfail(.    
-0001f880: 2020 2020 2020 2020 2755 6e61 626c 6520          'Unable 
-0001f890: 746f 2074 6573 7420 7a65 726f 2071 756f  to test zero quo
-0001f8a0: 7461 2066 6169 6c6f 7665 7220 6f70 7469  ta failover opti
-0001f8b0: 6d69 7a61 7469 6f6e 20e2 8094 2071 756f  mization ... quo
-0001f8c0: 7461 7320 270a 2020 2020 2020 2020 2020  tas '.          
-0001f8d0: 2020 2766 6f72 2041 3130 302d 3830 4742    'for A100-80GB
-0001f8e0: 2047 5055 7320 7765 7265 2066 6f75 6e64   GPUs were found
-0001f8f0: 206f 6e20 616c 6c20 4743 5020 7265 6769   on all GCP regi
-0001f900: 6f6e 732e 2049 7320 7468 6973 2027 0a20  ons. Is this '. 
-0001f910: 2020 2020 2020 2020 2020 2027 6578 7065             'expe
-0001f920: 6374 6564 2066 6f72 2079 6f75 7220 6163  cted for your ac
-0001f930: 636f 756e 743f 2729 0a20 2020 2020 2020  count?').       
-0001f940: 2072 6574 7572 6e0a 0a20 2020 2074 6573   return..    tes
-0001f950: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0001f960: 2020 2767 6370 2d7a 6572 6f2d 7175 6f74    'gcp-zero-quot
-0001f970: 612d 6661 696c 6f76 6572 272c 0a20 2020  a-failover',.   
-0001f980: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001f990: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0001f9a0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-0001f9b0: 6c6f 7564 2067 6370 202d 2d72 6567 696f  loud gcp --regio
-0001f9c0: 6e20 7b72 6567 696f 6e7d 202d 2d67 7075  n {region} --gpu
-0001f9d0: 7320 4131 3030 2d38 3047 423a 3120 2d2d  s A100-80GB:1 --
-0001f9e0: 7573 652d 7370 6f74 207c 2067 7265 7020  use-spot | grep 
-0001f9f0: 2246 6f75 6e64 206e 6f20 7175 6f74 6122  "Found no quota"
-0001fa00: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0001fa10: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0001fa20: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0001fa30: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0001fa40: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-0001fa50: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-0001fa60: 2073 6b79 7365 7276 6520 2d2d 2d2d 2d2d   skyserve ------
-0001fa70: 2d2d 2d2d 0a0a 0a64 6566 205f 6765 745f  ----...def _get_
-0001fa80: 7365 7276 6963 655f 6e61 6d65 2829 202d  service_name() -
-0001fa90: 3e20 7374 723a 0a20 2020 2022 2222 5265  > str:.    """Re
-0001faa0: 7475 726e 7320 6120 7573 6572 2d75 6e69  turns a user-uni
-0001fab0: 7175 6520 7365 7276 6963 6520 6e61 6d65  que service name
-0001fac0: 2066 6f72 2065 6163 6820 7465 7374 5f73   for each test_s
-0001fad0: 6b79 7365 7276 655f 3c6e 616d 653e 2829  kyserve_<name>()
-0001fae0: 2e0a 0a20 2020 204d 7573 7420 6265 2063  ...    Must be c
-0001faf0: 616c 6c65 6420 6672 6f6d 2065 6163 6820  alled from each 
-0001fb00: 7465 7374 5f73 6b79 7365 7276 655f 3c6e  test_skyserve_<n
-0001fb10: 616d 653e 2829 2e0a 2020 2020 2222 220a  ame>()..    """.
-0001fb20: 2020 2020 6361 6c6c 6572 5f66 756e 635f      caller_func_
-0001fb30: 6e61 6d65 203d 2069 6e73 7065 6374 2e73  name = inspect.s
-0001fb40: 7461 636b 2829 5b31 5d5b 335d 0a20 2020  tack()[1][3].   
-0001fb50: 2074 6573 745f 6e61 6d65 203d 2063 616c   test_name = cal
-0001fb60: 6c65 725f 6675 6e63 5f6e 616d 652e 7265  ler_func_name.re
-0001fb70: 706c 6163 6528 275f 272c 2027 2d27 292e  place('_', '-').
-0001fb80: 7265 706c 6163 6528 2774 6573 742d 272c  replace('test-',
-0001fb90: 2027 742d 2729 0a20 2020 2074 6573 745f   't-').    test_
-0001fba0: 6e61 6d65 203d 2074 6573 745f 6e61 6d65  name = test_name
-0001fbb0: 2e72 6570 6c61 6365 2827 736b 7973 6572  .replace('skyser
-0001fbc0: 7665 2d27 2c20 2773 732d 2729 0a20 2020  ve-', 'ss-').   
-0001fbd0: 2074 6573 745f 6e61 6d65 203d 2063 6f6d   test_name = com
-0001fbe0: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
-0001fbf0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
-0001fc00: 6c6f 7564 2874 6573 745f 6e61 6d65 2c20  loud(test_name, 
-0001fc10: 3234 290a 2020 2020 7265 7475 726e 2066  24).    return f
-0001fc20: 277b 7465 7374 5f6e 616d 657d 2d7b 7465  '{test_name}-{te
-0001fc30: 7374 5f69 647d 270a 0a0a 2320 5765 2063  st_id}'...# We c
-0001fc40: 6865 636b 2074 6865 206f 7574 7075 7420  heck the output 
-0001fc50: 6f66 2074 6865 2073 6b79 7365 7276 6520  of the skyserve 
-0001fc60: 7365 7276 6963 6520 746f 2073 6565 2069  service to see i
-0001fc70: 6620 6974 2069 7320 7265 6164 792e 204f  f it is ready. O
-0001fc80: 7574 7075 7420 6f66 0a23 2060 5245 504c  utput of.# `REPL
-0001fc90: 4943 4153 6020 6973 2069 6e20 7468 6520  ICAS` is in the 
-0001fca0: 666f 726d 206f 6620 6031 2f32 6020 7768  form of `1/2` wh
-0001fcb0: 6572 6520 7468 6520 6669 7273 7420 6e75  ere the first nu
-0001fcc0: 6d62 6572 2069 7320 7468 6520 6e75 6d62  mber is the numb
-0001fcd0: 6572 206f 660a 2320 7265 6164 7920 7265  er of.# ready re
-0001fce0: 706c 6963 6173 2061 6e64 2074 6865 2073  plicas and the s
-0001fcf0: 6563 6f6e 6420 6e75 6d62 6572 2069 7320  econd number is 
-0001fd00: 7468 6520 6e75 6d62 6572 206f 6620 746f  the number of to
-0001fd10: 7461 6c20 7265 706c 6963 6173 2e20 5765  tal replicas. We
-0001fd20: 0a23 2067 7265 7020 7375 6368 2066 6f72  .# grep such for
-0001fd30: 6d61 7420 746f 2065 6e73 7572 6520 7468  mat to ensure th
-0001fd40: 6174 2074 6865 2073 6572 7669 6365 2069  at the service i
-0001fd50: 7320 7265 6164 792c 2061 6e64 2065 6172  s ready, and ear
-0001fd60: 6c79 2065 7869 7420 6966 2061 6e79 0a23  ly exit if any.#
-0001fd70: 2066 6169 6c75 7265 2064 6574 6563 7465   failure detecte
-0001fd80: 642e 2049 6e20 7468 6520 656e 6420 7765  d. In the end we
-0001fd90: 2073 6c65 6570 2066 6f72 0a23 2073 6572   sleep for.# ser
-0001fda0: 7665 2e4c 425f 434f 4e54 524f 4c4c 4552  ve.LB_CONTROLLER
-0001fdb0: 5f53 594e 435f 494e 5445 5256 414c 5f53  _SYNC_INTERVAL_S
-0001fdc0: 4543 4f4e 4453 2074 6f20 6d61 6b65 2073  ECONDS to make s
-0001fdd0: 7572 6520 6c6f 6164 2062 616c 616e 6365  ure load balance
-0001fde0: 7220 6861 7665 0a23 2065 6e6f 7567 6820  r have.# enough 
-0001fdf0: 7469 6d65 2074 6f20 7379 6e63 2077 6974  time to sync wit
-0001fe00: 6820 7468 6520 636f 6e74 726f 6c6c 6572  h the controller
-0001fe10: 2061 6e64 2067 6574 2061 6c6c 2072 6561   and get all rea
-0001fe20: 6479 2072 6570 6c69 6361 2049 5073 2e0a  dy replica IPs..
-0001fe30: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-0001fe40: 4c5f 5245 4144 5920 3d20 280a 2020 2020  L_READY = (.    
-0001fe50: 277b 7b20 7768 696c 6520 7472 7565 3b20  '{{ while true; 
-0001fe60: 646f 270a 2020 2020 2720 2020 2020 733d  do'.    '     s=
-0001fe70: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
-0001fe80: 7573 207b 6e61 6d65 7d29 3b20 6563 686f  us {name}); echo
-0001fe90: 2022 2473 223b 270a 2020 2020 2720 2020   "$s";'.    '   
-0001fea0: 2020 6563 686f 2022 2473 2220 7c20 6772    echo "$s" | gr
-0001feb0: 6570 202d 7120 227b 7265 706c 6963 615f  ep -q "{replica_
-0001fec0: 6e75 6d7d 2f7b 7265 706c 6963 615f 6e75  num}/{replica_nu
-0001fed0: 6d7d 2220 2626 2062 7265 616b 3b27 0a20  m}" && break;'. 
-0001fee0: 2020 2027 2020 2020 2065 6368 6f20 2224     '     echo "$
-0001fef0: 7322 207c 2067 7265 7020 2d71 2022 4641  s" | grep -q "FA
-0001ff00: 494c 4544 2220 2626 2065 7869 7420 313b  ILED" && exit 1;
-0001ff10: 270a 2020 2020 2720 2020 2020 736c 6565  '.    '     slee
-0001ff20: 7020 3130 3b27 0a20 2020 2027 2064 6f6e  p 10;'.    ' don
-0001ff30: 653b 207d 7d3b 2065 6368 6f20 2247 6f74  e; }}; echo "Got
-0001ff40: 2073 6572 7669 6365 2073 7461 7475 7320   service status 
-0001ff50: 2473 223b 270a 2020 2020 6627 736c 6565  $s";'.    f'slee
-0001ff60: 7020 7b73 6572 7665 2e4c 425f 434f 4e54  p {serve.LB_CONT
-0001ff70: 524f 4c4c 4552 5f53 594e 435f 494e 5445  ROLLER_SYNC_INTE
-0001ff80: 5256 414c 5f53 4543 4f4e 4453 202b 2032  RVAL_SECONDS + 2
-0001ff90: 7d3b 2729 0a5f 4950 5f52 4547 4558 203d  };')._IP_REGEX =
-0001ffa0: 2072 2728 5b30 2d39 5d7b 312c 337d 5c2e   r'([0-9]{1,3}\.
-0001ffb0: 297b 337d 5b30 2d39 5d7b 312c 337d 270a  ){3}[0-9]{1,3}'.
-0001ffc0: 5f41 574b 5f41 4c4c 5f4c 494e 4553 5f42  _AWK_ALL_LINES_B
-0001ffd0: 454c 4f57 5f52 4550 4c49 4341 5320 3d20  ELOW_REPLICAS = 
-0001ffe0: 7227 2f52 6570 6c69 6361 732f 7b66 6c61  r'/Replicas/{fla
-0001fff0: 673d 313b 206e 6578 747d 2066 6c61 6727  g=1; next} flag'
-00020000: 0a5f 5345 5256 4943 455f 4c41 554e 4348  ._SERVICE_LAUNCH
-00020010: 494e 475f 5354 4154 5553 5f52 4547 4558  ING_STATUS_REGEX
-00020020: 203d 2027 5052 4f56 4953 494f 4e49 4e47   = 'PROVISIONING
-00020030: 5c7c 5354 4152 5449 4e47 270a 2320 5369  \|STARTING'.# Si
-00020040: 6e63 6520 7765 2064 6f6e 2774 2061 6c6c  nce we don't all
-00020050: 6f77 2074 6572 6d69 6e61 7465 2074 6865  ow terminate the
-00020060: 2073 6572 7669 6365 2069 6620 7468 6520   service if the 
-00020070: 636f 6e74 726f 6c6c 6572 2069 7320 494e  controller is IN
-00020080: 4954 2c0a 2320 7768 6963 6820 6973 2063  IT,.# which is c
-00020090: 6f6d 6d6f 6e20 666f 7220 7369 6d75 6c74  ommon for simult
-000200a0: 616e 656f 7573 2070 7974 6573 742c 2077  aneous pytest, w
-000200b0: 6520 6e65 6564 2074 6f20 7761 6974 2075  e need to wait u
-000200c0: 6e74 696c 2074 6865 0a23 2063 6f6e 7472  ntil the.# contr
-000200d0: 6f6c 6c65 7220 6973 2055 5020 6265 666f  oller is UP befo
-000200e0: 7265 2077 6520 6361 6e20 7465 726d 696e  re we can termin
-000200f0: 6174 6520 7468 6520 7365 7276 6963 652e  ate the service.
-00020100: 0a23 2054 6865 2074 6561 7264 6f77 6e20  .# The teardown 
-00020110: 636f 6d6d 616e 6420 6861 7320 6120 3130  command has a 10
-00020120: 2d6d 696e 7320 7469 6d65 6f75 742c 2073  -mins timeout, s
-00020130: 6f20 7765 2064 6f6e 2774 206e 6565 6420  o we don't need 
-00020140: 746f 2064 6f0a 2320 7468 6520 7469 6d65  to do.# the time
-00020150: 6f75 7420 6865 7265 2e20 5365 6520 696d  out here. See im
-00020160: 706c 656d 656e 7461 7469 6f6e 206f 6620  plementation of 
-00020170: 7275 6e5f 6f6e 655f 7465 7374 2829 2066  run_one_test() f
-00020180: 6f72 2064 6574 6169 6c73 2e0a 5f54 4541  or details.._TEA
-00020190: 5244 4f57 4e5f 5345 5256 4943 4520 3d20  RDOWN_SERVICE = 
-000201a0: 280a 2020 2020 2728 7768 696c 6520 7472  (.    '(while tr
-000201b0: 7565 3b20 646f 270a 2020 2020 2720 2020  ue; do'.    '   
-000201c0: 2020 733d 2428 736b 7920 7365 7276 6520    s=$(sky serve 
-000201d0: 646f 776e 202d 7920 7b6e 616d 657d 293b  down -y {name});
-000201e0: 270a 2020 2020 2720 2020 2020 6563 686f  '.    '     echo
-000201f0: 2022 2473 2220 7c20 6772 6570 202d 7120   "$s" | grep -q 
-00020200: 2273 6368 6564 756c 6564 2074 6f20 6265  "scheduled to be
-00020210: 2074 6572 6d69 6e61 7465 6422 2026 2620   terminated" && 
-00020220: 6272 6561 6b3b 270a 2020 2020 2720 2020  break;'.    '   
-00020230: 2020 736c 6565 7020 3130 3b27 0a20 2020    sleep 10;'.   
-00020240: 2027 646f 6e65 2927 290a 0a5f 5345 5256   'done)').._SERV
-00020250: 455f 454e 4450 4f49 4e54 5f57 4149 5420  E_ENDPOINT_WAIT 
-00020260: 3d20 280a 2020 2020 2765 7870 6f72 7420  = (.    'export 
-00020270: 4f52 4947 494e 5f53 4b59 5049 4c4f 545f  ORIGIN_SKYPILOT_
-00020280: 4445 4255 473d 2453 4b59 5049 4c4f 545f  DEBUG=$SKYPILOT_
-00020290: 4445 4255 473b 2065 7870 6f72 7420 534b  DEBUG; export SK
-000202a0: 5950 494c 4f54 5f44 4542 5547 3d30 3b20  YPILOT_DEBUG=0; 
-000202b0: 270a 2020 2020 2765 6e64 706f 696e 743d  '.    'endpoint=
-000202c0: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
-000202d0: 7573 202d 2d65 6e64 706f 696e 7420 7b6e  us --endpoint {n
-000202e0: 616d 657d 293b 2027 0a20 2020 2027 756e  ame}); '.    'un
-000202f0: 7469 6c20 2120 6563 686f 2022 2465 6e64  til ! echo "$end
-00020300: 706f 696e 7422 207c 2067 7265 7020 2243  point" | grep "C
-00020310: 6f6e 7472 6f6c 6c65 7220 6973 2069 6e69  ontroller is ini
-00020320: 7469 616c 697a 696e 6722 3b20 270a 2020  tializing"; '.  
-00020330: 2020 2764 6f20 6563 686f 2022 5761 6974    'do echo "Wait
-00020340: 696e 6720 666f 7220 7365 7276 6520 656e  ing for serve en
-00020350: 6470 6f69 6e74 2074 6f20 6265 2072 6561  dpoint to be rea
-00020360: 6479 2e2e 2e22 3b20 270a 2020 2020 2773  dy..."; '.    's
-00020370: 6c65 6570 2035 3b20 656e 6470 6f69 6e74  leep 5; endpoint
-00020380: 3d24 2873 6b79 2073 6572 7665 2073 7461  =$(sky serve sta
-00020390: 7475 7320 2d2d 656e 6470 6f69 6e74 207b  tus --endpoint {
-000203a0: 6e61 6d65 7d29 3b20 646f 6e65 3b20 270a  name}); done; '.
-000203b0: 2020 2020 2765 7870 6f72 7420 534b 5950      'export SKYP
-000203c0: 494c 4f54 5f44 4542 5547 3d24 4f52 4947  ILOT_DEBUG=$ORIG
-000203d0: 494e 5f53 4b59 5049 4c4f 545f 4445 4255  IN_SKYPILOT_DEBU
-000203e0: 473b 2065 6368 6f20 2224 656e 6470 6f69  G; echo "$endpoi
-000203f0: 6e74 2227 290a 0a5f 5345 5256 455f 5354  nt"').._SERVE_ST
-00020400: 4154 5553 5f57 4149 5420 3d20 2827 733d  ATUS_WAIT = ('s=
-00020410: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
-00020420: 7573 207b 6e61 6d65 7d29 3b20 270a 2020  us {name}); '.  
-00020430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020440: 2020 2020 2775 6e74 696c 2021 2065 6368      'until ! ech
-00020450: 6f20 2224 7322 207c 2067 7265 7020 2243  o "$s" | grep "C
-00020460: 6f6e 7472 6f6c 6c65 7220 6973 2069 6e69  ontroller is ini
-00020470: 7469 616c 697a 696e 672e 223b 2027 0a20  tializing."; '. 
-00020480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020490: 2020 2020 2027 646f 2065 6368 6f20 2257       'do echo "W
-000204a0: 6169 7469 6e67 2066 6f72 2073 6572 7665  aiting for serve
-000204b0: 2073 7461 7475 7320 746f 2062 6520 7265   status to be re
-000204c0: 6164 792e 2e2e 223b 2027 0a20 2020 2020  ady..."; '.     
-000204d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000204e0: 2027 736c 6565 7020 353b 2073 3d24 2873   'sleep 5; s=$(s
-000204f0: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
-00020500: 7b6e 616d 657d 293b 2064 6f6e 653b 2065  {name}); done; e
-00020510: 6368 6f20 2224 7322 2729 0a0a 0a64 6566  cho "$s"')...def
-00020520: 205f 6765 745f 7265 706c 6963 615f 6970   _get_replica_ip
-00020530: 286e 616d 653a 2073 7472 2c20 7265 706c  (name: str, repl
-00020540: 6963 615f 6964 3a20 696e 7429 202d 3e20  ica_id: int) -> 
-00020550: 7374 723a 0a20 2020 2072 6574 7572 6e20  str:.    return 
-00020560: 2866 2769 707b 7265 706c 6963 615f 6964  (f'ip{replica_id
-00020570: 7d3d 2428 6563 686f 2022 2473 2220 7c20  }=$(echo "$s" | 
-00020580: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00020590: 6177 6b20 227b 5f41 574b 5f41 4c4c 5f4c  awk "{_AWK_ALL_L
-000205a0: 494e 4553 5f42 454c 4f57 5f52 4550 4c49  INES_BELOW_REPLI
-000205b0: 4341 537d 2220 7c20 270a 2020 2020 2020  CAS}" | '.      
-000205c0: 2020 2020 2020 6627 6772 6570 202d 4520        f'grep -E 
-000205d0: 227b 6e61 6d65 7d5c 732b 7b72 6570 6c69  "{name}\s+{repli
-000205e0: 6361 5f69 647d 2220 7c20 270a 2020 2020  ca_id}" | '.    
-000205f0: 2020 2020 2020 2020 6627 6772 6570 202d          f'grep -
-00020600: 456f 2022 7b5f 4950 5f52 4547 4558 7d22  Eo "{_IP_REGEX}"
-00020610: 2927 290a 0a0a 6465 6620 5f67 6574 5f73  )')...def _get_s
-00020620: 6b79 7365 7276 655f 6874 7470 5f74 6573  kyserve_http_tes
-00020630: 7428 6e61 6d65 3a20 7374 722c 2063 6c6f  t(name: str, clo
-00020640: 7564 3a20 7374 722c 0a20 2020 2020 2020  ud: str,.       
-00020650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020660: 2020 2020 2074 696d 656f 7574 5f6d 696e       timeout_min
-00020670: 7574 6573 3a20 696e 7429 202d 3e20 5465  utes: int) -> Te
-00020680: 7374 3a0a 2020 2020 7465 7374 203d 2054  st:.    test = T
-00020690: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
-000206a0: 6573 742d 736b 7973 6572 7665 2d7b 636c  est-skyserve-{cl
-000206b0: 6f75 642e 7265 706c 6163 6528 225f 222c  oud.replace("_",
-000206c0: 2022 2d22 297d 272c 0a20 2020 2020 2020   "-")}',.       
-000206d0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000206e0: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
-000206f0: 207b 6e61 6d65 7d20 2d79 2074 6573 7473   {name} -y tests
-00020700: 2f73 6b79 7365 7276 652f 6874 7470 2f7b  /skyserve/http/{
-00020710: 636c 6f75 647d 2e79 616d 6c27 2c0a 2020  cloud}.yaml',.  
-00020720: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00020730: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00020740: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00020750: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00020760: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
-00020770: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-00020780: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-00020790: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-000207a0: 2020 2020 2020 2020 2020 2763 7572 6c20            'curl 
-000207b0: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
-000207c0: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
-000207d0: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
-000207e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000207f0: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
-00020800: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
-00020810: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00020820: 2074 696d 656f 7574 3d74 696d 656f 7574   timeout=timeout
-00020830: 5f6d 696e 7574 6573 202a 2036 302c 0a20  _minutes * 60,. 
-00020840: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
-00020850: 7465 7374 0a0a 0a64 6566 205f 6368 6563  test...def _chec
-00020860: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
-00020870: 7475 7328 6e61 6d65 3a20 7374 722c 2063  tus(name: str, c
-00020880: 6865 636b 5f74 7570 6c65 733a 204c 6973  heck_tuples: Lis
-00020890: 745b 5475 706c 655b 696e 742c 2062 6f6f  t[Tuple[int, boo
-000208a0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
-000208b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000208c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000208d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000208e0: 2020 2020 7374 725d 5d29 202d 3e20 7374      str]]) -> st
-000208f0: 723a 0a20 2020 2022 2222 4368 6563 6b20  r:.    """Check 
-00020900: 7265 706c 6963 6173 2720 7374 6174 7573  replicas' status
-00020910: 2061 6e64 2063 6f75 6e74 2069 6e20 736b   and count in sk
-00020920: 7920 7365 7276 6520 7374 6174 7573 0a0a  y serve status..
-00020930: 2020 2020 5765 2077 696c 6c20 6368 6563      We will chec
-00020940: 6b20 7643 5055 3d32 2c20 6173 2061 6c6c  k vCPU=2, as all
-00020950: 206f 7572 2074 6573 7473 2075 7365 2076   our tests use v
-00020960: 4350 553d 322e 0a20 2020 200a 2020 2020  CPU=2..    .    
-00020970: 4172 6773 3a0a 2020 2020 2020 2020 6e61  Args:.        na
-00020980: 6d65 3a20 7468 6520 6e61 6d65 206f 6620  me: the name of 
-00020990: 7468 6520 7365 7276 6963 650a 2020 2020  the service.    
-000209a0: 2020 2020 6368 6563 6b5f 7475 706c 6573      check_tuples
-000209b0: 3a20 4120 6c69 7374 206f 6620 7265 706c  : A list of repl
-000209c0: 6963 6120 7072 6f70 6572 7479 2074 6f20  ica property to 
-000209d0: 6368 6563 6b2e 2045 6163 6820 7475 706c  check. Each tupl
-000209e0: 6520 6973 0a20 2020 2020 2020 2020 2020  e is.           
-000209f0: 2028 636f 756e 742c 2069 735f 7370 6f74   (count, is_spot
-00020a00: 2c20 7374 6174 7573 290a 2020 2020 2222  , status).    ""
-00020a10: 220a 2020 2020 6368 6563 6b5f 636d 6420  ".    check_cmd 
-00020a20: 3d20 2727 0a20 2020 2066 6f72 2063 6865  = ''.    for che
-00020a30: 636b 5f74 7570 6c65 2069 6e20 6368 6563  ck_tuple in chec
-00020a40: 6b5f 7475 706c 6573 3a0a 2020 2020 2020  k_tuples:.      
-00020a50: 2020 636f 756e 742c 2069 735f 7370 6f74    count, is_spot
-00020a60: 2c20 7374 6174 7573 203d 2063 6865 636b  , status = check
-00020a70: 5f74 7570 6c65 0a20 2020 2020 2020 2072  _tuple.        r
-00020a80: 6573 6f75 7263 655f 7374 7220 3d20 2727  esource_str = ''
-00020a90: 0a20 2020 2020 2020 2069 6620 7374 6174  .        if stat
-00020aa0: 7573 206e 6f74 2069 6e20 5b27 5045 4e44  us not in ['PEND
-00020ab0: 494e 4727 2c20 2753 4855 5454 494e 475f  ING', 'SHUTTING_
-00020ac0: 444f 574e 272c 2027 4641 494c 4544 275d  DOWN', 'FAILED']
-00020ad0: 3a0a 2020 2020 2020 2020 2020 2020 7370  :.            sp
-00020ae0: 6f74 5f73 7472 203d 2027 270a 2020 2020  ot_str = ''.    
-00020af0: 2020 2020 2020 2020 6966 2069 735f 7370          if is_sp
-00020b00: 6f74 3a0a 2020 2020 2020 2020 2020 2020  ot:.            
-00020b10: 2020 2020 7370 6f74 5f73 7472 203d 2027      spot_str = '
-00020b20: 5c5b 5370 6f74 5c5d 270a 2020 2020 2020  \[Spot\]'.      
-00020b30: 2020 2020 2020 7265 736f 7572 6365 5f73        resource_s
-00020b40: 7472 203d 2066 2728 7b73 706f 745f 7374  tr = f'({spot_st
-00020b50: 727d 7643 5055 3d32 2927 0a20 2020 2020  r}vCPU=2)'.     
-00020b60: 2020 2063 6865 636b 5f63 6d64 202b 3d20     check_cmd += 
-00020b70: 2866 2720 6563 686f 2022 2473 2220 7c20  (f' echo "$s" | 
-00020b80: 6772 6570 2022 7b72 6573 6f75 7263 655f  grep "{resource_
-00020b90: 7374 727d 2220 7c20 270a 2020 2020 2020  str}" | '.      
-00020ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020bb0: 6627 6772 6570 2022 7b73 7461 7475 737d  f'grep "{status}
-00020bc0: 2220 7c20 7763 202d 6c20 7c20 6772 6570  " | wc -l | grep
-00020bd0: 207b 636f 756e 747d 207c 7c20 6578 6974   {count} || exit
-00020be0: 2031 3b27 290a 2020 2020 7265 7475 726e   1;').    return
-00020bf0: 2028 6627 7b5f 5345 5256 455f 5354 4154   (f'{_SERVE_STAT
-00020c00: 5553 5f57 4149 542e 666f 726d 6174 286e  US_WAIT.format(n
-00020c10: 616d 653d 6e61 6d65 297d 3b20 6563 686f  ame=name)}; echo
-00020c20: 2022 2473 223b 2027 202b 2063 6865 636b   "$s"; ' + check
-00020c30: 5f63 6d64 290a 0a0a 6465 6620 5f63 6865  _cmd)...def _che
-00020c40: 636b 5f73 6572 7669 6365 5f76 6572 7369  ck_service_versi
-00020c50: 6f6e 2873 6572 7669 6365 5f6e 616d 653a  on(service_name:
-00020c60: 2073 7472 2c20 7665 7273 696f 6e3a 2073   str, version: s
-00020c70: 7472 2920 2d3e 2073 7472 3a0a 2020 2020  tr) -> str:.    
-00020c80: 2320 4772 6570 2074 6865 206c 696e 6573  # Grep the lines
-00020c90: 2062 6566 6f72 6520 2753 6572 7669 6365   before 'Service
-00020ca0: 2052 6570 6c69 6361 7327 2061 6e64 2063   Replicas' and c
-00020cb0: 6865 636b 2069 6620 7468 6520 7365 7276  heck if the serv
-00020cc0: 6963 6520 7665 7273 696f 6e0a 2020 2020  ice version.    
-00020cd0: 2320 6973 2063 6f72 7265 6374 2e0a 2020  # is correct..  
-00020ce0: 2020 7265 7475 726e 2028 6627 6563 686f    return (f'echo
-00020cf0: 2022 2473 2220 7c20 6772 6570 202d 4231   "$s" | grep -B1
-00020d00: 3030 3020 2253 6572 7669 6365 2052 6570  000 "Service Rep
-00020d10: 6c69 6361 7322 207c 2027 0a20 2020 2020  licas" | '.     
-00020d20: 2020 2020 2020 2066 2767 7265 7020 2d45         f'grep -E
-00020d30: 2022 7b73 6572 7669 6365 5f6e 616d 657d   "{service_name}
-00020d40: 5c73 2b7b 7665 7273 696f 6e7d 2220 7c7c  \s+{version}" ||
-00020d50: 2065 7869 7420 313b 2027 290a 0a0a 4070   exit 1; ')...@p
-00020d60: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
-00020d70: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
-00020d80: 650a 6465 6620 7465 7374 5f73 6b79 7365  e.def test_skyse
-00020d90: 7276 655f 6763 705f 6874 7470 2829 3a0a  rve_gcp_http():.
-00020da0: 2020 2020 2222 2254 6573 7420 736b 7973      """Test skys
-00020db0: 6572 7665 206f 6e20 4743 5022 2222 0a20  erve on GCP""". 
-00020dc0: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
-00020dd0: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
-00020de0: 2020 7465 7374 203d 205f 6765 745f 736b    test = _get_sk
-00020df0: 7973 6572 7665 5f68 7474 705f 7465 7374  yserve_http_test
-00020e00: 286e 616d 652c 2027 6763 7027 2c20 3230  (name, 'gcp', 20
-00020e10: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00020e20: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00020e30: 7374 2e6d 6172 6b2e 6177 730a 4070 7974  st.mark.aws.@pyt
-00020e40: 6573 742e 6d61 726b 2e73 6572 7665 0a64  est.mark.serve.d
-00020e50: 6566 2074 6573 745f 736b 7973 6572 7665  ef test_skyserve
-00020e60: 5f61 7773 5f68 7474 7028 293a 0a20 2020  _aws_http():.   
-00020e70: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
-00020e80: 6520 6f6e 2041 5753 2222 220a 2020 2020  e on AWS""".    
-00020e90: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
-00020ea0: 6963 655f 6e61 6d65 2829 0a20 2020 2074  ice_name().    t
-00020eb0: 6573 7420 3d20 5f67 6574 5f73 6b79 7365  est = _get_skyse
-00020ec0: 7276 655f 6874 7470 5f74 6573 7428 6e61  rve_http_test(na
-00020ed0: 6d65 2c20 2761 7773 272c 2032 3029 0a20  me, 'aws', 20). 
-00020ee0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00020ef0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00020f00: 6d61 726b 2e61 7a75 7265 0a40 7079 7465  mark.azure.@pyte
-00020f10: 7374 2e6d 6172 6b2e 7365 7276 650a 6465  st.mark.serve.de
-00020f20: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
-00020f30: 617a 7572 655f 6874 7470 2829 3a0a 2020  azure_http():.  
-00020f40: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
-00020f50: 7665 206f 6e20 417a 7572 6522 2222 0a20  ve on Azure""". 
-00020f60: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
-00020f70: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
-00020f80: 2020 7465 7374 203d 205f 6765 745f 736b    test = _get_sk
-00020f90: 7973 6572 7665 5f68 7474 705f 7465 7374  yserve_http_test
-00020fa0: 286e 616d 652c 2027 617a 7572 6527 2c20  (name, 'azure', 
-00020fb0: 3330 290a 2020 2020 7275 6e5f 6f6e 655f  30).    run_one_
-00020fc0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00020fd0: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
-00020fe0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00020ff0: 6b75 6265 726e 6574 6573 0a64 6566 2074  kubernetes.def t
-00021000: 6573 745f 736b 7973 6572 7665 5f6c 6c6d  est_skyserve_llm
-00021010: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00021020: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
-00021030: 7420 736b 7973 6572 7665 2077 6974 6820  t skyserve with 
-00021040: 7265 616c 204c 4c4d 2075 7365 6361 7365  real LLM usecase
-00021050: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-00021060: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-00021070: 2829 0a0a 2020 2020 6465 6620 6765 6e65  ()..    def gene
-00021080: 7261 7465 5f6c 6c6d 5f74 6573 745f 636f  rate_llm_test_co
-00021090: 6d6d 616e 6428 7072 6f6d 7074 3a20 7374  mmand(prompt: st
-000210a0: 722c 2065 7870 6563 7465 645f 6f75 7470  r, expected_outp
-000210b0: 7574 3a20 7374 7229 202d 3e20 7374 723a  ut: str) -> str:
-000210c0: 0a20 2020 2020 2020 2070 726f 6d70 7420  .        prompt 
-000210d0: 3d20 7368 6c65 782e 7175 6f74 6528 7072  = shlex.quote(pr
-000210e0: 6f6d 7074 290a 2020 2020 2020 2020 6578  ompt).        ex
-000210f0: 7065 6374 6564 5f6f 7574 7075 7420 3d20  pected_output = 
-00021100: 7368 6c65 782e 7175 6f74 6528 6578 7065  shlex.quote(expe
-00021110: 6374 6564 5f6f 7574 7075 7429 0a20 2020  cted_output).   
-00021120: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
-00021130: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-00021140: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-00021150: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-00021160: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
-00021170: 2020 2020 2770 7974 686f 6e20 7465 7374      'python test
-00021180: 732f 736b 7973 6572 7665 2f6c 6c6d 2f67  s/skyserve/llm/g
-00021190: 6574 5f72 6573 706f 6e73 652e 7079 202d  et_response.py -
-000211a0: 2d65 6e64 706f 696e 7420 2465 6e64 706f  -endpoint $endpo
-000211b0: 696e 7420 270a 2020 2020 2020 2020 2020  int '.          
-000211c0: 2020 6627 2d2d 7072 6f6d 7074 207b 7072    f'--prompt {pr
-000211d0: 6f6d 7074 7d20 7c20 6772 6570 207b 6578  ompt} | grep {ex
-000211e0: 7065 6374 6564 5f6f 7574 7075 747d 2729  pected_output}')
-000211f0: 0a0a 2020 2020 7769 7468 206f 7065 6e28  ..    with open(
-00021200: 2774 6573 7473 2f73 6b79 7365 7276 652f  'tests/skyserve/
-00021210: 6c6c 6d2f 7072 6f6d 7074 5f6f 7574 7075  llm/prompt_outpu
-00021220: 742e 6a73 6f6e 272c 2027 7227 2c0a 2020  t.json', 'r',.  
-00021230: 2020 2020 2020 2020 2020 2020 656e 636f              enco
-00021240: 6469 6e67 3d27 7574 662d 3827 2920 6173  ding='utf-8') as
-00021250: 2066 3a0a 2020 2020 2020 2020 7072 6f6d   f:.        prom
-00021260: 7074 326f 7574 7075 7420 3d20 6a73 6f6e  pt2output = json
-00021270: 2e6c 6f61 6428 6629 0a0a 2020 2020 7465  .load(f)..    te
-00021280: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00021290: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-000212a0: 7665 2d6c 6c6d 272c 0a20 2020 2020 2020  ve-llm',.       
-000212b0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000212c0: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
-000212d0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-000212e0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-000212f0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-00021300: 652f 6c6c 6d2f 7365 7276 6963 652e 7961  e/llm/service.ya
-00021310: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00021320: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-00021330: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-00021340: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-00021350: 6361 5f6e 756d 3d31 292c 0a20 2020 2020  ca_num=1),.     
-00021360: 2020 2020 2020 202a 5b0a 2020 2020 2020         *[.      
-00021370: 2020 2020 2020 2020 2020 6765 6e65 7261            genera
-00021380: 7465 5f6c 6c6d 5f74 6573 745f 636f 6d6d  te_llm_test_comm
-00021390: 616e 6428 7072 6f6d 7074 2c20 6f75 7470  and(prompt, outp
-000213a0: 7574 290a 2020 2020 2020 2020 2020 2020  ut).            
-000213b0: 2020 2020 666f 7220 7072 6f6d 7074 2c20      for prompt, 
-000213c0: 6f75 7470 7574 2069 6e20 7072 6f6d 7074  output in prompt
-000213d0: 326f 7574 7075 742e 6974 656d 7328 290a  2output.items().
-000213e0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-000213f0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00021400: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
-00021410: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
-00021420: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-00021430: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00021440: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00021450: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00021460: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-00021470: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
-00021480: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
-00021490: 6572 7665 5f73 706f 745f 7265 636f 7665  erve_spot_recove
-000214a0: 7279 2829 3a0a 2020 2020 6e61 6d65 203d  ry():.    name =
-000214b0: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
-000214c0: 6d65 2829 0a20 2020 207a 6f6e 6520 3d20  me().    zone = 
-000214d0: 2775 732d 6365 6e74 7261 6c31 2d61 270a  'us-central1-a'.
-000214e0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-000214f0: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-00021500: 2d73 6b79 7365 7276 652d 7370 6f74 2d72  -skyserve-spot-r
-00021510: 6563 6f76 6572 792d 6763 7027 2c0a 2020  ecovery-gcp',.  
-00021520: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00021530: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00021540: 7570 202d 6e20 7b6e 616d 657d 202d 7920  up -n {name} -y 
-00021550: 7465 7374 732f 736b 7973 6572 7665 2f73  tests/skyserve/s
-00021560: 706f 742f 7265 636f 7665 7279 2e79 616d  pot/recovery.yam
-00021570: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00021580: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-00021590: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-000215a0: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-000215b0: 615f 6e75 6d3d 3129 2c0a 2020 2020 2020  a_num=1),.      
-000215c0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-000215d0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-000215e0: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-000215f0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00021600: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
-00021610: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-00021620: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-00021630: 6572 6522 272c 0a20 2020 2020 2020 2020  ere"',.         
-00021640: 2020 205f 7465 726d 696e 6174 655f 6763     _terminate_gc
-00021650: 705f 7265 706c 6963 6128 6e61 6d65 2c20  p_replica(name, 
-00021660: 7a6f 6e65 2c20 3129 2c0a 2020 2020 2020  zone, 1),.      
-00021670: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-00021680: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-00021690: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-000216a0: 7265 706c 6963 615f 6e75 6d3d 3129 2c0a  replica_num=1),.
-000216b0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-000216c0: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
-000216d0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-000216e0: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
-000216f0: 2020 2020 2020 2763 7572 6c20 2d4c 2068        'curl -L h
-00021700: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
-00021710: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
-00021720: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
-00021730: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00021740: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
-00021750: 452e 666f 726d 6174 286e 616d 653d 6e61  E.format(name=na
-00021760: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-00021770: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-00021780: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00021790: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-000217a0: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
-000217b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000217c0: 6b75 6265 726e 6574 6573 0a64 6566 2074  kubernetes.def t
-000217d0: 6573 745f 736b 7973 6572 7665 5f62 6173  est_skyserve_bas
-000217e0: 655f 6f6e 6465 6d61 6e64 5f66 616c 6c62  e_ondemand_fallb
-000217f0: 6163 6b28 6765 6e65 7269 635f 636c 6f75  ack(generic_clou
-00021800: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-00021810: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-00021820: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00021830: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00021840: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
-00021850: 2d62 6173 652d 6f6e 6465 6d61 6e64 2d66  -base-ondemand-f
-00021860: 616c 6c62 6163 6b27 2c0a 2020 2020 2020  allback',.      
-00021870: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00021880: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
-00021890: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
-000218a0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-000218b0: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-000218c0: 7665 2f73 706f 742f 6261 7365 5f6f 6e64  ve/spot/base_ond
-000218d0: 656d 616e 645f 6661 6c6c 6261 636b 2e79  emand_fallback.y
-000218e0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-000218f0: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00021900: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00021910: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00021920: 6963 615f 6e75 6d3d 3229 2c0a 2020 2020  ica_num=2),.    
-00021930: 2020 2020 2020 2020 5f63 6865 636b 5f72          _check_r
-00021940: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
-00021950: 286e 616d 652c 205b 2831 2c20 5472 7565  (name, [(1, True
-00021960: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
-00021970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021990: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
-000219a0: 652c 2027 5245 4144 5927 295d 292c 0a20  e, 'READY')]),. 
-000219b0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000219c0: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
-000219d0: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
-000219e0: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-000219f0: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00021a00: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00021a10: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00021a20: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-00021a30: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
-00021a40: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
-00021a50: 6572 7665 5f64 796e 616d 6963 5f6f 6e64  erve_dynamic_ond
-00021a60: 656d 616e 645f 6661 6c6c 6261 636b 2829  emand_fallback()
-00021a70: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00021a80: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
-00021a90: 0a20 2020 207a 6f6e 6520 3d20 2775 732d  .    zone = 'us-
-00021aa0: 6365 6e74 7261 6c31 2d61 270a 0a20 2020  central1-a'..   
-00021ab0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00021ac0: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
-00021ad0: 7365 7276 652d 6479 6e61 6d69 632d 6f6e  serve-dynamic-on
-00021ae0: 6465 6d61 6e64 2d66 616c 6c62 6163 6b27  demand-fallback'
-00021af0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00021b00: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00021b10: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-00021b20: 202d 2d63 6c6f 7564 2067 6370 202d 7920   --cloud gcp -y 
-00021b30: 7465 7374 732f 736b 7973 6572 7665 2f73  tests/skyserve/s
-00021b40: 706f 742f 6479 6e61 6d69 635f 6f6e 6465  pot/dynamic_onde
-00021b50: 6d61 6e64 5f66 616c 6c62 6163 6b2e 7961  mand_fallback.ya
-00021b60: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00021b70: 2066 2773 6c65 6570 2034 3027 2c0a 2020   f'sleep 40',.  
-00021b80: 2020 2020 2020 2020 2020 2320 3220 6f6e            # 2 on
-00021b90: 2d64 656d 616e 6420 2870 726f 7669 7369  -demand (provisi
-00021ba0: 6f6e 696e 6729 202b 2032 2053 706f 7420  oning) + 2 Spot 
-00021bb0: 2870 726f 7669 7369 6f6e 696e 6729 2e0a  (provisioning)..
-00021bc0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00021bd0: 5345 5256 455f 5354 4154 5553 5f57 4149  SERVE_STATUS_WAI
-00021be0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-00021bf0: 6d65 297d 3b20 6563 686f 2022 2473 223b  me)}; echo "$s";
-00021c00: 270a 2020 2020 2020 2020 2020 2020 2765  '.            'e
-00021c10: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00021c20: 2d71 2022 302f 3422 207c 7c20 6578 6974  -q "0/4" || exit
-00021c30: 2031 272c 0a20 2020 2020 2020 2020 2020   1',.           
-00021c40: 2023 2057 6169 7420 666f 7220 7468 6520   # Wait for the 
-00021c50: 7072 6f76 6973 696f 6e69 6e67 2073 7461  provisioning sta
-00021c60: 7274 730a 2020 2020 2020 2020 2020 2020  rts.            
-00021c70: 6627 736c 6565 7020 3430 272c 0a20 2020  f'sleep 40',.   
-00021c80: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00021c90: 7265 706c 6963 615f 696e 5f73 7461 7475  replica_in_statu
-00021ca0: 7328 6e61 6d65 2c20 5b0a 2020 2020 2020  s(name, [.      
-00021cb0: 2020 2020 2020 2020 2020 2832 2c20 5472            (2, Tr
-00021cc0: 7565 2c20 5f53 4552 5649 4345 5f4c 4155  ue, _SERVICE_LAU
-00021cd0: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
-00021ce0: 4745 5820 2b20 275c 7c52 4541 4459 2729  GEX + '\|READY')
-00021cf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00021d00: 2020 2832 2c20 4661 6c73 652c 205f 5345    (2, False, _SE
-00021d10: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
-00021d20: 5354 4154 5553 5f52 4547 4558 202b 2027  STATUS_REGEX + '
-00021d30: 5c7c 5348 5554 5449 4e47 5f44 4f57 4e27  \|SHUTTING_DOWN'
-00021d40: 290a 2020 2020 2020 2020 2020 2020 5d29  ).            ])
-00021d50: 2c0a 0a20 2020 2020 2020 2020 2020 2023  ,..            #
-00021d60: 2057 6169 7420 756e 7469 6c20 3220 7370   Wait until 2 sp
-00021d70: 6f74 2069 6e73 7461 6e63 6573 2061 7265  ot instances are
-00021d80: 2072 6561 6479 2e0a 2020 2020 2020 2020   ready..        
-00021d90: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00021da0: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00021db0: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-00021dc0: 706c 6963 615f 6e75 6d3d 3229 2c0a 2020  plica_num=2),.  
-00021dd0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00021de0: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
-00021df0: 7573 286e 616d 652c 205b 2832 2c20 5472  us(name, [(2, Tr
-00021e00: 7565 2c20 2752 4541 4459 2729 2c0a 2020  ue, 'READY'),.  
-00021e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021e30: 2020 2020 2020 2020 2020 2830 2c20 4661            (0, Fa
-00021e40: 6c73 652c 2027 2729 5d29 2c0a 2020 2020  lse, '')]),.    
-00021e50: 2020 2020 2020 2020 5f74 6572 6d69 6e61          _termina
-00021e60: 7465 5f67 6370 5f72 6570 6c69 6361 286e  te_gcp_replica(n
-00021e70: 616d 652c 207a 6f6e 652c 2031 292c 0a20  ame, zone, 1),. 
-00021e80: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
-00021e90: 6570 2034 3027 2c0a 2020 2020 2020 2020  ep 40',.        
-00021ea0: 2020 2020 2320 3120 6f6e 2d64 656d 616e      # 1 on-deman
-00021eb0: 6420 2870 726f 7669 7369 6f6e 696e 6729  d (provisioning)
-00021ec0: 202b 2031 2053 706f 7420 2872 6561 6479   + 1 Spot (ready
-00021ed0: 2920 2b20 3120 7370 6f74 2028 7072 6f76  ) + 1 spot (prov
-00021ee0: 6973 696f 6e69 6e67 292e 0a20 2020 2020  isioning)..     
-00021ef0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-00021f00: 5f53 5441 5455 535f 5741 4954 2e66 6f72  _STATUS_WAIT.for
-00021f10: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00021f20: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00021f30: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-00021f40: 202d 7120 2231 2f33 2227 2c0a 2020 2020   -q "1/3"',.    
-00021f50: 2020 2020 2020 2020 5f63 6865 636b 5f72          _check_r
-00021f60: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
-00021f70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00021f80: 2020 6e61 6d65 2c20 5b28 312c 2054 7275    name, [(1, Tru
-00021f90: 652c 2027 5245 4144 5927 292c 0a20 2020  e, 'READY'),.   
-00021fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021fb0: 2020 2020 2831 2c20 5472 7565 2c20 5f53      (1, True, _S
-00021fc0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
-00021fd0: 5f53 5441 5455 535f 5245 4745 5829 2c0a  _STATUS_REGEX),.
-00021fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021ff0: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
-00022000: 2c20 5f53 4552 5649 4345 5f4c 4155 4e43  , _SERVICE_LAUNC
-00022010: 4849 4e47 5f53 5441 5455 535f 5245 4745  HING_STATUS_REGE
-00022020: 5829 5d29 2c0a 0a20 2020 2020 2020 2020  X)]),..         
-00022030: 2020 2023 2057 6169 7420 756e 7469 6c20     # Wait until 
-00022040: 3220 7370 6f74 2069 6e73 7461 6e63 6573  2 spot instances
-00022050: 2061 7265 2072 6561 6479 2e0a 2020 2020   are ready..    
-00022060: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00022070: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-00022080: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00022090: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
-000220a0: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
-000220b0: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
-000220c0: 7374 6174 7573 286e 616d 652c 205b 2832  status(name, [(2
-000220d0: 2c20 5472 7565 2c20 2752 4541 4459 2729  , True, 'READY')
-000220e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000220f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022100: 2020 2020 2020 2020 2020 2020 2020 2830                (0
-00022110: 2c20 4661 6c73 652c 2027 2729 5d29 2c0a  , False, '')]),.
-00022120: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00022130: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
-00022140: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
-00022150: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-00022160: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-00022170: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00022180: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00022190: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
-000221a0: 7665 0a40 7079 7465 7374 2e6d 6172 6b2e  ve.@pytest.mark.
-000221b0: 6e6f 5f6b 7562 6572 6e65 7465 730a 6465  no_kubernetes.de
-000221c0: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
-000221d0: 7573 6572 5f62 7567 5f72 6573 7461 7274  user_bug_restart
-000221e0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-000221f0: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
-00022200: 7473 2074 6861 7420 7765 2072 6573 7461  ts that we resta
-00022210: 7274 2074 6865 2073 6572 7669 6365 2061  rt the service a
-00022220: 6674 6572 2075 7365 7220 6275 672e 2222  fter user bug.""
-00022230: 220a 2020 2020 2320 544f 444f 287a 6877  ".    # TODO(zhw
-00022240: 7529 3a20 7468 6973 2062 6568 6176 696f  u): this behavio
-00022250: 7220 6e65 6564 7320 736f 6d65 2072 6574  r needs some ret
-00022260: 6869 6e6b 696e 672e 0a20 2020 206e 616d  hinking..    nam
-00022270: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-00022280: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00022290: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000222a0: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
-000222b0: 2d75 7365 722d 6275 672d 7265 7374 6172  -user-bug-restar
-000222c0: 7427 2c0a 2020 2020 2020 2020 5b0a 2020  t',.        [.  
-000222d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000222e0: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
-000222f0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00022300: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
-00022310: 7374 732f 736b 7973 6572 7665 2f72 6573  sts/skyserve/res
-00022320: 7461 7274 2f75 7365 725f 6275 672e 7961  tart/user_bug.ya
-00022330: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00022340: 2066 2773 3d24 2873 6b79 2073 6572 7665   f's=$(sky serve
-00022350: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00022360: 2065 6368 6f20 2224 7322 3b27 0a20 2020   echo "$s";'.   
-00022370: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
-00022380: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-00022390: 202d 4132 2022 5365 7276 6963 6520 5265   -A2 "Service Re
-000223a0: 706c 6963 6173 2220 7c20 6772 6570 2022  plicas" | grep "
-000223b0: 5348 5554 5449 4e47 5f44 4f57 4e22 3b20  SHUTTING_DOWN"; 
-000223c0: 270a 2020 2020 2020 2020 2020 2020 2764  '.            'd
-000223d0: 6f20 6563 686f 2022 5761 6974 696e 6720  o echo "Waiting 
-000223e0: 666f 7220 6669 7273 7420 7365 7276 6963  for first servic
-000223f0: 6520 746f 2062 6520 5348 5554 5449 4e47  e to be SHUTTING
-00022400: 2044 4f57 4e2e 2e2e 223b 2027 0a20 2020   DOWN..."; '.   
-00022410: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-00022420: 2035 3b20 733d 2428 736b 7920 7365 7276   5; s=$(sky serv
-00022430: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
-00022440: 3b20 6563 686f 2022 2473 223b 2064 6f6e  ; echo "$s"; don
-00022450: 653b 2073 6c65 6570 2032 303b 2027 0a20  e; sleep 20; '. 
-00022460: 2020 2020 2020 2020 2020 202b 205f 5345             + _SE
-00022470: 5256 455f 5354 4154 5553 5f57 4149 542e  RVE_STATUS_WAIT.
-00022480: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00022490: 2920 2b0a 2020 2020 2020 2020 2020 2020  ) +.            
-000224a0: 2320 5768 656e 2074 6865 2066 6972 7374  # When the first
-000224b0: 2072 6570 6c69 6361 2069 7320 6465 7465   replica is dete
-000224c0: 6374 6564 2066 6169 6c65 642c 2074 6865  cted failed, the
-000224d0: 2063 6f6e 7472 6f6c 6c65 7220 7769 6c6c   controller will
-000224e0: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-000224f0: 7461 7274 2074 6f20 7072 6f76 6973 696f  tart to provisio
-00022500: 6e20 6120 6e65 7720 7265 706c 6963 612c  n a new replica,
-00022510: 2061 6e64 2073 6875 7420 646f 776e 2074   and shut down t
-00022520: 6865 2066 6972 7374 206f 6e65 2e0a 2020  he first one..  
-00022530: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00022540: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
-00022550: 7573 280a 2020 2020 2020 2020 2020 2020  us(.            
-00022560: 2020 2020 6e61 6d65 2c20 5b28 312c 2054      name, [(1, T
-00022570: 7275 652c 2027 5348 5554 5449 4e47 5f44  rue, 'SHUTTING_D
-00022580: 4f57 4e27 292c 0a20 2020 2020 2020 2020  OWN'),.         
-00022590: 2020 2020 2020 2020 2020 2020 2020 2831                (1
-000225a0: 2c20 5472 7565 2c20 5f53 4552 5649 4345  , True, _SERVICE
-000225b0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
-000225c0: 535f 5245 4745 5829 5d29 2c0a 2020 2020  S_REGEX)]),.    
-000225d0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-000225e0: 7920 7365 7276 6520 7374 6174 7573 207b  y serve status {
-000225f0: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-00022600: 223b 270a 2020 2020 2020 2020 2020 2020  ";'.            
-00022610: 2775 6e74 696c 2065 6368 6f20 2224 7322  'until echo "$s"
-00022620: 207c 2067 7265 7020 2d41 3220 2253 6572   | grep -A2 "Ser
-00022630: 7669 6365 2052 6570 6c69 6361 7322 207c  vice Replicas" |
-00022640: 2067 7265 7020 2246 4149 4c45 4422 3b20   grep "FAILED"; 
-00022650: 270a 2020 2020 2020 2020 2020 2020 2764  '.            'd
-00022660: 6f20 6563 686f 2022 5761 6974 696e 6720  o echo "Waiting 
-00022670: 666f 7220 6669 7273 7420 7365 7276 6963  for first servic
-00022680: 6520 746f 2062 6520 4641 494c 4544 2e2e  e to be FAILED..
-00022690: 2e22 3b20 270a 2020 2020 2020 2020 2020  ."; '.          
-000226a0: 2020 6627 736c 6565 7020 353b 2073 3d24    f'sleep 5; s=$
-000226b0: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
-000226c0: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
-000226d0: 2224 7322 3b20 646f 6e65 3b20 6563 686f  "$s"; done; echo
-000226e0: 2022 2473 223b 2027 0a20 2020 2020 2020   "$s"; '.       
-000226f0: 2020 2020 202b 205f 6368 6563 6b5f 7265       + _check_re
-00022700: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-00022710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022720: 206e 616d 652c 205b 2831 2c20 5472 7565   name, [(1, True
-00022730: 2c20 2746 4149 4c45 4427 292c 0a20 2020  , 'FAILED'),.   
-00022740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022750: 2020 2020 2831 2c20 5472 7565 2c20 5f53      (1, True, _S
-00022760: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
-00022770: 5f53 5441 5455 535f 5245 4745 5829 5d29  _STATUS_REGEX)])
-00022780: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00022790: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
-000227a0: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
-000227b0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-000227c0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-000227d0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-000227e0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000227f0: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
-00022800: 6572 7665 0a40 7079 7465 7374 2e6d 6172  erve.@pytest.mar
-00022810: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
-00022820: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
-00022830: 655f 6c6f 6164 5f62 616c 616e 6365 7228  e_load_balancer(
-00022840: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00022850: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-00022860: 2073 6b79 7365 7276 6520 6c6f 6164 2062   skyserve load b
-00022870: 616c 616e 6365 7220 726f 756e 642d 726f  alancer round-ro
-00022880: 6269 6e20 706f 6c69 6379 2222 220a 2020  bin policy""".  
-00022890: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
-000228a0: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
-000228b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-000228c0: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
-000228d0: 7365 7276 652d 6c6f 6164 2d62 616c 616e  serve-load-balan
-000228e0: 6365 7227 2c0a 2020 2020 2020 2020 5b0a  cer',.        [.
-000228f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00022900: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
-00022910: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00022920: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
-00022930: 7465 7374 732f 736b 7973 6572 7665 2f6c  tests/skyserve/l
-00022940: 6f61 645f 6261 6c61 6e63 6572 2f73 6572  oad_balancer/ser
-00022950: 7669 6365 2e79 616d 6c27 2c0a 2020 2020  vice.yaml',.    
-00022960: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00022970: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-00022980: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00022990: 2c20 7265 706c 6963 615f 6e75 6d3d 3329  , replica_num=3)
-000229a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000229b0: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
-000229c0: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-000229d0: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
-000229e0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-000229f0: 455f 5354 4154 5553 5f57 4149 542e 666f  E_STATUS_WAIT.fo
-00022a00: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00022a10: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00022a20: 6627 7b5f 6765 745f 7265 706c 6963 615f  f'{_get_replica_
-00022a30: 6970 286e 616d 652c 2031 297d 3b20 270a  ip(name, 1)}; '.
-00022a40: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00022a50: 6765 745f 7265 706c 6963 615f 6970 286e  get_replica_ip(n
-00022a60: 616d 652c 2032 297d 3b20 7b5f 6765 745f  ame, 2)}; {_get_
-00022a70: 7265 706c 6963 615f 6970 286e 616d 652c  replica_ip(name,
-00022a80: 2033 297d 3b20 270a 2020 2020 2020 2020   3)}; '.        
-00022a90: 2020 2020 2770 7974 686f 6e20 7465 7374      'python test
-00022aa0: 732f 736b 7973 6572 7665 2f6c 6f61 645f  s/skyserve/load_
-00022ab0: 6261 6c61 6e63 6572 2f74 6573 745f 726f  balancer/test_ro
-00022ac0: 756e 645f 726f 6269 6e2e 7079 2027 0a20  und_robin.py '. 
-00022ad0: 2020 2020 2020 2020 2020 2027 2d2d 656e             '--en
-00022ae0: 6470 6f69 6e74 2024 656e 6470 6f69 6e74  dpoint $endpoint
-00022af0: 202d 2d72 6570 6c69 6361 2d6e 756d 2033   --replica-num 3
-00022b00: 202d 2d72 6570 6c69 6361 2d69 7073 2024   --replica-ips $
-00022b10: 6970 3120 2469 7032 2024 6970 3327 2c0a  ip1 $ip2 $ip3',.
-00022b20: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00022b30: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
-00022b40: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
-00022b50: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-00022b60: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-00022b70: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00022b80: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00022b90: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-00022ba0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-00022bb0: 7276 650a 4070 7974 6573 742e 6d61 726b  rve.@pytest.mark
-00022bc0: 2e6e 6f5f 6b75 6265 726e 6574 6573 0a64  .no_kubernetes.d
-00022bd0: 6566 2074 6573 745f 736b 7973 6572 7665  ef test_skyserve
-00022be0: 5f61 7574 6f5f 7265 7374 6172 7428 293a  _auto_restart():
-00022bf0: 0a20 2020 2022 2222 5465 7374 2073 6b79  .    """Test sky
-00022c00: 7365 7276 6520 7769 7468 2061 7574 6f20  serve with auto 
-00022c10: 7265 7374 6172 7422 2222 0a20 2020 206e  restart""".    n
-00022c20: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
-00022c30: 6365 5f6e 616d 6528 290a 2020 2020 7a6f  ce_name().    zo
-00022c40: 6e65 203d 2027 7573 2d63 656e 7472 616c  ne = 'us-central
-00022c50: 312d 6127 0a20 2020 2074 6573 7420 3d20  1-a'.    test = 
-00022c60: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
-00022c70: 7465 7374 2d73 6b79 7365 7276 652d 6175  test-skyserve-au
-00022c80: 746f 2d72 6573 7461 7274 272c 0a20 2020  to-restart',.   
-00022c90: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00022ca0: 2020 2023 2054 4f44 4f28 7469 616e 293a     # TODO(tian):
-00022cb0: 2077 6520 6361 6e20 6479 6e61 6d69 6361   we can dynamica
-00022cc0: 6c6c 7920 6765 6e65 7261 7465 2059 414d  lly generate YAM
-00022cd0: 4c20 6672 6f6d 2074 656d 706c 6174 6520  L from template 
-00022ce0: 746f 0a20 2020 2020 2020 2020 2020 2023  to.            #
-00022cf0: 2061 766f 6964 206d 6169 6e74 6169 6e69   avoid maintaini
-00022d00: 6e67 2074 6f6f 206d 616e 7920 5941 4d4c  ng too many YAML
-00022d10: 2066 696c 6573 0a20 2020 2020 2020 2020   files.         
-00022d20: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00022d30: 7020 2d6e 207b 6e61 6d65 7d20 2d79 2074  p -n {name} -y t
-00022d40: 6573 7473 2f73 6b79 7365 7276 652f 6175  ests/skyserve/au
-00022d50: 746f 5f72 6573 7461 7274 2e79 616d 6c27  to_restart.yaml'
-00022d60: 2c0a 2020 2020 2020 2020 2020 2020 5f53  ,.            _S
-00022d70: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
-00022d80: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
-00022d90: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
-00022da0: 6e75 6d3d 3129 2c0a 2020 2020 2020 2020  num=1),.        
-00022db0: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
-00022dc0: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
-00022dd0: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
-00022de0: 270a 2020 2020 2020 2020 2020 2020 2763  '.            'c
-00022df0: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
-00022e00: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
-00022e10: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
-00022e20: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
-00022e30: 2023 2073 6c65 6570 2066 6f72 2032 3020   # sleep for 20 
-00022e40: 7365 636f 6e64 7320 2869 6e69 7469 616c  seconds (initial
-00022e50: 2064 656c 6179 2920 746f 206d 616b 6520   delay) to make 
-00022e60: 7375 7265 2069 7420 7769 6c6c 0a20 2020  sure it will.   
-00022e70: 2020 2020 2020 2020 2023 2062 6520 7265           # be re
-00022e80: 7374 6172 7465 640a 2020 2020 2020 2020  started.        
-00022e90: 2020 2020 6627 736c 6565 7020 3230 272c      f'sleep 20',
-00022ea0: 0a20 2020 2020 2020 2020 2020 205f 7465  .            _te
-00022eb0: 726d 696e 6174 655f 6763 705f 7265 706c  rminate_gcp_repl
-00022ec0: 6963 6128 6e61 6d65 2c20 7a6f 6e65 2c20  ica(name, zone, 
-00022ed0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
-00022ee0: 2320 5761 6974 2066 6f72 2063 6f6e 7365  # Wait for conse
-00022ef0: 6375 7469 7665 2066 6169 6c75 7265 2074  cutive failure t
-00022f00: 696d 656f 7574 2070 6173 7365 642e 0a20  imeout passed.. 
-00022f10: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-00022f20: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
-00022f30: 6f74 2075 7369 6e67 2073 706f 742c 2069  ot using spot, i
-00022f40: 7420 776f 6e27 7420 6368 6563 6b20 7468  t won't check th
-00022f50: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
-00022f60: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
-00022f70: 6e20 7468 6520 636c 6f75 6420 2873 696e  n the cloud (sin
-00022f80: 6365 206d 616e 7561 6c20 7368 7574 646f  ce manual shutdo
-00022f90: 776e 2069 7320 6e6f 7420 6120 636f 6d6d  wn is not a comm
-00022fa0: 6f6e 2062 6568 6176 696f 7220 616e 6420  on behavior and 
-00022fb0: 7375 6368 0a20 2020 2020 2020 2020 2020  such.           
-00022fc0: 2023 2071 7565 7269 6573 2074 616b 6573   # queries takes
-00022fd0: 2061 206c 6f74 206f 6620 7469 6d65 292e   a lot of time).
-00022fe0: 2049 6e73 7465 6164 2c20 7765 2074 6869   Instead, we thi
-00022ff0: 6e6b 2063 6f6e 7469 6e75 6f75 7320 3320  nk continuous 3 
-00023000: 6d69 6e20 7072 6f62 650a 2020 2020 2020  min probe.      
-00023010: 2020 2020 2020 2320 6661 696c 7572 6520        # failure 
-00023020: 6973 206e 6f74 2061 2074 656d 706f 7261  is not a tempora
-00023030: 7279 2070 726f 626c 656d 2062 7574 2069  ry problem but i
-00023040: 6e64 6565 6420 6120 6661 696c 7572 652e  ndeed a failure.
-00023050: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00023060: 6565 7020 3138 3027 2c0a 2020 2020 2020  eep 180',.      
-00023070: 2020 2020 2020 2320 5765 2063 616e 6e6f        # We canno
-00023080: 7420 7573 6520 5f53 4552 5645 5f57 4149  t use _SERVE_WAI
-00023090: 545f 554e 5449 4c5f 5245 4144 593b 2074  T_UNTIL_READY; t
-000230a0: 6865 7265 2077 696c 6c20 6265 2061 2069  here will be a i
-000230b0: 6e74 6572 6d65 6469 6174 6520 7469 6d65  ntermediate time
-000230c0: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-000230d0: 6861 7420 7468 6520 6f75 7470 7574 206f  hat the output o
-000230e0: 6620 6073 6b79 2073 6572 7665 2073 7461  f `sky serve sta
-000230f0: 7475 7360 2073 686f 7773 2046 4149 4c45  tus` shows FAILE
-00023100: 4420 616e 6420 7468 6973 2073 7461 7475  D and this statu
-00023110: 7320 7769 6c6c 0a20 2020 2020 2020 2020  s will.         
-00023120: 2020 2023 2063 6175 7365 205f 5345 5256     # cause _SERV
-00023130: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00023140: 4459 2074 6f20 6561 726c 7920 7175 6974  DY to early quit
-00023150: 2e0a 2020 2020 2020 2020 2020 2020 2728  ..            '(
-00023160: 7768 696c 6520 7472 7565 3b20 646f 270a  while true; do'.
-00023170: 2020 2020 2020 2020 2020 2020 6627 2020              f'  
-00023180: 2020 6f75 7470 7574 3d24 2873 6b79 2073    output=$(sky s
-00023190: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
-000231a0: 657d 293b 270a 2020 2020 2020 2020 2020  e});'.          
-000231b0: 2020 2720 2020 2020 6563 686f 2022 246f    '     echo "$o
-000231c0: 7574 7075 7422 207c 2067 7265 7020 2d71  utput" | grep -q
-000231d0: 2022 312f 3122 2026 2620 6272 6561 6b3b   "1/1" && break;
-000231e0: 270a 2020 2020 2020 2020 2020 2020 2720  '.            ' 
-000231f0: 2020 2020 736c 6565 7020 3130 3b27 0a20      sleep 10;'. 
-00023200: 2020 2020 2020 2020 2020 2066 2764 6f6e             f'don
-00023210: 6529 3b20 736c 6565 7020 7b73 6572 7665  e); sleep {serve
-00023220: 2e4c 425f 434f 4e54 524f 4c4c 4552 5f53  .LB_CONTROLLER_S
-00023230: 594e 435f 494e 5445 5256 414c 5f53 4543  YNC_INTERVAL_SEC
-00023240: 4f4e 4453 7d3b 272c 0a20 2020 2020 2020  ONDS};',.       
-00023250: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00023260: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00023270: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00023280: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00023290: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-000232a0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-000232b0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-000232c0: 7265 2227 2c0a 2020 2020 2020 2020 5d2c  re"',.        ],
-000232d0: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-000232e0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-000232f0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00023300: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00023310: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00023320: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00023330: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00023340: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
-00023350: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-00023360: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
-00023370: 7365 7276 655f 6361 6e63 656c 2867 656e  serve_cancel(gen
-00023380: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00023390: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
-000233a0: 7973 6572 7665 2077 6974 6820 6361 6e63  yserve with canc
-000233b0: 656c 2222 220a 2020 2020 6e61 6d65 203d  el""".    name =
-000233c0: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
-000233d0: 6d65 2829 0a0a 2020 2020 7465 7374 203d  me()..    test =
-000233e0: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
-000233f0: 2774 6573 742d 736b 7973 6572 7665 2d63  'test-skyserve-c
-00023400: 616e 6365 6c27 2c0a 2020 2020 2020 2020  ancel',.        
-00023410: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00023420: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
-00023430: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-00023440: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-00023450: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
-00023460: 2f63 616e 6365 6c2f 6361 6e63 656c 2e79  /cancel/cancel.y
-00023470: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00023480: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00023490: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-000234a0: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-000234b0: 6963 615f 6e75 6d3d 3129 2c0a 2020 2020  ica_num=1),.    
-000234c0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-000234d0: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-000234e0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-000234f0: 297d 3b20 7079 7468 6f6e 3320 270a 2020  )}; python3 '.  
-00023500: 2020 2020 2020 2020 2020 2774 6573 7473            'tests
-00023510: 2f73 6b79 7365 7276 652f 6361 6e63 656c  /skyserve/cancel
-00023520: 2f73 656e 645f 6361 6e63 656c 5f72 6571  /send_cancel_req
-00023530: 7565 7374 2e70 7920 270a 2020 2020 2020  uest.py '.      
-00023540: 2020 2020 2020 272d 2d65 6e64 706f 696e        '--endpoin
-00023550: 7420 2465 6e64 706f 696e 7420 7c20 6772  t $endpoint | gr
-00023560: 6570 2022 5265 7175 6573 7420 7761 7320  ep "Request was 
-00023570: 6361 6e63 656c 6c65 6422 272c 0a20 2020  cancelled"',.   
-00023580: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00023590: 6b79 2073 6572 7665 206c 6f67 7320 7b6e  ky serve logs {n
-000235a0: 616d 657d 2031 202d 2d6e 6f2d 666f 6c6c  ame} 1 --no-foll
-000235b0: 6f77 293b 2027 0a20 2020 2020 2020 2020  ow); '.         
-000235c0: 2020 2027 756e 7469 6c20 2120 6563 686f     'until ! echo
-000235d0: 2022 2473 2220 7c20 6772 6570 2022 506c   "$s" | grep "Pl
-000235e0: 6561 7365 2077 6169 7420 666f 7220 7468  ease wait for th
-000235f0: 6520 636f 6e74 726f 6c6c 6572 2074 6f20  e controller to 
-00023600: 6265 223b 2027 0a20 2020 2020 2020 2020  be"; '.         
-00023610: 2020 2027 646f 2065 6368 6f20 2257 6169     'do echo "Wai
-00023620: 7469 6e67 2066 6f72 2073 6572 7665 206c  ting for serve l
-00023630: 6f67 7322 3b20 736c 6565 7020 3130 3b20  ogs"; sleep 10; 
-00023640: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00023650: 733d 2428 736b 7920 7365 7276 6520 6c6f  s=$(sky serve lo
-00023660: 6773 207b 6e61 6d65 7d20 3120 2d2d 6e6f  gs {name} 1 --no
-00023670: 2d66 6f6c 6c6f 7729 3b20 646f 6e65 3b20  -follow); done; 
-00023680: 270a 2020 2020 2020 2020 2020 2020 2765  '.            'e
-00023690: 6368 6f20 2224 7322 3b20 6563 686f 2022  cho "$s"; echo "
-000236a0: 2473 2220 7c20 6772 6570 2022 436c 6965  $s" | grep "Clie
-000236b0: 6e74 2064 6973 636f 6e6e 6563 7465 642c  nt disconnected,
-000236c0: 2073 746f 7070 696e 6720 636f 6d70 7574   stopping comput
-000236d0: 6174 696f 6e22 272c 0a20 2020 2020 2020  ation"',.       
-000236e0: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
-000236f0: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
-00023700: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
-00023710: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-00023720: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-00023730: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00023740: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00023750: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
-00023760: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-00023770: 726e 6574 6573 0a64 6566 2074 6573 745f  rnetes.def test_
-00023780: 736b 7973 6572 7665 5f75 7064 6174 6528  skyserve_update(
-00023790: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-000237a0: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-000237b0: 2073 6b79 7365 7276 6520 7769 7468 2075   skyserve with u
-000237c0: 7064 6174 6522 2222 0a20 2020 206e 616d  pdate""".    nam
-000237d0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-000237e0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000237f0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00023800: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
-00023810: 2d75 7064 6174 6527 2c0a 2020 2020 2020  -update',.      
-00023820: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00023830: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
-00023840: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
-00023850: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00023860: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00023870: 7665 2f75 7064 6174 652f 6f6c 642e 7961  ve/update/old.ya
-00023880: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00023890: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-000238a0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-000238b0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-000238c0: 6361 5f6e 756d 3d32 292c 0a20 2020 2020  ca_num=2),.     
-000238d0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-000238e0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
-000238f0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00023900: 7d3b 2063 7572 6c20 2d4c 2068 7474 703a  }; curl -L http:
-00023910: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00023920: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00023930: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
-00023940: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-00023950: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
-00023960: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00023970: 636c 6f75 647d 202d 2d6d 6f64 6520 626c  cloud} --mode bl
-00023980: 7565 5f67 7265 656e 202d 7920 7465 7374  ue_green -y test
-00023990: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
-000239a0: 652f 6e65 772e 7961 6d6c 272c 0a20 2020  e/new.yaml',.   
-000239b0: 2020 2020 2020 2020 2023 2073 6c65 6570           # sleep
-000239c0: 2062 6566 6f72 6520 7570 6461 7465 2069   before update i
-000239d0: 7320 7265 6769 7374 6572 6564 2e0a 2020  s registered..  
-000239e0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000239f0: 2032 3027 2c0a 2020 2020 2020 2020 2020   20',.          
-00023a00: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00023a10: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00023a20: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-00023a30: 2020 2020 2020 2020 2020 2020 2775 6e74              'unt
-00023a40: 696c 2063 7572 6c20 2d4c 2068 7474 703a  il curl -L http:
-00023a50: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00023a60: 6570 2022 4869 2c20 6e65 7720 536b 7950  ep "Hi, new SkyP
-00023a70: 696c 6f74 2068 6572 6521 223b 2064 6f20  ilot here!"; do 
-00023a80: 736c 6565 7020 323b 2064 6f6e 653b 270a  sleep 2; done;'.
-00023a90: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-00023aa0: 6b65 2073 7572 6520 7468 6520 7472 6166  ke sure the traf
-00023ab0: 6669 6320 6973 206e 6f74 206d 6978 6564  fic is not mixed
-00023ac0: 0a20 2020 2020 2020 2020 2020 2027 6375  .            'cu
-00023ad0: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
-00023ae0: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
-00023af0: 692c 206e 6577 2053 6b79 5069 6c6f 7420  i, new SkyPilot 
-00023b00: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-00023b10: 2020 2020 2320 5468 6520 6c61 7465 7374      # The latest
-00023b20: 2032 2076 6572 7369 6f6e 2073 686f 756c   2 version shoul
-00023b30: 6420 6265 2052 4541 4459 2061 6e64 2074  d be READY and t
-00023b40: 6865 206f 6c64 6572 2076 6572 7369 6f6e  he older version
-00023b50: 7320 7368 6f75 6c64 2062 6520 7368 7574  s should be shut
-00023b60: 7469 6e67 2064 6f77 6e0a 2020 2020 2020  ting down.      
-00023b70: 2020 2020 2020 285f 6368 6563 6b5f 7265        (_check_re
-00023b80: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-00023b90: 6e61 6d65 2c20 5b28 322c 2046 616c 7365  name, [(2, False
-00023ba0: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
-00023bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023bd0: 2020 2020 2020 2020 2028 322c 2046 616c           (2, Fal
-00023be0: 7365 2c20 2753 4855 5454 494e 475f 444f  se, 'SHUTTING_DO
-00023bf0: 574e 2729 5d29 202b 0a20 2020 2020 2020  WN')]) +.       
-00023c00: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
-00023c10: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-00023c20: 652c 2022 3222 2929 2c0a 2020 2020 2020  e, "2")),.      
-00023c30: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
-00023c40: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
-00023c50: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00023c60: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00023c70: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-00023c80: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00023c90: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00023ca0: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
-00023cb0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
-00023cc0: 6572 6e65 7465 730a 6465 6620 7465 7374  ernetes.def test
-00023cd0: 5f73 6b79 7365 7276 655f 726f 6c6c 696e  _skyserve_rollin
-00023ce0: 675f 7570 6461 7465 2867 656e 6572 6963  g_update(generic
-00023cf0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00023d00: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
-00023d10: 7665 2077 6974 6820 726f 6c6c 696e 6720  ve with rolling 
-00023d20: 7570 6461 7465 2222 220a 2020 2020 6e61  update""".    na
-00023d30: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-00023d40: 655f 6e61 6d65 2829 0a20 2020 2073 696e  e_name().    sin
-00023d50: 676c 655f 6e65 775f 7265 706c 6963 6120  gle_new_replica 
-00023d60: 3d20 5f63 6865 636b 5f72 6570 6c69 6361  = _check_replica
-00023d70: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
-00023d80: 2020 2020 6e61 6d65 2c20 5b28 322c 2046      name, [(2, F
-00023d90: 616c 7365 2c20 2752 4541 4459 2729 2c20  alse, 'READY'), 
-00023da0: 2831 2c20 4661 6c73 652c 205f 5345 5256  (1, False, _SERV
-00023db0: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
-00023dc0: 4154 5553 5f52 4547 4558 292c 0a20 2020  ATUS_REGEX),.   
-00023dd0: 2020 2020 2020 2020 2020 2020 2831 2c20              (1, 
-00023de0: 4661 6c73 652c 2027 5348 5554 5449 4e47  False, 'SHUTTING
-00023df0: 5f44 4f57 4e27 295d 290a 2020 2020 7465  _DOWN')]).    te
-00023e00: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00023e10: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-00023e20: 7665 2d72 6f6c 6c69 6e67 2d75 7064 6174  ve-rolling-updat
-00023e30: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-00023e40: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00023e50: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
-00023e60: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00023e70: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
-00023e80: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
-00023e90: 6174 652f 6f6c 642e 7961 6d6c 272c 0a20  ate/old.yaml',. 
-00023ea0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00023eb0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00023ec0: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00023ed0: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-00023ee0: 3d32 292c 0a20 2020 2020 2020 2020 2020  =2),.           
-00023ef0: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-00023f00: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-00023f10: 6e61 6d65 3d6e 616d 6529 7d3b 2063 7572  name=name)}; cur
-00023f20: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-00023f30: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-00023f40: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-00023f50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00023f60: 2773 6b79 2073 6572 7665 2075 7064 6174  'sky serve updat
-00023f70: 6520 7b6e 616d 657d 202d 2d63 6c6f 7564  e {name} --cloud
-00023f80: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00023f90: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00023fa0: 7665 2f75 7064 6174 652f 6e65 772e 7961  ve/update/new.ya
-00023fb0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00023fc0: 2023 204d 616b 6520 7375 7265 2074 6865   # Make sure the
-00023fd0: 2074 7261 6666 6963 2069 7320 6d69 7865   traffic is mixe
-00023fe0: 6420 6163 726f 7373 2074 776f 2076 6572  d across two ver
-00023ff0: 7369 6f6e 732c 2074 6865 2072 6570 6c69  sions, the repli
-00024000: 6361 730a 2020 2020 2020 2020 2020 2020  cas.            
-00024010: 2320 7769 7468 2065 7665 6e20 6964 2077  # with even id w
-00024020: 696c 6c20 736c 6565 7020 3630 2073 6563  ill sleep 60 sec
-00024030: 6f6e 6473 2062 6566 6f72 6520 6265 696e  onds before bein
-00024040: 6720 7265 6164 792c 2073 6f20 7765 0a20  g ready, so we. 
-00024050: 2020 2020 2020 2020 2020 2023 2073 686f             # sho
-00024060: 756c 6420 6265 2061 626c 6520 746f 2067  uld be able to g
-00024070: 6574 206f 6273 6572 7665 2074 6865 2070  et observe the p
-00024080: 6572 696f 6420 7468 6174 2074 6865 2074  eriod that the t
-00024090: 7261 6666 6963 2069 7320 6d69 7865 640a  raffic is mixed.
-000240a0: 2020 2020 2020 2020 2020 2020 2320 6163              # ac
-000240b0: 726f 7373 2074 776f 2076 6572 7369 6f6e  ross two version
-000240c0: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
-000240d0: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-000240e0: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-000240f0: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
-00024100: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
-00024110: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00024120: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00024130: 2248 692c 206e 6577 2053 6b79 5069 6c6f  "Hi, new SkyPilo
-00024140: 7420 6865 7265 2122 3b20 646f 2073 6c65  t here!"; do sle
-00024150: 6570 2032 3b20 646f 6e65 3b20 270a 2020  ep 2; done; '.  
-00024160: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00024170: 6c61 7465 7374 2076 6572 7369 6f6e 2073  latest version s
-00024180: 686f 756c 6420 6861 7665 206f 6e65 2052  hould have one R
-00024190: 4541 4459 2061 6e64 2074 6865 206f 6e65  EADY and the one
-000241a0: 206f 6620 7468 6520 6f6c 6465 7220 7665   of the older ve
-000241b0: 7273 696f 6e73 2073 686f 756c 6420 6265  rsions should be
-000241c0: 2073 6875 7474 696e 6720 646f 776e 0a20   shutting down. 
-000241d0: 2020 2020 2020 2020 2020 2066 277b 7369             f'{si
-000241e0: 6e67 6c65 5f6e 6577 5f72 6570 6c69 6361  ngle_new_replica
-000241f0: 7d20 7b5f 6368 6563 6b5f 7365 7276 6963  } {_check_servic
-00024200: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
-00024210: 2231 2c32 2229 7d20 270a 2020 2020 2020  "1,2")} '.      
-00024220: 2020 2020 2020 2320 4368 6563 6b20 7468        # Check th
-00024230: 6520 6f75 7470 7574 2066 726f 6d20 7468  e output from th
-00024240: 6520 6f6c 6420 7665 7273 696f 6e2c 2069  e old version, i
-00024250: 6d6d 6564 6961 7465 6c79 2061 6674 6572  mmediately after
-00024260: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-00024270: 2023 206f 7574 7075 7420 6672 6f6d 2074   # output from t
-00024280: 6865 206e 6577 2076 6572 7369 6f6e 2061  he new version a
-00024290: 7070 6561 7273 2e20 5468 6973 2069 7320  ppears. This is 
-000242a0: 6775 6172 616e 7465 6564 2062 7920 7468  guaranteed by th
-000242b0: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-000242c0: 726f 756e 6420 726f 6269 6e20 6c6f 6164  round robin load
-000242d0: 2062 616c 616e 6369 6e67 2070 6f6c 6963   balancing polic
-000242e0: 792e 0a20 2020 2020 2020 2020 2020 2023  y..            #
-000242f0: 2054 4f44 4f28 7a68 7775 293a 2077 6520   TODO(zhwu): we 
-00024300: 7368 6f75 6c64 2068 6176 6520 6120 6d6f  should have a mo
-00024310: 7265 2067 656e 6572 616c 697a 6564 2077  re generalized w
-00024320: 6179 2066 6f72 2063 6865 636b 696e 6720  ay for checking 
-00024330: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-00024340: 2320 6d69 7865 6420 7665 7273 696f 6e20  # mixed version 
-00024350: 6f66 2072 6570 6c69 6361 7320 746f 2061  of replicas to a
-00024360: 766f 6964 2064 6570 656e 6469 6e67 206f  void depending o
-00024370: 6e20 7468 6520 7370 6563 6966 6963 0a20  n the specific. 
-00024380: 2020 2020 2020 2020 2020 2023 2072 6f75             # rou
-00024390: 6e64 2072 6f62 696e 206c 6f61 6420 6261  nd robin load ba
-000243a0: 6c61 6e63 696e 6720 706f 6c69 6379 2e0a  lancing policy..
-000243b0: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
-000243c0: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-000243d0: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-000243e0: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-000243f0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00024400: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-00024410: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-00024420: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00024430: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00024440: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00024450: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00024460: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00024470: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
-00024480: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-00024490: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-000244a0: 7665 5f66 6173 745f 7570 6461 7465 2867  ve_fast_update(g
-000244b0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-000244c0: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
-000244d0: 736b 7973 6572 7665 2077 6974 6820 6661  skyserve with fa
-000244e0: 7374 2075 7064 6174 6520 2849 6e63 7265  st update (Incre
-000244f0: 6d65 6e74 2076 6572 7369 6f6e 206f 6620  ment version of 
-00024500: 6f6c 6420 7265 706c 6963 6173 2922 2222  old replicas)"""
-00024510: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00024520: 5f73 6572 7669 6365 5f6e 616d 6528 290a  _service_name().
-00024530: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00024540: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-00024550: 2d73 6b79 7365 7276 652d 6661 7374 2d75  -skyserve-fast-u
-00024560: 7064 6174 6527 2c0a 2020 2020 2020 2020  pdate',.        
-00024570: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00024580: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
-00024590: 7b6e 616d 657d 202d 7920 2d2d 636c 6f75  {name} -y --clou
-000245a0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-000245b0: 7d20 7465 7374 732f 736b 7973 6572 7665  } tests/skyserve
-000245c0: 2f75 7064 6174 652f 6275 6d70 5f76 6572  /update/bump_ver
-000245d0: 7369 6f6e 5f62 6566 6f72 652e 7961 6d6c  sion_before.yaml
-000245e0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-000245f0: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00024600: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00024610: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00024620: 5f6e 756d 3d32 292c 0a20 2020 2020 2020  _num=2),.       
-00024630: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00024640: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00024650: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00024660: 2063 7572 6c20 2d4c 2068 7474 703a 2f2f   curl -L http://
-00024670: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-00024680: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-00024690: 6572 6522 272c 0a20 2020 2020 2020 2020  ere"',.         
-000246a0: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-000246b0: 7064 6174 6520 7b6e 616d 657d 202d 2d63  pdate {name} --c
-000246c0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-000246d0: 6f75 647d 202d 2d6d 6f64 6520 626c 7565  oud} --mode blue
-000246e0: 5f67 7265 656e 202d 7920 7465 7374 732f  _green -y tests/
-000246f0: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
-00024700: 6275 6d70 5f76 6572 7369 6f6e 5f61 6674  bump_version_aft
-00024710: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
-00024720: 2020 2020 2020 2320 736c 6565 7020 746f        # sleep to
-00024730: 2077 6169 7420 666f 7220 7570 6461 7465   wait for update
-00024740: 2074 6f20 6265 2072 6567 6973 7465 7265   to be registere
-00024750: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
-00024760: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-00024770: 2020 2020 2020 2020 2320 3220 6f6e 2d64          # 2 on-d
-00024780: 6561 6d6e 6420 2872 6561 6479 2920 2b20  eamnd (ready) + 
-00024790: 3120 6f6e 2d64 656d 616e 6420 2870 726f  1 on-demand (pro
-000247a0: 7669 7369 6f6e 696e 6729 2e0a 2020 2020  visioning)..    
-000247b0: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-000247c0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-000247d0: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
-000247e0: 7573 280a 2020 2020 2020 2020 2020 2020  us(.            
-000247f0: 2020 2020 2020 2020 6e61 6d65 2c20 5b28          name, [(
-00024800: 322c 2046 616c 7365 2c20 2752 4541 4459  2, False, 'READY
-00024810: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00024820: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00024830: 312c 2046 616c 7365 2c20 5f53 4552 5649  1, False, _SERVI
-00024840: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
-00024850: 5455 535f 5245 4745 5829 5d29 202b 0a20  TUS_REGEX)]) +. 
-00024860: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00024870: 2046 6173 7420 7570 6461 7465 2077 696c   Fast update wil
-00024880: 6c20 6469 7265 6374 6c79 2068 6176 6520  l directly have 
-00024890: 7468 6520 6c61 7465 7374 2076 6572 7369  the latest versi
-000248a0: 6f6e 2072 6561 6479 2e0a 2020 2020 2020  on ready..      
-000248b0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-000248c0: 5f73 6572 7669 6365 5f76 6572 7369 6f6e  _service_version
-000248d0: 286e 616d 652c 2022 3222 2929 2c0a 2020  (name, "2")),.  
-000248e0: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-000248f0: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00024900: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00024910: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00024920: 3329 202b 0a20 2020 2020 2020 2020 2020  3) +.           
-00024930: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
-00024940: 7665 7273 696f 6e28 6e61 6d65 2c20 2232  version(name, "2
-00024950: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00024960: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-00024970: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-00024980: 616d 653d 6e61 6d65 297d 3b20 6375 726c  ame=name)}; curl
-00024990: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
-000249a0: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
-000249b0: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
-000249c0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000249d0: 5465 7374 2072 6f6c 6c69 6e67 2075 7064  Test rolling upd
-000249e0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-000249f0: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
-00024a00: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
-00024a10: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00024a20: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
-00024a30: 7276 652f 7570 6461 7465 2f62 756d 705f  rve/update/bump_
-00024a40: 7665 7273 696f 6e5f 6265 666f 7265 2e79  version_before.y
-00024a50: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00024a60: 2020 2320 736c 6565 7020 746f 2077 6169    # sleep to wai
-00024a70: 7420 666f 7220 7570 6461 7465 2074 6f20  t for update to 
-00024a80: 6265 2072 6567 6973 7465 7265 642e 0a20  be registered.. 
-00024a90: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00024aa0: 7020 3330 272c 0a20 2020 2020 2020 2020  p 30',.         
-00024ab0: 2020 2023 2032 206f 6e2d 6465 616d 6e64     # 2 on-deamnd
-00024ac0: 2028 7265 6164 7929 202b 2031 206f 6e2d   (ready) + 1 on-
-00024ad0: 6465 6d61 6e64 2028 7368 7574 7469 6e67  demand (shutting
-00024ae0: 2064 6f77 6e29 2e0a 2020 2020 2020 2020   down)..        
-00024af0: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
-00024b00: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
-00024b10: 652c 205b 2832 2c20 4661 6c73 652c 2027  e, [(2, False, '
-00024b20: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
-00024b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024b50: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
-00024b60: 2753 4855 5454 494e 475f 444f 574e 2729  'SHUTTING_DOWN')
-00024b70: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-00024b80: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-00024b90: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-00024ba0: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-00024bb0: 615f 6e75 6d3d 3229 202b 0a20 2020 2020  a_num=2) +.     
-00024bc0: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
-00024bd0: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
-00024be0: 6d65 2c20 2233 2229 2c0a 2020 2020 2020  me, "3"),.      
-00024bf0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-00024c00: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00024c10: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00024c20: 3b20 6375 726c 202d 4c20 6874 7470 3a2f  ; curl -L http:/
-00024c30: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
-00024c40: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
-00024c50: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-00024c60: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
-00024c70: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
-00024c80: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
-00024c90: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00024ca0: 3330 202a 2036 302c 0a20 2020 2029 0a20  30 * 60,.    ). 
-00024cb0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00024cc0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00024cd0: 6d61 726b 2e73 6572 7665 0a40 7079 7465  mark.serve.@pyte
-00024ce0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
-00024cf0: 6e65 7465 730a 6465 6620 7465 7374 5f73  netes.def test_s
-00024d00: 6b79 7365 7276 655f 7570 6461 7465 5f61  kyserve_update_a
-00024d10: 7574 6f73 6361 6c65 2867 656e 6572 6963  utoscale(generic
-00024d20: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00024d30: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
-00024d40: 7665 2075 7064 6174 6520 7769 7468 2061  ve update with a
-00024d50: 7574 6f73 6361 6c65 2222 220a 2020 2020  utoscale""".    
-00024d60: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
-00024d70: 6963 655f 6e61 6d65 2829 0a20 2020 2074  ice_name().    t
-00024d80: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00024d90: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
-00024da0: 7276 652d 7570 6461 7465 2d61 7574 6f73  rve-update-autos
-00024db0: 6361 6c65 272c 0a20 2020 2020 2020 205b  cale',.        [
-00024dc0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00024dd0: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
-00024de0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00024df0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
-00024e00: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-00024e10: 7570 6461 7465 2f6e 756d 5f6d 696e 5f74  update/num_min_t
-00024e20: 776f 2e79 616d 6c27 2c0a 2020 2020 2020  wo.yaml',.      
-00024e30: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-00024e40: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-00024e50: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-00024e60: 7265 706c 6963 615f 6e75 6d3d 3229 202b  replica_num=2) +
-00024e70: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00024e80: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
-00024e90: 696f 6e28 6e61 6d65 2c20 2231 2229 2c0a  ion(name, "1"),.
-00024ea0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00024eb0: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
-00024ec0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-00024ed0: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
-00024ee0: 2020 2020 2020 2763 7572 6c20 2d4c 2068        'curl -L h
-00024ef0: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
-00024f00: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
-00024f10: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
-00024f20: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00024f30: 6572 7665 2075 7064 6174 6520 7b6e 616d  erve update {nam
-00024f40: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00024f50: 7269 635f 636c 6f75 647d 202d 2d6d 6f64  ric_cloud} --mod
-00024f60: 6520 626c 7565 5f67 7265 656e 202d 7920  e blue_green -y 
-00024f70: 7465 7374 732f 736b 7973 6572 7665 2f75  tests/skyserve/u
-00024f80: 7064 6174 652f 6e75 6d5f 6d69 6e5f 6f6e  pdate/num_min_on
-00024f90: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
-00024fa0: 2020 2020 2023 2073 6c65 6570 2062 6566       # sleep bef
-00024fb0: 6f72 6520 7570 6461 7465 2069 7320 7265  ore update is re
-00024fc0: 6769 7374 6572 6564 2e0a 2020 2020 2020  gistered..      
-00024fd0: 2020 2020 2020 2773 6c65 6570 2032 3027        'sleep 20'
-00024fe0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00024ff0: 5469 6d65 6f75 7420 7769 6c6c 2062 6520  Timeout will be 
-00025000: 7472 6967 6765 7265 6420 7768 656e 2075  triggered when u
-00025010: 7064 6174 6520 6661 696c 732e 0a20 2020  pdate fails..   
-00025020: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-00025030: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00025040: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00025050: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
-00025060: 2920 2b0a 2020 2020 2020 2020 2020 2020  ) +.            
-00025070: 5f63 6865 636b 5f73 6572 7669 6365 5f76  _check_service_v
-00025080: 6572 7369 6f6e 286e 616d 652c 2022 3222  ersion(name, "2"
-00025090: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-000250a0: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-000250b0: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-000250c0: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
-000250d0: 2020 2020 2020 2020 2027 6375 726c 202d           'curl -
-000250e0: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
-000250f0: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
-00025100: 6b79 5069 6c6f 7420 6865 7265 2122 272c  kyPilot here!"',
-00025110: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-00025120: 6f6c 6c69 6e67 2055 7064 6174 650a 2020  olling Update.  
-00025130: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00025140: 7365 7276 6520 7570 6461 7465 207b 6e61  serve update {na
-00025150: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00025160: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
-00025170: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
-00025180: 6461 7465 2f6e 756d 5f6d 696e 5f74 776f  date/num_min_two
-00025190: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-000251a0: 2020 2020 2320 736c 6565 7020 6265 666f      # sleep befo
-000251b0: 7265 2075 7064 6174 6520 6973 2072 6567  re update is reg
-000251c0: 6973 7465 7265 642e 0a20 2020 2020 2020  istered..       
-000251d0: 2020 2020 2027 736c 6565 7020 3230 272c       'sleep 20',
-000251e0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-000251f0: 696d 656f 7574 2077 696c 6c20 6265 2074  imeout will be t
-00025200: 7269 6767 6572 6564 2077 6865 6e20 7570  riggered when up
-00025210: 6461 7465 2066 6169 6c73 2e0a 2020 2020  date fails..    
-00025220: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00025230: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-00025240: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00025250: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
-00025260: 202b 0a20 2020 2020 2020 2020 2020 205f   +.            _
-00025270: 6368 6563 6b5f 7365 7276 6963 655f 7665  check_service_ve
-00025280: 7273 696f 6e28 6e61 6d65 2c20 2233 2229  rsion(name, "3")
-00025290: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000252a0: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
-000252b0: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-000252c0: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
-000252d0: 2020 2020 2020 2020 2763 7572 6c20 2d4c          'curl -L
-000252e0: 2068 7474 703a 2f2f 2465 6e64 706f 696e   http://$endpoin
-000252f0: 7420 7c20 6772 6570 2022 4869 2c20 536b  t | grep "Hi, Sk
-00025300: 7950 696c 6f74 2068 6572 6521 2227 2c0a  yPilot here!"',.
-00025310: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00025320: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
-00025330: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
-00025340: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-00025350: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
-00025360: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00025370: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00025380: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
-00025390: 7665 0a40 7079 7465 7374 2e6d 6172 6b2e  ve.@pytest.mark.
-000253a0: 7061 7261 6d65 7472 697a 6528 276d 6f64  parametrize('mod
-000253b0: 6527 2c20 5b27 726f 6c6c 696e 6727 2c20  e', ['rolling', 
-000253c0: 2762 6c75 655f 6772 6565 6e27 5d29 0a40  'blue_green']).@
-000253d0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
-000253e0: 7562 6572 6e65 7465 730a 6465 6620 7465  ubernetes.def te
-000253f0: 7374 5f73 6b79 7365 7276 655f 6e65 775f  st_skyserve_new_
-00025400: 6175 746f 7363 616c 6572 5f75 7064 6174  autoscaler_updat
-00025410: 6528 6d6f 6465 3a20 7374 722c 2067 656e  e(mode: str, gen
-00025420: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00025430: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
-00025440: 7973 6572 7665 2077 6974 6820 7570 6461  yserve with upda
-00025450: 7465 2074 6861 7420 6368 616e 6765 7320  te that changes 
-00025460: 6175 746f 7363 616c 6572 2222 220a 2020  autoscaler""".  
-00025470: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
-00025480: 7276 6963 655f 6e61 6d65 2829 202b 206d  rvice_name() + m
-00025490: 6f64 650a 0a20 2020 2066 6f75 725f 7370  ode..    four_sp
-000254a0: 6f74 5f75 705f 636d 6420 3d20 5f63 6865  ot_up_cmd = _che
-000254b0: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
-000254c0: 6174 7573 286e 616d 652c 205b 2834 2c20  atus(name, [(4, 
-000254d0: 5472 7565 2c20 2752 4541 4459 2729 5d29  True, 'READY')])
-000254e0: 0a20 2020 2075 7064 6174 655f 6368 6563  .    update_chec
-000254f0: 6b20 3d20 5b66 2775 6e74 696c 2028 7b66  k = [f'until ({f
-00025500: 6f75 725f 7370 6f74 5f75 705f 636d 647d  our_spot_up_cmd}
-00025510: 293b 2064 6f20 736c 6565 7020 353b 2064  ); do sleep 5; d
-00025520: 6f6e 653b 2073 6c65 6570 2031 303b 275d  one; sleep 10;']
-00025530: 0a20 2020 2069 6620 6d6f 6465 203d 3d20  .    if mode == 
-00025540: 2772 6f6c 6c69 6e67 273a 0a20 2020 2020  'rolling':.     
-00025550: 2020 2023 2043 6865 636b 2072 6f6c 6c69     # Check rolli
-00025560: 6e67 2075 7064 6174 652c 2069 7420 7769  ng update, it wi
-00025570: 6c6c 2074 6572 6d69 6e61 7465 206f 6e65  ll terminate one
-00025580: 206f 6620 7468 6520 6f6c 6420 6f6e 2d64   of the old on-d
-00025590: 656d 616e 640a 2020 2020 2020 2020 2320  emand.        # 
-000255a0: 696e 7374 616e 6365 732c 206f 6e63 6520  instances, once 
-000255b0: 7468 6572 6520 6172 6520 3420 7370 6f74  there are 4 spot
-000255c0: 2069 6e73 7461 6e63 6520 7265 6164 792e   instance ready.
-000255d0: 0a20 2020 2020 2020 2075 7064 6174 655f  .        update_
-000255e0: 6368 6563 6b20 2b3d 205b 0a20 2020 2020  check += [.     
-000255f0: 2020 2020 2020 205f 6368 6563 6b5f 7265         _check_re
-00025600: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-00025610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025620: 206e 616d 652c 205b 2831 2c20 4661 6c73   name, [(1, Fals
-00025630: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
-00025640: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
-00025650: 4558 292c 0a20 2020 2020 2020 2020 2020  EX),.           
-00025660: 2020 2020 2020 2020 2020 2020 2831 2c20              (1, 
-00025670: 4661 6c73 652c 2027 5348 5554 5449 4e47  False, 'SHUTTING
-00025680: 5f44 4f57 4e27 292c 2028 312c 2046 616c  _DOWN'), (1, Fal
-00025690: 7365 2c20 2752 4541 4459 2729 5d29 202b  se, 'READY')]) +
-000256a0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-000256b0: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
-000256c0: 696f 6e28 6e61 6d65 2c20 2231 2c32 2229  ion(name, "1,2")
-000256d0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
-000256e0: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-000256f0: 4368 6563 6b20 626c 7565 2067 7265 656e  Check blue green
-00025700: 2075 7064 6174 652c 2069 7420 7769 6c6c   update, it will
-00025710: 206b 6565 7020 626f 7468 206f 6c64 206f   keep both old o
-00025720: 6e2d 6465 6d61 6e64 2069 6e73 7461 6e63  n-demand instanc
-00025730: 6573 0a20 2020 2020 2020 2023 2072 756e  es.        # run
-00025740: 6e69 6e67 2c20 6f6e 6365 2074 6865 7265  ning, once there
-00025750: 2061 7265 2034 2073 706f 7420 696e 7374   are 4 spot inst
-00025760: 616e 6365 2072 6561 6479 2e0a 2020 2020  ance ready..    
-00025770: 2020 2020 7570 6461 7465 5f63 6865 636b      update_check
-00025780: 202b 3d20 5b0a 2020 2020 2020 2020 2020   += [.          
-00025790: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
-000257a0: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
-000257b0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-000257c0: 2c20 5b28 312c 2046 616c 7365 2c20 5f53  , [(1, False, _S
-000257d0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
-000257e0: 5f53 5441 5455 535f 5245 4745 5829 2c0a  _STATUS_REGEX),.
-000257f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025800: 2020 2020 2020 2028 322c 2046 616c 7365         (2, False
-00025810: 2c20 2752 4541 4459 2729 5d29 202b 0a20  , 'READY')]) +. 
-00025820: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00025830: 6b5f 7365 7276 6963 655f 7665 7273 696f  k_service_versio
-00025840: 6e28 6e61 6d65 2c20 2231 2229 2c0a 2020  n(name, "1"),.  
-00025850: 2020 2020 2020 5d0a 2020 2020 7465 7374        ].    test
-00025860: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00025870: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
-00025880: 2d6e 6577 2d61 7574 6f73 6361 6c65 722d  -new-autoscaler-
-00025890: 7570 6461 7465 272c 0a20 2020 2020 2020  update',.       
-000258a0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000258b0: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
-000258c0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-000258d0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-000258e0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-000258f0: 652f 7570 6461 7465 2f6e 6577 5f61 7574  e/update/new_aut
-00025900: 6f73 6361 6c65 725f 6265 666f 7265 2e79  oscaler_before.y
-00025910: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00025920: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00025930: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00025940: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00025950: 6963 615f 6e75 6d3d 3229 202b 0a20 2020  ica_num=2) +.   
-00025960: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00025970: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
-00025980: 6e61 6d65 2c20 2231 2229 2c0a 2020 2020  name, "1"),.    
-00025990: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-000259a0: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-000259b0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-000259c0: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
-000259d0: 2020 2773 3d24 2863 7572 6c20 2d4c 2068    's=$(curl -L h
-000259e0: 7474 703a 2f2f 2465 6e64 706f 696e 7429  ttp://$endpoint)
-000259f0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00025a00: 6f20 2224 7322 207c 2067 7265 7020 2248  o "$s" | grep "H
-00025a10: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
-00025a20: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00025a30: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
-00025a40: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
-00025a50: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00025a60: 7d20 2d2d 6d6f 6465 207b 6d6f 6465 7d20  } --mode {mode} 
-00025a70: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-00025a80: 652f 7570 6461 7465 2f6e 6577 5f61 7574  e/update/new_aut
-00025a90: 6f73 6361 6c65 725f 6166 7465 722e 7961  oscaler_after.ya
-00025aa0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00025ab0: 2023 2057 6169 7420 666f 7220 7570 6461   # Wait for upda
-00025ac0: 7465 2074 6f20 6265 2072 6567 6973 7465  te to be registe
-00025ad0: 7265 640a 2020 2020 2020 2020 2020 2020  red.            
-00025ae0: 6627 736c 6565 7020 3132 3027 2c0a 2020  f'sleep 120',.  
-00025af0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00025b00: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
-00025b10: 7573 280a 2020 2020 2020 2020 2020 2020  us(.            
-00025b20: 2020 2020 6e61 6d65 2c20 5b28 342c 2054      name, [(4, T
-00025b30: 7275 652c 205f 5345 5256 4943 455f 4c41  rue, _SERVICE_LA
-00025b40: 554e 4348 494e 475f 5354 4154 5553 5f52  UNCHING_STATUS_R
-00025b50: 4547 4558 202b 2027 5c7c 5245 4144 5927  EGEX + '\|READY'
-00025b60: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00025b70: 2020 2020 2020 2020 2020 2831 2c20 4661            (1, Fa
-00025b80: 6c73 652c 205f 5345 5256 4943 455f 4c41  lse, _SERVICE_LA
-00025b90: 554e 4348 494e 475f 5354 4154 5553 5f52  UNCHING_STATUS_R
-00025ba0: 4547 4558 292c 0a20 2020 2020 2020 2020  EGEX),.         
-00025bb0: 2020 2020 2020 2020 2020 2020 2020 2832                (2
-00025bc0: 2c20 4661 6c73 652c 2027 5245 4144 5927  , False, 'READY'
-00025bd0: 295d 292c 0a20 2020 2020 2020 2020 2020  )]),.           
-00025be0: 202a 7570 6461 7465 5f63 6865 636b 2c0a   *update_check,.
-00025bf0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
-00025c00: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-00025c10: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
-00025c20: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
-00025c30: 6d3d 3529 2c0a 2020 2020 2020 2020 2020  m=5),.          
-00025c40: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00025c50: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00025c60: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-00025c70: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
-00025c80: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-00025c90: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-00025ca0: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-00025cb0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00025cc0: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
-00025cd0: 5f73 7461 7475 7328 6e61 6d65 2c20 5b28  _status(name, [(
-00025ce0: 342c 2054 7275 652c 2027 5245 4144 5927  4, True, 'READY'
-00025cf0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00025d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d10: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00025d20: 312c 2046 616c 7365 2c20 2752 4541 4459  1, False, 'READY
-00025d30: 2729 5d29 2c0a 2020 2020 2020 2020 5d2c  ')]),.        ],
-00025d40: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00025d50: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00025d60: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00025d70: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00025d80: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00025d90: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00025da0: 7374 290a 0a0a 2320 544f 444f 285a 696d  st)...# TODO(Zim
-00025db0: 696e 672c 2054 6961 6e29 3a20 4164 6420  ing, Tian): Add 
-00025dc0: 7465 7374 7320 666f 7220 6175 746f 7363  tests for autosc
-00025dd0: 616c 696e 672e 0a0a 0a23 202d 2d2d 2d2d  aling....# -----
-00025de0: 2d2d 2054 6573 7469 6e67 2075 7365 7220  -- Testing user 
-00025df0: 7261 7920 636c 7573 7465 7220 2d2d 2d2d  ray cluster ----
-00025e00: 2d2d 2d2d 0a64 6566 2074 6573 745f 7573  ----.def test_us
-00025e10: 6572 5f72 6179 5f63 6c75 7374 6572 2867  er_ray_cluster(g
-00025e20: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-00025e30: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-00025e40: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00025e50: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00025e60: 7374 280a 2020 2020 2020 2020 2775 7365  st(.        'use
-00025e70: 722d 7261 792d 636c 7573 7465 7227 2c0a  r-ray-cluster',.
-00025e80: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00025e90: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00025ea0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00025eb0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00025ec0: 5f63 6c6f 7564 7d20 2272 6179 2073 7461  _cloud} "ray sta
-00025ed0: 7274 202d 2d68 6561 6422 272c 0a20 2020  rt --head"',.   
-00025ee0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00025ef0: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
-00025f00: 2068 6922 272c 0a20 2020 2020 2020 2020   hi"',.         
-00025f10: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00025f20: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-00025f30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00025f40: 736b 7920 7374 6174 7573 202d 7220 7b6e  sky status -r {n
-00025f50: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
-00025f60: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00025f70: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00025f80: 6563 686f 2062 7965 2227 2c0a 2020 2020  echo bye"',.    
-00025f90: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00025fa0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-00025fb0: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-00025fc0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00025fd0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00025fe0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00025ff0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00026000: 2320 2d2d 2d2d 2d2d 2d20 5465 7374 696e  # ------- Testin
-00026010: 6720 7468 6520 636f 7265 2041 5049 202d  g the core API -
-00026020: 2d2d 2d2d 2d2d 2d0a 2320 4d6f 7374 206f  -------.# Most o
-00026030: 6620 7468 6520 636f 7265 2041 5049 7320  f the core APIs 
-00026040: 6861 7665 2062 6565 6e20 7465 7374 6564  have been tested
-00026050: 2069 6e20 7468 6520 434c 4920 7465 7374   in the CLI test
-00026060: 732e 0a23 2054 6865 7365 2074 6573 7473  s..# These tests
-00026070: 2061 7265 2066 6f72 2074 6573 7469 6e67   are for testing
-00026080: 2074 6865 2072 6574 7572 6e20 7661 6c75   the return valu
-00026090: 6520 6f66 2074 6865 2041 5049 7320 6e6f  e of the APIs no
-000260a0: 7420 6675 6c6c 7920 7573 6564 2069 6e20  t fully used in 
-000260b0: 434c 492e 0a0a 0a40 7079 7465 7374 2e6d  CLI....@pytest.m
-000260c0: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
-000260d0: 5f63 6f72 655f 6170 695f 736b 795f 6c61  _core_api_sky_la
-000260e0: 756e 6368 5f65 7865 6328 293a 0a20 2020  unch_exec():.   
-000260f0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00026100: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00026110: 7461 736b 203d 2073 6b79 2e54 6173 6b28  task = sky.Task(
-00026120: 7275 6e3d 2277 686f 616d 6922 290a 2020  run="whoami").  
-00026130: 2020 7461 736b 2e73 6574 5f72 6573 6f75    task.set_resou
-00026140: 7263 6573 2873 6b79 2e52 6573 6f75 7263  rces(sky.Resourc
-00026150: 6573 2863 6c6f 7564 3d73 6b79 2e47 4350  es(cloud=sky.GCP
-00026160: 2829 2929 0a20 2020 206a 6f62 5f69 642c  ())).    job_id,
-00026170: 2068 616e 646c 6520 3d20 736b 792e 6c61   handle = sky.la
-00026180: 756e 6368 2874 6173 6b2c 2063 6c75 7374  unch(task, clust
-00026190: 6572 5f6e 616d 653d 6e61 6d65 290a 2020  er_name=name).  
-000261a0: 2020 6173 7365 7274 206a 6f62 5f69 6420    assert job_id 
-000261b0: 3d3d 2031 0a20 2020 2061 7373 6572 7420  == 1.    assert 
-000261c0: 6861 6e64 6c65 2069 7320 6e6f 7420 4e6f  handle is not No
-000261d0: 6e65 0a20 2020 2061 7373 6572 7420 6861  ne.    assert ha
-000261e0: 6e64 6c65 2e63 6c75 7374 6572 5f6e 616d  ndle.cluster_nam
-000261f0: 6520 3d3d 206e 616d 650a 2020 2020 6173  e == name.    as
-00026200: 7365 7274 2068 616e 646c 652e 6c61 756e  sert handle.laun
-00026210: 6368 6564 5f72 6573 6f75 7263 6573 2e63  ched_resources.c
-00026220: 6c6f 7564 2e69 735f 7361 6d65 5f63 6c6f  loud.is_same_clo
-00026230: 7564 2873 6b79 2e47 4350 2829 290a 2020  ud(sky.GCP()).  
-00026240: 2020 6a6f 625f 6964 5f65 7865 632c 2068    job_id_exec, h
-00026250: 616e 646c 655f 6578 6563 203d 2073 6b79  andle_exec = sky
-00026260: 2e65 7865 6328 7461 736b 2c20 636c 7573  .exec(task, clus
-00026270: 7465 725f 6e61 6d65 3d6e 616d 6529 0a20  ter_name=name). 
-00026280: 2020 2061 7373 6572 7420 6a6f 625f 6964     assert job_id
-00026290: 5f65 7865 6320 3d3d 2032 0a20 2020 2061  _exec == 2.    a
-000262a0: 7373 6572 7420 6861 6e64 6c65 5f65 7865  ssert handle_exe
-000262b0: 6320 6973 206e 6f74 204e 6f6e 650a 2020  c is not None.  
-000262c0: 2020 6173 7365 7274 2068 616e 646c 655f    assert handle_
-000262d0: 6578 6563 2e63 6c75 7374 6572 5f6e 616d  exec.cluster_nam
-000262e0: 6520 3d3d 206e 616d 650a 2020 2020 6173  e == name.    as
-000262f0: 7365 7274 2068 616e 646c 655f 6578 6563  sert handle_exec
-00026300: 2e6c 6175 6e63 6865 645f 7265 736f 7572  .launched_resour
-00026310: 6365 732e 636c 6f75 642e 6973 5f73 616d  ces.cloud.is_sam
-00026320: 655f 636c 6f75 6428 736b 792e 4743 5028  e_cloud(sky.GCP(
-00026330: 2929 0a20 2020 2023 2046 6f72 2064 756d  )).    # For dum
-00026340: 6d79 2074 6173 6b20 2869 2e65 2e20 7461  my task (i.e. ta
-00026350: 736b 2e72 756e 2069 7320 4e6f 6e65 292c  sk.run is None),
-00026360: 2074 6865 206a 6f62 2077 6f6e 2774 2062   the job won't b
-00026370: 6520 7375 626d 6974 7465 642e 0a20 2020  e submitted..   
-00026380: 2064 756d 6d79 5f74 6173 6b20 3d20 736b   dummy_task = sk
-00026390: 792e 5461 736b 2829 0a20 2020 206a 6f62  y.Task().    job
-000263a0: 5f69 645f 6475 6d6d 792c 205f 203d 2073  _id_dummy, _ = s
-000263b0: 6b79 2e65 7865 6328 6475 6d6d 795f 7461  ky.exec(dummy_ta
-000263c0: 736b 2c20 636c 7573 7465 725f 6e61 6d65  sk, cluster_name
-000263d0: 3d6e 616d 6529 0a20 2020 2061 7373 6572  =name).    asser
-000263e0: 7420 6a6f 625f 6964 5f64 756d 6d79 2069  t job_id_dummy i
-000263f0: 7320 4e6f 6e65 0a20 2020 2073 6b79 2e64  s None.    sky.d
-00026400: 6f77 6e28 6e61 6d65 290a 0a0a 2320 2d2d  own(name)...# --
-00026410: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-00026420: 2053 746f 7261 6765 202d 2d2d 2d2d 2d2d   Storage -------
-00026430: 2d2d 2d0a 636c 6173 7320 5465 7374 5374  ---.class TestSt
-00026440: 6f72 6167 6557 6974 6843 7265 6465 6e74  orageWithCredent
-00026450: 6961 6c73 3a0a 2020 2020 2222 2253 746f  ials:.    """Sto
-00026460: 7261 6765 2074 6573 7473 2077 6869 6368  rage tests which
-00026470: 2072 6571 7569 7265 2063 7265 6465 6e74   require credent
-00026480: 6961 6c73 2061 6e64 206e 6574 776f 726b  ials and network
-00026490: 2063 6f6e 6e65 6374 696f 6e22 2222 0a0a   connection"""..
-000264a0: 2020 2020 4157 535f 494e 5641 4c49 445f      AWS_INVALID_
-000264b0: 4e41 4d45 5320 3d20 5b0a 2020 2020 2020  NAMES = [.      
-000264c0: 2020 2761 6227 2c20 2023 206c 6573 7320    'ab',  # less 
-000264d0: 7468 616e 2033 2063 6861 7261 6374 6572  than 3 character
-000264e0: 730a 2020 2020 2020 2020 2761 6263 6465  s.        'abcde
-000264f0: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
-00026500: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
-00026510: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
-00026520: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
-00026530: 7273 7475 7677 7879 7a31 272c 0a20 2020  rstuvwxyz1',.   
-00026540: 2020 2020 2023 206d 6f72 6520 7468 616e       # more than
-00026550: 2036 3320 6368 6172 6163 7465 7273 0a20   63 characters. 
-00026560: 2020 2020 2020 2027 4162 6364 6566 272c         'Abcdef',
-00026570: 2020 2320 636f 6e74 6169 6e73 2061 6e20    # contains an 
-00026580: 7570 7065 7263 6173 6520 6c65 7474 6572  uppercase letter
-00026590: 0a20 2020 2020 2020 2027 6162 6320 6465  .        'abc de
-000265a0: 6627 2c20 2023 2063 6f6e 7461 696e 7320  f',  # contains 
-000265b0: 6120 7370 6163 650a 2020 2020 2020 2020  a space.        
-000265c0: 2761 6263 2e2e 6465 6627 2c20 2023 2074  'abc..def',  # t
-000265d0: 776f 2061 646a 6163 656e 7420 7065 7269  wo adjacent peri
-000265e0: 6f64 730a 2020 2020 2020 2020 2731 3932  ods.        '192
-000265f0: 2e31 3638 2e35 2e34 272c 2020 2320 666f  .168.5.4',  # fo
-00026600: 726d 6174 7465 6420 6173 2061 6e20 4950  rmatted as an IP
-00026610: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
-00026620: 2027 786e 2d2d 6275 636b 6574 272c 2020   'xn--bucket',  
-00026630: 2320 7374 6172 7473 2077 6974 6820 2778  # starts with 'x
-00026640: 6e2d 2d27 2070 7265 6669 780a 2020 2020  n--' prefix.    
-00026650: 2020 2020 2762 7563 6b65 742d 7333 616c      'bucket-s3al
-00026660: 6961 7327 2c20 2023 2065 6e64 7320 7769  ias',  # ends wi
-00026670: 7468 2027 2d73 3361 6c69 6173 2720 7375  th '-s3alias' su
-00026680: 6666 6978 0a20 2020 2020 2020 2027 6275  ffix.        'bu
-00026690: 636b 6574 2d2d 6f6c 2d73 3327 2c20 2023  cket--ol-s3',  #
-000266a0: 2065 6e64 7320 7769 7468 2027 2d2d 6f6c   ends with '--ol
-000266b0: 2d73 3327 2073 7566 6669 780a 2020 2020  -s3' suffix.    
-000266c0: 2020 2020 272e 6162 6327 2c20 2023 2073      '.abc',  # s
-000266d0: 7461 7274 7320 7769 7468 2061 2064 6f74  tarts with a dot
-000266e0: 0a20 2020 2020 2020 2027 6162 632e 272c  .        'abc.',
-000266f0: 2020 2320 656e 6473 2077 6974 6820 6120    # ends with a 
-00026700: 646f 740a 2020 2020 2020 2020 272d 6162  dot.        '-ab
-00026710: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
-00026720: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
-00026730: 2020 2020 2761 6263 2d27 2c20 2023 2065      'abc-',  # e
-00026740: 6e64 7320 7769 7468 2061 2068 7970 6865  nds with a hyphe
-00026750: 6e0a 2020 2020 5d0a 0a20 2020 2047 4353  n.    ]..    GCS
-00026760: 5f49 4e56 414c 4944 5f4e 414d 4553 203d  _INVALID_NAMES =
-00026770: 205b 0a20 2020 2020 2020 2027 6162 272c   [.        'ab',
-00026780: 2020 2320 6c65 7373 2074 6861 6e20 3320    # less than 3 
-00026790: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
-000267a0: 2020 2027 6162 6364 6566 6768 696a 6b6c     'abcdefghijkl
-000267b0: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
-000267c0: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
-000267d0: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
-000267e0: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
-000267f0: 797a 3127 2c0a 2020 2020 2020 2020 2320  yz1',.        # 
-00026800: 6d6f 7265 2074 6861 6e20 3633 2063 6861  more than 63 cha
-00026810: 7261 6374 6572 7320 2877 6974 686f 7574  racters (without
-00026820: 2064 6f74 7329 0a20 2020 2020 2020 2027   dots).        '
-00026830: 4162 6364 6566 272c 2020 2320 636f 6e74  Abcdef',  # cont
-00026840: 6169 6e73 2061 6e20 7570 7065 7263 6173  ains an uppercas
-00026850: 6520 6c65 7474 6572 0a20 2020 2020 2020  e letter.       
-00026860: 2027 6162 6320 6465 6627 2c20 2023 2063   'abc def',  # c
-00026870: 6f6e 7461 696e 7320 6120 7370 6163 650a  ontains a space.
-00026880: 2020 2020 2020 2020 2761 6263 2e2e 6465          'abc..de
-00026890: 6627 2c20 2023 2074 776f 2061 646a 6163  f',  # two adjac
-000268a0: 656e 7420 7065 7269 6f64 730a 2020 2020  ent periods.    
-000268b0: 2020 2020 2761 6263 5f2e 6465 662e 6768      'abc_.def.gh
-000268c0: 692e 6a6b 6c6d 6e6f 7071 7273 7475 7677  i.jklmnopqrstuvw
-000268d0: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
-000268e0: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
-000268f0: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-00026900: 7475 7677 7879 7a31 270a 2020 2020 2020  tuvwxyz1'.      
-00026910: 2020 2320 4d6f 7265 2074 6861 6e20 3633    # More than 63
-00026920: 2063 6861 7261 6374 6572 7320 6265 7477   characters betw
-00026930: 6565 6e20 646f 7473 0a20 2020 2020 2020  een dots.       
-00026940: 2027 6162 635f 2e64 6566 2e67 6869 2e6a   'abc_.def.ghi.j
-00026950: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-00026960: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
-00026970: 7166 6768 696a 6b6c 6d6e 6f70 7172 7374  qfghijklmnopqrst
-00026980: 7576 7727 202a 2035 2c0a 2020 2020 2020  uvw' * 5,.      
-00026990: 2020 2320 6d6f 7265 2074 6861 6e20 3232    # more than 22
-000269a0: 3220 6368 6172 6163 7465 7273 2028 7769  2 characters (wi
-000269b0: 7468 2064 6f74 7329 0a20 2020 2020 2020  th dots).       
-000269c0: 2027 3139 322e 3136 382e 352e 3427 2c20   '192.168.5.4', 
-000269d0: 2023 2066 6f72 6d61 7474 6564 2061 7320   # formatted as 
-000269e0: 616e 2049 5020 6164 6472 6573 730a 2020  an IP address.  
-000269f0: 2020 2020 2020 2767 6f6f 6762 7563 6b65        'googbucke
-00026a00: 7427 2c20 2023 2073 7461 7274 7320 7769  t',  # starts wi
-00026a10: 7468 2027 676f 6f67 2720 7072 6566 6978  th 'goog' prefix
-00026a20: 0a20 2020 2020 2020 2027 676f 6f67 6c65  .        'google
-00026a30: 6275 636b 6574 272c 2020 2320 636f 6e74  bucket',  # cont
-00026a40: 6169 6e73 2027 676f 6f67 6c65 270a 2020  ains 'google'.  
-00026a50: 2020 2020 2020 2767 3030 676c 6562 7563        'g00glebuc
-00026a60: 6b65 7427 2c20 2023 2076 6172 6961 6e74  ket',  # variant
-00026a70: 206f 6620 2767 6f6f 676c 6527 0a20 2020   of 'google'.   
-00026a80: 2020 2020 2027 676f 3067 6c65 6275 636b       'go0glebuck
-00026a90: 6574 272c 2020 2320 7661 7269 616e 7420  et',  # variant 
-00026aa0: 6f66 2027 676f 6f67 6c65 270a 2020 2020  of 'google'.    
-00026ab0: 2020 2020 2767 306f 676c 6562 7563 6b65      'g0oglebucke
-00026ac0: 7427 2c20 2023 2076 6172 6961 6e74 206f  t',  # variant o
-00026ad0: 6620 2767 6f6f 676c 6527 0a20 2020 2020  f 'google'.     
-00026ae0: 2020 2027 2e61 6263 272c 2020 2320 7374     '.abc',  # st
-00026af0: 6172 7473 2077 6974 6820 6120 646f 740a  arts with a dot.
-00026b00: 2020 2020 2020 2020 2761 6263 2e27 2c20          'abc.', 
-00026b10: 2023 2065 6e64 7320 7769 7468 2061 2064   # ends with a d
-00026b20: 6f74 0a20 2020 2020 2020 2027 5f61 6263  ot.        '_abc
-00026b30: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
-00026b40: 6820 616e 2075 6e64 6572 7363 6f72 650a  h an underscore.
-00026b50: 2020 2020 2020 2020 2761 6263 5f27 2c20          'abc_', 
-00026b60: 2023 2065 6e64 7320 7769 7468 2061 6e20   # ends with an 
-00026b70: 756e 6465 7273 636f 7265 0a20 2020 205d  underscore.    ]
-00026b80: 0a0a 2020 2020 4942 4d5f 494e 5641 4c49  ..    IBM_INVALI
-00026b90: 445f 4e41 4d45 5320 3d20 5b0a 2020 2020  D_NAMES = [.    
-00026ba0: 2020 2020 2761 6227 2c20 2023 206c 6573      'ab',  # les
-00026bb0: 7320 7468 616e 2033 2063 6861 7261 6374  s than 3 charact
-00026bc0: 6572 730a 2020 2020 2020 2020 2761 6263  ers.        'abc
-00026bd0: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-00026be0: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
-00026bf0: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
-00026c00: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
-00026c10: 7071 7273 7475 7677 7879 7a31 272c 0a20  pqrstuvwxyz1',. 
-00026c20: 2020 2020 2020 2023 206d 6f72 6520 7468         # more th
-00026c30: 616e 2036 3320 6368 6172 6163 7465 7273  an 63 characters
-00026c40: 0a20 2020 2020 2020 2027 4162 6364 6566  .        'Abcdef
-00026c50: 272c 2020 2320 636f 6e74 6169 6e73 2061  ',  # contains a
-00026c60: 6e20 7570 7065 7263 6173 6520 6c65 7474  n uppercase lett
-00026c70: 6572 0a20 2020 2020 2020 2027 6162 6320  er.        'abc 
-00026c80: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
-00026c90: 7320 6120 7370 6163 650a 2020 2020 2020  s a space.      
-00026ca0: 2020 2761 6263 2e2e 6465 6627 2c20 2023    'abc..def',  #
-00026cb0: 2074 776f 2061 646a 6163 656e 7420 7065   two adjacent pe
-00026cc0: 7269 6f64 730a 2020 2020 2020 2020 2731  riods.        '1
-00026cd0: 3932 2e31 3638 2e35 2e34 272c 2020 2320  92.168.5.4',  # 
-00026ce0: 666f 726d 6174 7465 6420 6173 2061 6e20  formatted as an 
-00026cf0: 4950 2061 6464 7265 7373 0a20 2020 2020  IP address.     
-00026d00: 2020 2027 786e 2d2d 6275 636b 6574 272c     'xn--bucket',
-00026d10: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
-00026d20: 2778 6e2d 2d27 2070 7265 6669 780a 2020  'xn--' prefix.  
-00026d30: 2020 2020 2020 272e 6162 6327 2c20 2023        '.abc',  #
-00026d40: 2073 7461 7274 7320 7769 7468 2061 2064   starts with a d
-00026d50: 6f74 0a20 2020 2020 2020 2027 6162 632e  ot.        'abc.
-00026d60: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
-00026d70: 6120 646f 740a 2020 2020 2020 2020 272d  a dot.        '-
-00026d80: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
-00026d90: 7769 7468 2061 2068 7970 6865 6e0a 2020  with a hyphen.  
-00026da0: 2020 2020 2020 2761 6263 2d27 2c20 2023        'abc-',  #
-00026db0: 2065 6e64 7320 7769 7468 2061 2068 7970   ends with a hyp
-00026dc0: 6865 6e0a 2020 2020 2020 2020 2761 2e2d  hen.        'a.-
-00026dd0: 6263 272c 2020 2320 636f 6e74 6169 6e73  bc',  # contains
-00026de0: 2074 6865 2073 6571 7565 6e63 6520 272e   the sequence '.
-00026df0: 2d27 0a20 2020 2020 2020 2027 612d 2e62  -'.        'a-.b
-00026e00: 6327 2c20 2023 2063 6f6e 7461 696e 7320  c',  # contains 
-00026e10: 7468 6520 7365 7175 656e 6365 2027 2d2e  the sequence '-.
-00026e20: 270a 2020 2020 2020 2020 2761 2662 6327  '.        'a&bc'
-00026e30: 2020 2320 636f 6e74 6169 6e73 2073 7065    # contains spe
-00026e40: 6369 616c 2063 6861 7261 6374 6572 730a  cial characters.
-00026e50: 2020 2020 2020 2020 2761 625e 6327 2020          'ab^c'  
-00026e60: 2320 636f 6e74 6169 6e73 2073 7065 6369  # contains speci
-00026e70: 616c 2063 6861 7261 6374 6572 730a 2020  al characters.  
-00026e80: 2020 5d0a 2020 2020 4749 5449 474e 4f52    ].    GITIGNOR
-00026e90: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
-00026ea0: 5354 5255 4354 5552 4520 3d20 7b0a 2020  STRUCTURE = {.  
-00026eb0: 2020 2020 2020 2764 6f75 626c 655f 6173        'double_as
-00026ec0: 7465 7269 736b 273a 207b 0a20 2020 2020  terisk': {.     
-00026ed0: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
-00026ee0: 7374 6572 6973 6b5f 6578 636c 7564 6564  sterisk_excluded
-00026ef0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00026f00: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
-00026f10: 6572 6973 6b5f 6578 636c 7564 6564 5f64  erisk_excluded_d
-00026f20: 6972 273a 207b 0a20 2020 2020 2020 2020  ir': {.         
-00026f30: 2020 2020 2020 2027 6469 725f 6578 636c         'dir_excl
-00026f40: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-00026f50: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00026f60: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
-00026f70: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
-00026f80: 7061 7265 6e74 273a 207b 0a20 2020 2020  parent': {.     
-00026f90: 2020 2020 2020 2027 7061 7265 6e74 273a         'parent':
-00026fa0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00026fb0: 2020 2027 616c 736f 5f65 7863 6c75 6465     'also_exclude
-00026fc0: 642e 7478 7427 3a20 4e6f 6e65 2c0a 2020  d.txt': None,.  
-00026fd0: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-00026fe0: 6869 6c64 273a 207b 0a20 2020 2020 2020  hild': {.       
-00026ff0: 2020 2020 2020 2020 2020 2020 2027 646f               'do
-00027000: 7562 6c65 5f61 7374 6572 6973 6b5f 7061  uble_asterisk_pa
-00027010: 7265 6e74 5f63 6869 6c64 5f65 7863 6c75  rent_child_exclu
-00027020: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
-00027030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027040: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-00027050: 2020 2027 646f 7562 6c65 5f61 7374 6572     'double_aster
-00027060: 6973 6b5f 7061 7265 6e74 5f65 7863 6c75  isk_parent_exclu
-00027070: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
-00027080: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-00027090: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-000270a0: 2020 2765 7863 6c75 6465 642e 6c6f 6727    'excluded.log'
-000270b0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-000270c0: 2765 7863 6c75 6465 645f 6469 7227 3a20  'excluded_dir': 
-000270d0: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-000270e0: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
-000270f0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00027100: 276e 6573 7465 645f 6578 636c 7564 6564  'nested_excluded
-00027110: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00027120: 2020 2020 2027 6578 636c 7564 6564 273a       'excluded':
-00027130: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00027140: 2020 207d 2c0a 2020 2020 2020 2020 7d2c     },.        },
-00027150: 0a20 2020 2020 2020 2027 6578 702d 3127  .        'exp-1'
-00027160: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00027170: 2762 655f 6578 636c 7564 6564 273a 204e  'be_excluded': N
-00027180: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
-00027190: 2020 2020 2020 2020 2765 7870 2d32 273a          'exp-2':
-000271a0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-000271b0: 6265 5f65 7863 6c75 6465 6427 3a20 4e6f  be_excluded': No
-000271c0: 6e65 2c0a 2020 2020 2020 2020 7d2c 0a20  ne,.        },. 
-000271d0: 2020 2020 2020 2027 6672 6f6e 745f 736c         'front_sl
-000271e0: 6173 685f 6578 636c 7564 6564 273a 204e  ash_excluded': N
-000271f0: 6f6e 652c 0a20 2020 2020 2020 2027 696e  one,.        'in
-00027200: 636c 7564 6564 2e6c 6f67 273a 204e 6f6e  cluded.log': Non
-00027210: 652c 0a20 2020 2020 2020 2027 696e 636c  e,.        'incl
-00027220: 7564 6564 2e74 7874 273a 204e 6f6e 652c  uded.txt': None,
-00027230: 0a20 2020 2020 2020 2027 696e 636c 7564  .        'includ
-00027240: 655f 6469 7227 3a20 7b0a 2020 2020 2020  e_dir': {.      
-00027250: 2020 2020 2020 2765 7863 6c75 6465 642e        'excluded.
-00027260: 6c6f 6727 3a20 4e6f 6e65 2c0a 2020 2020  log': None,.    
-00027270: 2020 2020 2020 2020 2769 6e63 6c75 6465          'include
-00027280: 642e 6c6f 6727 3a20 4e6f 6e65 2c0a 2020  d.log': None,.  
-00027290: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-000272a0: 2027 6e65 7374 6564 5f64 6f75 626c 655f   'nested_double_
-000272b0: 6173 7465 7269 736b 273a 207b 0a20 2020  asterisk': {.   
-000272c0: 2020 2020 2020 2020 2027 6f6e 6527 3a20           'one': 
-000272d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000272e0: 2020 2761 6c73 6f5f 6578 636c 7564 652e    'also_exclude.
-000272f0: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
-00027300: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00027310: 2020 2020 2020 2027 7477 6f27 3a20 7b0a         'two': {.
-00027320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027330: 2761 6c73 6f5f 6578 636c 7564 652e 7478  'also_exclude.tx
-00027340: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-00027350: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00027360: 207d 2c0a 2020 2020 2020 2020 276e 6573   },.        'nes
-00027370: 7465 645f 7769 6c64 6361 7264 5f64 6972  ted_wildcard_dir
-00027380: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00027390: 2027 6d6f 6e64 6179 273a 207b 0a20 2020   'monday': {.   
-000273a0: 2020 2020 2020 2020 2020 2020 2027 616c               'al
-000273b0: 736f 5f65 7863 6c75 6465 2e74 7874 273a  so_exclude.txt':
-000273c0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-000273d0: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-000273e0: 2020 2774 7565 7364 6179 273a 207b 0a20    'tuesday': {. 
-000273f0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00027400: 616c 736f 5f65 7863 6c75 6465 2e74 7874  also_exclude.txt
-00027410: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00027420: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00027430: 7d2c 0a20 2020 2020 2020 2027 6e6f 5f73  },.        'no_s
-00027440: 6c61 7368 5f65 7863 6c75 6465 6427 3a20  lash_excluded': 
-00027450: 4e6f 6e65 2c0a 2020 2020 2020 2020 276e  None,.        'n
-00027460: 6f5f 736c 6173 685f 7465 7374 7327 3a20  o_slash_tests': 
-00027470: 7b0a 2020 2020 2020 2020 2020 2020 276e  {.            'n
-00027480: 6f5f 736c 6173 685f 6578 636c 7564 6564  o_slash_excluded
-00027490: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-000274a0: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
-000274b0: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
-000274c0: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-000274d0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-000274e0: 2020 2771 7565 7374 696f 6e5f 6d61 726b    'question_mark
-000274f0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00027500: 2027 6578 636c 7564 6564 312e 7478 7427   'excluded1.txt'
-00027510: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00027520: 2020 2020 2765 7863 6c75 6465 6440 2e74      'excluded@.t
-00027530: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
-00027540: 2020 207d 2c0a 2020 2020 2020 2020 2773     },.        's
-00027550: 7175 6172 655f 6272 6163 6b65 7427 3a20  quare_bracket': 
-00027560: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-00027570: 7863 6c75 6465 6431 2e74 7874 273a 204e  xcluded1.txt': N
-00027580: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
-00027590: 2020 2020 2020 2020 2773 7175 6172 655f          'square_
-000275a0: 6272 6163 6b65 745f 616c 7068 6127 3a20  bracket_alpha': 
-000275b0: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-000275c0: 7863 6c75 6465 647a 2e74 7874 273a 204e  xcludedz.txt': N
-000275d0: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
-000275e0: 2020 2020 2020 2020 2773 7175 6172 655f          'square_
-000275f0: 6272 6163 6b65 745f 6578 636c 6127 3a20  bracket_excla': 
-00027600: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-00027610: 7863 6c75 6465 6432 2e74 7874 273a 204e  xcluded2.txt': N
-00027620: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00027630: 2027 6578 636c 7564 6564 402e 7478 7427   'excluded@.txt'
-00027640: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00027650: 7d2c 0a20 2020 2020 2020 2027 7371 7561  },.        'squa
-00027660: 7265 5f62 7261 636b 6574 5f73 696e 676c  re_bracket_singl
-00027670: 6527 3a20 7b0a 2020 2020 2020 2020 2020  e': {.          
-00027680: 2020 2765 7863 6c75 6465 6430 2e74 7874    'excluded0.txt
-00027690: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-000276a0: 207d 2c0a 2020 2020 7d0a 0a20 2020 2040   },.    }..    @
-000276b0: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-000276c0: 2064 6566 2063 7265 6174 655f 6469 725f   def create_dir_
-000276d0: 7374 7275 6374 7572 6528 6261 7365 5f70  structure(base_p
-000276e0: 6174 682c 2073 7472 7563 7475 7265 293a  ath, structure):
-000276f0: 0a20 2020 2020 2020 2023 2063 7265 6174  .        # creat
-00027700: 6573 2061 2067 6976 656e 2066 696c 6520  es a given file 
-00027710: 5354 5255 4354 5552 4520 696e 2042 4153  STRUCTURE in BAS
-00027720: 455f 5041 5448 0a20 2020 2020 2020 2066  E_PATH.        f
-00027730: 6f72 206e 616d 652c 2073 7562 7374 7275  or name, substru
-00027740: 6374 7572 6520 696e 2073 7472 7563 7475  cture in structu
-00027750: 7265 2e69 7465 6d73 2829 3a0a 2020 2020  re.items():.    
-00027760: 2020 2020 2020 2020 7061 7468 203d 206f          path = o
-00027770: 732e 7061 7468 2e6a 6f69 6e28 6261 7365  s.path.join(base
-00027780: 5f70 6174 682c 206e 616d 6529 0a20 2020  _path, name).   
-00027790: 2020 2020 2020 2020 2069 6620 7375 6273           if subs
-000277a0: 7472 7563 7475 7265 2069 7320 4e6f 6e65  tructure is None
-000277b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000277c0: 2020 2320 4372 6561 7465 2061 2066 696c    # Create a fil
-000277d0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000277e0: 2020 6f70 656e 2870 6174 682c 2027 6127    open(path, 'a'
-000277f0: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
-00027800: 3827 292e 636c 6f73 6528 290a 2020 2020  8').close().    
-00027810: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00027820: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00027830: 4372 6561 7465 2061 2073 7562 6469 7265  Create a subdire
-00027840: 6374 6f72 790a 2020 2020 2020 2020 2020  ctory.          
-00027850: 2020 2020 2020 6f73 2e6d 6b64 6972 2870        os.mkdir(p
-00027860: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-00027870: 2020 2020 2054 6573 7453 746f 7261 6765       TestStorage
-00027880: 5769 7468 4372 6564 656e 7469 616c 732e  WithCredentials.
-00027890: 6372 6561 7465 5f64 6972 5f73 7472 7563  create_dir_struc
-000278a0: 7475 7265 280a 2020 2020 2020 2020 2020  ture(.          
-000278b0: 2020 2020 2020 2020 2020 7061 7468 2c20            path, 
-000278c0: 7375 6273 7472 7563 7475 7265 290a 0a20  substructure).. 
-000278d0: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-000278e0: 0a20 2020 2064 6566 2063 6c69 5f64 656c  .    def cli_del
-000278f0: 6574 655f 636d 6428 7374 6f72 655f 7479  ete_cmd(store_ty
-00027900: 7065 2c20 6275 636b 6574 5f6e 616d 6529  pe, bucket_name)
-00027910: 3a0a 2020 2020 2020 2020 6966 2073 746f  :.        if sto
-00027920: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-00027930: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00027940: 2e53 333a 0a20 2020 2020 2020 2020 2020  .S3:.           
-00027950: 2075 726c 203d 2066 2773 333a 2f2f 7b62   url = f's3://{b
-00027960: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
-00027970: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00027980: 6627 6177 7320 7333 2072 6220 7b75 726c  f'aws s3 rb {url
-00027990: 7d20 2d2d 666f 7263 6527 0a20 2020 2020  } --force'.     
-000279a0: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
-000279b0: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
-000279c0: 5374 6f72 6554 7970 652e 4743 533a 0a20  StoreType.GCS:. 
-000279d0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
-000279e0: 2066 2767 733a 2f2f 7b62 7563 6b65 745f   f'gs://{bucket_
-000279f0: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
-00027a00: 2020 2067 7375 7469 6c5f 616c 6961 732c     gsutil_alias,
-00027a10: 2061 6c69 6173 5f67 656e 203d 2064 6174   alias_gen = dat
-00027a20: 615f 7574 696c 732e 6765 745f 6773 7574  a_utils.get_gsut
-00027a30: 696c 5f63 6f6d 6d61 6e64 2829 0a20 2020  il_command().   
-00027a40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00027a50: 6627 7b61 6c69 6173 5f67 656e 7d3b 207b  f'{alias_gen}; {
-00027a60: 6773 7574 696c 5f61 6c69 6173 7d20 726d  gsutil_alias} rm
-00027a70: 202d 7220 7b75 726c 7d27 0a20 2020 2020   -r {url}'.     
-00027a80: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
-00027a90: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
-00027aa0: 5374 6f72 6554 7970 652e 5232 3a0a 2020  StoreType.R2:.  
-00027ab0: 2020 2020 2020 2020 2020 656e 6470 6f69            endpoi
-00027ac0: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
-00027ad0: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
-00027ae0: 696e 7428 290a 2020 2020 2020 2020 2020  int().          
-00027af0: 2020 7572 6c20 3d20 6627 7333 3a2f 2f7b    url = f's3://{
-00027b00: 6275 636b 6574 5f6e 616d 657d 270a 2020  bucket_name}'.  
-00027b10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00027b20: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
-00027b30: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
-00027b40: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
-00027b50: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
-00027b60: 6177 7320 7333 2072 6220 7b75 726c 7d20  aws s3 rb {url} 
-00027b70: 2d2d 666f 7263 6520 2d2d 656e 6470 6f69  --force --endpoi
-00027b80: 6e74 207b 656e 6470 6f69 6e74 5f75 726c  nt {endpoint_url
-00027b90: 7d20 2d2d 7072 6f66 696c 653d 7232 270a  } --profile=r2'.
-00027ba0: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-00027bb0: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-00027bc0: 5f6c 6962 2e53 746f 7265 5479 7065 2e49  _lib.StoreType.I
-00027bd0: 424d 3a0a 2020 2020 2020 2020 2020 2020  BM:.            
-00027be0: 6275 636b 6574 5f72 636c 6f6e 655f 7072  bucket_rclone_pr
-00027bf0: 6f66 696c 6520 3d20 5263 6c6f 6e65 2e67  ofile = Rclone.g
-00027c00: 656e 6572 6174 655f 7263 6c6f 6e65 5f62  enerate_rclone_b
-00027c10: 7563 6b65 745f 7072 6f66 696c 655f 6e61  ucket_profile_na
-00027c20: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
-00027c30: 2020 2020 6275 636b 6574 5f6e 616d 652c      bucket_name,
-00027c40: 2052 636c 6f6e 652e 5263 6c6f 6e65 436c   Rclone.RcloneCl
-00027c50: 6f75 6473 2e49 424d 290a 2020 2020 2020  ouds.IBM).      
-00027c60: 2020 2020 2020 7265 7475 726e 2066 2772        return f'r
-00027c70: 636c 6f6e 6520 7075 7267 6520 7b62 7563  clone purge {buc
-00027c80: 6b65 745f 7263 6c6f 6e65 5f70 726f 6669  ket_rclone_profi
-00027c90: 6c65 7d3a 7b62 7563 6b65 745f 6e61 6d65  le}:{bucket_name
-00027ca0: 7d20 2626 2072 636c 6f6e 6520 636f 6e66  } && rclone conf
-00027cb0: 6967 2064 656c 6574 6520 7b62 7563 6b65  ig delete {bucke
-00027cc0: 745f 7263 6c6f 6e65 5f70 726f 6669 6c65  t_rclone_profile
-00027cd0: 7d27 0a0a 2020 2020 4073 7461 7469 636d  }'..    @staticm
-00027ce0: 6574 686f 640a 2020 2020 6465 6620 636c  ethod.    def cl
-00027cf0: 695f 6c73 5f63 6d64 2873 746f 7265 5f74  i_ls_cmd(store_t
-00027d00: 7970 652c 2062 7563 6b65 745f 6e61 6d65  ype, bucket_name
-00027d10: 2c20 7375 6666 6978 3d27 2729 3a0a 2020  , suffix=''):.  
-00027d20: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
-00027d30: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
-00027d40: 6962 2e53 746f 7265 5479 7065 2e53 333a  ib.StoreType.S3:
-00027d50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00027d60: 7375 6666 6978 3a0a 2020 2020 2020 2020  suffix:.        
-00027d70: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
-00027d80: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
-00027d90: 657d 2f7b 7375 6666 6978 7d27 0a20 2020  e}/{suffix}'.   
-00027da0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00027db0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00027dc0: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
-00027dd0: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
-00027de0: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-00027df0: 6177 7320 7333 206c 7320 7b75 726c 7d27  aws s3 ls {url}'
-00027e00: 0a20 2020 2020 2020 2069 6620 7374 6f72  .        if stor
-00027e10: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-00027e20: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00027e30: 4743 533a 0a20 2020 2020 2020 2020 2020  GCS:.           
-00027e40: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
-00027e50: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
-00027e60: 3d20 6627 6773 3a2f 2f7b 6275 636b 6574  = f'gs://{bucket
-00027e70: 5f6e 616d 657d 2f7b 7375 6666 6978 7d27  _name}/{suffix}'
-00027e80: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00027e90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00027ea0: 2020 2075 726c 203d 2066 2767 733a 2f2f     url = f'gs://
-00027eb0: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
-00027ec0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00027ed0: 6e20 6627 6773 7574 696c 206c 7320 7b75  n f'gsutil ls {u
-00027ee0: 726c 7d27 0a20 2020 2020 2020 2069 6620  rl}'.        if 
-00027ef0: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
-00027f00: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00027f10: 7970 652e 5232 3a0a 2020 2020 2020 2020  ype.R2:.        
-00027f20: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
-00027f30: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
-00027f40: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
-00027f50: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00027f60: 7566 6669 783a 0a20 2020 2020 2020 2020  uffix:.         
-00027f70: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
-00027f80: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-00027f90: 7d2f 7b73 7566 6669 787d 270a 2020 2020  }/{suffix}'.    
-00027fa0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00027fb0: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-00027fc0: 6c20 3d20 6627 7333 3a2f 2f7b 6275 636b  l = f's3://{buck
-00027fd0: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
-00027fe0: 2020 2020 2020 7265 7475 726e 2066 2741        return f'A
-00027ff0: 5753 5f53 4841 5245 445f 4352 4544 454e  WS_SHARED_CREDEN
-00028000: 5449 414c 535f 4649 4c45 3d7b 636c 6f75  TIALS_FILE={clou
-00028010: 6466 6c61 7265 2e52 325f 4352 4544 454e  dflare.R2_CREDEN
-00028020: 5449 414c 535f 5041 5448 7d20 6177 7320  TIALS_PATH} aws 
-00028030: 7333 206c 7320 7b75 726c 7d20 2d2d 656e  s3 ls {url} --en
-00028040: 6470 6f69 6e74 207b 656e 6470 6f69 6e74  dpoint {endpoint
-00028050: 5f75 726c 7d20 2d2d 7072 6f66 696c 653d  _url} --profile=
-00028060: 7232 270a 2020 2020 2020 2020 6966 2073  r2'.        if s
-00028070: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
-00028080: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00028090: 7065 2e49 424d 3a0a 2020 2020 2020 2020  pe.IBM:.        
-000280a0: 2020 2020 6275 636b 6574 5f72 636c 6f6e      bucket_rclon
-000280b0: 655f 7072 6f66 696c 6520 3d20 5263 6c6f  e_profile = Rclo
-000280c0: 6e65 2e67 656e 6572 6174 655f 7263 6c6f  ne.generate_rclo
-000280d0: 6e65 5f62 7563 6b65 745f 7072 6f66 696c  ne_bucket_profil
-000280e0: 655f 6e61 6d65 280a 2020 2020 2020 2020  e_name(.        
-000280f0: 2020 2020 2020 2020 6275 636b 6574 5f6e          bucket_n
-00028100: 616d 652c 2052 636c 6f6e 652e 5263 6c6f  ame, Rclone.Rclo
-00028110: 6e65 436c 6f75 6473 2e49 424d 290a 2020  neClouds.IBM).  
-00028120: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00028130: 2066 2772 636c 6f6e 6520 6c73 207b 6275   f'rclone ls {bu
-00028140: 636b 6574 5f72 636c 6f6e 655f 7072 6f66  cket_rclone_prof
-00028150: 696c 657d 3a7b 6275 636b 6574 5f6e 616d  ile}:{bucket_nam
-00028160: 657d 2f7b 7375 6666 6978 7d27 0a0a 2020  e}/{suffix}'..  
-00028170: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
-00028180: 2020 2020 6465 6620 636c 695f 7265 6769      def cli_regi
-00028190: 6f6e 5f63 6d64 2873 746f 7265 5f74 7970  on_cmd(store_typ
-000281a0: 652c 2062 7563 6b65 745f 6e61 6d65 293a  e, bucket_name):
-000281b0: 0a20 2020 2020 2020 2069 6620 7374 6f72  .        if stor
-000281c0: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-000281d0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-000281e0: 5333 3a0a 2020 2020 2020 2020 2020 2020  S3:.            
-000281f0: 7265 7475 726e 2028 2761 7773 2073 3361  return ('aws s3a
-00028200: 7069 2067 6574 2d62 7563 6b65 742d 6c6f  pi get-bucket-lo
-00028210: 6361 7469 6f6e 2027 0a20 2020 2020 2020  cation '.       
-00028220: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-00028230: 2d62 7563 6b65 7420 7b62 7563 6b65 745f  -bucket {bucket_
-00028240: 6e61 6d65 7d20 2d2d 6f75 7470 7574 2074  name} --output t
-00028250: 6578 7427 290a 2020 2020 2020 2020 656c  ext').        el
-00028260: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
-00028270: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00028280: 7265 5479 7065 2e47 4353 3a0a 2020 2020  reType.GCS:.    
-00028290: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-000282a0: 6627 6773 7574 696c 206c 7320 2d4c 202d  f'gsutil ls -L -
-000282b0: 6220 6773 3a2f 2f7b 6275 636b 6574 5f6e  b gs://{bucket_n
-000282c0: 616d 657d 2f20 7c20 270a 2020 2020 2020  ame}/ | '.      
-000282d0: 2020 2020 2020 2020 2020 2020 2020 2767                'g
-000282e0: 7265 7020 224c 6f63 6174 696f 6e20 636f  rep "Location co
-000282f0: 6e73 7472 6169 6e74 2220 7c20 270a 2020  nstraint" | '.  
-00028300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028310: 2020 2761 776b 205c 277b 7072 696e 7420    'awk \'{print 
-00028320: 746f 6c6f 7765 7228 244e 4629 7d5c 2727  tolower($NF)}\''
-00028330: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00028340: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00028350: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
-00028360: 4572 726f 7228 6627 5265 6769 6f6e 2063  Error(f'Region c
-00028370: 6f6d 6d61 6e64 206e 6f74 2069 6d70 6c65  ommand not imple
-00028380: 6d65 6e74 6564 2066 6f72 2027 0a20 2020  mented for '.   
-00028390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000283a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000283b0: 2020 2066 277b 7374 6f72 655f 7479 7065     f'{store_type
-000283c0: 7d27 290a 0a20 2020 2040 7374 6174 6963  }')..    @static
-000283d0: 6d65 7468 6f64 0a20 2020 2064 6566 2063  method.    def c
-000283e0: 6c69 5f63 6f75 6e74 5f6e 616d 655f 696e  li_count_name_in
-000283f0: 5f62 7563 6b65 7428 7374 6f72 655f 7479  _bucket(store_ty
-00028400: 7065 2c20 6275 636b 6574 5f6e 616d 652c  pe, bucket_name,
-00028410: 2066 696c 655f 6e61 6d65 2c20 7375 6666   file_name, suff
-00028420: 6978 3d27 2729 3a0a 2020 2020 2020 2020  ix=''):.        
-00028430: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
-00028440: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00028450: 7265 5479 7065 2e53 333a 0a20 2020 2020  reType.S3:.     
-00028460: 2020 2020 2020 2069 6620 7375 6666 6978         if suffix
-00028470: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028480: 2020 7265 7475 726e 2066 2761 7773 2073    return f'aws s
-00028490: 3361 7069 206c 6973 742d 6f62 6a65 6374  3api list-object
-000284a0: 7320 2d2d 6275 636b 6574 2022 7b62 7563  s --bucket "{buc
-000284b0: 6b65 745f 6e61 6d65 7d22 202d 2d70 7265  ket_name}" --pre
-000284c0: 6669 7820 7b73 7566 6669 787d 202d 2d71  fix {suffix} --q
-000284d0: 7565 7279 2022 6c65 6e67 7468 2843 6f6e  uery "length(Con
-000284e0: 7465 6e74 735b 3f63 6f6e 7461 696e 7328  tents[?contains(
-000284f0: 4b65 792c 5c27 7b66 696c 655f 6e61 6d65  Key,\'{file_name
-00028500: 7d5c 2729 5d2e 4b65 7929 2227 0a20 2020  }\')].Key)"'.   
-00028510: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00028520: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00028530: 6574 7572 6e20 6627 6177 7320 7333 6170  eturn f'aws s3ap
-00028540: 6920 6c69 7374 2d6f 626a 6563 7473 202d  i list-objects -
-00028550: 2d62 7563 6b65 7420 227b 6275 636b 6574  -bucket "{bucket
-00028560: 5f6e 616d 657d 2220 2d2d 7175 6572 7920  _name}" --query 
-00028570: 226c 656e 6774 6828 436f 6e74 656e 7473  "length(Contents
-00028580: 5b3f 636f 6e74 6169 6e73 284b 6579 2c5c  [?contains(Key,\
-00028590: 277b 6669 6c65 5f6e 616d 657d 5c27 295d  '{file_name}\')]
-000285a0: 2e4b 6579 2922 270a 2020 2020 2020 2020  .Key)"'.        
-000285b0: 656c 6966 2073 746f 7265 5f74 7970 6520  elif store_type 
-000285c0: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-000285d0: 746f 7265 5479 7065 2e47 4353 3a0a 2020  toreType.GCS:.  
-000285e0: 2020 2020 2020 2020 2020 6966 2073 7566            if suf
-000285f0: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
-00028600: 2020 2020 2072 6574 7572 6e20 6627 6773       return f'gs
-00028610: 7574 696c 206c 7320 2d72 2067 733a 2f2f  util ls -r gs://
-00028620: 7b62 7563 6b65 745f 6e61 6d65 7d2f 7b73  {bucket_name}/{s
-00028630: 7566 6669 787d 207c 2067 7265 7020 227b  uffix} | grep "{
-00028640: 6669 6c65 5f6e 616d 657d 2220 7c20 7763  file_name}" | wc
-00028650: 202d 6c27 0a20 2020 2020 2020 2020 2020   -l'.           
-00028660: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00028670: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-00028680: 6773 7574 696c 206c 7320 2d72 2067 733a  gsutil ls -r gs:
-00028690: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d20  //{bucket_name} 
-000286a0: 7c20 6772 6570 2022 7b66 696c 655f 6e61  | grep "{file_na
-000286b0: 6d65 7d22 207c 2077 6320 2d6c 270a 2020  me}" | wc -l'.  
-000286c0: 2020 2020 2020 656c 6966 2073 746f 7265        elif store
-000286d0: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-000286e0: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
-000286f0: 323a 0a20 2020 2020 2020 2020 2020 2065  2:.            e
-00028700: 6e64 706f 696e 745f 7572 6c20 3d20 636c  ndpoint_url = cl
-00028710: 6f75 6466 6c61 7265 2e63 7265 6174 655f  oudflare.create_
-00028720: 656e 6470 6f69 6e74 2829 0a20 2020 2020  endpoint().     
-00028730: 2020 2020 2020 2069 6620 7375 6666 6978         if suffix
-00028740: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028750: 2020 7265 7475 726e 2066 2741 5753 5f53    return f'AWS_S
-00028760: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
-00028770: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
-00028780: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
-00028790: 535f 5041 5448 7d20 6177 7320 7333 6170  S_PATH} aws s3ap
-000287a0: 6920 6c69 7374 2d6f 626a 6563 7473 202d  i list-objects -
-000287b0: 2d62 7563 6b65 7420 227b 6275 636b 6574  -bucket "{bucket
-000287c0: 5f6e 616d 657d 2220 2d2d 7072 6566 6978  _name}" --prefix
-000287d0: 207b 7375 6666 6978 7d20 2d2d 7175 6572   {suffix} --quer
-000287e0: 7920 226c 656e 6774 6828 436f 6e74 656e  y "length(Conten
-000287f0: 7473 5b3f 636f 6e74 6169 6e73 284b 6579  ts[?contains(Key
-00028800: 2c5c 277b 6669 6c65 5f6e 616d 657d 5c27  ,\'{file_name}\'
-00028810: 295d 2e4b 6579 2922 202d 2d65 6e64 706f  )].Key)" --endpo
-00028820: 696e 7420 7b65 6e64 706f 696e 745f 7572  int {endpoint_ur
-00028830: 6c7d 202d 2d70 726f 6669 6c65 3d72 3227  l} --profile=r2'
-00028840: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00028850: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00028860: 2020 2072 6574 7572 6e20 6627 4157 535f     return f'AWS_
-00028870: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
-00028880: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
-00028890: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
-000288a0: 4c53 5f50 4154 487d 2061 7773 2073 3361  LS_PATH} aws s3a
-000288b0: 7069 206c 6973 742d 6f62 6a65 6374 7320  pi list-objects 
-000288c0: 2d2d 6275 636b 6574 2022 7b62 7563 6b65  --bucket "{bucke
-000288d0: 745f 6e61 6d65 7d22 202d 2d71 7565 7279  t_name}" --query
-000288e0: 2022 6c65 6e67 7468 2843 6f6e 7465 6e74   "length(Content
-000288f0: 735b 3f63 6f6e 7461 696e 7328 4b65 792c  s[?contains(Key,
-00028900: 5c27 7b66 696c 655f 6e61 6d65 7d5c 2729  \'{file_name}\')
-00028910: 5d2e 4b65 7929 2220 2d2d 656e 6470 6f69  ].Key)" --endpoi
-00028920: 6e74 207b 656e 6470 6f69 6e74 5f75 726c  nt {endpoint_url
-00028930: 7d20 2d2d 7072 6f66 696c 653d 7232 270a  } --profile=r2'.
-00028940: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-00028950: 6f64 0a20 2020 2064 6566 2063 6c69 5f63  od.    def cli_c
-00028960: 6f75 6e74 5f66 696c 655f 696e 5f62 7563  ount_file_in_buc
-00028970: 6b65 7428 7374 6f72 655f 7479 7065 2c20  ket(store_type, 
-00028980: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
-00028990: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
-000289a0: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
-000289b0: 6962 2e53 746f 7265 5479 7065 2e53 333a  ib.StoreType.S3:
-000289c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000289d0: 7572 6e20 6627 6177 7320 7333 206c 7320  urn f'aws s3 ls 
-000289e0: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
-000289f0: 657d 202d 2d72 6563 7572 7369 7665 207c  e} --recursive |
-00028a00: 2077 6320 2d6c 270a 2020 2020 2020 2020   wc -l'.        
-00028a10: 656c 6966 2073 746f 7265 5f74 7970 6520  elif store_type 
-00028a20: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-00028a30: 746f 7265 5479 7065 2e47 4353 3a0a 2020  toreType.GCS:.  
-00028a40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00028a50: 2066 2767 7375 7469 6c20 6c73 202d 7220   f'gsutil ls -r 
-00028a60: 6773 3a2f 2f7b 6275 636b 6574 5f6e 616d  gs://{bucket_nam
-00028a70: 657d 2f2a 2a20 7c20 7763 202d 6c27 0a20  e}/** | wc -l'. 
-00028a80: 2020 2020 2020 2065 6c69 6620 7374 6f72         elif stor
-00028a90: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-00028aa0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00028ab0: 5232 3a0a 2020 2020 2020 2020 2020 2020  R2:.            
-00028ac0: 656e 6470 6f69 6e74 5f75 726c 203d 2063  endpoint_url = c
-00028ad0: 6c6f 7564 666c 6172 652e 6372 6561 7465  loudflare.create
-00028ae0: 5f65 6e64 706f 696e 7428 290a 2020 2020  _endpoint().    
-00028af0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00028b00: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
-00028b10: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
-00028b20: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
-00028b30: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
-00028b40: 7320 7333 206c 7320 7333 3a2f 2f7b 6275  s s3 ls s3://{bu
-00028b50: 636b 6574 5f6e 616d 657d 202d 2d72 6563  cket_name} --rec
-00028b60: 7572 7369 7665 202d 2d65 6e64 706f 696e  ursive --endpoin
-00028b70: 7420 7b65 6e64 706f 696e 745f 7572 6c7d  t {endpoint_url}
-00028b80: 202d 2d70 726f 6669 6c65 3d72 3220 7c20   --profile=r2 | 
-00028b90: 7763 202d 6c27 0a0a 2020 2020 4070 7974  wc -l'..    @pyt
-00028ba0: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
-00028bb0: 6465 6620 746d 705f 736f 7572 6365 2873  def tmp_source(s
-00028bc0: 656c 662c 2074 6d70 5f70 6174 6829 3a0a  elf, tmp_path):.
-00028bd0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-00028be0: 7320 6120 7465 6d70 6f72 6172 7920 6469  s a temporary di
-00028bf0: 7265 6374 6f72 7920 7769 7468 2061 2066  rectory with a f
-00028c00: 696c 6520 696e 2069 740a 2020 2020 2020  ile in it.      
-00028c10: 2020 746d 705f 6469 7220 3d20 746d 705f    tmp_dir = tmp_
-00028c20: 7061 7468 202f 2027 746d 702d 736f 7572  path / 'tmp-sour
-00028c30: 6365 270a 2020 2020 2020 2020 746d 705f  ce'.        tmp_
-00028c40: 6469 722e 6d6b 6469 7228 290a 2020 2020  dir.mkdir().    
-00028c50: 2020 2020 746d 705f 6669 6c65 203d 2074      tmp_file = t
-00028c60: 6d70 5f64 6972 202f 2027 746d 702d 6669  mp_dir / 'tmp-fi
-00028c70: 6c65 270a 2020 2020 2020 2020 746d 705f  le'.        tmp_
-00028c80: 6669 6c65 2e77 7269 7465 5f74 6578 7428  file.write_text(
-00028c90: 2774 6573 7427 290a 2020 2020 2020 2020  'test').        
-00028ca0: 6369 7263 6c65 5f6c 696e 6b20 3d20 746d  circle_link = tm
-00028cb0: 705f 6469 7220 2f20 2763 6972 636c 652d  p_dir / 'circle-
-00028cc0: 6c69 6e6b 270a 2020 2020 2020 2020 6369  link'.        ci
-00028cd0: 7263 6c65 5f6c 696e 6b2e 7379 6d6c 696e  rcle_link.symlin
-00028ce0: 6b5f 746f 2874 6d70 5f64 6972 2c20 7461  k_to(tmp_dir, ta
-00028cf0: 7267 6574 5f69 735f 6469 7265 6374 6f72  rget_is_director
-00028d00: 793d 5472 7565 290a 2020 2020 2020 2020  y=True).        
-00028d10: 7969 656c 6420 7374 7228 746d 705f 6469  yield str(tmp_di
-00028d20: 7229 0a0a 2020 2020 4073 7461 7469 636d  r)..    @staticm
-00028d30: 6574 686f 640a 2020 2020 6465 6620 6765  ethod.    def ge
-00028d40: 6e65 7261 7465 5f62 7563 6b65 745f 6e61  nerate_bucket_na
-00028d50: 6d65 2829 3a0a 2020 2020 2020 2020 2320  me():.        # 
-00028d60: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
-00028d70: 6172 7920 6275 636b 6574 206e 616d 650a  ary bucket name.
-00028d80: 2020 2020 2020 2020 2320 7469 6d65 2e74          # time.t
-00028d90: 696d 6528 2920 7265 7475 726e 7320 7661  ime() returns va
-00028da0: 7279 696e 6720 7072 6563 6973 696f 6e20  rying precision 
-00028db0: 6f6e 2064 6966 6665 7265 6e74 2073 7973  on different sys
-00028dc0: 7465 6d73 2c20 736f 2077 650a 2020 2020  tems, so we.    
-00028dd0: 2020 2020 2320 7265 706c 6163 6520 7468      # replace th
-00028de0: 6520 6465 6369 6d61 6c20 706f 696e 7420  e decimal point 
-00028df0: 616e 6420 7573 6520 7768 6174 6576 6572  and use whatever
-00028e00: 2070 7265 6369 7369 6f6e 2077 6520 6361   precision we ca
-00028e10: 6e20 6765 742e 0a20 2020 2020 2020 2074  n get..        t
-00028e20: 696d 6573 7461 6d70 203d 2073 7472 2874  imestamp = str(t
-00028e30: 696d 652e 7469 6d65 2829 292e 7265 706c  ime.time()).repl
-00028e40: 6163 6528 272e 272c 2027 2729 0a20 2020  ace('.', '').   
-00028e50: 2020 2020 2072 6574 7572 6e20 6627 736b       return f'sk
-00028e60: 792d 7465 7374 2d7b 7469 6d65 7374 616d  y-test-{timestam
-00028e70: 707d 270a 0a20 2020 2040 7079 7465 7374  p}'..    @pytest
-00028e80: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
-00028e90: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
-00028ea0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00028eb0: 7969 656c 6420 7365 6c66 2e67 656e 6572  yield self.gener
-00028ec0: 6174 655f 6275 636b 6574 5f6e 616d 6528  ate_bucket_name(
-00028ed0: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
-00028ee0: 7468 6f64 0a20 2020 2064 6566 2079 6965  thod.    def yie
-00028ef0: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
-00028f00: 7428 0a20 2020 2020 2020 2020 2020 206e  t(.            n
-00028f10: 616d 653a 204f 7074 696f 6e61 6c5b 7374  ame: Optional[st
-00028f20: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
-00028f30: 2020 2020 2020 2073 6f75 7263 653a 204f         source: O
-00028f40: 7074 696f 6e61 6c5b 7374 6f72 6167 655f  ptional[storage_
-00028f50: 6c69 622e 5061 7468 5d20 3d20 4e6f 6e65  lib.Path] = None
-00028f60: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-00028f70: 6f72 6573 3a20 4f70 7469 6f6e 616c 5b44  ores: Optional[D
-00028f80: 6963 745b 7374 6f72 6167 655f 6c69 622e  ict[storage_lib.
-00028f90: 5374 6f72 6554 7970 652c 0a20 2020 2020  StoreType,.     
-00028fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028fb0: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-00028fc0: 7261 6765 5f6c 6962 2e41 6273 7472 6163  rage_lib.Abstrac
-00028fd0: 7453 746f 7265 5d5d 203d 204e 6f6e 652c  tStore]] = None,
-00028fe0: 0a20 2020 2020 2020 2020 2020 2070 6572  .            per
-00028ff0: 7369 7374 656e 743a 204f 7074 696f 6e61  sistent: Optiona
-00029000: 6c5b 626f 6f6c 5d20 3d20 5472 7565 2c0a  l[bool] = True,.
-00029010: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-00029020: 3a20 7374 6f72 6167 655f 6c69 622e 5374  : storage_lib.St
-00029030: 6f72 6167 654d 6f64 6520 3d20 7374 6f72  orageMode = stor
-00029040: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
-00029050: 6f64 652e 4d4f 554e 5429 3a0a 2020 2020  ode.MOUNT):.    
-00029060: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-00029070: 7465 6d70 6f72 6172 7920 7374 6f72 6167  temporary storag
-00029080: 6520 6f62 6a65 6374 2e20 5374 6f72 6573  e object. Stores
-00029090: 206d 7573 7420 6265 2061 6464 6564 2069   must be added i
-000290a0: 6e20 7468 6520 7465 7374 2e0a 2020 2020  n the test..    
-000290b0: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-000290c0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-000290d0: 6f72 6167 6528 6e61 6d65 3d6e 616d 652c  orage(name=name,
-000290e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000de50: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
+0000de60: 6d65 7d20 3333 2033 3520 3337 2033 3920  me} 33 35 37 39 
+0000de70: 3137 2031 3820 3139 272c 0a20 2020 2020  17 18 19',.     
+0000de80: 2020 2020 2020 202a 5b0a 2020 2020 2020         *[.      
+0000de90: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000dea0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000deb0: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+0000dec0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+0000ded0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000dee0: 7d2d 7b69 7d20 7c20 6772 6570 2043 414e  }-{i} | grep CAN
+0000def0: 4345 4c4c 4544 270a 2020 2020 2020 2020  CELLED'.        
+0000df00: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+0000df10: 2072 616e 6765 2833 332c 2034 302c 2032   range(33, 40, 2
+0000df20: 290a 2020 2020 2020 2020 2020 2020 5d2c  ).            ],
+0000df30: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0000df40: 6565 7020 3130 272c 0a20 2020 2020 2020  eep 10',.       
+0000df50: 2020 2020 202a 5b0a 2020 2020 2020 2020       *[.        
+0000df60: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+0000df70: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
+0000df80: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+0000df90: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+0000dfa0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000dfb0: 7b69 7d20 7c20 6772 6570 2052 554e 4e49  {i} | grep RUNNI
+0000dfc0: 4e47 270a 2020 2020 2020 2020 2020 2020  NG'.            
+0000dfd0: 2020 2020 666f 7220 6920 696e 205b 3334      for i in [34
+0000dfe0: 2c20 3336 2c20 3338 5d0a 2020 2020 2020  , 36, 38].      
+0000dff0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000e000: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+0000e010: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0000e020: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+0000e030: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
+0000e040: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+0000e050: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+0000e060: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
+0000e070: 615f 636c 6f75 6420 2023 204e 6f20 4c61  a_cloud  # No La
+0000e080: 6d62 6461 2043 6c6f 7564 2056 4d20 6861  mbda Cloud VM ha
+0000e090: 7320 3820 4350 5573 0a64 6566 2074 6573  s 8 CPUs.def tes
+0000e0a0: 745f 6661 7374 5f6c 6172 6765 5f6a 6f62  t_fast_large_job
+0000e0b0: 5f71 7565 7565 2867 656e 6572 6963 5f63  _queue(generic_c
+0000e0c0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000e0d0: 2320 5468 6973 2069 7320 746f 2074 6573  # This is to tes
+0000e0e0: 7420 7468 6520 6a6f 6273 2063 616e 2062  t the jobs can b
+0000e0f0: 6520 7363 6865 6475 6c65 6420 7175 6963  e scheduled quic
+0000e100: 6b6c 7920 7768 656e 2074 6865 7265 2061  kly when there a
+0000e110: 7265 206d 616e 7920 6a6f 6273 2069 6e20  re many jobs in 
+0000e120: 7468 6520 7175 6575 652e 0a20 2020 206e  the queue..    n
+0000e130: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0000e140: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+0000e150: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0000e160: 2020 2027 6661 7374 5f6c 6172 6765 5f6a     'fast_large_j
+0000e170: 6f62 5f71 7565 7565 272c 0a20 2020 2020  ob_queue',.     
+0000e180: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0000e190: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000e1a0: 202d 6320 7b6e 616d 657d 202d 2d63 7075   -c {name} --cpu
+0000e1b0: 7320 3820 2d2d 636c 6f75 6420 7b67 656e  s 8 --cloud {gen
+0000e1c0: 6572 6963 5f63 6c6f 7564 7d27 2c0a 2020  eric_cloud}',.  
+0000e1d0: 2020 2020 2020 2020 2020 6627 666f 7220            f'for 
+0000e1e0: 6920 696e 2060 7365 7120 3120 3332 603b  i in `seq 1 32`;
+0000e1f0: 2064 6f20 736b 7920 6578 6563 207b 6e61   do sky exec {na
+0000e200: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 2469  me} -n {name}-$i
+0000e210: 202d 6420 2265 6368 6f20 2469 223b 2064   -d "echo $i"; d
+0000e220: 6f6e 6527 2c0a 2020 2020 2020 2020 2020  one',.          
+0000e230: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+0000e240: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000e250: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000e260: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+0000e270: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+0000e280: 2473 2220 7c20 6772 6570 202d 7620 6772  $s" | grep -v gr
+0000e290: 6570 207c 2067 7265 7020 5355 4343 4545  ep | grep SUCCEE
+0000e2a0: 4445 4420 7c20 7763 202d 6c20 7c20 6772  DED | wc -l | gr
+0000e2b0: 6570 2033 3227 2c0a 2020 2020 2020 2020  ep 32',.        
+0000e2c0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+0000e2d0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+0000e2e0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+0000e2f0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+0000e300: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0000e310: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+0000e320: 742e 6d61 726b 2e69 626d 0a64 6566 2074  t.mark.ibm.def t
+0000e330: 6573 745f 6962 6d5f 6a6f 625f 7175 6575  est_ibm_job_queu
+0000e340: 655f 6d75 6c74 696e 6f64 6528 293a 0a20  e_multinode():. 
+0000e350: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000e360: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000e370: 2020 7461 736b 5f66 696c 6520 3d20 2765    task_file = 'e
+0000e380: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000e390: 652f 6a6f 625f 6d75 6c74 696e 6f64 655f  e/job_multinode_
+0000e3a0: 6962 6d2e 7961 6d6c 270a 2020 2020 7465  ibm.yaml'.    te
+0000e3b0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0000e3c0: 2020 2027 6962 6d5f 6a6f 625f 7175 6575     'ibm_job_queu
+0000e3d0: 655f 6d75 6c74 696e 6f64 6527 2c0a 2020  e_multinode',.  
+0000e3e0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000e3f0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000e400: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+0000e410: 636c 6f75 6420 6962 6d20 2d2d 6770 7573  cloud ibm --gpus
+0000e420: 2076 3130 3020 2d2d 6e75 6d2d 6e6f 6465   v100 --num-node
+0000e430: 7320 3227 2c0a 2020 2020 2020 2020 2020  s 2',.          
+0000e440: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000e450: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
+0000e460: 2d64 207b 7461 736b 5f66 696c 657d 272c  -d {task_file}',
+0000e470: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000e480: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000e490: 6e20 7b6e 616d 657d 2d32 202d 6420 7b74  n {name}-2 -d {t
+0000e4a0: 6173 6b5f 6669 6c65 7d27 2c0a 2020 2020  ask_file}',.    
+0000e4b0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000e4c0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000e4d0: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
+0000e4e0: 6465 7461 6368 2d73 6574 7570 202d 6420  detach-setup -d 
+0000e4f0: 7b74 6173 6b5f 6669 6c65 7d27 2c0a 2020  {task_file}',.  
+0000e500: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000e510: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000e520: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
+0000e530: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
+0000e540: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+0000e550: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
+0000e560: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000e570: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000e580: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
+0000e590: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
+0000e5a0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000e5b0: 3220 7c20 6772 6570 2052 554e 4e49 4e47  2 | grep RUNNING
+0000e5c0: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
+0000e5d0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000e5e0: 7b6e 616d 657d 2920 2626 2070 7269 6e74  {name}) && print
+0000e5f0: 6620 2224 7322 2026 2620 2865 6368 6f20  f "$s" && (echo 
+0000e600: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000e610: 657d 2d33 207c 2067 7265 7020 5345 5454  e}-3 | grep SETT
+0000e620: 494e 475f 5550 2927 2c0a 2020 2020 2020  ING_UP)',.      
+0000e630: 2020 2020 2020 2773 6c65 6570 2039 3027        'sleep 90'
+0000e640: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000e650: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000e660: 616d 657d 2920 2626 2070 7269 6e74 6620  ame}) && printf 
+0000e670: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
+0000e680: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000e690: 2d33 207c 2067 7265 7020 5045 4e44 494e  -3 | grep PENDIN
+0000e6a0: 4729 272c 0a20 2020 2020 2020 2020 2020  G)',.           
+0000e6b0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000e6c0: 207b 6e61 6d65 7d20 3127 2c0a 2020 2020   {name} 1',.    
+0000e6d0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0000e6e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000e6f0: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
+0000e700: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
+0000e710: 3320 7c20 6772 6570 2052 554e 4e49 4e47  3 | grep RUNNING
+0000e720: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000e730: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000e740: 6e61 6d65 7d20 3120 3220 3327 2c0a 2020  name} 1 2 3',.  
+0000e750: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000e760: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+0000e770: 202d 6e20 7b6e 616d 657d 2d34 202d 2d64   -n {name}-4 --d
+0000e780: 6574 6163 682d 7365 7475 7020 2d64 207b  etach-setup -d {
+0000e790: 7461 736b 5f66 696c 657d 272c 0a20 2020  task_file}',.   
+0000e7a0: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
+0000e7b0: 7468 6520 6a6f 6220 7374 6174 7573 2069  the job status i
+0000e7c0: 7320 636f 7272 6563 746c 7920 7365 7420  s correctly set 
+0000e7d0: 746f 2053 4554 5449 4e47 5f55 502c 2064  to SETTING_UP, d
+0000e7e0: 7572 696e 6720 7468 6520 7365 7475 7020  uring the setup 
+0000e7f0: 6973 2072 756e 6e69 6e67 2c0a 2020 2020  is running,.    
+0000e800: 2020 2020 2020 2020 2320 616e 6420 7468          # and th
+0000e810: 6520 6a6f 6220 6361 6e20 6265 2063 616e  e job can be can
+0000e820: 6365 6c6c 6564 2064 7572 696e 6720 7468  celled during th
+0000e830: 6520 7365 7475 702e 0a20 2020 2020 2020  e setup..       
+0000e840: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000e850: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
+0000e860: 7072 696e 7466 2022 2473 2220 2626 2028  printf "$s" && (
+0000e870: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000e880: 207b 6e61 6d65 7d2d 3420 7c20 6772 6570   {name}-4 | grep
+0000e890: 2053 4554 5449 4e47 5f55 5029 272c 0a20   SETTING_UP)',. 
+0000e8a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000e8b0: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+0000e8c0: 7d20 3427 2c0a 2020 2020 2020 2020 2020  } 4',.          
+0000e8d0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000e8e0: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
+0000e8f0: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
+0000e900: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000e910: 616d 657d 2d34 207c 2067 7265 7020 4341  ame}-4 | grep CA
+0000e920: 4e43 454c 4c45 4429 272c 0a20 2020 2020  NCELLED)',.     
+0000e930: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000e940: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
+0000e950: 7631 3030 3a30 2e32 2022 5b5b 205c 2453  v100:0.2 "[[ \$S
+0000e960: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
+0000e970: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
+0000e980: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
+0000e990: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000e9a0: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+0000e9b0: 6770 7573 2076 3130 303a 302e 3220 2d2d  gpus v100:0.2 --
+0000e9c0: 6e75 6d2d 6e6f 6465 7320 3220 225b 5b20  num-nodes 2 "[[ 
+0000e9d0: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
+0000e9e0: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
+0000e9f0: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
+0000ea00: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000ea10: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000ea20: 202d 2d67 7075 7320 7631 3030 3a31 202d   --gpus v100:1 -
+0000ea30: 2d6e 756d 2d6e 6f64 6573 2032 2022 5b5b  -num-nodes 2 "[[
+0000ea40: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
+0000ea50: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
+0000ea60: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
+0000ea70: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000ea80: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000ea90: 7d20 3520 2d2d 7374 6174 7573 272c 0a20  } 5 --status',. 
+0000eaa0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000eab0: 206c 6f67 7320 7b6e 616d 657d 2036 202d   logs {name} 6 -
+0000eac0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+0000ead0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000eae0: 207b 6e61 6d65 7d20 3720 2d2d 7374 6174   {name} 7 --stat
+0000eaf0: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
+0000eb00: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000eb10: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0000eb20: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0000eb30: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+0000eb40: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
+0000eb50: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0000eb60: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2044  ..# ---------- D
+0000eb70: 6f63 6b65 7220 7769 7468 2070 7265 696e  ocker with prein
+0000eb80: 7374 616c 6c65 6420 7061 636b 6167 652e  stalled package.
+0000eb90: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+0000eba0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+0000ebb0: 6473 7461 636b 2020 2320 446f 6573 6e27  dstack  # Doesn'
+0000ebc0: 7420 7375 7070 6f72 7420 466c 7569 6473  t support Fluids
+0000ebd0: 7461 636b 2066 6f72 206e 6f77 0a40 7079  tack for now.@py
+0000ebe0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+0000ebf0: 6264 615f 636c 6f75 6420 2023 2044 6f65  bda_cloud  # Doe
+0000ec00: 736e 2774 2073 7570 706f 7274 204c 616d  sn't support Lam
+0000ec10: 6264 6120 436c 6f75 6420 666f 7220 6e6f  bda Cloud for no
+0000ec20: 770a 4070 7974 6573 742e 6d61 726b 2e6e  w.@pytest.mark.n
+0000ec30: 6f5f 6962 6d20 2023 2044 6f65 736e 2774  o_ibm  # Doesn't
+0000ec40: 2073 7570 706f 7274 2049 424d 2043 6c6f   support IBM Clo
+0000ec50: 7564 2066 6f72 206e 6f77 0a40 7079 7465  ud for now.@pyte
+0000ec60: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+0000ec70: 2320 446f 6573 6e27 7420 7375 7070 6f72  # Doesn't suppor
+0000ec80: 7420 5343 5020 666f 7220 6e6f 770a 4070  t SCP for now.@p
+0000ec90: 7974 6573 742e 6d61 726b 2e6e 6f5f 6f63  ytest.mark.no_oc
+0000eca0: 6920 2023 2044 6f65 736e 2774 2073 7570  i  # Doesn't sup
+0000ecb0: 706f 7274 204f 4349 2066 6f72 206e 6f77  port OCI for now
+0000ecc0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000ecd0: 5f6b 7562 6572 6e65 7465 7320 2023 2044  _kubernetes  # D
+0000ece0: 6f65 736e 2774 2073 7570 706f 7274 204b  oesn't support K
+0000ecf0: 7562 6572 6e65 7465 7320 666f 7220 6e6f  ubernetes for no
+0000ed00: 770a 6465 6620 7465 7374 5f64 6f63 6b65  w.def test_docke
+0000ed10: 725f 7072 6569 6e73 7461 6c6c 6564 5f70  r_preinstalled_p
+0000ed20: 6163 6b61 6765 2867 656e 6572 6963 5f63  ackage(generic_c
+0000ed30: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000ed40: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000ed50: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000ed60: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000ed70: 2020 2020 2764 6f63 6b65 725f 7769 7468      'docker_with
+0000ed80: 5f70 7265 696e 7374 616c 6c65 645f 7061  _preinstalled_pa
+0000ed90: 636b 6167 6527 2c0a 2020 2020 2020 2020  ckage',.        
+0000eda0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0000edb0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0000edc0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+0000edd0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+0000ede0: 2d2d 696d 6167 652d 6964 2064 6f63 6b65  --image-id docke
+0000edf0: 723a 6e67 696e 7827 2c0a 2020 2020 2020  r:nginx',.      
+0000ee00: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000ee10: 207b 6e61 6d65 7d20 226e 6769 6e78 202d   {name} "nginx -
+0000ee20: 5622 272c 0a20 2020 2020 2020 2020 2020  V"',.           
+0000ee30: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000ee40: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
+0000ee50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000ee60: 7920 6578 6563 207b 6e61 6d65 7d20 7768  y exec {name} wh
+0000ee70: 6f61 6d69 207c 2067 7265 7020 726f 6f74  oami | grep root
+0000ee80: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0000ee90: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0000eea0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0000eeb0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0000eec0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+0000eed0: 2d2d 2d2d 2d2d 2d2d 2053 7562 6d69 7474  -------- Submitt
+0000eee0: 696e 6720 6d75 6c74 6970 6c65 2074 6173  ing multiple tas
+0000eef0: 6b73 2074 6f20 7468 6520 7361 6d65 2063  ks to the same c
+0000ef00: 6c75 7374 6572 2e20 2d2d 2d2d 2d2d 2d2d  luster. --------
+0000ef10: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+0000ef20: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+0000ef30: 2046 6c75 6964 5374 6163 6b20 4443 2068   FluidStack DC h
+0000ef40: 6173 206c 6f77 2061 7661 696c 6162 696c  as low availabil
+0000ef50: 6974 7920 6f66 2054 3420 4750 5573 0a40  ity of T4 GPUs.@
+0000ef60: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+0000ef70: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
+0000ef80: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
+0000ef90: 206e 6f74 2068 6176 6520 5434 2067 7075   not have T4 gpu
+0000efa0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+0000efb0: 6f5f 7061 7065 7273 7061 6365 2020 2320  o_paperspace  # 
+0000efc0: 5061 7065 7273 7061 6365 2064 6f65 7320  Paperspace does 
+0000efd0: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
+0000efe0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000eff0: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
+0000f000: 6420 646f 6573 206e 6f74 2068 6176 6520  d does not have 
+0000f010: 5434 2067 7075 730a 4070 7974 6573 742e  T4 gpus.@pytest.
+0000f020: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+0000f030: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+0000f040: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
+0000f050: 3120 7965 740a 4070 7974 6573 742e 6d61  1 yet.@pytest.ma
+0000f060: 726b 2e6e 6f5f 6f63 6920 2023 204f 4349  rk.no_oci  # OCI
+0000f070: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+0000f080: 6861 7665 2054 3420 6770 7573 0a64 6566  have T4 gpus.def
+0000f090: 2074 6573 745f 6d75 6c74 695f 6563 686f   test_multi_echo
+0000f0a0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+0000f0b0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+0000f0c0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000f0d0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+0000f0e0: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
+0000f0f0: 756c 7469 5f65 6368 6f27 2c0a 2020 2020  ulti_echo',.    
+0000f100: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0000f110: 2020 6627 7079 7468 6f6e 2065 7861 6d70    f'python examp
+0000f120: 6c65 732f 6d75 6c74 695f 6563 686f 2e70  les/multi_echo.p
+0000f130: 7920 7b6e 616d 657d 207b 6765 6e65 7269  y {name} {generi
+0000f140: 635f 636c 6f75 647d 272c 0a20 2020 2020  c_cloud}',.     
+0000f150: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
+0000f160: 3027 2c0a 2020 2020 2020 2020 5d20 2b0a  0',.        ] +.
+0000f170: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+0000f180: 206a 6f62 7320 7375 6363 6565 6465 642e   jobs succeeded.
+0000f190: 0a20 2020 2020 2020 205b 6627 736b 7920  .        [f'sky 
+0000f1a0: 6c6f 6773 207b 6e61 6d65 7d20 7b69 202b  logs {name} {i +
+0000f1b0: 2031 7d20 2d2d 7374 6174 7573 2720 666f   1} --status' fo
+0000f1c0: 7220 6920 696e 2072 616e 6765 2833 3229  r i in range(32)
+0000f1d0: 5d20 2b0a 2020 2020 2020 2020 2320 456e  ] +.        # En
+0000f1e0: 7375 7265 206d 6f6e 6974 6f72 2f61 7574  sure monitor/aut
+0000f1f0: 6f73 6361 6c65 7220 6469 646e 2774 2063  oscaler didn't c
+0000f200: 7261 7368 206f 6e20 7468 6520 2761 7373  rash on the 'ass
+0000f210: 6572 7420 6e6f 740a 2020 2020 2020 2020  ert not.        
+0000f220: 2320 756e 6675 6c66 696c 6c65 6427 2065  # unfulfilled' e
+0000f230: 7272 6f72 2e20 2049 6620 7072 6f63 6573  rror.  If proces
+0000f240: 7320 6e6f 7420 666f 756e 642c 2067 7265  s not found, gre
+0000f250: 702d 3e73 7368 2072 6574 7572 6e73 2031  p->ssh returns 1
+0000f260: 2e0a 2020 2020 2020 2020 5b66 2773 7368  ..        [f'ssh
+0000f270: 207b 6e61 6d65 7d20 5c27 7073 2061 7578   {name} \'ps aux
+0000f280: 207c 2067 7265 7020 225b 2f5d 226d 6f6e   | grep "[/]"mon
+0000f290: 6974 6f72 2e70 795c 2727 5d2c 0a20 2020  itor.py\''],.   
+0000f2a0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000f2b0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000f2c0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+0000f2d0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0000f2e0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000f2f0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+0000f300: 2054 6173 6b3a 2031 206e 6f64 6520 7472   Task: 1 node tr
+0000f310: 6169 6e69 6e67 2e20 2d2d 2d2d 2d2d 2d2d  aining. --------
+0000f320: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+0000f330: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+0000f340: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+0000f350: 646f 6573 206e 6f74 2068 6176 6520 5631  does not have V1
+0000f360: 3030 2067 7075 730a 4070 7974 6573 742e  00 gpus.@pytest.
+0000f370: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
+0000f380: 424d 2063 6c6f 7564 2063 7572 7265 6e74  BM cloud current
+0000f390: 6c79 2064 6f65 736e 2774 2070 726f 7669  ly doesn't provi
+0000f3a0: 6465 2070 7562 6c69 6320 696d 6167 6520  de public image 
+0000f3b0: 7769 7468 2043 5544 410a 4070 7974 6573  with CUDA.@pytes
+0000f3c0: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+0000f3d0: 2053 4350 2064 6f65 7320 6e6f 7420 6861   SCP does not ha
+0000f3e0: 7665 2056 3130 3020 2831 3647 4229 2047  ve V100 (16GB) G
+0000f3f0: 5055 732e 2052 756e 2074 6573 745f 7363  PUs. Run test_sc
+0000f400: 705f 6875 6767 696e 6766 6163 6520 696e  p_huggingface in
+0000f410: 7374 6561 642e 0a64 6566 2074 6573 745f  stead..def test_
+0000f420: 6875 6767 696e 6766 6163 6528 6765 6e65  huggingface(gene
+0000f430: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+0000f440: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000f450: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0000f460: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000f470: 0a20 2020 2020 2020 2027 6875 6767 696e  .        'huggin
+0000f480: 6766 6163 655f 676c 7565 5f69 6d64 625f  gface_glue_imdb_
+0000f490: 6170 7027 2c0a 2020 2020 2020 2020 5b0a  app',.        [.
+0000f4a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000f4b0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000f4c0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+0000f4d0: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
+0000f4e0: 616d 706c 6573 2f68 7567 6769 6e67 6661  amples/huggingfa
+0000f4f0: 6365 5f67 6c75 655f 696d 6462 5f61 7070  ce_glue_imdb_app
+0000f500: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000f510: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000f520: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0000f530: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0000f540: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+0000f550: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000f560: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
+0000f570: 616d 706c 6573 2f68 7567 6769 6e67 6661  amples/huggingfa
+0000f580: 6365 5f67 6c75 655f 696d 6462 5f61 7070  ce_glue_imdb_app
+0000f590: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000f5a0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000f5b0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+0000f5c0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0000f5d0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+0000f5e0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000f5f0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0000f600: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+0000f610: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0000f620: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+0000f630: 2e6d 6172 6b2e 6c61 6d62 6461 5f63 6c6f  .mark.lambda_clo
+0000f640: 7564 0a64 6566 2074 6573 745f 6c61 6d62  ud.def test_lamb
+0000f650: 6461 5f68 7567 6769 6e67 6661 6365 2867  da_huggingface(g
+0000f660: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+0000f670: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+0000f680: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000f690: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0000f6a0: 7374 280a 2020 2020 2020 2020 276c 616d  st(.        'lam
+0000f6b0: 6264 615f 6875 6767 696e 6766 6163 655f  bda_huggingface_
+0000f6c0: 676c 7565 5f69 6d64 625f 6170 7027 2c0a  glue_imdb_app',.
+0000f6d0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0000f6e0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+0000f6f0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+0000f700: 7b4c 414d 4244 415f 5459 5045 7d20 6578  {LAMBDA_TYPE} ex
+0000f710: 616d 706c 6573 2f68 7567 6769 6e67 6661  amples/huggingfa
+0000f720: 6365 5f67 6c75 655f 696d 6462 5f61 7070  ce_glue_imdb_app
+0000f730: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000f740: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000f750: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0000f760: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0000f770: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+0000f780: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000f790: 7920 6578 6563 207b 6e61 6d65 7d20 7b4c  y exec {name} {L
+0000f7a0: 414d 4244 415f 5459 5045 7d20 6578 616d  AMBDA_TYPE} exam
+0000f7b0: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
+0000f7c0: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
+0000f7d0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000f7e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000f7f0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+0000f800: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000f810: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000f820: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000f830: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000f840: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+0000f850: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000f860: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000f870: 6172 6b2e 7363 700a 6465 6620 7465 7374  ark.scp.def test
+0000f880: 5f73 6370 5f68 7567 6769 6e67 6661 6365  _scp_huggingface
+0000f890: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+0000f8a0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+0000f8b0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000f8c0: 6d65 2829 0a20 2020 206e 756d 5f6f 665f  me().    num_of_
+0000f8d0: 6770 755f 6c61 756e 6368 203d 2031 0a20  gpu_launch = 1. 
+0000f8e0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0000f8f0: 2020 2020 2020 2020 2753 4350 5f68 7567          'SCP_hug
+0000f900: 6769 6e67 6661 6365 5f67 6c75 655f 696d  gingface_glue_im
+0000f910: 6462 5f61 7070 272c 0a20 2020 2020 2020  db_app',.       
+0000f920: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000f930: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+0000f940: 6320 7b6e 616d 657d 207b 5343 505f 5459  c {name} {SCP_TY
+0000f950: 5045 7d20 7b53 4350 5f47 5055 5f56 3130  PE} {SCP_GPU_V10
+0000f960: 307d 3a7b 6e75 6d5f 6f66 5f67 7075 5f6c  0}:{num_of_gpu_l
+0000f970: 6175 6e63 687d 2065 7861 6d70 6c65 732f  aunch} examples/
+0000f980: 6875 6767 696e 6766 6163 655f 676c 7565  huggingface_glue
+0000f990: 5f69 6d64 625f 6170 702e 7961 6d6c 272c  _imdb_app.yaml',
+0000f9a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000f9b0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0000f9c0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000f9d0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000f9e0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000f9f0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000fa00: 7b6e 616d 657d 207b 5343 505f 5459 5045  {name} {SCP_TYPE
+0000fa10: 7d20 7b53 4350 5f47 5055 5f56 3130 307d  } {SCP_GPU_V100}
+0000fa20: 3a7b 6e75 6d5f 6f66 5f67 7075 5f6c 6175  :{num_of_gpu_lau
+0000fa30: 6e63 687d 2065 7861 6d70 6c65 732f 6875  nch} examples/hu
+0000fa40: 6767 696e 6766 6163 655f 676c 7565 5f69  ggingface_glue_i
+0000fa50: 6d64 625f 6170 702e 7961 6d6c 272c 0a20  mdb_app.yaml',. 
+0000fa60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000fa70: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+0000fa80: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+0000fa90: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+0000faa0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+0000fab0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000fac0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000fad0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0000fae0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000faf0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2049 6e66  # ---------- Inf
+0000fb00: 6572 656e 7469 612e 202d 2d2d 2d2d 2d2d  erentia. -------
+0000fb10: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0000fb20: 2e61 7773 0a64 6566 2074 6573 745f 696e  .aws.def test_in
+0000fb30: 6665 7265 6e74 6961 2829 3a0a 2020 2020  ferentia():.    
+0000fb40: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000fb50: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000fb60: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000fb70: 2020 2020 2774 6573 745f 696e 6665 7265      'test_infere
+0000fb80: 6e74 6961 272c 0a20 2020 2020 2020 205b  ntia',.        [
+0000fb90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000fba0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000fbb0: 7b6e 616d 657d 202d 7420 696e 6632 2e78  {name} -t inf2.x
+0000fbc0: 6c61 7267 6520 2d2d 2065 6368 6f20 6869  large -- echo hi
+0000fbd0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000fbe0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000fbf0: 202d 2d67 7075 7320 496e 6665 7265 6e74   --gpus Inferent
+0000fc00: 6961 3a31 2065 6368 6f20 6869 272c 0a20  ia:1 echo hi',. 
+0000fc10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000fc20: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+0000fc30: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+0000fc40: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+0000fc50: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+0000fc60: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000fc70: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+0000fc80: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+0000fc90: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+0000fca0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+0000fcb0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+0000fcc0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+0000fcd0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000fce0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0000fcf0: 2d2d 2d2d 2054 5055 2e20 2d2d 2d2d 2d2d  ---- TPU. ------
+0000fd00: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+0000fd10: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+0000fd20: 726b 2e74 7075 0a64 6566 2074 6573 745f  rk.tpu.def test_
+0000fd30: 7470 7528 293a 0a20 2020 206e 616d 6520  tpu():.    name 
+0000fd40: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0000fd50: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+0000fd60: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0000fd70: 7470 755f 6170 7027 2c0a 2020 2020 2020  tpu_app',.      
+0000fd80: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000fd90: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+0000fda0: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
+0000fdb0: 6573 2f74 7075 2f74 7075 5f61 7070 2e79  es/tpu/tpu_app.y
+0000fdc0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000fdd0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000fde0: 6d65 7d20 3127 2c20 2023 2045 6e73 7572  me} 1',  # Ensur
+0000fdf0: 6520 7468 6520 6a6f 6220 6669 6e69 7368  e the job finish
+0000fe00: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+0000fe10: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000fe20: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+0000fe30: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+0000fe40: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+0000fe50: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000fe60: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000fe70: 7d20 6578 616d 706c 6573 2f74 7075 2f74  } examples/tpu/t
+0000fe80: 7075 5f61 7070 2e79 616d 6c20 7c20 6772  pu_app.yaml | gr
+0000fe90: 6570 2022 5450 5520 2e2a 2061 6c72 6561  ep "TPU .* alrea
+0000fea0: 6479 2065 7869 7374 7322 272c 2020 2320  dy exists"',  # 
+0000feb0: 456e 7375 7265 2073 6b79 206c 6175 6e63  Ensure sky launc
+0000fec0: 6820 776f 6e27 7420 6372 6561 7465 2061  h won't create a
+0000fed0: 6e6f 7468 6572 2054 5055 2e0a 2020 2020  nother TPU..    
+0000fee0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000fef0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000ff00: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0000ff10: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
+0000ff20: 2320 6361 6e20 7461 6b65 203e 3230 206d  # can take >20 m
+0000ff30: 696e 730a 2020 2020 290a 2020 2020 7275  ins.    ).    ru
+0000ff40: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000ff50: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+0000ff60: 5450 5520 564d 2e20 2d2d 2d2d 2d2d 2d2d  TPU VM. --------
+0000ff70: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+0000ff80: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
+0000ff90: 2e74 7075 0a64 6566 2074 6573 745f 7470  .tpu.def test_tp
+0000ffa0: 755f 766d 2829 3a0a 2020 2020 6e61 6d65  u_vm():.    name
+0000ffb0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0000ffc0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0000ffd0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0000ffe0: 2774 7075 5f76 6d5f 6170 7027 2c0a 2020  'tpu_vm_app',.  
+0000fff0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00010000: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00010010: 202d 7920 2d63 207b 6e61 6d65 7d20 6578   -y -c {name} ex
+00010020: 616d 706c 6573 2f74 7075 2f74 7075 766d  amples/tpu/tpuvm
+00010030: 5f6d 6e69 7374 2e79 616d 6c27 2c0a 2020  _mnist.yaml',.  
+00010040: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00010050: 6c6f 6773 207b 6e61 6d65 7d20 3127 2c20  logs {name} 1', 
+00010060: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00010070: 6220 6669 6e69 7368 6564 2e0a 2020 2020  b finished..    
+00010080: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00010090: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+000100a0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+000100b0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+000100c0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+000100d0: 6627 736b 7920 7374 6f70 202d 7920 7b6e  f'sky stop -y {n
+000100e0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+000100f0: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+00010100: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+00010110: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+00010120: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+00010130: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+00010140: 7b6e 616d 657d 207c 2067 7265 7020 5354  {name} | grep ST
+00010150: 4f50 5045 4427 2c20 2023 2045 6e73 7572  OPPED',  # Ensur
+00010160: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+00010170: 2053 544f 5050 4544 2e0a 2020 2020 2020   STOPPED..      
+00010180: 2020 2020 2020 2320 5573 6520 7265 7472        # Use retr
+00010190: 793a 2067 7561 7264 2061 6761 696e 7374  y: guard against
+000101a0: 2074 7261 6e73 6965 6e74 2065 7272 6f72   transient error
+000101b0: 7320 6f62 7365 7276 6564 2066 6f72 0a20  s observed for. 
+000101c0: 2020 2020 2020 2020 2020 2023 206a 7573             # jus
+000101d0: 742d 7374 6f70 7065 6420 5450 5520 564d  t-stopped TPU VM
+000101e0: 7320 2823 3936 3229 2e0a 2020 2020 2020  s (#962)..      
+000101f0: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
+00010200: 7420 2d2d 7265 7472 792d 756e 7469 6c2d  t --retry-until-
+00010210: 7570 202d 7920 7b6e 616d 657d 272c 0a20  up -y {name}',. 
+00010220: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00010230: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+00010240: 6d70 6c65 732f 7470 752f 7470 7576 6d5f  mples/tpu/tpuvm_
+00010250: 6d6e 6973 742e 7961 6d6c 272c 0a20 2020  mnist.yaml',.   
+00010260: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00010270: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+00010280: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00010290: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+000102a0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+000102b0: 2066 2773 6b79 2073 746f 7020 2d79 207b   f'sky stop -y {
+000102c0: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+000102d0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+000102e0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000102f0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00010300: 743d 3330 202a 2036 302c 2020 2320 6361  t=30 * 60,  # ca
+00010310: 6e20 7461 6b65 2033 3020 6d69 6e73 0a20  n take 30 mins. 
+00010320: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00010330: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00010340: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055 2056  ---------- TPU V
+00010350: 4d20 506f 642e 202d 2d2d 2d2d 2d2d 2d2d  M Pod. ---------
+00010360: 2d0a 4070 7974 6573 742e 6d61 726b 2e67  -.@pytest.mark.g
+00010370: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
+00010380: 7470 750a 6465 6620 7465 7374 5f74 7075  tpu.def test_tpu
+00010390: 5f76 6d5f 706f 6428 293a 0a20 2020 206e  _vm_pod():.    n
+000103a0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+000103b0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+000103c0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+000103d0: 2020 2027 7470 755f 706f 6427 2c0a 2020     'tpu_pod',.  
+000103e0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000103f0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00010400: 202d 7920 2d63 207b 6e61 6d65 7d20 6578   -y -c {name} ex
+00010410: 616d 706c 6573 2f74 7075 2f74 7075 766d  amples/tpu/tpuvm
+00010420: 5f6d 6e69 7374 2e79 616d 6c20 2d2d 6770  _mnist.yaml --gp
+00010430: 7573 2074 7075 2d76 322d 3332 202d 2d75  us tpu-v2-32 --u
+00010440: 7365 2d73 706f 7420 2d2d 7a6f 6e65 2065  se-spot --zone e
+00010450: 7572 6f70 652d 7765 7374 342d 6127 2c0a  urope-west4-a',.
+00010460: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00010470: 7920 6c6f 6773 207b 6e61 6d65 7d20 3127  y logs {name} 1'
+00010480: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00010490: 6a6f 6220 6669 6e69 7368 6564 2e0a 2020  job finished..  
+000104a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000104b0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+000104c0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+000104d0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+000104e0: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
+000104f0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00010500: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00010510: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00010520: 3330 202a 2036 302c 2020 2320 6361 6e20  30 * 60,  # can 
+00010530: 7461 6b65 2033 3020 6d69 6e73 0a20 2020  take 30 mins.   
+00010540: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00010550: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00010560: 2d2d 2d2d 2d2d 2d2d 2053 696d 706c 6520  -------- Simple 
+00010570: 6170 7073 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  apps. ----------
+00010580: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00010590: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+000105a0: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
+000105b0: 5f6e 6f64 6573 203e 2031 2079 6574 0a64  _nodes > 1 yet.d
+000105c0: 6566 2074 6573 745f 6d75 6c74 695f 686f  ef test_multi_ho
+000105d0: 7374 6e61 6d65 2867 656e 6572 6963 5f63  stname(generic_c
+000105e0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+000105f0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00010600: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00010610: 6f74 616c 5f74 696d 656f 7574 5f6d 696e  otal_timeout_min
+00010620: 7574 6573 203d 2032 3520 6966 2067 656e  utes = 25 if gen
+00010630: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
+00010640: 7a75 7265 2720 656c 7365 2031 350a 2020  zure' else 15.  
+00010650: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00010660: 2020 2020 2020 2027 6d75 6c74 695f 686f         'multi_ho
+00010670: 7374 6e61 6d65 272c 0a20 2020 2020 2020  stname',.       
+00010680: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00010690: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+000106a0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+000106b0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+000106c0: 2065 7861 6d70 6c65 732f 6d75 6c74 695f   examples/multi_
+000106d0: 686f 7374 6e61 6d65 2e79 616d 6c27 2c0a  hostname.yaml',.
+000106e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000106f0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00010700: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00010710: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00010720: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00010730: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00010740: 6e61 6d65 7d20 3120 7c20 6772 6570 2022  name} 1 | grep "
+00010750: 4d79 2068 6f73 746e 616d 653a 2220 7c20  My hostname:" | 
+00010760: 7763 202d 6c20 7c20 6772 6570 2032 272c  wc -l | grep 2',
+00010770: 2020 2320 456e 7375 7265 2074 6865 7265    # Ensure there
+00010780: 2061 7265 2032 2068 6f73 7473 2e0a 2020   are 2 hosts..  
+00010790: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000107a0: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
+000107b0: 706c 6573 2f6d 756c 7469 5f68 6f73 746e  ples/multi_hostn
+000107c0: 616d 652e 7961 6d6c 272c 0a20 2020 2020  ame.yaml',.     
+000107d0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+000107e0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+000107f0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00010800: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00010810: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+00010820: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00010830: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00010840: 2020 2020 2074 696d 656f 7574 3d5f 6765       timeout=_ge
+00010850: 745f 7469 6d65 6f75 7428 6765 6e65 7269  t_timeout(generi
+00010860: 635f 636c 6f75 642c 2074 6f74 616c 5f74  c_cloud, total_t
+00010870: 696d 656f 7574 5f6d 696e 7574 6573 202a  imeout_minutes *
+00010880: 2036 3029 2c0a 2020 2020 290a 2020 2020   60),.    ).    
+00010890: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000108a0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+000108b0: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+000108c0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000108d0: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
+000108e0: 6574 0a64 6566 2074 6573 745f 6d75 6c74  et.def test_mult
+000108f0: 695f 6e6f 6465 5f66 6169 6c75 7265 2867  i_node_failure(g
+00010900: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00010910: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+00010920: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00010930: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00010940: 7374 280a 2020 2020 2020 2020 276d 756c  st(.        'mul
+00010950: 7469 5f6e 6f64 655f 6661 696c 7572 6527  ti_node_failure'
+00010960: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00010970: 2020 2020 2020 2020 2320 544f 444f 287a          # TODO(z
+00010980: 6877 7529 3a20 7765 2075 7365 206d 756c  hwu): we use mul
+00010990: 7469 2d74 6872 6561 6420 746f 2072 756e  ti-thread to run
+000109a0: 2074 6865 2063 6f6d 6d61 6e64 7320 696e   the commands in
+000109b0: 2073 6574 7570 0a20 2020 2020 2020 2020   setup.         
+000109c0: 2020 2023 2063 6f6d 6d61 6e64 7320 696e     # commands in
+000109d0: 2070 6172 616c 6c65 6c2c 2077 6869 6368   parallel, which
+000109e0: 206d 616b 6573 2069 7420 696d 706f 7373   makes it imposs
+000109f0: 6962 6c65 2074 6f20 6661 696c 2066 6173  ible to fail fas
+00010a00: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+00010a10: 7768 656e 206f 6e65 206f 6620 7468 6520  when one of the 
+00010a20: 6e6f 6465 7320 6661 696c 732e 2057 6520  nodes fails. We 
+00010a30: 7368 6f75 6c64 2066 6978 2074 6869 7320  should fix this 
+00010a40: 696e 2074 6865 2066 7574 7572 652e 0a20  in the future.. 
+00010a50: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00010a60: 202d 2d64 6574 6163 682d 7365 7475 7020   --detach-setup 
+00010a70: 7665 7273 696f 6e20 6361 6e20 6661 696c  version can fail
+00010a80: 2066 6173 742c 2061 7320 7468 6520 7365   fast, as the se
+00010a90: 7475 7020 6973 0a20 2020 2020 2020 2020  tup is.         
+00010aa0: 2020 2023 2073 7562 6d69 7474 6564 2074     # submitted t
+00010ab0: 6f20 7468 6520 7265 6d6f 7465 206d 6163  o the remote mac
+00010ac0: 6869 6e65 2c20 7768 6963 6820 646f 6573  hine, which does
+00010ad0: 206e 6f74 2075 7365 206d 756c 7469 2d74   not use multi-t
+00010ae0: 6872 6561 642e 0a20 2020 2020 2020 2020  hread..         
+00010af0: 2020 2023 2052 6566 6572 2074 6f20 7468     # Refer to th
+00010b00: 6520 636f 6d6d 656e 7420 696e 2060 7375  e comment in `su
+00010b10: 6270 726f 6365 7373 5f75 7469 6c73 2e72  bprocess_utils.r
+00010b20: 756e 5f69 6e5f 7061 7261 6c6c 656c 602e  un_in_parallel`.
+00010b30: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
+00010b40: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00010b50: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00010b60: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00010b70: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00010b80: 732f 6661 696c 6564 5f77 6f72 6b65 725f  s/failed_worker_
+00010b90: 7365 7475 702e 7961 6d6c 2026 2620 6578  setup.yaml && ex
+00010ba0: 6974 2031 272c 2020 2320 456e 7375 7265  it 1',  # Ensure
+00010bb0: 2074 6865 206a 6f62 2073 6574 7570 2066   the job setup f
+00010bc0: 6169 6c65 642e 0a20 2020 2020 2020 2020  ailed..         
+00010bd0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00010be0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00010bf0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00010c00: 6f75 647d 202d 2d64 6574 6163 682d 7365  oud} --detach-se
+00010c10: 7475 7020 7465 7374 732f 7465 7374 5f79  tup tests/test_y
+00010c20: 616d 6c73 2f66 6169 6c65 645f 776f 726b  amls/failed_work
+00010c30: 6572 5f73 6574 7570 2e79 616d 6c27 2c0a  er_setup.yaml',.
+00010c40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00010c50: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00010c60: 2d2d 7374 6174 7573 207c 2067 7265 7020  --status | grep 
+00010c70: 4641 494c 4544 5f53 4554 5550 272c 2020  FAILED_SETUP',  
+00010c80: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00010c90: 2073 6574 7570 2066 6169 6c65 642e 0a20   setup failed.. 
+00010ca0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00010cb0: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
+00010cc0: 7473 2f74 6573 745f 7961 6d6c 732f 6661  ts/test_yamls/fa
+00010cd0: 696c 6564 5f77 6f72 6b65 725f 7275 6e2e  iled_worker_run.
+00010ce0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00010cf0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00010d00: 616d 657d 2032 202d 2d73 7461 7475 7320  ame} 2 --status 
+00010d10: 7c20 6772 6570 2046 4149 4c45 4427 2c20  | grep FAILED', 
+00010d20: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00010d30: 6220 6661 696c 6564 2e0a 2020 2020 2020  b failed..      
+00010d40: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00010d50: 207b 6e61 6d65 7d20 3220 7c20 6772 6570   {name} 2 | grep
+00010d60: 2022 4d79 2068 6f73 746e 616d 653a 2220   "My hostname:" 
+00010d70: 7c20 7763 202d 6c20 7c20 6772 6570 2032  | wc -l | grep 2
+00010d80: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00010d90: 7265 2032 206f 6620 7468 6520 686f 7374  re 2 of the host
+00010da0: 7320 7072 696e 7465 6420 7468 6569 7220  s printed their 
+00010db0: 686f 7374 6e61 6d65 2e0a 2020 2020 2020  hostname..      
+00010dc0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00010dd0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00010de0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00010df0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00010e00: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00010e10: 5765 6220 6170 7073 2077 6974 6820 6375  Web apps with cu
+00010e20: 7374 6f6d 2070 6f72 7473 206f 6e20 4743  stom ports on GC
+00010e30: 502e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  P. ----------.@p
+00010e40: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
+00010e50: 6566 2074 6573 745f 6763 705f 6874 7470  ef test_gcp_http
+00010e60: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
+00010e70: 746f 6d5f 706f 7274 7328 293a 0a20 2020  tom_ports():.   
+00010e80: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00010e90: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00010ea0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00010eb0: 2020 2020 2027 6763 705f 6874 7470 5f73       'gcp_http_s
+00010ec0: 6572 7665 725f 7769 7468 5f63 7573 746f  erver_with_custo
+00010ed0: 6d5f 706f 7274 7327 2c0a 2020 2020 2020  m_ports',.      
+00010ee0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00010ef0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00010f00: 2d64 202d 6320 7b6e 616d 657d 202d 2d63  -d -c {name} --c
+00010f10: 6c6f 7564 2067 6370 2065 7861 6d70 6c65  loud gcp example
+00010f20: 732f 6874 7470 5f73 6572 7665 725f 7769  s/http_server_wi
+00010f30: 7468 5f63 7573 746f 6d5f 706f 7274 732f  th_custom_ports/
+00010f40: 7461 736b 2e79 616d 6c27 2c0a 2020 2020  task.yaml',.    
+00010f50: 2020 2020 2020 2020 6627 756e 7469 6c20          f'until 
+00010f60: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+00010f70: 2073 6b79 2073 7461 7475 7320 2d2d 656e   sky status --en
+00010f80: 6470 6f69 6e74 2033 3338 3238 207b 6e61  dpoint 33828 {na
+00010f90: 6d65 7d3b 2064 6f20 736c 6565 7020 3130  me}; do sleep 10
+00010fa0: 3b20 646f 6e65 272c 0a20 2020 2020 2020  ; done',.       
+00010fb0: 2020 2020 2023 2052 6574 7279 2061 2066       # Retry a f
+00010fc0: 6577 2074 696d 6573 2074 6f20 6176 6f69  ew times to avoi
+00010fd0: 6420 666c 616b 696e 6573 7320 696e 2070  d flakiness in p
+00010fe0: 6f72 7473 2062 6569 6e67 206f 7065 6e2e  orts being open.
+00010ff0: 0a20 2020 2020 2020 2020 2020 2066 2769  .            f'i
+00011000: 703d 2428 534b 5950 494c 4f54 5f44 4542  p=$(SKYPILOT_DEB
+00011010: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
+00011020: 2d2d 656e 6470 6f69 6e74 2033 3338 3238  --endpoint 33828
+00011030: 207b 6e61 6d65 7d29 3b20 7375 6363 6573   {name}); succes
+00011040: 733d 6661 6c73 653b 2066 6f72 2069 2069  s=false; for i i
+00011050: 6e20 2428 7365 7120 3120 3529 3b20 646f  n $(seq 1 5); do
+00011060: 2069 6620 6375 726c 2024 6970 207c 2067   if curl $ip | g
+00011070: 7265 7020 223c 6831 3e54 6869 7320 6973  rep "<h1>This is
+00011080: 2061 2064 656d 6f20 4854 4d4c 2070 6167   a demo HTML pag
+00011090: 652e 3c2f 6831 3e22 3b20 7468 656e 2073  e.</h1>"; then s
+000110a0: 7563 6365 7373 3d74 7275 653b 2062 7265  uccess=true; bre
+000110b0: 616b 3b20 6669 3b20 736c 6565 7020 3130  ak; fi; sleep 10
+000110c0: 3b20 646f 6e65 3b20 6966 205b 2022 2473  ; done; if [ "$s
+000110d0: 7563 6365 7373 2220 3d20 6661 6c73 6520  uccess" = false 
+000110e0: 5d3b 2074 6865 6e20 6578 6974 2031 3b20  ]; then exit 1; 
+000110f0: 6669 272c 0a20 2020 2020 2020 205d 2c0a  fi',.        ],.
+00011100: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00011110: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00011120: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00011130: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00011140: 2d2d 2d2d 2d2d 2d2d 2d2d 2057 6562 2061  ---------- Web a
+00011150: 7070 7320 7769 7468 2063 7573 746f 6d20  pps with custom 
+00011160: 706f 7274 7320 6f6e 2041 5753 2e20 2d2d  ports on AWS. --
+00011170: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00011180: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
+00011190: 7374 5f61 7773 5f68 7474 705f 7365 7276  st_aws_http_serv
+000111a0: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
+000111b0: 6f72 7473 2829 3a0a 2020 2020 6e61 6d65  orts():.    name
+000111c0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000111d0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000111e0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+000111f0: 2761 7773 5f68 7474 705f 7365 7276 6572  'aws_http_server
+00011200: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
+00011210: 7473 272c 0a20 2020 2020 2020 205b 0a20  ts',.        [. 
+00011220: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00011230: 206c 6175 6e63 6820 2d79 202d 6420 2d63   launch -y -d -c
+00011240: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00011250: 6177 7320 6578 616d 706c 6573 2f68 7474  aws examples/htt
+00011260: 705f 7365 7276 6572 5f77 6974 685f 6375  p_server_with_cu
+00011270: 7374 6f6d 5f70 6f72 7473 2f74 6173 6b2e  stom_ports/task.
+00011280: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00011290: 2020 2066 2775 6e74 696c 2053 4b59 5049     f'until SKYPI
+000112a0: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
+000112b0: 7374 6174 7573 202d 2d65 6e64 706f 696e  status --endpoin
+000112c0: 7420 3333 3832 3820 7b6e 616d 657d 3b20  t 33828 {name}; 
+000112d0: 646f 2073 6c65 6570 2031 303b 2064 6f6e  do sleep 10; don
+000112e0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+000112f0: 2320 5265 7472 7920 6120 6665 7720 7469  # Retry a few ti
+00011300: 6d65 7320 746f 2061 766f 6964 2066 6c61  mes to avoid fla
+00011310: 6b69 6e65 7373 2069 6e20 706f 7274 7320  kiness in ports 
+00011320: 6265 696e 6720 6f70 656e 2e0a 2020 2020  being open..    
+00011330: 2020 2020 2020 2020 6627 6970 3d24 2853          f'ip=$(S
+00011340: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
+00011350: 736b 7920 7374 6174 7573 202d 2d65 6e64  sky status --end
+00011360: 706f 696e 7420 3333 3832 3820 7b6e 616d  point 33828 {nam
+00011370: 657d 293b 2073 7563 6365 7373 3d66 616c  e}); success=fal
+00011380: 7365 3b20 666f 7220 6920 696e 2024 2873  se; for i in $(s
+00011390: 6571 2031 2035 293b 2064 6f20 6966 2063  eq 1 5); do if c
+000113a0: 7572 6c20 2469 7020 7c20 6772 6570 2022  url $ip | grep "
+000113b0: 3c68 313e 5468 6973 2069 7320 6120 6465  <h1>This is a de
+000113c0: 6d6f 2048 544d 4c20 7061 6765 2e3c 2f68  mo HTML page.</h
+000113d0: 313e 223b 2074 6865 6e20 7375 6363 6573  1>"; then succes
+000113e0: 733d 7472 7565 3b20 6272 6561 6b3b 2066  s=true; break; f
+000113f0: 693b 2073 6c65 6570 2031 303b 2064 6f6e  i; sleep 10; don
+00011400: 653b 2069 6620 5b20 2224 7375 6363 6573  e; if [ "$succes
+00011410: 7322 203d 2066 616c 7365 205d 3b20 7468  s" = false ]; th
+00011420: 656e 2065 7869 7420 313b 2066 6927 0a20  en exit 1; fi'. 
+00011430: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00011440: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00011450: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00011460: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00011470: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00011480: 2d2d 2d2d 2057 6562 2061 7070 7320 7769  ---- Web apps wi
+00011490: 7468 2063 7573 746f 6d20 706f 7274 7320  th custom ports 
+000114a0: 6f6e 2041 7a75 7265 2e20 2d2d 2d2d 2d2d  on Azure. ------
+000114b0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+000114c0: 6b2e 617a 7572 650a 6465 6620 7465 7374  k.azure.def test
+000114d0: 5f61 7a75 7265 5f68 7474 705f 7365 7276  _azure_http_serv
+000114e0: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
+000114f0: 6f72 7473 2829 3a0a 2020 2020 6e61 6d65  orts():.    name
+00011500: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00011510: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00011520: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00011530: 2761 7a75 7265 5f68 7474 705f 7365 7276  'azure_http_serv
+00011540: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
+00011550: 6f72 7473 272c 0a20 2020 2020 2020 205b  orts',.        [
+00011560: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00011570: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
+00011580: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00011590: 6420 617a 7572 6520 6578 616d 706c 6573  d azure examples
+000115a0: 2f68 7474 705f 7365 7276 6572 5f77 6974  /http_server_wit
+000115b0: 685f 6375 7374 6f6d 5f70 6f72 7473 2f74  h_custom_ports/t
+000115c0: 6173 6b2e 7961 6d6c 272c 0a20 2020 2020  ask.yaml',.     
+000115d0: 2020 2020 2020 2066 2775 6e74 696c 2053         f'until S
+000115e0: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
+000115f0: 736b 7920 7374 6174 7573 202d 2d65 6e64  sky status --end
+00011600: 706f 696e 7420 3333 3832 3820 7b6e 616d  point 33828 {nam
+00011610: 657d 3b20 646f 2073 6c65 6570 2031 303b  e}; do sleep 10;
+00011620: 2064 6f6e 6527 2c0a 2020 2020 2020 2020   done',.        
+00011630: 2020 2020 2320 5265 7472 7920 6120 6665      # Retry a fe
+00011640: 7720 7469 6d65 7320 746f 2061 766f 6964  w times to avoid
+00011650: 2066 6c61 6b69 6e65 7373 2069 6e20 706f   flakiness in po
+00011660: 7274 7320 6265 696e 6720 6f70 656e 2e0a  rts being open..
+00011670: 2020 2020 2020 2020 2020 2020 6627 6970              f'ip
+00011680: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
+00011690: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
+000116a0: 2d65 6e64 706f 696e 7420 3333 3832 3820  -endpoint 33828 
+000116b0: 7b6e 616d 657d 293b 2073 7563 6365 7373  {name}); success
+000116c0: 3d66 616c 7365 3b20 666f 7220 6920 696e  =false; for i in
+000116d0: 2024 2873 6571 2031 2035 293b 2064 6f20   $(seq 1 5); do 
+000116e0: 6966 2063 7572 6c20 2469 7020 7c20 6772  if curl $ip | gr
+000116f0: 6570 2022 3c68 313e 5468 6973 2069 7320  ep "<h1>This is 
+00011700: 6120 6465 6d6f 2048 544d 4c20 7061 6765  a demo HTML page
+00011710: 2e3c 2f68 313e 223b 2074 6865 6e20 7375  .</h1>"; then su
+00011720: 6363 6573 733d 7472 7565 3b20 6272 6561  ccess=true; brea
+00011730: 6b3b 2066 693b 2073 6c65 6570 2031 303b  k; fi; sleep 10;
+00011740: 2064 6f6e 653b 2069 6620 5b20 2224 7375   done; if [ "$su
+00011750: 6363 6573 7322 203d 2066 616c 7365 205d  ccess" = false ]
+00011760: 3b20 7468 656e 2065 7869 7420 313b 2066  ; then exit 1; f
+00011770: 6927 0a20 2020 2020 2020 205d 2c0a 2020  i'.        ],.  
+00011780: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00011790: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+000117a0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+000117b0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+000117c0: 2d2d 2d2d 2d2d 2d2d 2057 6562 2061 7070  -------- Web app
+000117d0: 7320 7769 7468 2063 7573 746f 6d20 706f  s with custom po
+000117e0: 7274 7320 6f6e 204b 7562 6572 6e65 7465  rts on Kubernete
+000117f0: 732e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  s. ----------.@p
+00011800: 7974 6573 742e 6d61 726b 2e6b 7562 6572  ytest.mark.kuber
+00011810: 6e65 7465 730a 6465 6620 7465 7374 5f6b  netes.def test_k
+00011820: 7562 6572 6e65 7465 735f 6874 7470 5f73  ubernetes_http_s
+00011830: 6572 7665 725f 7769 7468 5f63 7573 746f  erver_with_custo
+00011840: 6d5f 706f 7274 7328 293a 0a20 2020 206e  m_ports():.    n
+00011850: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00011860: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00011870: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00011880: 2020 2027 6b75 6265 726e 6574 6573 5f68     'kubernetes_h
+00011890: 7474 705f 7365 7276 6572 5f77 6974 685f  ttp_server_with_
+000118a0: 6375 7374 6f6d 5f70 6f72 7473 272c 0a20  custom_ports',. 
+000118b0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000118c0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000118d0: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
+000118e0: 7d20 2d2d 636c 6f75 6420 6b75 6265 726e  } --cloud kubern
+000118f0: 6574 6573 2065 7861 6d70 6c65 732f 6874  etes examples/ht
+00011900: 7470 5f73 6572 7665 725f 7769 7468 5f63  tp_server_with_c
+00011910: 7573 746f 6d5f 706f 7274 732f 7461 736b  ustom_ports/task
+00011920: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00011930: 2020 2020 6627 756e 7469 6c20 534b 5950      f'until SKYP
+00011940: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
+00011950: 2073 7461 7475 7320 2d2d 656e 6470 6f69   status --endpoi
+00011960: 6e74 2033 3338 3238 207b 6e61 6d65 7d3b  nt 33828 {name};
+00011970: 2064 6f20 736c 6565 7020 3130 3b20 646f   do sleep 10; do
+00011980: 6e65 272c 0a20 2020 2020 2020 2020 2020  ne',.           
+00011990: 2023 2052 6574 7279 2061 2066 6577 2074   # Retry a few t
+000119a0: 696d 6573 2074 6f20 6176 6f69 6420 666c  imes to avoid fl
+000119b0: 616b 696e 6573 7320 696e 2070 6f72 7473  akiness in ports
+000119c0: 2062 6569 6e67 206f 7065 6e2e 0a20 2020   being open..   
+000119d0: 2020 2020 2020 2020 2066 2769 703d 2428           f'ip=$(
+000119e0: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+000119f0: 2073 6b79 2073 7461 7475 7320 2d2d 656e   sky status --en
+00011a00: 6470 6f69 6e74 2033 3338 3238 207b 6e61  dpoint 33828 {na
+00011a10: 6d65 7d29 3b20 7375 6363 6573 733d 6661  me}); success=fa
+00011a20: 6c73 653b 2066 6f72 2069 2069 6e20 2428  lse; for i in $(
+00011a30: 7365 7120 3120 3130 3029 3b20 646f 2069  seq 1 100); do i
+00011a40: 6620 6375 726c 2024 6970 207c 2067 7265  f curl $ip | gre
+00011a50: 7020 223c 6831 3e54 6869 7320 6973 2061  p "<h1>This is a
+00011a60: 2064 656d 6f20 4854 4d4c 2070 6167 652e   demo HTML page.
+00011a70: 3c2f 6831 3e22 3b20 7468 656e 2073 7563  </h1>"; then suc
+00011a80: 6365 7373 3d74 7275 653b 2062 7265 616b  cess=true; break
+00011a90: 3b20 6669 3b20 736c 6565 7020 353b 2064  ; fi; sleep 5; d
+00011aa0: 6f6e 653b 2069 6620 5b20 2224 7375 6363  one; if [ "$succ
+00011ab0: 6573 7322 203d 2066 616c 7365 205d 3b20  ess" = false ]; 
+00011ac0: 7468 656e 2065 7869 7420 313b 2066 6927  then exit 1; fi'
+00011ad0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00011ae0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00011af0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00011b00: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00011b10: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00011b20: 2d2d 2d2d 2d2d 2057 6562 2061 7070 7320  ------ Web apps 
+00011b30: 7769 7468 2063 7573 746f 6d20 706f 7274  with custom port
+00011b40: 7320 6f6e 2050 6170 6572 7370 6163 652e  s on Paperspace.
+00011b50: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+00011b60: 6573 742e 6d61 726b 2e70 6170 6572 7370  est.mark.papersp
+00011b70: 6163 650a 6465 6620 7465 7374 5f70 6170  ace.def test_pap
+00011b80: 6572 7370 6163 655f 6874 7470 5f73 6572  erspace_http_ser
+00011b90: 7665 725f 7769 7468 5f63 7573 746f 6d5f  ver_with_custom_
+00011ba0: 706f 7274 7328 293a 0a20 2020 206e 616d  ports():.    nam
+00011bb0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00011bc0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00011bd0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00011be0: 2027 7061 7065 7273 7061 6365 5f68 7474   'paperspace_htt
+00011bf0: 705f 7365 7276 6572 5f77 6974 685f 6375  p_server_with_cu
+00011c00: 7374 6f6d 5f70 6f72 7473 272c 0a20 2020  stom_ports',.   
+00011c10: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00011c20: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00011c30: 2d79 202d 6420 2d63 207b 6e61 6d65 7d20  -y -d -c {name} 
+00011c40: 2d2d 636c 6f75 6420 7061 7065 7273 7061  --cloud paperspa
+00011c50: 6365 2065 7861 6d70 6c65 732f 6874 7470  ce examples/http
+00011c60: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
+00011c70: 746f 6d5f 706f 7274 732f 7461 736b 2e79  tom_ports/task.y
+00011c80: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00011c90: 2020 6627 756e 7469 6c20 534b 5950 494c    f'until SKYPIL
+00011ca0: 4f54 5f44 4542 5547 3d30 2073 6b79 2073  OT_DEBUG=0 sky s
+00011cb0: 7461 7475 7320 2d2d 656e 6470 6f69 6e74  tatus --endpoint
+00011cc0: 2033 3338 3238 207b 6e61 6d65 7d3b 2064   33828 {name}; d
+00011cd0: 6f20 736c 6565 7020 3130 3b20 646f 6e65  o sleep 10; done
+00011ce0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00011cf0: 2052 6574 7279 2061 2066 6577 2074 696d   Retry a few tim
+00011d00: 6573 2074 6f20 6176 6f69 6420 666c 616b  es to avoid flak
+00011d10: 696e 6573 7320 696e 2070 6f72 7473 2062  iness in ports b
+00011d20: 6569 6e67 206f 7065 6e2e 0a20 2020 2020  eing open..     
+00011d30: 2020 2020 2020 2066 2769 703d 2428 534b         f'ip=$(SK
+00011d40: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
+00011d50: 6b79 2073 7461 7475 7320 2d2d 656e 6470  ky status --endp
+00011d60: 6f69 6e74 2033 3338 3238 207b 6e61 6d65  oint 33828 {name
+00011d70: 7d29 3b20 7375 6363 6573 733d 6661 6c73  }); success=fals
+00011d80: 653b 2066 6f72 2069 2069 6e20 2428 7365  e; for i in $(se
+00011d90: 7120 3120 3529 3b20 646f 2069 6620 6375  q 1 5); do if cu
+00011da0: 726c 2024 6970 207c 2067 7265 7020 223c  rl $ip | grep "<
+00011db0: 6831 3e54 6869 7320 6973 2061 2064 656d  h1>This is a dem
+00011dc0: 6f20 4854 4d4c 2070 6167 652e 3c2f 6831  o HTML page.</h1
+00011dd0: 3e22 3b20 7468 656e 2073 7563 6365 7373  >"; then success
+00011de0: 3d74 7275 653b 2062 7265 616b 3b20 6669  =true; break; fi
+00011df0: 3b20 736c 6565 7020 3130 3b20 646f 6e65  ; sleep 10; done
+00011e00: 3b20 6966 205b 2022 2473 7563 6365 7373  ; if [ "$success
+00011e10: 2220 3d20 6661 6c73 6520 5d3b 2074 6865  " = false ]; the
+00011e20: 6e20 6578 6974 2031 3b20 6669 272c 0a20  n exit 1; fi',. 
+00011e30: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00011e40: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00011e50: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00011e60: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00011e70: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00011e80: 2d2d 2d2d 2054 6173 6b3a 206e 3d32 206e  ---- Task: n=2 n
+00011e90: 6f64 6573 2077 6974 6820 7365 7475 7073  odes with setups
+00011ea0: 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  . ----------.@py
+00011eb0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+00011ec0: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+00011ed0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+00011ee0: 6f74 2068 6176 6520 5631 3030 2067 7075  ot have V100 gpu
+00011ef0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+00011f00: 6f5f 6962 6d20 2023 2049 424d 2063 6c6f  o_ibm  # IBM clo
+00011f10: 7564 2063 7572 7265 6e74 6c79 2064 6f65  ud currently doe
+00011f20: 736e 2774 2070 726f 7669 6465 2070 7562  sn't provide pub
+00011f30: 6c69 6320 696d 6167 6520 7769 7468 2043  lic image with C
+00011f40: 5544 410a 4070 7974 6573 742e 6d61 726b  UDA.@pytest.mark
+00011f50: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+00011f60: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00011f70: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
+00011f80: 740a 4070 7974 6573 742e 6d61 726b 2e73  t.@pytest.mark.s
+00011f90: 6b69 7028 0a20 2020 2072 6561 736f 6e3d  kip(.    reason=
+00011fa0: 0a20 2020 2027 5468 6520 7265 736e 6574  .    'The resnet
+00011fb0: 5f64 6973 7472 6962 7574 6564 5f74 665f  _distributed_tf_
+00011fc0: 6170 7020 6973 2066 6c61 6b79 2c20 6475  app is flaky, du
+00011fd0: 6520 746f 2069 7420 6661 696c 696e 6720  e to it failing 
+00011fe0: 746f 2064 6574 6563 7420 4750 5573 2e27  to detect GPUs.'
+00011ff0: 290a 6465 6620 7465 7374 5f64 6973 7472  ).def test_distr
+00012000: 6962 7574 6564 5f74 6628 6765 6e65 7269  ibuted_tf(generi
+00012010: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00012020: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00012030: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00012040: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00012050: 2020 2020 2020 2027 7265 736e 6574 5f64         'resnet_d
+00012060: 6973 7472 6962 7574 6564 5f74 665f 6170  istributed_tf_ap
+00012070: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+00012080: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+00012090: 3a20 7275 6e6e 696e 6720 6974 2074 7769  : running it twi
+000120a0: 6365 2077 696c 6c20 6861 6e67 2028 736f  ce will hang (so
+000120b0: 6d65 7469 6d65 733f 2920 2d20 616e 2061  metimes?) - an a
+000120c0: 7070 2d6c 6576 656c 2062 7567 2e0a 2020  pp-level bug..  
+000120d0: 2020 2020 2020 2020 2020 6627 7079 7468            f'pyth
+000120e0: 6f6e 2065 7861 6d70 6c65 732f 7265 736e  on examples/resn
+000120f0: 6574 5f64 6973 7472 6962 7574 6564 5f74  et_distributed_t
+00012100: 665f 6170 702e 7079 207b 6e61 6d65 7d20  f_app.py {name} 
+00012110: 7b67 656e 6572 6963 5f63 6c6f 7564 7d27  {generic_cloud}'
+00012120: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00012130: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00012140: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+00012150: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+00012160: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+00012170: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00012180: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00012190: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+000121a0: 6f75 743d 3235 202a 2036 302c 2020 2320  out=25 * 60,  # 
+000121b0: 3235 206d 696e 7320 2869 7420 7461 6b65  25 mins (it take
+000121c0: 7320 6172 6f75 6e64 207e 3139 206d 696e  s around ~19 min
+000121d0: 7329 0a20 2020 2029 0a20 2020 2072 756e  s).    ).    run
+000121e0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000121f0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+00012200: 6573 7469 6e67 2047 4350 2073 7461 7274  esting GCP start
+00012210: 2061 6e64 2073 746f 7020 696e 7374 616e   and stop instan
+00012220: 6365 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  ces ----------.@
+00012230: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00012240: 6465 6620 7465 7374 5f67 6370 5f73 7461  def test_gcp_sta
+00012250: 7274 5f73 746f 7028 293a 0a20 2020 206e  rt_stop():.    n
+00012260: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00012270: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00012280: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00012290: 2020 2027 6763 702d 7374 6172 742d 7374     'gcp-start-st
+000122a0: 6f70 272c 0a20 2020 2020 2020 205b 0a20  op',.        [. 
+000122b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000122c0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+000122d0: 616d 657d 2065 7861 6d70 6c65 732f 6763  ame} examples/gc
+000122e0: 705f 7374 6172 745f 7374 6f70 2e79 616d  p_start_stop.yam
+000122f0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00012300: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00012310: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00012320: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00012330: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00012340: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00012350: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
+00012360: 6573 2f67 6370 5f73 7461 7274 5f73 746f  es/gcp_start_sto
+00012370: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
+00012380: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00012390: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+000123a0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+000123b0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+000123c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000123d0: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
+000123e0: 7072 6c69 6d69 7420 2d6e 202d 2d70 6964  prlimit -n --pid
+000123f0: 3d5c 2428 7067 7265 7020 2d66 205c 2772  =\$(pgrep -f \'r
+00012400: 6179 6c65 742f 7261 796c 6574 202d 2d72  aylet/raylet --r
+00012410: 6179 6c65 745f 736f 636b 6574 5f6e 616d  aylet_socket_nam
+00012420: 655c 2729 207c 2067 7265 7020 5c27 225c  e\') | grep \'"\
+00012430: 2731 3034 3835 3736 2031 3034 3835 3736  '1048576 1048576
+00012440: 5c27 225c 2722 272c 2020 2320 456e 7375  \'"\'"',  # Ensu
+00012450: 7265 2074 6865 2072 6179 6c65 7420 7072  re the raylet pr
+00012460: 6f63 6573 7320 6861 7320 7468 6520 636f  ocess has the co
+00012470: 7272 6563 7420 6669 6c65 2064 6573 6372  rrect file descr
+00012480: 6970 746f 7220 6c69 6d69 742e 0a20 2020  iptor limit..   
+00012490: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000124a0: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+000124b0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+000124c0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+000124d0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+000124e0: 2066 2773 6b79 2073 746f 7020 2d79 207b   f'sky stop -y {
+000124f0: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+00012500: 2020 2020 6627 736c 6565 7020 3230 272c      f'sleep 20',
+00012510: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00012520: 6b79 2073 7461 7274 202d 7920 7b6e 616d  ky start -y {nam
+00012530: 657d 202d 6920 3127 2c0a 2020 2020 2020  e} -i 1',.      
+00012540: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00012550: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00012560: 2f67 6370 5f73 7461 7274 5f73 746f 702e  /gcp_start_stop.
+00012570: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00012580: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00012590: 616d 657d 2034 202d 2d73 7461 7475 7327  ame} 4 --status'
+000125a0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+000125b0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+000125c0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000125d0: 7020 3138 3027 2c0a 2020 2020 2020 2020  p 180',.        
+000125e0: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+000125f0: 202d 7220 7b6e 616d 657d 207c 2067 7265   -r {name} | gre
+00012600: 7020 2249 4e49 545c 7c53 544f 5050 4544  p "INIT\|STOPPED
+00012610: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
+00012620: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00012630: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00012640: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00012650: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+00012660: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
+00012670: 6720 417a 7572 6520 7374 6172 7420 616e  g Azure start an
+00012680: 6420 7374 6f70 2069 6e73 7461 6e63 6573  d stop instances
+00012690: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+000126a0: 6573 742e 6d61 726b 2e61 7a75 7265 0a64  est.mark.azure.d
+000126b0: 6566 2074 6573 745f 617a 7572 655f 7374  ef test_azure_st
+000126c0: 6172 745f 7374 6f70 2829 3a0a 2020 2020  art_stop():.    
+000126d0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000126e0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+000126f0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00012700: 2020 2020 2761 7a75 7265 2d73 7461 7274      'azure-start
+00012710: 2d73 746f 7027 2c0a 2020 2020 2020 2020  -stop',.        
+00012720: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00012730: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00012740: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00012750: 2f61 7a75 7265 5f73 7461 7274 5f73 746f  /azure_start_sto
+00012760: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
+00012770: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00012780: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+00012790: 617a 7572 655f 7374 6172 745f 7374 6f70  azure_start_stop
+000127a0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000127b0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+000127c0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+000127d0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+000127e0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+000127f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00012800: 7920 6578 6563 207b 6e61 6d65 7d20 2270  y exec {name} "p
+00012810: 726c 696d 6974 202d 6e20 2d2d 7069 643d  rlimit -n --pid=
+00012820: 5c24 2870 6772 6570 202d 6620 5c27 7261  \$(pgrep -f \'ra
+00012830: 796c 6574 2f72 6179 6c65 7420 2d2d 7261  ylet/raylet --ra
+00012840: 796c 6574 5f73 6f63 6b65 745f 6e61 6d65  ylet_socket_name
+00012850: 5c27 2920 7c20 6772 6570 205c 2722 5c27  \') | grep \'"\'
+00012860: 3130 3438 3537 3620 3130 3438 3537 365c  1048576 1048576\
+00012870: 2722 5c27 2227 2c20 2023 2045 6e73 7572  '"\'"',  # Ensur
+00012880: 6520 7468 6520 7261 796c 6574 2070 726f  e the raylet pro
+00012890: 6365 7373 2068 6173 2074 6865 2063 6f72  cess has the cor
+000128a0: 7265 6374 2066 696c 6520 6465 7363 7269  rect file descri
+000128b0: 7074 6f72 206c 696d 6974 2e0a 2020 2020  ptor limit..    
+000128c0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000128d0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+000128e0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+000128f0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00012900: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00012910: 6627 736b 7920 7374 6f70 202d 7920 7b6e  f'sky stop -y {n
+00012920: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+00012930: 2020 2066 2773 6b79 2073 7461 7274 202d     f'sky start -
+00012940: 7920 7b6e 616d 657d 202d 6920 3127 2c0a  y {name} -i 1',.
+00012950: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00012960: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
+00012970: 616d 706c 6573 2f61 7a75 7265 5f73 7461  amples/azure_sta
+00012980: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
+00012990: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000129a0: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
+000129b0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000129c0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000129d0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+000129e0: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
+000129f0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00012a00: 2428 736b 7920 7374 6174 7573 202d 7220  $(sky status -r 
+00012a10: 7b6e 616d 657d 2920 2626 2065 6368 6f20  {name}) && echo 
+00012a20: 2473 2026 2620 6563 686f 2024 7320 7c20  $s && echo $s | 
+00012a30: 6772 6570 2022 494e 4954 5c7c 5354 4f50  grep "INIT\|STOP
+00012a40: 5045 4422 270a 2020 2020 2020 2020 5d2c  PED"'.        ],
+00012a50: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00012a60: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00012a70: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00012a80: 3330 202a 2036 302c 2020 2320 3330 206d  30 * 60,  # 30 m
+00012a90: 696e 730a 2020 2020 290a 2020 2020 7275  ins.    ).    ru
+00012aa0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00012ab0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00012ac0: 5465 7374 696e 6720 4175 746f 7374 6f70  Testing Autostop
+00012ad0: 7069 6e67 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ping ----------.
+00012ae0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00012af0: 666c 7569 6473 7461 636b 2020 2320 466c  fluidstack  # Fl
+00012b00: 7569 6453 7461 636b 2064 6f65 7320 6e6f  uidStack does no
+00012b10: 7420 7375 7070 6f72 7420 7374 6f70 7069  t support stoppi
+00012b20: 6e67 2069 6e20 536b 7950 696c 6f74 2069  ng in SkyPilot i
+00012b30: 6d70 6c65 6d65 6e74 6174 696f 6e0a 4070  mplementation.@p
+00012b40: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+00012b50: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
+00012b60: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
+00012b70: 6e6f 7420 7375 7070 6f72 7420 7374 6f70  not support stop
+00012b80: 7069 6e67 2069 6e73 7461 6e63 6573 0a40  ping instances.@
+00012b90: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+00012ba0: 626d 2020 2320 4649 5828 4942 4d29 2073  bm  # FIX(IBM) s
+00012bb0: 706f 7261 6469 6361 6c6c 7920 6661 696c  poradically fail
+00012bc0: 732c 2061 7320 7265 7374 6172 7465 6420  s, as restarted 
+00012bd0: 776f 726b 6572 7320 7374 6179 2075 6e69  workers stay uni
+00012be0: 6e69 7469 616c 697a 6564 2069 6e64 6566  nitialized indef
+00012bf0: 696e 6974 656c 790a 4070 7974 6573 742e  initely.@pytest.
+00012c00: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+00012c10: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+00012c20: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
+00012c30: 3120 7965 740a 4070 7974 6573 742e 6d61  1 yet.@pytest.ma
+00012c40: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00012c50: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
+00012c60: 6f65 7320 6e6f 7420 6175 746f 7374 6f70  oes not autostop
+00012c70: 2079 6574 0a64 6566 2074 6573 745f 6175   yet.def test_au
+00012c80: 746f 7374 6f70 2867 656e 6572 6963 5f63  tostop(generic_c
+00012c90: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00012ca0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00012cb0: 7465 725f 6e61 6d65 2829 0a20 2020 2023  ter_name().    #
+00012cc0: 2041 7a75 7265 2074 616b 6573 207e 2037   Azure takes ~ 7
+00012cd0: 6d31 3573 2028 3433 3573 2920 746f 2061  m15s (435s) to a
+00012ce0: 7574 6f73 746f 7020 6120 564d 2c20 736f  utostop a VM, so
+00012cf0: 2068 6572 6520 7765 2075 7365 2036 3030   here we use 600
+00012d00: 2074 6f20 656e 7375 7265 0a20 2020 2023   to ensure.    #
+00012d10: 2074 6865 2056 4d20 6973 2073 746f 7070   the VM is stopp
+00012d20: 6564 2e0a 2020 2020 6175 746f 7374 6f70  ed..    autostop
+00012d30: 5f74 696d 656f 7574 203d 2036 3030 2069  _timeout = 600 i
+00012d40: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
+00012d50: 3d3d 2027 617a 7572 6527 2065 6c73 6520  == 'azure' else 
+00012d60: 3235 300a 2020 2020 2320 4c61 756e 6368  250.    # Launch
+00012d70: 696e 6720 616e 6420 7374 6172 7469 6e67  ing and starting
+00012d80: 2041 7a75 7265 2063 6c75 7374 6572 7320   Azure clusters 
+00012d90: 6361 6e20 7461 6b65 2061 206c 6f6e 6720  can take a long 
+00012da0: 7469 6d65 2074 6f6f 2e20 652e 672e 2c20  time too. e.g., 
+00012db0: 7265 7374 6172 740a 2020 2020 2320 6120  restart.    # a 
+00012dc0: 7374 6f70 7065 6420 417a 7572 6520 636c  stopped Azure cl
+00012dd0: 7573 7465 7220 6361 6e20 7461 6b65 2037  uster can take 7
+00012de0: 6d2e 2053 6f20 7765 2073 6574 2074 6865  m. So we set the
+00012df0: 2074 6f74 616c 2074 696d 656f 7574 2074   total timeout t
+00012e00: 6f20 3730 6d2e 0a20 2020 2074 6f74 616c  o 70m..    total
+00012e10: 5f74 696d 656f 7574 5f6d 696e 7574 6573  _timeout_minutes
+00012e20: 203d 2037 3020 6966 2067 656e 6572 6963   = 70 if generic
+00012e30: 5f63 6c6f 7564 203d 3d20 2761 7a75 7265  _cloud == 'azure
+00012e40: 2720 656c 7365 2032 300a 2020 2020 7465  ' else 20.    te
+00012e50: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00012e60: 2020 2027 6175 746f 7374 6f70 272c 0a20     'autostop',. 
+00012e70: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00012e80: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00012e90: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
+00012ea0: 7d20 2d2d 6e75 6d2d 6e6f 6465 7320 3220  } --num-nodes 2 
+00012eb0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00012ec0: 5f63 6c6f 7564 7d20 7465 7374 732f 7465  _cloud} tests/te
+00012ed0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+00012ee0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00012ef0: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+00012f00: 6f70 202d 7920 7b6e 616d 657d 202d 6920  op -y {name} -i 
+00012f10: 3127 2c0a 0a20 2020 2020 2020 2020 2020  1',..           
+00012f20: 2023 2045 6e73 7572 6520 6175 746f 7374   # Ensure autost
+00012f30: 6f70 2069 7320 7365 742e 0a20 2020 2020  op is set..     
+00012f40: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00012f50: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
+00012f60: 7d20 7c20 6772 6570 2022 316d 2227 2c0a  } | grep "1m"',.
+00012f70: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00012f80: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00012f90: 7220 6973 206e 6f74 2073 746f 7070 6564  r is not stopped
+00012fa0: 2065 6172 6c79 2e0a 2020 2020 2020 2020   early..        
+00012fb0: 2020 2020 2773 6c65 6570 2034 3027 2c0a      'sleep 40',.
+00012fc0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00012fd0: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
+00012fe0: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
+00012ff0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+00013000: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+00013010: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
+00013020: 7c20 6772 6570 2055 5027 2c0a 0a20 2020  | grep UP',..   
+00013030: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00013040: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+00013050: 2053 544f 5050 4544 2e0a 2020 2020 2020   STOPPED..      
+00013060: 2020 2020 2020 6627 736c 6565 7020 7b61        f'sleep {a
+00013070: 7574 6f73 746f 705f 7469 6d65 6f75 747d  utostop_timeout}
+00013080: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00013090: 2773 3d24 2873 6b79 2073 7461 7475 7320  's=$(sky status 
+000130a0: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
+000130b0: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+000130c0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+000130d0: 2473 2220 207c 2067 7265 7020 7b6e 616d  $s"  | grep {nam
+000130e0: 657d 207c 2067 7265 7020 5354 4f50 5045  e} | grep STOPPE
+000130f0: 4427 2c0a 0a20 2020 2020 2020 2020 2020  D',..           
+00013100: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+00013110: 7573 7465 7220 6973 2055 5020 616e 6420  uster is UP and 
+00013120: 7468 6520 6175 746f 7374 6f70 2073 6574  the autostop set
+00013130: 7469 6e67 2069 7320 7265 7365 7420 2827  ting is reset ('
+00013140: 2d27 292e 0a20 2020 2020 2020 2020 2020  -')..           
+00013150: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
+00013160: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+00013170: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00013180: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
+00013190: 7c20 6772 6570 202d 4520 2255 505c 732b  | grep -E "UP\s+
+000131a0: 2d22 272c 0a0a 2020 2020 2020 2020 2020  -"',..          
+000131b0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+000131c0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+000131d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000131e0: 6578 6563 207b 6e61 6d65 7d20 7465 7374  exec {name} test
+000131f0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+00013200: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00013210: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00013220: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00013230: 6174 7573 272c 0a0a 2020 2020 2020 2020  atus',..        
+00013240: 2020 2020 2320 5465 7374 2072 6573 7461      # Test resta
+00013250: 7274 696e 6720 7468 6520 6964 6c65 6e65  rting the idlene
+00013260: 7373 2074 696d 6572 2076 6961 2072 6573  ss timer via res
+00013270: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+00013280: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
+00013290: 7920 7b6e 616d 657d 202d 6920 3127 2c20  y {name} -i 1', 
+000132a0: 2023 2049 646c 656e 6573 7320 7374 6172   # Idleness star
+000132b0: 7473 2063 6f75 6e74 696e 672e 0a20 2020  ts counting..   
+000132c0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+000132d0: 3430 272c 2020 2320 416c 6d6f 7374 2072  40',  # Almost r
+000132e0: 6561 6368 6564 2074 6865 2074 6872 6573  eached the thres
+000132f0: 686f 6c64 2e0a 2020 2020 2020 2020 2020  hold..          
+00013300: 2020 6627 736b 7920 6175 746f 7374 6f70    f'sky autostop
+00013310: 202d 7920 7b6e 616d 657d 202d 6920 3127   -y {name} -i 1'
+00013320: 2c20 2023 2053 686f 756c 6420 7265 7374  ,  # Should rest
+00013330: 6172 7420 7468 6520 7469 6d65 722e 0a20  art the timer.. 
+00013340: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00013350: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
+00013360: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+00013370: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+00013380: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+00013390: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+000133a0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+000133b0: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
+000133c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000133d0: 736c 6565 7020 7b61 7574 6f73 746f 705f  sleep {autostop_
+000133e0: 7469 6d65 6f75 747d 272c 0a20 2020 2020  timeout}',.     
+000133f0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00013400: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+00013410: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+00013420: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+00013430: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+00013440: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00013450: 7020 5354 4f50 5045 4427 2c0a 0a20 2020  p STOPPED',..   
+00013460: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
+00013470: 7265 7374 6172 7469 6e67 2074 6865 2069  restarting the i
+00013480: 646c 656e 6573 7320 7469 6d65 7220 7669  dleness timer vi
+00013490: 6120 6578 6563 3a0a 2020 2020 2020 2020  a exec:.        
+000134a0: 2020 2020 6627 736b 7920 7374 6172 7420      f'sky start 
+000134b0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+000134c0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+000134d0: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
+000134e0: 657d 207c 2067 7265 7020 2d45 2022 5550  e} | grep -E "UP
+000134f0: 5c73 2b2d 2227 2c0a 2020 2020 2020 2020  \s+-"',.        
+00013500: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+00013510: 6f70 202d 7920 7b6e 616d 657d 202d 6920  op -y {name} -i 
+00013520: 3127 2c20 2023 2049 646c 656e 6573 7320  1',  # Idleness 
+00013530: 7374 6172 7473 2063 6f75 6e74 696e 672e  starts counting.
+00013540: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00013550: 6565 7020 3435 272c 2020 2320 416c 6d6f  eep 45',  # Almo
+00013560: 7374 2072 6561 6368 6564 2074 6865 2074  st reached the t
+00013570: 6872 6573 686f 6c64 2e0a 2020 2020 2020  hreshold..      
+00013580: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00013590: 207b 6e61 6d65 7d20 6563 686f 2068 6927   {name} echo hi'
+000135a0: 2c20 2023 2053 686f 756c 6420 7265 7374  ,  # Should rest
+000135b0: 6172 7420 7468 6520 7469 6d65 722e 0a20  art the timer.. 
+000135c0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000135d0: 7020 3435 272c 0a20 2020 2020 2020 2020  p 45',.         
+000135e0: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+000135f0: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+00013600: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+00013610: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+00013620: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+00013630: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
+00013640: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00013650: 2773 6c65 6570 207b 6175 746f 7374 6f70  'sleep {autostop
+00013660: 5f74 696d 656f 7574 7d27 2c0a 2020 2020  _timeout}',.    
+00013670: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+00013680: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
+00013690: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
+000136a0: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
+000136b0: 6f3b 2065 6368 6f20 2224 7322 2020 7c20  o; echo "$s"  | 
+000136c0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+000136d0: 6570 2053 544f 5050 4544 272c 0a20 2020  ep STOPPED',.   
+000136e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000136f0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00013700: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+00013710: 696d 656f 7574 3d74 6f74 616c 5f74 696d  imeout=total_tim
+00013720: 656f 7574 5f6d 696e 7574 6573 202a 2036  eout_minutes * 6
+00013730: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00013740: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00013750: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+00013760: 6573 7469 6e67 2041 7574 6f64 6f77 6e69  esting Autodowni
+00013770: 6e67 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ng ----------.@p
+00013780: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+00013790: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
+000137a0: 6453 7461 636b 2064 6f65 7320 6e6f 7420  dStack does not 
+000137b0: 7375 7070 6f72 7420 7374 6f70 7069 6e67  support stopping
+000137c0: 2069 6e20 536b 7950 696c 6f74 2069 6d70   in SkyPilot imp
+000137d0: 6c65 6d65 6e74 6174 696f 6e0a 4070 7974  lementation.@pyt
+000137e0: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+000137f0: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+00013800: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
+00013810: 7320 3e20 3120 7965 742e 2052 756e 2074  s > 1 yet. Run t
+00013820: 6573 745f 7363 705f 6175 746f 646f 776e  est_scp_autodown
+00013830: 2069 6e73 7465 6164 2e0a 6465 6620 7465   instead..def te
+00013840: 7374 5f61 7574 6f64 6f77 6e28 6765 6e65  st_autodown(gene
+00013850: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+00013860: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00013870: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00013880: 2020 2020 2320 417a 7572 6520 7461 6b65      # Azure take
+00013890: 7320 7e20 3133 6d33 3073 2028 3831 3073  s ~ 13m30s (810s
+000138a0: 2920 746f 2061 7574 6f64 6f77 6e20 6120  ) to autodown a 
+000138b0: 564d 2c20 736f 2068 6572 6520 7765 2075  VM, so here we u
+000138c0: 7365 2039 3030 2074 6f20 656e 7375 7265  se 900 to ensure
+000138d0: 0a20 2020 2023 2074 6865 2056 4d20 6973  .    # the VM is
+000138e0: 2074 6572 6d69 6e61 7465 642e 0a20 2020   terminated..   
+000138f0: 2061 7574 6f64 6f77 6e5f 7469 6d65 6f75   autodown_timeou
+00013900: 7420 3d20 3930 3020 6966 2067 656e 6572  t = 900 if gener
+00013910: 6963 5f63 6c6f 7564 203d 3d20 2761 7a75  ic_cloud == 'azu
+00013920: 7265 2720 656c 7365 2032 3430 0a20 2020  re' else 240.   
+00013930: 2074 6f74 616c 5f74 696d 656f 7574 5f6d   total_timeout_m
+00013940: 696e 7574 6573 203d 2039 3020 6966 2067  inutes = 90 if g
+00013950: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
+00013960: 2761 7a75 7265 2720 656c 7365 2032 300a  'azure' else 20.
+00013970: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00013980: 0a20 2020 2020 2020 2027 6175 746f 646f  .        'autodo
+00013990: 776e 272c 0a20 2020 2020 2020 205b 0a20  wn',.        [. 
+000139a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000139b0: 206c 6175 6e63 6820 2d79 202d 6420 2d63   launch -y -d -c
+000139c0: 207b 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f   {name} --num-no
+000139d0: 6465 7320 3220 2d2d 636c 6f75 6420 7b67  des 2 --cloud {g
+000139e0: 656e 6572 6963 5f63 6c6f 7564 7d20 7465  eneric_cloud} te
+000139f0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+00013a00: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+00013a10: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00013a20: 6175 746f 7374 6f70 202d 7920 7b6e 616d  autostop -y {nam
+00013a30: 657d 202d 2d64 6f77 6e20 2d69 2031 272c  e} --down -i 1',
+00013a40: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00013a50: 6e73 7572 6520 6175 746f 7374 6f70 2069  nsure autostop i
+00013a60: 7320 7365 742e 0a20 2020 2020 2020 2020  s set..         
+00013a70: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00013a80: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00013a90: 6772 6570 2022 316d 2028 646f 776e 2922  grep "1m (down)"
+00013aa0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00013ab0: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
+00013ac0: 7465 7220 6973 206e 6f74 2074 6572 6d69  ter is not termi
+00013ad0: 6e61 7465 6420 6561 726c 792e 0a20 2020  nated early..   
+00013ae0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00013af0: 3430 272c 0a20 2020 2020 2020 2020 2020  40',.           
+00013b00: 2066 2773 3d24 2873 6b79 2073 7461 7475   f's=$(sky statu
+00013b10: 7320 7b6e 616d 657d 202d 2d72 6566 7265  s {name} --refre
+00013b20: 7368 293b 2065 6368 6f20 2224 7322 3b20  sh); echo "$s"; 
+00013b30: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+00013b40: 2022 2473 2220 207c 2067 7265 7020 7b6e   "$s"  | grep {n
+00013b50: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
+00013b60: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00013b70: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00013b80: 7220 6973 2074 6572 6d69 6e61 7465 642e  r is terminated.
+00013b90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00013ba0: 6c65 6570 207b 6175 746f 646f 776e 5f74  leep {autodown_t
+00013bb0: 696d 656f 7574 7d27 2c0a 2020 2020 2020  imeout}',.      
+00013bc0: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
+00013bd0: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
+00013be0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+00013bf0: 2d72 6566 7265 7368 2920 2626 2065 6368  -refresh) && ech
+00013c00: 6f20 2224 7322 2026 2620 7b7b 2065 6368  o "$s" && {{ ech
+00013c10: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+00013c20: 616d 657d 207c 2067 7265 7020 2241 7574  ame} | grep "Aut
+00013c30: 6f64 6f77 6e65 6420 636c 7573 7465 725c  odowned cluster\
+00013c40: 7c74 6572 6d69 6e61 7465 6420 6f6e 2074  |terminated on t
+00013c50: 6865 2063 6c6f 7564 223b 207d 7d20 7c7c  he cloud"; }} ||
+00013c60: 207b 7b20 6563 686f 2022 2473 2220 7c20   {{ echo "$s" | 
+00013c70: 6772 6570 207b 6e61 6d65 7d20 2626 2065  grep {name} && e
+00013c80: 7869 7420 3120 7c7c 2065 7869 7420 303b  xit 1 || exit 0;
+00013c90: 207d 7d27 2c0a 2020 2020 2020 2020 2020   }}',.          
+00013ca0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00013cb0: 7920 2d64 202d 6320 7b6e 616d 657d 202d  y -d -c {name} -
+00013cc0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00013cd0: 636c 6f75 647d 202d 2d6e 756d 2d6e 6f64  cloud} --num-nod
+00013ce0: 6573 2032 202d 2d64 6f77 6e20 7465 7374  es 2 --down test
+00013cf0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+00013d00: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00013d10: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00013d20: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
+00013d30: 657d 207c 2067 7265 7020 5550 272c 2020  e} | grep UP',  
+00013d40: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+00013d50: 7374 6572 2069 7320 5550 2e0a 2020 2020  ster is UP..    
+00013d60: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00013d70: 6563 207b 6e61 6d65 7d20 2d2d 636c 6f75  ec {name} --clou
+00013d80: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00013d90: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+00013da0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+00013db0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00013dc0: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
+00013dd0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00013de0: 2231 6d20 2864 6f77 6e29 2227 2c0a 2020  "1m (down)"',.  
+00013df0: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+00013e00: 7020 7b61 7574 6f64 6f77 6e5f 7469 6d65  p {autodown_time
+00013e10: 6f75 747d 272c 0a20 2020 2020 2020 2020  out}',.         
+00013e20: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
+00013e30: 636c 7573 7465 7220 6973 2074 6572 6d69  cluster is termi
+00013e40: 6e61 7465 642e 0a20 2020 2020 2020 2020  nated..         
+00013e50: 2020 2066 2773 3d24 2853 4b59 5049 4c4f     f's=$(SKYPILO
+00013e60: 545f 4445 4255 473d 3020 736b 7920 7374  T_DEBUG=0 sky st
+00013e70: 6174 7573 207b 6e61 6d65 7d20 2d2d 7265  atus {name} --re
+00013e80: 6672 6573 6829 2026 2620 6563 686f 2022  fresh) && echo "
+00013e90: 2473 2220 2626 207b 7b20 6563 686f 2022  $s" && {{ echo "
+00013ea0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+00013eb0: 7d20 7c20 6772 6570 2022 4175 746f 646f  } | grep "Autodo
+00013ec0: 776e 6564 2063 6c75 7374 6572 5c7c 7465  wned cluster\|te
+00013ed0: 726d 696e 6174 6564 206f 6e20 7468 6520  rminated on the 
+00013ee0: 636c 6f75 6422 3b20 7d7d 207c 7c20 7b7b  cloud"; }} || {{
+00013ef0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+00013f00: 7020 7b6e 616d 657d 2026 2620 6578 6974  p {name} && exit
+00013f10: 2031 207c 7c20 6578 6974 2030 3b20 7d7d   1 || exit 0; }}
+00013f20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00013f30: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00013f40: 6420 2d63 207b 6e61 6d65 7d20 2d2d 636c  d -c {name} --cl
+00013f50: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00013f60: 7564 7d20 2d2d 6e75 6d2d 6e6f 6465 7320  ud} --num-nodes 
+00013f70: 3220 2d2d 646f 776e 2074 6573 7473 2f74  2 --down tests/t
+00013f80: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+00013f90: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00013fa0: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
+00013fb0: 746f 7020 2d79 207b 6e61 6d65 7d20 2d2d  top -y {name} --
+00013fc0: 6361 6e63 656c 272c 0a20 2020 2020 2020  cancel',.       
+00013fd0: 2020 2020 2066 2773 6c65 6570 207b 6175       f'sleep {au
+00013fe0: 746f 646f 776e 5f74 696d 656f 7574 7d27  todown_timeout}'
+00013ff0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00014000: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
+00014010: 6572 2069 7320 7374 696c 6c20 5550 2e0a  er is still UP..
+00014020: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00014030: 2428 534b 5950 494c 4f54 5f44 4542 5547  $(SKYPILOT_DEBUG
+00014040: 3d30 2073 6b79 2073 7461 7475 7320 7b6e  =0 sky status {n
+00014050: 616d 657d 202d 2d72 6566 7265 7368 2920  ame} --refresh) 
+00014060: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
+00014070: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00014080: 207b 6e61 6d65 7d20 7c20 6772 6570 2055   {name} | grep U
+00014090: 5027 2c0a 2020 2020 2020 2020 5d2c 0a20  P',.        ],. 
+000140a0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+000140b0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+000140c0: 2020 2020 2020 7469 6d65 6f75 743d 746f        timeout=to
+000140d0: 7461 6c5f 7469 6d65 6f75 745f 6d69 6e75  tal_timeout_minu
+000140e0: 7465 7320 2a20 3630 2c0a 2020 2020 290a  tes * 60,.    ).
+000140f0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00014100: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00014110: 2e6d 6172 6b2e 7363 700a 6465 6620 7465  .mark.scp.def te
+00014120: 7374 5f73 6370 5f61 7574 6f64 6f77 6e28  st_scp_autodown(
+00014130: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00014140: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00014150: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00014160: 7428 0a20 2020 2020 2020 2027 5343 505f  t(.        'SCP_
+00014170: 6175 746f 646f 776e 272c 0a20 2020 2020  autodown',.     
+00014180: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00014190: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+000141a0: 202d 6420 2d63 207b 6e61 6d65 7d20 7b53   -d -c {name} {S
+000141b0: 4350 5f54 5950 457d 2074 6573 7473 2f74  CP_TYPE} tests/t
+000141c0: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+000141d0: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+000141e0: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
+000141f0: 746f 7020 2d79 207b 6e61 6d65 7d20 2d2d  top -y {name} --
+00014200: 646f 776e 202d 6920 3127 2c0a 2020 2020  down -i 1',.    
+00014210: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+00014220: 2061 7574 6f73 746f 7020 6973 2073 6574   autostop is set
+00014230: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00014240: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
+00014250: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00014260: 2231 6d20 2864 6f77 6e29 2227 2c0a 2020  "1m (down)"',.  
+00014270: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
+00014280: 7265 2074 6865 2063 6c75 7374 6572 2069  re the cluster i
+00014290: 7320 6e6f 7420 7465 726d 696e 6174 6564  s not terminated
+000142a0: 2065 6172 6c79 2e0a 2020 2020 2020 2020   early..        
+000142b0: 2020 2020 2773 6c65 6570 2034 3527 2c0a      'sleep 45',.
+000142c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000142d0: 7920 7374 6174 7573 202d 2d72 6566 7265  y status --refre
+000142e0: 7368 207c 2067 7265 7020 7b6e 616d 657d  sh | grep {name}
+000142f0: 207c 2067 7265 7020 5550 272c 0a20 2020   | grep UP',.   
+00014300: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00014310: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+00014320: 2074 6572 6d69 6e61 7465 642e 0a20 2020   terminated..   
+00014330: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00014340: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+00014350: 2020 6627 733d 2428 534b 5950 494c 4f54    f's=$(SKYPILOT
+00014360: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
+00014370: 7475 7320 2d2d 7265 6672 6573 6829 2026  tus --refresh) &
+00014380: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
+00014390: 207b 7b20 6563 686f 2022 2473 2220 7c20   {{ echo "$s" | 
+000143a0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+000143b0: 6570 2022 4175 746f 646f 776e 6564 2063  ep "Autodowned c
+000143c0: 6c75 7374 6572 5c7c 7465 726d 696e 6174  luster\|terminat
+000143d0: 6564 206f 6e20 7468 6520 636c 6f75 6422  ed on the cloud"
+000143e0: 3b20 7d7d 207c 7c20 7b7b 2065 6368 6f20  ; }} || {{ echo 
+000143f0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+00014400: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
+00014410: 6578 6974 2030 3b20 7d7d 272c 0a20 2020  exit 0; }}',.   
+00014420: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00014430: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
+00014440: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+00014450: 202d 2d64 6f77 6e20 7465 7374 732f 7465   --down tests/te
+00014460: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+00014470: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00014480: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+00014490: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+000144a0: 2067 7265 7020 5550 272c 2020 2320 456e   grep UP',  # En
+000144b0: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
+000144c0: 2069 7320 5550 2e0a 2020 2020 2020 2020   is UP..        
+000144d0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+000144e0: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+000144f0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00014500: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00014510: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00014520: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
+00014530: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
+00014540: 316d 2028 646f 776e 2922 272c 0a20 2020  1m (down)"',.   
+00014550: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00014560: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+00014570: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
+00014580: 6c75 7374 6572 2069 7320 7465 726d 696e  luster is termin
+00014590: 6174 6564 2e0a 2020 2020 2020 2020 2020  ated..          
+000145a0: 2020 6627 733d 2428 534b 5950 494c 4f54    f's=$(SKYPILOT
+000145b0: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
+000145c0: 7475 7320 2d2d 7265 6672 6573 6829 2026  tus --refresh) &
+000145d0: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
+000145e0: 207b 7b20 6563 686f 2022 2473 2220 7c20   {{ echo "$s" | 
+000145f0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00014600: 6570 2022 4175 746f 646f 776e 6564 2063  ep "Autodowned c
+00014610: 6c75 7374 6572 5c7c 7465 726d 696e 6174  luster\|terminat
+00014620: 6564 206f 6e20 7468 6520 636c 6f75 6422  ed on the cloud"
+00014630: 3b20 7d7d 207c 7c20 7b7b 2065 6368 6f20  ; }} || {{ echo 
+00014640: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+00014650: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
+00014660: 6578 6974 2030 3b20 7d7d 272c 0a20 2020  exit 0; }}',.   
+00014670: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00014680: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
+00014690: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+000146a0: 202d 2d64 6f77 6e20 7465 7374 732f 7465   --down tests/te
+000146b0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+000146c0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000146d0: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+000146e0: 6f70 202d 7920 7b6e 616d 657d 202d 2d63  op -y {name} --c
+000146f0: 616e 6365 6c27 2c0a 2020 2020 2020 2020  ancel',.        
+00014700: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+00014710: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00014720: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00014730: 7220 6973 2073 7469 6c6c 2055 502e 0a20  r is still UP.. 
+00014740: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00014750: 2853 4b59 5049 4c4f 545f 4445 4255 473d  (SKYPILOT_DEBUG=
+00014760: 3020 736b 7920 7374 6174 7573 202d 2d72  0 sky status --r
+00014770: 6566 7265 7368 2920 2626 2070 7269 6e74  efresh) && print
+00014780: 6620 2224 7322 2026 2620 6563 686f 2022  f "$s" && echo "
+00014790: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+000147a0: 7d20 7c20 6772 6570 2055 5027 2c0a 2020  } | grep UP',.  
+000147b0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000147c0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+000147d0: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+000147e0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+000147f0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00014800: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00014810: 6465 6620 5f67 6574 5f63 616e 6365 6c5f  def _get_cancel_
+00014820: 7461 736b 5f77 6974 685f 636c 6f75 6428  task_with_cloud(
+00014830: 6e61 6d65 2c20 636c 6f75 642c 2074 696d  name, cloud, tim
+00014840: 656f 7574 3d31 3520 2a20 3630 293a 0a20  eout=15 * 60):. 
+00014850: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00014860: 2020 2020 2020 2020 6627 7b63 6c6f 7564          f'{cloud
+00014870: 7d2d 6361 6e63 656c 2d74 6173 6b27 2c0a  }-cancel-task',.
+00014880: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00014890: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+000148a0: 6368 202d 6320 7b6e 616d 657d 2065 7861  ch -c {name} exa
+000148b0: 6d70 6c65 732f 7265 736e 6574 5f61 7070  mples/resnet_app
+000148c0: 2e79 616d 6c20 2d2d 636c 6f75 6420 7b63  .yaml --cloud {c
+000148d0: 6c6f 7564 7d20 2d79 202d 6427 2c0a 2020  loud} -y -d',.  
+000148e0: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
+000148f0: 2074 6865 2047 5055 2070 726f 6365 7373   the GPU process
+00014900: 2074 6f20 7374 6172 742e 0a20 2020 2020   to start..     
+00014910: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
+00014920: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014930: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00014940: 2022 6e76 6964 6961 2d73 6d69 207c 2067   "nvidia-smi | g
+00014950: 7265 7020 7079 7468 6f6e 2227 2c0a 2020  rep python"',.  
+00014960: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00014970: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
+00014980: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00014990: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+000149a0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+000149b0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
+000149c0: 7920 7b6e 616d 657d 2031 272c 0a20 2020  y {name} 1',.   
+000149d0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+000149e0: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
+000149f0: 2023 2063 6865 636b 2069 6620 7468 6520   # check if the 
+00014a00: 7079 7468 6f6e 206a 6f62 2069 7320 676f  python job is go
+00014a10: 6e65 2e0a 2020 2020 2020 2020 2020 2020  ne..            
+00014a20: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00014a30: 7d20 2221 206e 7669 6469 612d 736d 6920  } "! nvidia-smi 
+00014a40: 7c20 6772 6570 2070 7974 686f 6e22 272c  | grep python"',
+00014a50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00014a60: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
+00014a70: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00014a80: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00014a90: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00014aa0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00014ab0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00014ac0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+00014ad0: 7574 3d74 696d 656f 7574 2c0a 2020 2020  ut=timeout,.    
+00014ae0: 290a 2020 2020 7265 7475 726e 2074 6573  ).    return tes
+00014af0: 740a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  t...# ----------
+00014b00: 2054 6573 7469 6e67 2060 736b 7920 6361   Testing `sky ca
+00014b10: 6e63 656c 6020 2d2d 2d2d 2d2d 2d2d 2d2d  ncel` ----------
+00014b20: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+00014b30: 730a 4070 7974 6573 742e 6d61 726b 2e73  s.@pytest.mark.s
+00014b40: 6b69 7028 0a20 2020 2072 6561 736f 6e3d  kip(.    reason=
+00014b50: 2754 6865 2072 6573 6e65 745f 6170 7020  'The resnet_app 
+00014b60: 6973 2066 6c61 6b79 2c20 6475 6520 746f  is flaky, due to
+00014b70: 2054 4620 6661 696c 696e 6720 746f 2064   TF failing to d
+00014b80: 6574 6563 7420 4750 5573 2e27 290a 6465  etect GPUs.').de
+00014b90: 6620 7465 7374 5f63 616e 6365 6c5f 6177  f test_cancel_aw
+00014ba0: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+00014bb0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00014bc0: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
+00014bd0: 6765 745f 6361 6e63 656c 5f74 6173 6b5f  get_cancel_task_
+00014be0: 7769 7468 5f63 6c6f 7564 286e 616d 652c  with_cloud(name,
+00014bf0: 2027 6177 7327 290a 2020 2020 7275 6e5f   'aws').    run_
+00014c00: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00014c10: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+00014c20: 700a 4070 7974 6573 742e 6d61 726b 2e73  p.@pytest.mark.s
+00014c30: 6b69 7028 0a20 2020 2072 6561 736f 6e3d  kip(.    reason=
+00014c40: 2754 6865 2072 6573 6e65 745f 6170 7020  'The resnet_app 
+00014c50: 6973 2066 6c61 6b79 2c20 6475 6520 746f  is flaky, due to
+00014c60: 2054 4620 6661 696c 696e 6720 746f 2064   TF failing to d
+00014c70: 6574 6563 7420 4750 5573 2e27 290a 6465  etect GPUs.').de
+00014c80: 6620 7465 7374 5f63 616e 6365 6c5f 6763  f test_cancel_gc
+00014c90: 7028 293a 0a20 2020 206e 616d 6520 3d20  p():.    name = 
+00014ca0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00014cb0: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
+00014cc0: 6765 745f 6361 6e63 656c 5f74 6173 6b5f  get_cancel_task_
+00014cd0: 7769 7468 5f63 6c6f 7564 286e 616d 652c  with_cloud(name,
+00014ce0: 2027 6763 7027 290a 2020 2020 7275 6e5f   'gcp').    run_
+00014cf0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00014d00: 0a40 7079 7465 7374 2e6d 6172 6b2e 617a  .@pytest.mark.az
+00014d10: 7572 650a 4070 7974 6573 742e 6d61 726b  ure.@pytest.mark
+00014d20: 2e73 6b69 7028 0a20 2020 2072 6561 736f  .skip(.    reaso
+00014d30: 6e3d 2754 6865 2072 6573 6e65 745f 6170  n='The resnet_ap
+00014d40: 7020 6973 2066 6c61 6b79 2c20 6475 6520  p is flaky, due 
+00014d50: 746f 2054 4620 6661 696c 696e 6720 746f  to TF failing to
+00014d60: 2064 6574 6563 7420 4750 5573 2e27 290a   detect GPUs.').
+00014d70: 6465 6620 7465 7374 5f63 616e 6365 6c5f  def test_cancel_
+00014d80: 617a 7572 6528 293a 0a20 2020 206e 616d  azure():.    nam
+00014d90: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00014da0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00014db0: 203d 205f 6765 745f 6361 6e63 656c 5f74   = _get_cancel_t
+00014dc0: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
+00014dd0: 616d 652c 2027 617a 7572 6527 2c20 7469  ame, 'azure', ti
+00014de0: 6d65 6f75 743d 3330 202a 2036 3029 0a20  meout=30 * 60). 
+00014df0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00014e00: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00014e10: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+00014e20: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+00014e30: 6c6f 7564 2064 6f65 7320 6e6f 7420 6861  loud does not ha
+00014e40: 7665 2056 3130 3020 6770 7573 0a40 7079  ve V100 gpus.@py
+00014e50: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
+00014e60: 2020 2320 4942 4d20 636c 6f75 6420 6375    # IBM cloud cu
+00014e70: 7272 656e 746c 7920 646f 6573 6e27 7420  rrently doesn't 
+00014e80: 7072 6f76 6964 6520 7075 626c 6963 2069  provide public i
+00014e90: 6d61 6765 2077 6974 6820 4355 4441 0a40  mage with CUDA.@
+00014ea0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
+00014eb0: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
+00014ec0: 6572 7370 6163 6520 6861 7320 6067 6e6f  erspace has `gno
+00014ed0: 6d65 2d73 6865 6c6c 6020 6f6e 206e 7669  me-shell` on nvi
+00014ee0: 6469 612d 736d 690a 4070 7974 6573 742e  dia-smi.@pytest.
+00014ef0: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+00014f00: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+00014f10: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
+00014f20: 3120 7965 740a 6465 6620 7465 7374 5f63  1 yet.def test_c
+00014f30: 616e 6365 6c5f 7079 746f 7263 6828 6765  ancel_pytorch(ge
+00014f40: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00014f50: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00014f60: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00014f70: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00014f80: 7428 0a20 2020 2020 2020 2027 6361 6e63  t(.        'canc
+00014f90: 656c 2d70 7974 6f72 6368 272c 0a20 2020  el-pytorch',.   
+00014fa0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00014fb0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00014fc0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00014fd0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00014fe0: 7d20 6578 616d 706c 6573 2f72 6573 6e65  } examples/resne
+00014ff0: 745f 6469 7374 7269 6275 7465 645f 746f  t_distributed_to
+00015000: 7263 682e 7961 6d6c 202d 7920 2d64 272c  rch.yaml -y -d',
+00015010: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+00015020: 6169 7420 7468 6520 4750 5520 7072 6f63  ait the GPU proc
+00015030: 6573 7320 746f 2073 7461 7274 2e0a 2020  ess to start..  
+00015040: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00015050: 2039 3027 2c0a 2020 2020 2020 2020 2020   90',.          
+00015060: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00015070: 6d65 7d20 2228 6e76 6964 6961 2d73 6d69  me} "(nvidia-smi
+00015080: 207c 2067 7265 7020 7079 7468 6f6e 2920   | grep python) 
+00015090: 7c7c 2027 0a20 2020 2020 2020 2020 2020  || '.           
+000150a0: 2023 2057 6865 6e20 7275 6e20 696e 7369   # When run insi
+000150b0: 6465 2063 6f6e 7461 696e 6572 2f6b 3873  de container/k8s
+000150c0: 2c20 6e76 6964 6961 2d73 6d69 2063 616e  , nvidia-smi can
+000150d0: 6e6f 7420 7368 6f77 2070 726f 6365 7373  not show process
+000150e0: 2069 6473 2e0a 2020 2020 2020 2020 2020   ids..          
+000150f0: 2020 2320 5365 6520 6874 7470 733a 2f2f    # See https://
+00015100: 6769 7468 7562 2e63 6f6d 2f4e 5649 4449  github.com/NVIDI
+00015110: 412f 6e76 6964 6961 2d64 6f63 6b65 722f  A/nvidia-docker/
+00015120: 6973 7375 6573 2f31 3739 0a20 2020 2020  issues/179.     
+00015130: 2020 2020 2020 2023 2054 6f20 776f 726b         # To work
+00015140: 2061 726f 756e 642c 2077 6520 6368 6563   around, we chec
+00015150: 6b20 6966 2047 5055 2075 7469 6c69 7a61  k if GPU utiliza
+00015160: 7469 6f6e 2069 7320 6772 6561 7465 7220  tion is greater 
+00015170: 7468 616e 2030 2e0a 2020 2020 2020 2020  than 0..        
+00015180: 2020 2020 6627 5b20 5c24 286e 7669 6469      f'[ \$(nvidi
+00015190: 612d 736d 6920 2d2d 7175 6572 792d 6770  a-smi --query-gp
+000151a0: 753d 7574 696c 697a 6174 696f 6e2e 6770  u=utilization.gp
+000151b0: 7520 2d2d 666f 726d 6174 3d63 7376 2c6e  u --format=csv,n
+000151c0: 6f68 6561 6465 722c 6e6f 756e 6974 7329  oheader,nounits)
+000151d0: 202d 6774 2030 205d 2227 2c0a 2020 2020   -gt 0 ]"',.    
+000151e0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000151f0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00015200: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00015210: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00015220: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00015230: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
+00015240: 7b6e 616d 657d 2031 272c 0a20 2020 2020  {name} 1',.     
+00015250: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
+00015260: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00015270: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00015280: 2022 286e 7669 6469 612d 736d 6920 7c20   "(nvidia-smi | 
+00015290: 6772 6570 205c 274e 6f20 7275 6e6e 696e  grep \'No runnin
+000152a0: 6720 7072 6f63 6573 735c 2729 207c 7c20  g process\') || 
+000152b0: 270a 2020 2020 2020 2020 2020 2020 2320  '.            # 
+000152c0: 456e 7375 7265 2058 6f72 6720 6973 2074  Ensure Xorg is t
+000152d0: 6865 206f 6e6c 7920 7072 6f63 6573 7320  he only process 
+000152e0: 7275 6e6e 696e 672e 0a20 2020 2020 2020  running..       
+000152f0: 2020 2020 2027 5b20 5c24 286e 7669 6469       '[ \$(nvidi
+00015300: 612d 736d 6920 7c20 6772 6570 202d 4120  a-smi | grep -A 
+00015310: 3130 2050 726f 6365 7373 6573 207c 2067  10 Processes | g
+00015320: 7265 7020 2d41 2031 3020 3d3d 3d20 7c20  rep -A 10 === | 
+00015330: 6772 6570 202d 7620 586f 7267 2920 2d65  grep -v Xorg) -e
+00015340: 7120 3220 5d22 272c 0a20 2020 2020 2020  q 2 ]"',.       
+00015350: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00015360: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+00015370: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00015380: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00015390: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+000153a0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+000153b0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+000153c0: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+000153d0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+000153e0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000153f0: 0a0a 0a23 2063 616e 2774 2075 7365 2060  ...# can't use `
+00015400: 5f67 6574 5f63 616e 6365 6c5f 7461 736b  _get_cancel_task
+00015410: 5f77 6974 685f 636c 6f75 6428 2960 2c20  _with_cloud()`, 
+00015420: 6173 2063 6f6d 6d61 6e64 2060 6e76 6964  as command `nvid
+00015430: 6961 2d73 6d69 600a 2320 7265 7175 6972  ia-smi`.# requir
+00015440: 6573 2061 2043 5544 4120 7075 626c 6963  es a CUDA public
+00015450: 2069 6d61 6765 2c20 7768 6963 6820 4942   image, which IB
+00015460: 4d20 646f 6573 6e27 7420 6f66 6665 720a  M doesn't offer.
+00015470: 4070 7974 6573 742e 6d61 726b 2e69 626d  @pytest.mark.ibm
+00015480: 0a64 6566 2074 6573 745f 6361 6e63 656c  .def test_cancel
+00015490: 5f69 626d 2829 3a0a 2020 2020 6e61 6d65  _ibm():.    name
+000154a0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000154b0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000154c0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+000154d0: 2769 626d 2d63 616e 6365 6c2d 7461 736b  'ibm-cancel-task
+000154e0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000154f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00015500: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00015510: 657d 202d 2d63 6c6f 7564 2069 626d 2065  e} --cloud ibm e
+00015520: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00015530: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00015540: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00015550: 616d 657d 202d 6e20 7b6e 616d 657d 2d31  ame} -n {name}-1
+00015560: 202d 6420 2022 7768 696c 6520 7472 7565   -d  "while true
+00015570: 3b20 646f 2065 6368 6f20 5c27 4865 6c6c  ; do echo \'Hell
+00015580: 6f20 536b 7950 696c 6f74 5c27 3b20 736c  o SkyPilot\'; sl
+00015590: 6565 7020 323b 2064 6f6e 6522 272c 0a20  eep 2; done"',. 
+000155a0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000155b0: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
+000155c0: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
+000155d0: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
+000155e0: 6d65 7d2d 3120 7c20 6772 6570 2052 554e  me}-1 | grep RUN
+000155f0: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
+00015600: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+00015610: 2d79 207b 6e61 6d65 7d20 3227 2c0a 2020  -y {name} 2',.  
+00015620: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+00015630: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+00015640: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
+00015650: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
+00015660: 657d 2d31 207c 2067 7265 7020 4341 4e43  e}-1 | grep CANC
+00015670: 454c 4c45 4427 2c0a 2020 2020 2020 2020  ELLED',.        
+00015680: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00015690: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000156a0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+000156b0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+000156c0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+000156d0: 7374 696e 6720 7573 652d 7370 6f74 206f  sting use-spot o
+000156e0: 7074 696f 6e20 2d2d 2d2d 2d2d 2d2d 2d2d  ption ----------
+000156f0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00015700: 5f66 6c75 6964 7374 6163 6b20 2023 2046  _fluidstack  # F
+00015710: 6c75 6964 5374 6163 6b20 646f 6573 206e  luidStack does n
+00015720: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00015730: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00015740: 742e 6d61 726b 2e6e 6f5f 617a 7572 6520  t.mark.no_azure 
+00015750: 2023 2041 7a75 7265 2064 6f65 7320 6e6f   # Azure does no
+00015760: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+00015770: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00015780: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
+00015790: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
+000157a0: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+000157b0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+000157c0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+000157d0: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+000157e0: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
+000157f0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00015800: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00015810: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+00015820: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
+00015830: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00015840: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+00015850: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00015860: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+00015870: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00015880: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00015890: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
+000158a0: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
+000158b0: 7465 7320 646f 6573 206e 6f74 2068 6176  tes does not hav
+000158c0: 6520 6120 6e6f 7469 6f6e 206f 6620 7370  e a notion of sp
+000158d0: 6f74 2069 6e73 7461 6e63 6573 0a64 6566  ot instances.def
+000158e0: 2074 6573 745f 7573 655f 7370 6f74 2867   test_use_spot(g
+000158f0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00015900: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
+00015910: 7573 652d 7370 6f74 2061 6e64 2073 6b79  use-spot and sky
+00015920: 2065 7865 632e 2222 220a 2020 2020 6e61   exec.""".    na
+00015930: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00015940: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00015950: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00015960: 2020 2775 7365 2d73 706f 7427 2c0a 2020    'use-spot',.  
+00015970: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00015980: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00015990: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+000159a0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+000159b0: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
+000159c0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+000159d0: 202d 2d75 7365 2d73 706f 7420 2d79 272c   --use-spot -y',
+000159e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000159f0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00015a00: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00015a10: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00015a20: 6563 207b 6e61 6d65 7d20 6563 686f 2068  ec {name} echo h
+00015a30: 6927 2c0a 2020 2020 2020 2020 2020 2020  i',.            
+00015a40: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00015a50: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00015a60: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00015a70: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00015a80: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00015a90: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00015aa0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00015ab0: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+00015ac0: 745f 7374 6f70 5f67 6370 5f73 706f 7428  t_stop_gcp_spot(
+00015ad0: 293a 0a20 2020 2022 2222 5465 7374 2047  ):.    """Test G
+00015ae0: 4350 2073 706f 7420 6361 6e20 6265 2073  CP spot can be s
+00015af0: 746f 7070 6564 2c20 6175 746f 7374 6f70  topped, autostop
+00015b00: 7065 642c 2072 6573 7461 7274 6564 2e22  ped, restarted."
+00015b10: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+00015b20: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00015b30: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00015b40: 7428 0a20 2020 2020 2020 2027 7374 6f70  t(.        'stop
+00015b50: 5f67 6370 5f73 706f 7427 2c0a 2020 2020  _gcp_spot',.    
+00015b60: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00015b70: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00015b80: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00015b90: 2067 6370 202d 2d75 7365 2d73 706f 7420   gcp --use-spot 
+00015ba0: 2d2d 6370 7573 2032 2b20 2d79 202d 2d20  --cpus 2+ -y -- 
+00015bb0: 746f 7563 6820 6d79 6669 6c65 272c 0a20  touch myfile',. 
+00015bc0: 2020 2020 2020 2020 2020 2023 2073 746f             # sto
+00015bd0: 7020 7368 6f75 6c64 2067 6f20 7468 726f  p should go thro
+00015be0: 7567 683a 0a20 2020 2020 2020 2020 2020  ugh:.           
+00015bf0: 2066 2773 6b79 2073 746f 7020 7b6e 616d   f'sky stop {nam
+00015c00: 657d 202d 7927 2c0a 2020 2020 2020 2020  e} -y',.        
+00015c10: 2020 2020 6627 736b 7920 7374 6172 7420      f'sky start 
+00015c20: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
+00015c30: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00015c40: 6563 207b 6e61 6d65 7d20 2d2d 206c 7320  ec {name} -- ls 
+00015c50: 6d79 6669 6c65 272c 0a20 2020 2020 2020  myfile',.       
+00015c60: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00015c70: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+00015c80: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00015c90: 6627 736b 7920 6175 746f 7374 6f70 207b  f'sky autostop {
+00015ca0: 6e61 6d65 7d20 2d69 3020 2d79 272c 0a20  name} -i0 -y',. 
+00015cb0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00015cc0: 7020 3930 272c 0a20 2020 2020 2020 2020  p 90',.         
+00015cd0: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+00015ce0: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+00015cf0: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+00015d00: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+00015d10: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+00015d20: 7b6e 616d 657d 207c 2067 7265 7020 5354  {name} | grep ST
+00015d30: 4f50 5045 4427 2c0a 2020 2020 2020 2020  OPPED',.        
+00015d40: 2020 2020 6627 736b 7920 7374 6172 7420      f'sky start 
+00015d50: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
+00015d60: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00015d70: 6563 207b 6e61 6d65 7d20 2d2d 206c 7320  ec {name} -- ls 
+00015d80: 6d79 6669 6c65 272c 0a20 2020 2020 2020  myfile',.       
+00015d90: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00015da0: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+00015db0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00015dc0: 2320 2d69 206f 7074 696f 6e20 6174 206c  # -i option at l
+00015dd0: 6175 6e63 6820 7368 6f75 6c64 2067 6f20  aunch should go 
+00015de0: 7468 726f 7567 683a 0a20 2020 2020 2020  through:.       
+00015df0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00015e00: 6820 2d63 207b 6e61 6d65 7d20 2d69 3020  h -c {name} -i0 
+00015e10: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
+00015e20: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
+00015e30: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00015e40: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+00015e50: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+00015e60: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+00015e70: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
+00015e80: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00015e90: 6772 6570 2053 544f 5050 4544 272c 0a20  grep STOPPED',. 
+00015ea0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00015eb0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00015ec0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00015ed0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00015ee0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00015ef0: 2d2d 2d2d 2054 6573 7469 6e67 206d 616e  ---- Testing man
+00015f00: 6167 6564 2073 706f 7420 2d2d 2d2d 2d2d  aged spot ------
+00015f10: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00015f20: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+00015f30: 2023 2046 6c75 6964 5374 6163 6b20 646f   # FluidStack do
+00015f40: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00015f50: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00015f60: 7974 6573 742e 6d61 726b 2e6e 6f5f 617a  ytest.mark.no_az
+00015f70: 7572 6520 2023 2041 7a75 7265 2064 6f65  ure  # Azure doe
+00015f80: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00015f90: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00015fa0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+00015fb0: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+00015fc0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+00015fd0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00015fe0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00015ff0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+00016000: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+00016010: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00016020: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00016030: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+00016040: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+00016050: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00016060: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00016070: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+00016080: 2020 2320 5061 7070 6572 7370 6163 6520    # Papperspace 
+00016090: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000160a0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+000160b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000160c0: 6b75 6265 726e 6574 6573 2020 2320 4b75  kubernetes  # Ku
+000160d0: 6265 726e 6574 6573 2064 6f65 7320 6e6f  bernetes does no
+000160e0: 7420 6861 7665 2061 206e 6f74 696f 6e20  t have a notion 
+000160f0: 6f66 2073 706f 7420 696e 7374 616e 6365  of spot instance
+00016100: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
+00016110: 616e 6167 6564 5f73 706f 740a 6465 6620  anaged_spot.def 
+00016120: 7465 7374 5f73 706f 7428 6765 6e65 7269  test_spot(generi
+00016130: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00016140: 2020 2022 2222 5465 7374 2074 6865 2073     """Test the s
+00016150: 706f 7420 7961 6d6c 2e22 2222 0a20 2020  pot yaml.""".   
+00016160: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00016170: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00016180: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00016190: 2020 2020 2027 6d61 6e61 6765 642d 7370       'managed-sp
+000161a0: 6f74 272c 0a20 2020 2020 2020 205b 0a20  ot',.        [. 
+000161b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000161c0: 2073 706f 7420 6c61 756e 6368 202d 6e20   spot launch -n 
+000161d0: 7b6e 616d 657d 2d31 202d 2d63 6c6f 7564  {name}-1 --cloud
+000161e0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+000161f0: 2065 7861 6d70 6c65 732f 6d61 6e61 6765   examples/manage
+00016200: 645f 7370 6f74 2e79 616d 6c20 2d79 202d  d_spot.yaml -y -
+00016210: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00016220: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
+00016230: 6820 2d6e 207b 6e61 6d65 7d2d 3220 2d2d  h -n {name}-2 --
+00016240: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00016250: 6c6f 7564 7d20 6578 616d 706c 6573 2f6d  loud} examples/m
+00016260: 616e 6167 6564 5f73 706f 742e 7961 6d6c  anaged_spot.yaml
+00016270: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+00016280: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+00016290: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+000162a0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+000162b0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
+000162c0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+000162d0: 7020 2253 5441 5254 494e 475c 7c52 554e  p "STARTING\|RUN
+000162e0: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
+000162f0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00016300: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00016310: 6e61 6d65 7d2d 3220 7c20 6865 6164 202d  name}-2 | head -
+00016320: 6e31 207c 2067 7265 7020 2253 5441 5254  n1 | grep "START
+00016330: 494e 475c 7c52 554e 4e49 4e47 2227 2c0a  ING\|RUNNING"',.
+00016340: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
+00016350: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00016360: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+00016370: 7b6e 616d 657d 2d31 2729 2c0a 2020 2020  {name}-1'),.    
+00016380: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+00016390: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000163a0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+000163b0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+000163c0: 2d31 207c 2068 6561 6420 2d6e 3120 7c20  -1 | head -n1 | 
+000163d0: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+000163e0: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+000163f0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00016400: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
+00016410: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00016420: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00016430: 6e61 6d65 7d2d 3120 7c20 6865 6164 202d  name}-1 | head -
+00016440: 6e31 207c 2067 7265 7020 4341 4e43 454c  n1 | grep CANCEL
+00016450: 4c45 4427 2c0a 2020 2020 2020 2020 2020  LED',.          
+00016460: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00016470: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00016480: 6d65 7d2d 3220 7c20 6865 6164 202d 6e31  me}-2 | head -n1
+00016490: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+000164a0: 5c7c 5355 4343 4545 4445 4422 272c 0a20  \|SUCCEEDED"',. 
+000164b0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000164c0: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
+000164d0: 4368 616e 6765 2074 6f20 5f53 504f 545f  Change to _SPOT_
+000164e0: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
+000164f0: 6174 286a 6f62 5f6e 616d 653d 6627 7b6e  at(job_name=f'{n
+00016500: 616d 657d 2d31 202d 6e20 7b6e 616d 657d  ame}-1 -n {name}
+00016510: 2d32 2729 2077 6865 6e0a 2020 2020 2020  -2') when.      
+00016520: 2020 2320 6361 6e63 656c 696e 6720 6d75    # canceling mu
+00016530: 6c74 6970 6c65 206a 6f62 206e 616d 6573  ltiple job names
+00016540: 2069 7320 7375 7070 6f72 7465 642e 0a20   is supported.. 
+00016550: 2020 2020 2020 2028 5f53 504f 545f 4341         (_SPOT_CA
+00016560: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+00016570: 286a 6f62 5f6e 616d 653d 6627 7b6e 616d  (job_name=f'{nam
+00016580: 657d 2d31 2729 202b 2027 3b20 2720 2b0a  e}-1') + '; ' +.
+00016590: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
+000165a0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+000165b0: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
+000165c0: 6d65 7d2d 3227 2929 2c0a 2020 2020 2020  me}-2')),.      
+000165d0: 2020 2320 496e 6372 6561 7365 2074 696d    # Increase tim
+000165e0: 656f 7574 2073 696e 6365 2073 6b79 2073  eout since sky s
+000165f0: 706f 7420 7175 6575 6520 2d72 2063 616e  pot queue -r can
+00016600: 2062 6520 626c 6f63 6b65 6420 6279 206f   be blocked by o
+00016610: 7468 6572 2073 706f 7420 7465 7374 732e  ther spot tests.
+00016620: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00016630: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
+00016640: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00016650: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00016660: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+00016670: 6163 6b20 2023 666c 7569 6473 7461 636b  ack  #fluidstack
+00016680: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00016690: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+000166a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+000166b0: 5f61 7a75 7265 2020 2320 417a 7572 6520  _azure  # Azure 
+000166c0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000166d0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+000166e0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000166f0: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
+00016700: 4c61 6d62 6461 2043 6c6f 7564 2064 6f65  Lambda Cloud doe
+00016710: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00016720: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00016730: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
+00016740: 2020 2320 4942 4d20 436c 6f75 6420 646f    # IBM Cloud do
+00016750: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00016760: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00016770: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+00016780: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+00016790: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+000167a0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+000167b0: 2e6d 6172 6b2e 6e6f 5f70 6170 6572 7370  .mark.no_papersp
+000167c0: 6163 6520 2023 2050 6170 6572 7370 6163  ace  # Paperspac
+000167d0: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
+000167e0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+000167f0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+00016800: 6f5f 6b75 6265 726e 6574 6573 2020 2320  o_kubernetes  # 
+00016810: 4b75 6265 726e 6574 6573 2064 6f65 7320  Kubernetes does 
+00016820: 6e6f 7420 6861 7665 2061 206e 6f74 696f  not have a notio
+00016830: 6e20 6f66 2073 706f 7420 696e 7374 616e  n of spot instan
+00016840: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00016850: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
+00016860: 6620 7465 7374 5f73 706f 745f 7069 7065  f test_spot_pipe
+00016870: 6c69 6e65 2867 656e 6572 6963 5f63 6c6f  line(generic_clo
+00016880: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+00016890: 2254 6573 7420 6120 7370 6f74 c2a0 7069  "Test a spot..pi
+000168a0: 7065 6c69 6e65 2e22 2222 0a20 2020 206e  peline.""".    n
+000168b0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+000168c0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+000168d0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+000168e0: 2020 2027 7370 6f74 2d70 6970 656c 696e     'spot-pipelin
+000168f0: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+00016900: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00016910: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
+00016920: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+00016930: 5f79 616d 6c73 2f70 6970 656c 696e 652e  _yamls/pipeline.
+00016940: 7961 6d6c 202d 7920 2d64 272c 0a20 2020  yaml -y -d',.   
+00016950: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00016960: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+00016970: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00016980: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00016990: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+000169a0: 7265 7020 2253 5441 5254 494e 475c 7c52  rep "STARTING\|R
+000169b0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+000169c0: 2020 2020 2020 2320 6067 7265 7020 2d41        # `grep -A
+000169d0: 2034 207b 6e61 6d65 7d60 2066 696e 6473   4 {name}` finds
+000169e0: 2074 6865 206a 6f62 2077 6974 6820 7b6e   the job with {n
+000169f0: 616d 657d 2061 6e64 2074 6865 2034 206c  ame} and the 4 l
+00016a00: 696e 6573 0a20 2020 2020 2020 2020 2020  ines.           
+00016a10: 2023 2061 6674 6572 2069 742c 2069 2e65   # after it, i.e
+00016a20: 2e20 7468 6520 3420 7461 736b 7320 7769  . the 4 tasks wi
+00016a30: 7468 696e 2074 6865 206a 6f62 2e0a 2020  thin the job..  
+00016a40: 2020 2020 2020 2020 2020 2320 6073 6564            # `sed
+00016a50: 202d 6e20 3270 6020 6765 7473 2074 6865   -n 2p` gets the
+00016a60: 2073 6563 6f6e 6420 6c69 6e65 206f 6620   second line of 
+00016a70: 7468 6520 3420 6c69 6e65 732c 2069 2e65  the 4 lines, i.e
+00016a80: 2e20 7468 6520 6669 7273 740a 2020 2020  . the first.    
+00016a90: 2020 2020 2020 2020 2320 7461 736b 2077          # task w
+00016aa0: 6974 6869 6e20 7468 6520 6a6f 622e 0a20  ithin the job.. 
+00016ab0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00016ac0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00016ad0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00016ae0: 7d7c 2073 6564 202d 6e20 3270 207c 2067  }| sed -n 2p | g
+00016af0: 7265 7020 2253 5441 5254 494e 475c 7c52  rep "STARTING\|R
+00016b00: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+00016b10: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00016b20: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00016b30: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
+00016b40: 6420 2d6e 2033 7020 7c20 6772 6570 2022  d -n 3p | grep "
+00016b50: 5045 4e44 494e 4722 272c 0a20 2020 2020  PENDING"',.     
+00016b60: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
+00016b70: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+00016b80: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
+00016b90: 7d27 292c 0a20 2020 2020 2020 2020 2020  }'),.           
+00016ba0: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+00016bb0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00016bc0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00016bd0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+00016be0: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
+00016bf0: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+00016c00: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+00016c10: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00016c20: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00016c30: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
+00016c40: 6564 202d 6e20 3370 207c 2067 7265 7020  ed -n 3p | grep 
+00016c50: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
+00016c60: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+00016c70: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00016c80: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00016c90: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
+00016ca0: 6420 2d6e 2034 7020 7c20 6772 6570 2022  d -n 4p | grep "
+00016cb0: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
+00016cc0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00016cd0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00016ce0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00016cf0: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
+00016d00: 202d 6e20 3570 207c 2067 7265 7020 2243   -n 5p | grep "C
+00016d10: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
+00016d20: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+00016d30: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+00016d40: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00016d50: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00016d60: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
+00016d70: 6d65 7d7c 2073 6564 202d 6e20 3270 207c  me}| sed -n 2p |
+00016d80: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
+00016d90: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00016da0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00016db0: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
+00016dc0: 7b6e 616d 657d 7c20 7365 6420 2d6e 2033  {name}| sed -n 3
+00016dd0: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
+00016de0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+00016df0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+00016e00: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
+00016e10: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00016e20: 6e20 3470 207c 2067 7265 7020 2243 414e  n 4p | grep "CAN
+00016e30: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+00016e40: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00016e50: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00016e60: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
+00016e70: 6420 2d6e 2035 7020 7c20 6772 6570 2022  d -n 5p | grep "
+00016e80: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+00016e90: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00016ea0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+00016eb0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+00016ec0: 653d 6627 7b6e 616d 657d 2729 2c0a 2020  e=f'{name}'),.  
+00016ed0: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+00016ee0: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+00016ef0: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
+00016f00: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+00016f10: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+00016f20: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+00016f30: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
+00016f40: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00016f50: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00016f60: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00016f70: 6964 7374 6163 6b20 2023 666c 7569 6473  idstack  #fluids
+00016f80: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
+00016f90: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00016fa0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00016fb0: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
+00016fc0: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
+00016fd0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00016fe0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00016ff0: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
+00017000: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
+00017010: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00017020: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00017030: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00017040: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
+00017050: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+00017060: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+00017070: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+00017080: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+00017090: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+000170a0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+000170b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+000170c0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+000170d0: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+000170e0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+000170f0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00017100: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00017110: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
+00017120: 6f65 7320 6e6f 7420 6861 7665 2061 206e  oes not have a n
+00017130: 6f74 696f 6e20 6f66 2073 706f 7420 696e  otion of spot in
+00017140: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00017150: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
+00017160: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
+00017170: 6661 696c 6564 5f73 6574 7570 2867 656e  failed_setup(gen
+00017180: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00017190: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+000171a0: 6e61 6765 6420 7370 6f74 206a 6f62 2077  naged spot job w
+000171b0: 6974 6820 6661 696c 6564 2073 6574 7570  ith failed setup
+000171c0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+000171d0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000171e0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+000171f0: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
+00017200: 6f74 5f66 6169 6c65 645f 7365 7475 7027  ot_failed_setup'
+00017210: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00017220: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+00017230: 6f74 206c 6175 6e63 6820 2d6e 207b 6e61  ot launch -n {na
+00017240: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00017250: 6572 6963 5f63 6c6f 7564 7d20 2d79 202d  eric_cloud} -y -
+00017260: 6420 7465 7374 732f 7465 7374 5f79 616d  d tests/test_yam
+00017270: 6c73 2f66 6169 6c65 645f 7365 7475 702e  ls/failed_setup.
+00017280: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00017290: 2020 2027 736c 6565 7020 3333 3027 2c0a     'sleep 330',.
+000172a0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+000172b0: 6b65 2073 7572 6520 7468 6520 6a6f 6220  ke sure the job 
+000172c0: 6661 696c 6564 2071 7569 636b 6c79 2e0a  failed quickly..
+000172d0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+000172e0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+000172f0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00017300: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00017310: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
+00017320: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00017330: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+00017340: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+00017350: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+00017360: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+00017370: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+00017380: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
+00017390: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+000173a0: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+000173b0: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+000173c0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+000173d0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+000173e0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+000173f0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00017400: 6964 7374 6163 6b20 2023 666c 7569 6473  idstack  #fluids
+00017410: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
+00017420: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00017430: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00017440: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
+00017450: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
+00017460: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00017470: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00017480: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
+00017490: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
+000174a0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+000174b0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+000174c0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+000174d0: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
+000174e0: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+000174f0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+00017500: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+00017510: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+00017520: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00017530: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00017540: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+00017550: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+00017560: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+00017570: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00017580: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00017590: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+000175a0: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
+000175b0: 6f65 7320 6e6f 7420 6861 7665 2061 206e  oes not have a n
+000175c0: 6f74 696f 6e20 6f66 2073 706f 7420 696e  otion of spot in
+000175d0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+000175e0: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
+000175f0: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
+00017600: 7069 7065 6c69 6e65 5f66 6169 6c65 645f  pipeline_failed_
+00017610: 7365 7475 7028 6765 6e65 7269 635f 636c  setup(generic_cl
+00017620: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+00017630: 2222 5465 7374 206d 616e 6167 6564 2073  ""Test managed s
+00017640: 706f 7420 6a6f 6220 7769 7468 2066 6169  pot job with fai
+00017650: 6c65 6420 7365 7475 7020 666f 7220 6120  led setup for a 
+00017660: 7069 7065 6c69 6e65 2e22 2222 0a20 2020  pipeline.""".   
+00017670: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00017680: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00017690: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000176a0: 2020 2020 2027 7370 6f74 5f70 6970 656c       'spot_pipel
+000176b0: 696e 655f 6661 696c 6564 5f73 6574 7570  ine_failed_setup
+000176c0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000176d0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+000176e0: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
+000176f0: 616d 657d 202d 7920 2d64 2074 6573 7473  ame} -y -d tests
+00017700: 2f74 6573 745f 7961 6d6c 732f 6661 696c  /test_yamls/fail
+00017710: 6564 5f73 6574 7570 5f70 6970 656c 696e  ed_setup_pipelin
+00017720: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
+00017730: 2020 2020 2027 736c 6565 7020 3830 3027       'sleep 800'
+00017740: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00017750: 4d61 6b65 2073 7572 6520 7468 6520 6a6f  Make sure the jo
+00017760: 6220 6661 696c 6564 2071 7569 636b 6c79  b failed quickly
+00017770: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00017780: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00017790: 547d 207c 2067 7265 7020 7b6e 616d 657d  T} | grep {name}
+000177a0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+000177b0: 6570 2022 4641 494c 4544 5f53 4554 5550  ep "FAILED_SETUP
+000177c0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+000177d0: 2320 5461 736b 2030 2073 686f 756c 6420  # Task 0 should 
+000177e0: 6265 2053 5543 4345 4544 4544 2e0a 2020  be SUCCEEDED..  
+000177f0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00017800: 4f54 5f51 5545 5545 5f57 4149 547d 207c  OT_QUEUE_WAIT} |
+00017810: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00017820: 7d7c 2073 6564 202d 6e20 3270 207c 2067  }| sed -n 2p | g
+00017830: 7265 7020 2253 5543 4345 4544 4544 2227  rep "SUCCEEDED"'
+00017840: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00017850: 5461 736b 2031 2073 686f 756c 6420 6265  Task 1 should be
+00017860: 2046 4149 4c45 445f 5345 5455 502e 0a20   FAILED_SETUP.. 
+00017870: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00017880: 504f 545f 5155 4555 455f 5741 4954 7d20  POT_QUEUE_WAIT} 
+00017890: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
+000178a0: 657d 7c20 7365 6420 2d6e 2033 7020 7c20  e}| sed -n 3p | 
+000178b0: 6772 6570 2022 4641 494c 4544 5f53 4554  grep "FAILED_SET
+000178c0: 5550 2227 2c0a 2020 2020 2020 2020 2020  UP"',.          
+000178d0: 2020 2320 5461 736b 2032 2073 686f 756c    # Task 2 shoul
+000178e0: 6420 6265 2043 414e 4345 4c4c 4544 2e0a  d be CANCELLED..
+000178f0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00017900: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00017910: 207c 2067 7265 7020 2d41 2034 207b 6e61   | grep -A 4 {na
+00017920: 6d65 7d7c 2073 6564 202d 6e20 3470 207c  me}| sed -n 4p |
+00017930: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
+00017940: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00017950: 2320 5461 736b 2033 2073 686f 756c 6420  # Task 3 should 
+00017960: 6265 2043 414e 4345 4c4c 4544 2e0a 2020  be CANCELLED..  
+00017970: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00017980: 4f54 5f51 5545 5545 5f57 4149 547d 207c  OT_QUEUE_WAIT} |
+00017990: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+000179a0: 7d7c 2073 6564 202d 6e20 3570 207c 2067  }| sed -n 5p | g
+000179b0: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
+000179c0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+000179d0: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+000179e0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+000179f0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+00017a00: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+00017a10: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+00017a20: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
+00017a30: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+00017a40: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+00017a50: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+00017a60: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
+00017a70: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00017a80: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+00017a90: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
+00017aa0: 6720 6d61 6e61 6765 6420 7370 6f74 2072  g managed spot r
+00017ab0: 6563 6f76 6572 7920 2d2d 2d2d 2d2d 2d2d  ecovery --------
+00017ac0: 2d2d 0a0a 0a40 7079 7465 7374 2e6d 6172  --...@pytest.mar
+00017ad0: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
+00017ae0: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+00017af0: 6465 6620 7465 7374 5f73 706f 745f 7265  def test_spot_re
+00017b00: 636f 7665 7279 5f61 7773 2861 7773 5f63  covery_aws(aws_c
+00017b10: 6f6e 6669 675f 7265 6769 6f6e 293a 0a20  onfig_region):. 
+00017b20: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
+00017b30: 6564 2073 706f 7420 7265 636f 7665 7279  ed spot recovery
+00017b40: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+00017b50: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00017b60: 6528 290a 2020 2020 6e61 6d65 5f6f 6e5f  e().    name_on_
+00017b70: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
+00017b80: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
+00017b90: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
+00017ba0: 0a20 2020 2020 2020 206e 616d 652c 2073  .        name, s
+00017bb0: 706f 742e 5350 4f54 5f43 4c55 5354 4552  pot.SPOT_CLUSTER
+00017bc0: 5f4e 414d 455f 5052 4546 4958 5f4c 454e  _NAME_PREFIX_LEN
+00017bd0: 4754 482c 2061 6464 5f75 7365 725f 6861  GTH, add_user_ha
+00017be0: 7368 3d46 616c 7365 290a 2020 2020 7265  sh=False).    re
+00017bf0: 6769 6f6e 203d 2061 7773 5f63 6f6e 6669  gion = aws_confi
+00017c00: 675f 7265 6769 6f6e 0a20 2020 2074 6573  g_region.    tes
+00017c10: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00017c20: 2020 2773 706f 745f 7265 636f 7665 7279    'spot_recovery
+00017c30: 5f61 7773 272c 0a20 2020 2020 2020 205b  _aws',.        [
+00017c40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00017c50: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
+00017c60: 2d63 6c6f 7564 2061 7773 202d 2d72 6567  -cloud aws --reg
+00017c70: 696f 6e20 7b72 6567 696f 6e7d 202d 6e20  ion {region} -n 
+00017c80: 7b6e 616d 657d 2022 6563 686f 2053 4b59  {name} "echo SKY
+00017c90: 5049 4c4f 545f 5441 534b 5f49 443a 205c  PILOT_TASK_ID: \
+00017ca0: 2453 4b59 5049 4c4f 545f 5441 534b 5f49  $SKYPILOT_TASK_I
+00017cb0: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
+00017cc0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00017cd0: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
+00017ce0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00017cf0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00017d00: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00017d10: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00017d20: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+00017d30: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
+00017d40: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
+00017d50: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+00017d60: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+00017d70: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
+00017d80: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
+00017d90: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
+00017da0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
+00017db0: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
+00017dc0: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
+00017dd0: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
+00017de0: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
+00017df0: 2020 2020 2866 2761 7773 2065 6332 2074      (f'aws ec2 t
+00017e00: 6572 6d69 6e61 7465 2d69 6e73 7461 6e63  erminate-instanc
+00017e10: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
+00017e20: 696f 6e7d 202d 2d69 6e73 7461 6e63 652d  ion} --instance-
+00017e30: 6964 7320 2428 270a 2020 2020 2020 2020  ids $('.        
+00017e40: 2020 2020 2066 2761 7773 2065 6332 2064       f'aws ec2 d
+00017e50: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
+00017e60: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+00017e70: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+00017e80: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
+00017e90: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
+00017ea0: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
+00017eb0: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d2a  {name_on_cloud}*
+00017ec0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00017ed0: 6627 2d2d 7175 6572 7920 5265 7365 7276  f'--query Reserv
+00017ee0: 6174 696f 6e73 5b5d 2e49 6e73 7461 6e63  ations[].Instanc
+00017ef0: 6573 5b5d 2e49 6e73 7461 6e63 6549 6420  es[].InstanceId 
+00017f00: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
+00017f10: 2d2d 6f75 7470 7574 2074 6578 7429 2729  --output text)')
+00017f20: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00017f30: 6c65 6570 2031 3030 272c 0a20 2020 2020  leep 100',.     
+00017f40: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00017f50: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00017f60: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+00017f70: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
+00017f80: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
+00017f90: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
+00017fa0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00017fb0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00017fc0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+00017fd0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+00017fe0: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
+00017ff0: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
+00018000: 5f49 443d 2428 6361 7420 2f74 6d70 2f7b  _ID=$(cat /tmp/{
+00018010: 6e61 6d65 7d2d 7275 6e2d 6964 293b 2065  name}-run-id); e
+00018020: 6368 6f20 2452 554e 5f49 443b 2073 6b79  cho $RUN_ID; sky
+00018030: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
+00018040: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
+00018050: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
+00018060: 5f54 4153 4b5f 4944 207c 2067 7265 7020  _TASK_ID | grep 
+00018070: 2224 5255 4e5f 4944 2227 2c0a 2020 2020  "$RUN_ID"',.    
+00018080: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+00018090: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+000180a0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+000180b0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+000180c0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+000180d0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000180e0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000180f0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+00018100: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00018110: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00018120: 6573 745f 7370 6f74 5f72 6563 6f76 6572  est_spot_recover
+00018130: 795f 6763 7028 293a 0a20 2020 2022 2222  y_gcp():.    """
+00018140: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
+00018150: 7420 7265 636f 7665 7279 2e22 2222 0a20  t recovery.""". 
+00018160: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00018170: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00018180: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
+00018190: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+000181a0: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+000181b0: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
+000181c0: 2020 206e 616d 652c 2073 706f 742e 5350     name, spot.SP
+000181d0: 4f54 5f43 4c55 5354 4552 5f4e 414d 455f  OT_CLUSTER_NAME_
+000181e0: 5052 4546 4958 5f4c 454e 4754 482c 2061  PREFIX_LENGTH, a
+000181f0: 6464 5f75 7365 725f 6861 7368 3d46 616c  dd_user_hash=Fal
+00018200: 7365 290a 2020 2020 7a6f 6e65 203d 2027  se).    zone = '
+00018210: 7573 2d65 6173 7434 2d62 270a 2020 2020  us-east4-b'.    
+00018220: 7175 6572 795f 636d 6420 3d20 280a 2020  query_cmd = (.  
+00018230: 2020 2020 2020 6627 6763 6c6f 7564 2063        f'gcloud c
+00018240: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
+00018250: 206c 6973 7420 2d2d 6669 6c74 6572 3d27   list --filter='
+00018260: 0a20 2020 2020 2020 2023 2060 3a60 206d  .        # `:` m
+00018270: 6561 6e73 2070 7265 6669 7820 6d61 7463  eans prefix matc
+00018280: 682e 0a20 2020 2020 2020 2066 2722 286c  h..        f'"(l
+00018290: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
+000182a0: 722d 6e61 6d65 3a7b 6e61 6d65 5f6f 6e5f  r-name:{name_on_
+000182b0: 636c 6f75 647d 2922 2027 0a20 2020 2020  cloud})" '.     
+000182c0: 2020 2066 272d 2d7a 6f6e 6573 3d7b 7a6f     f'--zones={zo
+000182d0: 6e65 7d20 2d2d 666f 726d 6174 3d22 7661  ne} --format="va
+000182e0: 6c75 6528 6e61 6d65 2922 2729 0a20 2020  lue(name)"').   
+000182f0: 2074 6572 6d69 6e61 7465 5f63 6d64 203d   terminate_cmd =
+00018300: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
+00018310: 7465 2069 6e73 7461 6e63 6573 2064 656c  te instances del
+00018320: 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65  ete --zone={zone
+00018330: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00018340: 2020 2020 2020 2020 6627 202d 2d71 7569          f' --qui
+00018350: 6574 2024 287b 7175 6572 795f 636d 647d  et $({query_cmd}
+00018360: 2927 290a 2020 2020 7465 7374 203d 2054  )').    test = T
+00018370: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
+00018380: 6f74 5f72 6563 6f76 6572 795f 6763 7027  ot_recovery_gcp'
+00018390: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+000183a0: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+000183b0: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
+000183c0: 6420 6763 7020 2d2d 7a6f 6e65 207b 7a6f  d gcp --zone {zo
+000183d0: 6e65 7d20 2d6e 207b 6e61 6d65 7d20 2d2d  ne} -n {name} --
+000183e0: 6370 7573 2032 2022 6563 686f 2053 4b59  cpus 2 "echo SKY
+000183f0: 5049 4c4f 545f 5441 534b 5f49 443a 205c  PILOT_TASK_ID: \
+00018400: 2453 4b59 5049 4c4f 545f 5441 534b 5f49  $SKYPILOT_TASK_I
+00018410: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
+00018420: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00018430: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
+00018440: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00018450: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00018460: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00018470: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00018480: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+00018490: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
+000184a0: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
+000184b0: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+000184c0: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+000184d0: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
+000184e0: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
+000184f0: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
+00018500: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
+00018510: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
+00018520: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
+00018530: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
+00018540: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
+00018550: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
+00018560: 642c 0a20 2020 2020 2020 2020 2020 2027  d,.            '
+00018570: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
+00018580: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00018590: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+000185a0: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+000185b0: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
+000185c0: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
+000185d0: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
+000185e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000185f0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00018600: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+00018610: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+00018620: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
+00018630: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
+00018640: 5f49 443d 2428 6361 7420 2f74 6d70 2f7b  _ID=$(cat /tmp/{
+00018650: 6e61 6d65 7d2d 7275 6e2d 6964 293b 2065  name}-run-id); e
+00018660: 6368 6f20 2452 554e 5f49 443b 2073 6b79  cho $RUN_ID; sky
+00018670: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
+00018680: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
+00018690: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
+000186a0: 5f54 4153 4b5f 4944 3a20 7c20 6772 6570  _TASK_ID: | grep
+000186b0: 2022 2452 554e 5f49 4422 272c 0a20 2020   "$RUN_ID"',.   
+000186c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000186d0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+000186e0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+000186f0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+00018700: 2074 696d 656f 7574 3d32 3520 2a20 3630   timeout=25 * 60
+00018710: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00018720: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00018730: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+00018740: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
+00018750: 616e 6167 6564 5f73 706f 740a 6465 6620  anaged_spot.def 
+00018760: 7465 7374 5f73 706f 745f 7069 7065 6c69  test_spot_pipeli
+00018770: 6e65 5f72 6563 6f76 6572 795f 6177 7328  ne_recovery_aws(
+00018780: 6177 735f 636f 6e66 6967 5f72 6567 696f  aws_config_regio
+00018790: 6e29 3a0a 2020 2020 2222 2254 6573 7420  n):.    """Test 
+000187a0: 6d61 6e61 6765 6420 7370 6f74 2072 6563  managed spot rec
+000187b0: 6f76 6572 7920 666f 7220 6120 7069 7065  overy for a pipe
+000187c0: 6c69 6e65 2e22 2222 0a20 2020 206e 616d  line.""".    nam
+000187d0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000187e0: 5f6e 616d 6528 290a 2020 2020 7573 6572  _name().    user
+000187f0: 5f68 6173 6820 3d20 636f 6d6d 6f6e 5f75  _hash = common_u
+00018800: 7469 6c73 2e67 6574 5f75 7365 725f 6861  tils.get_user_ha
+00018810: 7368 2829 0a20 2020 2075 7365 725f 6861  sh().    user_ha
+00018820: 7368 203d 2075 7365 725f 6861 7368 5b3a  sh = user_hash[:
+00018830: 636f 6d6d 6f6e 5f75 7469 6c73 2e55 5345  common_utils.USE
+00018840: 525f 4841 5348 5f4c 454e 4754 485f 494e  R_HASH_LENGTH_IN
+00018850: 5f43 4c55 5354 4552 5f4e 414d 455d 0a20  _CLUSTER_NAME]. 
+00018860: 2020 2072 6567 696f 6e20 3d20 6177 735f     region = aws_
+00018870: 636f 6e66 6967 5f72 6567 696f 6e0a 2020  config_region.  
+00018880: 2020 6966 2072 6567 696f 6e20 213d 2027    if region != '
+00018890: 7573 2d65 6173 742d 3227 3a0a 2020 2020  us-east-2':.    
+000188a0: 2020 2020 7079 7465 7374 2e73 6b69 7028      pytest.skip(
+000188b0: 274f 6e6c 7920 7275 6e20 7370 6f74 2070  'Only run spot p
+000188c0: 6970 656c 696e 6520 7265 636f 7665 7279  ipeline recovery
+000188d0: 2074 6573 7420 696e 2075 732d 6561 7374   test in us-east
+000188e0: 2d32 2729 0a20 2020 2074 6573 7420 3d20  -2').    test = 
+000188f0: 5465 7374 280a 2020 2020 2020 2020 2773  Test(.        's
+00018900: 706f 745f 7069 7065 6c69 6e65 5f72 6563  pot_pipeline_rec
+00018910: 6f76 6572 795f 6177 7327 2c0a 2020 2020  overy_aws',.    
+00018920: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00018930: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
+00018940: 6e63 6820 2d6e 207b 6e61 6d65 7d20 7465  nch -n {name} te
+00018950: 7374 732f 7465 7374 5f79 616d 6c73 2f70  sts/test_yamls/p
+00018960: 6970 656c 696e 655f 6177 732e 7961 6d6c  ipeline_aws.yaml
+00018970: 2020 2d79 202d 6427 2c0a 2020 2020 2020    -y -d',.      
+00018980: 2020 2020 2020 2773 6c65 6570 2034 3030        'sleep 400
+00018990: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000189a0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+000189b0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+000189c0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+000189d0: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
+000189e0: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
+000189f0: 5f49 443d 2428 736b 7920 7370 6f74 206c  _ID=$(sky spot l
+00018a00: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
+00018a10: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
+00018a20: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
+00018a30: 443a 207c 2063 7574 202d 643a 202d 6632  D: | cut -d: -f2
+00018a40: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
+00018a50: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
+00018a60: 6d65 7d2d 7275 6e2d 6964 272c 0a20 2020  me}-run-id',.   
+00018a70: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
+00018a80: 4453 3d24 2873 6b79 2073 706f 7420 6c6f  DS=$(sky spot lo
+00018a90: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
+00018aa0: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
+00018ab0: 2d41 2034 2053 4b59 5049 4c4f 545f 5441  -A 4 SKYPILOT_TA
+00018ac0: 534b 5f49 4453 207c 2063 7574 202d 6422  SK_IDS | cut -d"
+00018ad0: 2922 202d 6632 293b 2065 6368 6f20 2224  )" -f2); echo "$
+00018ae0: 5255 4e5f 4944 5322 207c 2074 6565 202f  RUN_IDS" | tee /
+00018af0: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+00018b00: 6473 272c 0a20 2020 2020 2020 2020 2020  ds',.           
+00018b10: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
+00018b20: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
+00018b30: 792e 0a20 2020 2020 2020 2020 2020 2023  y..            #
+00018b40: 2054 6865 2060 6361 7420 2e2e 2e7c 2072   The `cat ...| r
+00018b50: 6576 6020 6973 2074 6f20 7265 7472 6965  ev` is to retrie
+00018b60: 7665 2074 6865 206a 6f62 5f69 6420 6672  ve the job_id fr
+00018b70: 6f6d 2074 6865 0a20 2020 2020 2020 2020  om the.         
+00018b80: 2020 2023 2053 4b59 5049 4c4f 545f 5441     # SKYPILOT_TA
+00018b90: 534b 5f49 442c 2077 6869 6368 2067 6574  SK_ID, which get
+00018ba0: 7320 7468 6520 7365 636f 6e64 2074 6f20  s the second to 
+00018bb0: 6c61 7374 2066 6965 6c64 0a20 2020 2020  last field.     
+00018bc0: 2020 2020 2020 2023 2073 6570 6172 6174         # separat
+00018bd0: 6564 2062 7920 602d 602e 0a20 2020 2020  ed by `-`..     
+00018be0: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
+00018bf0: 2020 2020 2020 2020 2066 2753 504f 545f           f'SPOT_
+00018c00: 4a4f 425f 4944 3d60 6361 7420 2f74 6d70  JOB_ID=`cat /tmp
+00018c10: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 207c  /{name}-run-id |
+00018c20: 2072 6576 207c 2027 0a20 2020 2020 2020   rev | '.       
+00018c30: 2020 2020 2020 2020 2027 6375 7420 2d64           'cut -d
+00018c40: 5c27 2d5c 2720 2d66 3220 7c20 7265 7660  \'-\' -f2 | rev`
+00018c50: 3b27 0a20 2020 2020 2020 2020 2020 2020  ;'.             
+00018c60: 2020 2066 2761 7773 2065 6332 2074 6572     f'aws ec2 ter
+00018c70: 6d69 6e61 7465 2d69 6e73 7461 6e63 6573  minate-instances
+00018c80: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00018c90: 6e7d 202d 2d69 6e73 7461 6e63 652d 6964  n} --instance-id
+00018ca0: 7320 2428 270a 2020 2020 2020 2020 2020  s $('.          
+00018cb0: 2020 2020 2020 6627 6177 7320 6563 3220        f'aws ec2 
+00018cc0: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
+00018cd0: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
+00018ce0: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+00018cf0: 2020 2020 2020 2023 2054 4f44 4f28 7a68         # TODO(zh
+00018d00: 7775 293a 2066 6978 2074 6865 206e 616d  wu): fix the nam
+00018d10: 6520 666f 7220 7370 6f74 2063 6c75 7374  e for spot clust
+00018d20: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
+00018d30: 2020 2020 272d 2d66 696c 7465 7273 204e      '--filters N
+00018d40: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
+00018d50: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
+00018d60: 2a2d 247b 5350 4f54 5f4a 4f42 5f49 447d  *-${SPOT_JOB_ID}
+00018d70: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00018d80: 2020 6627 2d7b 7573 6572 5f68 6173 687d    f'-{user_hash}
+00018d90: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00018da0: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
+00018db0: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
+00018dc0: 616e 6365 735b 5d2e 496e 7374 616e 6365  ances[].Instance
+00018dd0: 4964 2027 0a20 2020 2020 2020 2020 2020  Id '.           
+00018de0: 2020 2020 2027 2d2d 6f75 7470 7574 2074       '--output t
+00018df0: 6578 7429 2729 2c0a 2020 2020 2020 2020  ext)'),.        
+00018e00: 2020 2020 2773 6c65 6570 2031 3030 272c      'sleep 100',
+00018e10: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00018e20: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00018e30: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00018e40: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00018e50: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+00018e60: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00018e70: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+00018e80: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00018e90: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00018ea0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00018eb0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00018ec0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00018ed0: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
+00018ee0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+00018ef0: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
+00018f00: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
+00018f10: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00018f20: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+00018f30: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
+00018f40: 7c20 6772 6570 2022 2452 554e 5f49 4422  | grep "$RUN_ID"
+00018f50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00018f60: 2752 554e 5f49 4453 3d24 2873 6b79 2073  'RUN_IDS=$(sky s
+00018f70: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
+00018f80: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+00018f90: 2067 7265 7020 2d41 2034 2053 4b59 5049   grep -A 4 SKYPI
+00018fa0: 4c4f 545f 5441 534b 5f49 4453 207c 2063  LOT_TASK_IDS | c
+00018fb0: 7574 202d 6422 2922 202d 6632 293b 2065  ut -d")" -f2); e
+00018fc0: 6368 6f20 2224 5255 4e5f 4944 5322 207c  cho "$RUN_IDS" |
+00018fd0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
+00018fe0: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
+00018ff0: 2020 2020 2020 2020 2020 2066 2764 6966             f'dif
+00019000: 6620 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  f /tmp/{name}-ru
+00019010: 6e2d 6964 7320 2f74 6d70 2f7b 6e61 6d65  n-ids /tmp/{name
+00019020: 7d2d 7275 6e2d 6964 732d 6e65 7727 2c0a  }-run-ids-new',.
+00019030: 2020 2020 2020 2020 2020 2020 6627 6361              f'ca
+00019040: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
+00019050: 6e2d 6964 7320 7c20 7365 6420 2d6e 2032  n-ids | sed -n 2
+00019060: 7020 7c20 6772 6570 2060 6361 7420 2f74  p | grep `cat /t
+00019070: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+00019080: 6027 2c0a 2020 2020 2020 2020 5d2c 0a20  `',.        ],. 
+00019090: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
+000190a0: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+000190b0: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
+000190c0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+000190d0: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
+000190e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000190f0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00019100: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+00019110: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
+00019120: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
+00019130: 5f70 6970 656c 696e 655f 7265 636f 7665  _pipeline_recove
+00019140: 7279 5f67 6370 2829 3a0a 2020 2020 2222  ry_gcp():.    ""
+00019150: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
+00019160: 6f74 2072 6563 6f76 6572 7920 666f 7220  ot recovery for 
+00019170: 6120 7069 7065 6c69 6e65 2e22 2222 0a20  a pipeline.""". 
+00019180: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00019190: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+000191a0: 2020 7a6f 6e65 203d 2027 7573 2d65 6173    zone = 'us-eas
+000191b0: 7434 2d62 270a 2020 2020 7573 6572 5f68  t4-b'.    user_h
+000191c0: 6173 6820 3d20 636f 6d6d 6f6e 5f75 7469  ash = common_uti
+000191d0: 6c73 2e67 6574 5f75 7365 725f 6861 7368  ls.get_user_hash
+000191e0: 2829 0a20 2020 2075 7365 725f 6861 7368  ().    user_hash
+000191f0: 203d 2075 7365 725f 6861 7368 5b3a 636f   = user_hash[:co
+00019200: 6d6d 6f6e 5f75 7469 6c73 2e55 5345 525f  mmon_utils.USER_
+00019210: 4841 5348 5f4c 454e 4754 485f 494e 5f43  HASH_LENGTH_IN_C
+00019220: 4c55 5354 4552 5f4e 414d 455d 0a20 2020  LUSTER_NAME].   
+00019230: 2071 7565 7279 5f63 6d64 203d 2028 2767   query_cmd = ('g
+00019240: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
+00019250: 7374 616e 6365 7320 6c69 7374 202d 2d66  stances list --f
+00019260: 696c 7465 723d 270a 2020 2020 2020 2020  ilter='.        
+00019270: 2020 2020 2020 2020 2066 2722 286c 6162           f'"(lab
+00019280: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
+00019290: 6e61 6d65 3a2a 2d24 7b7b 5350 4f54 5f4a  name:*-${{SPOT_J
+000192a0: 4f42 5f49 447d 7d2d 7b75 7365 725f 6861  OB_ID}}-{user_ha
+000192b0: 7368 7d29 2220 270a 2020 2020 2020 2020  sh})" '.        
+000192c0: 2020 2020 2020 2020 2066 272d 2d7a 6f6e           f'--zon
+000192d0: 6573 3d7b 7a6f 6e65 7d20 2d2d 666f 726d  es={zone} --form
+000192e0: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
+000192f0: 2729 0a20 2020 2074 6572 6d69 6e61 7465  ').    terminate
+00019300: 5f63 6d64 203d 2028 6627 6763 6c6f 7564  _cmd = (f'gcloud
+00019310: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+00019320: 6573 2064 656c 6574 6520 2d2d 7a6f 6e65  es delete --zone
+00019330: 3d7b 7a6f 6e65 7d27 0a20 2020 2020 2020  ={zone}'.       
+00019340: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00019350: 202d 2d71 7569 6574 2024 287b 7175 6572   --quiet $({quer
+00019360: 795f 636d 647d 2927 290a 2020 2020 7465  y_cmd})').    te
+00019370: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00019380: 2020 2027 7370 6f74 5f70 6970 656c 696e     'spot_pipelin
+00019390: 655f 7265 636f 7665 7279 5f67 6370 272c  e_recovery_gcp',
+000193a0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+000193b0: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+000193c0: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
+000193d0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+000193e0: 6d6c 732f 7069 7065 6c69 6e65 5f67 6370  mls/pipeline_gcp
+000193f0: 2e79 616d 6c20 202d 7920 2d64 272c 0a20  .yaml  -y -d',. 
+00019400: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00019410: 7020 3430 3027 2c0a 2020 2020 2020 2020  p 400',.        
+00019420: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00019430: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00019440: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+00019450: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+00019460: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00019470: 6627 5255 4e5f 4944 3d24 2873 6b79 2073  f'RUN_ID=$(sky s
+00019480: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
+00019490: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+000194a0: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
+000194b0: 4153 4b5f 4944 3a20 7c20 6375 7420 2d64  ASK_ID: | cut -d
+000194c0: 3a20 2d66 3229 3b20 6563 686f 2022 2452  : -f2); echo "$R
+000194d0: 554e 5f49 4422 207c 2074 6565 202f 746d  UN_ID" | tee /tm
+000194e0: 702f 7b6e 616d 657d 2d72 756e 2d69 6427  p/{name}-run-id'
+000194f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00019500: 5255 4e5f 4944 533d 2428 736b 7920 7370  RUN_IDS=$(sky sp
+00019510: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
+00019520: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+00019530: 6772 6570 202d 4120 3420 534b 5950 494c  grep -A 4 SKYPIL
+00019540: 4f54 5f54 4153 4b5f 4944 5320 7c20 6375  OT_TASK_IDS | cu
+00019550: 7420 2d64 2229 2220 2d66 3229 3b20 6563  t -d")" -f2); ec
+00019560: 686f 2022 2452 554e 5f49 4453 2220 7c20  ho "$RUN_IDS" | 
+00019570: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
+00019580: 7275 6e2d 6964 7327 2c0a 2020 2020 2020  run-ids',.      
+00019590: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
+000195a0: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
+000195b0: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
+000195c0: 2020 2020 2320 5468 6520 6063 6174 202e      # The `cat .
+000195d0: 2e2e 7c20 7265 7660 2069 7320 746f 2072  ..| rev` is to r
+000195e0: 6574 7269 6576 6520 7468 6520 6a6f 625f  etrieve the job_
+000195f0: 6964 2066 726f 6d20 7468 650a 2020 2020  id from the.    
+00019600: 2020 2020 2020 2020 2320 534b 5950 494c          # SKYPIL
+00019610: 4f54 5f54 4153 4b5f 4944 2c20 7768 6963  OT_TASK_ID, whic
+00019620: 6820 6765 7473 2074 6865 2073 6563 6f6e  h gets the secon
+00019630: 6420 746f 206c 6173 7420 6669 656c 640a  d to last field.
+00019640: 2020 2020 2020 2020 2020 2020 2320 7365              # se
+00019650: 7061 7261 7465 6420 6279 2060 2d60 2e0a  parated by `-`..
+00019660: 2020 2020 2020 2020 2020 2020 2866 2753              (f'S
+00019670: 504f 545f 4a4f 425f 4944 3d60 6361 7420  POT_JOB_ID=`cat 
+00019680: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+00019690: 6964 207c 2072 6576 207c 2027 0a20 2020  id | rev | '.   
+000196a0: 2020 2020 2020 2020 2020 6627 6375 7420            f'cut 
+000196b0: 2d64 5c27 2d5c 2720 2d66 3220 7c20 7265  -d\'-\' -f2 | re
+000196c0: 7660 3b7b 7465 726d 696e 6174 655f 636d  v`;{terminate_cm
+000196d0: 647d 2729 2c0a 2020 2020 2020 2020 2020  d}'),.          
+000196e0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+000196f0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00019700: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+00019710: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+00019720: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+00019730: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+00019740: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00019750: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+00019760: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00019770: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00019780: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00019790: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+000197a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000197b0: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
+000197c0: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
+000197d0: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
+000197e0: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
+000197f0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+00019800: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+00019810: 4c4f 545f 5441 534b 5f49 443a 207c 2067  LOT_TASK_ID: | g
+00019820: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
+00019830: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
+00019840: 4e5f 4944 533d 2428 736b 7920 7370 6f74  N_IDS=$(sky spot
+00019850: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+00019860: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+00019870: 6570 202d 4120 3420 534b 5950 494c 4f54  ep -A 4 SKYPILOT
+00019880: 5f54 4153 4b5f 4944 5320 7c20 6375 7420  _TASK_IDS | cut 
+00019890: 2d64 2229 2220 2d66 3229 3b20 6563 686f  -d")" -f2); echo
+000198a0: 2022 2452 554e 5f49 4453 2220 7c20 7465   "$RUN_IDS" | te
+000198b0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
+000198c0: 6e2d 6964 732d 6e65 7727 2c0a 2020 2020  n-ids-new',.    
+000198d0: 2020 2020 2020 2020 6627 6469 6666 202f          f'diff /
+000198e0: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+000198f0: 6473 202f 746d 702f 7b6e 616d 657d 2d72  ds /tmp/{name}-r
+00019900: 756e 2d69 6473 2d6e 6577 272c 0a20 2020  un-ids-new',.   
+00019910: 2020 2020 2020 2020 2066 2763 6174 202f           f'cat /
+00019920: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+00019930: 6473 207c 2073 6564 202d 6e20 3270 207c  ds | sed -n 2p |
+00019940: 2067 7265 7020 6063 6174 202f 746d 702f   grep `cat /tmp/
+00019950: 7b6e 616d 657d 2d72 756e 2d69 6460 272c  {name}-run-id`',
+00019960: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00019970: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
+00019980: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+00019990: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+000199a0: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
+000199b0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+000199c0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000199d0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+000199e0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+000199f0: 2023 2046 6c75 6964 7374 6163 6b20 646f   # Fluidstack do
+00019a00: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00019a10: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00019a20: 7974 6573 742e 6d61 726b 2e6e 6f5f 617a  ytest.mark.no_az
+00019a30: 7572 6520 2023 2041 7a75 7265 2064 6f65  ure  # Azure doe
+00019a40: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00019a50: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00019a60: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+00019a70: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+00019a80: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+00019a90: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00019aa0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00019ab0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+00019ac0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+00019ad0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00019ae0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00019af0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+00019b00: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+00019b10: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00019b20: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00019b30: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+00019b40: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
+00019b50: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00019b60: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00019b70: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
+00019b80: 7562 6572 6e65 7465 7320 2023 204b 7562  ubernetes  # Kub
+00019b90: 6572 6e65 7465 7320 646f 6573 206e 6f74  ernetes does not
+00019ba0: 2068 6176 6520 6120 6e6f 7469 6f6e 206f   have a notion o
+00019bb0: 6620 7370 6f74 2069 6e73 7461 6e63 6573  f spot instances
+00019bc0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00019bd0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00019be0: 6573 745f 7370 6f74 5f72 6563 6f76 6572  est_spot_recover
+00019bf0: 795f 6465 6661 756c 745f 7265 736f 7572  y_default_resour
+00019c00: 6365 7328 6765 6e65 7269 635f 636c 6f75  ces(generic_clou
+00019c10: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00019c20: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
+00019c30: 7420 7265 636f 7665 7279 2066 6f72 2064  t recovery for d
+00019c40: 6566 6175 6c74 2072 6573 6f75 7263 6573  efault resources
+00019c50: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+00019c60: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00019c70: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00019c80: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
+00019c90: 6e61 6765 642d 7370 6f74 2d72 6563 6f76  naged-spot-recov
+00019ca0: 6572 792d 6465 6661 756c 742d 7265 736f  ery-default-reso
+00019cb0: 7572 6365 7327 2c0a 2020 2020 2020 2020  urces',.        
+00019cc0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00019cd0: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
+00019ce0: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
+00019cf0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00019d00: 7d20 2273 6c65 6570 2033 3020 2626 2073  } "sleep 30 && s
+00019d10: 7564 6f20 7368 7574 646f 776e 206e 6f77  udo shutdown now
+00019d20: 2026 2620 736c 6565 7020 3130 3030 2220   && sleep 1000" 
+00019d30: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00019d40: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
+00019d50: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00019d60: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00019d70: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00019d80: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00019d90: 2022 5255 4e4e 494e 475c 7c52 4543 4f56   "RUNNING\|RECOV
+00019da0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00019db0: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
+00019dc0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00019dd0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+00019de0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+00019df0: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
+00019e00: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00019e10: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00019e20: 7465 7374 2e6d 6172 6b2e 6177 730a 4070  test.mark.aws.@p
+00019e30: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
+00019e40: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
+00019e50: 5f73 706f 745f 7265 636f 7665 7279 5f6d  _spot_recovery_m
+00019e60: 756c 7469 5f6e 6f64 655f 6177 7328 6177  ulti_node_aws(aw
+00019e70: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
+00019e80: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00019e90: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
+00019ea0: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
+00019eb0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00019ec0: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
+00019ed0: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
+00019ee0: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
+00019ef0: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+00019f00: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
+00019f10: 2c20 7370 6f74 2e53 504f 545f 434c 5553  , spot.SPOT_CLUS
+00019f20: 5445 525f 4e41 4d45 5f50 5245 4649 585f  TER_NAME_PREFIX_
+00019f30: 4c45 4e47 5448 2c20 6164 645f 7573 6572  LENGTH, add_user
+00019f40: 5f68 6173 683d 4661 6c73 6529 0a20 2020  _hash=False).   
+00019f50: 2072 6567 696f 6e20 3d20 6177 735f 636f   region = aws_co
+00019f60: 6e66 6967 5f72 6567 696f 6e0a 2020 2020  nfig_region.    
+00019f70: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00019f80: 2020 2020 2027 7370 6f74 5f72 6563 6f76       'spot_recov
+00019f90: 6572 795f 6d75 6c74 695f 6e6f 6465 5f61  ery_multi_node_a
+00019fa0: 7773 272c 0a20 2020 2020 2020 205b 0a20  ws',.        [. 
+00019fb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00019fc0: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
+00019fd0: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+00019fe0: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+00019ff0: 616d 657d 202d 2d6e 756d 2d6e 6f64 6573  ame} --num-nodes
+0001a000: 2032 2022 6563 686f 2053 4b59 5049 4c4f   2 "echo SKYPILO
+0001a010: 545f 5441 534b 5f49 443a 205c 2453 4b59  T_TASK_ID: \$SKY
+0001a020: 5049 4c4f 545f 5441 534b 5f49 443b 2073  PILOT_TASK_ID; s
+0001a030: 6c65 6570 2031 3830 3022 2020 2d79 202d  leep 1800"  -y -
+0001a040: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+0001a050: 2773 6c65 6570 2034 3530 272c 0a20 2020  'sleep 450',.   
+0001a060: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+0001a070: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+0001a080: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+0001a090: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+0001a0a0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+0001a0b0: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
+0001a0c0: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
+0001a0d0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+0001a0e0: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+0001a0f0: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
+0001a100: 7420 2d64 3a20 2d66 3229 3b20 6563 686f  t -d: -f2); echo
+0001a110: 2022 2452 554e 5f49 4422 207c 2074 6565   "$RUN_ID" | tee
+0001a120: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001a130: 2d69 6427 2c0a 2020 2020 2020 2020 2020  -id',.          
+0001a140: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
+0001a150: 6520 776f 726b 6572 206d 616e 7561 6c6c  e worker manuall
+0001a160: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
+0001a170: 6627 6177 7320 6563 3220 7465 726d 696e  f'aws ec2 termin
+0001a180: 6174 652d 696e 7374 616e 6365 7320 2d2d  ate-instances --
+0001a190: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+0001a1a0: 2d2d 696e 7374 616e 6365 2d69 6473 2024  --instance-ids $
+0001a1b0: 2827 0a20 2020 2020 2020 2020 2020 2020  ('.             
+0001a1c0: 6627 6177 7320 6563 3220 6465 7363 7269  f'aws ec2 descri
+0001a1d0: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
+0001a1e0: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
+0001a1f0: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
+0001a200: 2d2d 6669 6c74 6572 7320 4e61 6d65 3d74  --filters Name=t
+0001a210: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
+0001a220: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
+0001a230: 5f6f 6e5f 636c 6f75 647d 2a20 270a 2020  _on_cloud}* '.  
+0001a240: 2020 2020 2020 2020 2020 2027 4e61 6d65             'Name
+0001a250: 3d74 6167 3a72 6179 2d6e 6f64 652d 7479  =tag:ray-node-ty
+0001a260: 7065 2c56 616c 7565 733d 776f 726b 6572  pe,Values=worker
+0001a270: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001a280: 6627 2d2d 7175 6572 7920 5265 7365 7276  f'--query Reserv
+0001a290: 6174 696f 6e73 5b5d 2e49 6e73 7461 6e63  ations[].Instanc
+0001a2a0: 6573 5b5d 2e49 6e73 7461 6e63 6549 6420  es[].InstanceId 
+0001a2b0: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
+0001a2c0: 2d2d 6f75 7470 7574 2074 6578 7429 2729  --output text)')
+0001a2d0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001a2e0: 6c65 6570 2035 3027 2c0a 2020 2020 2020  leep 50',.      
+0001a2f0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+0001a300: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001a310: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001a320: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+0001a330: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+0001a340: 2020 2020 2027 736c 6565 7020 3536 3027       'sleep 560'
+0001a350: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001a360: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+0001a370: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+0001a380: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001a390: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+0001a3a0: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+0001a3b0: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
+0001a3c0: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
+0001a3d0: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
+0001a3e0: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+0001a3f0: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+0001a400: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+0001a410: 5441 534b 5f49 4420 7c20 6375 7420 2d64  TASK_ID | cut -d
+0001a420: 3a20 2d66 3220 7c20 6772 6570 2022 2452  : -f2 | grep "$R
+0001a430: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
+0001a440: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
+0001a450: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+0001a460: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+0001a470: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+0001a480: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
+0001a490: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0001a4a0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+0001a4b0: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
+0001a4c0: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
+0001a4d0: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
+0001a4e0: 5f73 706f 745f 7265 636f 7665 7279 5f6d  _spot_recovery_m
+0001a4f0: 756c 7469 5f6e 6f64 655f 6763 7028 293a  ulti_node_gcp():
+0001a500: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
+0001a510: 6167 6564 2073 706f 7420 7265 636f 7665  aged spot recove
+0001a520: 7279 2e22 2222 0a20 2020 206e 616d 6520  ry.""".    name 
+0001a530: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0001a540: 616d 6528 290a 2020 2020 6e61 6d65 5f6f  ame().    name_o
+0001a550: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
+0001a560: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
+0001a570: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+0001a580: 6428 0a20 2020 2020 2020 206e 616d 652c  d(.        name,
+0001a590: 2073 706f 742e 5350 4f54 5f43 4c55 5354   spot.SPOT_CLUST
+0001a5a0: 4552 5f4e 414d 455f 5052 4546 4958 5f4c  ER_NAME_PREFIX_L
+0001a5b0: 454e 4754 482c 2061 6464 5f75 7365 725f  ENGTH, add_user_
+0001a5c0: 6861 7368 3d46 616c 7365 290a 2020 2020  hash=False).    
+0001a5d0: 7a6f 6e65 203d 2027 7573 2d77 6573 7432  zone = 'us-west2
+0001a5e0: 2d61 270a 2020 2020 2320 5573 6520 273a  -a'.    # Use ':
+0001a5f0: 2720 746f 206d 6174 6368 2061 7320 7468  ' to match as th
+0001a600: 6520 636c 7573 7465 7220 6e61 6d65 2077  e cluster name w
+0001a610: 696c 6c20 636f 6e74 6169 6e20 7468 6520  ill contain the 
+0001a620: 7375 6666 6978 2077 6974 6820 6a6f 6220  suffix with job 
+0001a630: 6964 0a20 2020 2071 7565 7279 5f63 6d64  id.    query_cmd
+0001a640: 203d 2028 0a20 2020 2020 2020 2066 2767   = (.        f'g
+0001a650: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
+0001a660: 7374 616e 6365 7320 6c69 7374 202d 2d66  stances list --f
+0001a670: 696c 7465 723d 270a 2020 2020 2020 2020  ilter='.        
+0001a680: 6627 2228 6c61 6265 6c73 2e72 6179 2d63  f'"(labels.ray-c
+0001a690: 6c75 7374 6572 2d6e 616d 653a 7b6e 616d  luster-name:{nam
+0001a6a0: 655f 6f6e 5f63 6c6f 7564 7d20 414e 4420  e_on_cloud} AND 
+0001a6b0: 270a 2020 2020 2020 2020 6627 6c61 6265  '.        f'labe
+0001a6c0: 6c73 2e72 6179 2d6e 6f64 652d 7479 7065  ls.ray-node-type
+0001a6d0: 3d77 6f72 6b65 7229 2220 2d2d 7a6f 6e65  =worker)" --zone
+0001a6e0: 733d 7b7a 6f6e 657d 202d 2d66 6f72 6d61  s={zone} --forma
+0001a6f0: 743d 2276 616c 7565 286e 616d 6529 2227  t="value(name)"'
+0001a700: 290a 2020 2020 7465 726d 696e 6174 655f  ).    terminate_
+0001a710: 636d 6420 3d20 2866 2767 636c 6f75 6420  cmd = (f'gcloud 
+0001a720: 636f 6d70 7574 6520 696e 7374 616e 6365  compute instance
+0001a730: 7320 6465 6c65 7465 202d 2d7a 6f6e 653d  s delete --zone=
+0001a740: 7b7a 6f6e 657d 270a 2020 2020 2020 2020  {zone}'.        
+0001a750: 2020 2020 2020 2020 2020 2020 2066 2720               f' 
+0001a760: 2d2d 7175 6965 7420 2428 7b71 7565 7279  --quiet $({query
+0001a770: 5f63 6d64 7d29 2729 0a20 2020 2074 6573  _cmd})').    tes
+0001a780: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0001a790: 2020 2773 706f 745f 7265 636f 7665 7279    'spot_recovery
+0001a7a0: 5f6d 756c 7469 5f6e 6f64 655f 6763 7027  _multi_node_gcp'
+0001a7b0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0001a7c0: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+0001a7d0: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
+0001a7e0: 6420 6763 7020 2d2d 7a6f 6e65 207b 7a6f  d gcp --zone {zo
+0001a7f0: 6e65 7d20 2d6e 207b 6e61 6d65 7d20 2d2d  ne} -n {name} --
+0001a800: 6e75 6d2d 6e6f 6465 7320 3220 2265 6368  num-nodes 2 "ech
+0001a810: 6f20 534b 5950 494c 4f54 5f54 4153 4b5f  o SKYPILOT_TASK_
+0001a820: 4944 3a20 5c24 534b 5950 494c 4f54 5f54  ID: \$SKYPILOT_T
+0001a830: 4153 4b5f 4944 3b20 736c 6565 7020 3138  ASK_ID; sleep 18
+0001a840: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
+0001a850: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001a860: 3430 3027 2c0a 2020 2020 2020 2020 2020  400',.          
+0001a870: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+0001a880: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001a890: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001a8a0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+0001a8b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001a8c0: 5255 4e5f 4944 3d24 2873 6b79 2073 706f  RUN_ID=$(sky spo
+0001a8d0: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
+0001a8e0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+0001a8f0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+0001a900: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
+0001a910: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
+0001a920: 4944 2220 7c20 7465 6520 2f74 6d70 2f7b  ID" | tee /tmp/{
+0001a930: 6e61 6d65 7d2d 7275 6e2d 6964 272c 0a20  name}-run-id',. 
+0001a940: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
+0001a950: 6d69 6e61 7465 2074 6865 2077 6f72 6b65  minate the worke
+0001a960: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+0001a970: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
+0001a980: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
+0001a990: 2020 2027 736c 6565 7020 3530 272c 0a20     'sleep 50',. 
+0001a9a0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+0001a9b0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+0001a9c0: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+0001a9d0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+0001a9e0: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
+0001a9f0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001aa00: 2034 3230 272c 0a20 2020 2020 2020 2020   420',.         
+0001aa10: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+0001aa20: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001aa30: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001aa40: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
+0001aa50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001aa60: 2752 554e 5f49 443d 2428 6361 7420 2f74  'RUN_ID=$(cat /t
+0001aa70: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+0001aa80: 293b 2065 6368 6f20 2452 554e 5f49 443b  ); echo $RUN_ID;
+0001aa90: 2073 6b79 2073 706f 7420 6c6f 6773 202d   sky spot logs -
+0001aaa0: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
+0001aab0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
+0001aac0: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
+0001aad0: 7574 202d 643a 202d 6632 207c 2067 7265  ut -d: -f2 | gre
+0001aae0: 7020 2224 5255 4e5f 4944 2227 2c0a 2020  p "$RUN_ID"',.  
+0001aaf0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0001ab00: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
+0001ab10: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
+0001ab20: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+0001ab30: 2020 7469 6d65 6f75 743d 3235 202a 2036    timeout=25 * 6
+0001ab40: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+0001ab50: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0001ab60: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
+0001ab70: 7773 0a40 7079 7465 7374 2e6d 6172 6b2e  ws.@pytest.mark.
+0001ab80: 6d61 6e61 6765 645f 7370 6f74 0a64 6566  managed_spot.def
+0001ab90: 2074 6573 745f 7370 6f74 5f63 616e 6365   test_spot_cance
+0001aba0: 6c6c 6174 696f 6e5f 6177 7328 6177 735f  llation_aws(aws_
+0001abb0: 636f 6e66 6967 5f72 6567 696f 6e29 3a0a  config_region):.
+0001abc0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001abd0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0001abe0: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
+0001abf0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+0001ac00: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
+0001ac10: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
+0001ac20: 2020 2020 6e61 6d65 2c20 7370 6f74 2e53      name, spot.S
+0001ac30: 504f 545f 434c 5553 5445 525f 4e41 4d45  POT_CLUSTER_NAME
+0001ac40: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
+0001ac50: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
+0001ac60: 6c73 6529 0a20 2020 206e 616d 655f 325f  lse).    name_2_
+0001ac70: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
+0001ac80: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
+0001ac90: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+0001aca0: 7564 280a 2020 2020 2020 2020 6627 7b6e  ud(.        f'{n
+0001acb0: 616d 657d 2d32 272c 2073 706f 742e 5350  ame}-2', spot.SP
+0001acc0: 4f54 5f43 4c55 5354 4552 5f4e 414d 455f  OT_CLUSTER_NAME_
+0001acd0: 5052 4546 4958 5f4c 454e 4754 482c 2061  PREFIX_LENGTH, a
+0001ace0: 6464 5f75 7365 725f 6861 7368 3d46 616c  dd_user_hash=Fal
+0001acf0: 7365 290a 2020 2020 6e61 6d65 5f33 5f6f  se).    name_3_o
+0001ad00: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
+0001ad10: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
+0001ad20: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+0001ad30: 6428 0a20 2020 2020 2020 2066 277b 6e61  d(.        f'{na
+0001ad40: 6d65 7d2d 3327 2c20 7370 6f74 2e53 504f  me}-3', spot.SPO
+0001ad50: 545f 434c 5553 5445 525f 4e41 4d45 5f50  T_CLUSTER_NAME_P
+0001ad60: 5245 4649 585f 4c45 4e47 5448 2c20 6164  REFIX_LENGTH, ad
+0001ad70: 645f 7573 6572 5f68 6173 683d 4661 6c73  d_user_hash=Fals
+0001ad80: 6529 0a20 2020 2072 6567 696f 6e20 3d20  e).    region = 
+0001ad90: 6177 735f 636f 6e66 6967 5f72 6567 696f  aws_config_regio
+0001ada0: 6e0a 2020 2020 7465 7374 203d 2054 6573  n.    test = Tes
+0001adb0: 7428 0a20 2020 2020 2020 2027 7370 6f74  t(.        'spot
+0001adc0: 5f63 616e 6365 6c6c 6174 696f 6e5f 6177  _cancellation_aw
+0001add0: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
+0001ade0: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
+0001adf0: 2063 616e 6365 6c6c 6174 696f 6e20 6475   cancellation du
+0001ae00: 7269 6e67 2073 706f 7420 636c 7573 7465  ring spot cluste
+0001ae10: 7220 6265 696e 6720 6c61 756e 6368 6564  r being launched
+0001ae20: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0001ae30: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
+0001ae40: 2d2d 636c 6f75 6420 6177 7320 2d2d 7265  --cloud aws --re
+0001ae50: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d6e  gion {region} -n
+0001ae60: 207b 6e61 6d65 7d20 2273 6c65 6570 2031   {name} "sleep 1
+0001ae70: 3030 3022 2020 2d79 202d 6427 2c0a 2020  000"  -y -d',.  
+0001ae80: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001ae90: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
+0001aea0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+0001aeb0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001aec0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001aed0: 2067 7265 7020 2253 5441 5254 494e 4722   grep "STARTING"
+0001aee0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+0001aef0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+0001af00: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+0001af10: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+0001af20: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+0001af30: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+0001af40: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+0001af50: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+0001af60: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+0001af70: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
+0001af80: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+0001af90: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
+0001afa0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001afb0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+0001afc0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+0001afd0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001afe0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+0001aff0: 2020 2020 2020 2020 2020 2020 2866 2773              (f's
+0001b000: 3d24 2861 7773 2065 6332 2064 6573 6372  =$(aws ec2 descr
+0001b010: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
+0001b020: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+0001b030: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+0001b040: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
+0001b050: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
+0001b060: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
+0001b070: 655f 6f6e 5f63 6c6f 7564 7d2d 2a20 270a  e_on_cloud}-* '.
+0001b080: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+0001b090: 2d71 7565 7279 2052 6573 6572 7661 7469  -query Reservati
+0001b0a0: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
+0001b0b0: 5d2e 5374 6174 655b 5d2e 4e61 6d65 2027  ].State[].Name '
+0001b0c0: 0a20 2020 2020 2020 2020 2020 2020 272d  .             '-
+0001b0d0: 2d6f 7574 7075 7420 7465 7874 2920 2626  -output text) &&
+0001b0e0: 2065 6368 6f20 2224 7322 2026 2620 6563   echo "$s" && ec
+0001b0f0: 686f 3b20 5b5b 202d 7a20 2224 7322 205d  ho; [[ -z "$s" ]
+0001b100: 5d20 7c7c 205b 5b20 2224 7322 203d 2022  ] || [[ "$s" = "
+0001b110: 7465 726d 696e 6174 6564 2220 5d5d 207c  terminated" ]] |
+0001b120: 7c20 5b5b 2022 2473 2220 3d20 2273 6875  | [[ "$s" = "shu
+0001b130: 7474 696e 672d 646f 776e 2220 5d5d 270a  tting-down" ]]'.
+0001b140: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+0001b150: 2020 2020 2020 2020 2020 2023 2054 6573             # Tes
+0001b160: 7420 6361 6e63 656c 6c69 6e67 2074 6865  t cancelling the
+0001b170: 2073 706f 7420 636c 7573 7465 7220 6475   spot cluster du
+0001b180: 7269 6e67 2073 706f 7420 6a6f 6220 6265  ring spot job be
+0001b190: 696e 6720 7365 7475 702e 0a20 2020 2020  ing setup..     
+0001b1a0: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+0001b1b0: 7420 6c61 756e 6368 202d 2d63 6c6f 7564  t launch --cloud
+0001b1c0: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
+0001b1d0: 6567 696f 6e7d 202d 6e20 7b6e 616d 657d  egion} -n {name}
+0001b1e0: 2d32 2074 6573 7473 2f74 6573 745f 7961  -2 tests/test_ya
+0001b1f0: 6d6c 732f 7465 7374 5f6c 6f6e 675f 7365  mls/test_long_se
+0001b200: 7475 702e 7961 6d6c 2020 2d79 202d 6427  tup.yaml  -y -d'
+0001b210: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001b220: 6c65 6570 2033 3030 272c 0a20 2020 2020  leep 300',.     
+0001b230: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
+0001b240: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+0001b250: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
+0001b260: 7d2d 3227 292c 0a20 2020 2020 2020 2020  }-2'),.         
+0001b270: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
+0001b280: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+0001b290: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+0001b2a0: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
+0001b2b0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+0001b2c0: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
+0001b2d0: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+0001b2e0: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
+0001b2f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001b300: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+0001b310: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001b320: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
+0001b330: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
+0001b340: 272c 0a20 2020 2020 2020 2020 2020 2028  ',.            (
+0001b350: 6627 733d 2428 6177 7320 6563 3220 6465  f's=$(aws ec2 de
+0001b360: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
+0001b370: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001b380: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+0001b390: 2020 6627 2d2d 6669 6c74 6572 7320 4e61    f'--filters Na
+0001b3a0: 6d65 3d74 6167 3a72 6179 2d63 6c75 7374  me=tag:ray-clust
+0001b3b0: 6572 2d6e 616d 652c 5661 6c75 6573 3d7b  er-name,Values={
+0001b3c0: 6e61 6d65 5f32 5f6f 6e5f 636c 6f75 647d  name_2_on_cloud}
+0001b3d0: 2d2a 2027 0a20 2020 2020 2020 2020 2020  -* '.           
+0001b3e0: 2020 6627 2d2d 7175 6572 7920 5265 7365    f'--query Rese
+0001b3f0: 7276 6174 696f 6e73 5b5d 2e49 6e73 7461  rvations[].Insta
+0001b400: 6e63 6573 5b5d 2e53 7461 7465 5b5d 2e4e  nces[].State[].N
+0001b410: 616d 6520 270a 2020 2020 2020 2020 2020  ame '.          
+0001b420: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
+0001b430: 7429 2026 2620 6563 686f 2022 2473 2220  t) && echo "$s" 
+0001b440: 2626 2065 6368 6f3b 205b 5b20 2d7a 2022  && echo; [[ -z "
+0001b450: 2473 2220 5d5d 207c 7c20 5b5b 2022 2473  $s" ]] || [[ "$s
+0001b460: 2220 3d20 2274 6572 6d69 6e61 7465 6422  " = "terminated"
+0001b470: 205d 5d20 7c7c 205b 5b20 2224 7322 203d   ]] || [[ "$s" =
+0001b480: 2022 7368 7574 7469 6e67 2d64 6f77 6e22   "shutting-down"
+0001b490: 205d 5d27 0a20 2020 2020 2020 2020 2020   ]]'.           
+0001b4a0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0001b4b0: 2320 5465 7374 2063 616e 6365 6c6c 6174  # Test cancellat
+0001b4c0: 696f 6e20 6475 7269 6e67 2073 706f 7420  ion during spot 
+0001b4d0: 6a6f 6220 6973 2072 6563 6f76 6572 696e  job is recoverin
+0001b4e0: 672e 0a20 2020 2020 2020 2020 2020 2066  g..            f
+0001b4f0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+0001b500: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+0001b510: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+0001b520: 6e20 7b6e 616d 657d 2d33 2022 736c 6565  n {name}-3 "slee
+0001b530: 7020 3130 3030 2220 202d 7920 2d64 272c  p 1000"  -y -d',
+0001b540: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001b550: 6565 7020 3330 3027 2c0a 2020 2020 2020  eep 300',.      
+0001b560: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+0001b570: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001b580: 207b 6e61 6d65 7d2d 3320 7c20 6865 6164   {name}-3 | head
+0001b590: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
+0001b5a0: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
+0001b5b0: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
+0001b5c0: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
+0001b5d0: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+0001b5e0: 2020 2866 2761 7773 2065 6332 2074 6572    (f'aws ec2 ter
+0001b5f0: 6d69 6e61 7465 2d69 6e73 7461 6e63 6573  minate-instances
+0001b600: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001b610: 6e7d 202d 2d69 6e73 7461 6e63 652d 6964  n} --instance-id
+0001b620: 7320 2428 270a 2020 2020 2020 2020 2020  s $('.          
+0001b630: 2020 2066 2761 7773 2065 6332 2064 6573     f'aws ec2 des
+0001b640: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
+0001b650: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+0001b660: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+0001b670: 2066 272d 2d66 696c 7465 7273 204e 616d   f'--filters Nam
+0001b680: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
+0001b690: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
+0001b6a0: 616d 655f 335f 6f6e 5f63 6c6f 7564 7d2d  ame_3_on_cloud}-
+0001b6b0: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
+0001b6c0: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
+0001b6d0: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
+0001b6e0: 6365 735b 5d2e 496e 7374 616e 6365 4964  ces[].InstanceId
+0001b6f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001b700: 272d 2d6f 7574 7075 7420 7465 7874 2927  '--output text)'
+0001b710: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
+0001b720: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
+0001b730: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+0001b740: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001b750: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
+0001b760: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001b770: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+0001b780: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
+0001b790: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+0001b7a0: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
+0001b7b0: 6d65 7d2d 3327 292c 0a20 2020 2020 2020  me}-3'),.       
+0001b7c0: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+0001b7d0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001b7e0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+0001b7f0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0001b800: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001b810: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
+0001b820: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+0001b830: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
+0001b840: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
+0001b850: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
+0001b860: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001b870: 657d 2d33 207c 2068 6561 6420 2d6e 3120  e}-3 | head -n1 
+0001b880: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
+0001b890: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
+0001b8a0: 2023 2054 6865 2063 6c75 7374 6572 2073   # The cluster s
+0001b8b0: 686f 756c 6420 6265 2074 6572 6d69 6e61  hould be termina
+0001b8c0: 7465 6420 2873 6875 7474 696e 672d 646f  ted (shutting-do
+0001b8d0: 776e 2920 6166 7465 7220 6361 6e63 656c  wn) after cancel
+0001b8e0: 6c61 7469 6f6e 2e20 5765 2064 6f6e 2774  lation. We don't
+0001b8f0: 2075 7365 2074 6865 2060 3d60 206f 7065   use the `=` ope
+0001b900: 7261 746f 7220 6865 7265 2062 6563 6175  rator here becau
+0001b910: 7365 0a20 2020 2020 2020 2020 2020 2023  se.            #
+0001b920: 2074 6865 7265 2063 616e 2062 6520 6d75   there can be mu
+0001b930: 6c74 6970 6c65 2056 4d20 7769 7468 2074  ltiple VM with t
+0001b940: 6865 2073 616d 6520 6e61 6d65 2064 7565  he same name due
+0001b950: 2074 6f20 7468 6520 7265 636f 7665 7279   to the recovery
+0001b960: 2e0a 2020 2020 2020 2020 2020 2020 2866  ..            (f
+0001b970: 2773 3d24 2861 7773 2065 6332 2064 6573  's=$(aws ec2 des
+0001b980: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
+0001b990: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+0001b9a0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+0001b9b0: 2066 272d 2d66 696c 7465 7273 204e 616d   f'--filters Nam
+0001b9c0: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
+0001b9d0: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
+0001b9e0: 616d 655f 335f 6f6e 5f63 6c6f 7564 7d2d  ame_3_on_cloud}-
+0001b9f0: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
+0001ba00: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
+0001ba10: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
+0001ba20: 6365 735b 5d2e 5374 6174 655b 5d2e 4e61  ces[].State[].Na
+0001ba30: 6d65 2027 0a20 2020 2020 2020 2020 2020  me '.           
+0001ba40: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
+0001ba50: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
+0001ba60: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
+0001ba70: 7322 205d 5d20 7c7c 2065 6368 6f20 2224  s" ]] || echo "$
+0001ba80: 7322 207c 2067 7265 7020 2d76 202d 4520  s" | grep -v -E 
+0001ba90: 2270 656e 6469 6e67 7c72 756e 6e69 6e67  "pending|running
+0001baa0: 7c73 746f 7070 6564 7c73 746f 7070 696e  |stopped|stoppin
+0001bab0: 6722 270a 2020 2020 2020 2020 2020 2020  g"'.            
+0001bac0: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
+0001bad0: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+0001bae0: 202a 2036 3029 0a20 2020 2072 756e 5f6f   * 60).    run_o
+0001baf0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001bb00: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+0001bb10: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+0001bb20: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+0001bb30: 6573 745f 7370 6f74 5f63 616e 6365 6c6c  est_spot_cancell
+0001bb40: 6174 696f 6e5f 6763 7028 293a 0a20 2020  ation_gcp():.   
+0001bb50: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001bb60: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001bb70: 6e61 6d65 5f33 203d 2066 277b 6e61 6d65  name_3 = f'{name
+0001bb80: 7d2d 3327 0a20 2020 206e 616d 655f 335f  }-3'.    name_3_
+0001bb90: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
+0001bba0: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
+0001bbb0: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+0001bbc0: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
+0001bbd0: 5f33 2c20 7370 6f74 2e53 504f 545f 434c  _3, spot.SPOT_CL
+0001bbe0: 5553 5445 525f 4e41 4d45 5f50 5245 4649  USTER_NAME_PREFI
+0001bbf0: 585f 4c45 4e47 5448 2c20 6164 645f 7573  X_LENGTH, add_us
+0001bc00: 6572 5f68 6173 683d 4661 6c73 6529 0a20  er_hash=False). 
+0001bc10: 2020 207a 6f6e 6520 3d20 2775 732d 7765     zone = 'us-we
+0001bc20: 7374 332d 6227 0a20 2020 2071 7565 7279  st3-b'.    query
+0001bc30: 5f73 7461 7465 5f63 6d64 203d 2028 0a20  _state_cmd = (. 
+0001bc40: 2020 2020 2020 2027 6763 6c6f 7564 2063         'gcloud c
+0001bc50: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
+0001bc60: 206c 6973 7420 270a 2020 2020 2020 2020   list '.        
+0001bc70: 6627 2d2d 6669 6c74 6572 3d22 286c 6162  f'--filter="(lab
+0001bc80: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
+0001bc90: 6e61 6d65 3a7b 6e61 6d65 5f33 5f6f 6e5f  name:{name_3_on_
+0001bca0: 636c 6f75 647d 2922 2027 0a20 2020 2020  cloud})" '.     
+0001bcb0: 2020 2027 2d2d 666f 726d 6174 3d22 7661     '--format="va
+0001bcc0: 6c75 6528 7374 6174 7573 2922 2729 0a20  lue(status)"'). 
+0001bcd0: 2020 2071 7565 7279 5f63 6d64 203d 2028     query_cmd = (
+0001bce0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
+0001bcf0: 2069 6e73 7461 6e63 6573 206c 6973 7420   instances list 
+0001bd00: 2d2d 6669 6c74 6572 3d27 0a20 2020 2020  --filter='.     
+0001bd10: 2020 2020 2020 2020 2020 2020 6627 2228              f'"(
+0001bd20: 6c61 6265 6c73 2e72 6179 2d63 6c75 7374  labels.ray-clust
+0001bd30: 6572 2d6e 616d 653a 7b6e 616d 655f 335f  er-name:{name_3_
+0001bd40: 6f6e 5f63 6c6f 7564 7d29 2220 270a 2020  on_cloud})" '.  
+0001bd50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001bd60: 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65 7d20  '--zones={zone} 
+0001bd70: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
+0001bd80: 6e61 6d65 2922 2729 0a20 2020 2074 6572  name)"').    ter
+0001bd90: 6d69 6e61 7465 5f63 6d64 203d 2028 6627  minate_cmd = (f'
+0001bda0: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
+0001bdb0: 6e73 7461 6e63 6573 2064 656c 6574 6520  nstances delete 
+0001bdc0: 2d2d 7a6f 6e65 3d7b 7a6f 6e65 7d27 0a20  --zone={zone}'. 
+0001bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bde0: 2020 2020 6627 202d 2d71 7569 6574 2024      f' --quiet $
+0001bdf0: 287b 7175 6572 795f 636d 647d 2927 290a  ({query_cmd})').
+0001be00: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0001be10: 0a20 2020 2020 2020 2027 7370 6f74 5f63  .        'spot_c
+0001be20: 616e 6365 6c6c 6174 696f 6e5f 6763 7027  ancellation_gcp'
+0001be30: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0001be40: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
+0001be50: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
+0001be60: 6e67 2073 706f 7420 636c 7573 7465 7220  ng spot cluster 
+0001be70: 6265 696e 6720 6c61 756e 6368 6564 2e0a  being launched..
+0001be80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001be90: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
+0001bea0: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
+0001beb0: 207b 7a6f 6e65 7d20 2d6e 207b 6e61 6d65   {zone} -n {name
+0001bec0: 7d20 2273 6c65 6570 2031 3030 3022 2020  } "sleep 1000"  
+0001bed0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+0001bee0: 2020 2020 2773 6c65 6570 2036 3027 2c0a      'sleep 60',.
+0001bef0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001bf00: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+0001bf10: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0001bf20: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+0001bf30: 2253 5441 5254 494e 4722 272c 0a20 2020  "STARTING"',.   
+0001bf40: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
+0001bf50: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+0001bf60: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
+0001bf70: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001bf80: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
+0001bf90: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+0001bfa0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+0001bfb0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+0001bfc0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001bfd0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+0001bfe0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001bff0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
+0001c000: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+0001c010: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001c020: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+0001c030: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
+0001c040: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+0001c050: 2020 2020 2020 2320 5465 7374 2063 616e        # Test can
+0001c060: 6365 6c6c 696e 6720 7468 6520 7370 6f74  celling the spot
+0001c070: 2063 6c75 7374 6572 2064 7572 696e 6720   cluster during 
+0001c080: 7370 6f74 206a 6f62 2062 6569 6e67 2073  spot job being s
+0001c090: 6574 7570 2e0a 2020 2020 2020 2020 2020  etup..          
+0001c0a0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
+0001c0b0: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
+0001c0c0: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
+0001c0d0: 207b 6e61 6d65 7d2d 3220 7465 7374 732f   {name}-2 tests/
+0001c0e0: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
+0001c0f0: 6c6f 6e67 5f73 6574 7570 2e79 616d 6c20  long_setup.yaml 
+0001c100: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+0001c110: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
+0001c120: 2c0a 2020 2020 2020 2020 2020 2020 5f53  ,.            _S
+0001c130: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+0001c140: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+0001c150: 6627 7b6e 616d 657d 2d32 2729 2c0a 2020  f'{name}-2'),.  
+0001c160: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001c170: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
+0001c180: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
+0001c190: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001c1a0: 657d 2d32 207c 2068 6561 6420 2d6e 3120  e}-2 | head -n1 
+0001c1b0: 7c20 6772 6570 2022 4341 4e43 454c 4c49  | grep "CANCELLI
+0001c1c0: 4e47 5c7c 4341 4e43 454c 4c45 4422 272c  NG\|CANCELLED"',
+0001c1d0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001c1e0: 6565 7020 3132 3027 2c0a 2020 2020 2020  eep 120',.      
+0001c1f0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+0001c200: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001c210: 207b 6e61 6d65 7d2d 3220 7c20 6865 6164   {name}-2 | head
+0001c220: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
+0001c230: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+0001c240: 2020 2020 2020 2320 5465 7374 2063 616e        # Test can
+0001c250: 6365 6c6c 6174 696f 6e20 6475 7269 6e67  cellation during
+0001c260: 2073 706f 7420 6a6f 6220 6973 2072 6563   spot job is rec
+0001c270: 6f76 6572 696e 672e 0a20 2020 2020 2020  overing..       
+0001c280: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+0001c290: 6c61 756e 6368 202d 2d63 6c6f 7564 2067  launch --cloud g
+0001c2a0: 6370 202d 2d7a 6f6e 6520 7b7a 6f6e 657d  cp --zone {zone}
+0001c2b0: 202d 6e20 7b6e 616d 657d 2d33 2022 736c   -n {name}-3 "sl
+0001c2c0: 6565 7020 3130 3030 2220 202d 7920 2d64  eep 1000"  -y -d
+0001c2d0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001c2e0: 736c 6565 7020 3330 3027 2c0a 2020 2020  sleep 300',.    
+0001c2f0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+0001c300: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001c310: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
+0001c320: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001c330: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+0001c340: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
+0001c350: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
+0001c360: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
+0001c370: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
+0001c380: 642c 0a20 2020 2020 2020 2020 2020 2027  d,.            '
+0001c390: 736c 6565 7020 3830 272c 0a20 2020 2020  sleep 80',.     
+0001c3a0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+0001c3b0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001c3c0: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
+0001c3d0: 6420 2d6e 3120 7c20 6772 6570 2022 5245  d -n1 | grep "RE
+0001c3e0: 434f 5645 5249 4e47 2227 2c0a 2020 2020  COVERING"',.    
+0001c3f0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+0001c400: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+0001c410: 286a 6f62 5f6e 616d 653d 6627 7b6e 616d  (job_name=f'{nam
+0001c420: 657d 2d33 2729 2c0a 2020 2020 2020 2020  e}-3'),.        
+0001c430: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+0001c440: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+0001c450: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+0001c460: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0001c470: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001c480: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+0001c490: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001c4a0: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
+0001c4b0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001c4c0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+0001c4d0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001c4e0: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
+0001c4f0: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
+0001c500: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001c510: 2320 5468 6520 636c 7573 7465 7220 7368  # The cluster sh
+0001c520: 6f75 6c64 2062 6520 7465 726d 696e 6174  ould be terminat
+0001c530: 6564 2028 5354 4f50 5049 4e47 2920 6166  ed (STOPPING) af
+0001c540: 7465 7220 6361 6e63 656c 6c61 7469 6f6e  ter cancellation
+0001c550: 2e20 5765 2064 6f6e 2774 2075 7365 2074  . We don't use t
+0001c560: 6865 2060 3d60 206f 7065 7261 746f 7220  he `=` operator 
+0001c570: 6865 7265 2062 6563 6175 7365 0a20 2020  here because.   
+0001c580: 2020 2020 2020 2020 2023 2074 6865 7265           # there
+0001c590: 2063 616e 2062 6520 6d75 6c74 6970 6c65   can be multiple
+0001c5a0: 2056 4d20 7769 7468 2074 6865 2073 616d   VM with the sam
+0001c5b0: 6520 6e61 6d65 2064 7565 2074 6f20 7468  e name due to th
+0001c5c0: 6520 7265 636f 7665 7279 2e0a 2020 2020  e recovery..    
+0001c5d0: 2020 2020 2020 2020 2866 2773 3d24 287b          (f's=$({
+0001c5e0: 7175 6572 795f 7374 6174 655f 636d 647d  query_state_cmd}
+0001c5f0: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
+0001c600: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
+0001c610: 7322 205d 5d20 7c7c 2065 6368 6f20 2224  s" ]] || echo "$
+0001c620: 7322 207c 2067 7265 7020 2d76 202d 4520  s" | grep -v -E 
+0001c630: 2250 524f 5649 5349 4f4e 494e 477c 5354  "PROVISIONING|ST
+0001c640: 4147 494e 477c 5255 4e4e 494e 477c 5245  AGING|RUNNING|RE
+0001c650: 5041 4952 494e 477c 5445 524d 494e 4154  PAIRING|TERMINAT
+0001c660: 4544 7c53 5553 5045 4e44 494e 477c 5355  ED|SUSPENDING|SU
+0001c670: 5350 454e 4445 447c 5355 5350 454e 4445  SPENDED|SUSPENDE
+0001c680: 4422 270a 2020 2020 2020 2020 2020 2020  D"'.            
+0001c690: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
+0001c6a0: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+0001c6b0: 202a 2036 3029 0a20 2020 2072 756e 5f6f   * 60).    run_o
+0001c6c0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001c6d0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+0001c6e0: 7469 6e67 2073 746f 7261 6765 2066 6f72  ting storage for
+0001c6f0: 206d 616e 6167 6564 2073 706f 7420 2d2d   managed spot --
+0001c700: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+0001c710: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+0001c720: 6163 6b20 2023 2046 6c75 6964 7374 6163  ack  # Fluidstac
+0001c730: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
+0001c740: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+0001c750: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+0001c760: 6f5f 617a 7572 6520 2023 2041 7a75 7265  o_azure  # Azure
+0001c770: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+0001c780: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+0001c790: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0001c7a0: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
+0001c7b0: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
+0001c7c0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+0001c7d0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+0001c7e0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
+0001c7f0: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
+0001c800: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001c810: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+0001c820: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
+0001c830: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
+0001c840: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
+0001c850: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+0001c860: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+0001c870: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+0001c880: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+0001c890: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+0001c8a0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+0001c8b0: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
+0001c8c0: 204b 7562 6572 6e65 7465 7320 646f 6573   Kubernetes does
+0001c8d0: 206e 6f74 2068 6176 6520 6120 6e6f 7469   not have a noti
+0001c8e0: 6f6e 206f 6620 7370 6f74 2069 6e73 7461  on of spot insta
+0001c8f0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+0001c900: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
+0001c910: 6566 2074 6573 745f 7370 6f74 5f73 746f  ef test_spot_sto
+0001c920: 7261 6765 2867 656e 6572 6963 5f63 6c6f  rage(generic_clo
+0001c930: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+0001c940: 2254 6573 7420 7374 6f72 6167 6520 7769  "Test storage wi
+0001c950: 7468 206d 616e 6167 6564 2073 706f 7422  th managed spot"
+0001c960: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+0001c970: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0001c980: 290a 2020 2020 7961 6d6c 5f73 7472 203d  ).    yaml_str =
+0001c990: 2070 6174 686c 6962 2e50 6174 6828 0a20   pathlib.Path(. 
+0001c9a0: 2020 2020 2020 2027 6578 616d 706c 6573         'examples
+0001c9b0: 2f6d 616e 6167 6564 5f73 706f 745f 7769  /managed_spot_wi
+0001c9c0: 7468 5f73 746f 7261 6765 2e79 616d 6c27  th_storage.yaml'
+0001c9d0: 292e 7265 6164 5f74 6578 7428 290a 2020  ).read_text().  
+0001c9e0: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
+0001c9f0: 2066 2773 6b79 2d74 6573 742d 7b69 6e74   f'sky-test-{int
+0001ca00: 2874 696d 652e 7469 6d65 2829 297d 270a  (time.time())}'.
+0001ca10: 0a20 2020 2023 2041 6c73 6f20 7065 7266  .    # Also perf
+0001ca20: 6f72 6d20 7265 6769 6f6e 2074 6573 7469  orm region testi
+0001ca30: 6e67 2066 6f72 2062 7563 6b65 7420 6372  ng for bucket cr
+0001ca40: 6561 7469 6f6e 2074 6f20 7661 6c69 6461  eation to valida
+0001ca50: 7465 2069 6620 6275 636b 6574 7320 6172  te if buckets ar
+0001ca60: 650a 2020 2020 2320 6372 6561 7465 6420  e.    # created 
+0001ca70: 696e 2074 6865 2063 6f72 7265 6374 2072  in the correct r
+0001ca80: 6567 696f 6e20 616e 6420 636f 7272 6563  egion and correc
+0001ca90: 746c 7920 6d6f 756e 7465 6420 696e 2073  tly mounted in s
+0001caa0: 706f 7420 6a6f 6273 2e0a 2020 2020 2320  pot jobs..    # 
+0001cab0: 486f 7765 7665 722c 2077 6520 696e 6a65  However, we inje
+0001cac0: 6374 2074 6869 7320 7465 7374 696e 6720  ct this testing 
+0001cad0: 6f6e 6c79 2066 6f72 2041 5753 2061 6e64  only for AWS and
+0001cae0: 2047 4350 2073 696e 6365 2074 6865 7920   GCP since they 
+0001caf0: 6172 6520 7468 650a 2020 2020 2320 7375  are the.    # su
+0001cb00: 7070 6f72 7465 6420 6f62 6a65 6374 2073  pported object s
+0001cb10: 746f 7261 6765 2070 726f 7669 6465 7273  torage providers
+0001cb20: 2069 6e20 536b 7950 696c 6f74 2e0a 2020   in SkyPilot..  
+0001cb30: 2020 7265 6769 6f6e 5f66 6c61 6720 3d20    region_flag = 
+0001cb40: 2727 0a20 2020 2072 6567 696f 6e5f 7661  ''.    region_va
+0001cb50: 6c69 6461 7469 6f6e 5f63 6d64 203d 2027  lidation_cmd = '
+0001cb60: 7472 7565 270a 2020 2020 6966 2067 656e  true'.    if gen
+0001cb70: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
+0001cb80: 7773 273a 0a20 2020 2020 2020 2072 6567  ws':.        reg
+0001cb90: 696f 6e20 3d20 2765 752d 6365 6e74 7261  ion = 'eu-centra
+0001cba0: 6c2d 3127 0a20 2020 2020 2020 2072 6567  l-1'.        reg
+0001cbb0: 696f 6e5f 666c 6167 203d 2066 2720 2d2d  ion_flag = f' --
+0001cbc0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d27  region {region}'
+0001cbd0: 0a20 2020 2020 2020 2072 6567 696f 6e5f  .        region_
+0001cbe0: 636d 6420 3d20 5465 7374 5374 6f72 6167  cmd = TestStorag
+0001cbf0: 6557 6974 6843 7265 6465 6e74 6961 6c73  eWithCredentials
+0001cc00: 2e63 6c69 5f72 6567 696f 6e5f 636d 6428  .cli_region_cmd(
+0001cc10: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0001cc20: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0001cc30: 7065 2e53 332c 2073 746f 7261 6765 5f6e  pe.S3, storage_n
+0001cc40: 616d 6529 0a20 2020 2020 2020 2072 6567  ame).        reg
+0001cc50: 696f 6e5f 7661 6c69 6461 7469 6f6e 5f63  ion_validation_c
+0001cc60: 6d64 203d 2066 277b 7265 6769 6f6e 5f63  md = f'{region_c
+0001cc70: 6d64 7d20 7c20 6772 6570 207b 7265 6769  md} | grep {regi
+0001cc80: 6f6e 7d27 0a20 2020 2065 6c69 6620 6765  on}'.    elif ge
+0001cc90: 6e65 7269 635f 636c 6f75 6420 3d3d 2027  neric_cloud == '
+0001cca0: 6763 7027 3a0a 2020 2020 2020 2020 7265  gcp':.        re
+0001ccb0: 6769 6f6e 203d 2027 7573 2d77 6573 7432  gion = 'us-west2
+0001ccc0: 270a 2020 2020 2020 2020 7265 6769 6f6e  '.        region
+0001ccd0: 5f66 6c61 6720 3d20 6627 202d 2d72 6567  _flag = f' --reg
+0001cce0: 696f 6e20 7b72 6567 696f 6e7d 270a 2020  ion {region}'.  
+0001ccf0: 2020 2020 2020 7265 6769 6f6e 5f63 6d64        region_cmd
+0001cd00: 203d 2054 6573 7453 746f 7261 6765 5769   = TestStorageWi
+0001cd10: 7468 4372 6564 656e 7469 616c 732e 636c  thCredentials.cl
+0001cd20: 695f 7265 6769 6f6e 5f63 6d64 280a 2020  i_region_cmd(.  
+0001cd30: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0001cd40: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0001cd50: 4743 532c 2073 746f 7261 6765 5f6e 616d  GCS, storage_nam
+0001cd60: 6529 0a20 2020 2020 2020 2072 6567 696f  e).        regio
+0001cd70: 6e5f 7661 6c69 6461 7469 6f6e 5f63 6d64  n_validation_cmd
+0001cd80: 203d 2066 277b 7265 6769 6f6e 5f63 6d64   = f'{region_cmd
+0001cd90: 7d20 7c20 6772 6570 207b 7265 6769 6f6e  } | grep {region
+0001cda0: 7d27 0a0a 2020 2020 7961 6d6c 5f73 7472  }'..    yaml_str
+0001cdb0: 203d 2079 616d 6c5f 7374 722e 7265 706c   = yaml_str.repl
+0001cdc0: 6163 6528 2773 6b79 2d77 6f72 6b64 6972  ace('sky-workdir
+0001cdd0: 2d7a 6877 7527 2c20 7374 6f72 6167 655f  -zhwu', storage_
+0001cde0: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
+0001cdf0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
+0001ce00: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
+0001ce10: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
+0001ce20: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
+0001ce30: 2020 2066 2e77 7269 7465 2879 616d 6c5f     f.write(yaml_
+0001ce40: 7374 7229 0a20 2020 2020 2020 2066 2e66  str).        f.f
+0001ce50: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
+0001ce60: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
+0001ce70: 650a 2020 2020 2020 2020 7465 7374 203d  e.        test =
+0001ce80: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+0001ce90: 2020 2027 7370 6f74 5f73 746f 7261 6765     'spot_storage
+0001cea0: 272c 0a20 2020 2020 2020 2020 2020 205b  ',.            [
+0001ceb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cec0: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
+0001ced0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+0001cee0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001cef0: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
+0001cf00: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+0001cf10: 656e 6572 6963 5f63 6c6f 7564 7d7b 7265  eneric_cloud}{re
+0001cf20: 6769 6f6e 5f66 6c61 677d 207b 6669 6c65  gion_flag} {file
+0001cf30: 5f70 6174 687d 202d 7927 2c0a 2020 2020  _path} -y',.    
+0001cf40: 2020 2020 2020 2020 2020 2020 7265 6769              regi
+0001cf50: 6f6e 5f76 616c 6964 6174 696f 6e5f 636d  on_validation_cm
+0001cf60: 642c 2020 2320 4368 6563 6b20 6966 2074  d,  # Check if t
+0001cf70: 6865 2062 7563 6b65 7420 6973 2063 7265  he bucket is cre
+0001cf80: 6174 6564 2069 6e20 7468 6520 636f 7272  ated in the corr
+0001cf90: 6563 7420 7265 6769 6f6e 0a20 2020 2020  ect region.     
+0001cfa0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001cfb0: 7020 3630 272c 2020 2320 5761 6974 2074  p 60',  # Wait t
+0001cfc0: 6865 2073 706f 7420 7175 6575 6520 746f  he spot queue to
+0001cfd0: 2062 6520 7570 6461 7465 640a 2020 2020   be updated.    
+0001cfe0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001cff0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+0001d000: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0001d010: 6772 6570 2053 5543 4345 4544 4544 272c  grep SUCCEEDED',
+0001d020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d030: 2066 275b 2024 2861 7773 2073 3361 7069   f'[ $(aws s3api
+0001d040: 206c 6973 742d 6275 636b 6574 7320 2d2d   list-buckets --
+0001d050: 7175 6572 7920 2242 7563 6b65 7473 5b3f  query "Buckets[?
+0001d060: 636f 6e74 6169 6e73 284e 616d 652c 205c  contains(Name, \
+0001d070: 277b 7374 6f72 6167 655f 6e61 6d65 7d5c  '{storage_name}\
+0001d080: 2729 5d2e 4e61 6d65 2220 2d2d 6f75 7470  ')].Name" --outp
+0001d090: 7574 2074 6578 7420 7c20 7763 202d 6c29  ut text | wc -l)
+0001d0a0: 202d 6571 2030 205d 270a 2020 2020 2020   -eq 0 ]'.      
+0001d0b0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0001d0c0: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+0001d0d0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001d0e0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001d0f0: 2020 2020 2020 2020 2020 2320 496e 6372            # Incr
+0001d100: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
+0001d110: 6365 2073 6b79 2073 706f 7420 7175 6575  ce sky spot queu
+0001d120: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
+0001d130: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
+0001d140: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
+0001d150: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+0001d160: 2a20 3630 2c0a 2020 2020 2020 2020 290a  * 60,.        ).
+0001d170: 2020 2020 2020 2020 7275 6e5f 6f6e 655f          run_one_
+0001d180: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+0001d190: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
+0001d1a0: 6720 7370 6f74 2054 5055 202d 2d2d 2d2d  g spot TPU -----
+0001d1b0: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+0001d1c0: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
+0001d1d0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
+0001d1e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7470  .@pytest.mark.tp
+0001d1f0: 750a 6465 6620 7465 7374 5f73 706f 745f  u.def test_spot_
+0001d200: 7470 7528 293a 0a20 2020 2022 2222 5465  tpu():.    """Te
+0001d210: 7374 206d 616e 6167 6564 2073 706f 7420  st managed spot 
+0001d220: 6f6e 2054 5055 2e22 2222 0a20 2020 206e  on TPU.""".    n
+0001d230: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0001d240: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+0001d250: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0001d260: 2020 2027 7465 7374 2d73 706f 742d 7470     'test-spot-tp
+0001d270: 7527 2c0a 2020 2020 2020 2020 5b0a 2020  u',.        [.  
+0001d280: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001d290: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
+0001d2a0: 6e61 6d65 7d20 6578 616d 706c 6573 2f74  name} examples/t
+0001d2b0: 7075 2f74 7075 766d 5f6d 6e69 7374 2e79  pu/tpuvm_mnist.y
+0001d2c0: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
+0001d2d0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0001d2e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001d2f0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+0001d300: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001d310: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001d320: 6570 2053 5441 5254 494e 4727 2c0a 2020  ep STARTING',.  
+0001d330: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001d340: 2038 3430 272c 2020 2320 5450 5520 7461   840',  # TPU ta
+0001d350: 6b65 7320 6120 7768 696c 6520 746f 206c  kes a while to l
+0001d360: 6175 6e63 680a 2020 2020 2020 2020 2020  aunch.          
+0001d370: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+0001d380: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001d390: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001d3a0: 2067 7265 7020 2252 554e 4e49 4e47 5c7c   grep "RUNNING\|
+0001d3b0: 5355 4343 4545 4445 4422 272c 0a20 2020  SUCCEEDED"',.   
+0001d3c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001d3d0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+0001d3e0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+0001d3f0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+0001d400: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
+0001d410: 6f75 7420 7369 6e63 6520 736b 7920 7370  out since sky sp
+0001d420: 6f74 2071 7565 7565 202d 7220 6361 6e20  ot queue -r can 
+0001d430: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
+0001d440: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
+0001d450: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0001d460: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
+0001d470: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0001d480: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0001d490: 2d2d 2d2d 2054 6573 7469 6e67 2065 6e76  ---- Testing env
+0001d4a0: 2066 6f72 2073 706f 7420 2d2d 2d2d 2d2d   for spot ------
+0001d4b0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+0001d4c0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
+0001d4d0: 2023 2046 6c75 6964 7374 6163 6b20 646f   # Fluidstack do
+0001d4e0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+0001d4f0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+0001d500: 7974 6573 742e 6d61 726b 2e6e 6f5f 617a  ytest.mark.no_az
+0001d510: 7572 6520 2023 2041 7a75 7265 2064 6f65  ure  # Azure doe
+0001d520: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+0001d530: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+0001d540: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+0001d550: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+0001d560: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+0001d570: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+0001d580: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+0001d590: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+0001d5a0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+0001d5b0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+0001d5c0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+0001d5d0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+0001d5e0: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+0001d5f0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+0001d600: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+0001d610: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+0001d620: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
+0001d630: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001d640: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+0001d650: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
+0001d660: 7562 6572 6e65 7465 7320 2023 204b 7562  ubernetes  # Kub
+0001d670: 6572 6e65 7465 7320 646f 6573 206e 6f74  ernetes does not
+0001d680: 2068 6176 6520 6120 6e6f 7469 6f6e 206f   have a notion o
+0001d690: 6620 7370 6f74 2069 6e73 7461 6e63 6573  f spot instances
+0001d6a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+0001d6b0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+0001d6c0: 6573 745f 7370 6f74 5f69 6e6c 696e 655f  est_spot_inline_
+0001d6d0: 656e 7628 6765 6e65 7269 635f 636c 6f75  env(generic_clou
+0001d6e0: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+0001d6f0: 5465 7374 2073 706f 7420 656e 7622 2222  Test spot env"""
+0001d700: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0001d710: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0001d720: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0001d730: 0a20 2020 2020 2020 2027 7465 7374 2d73  .        'test-s
+0001d740: 706f 742d 696e 6c69 6e65 2d65 6e76 272c  pot-inline-env',
+0001d750: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001d760: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+0001d770: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
+0001d780: 657d 202d 7920 2d2d 636c 6f75 6420 7b67  e} -y --cloud {g
+0001d790: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+0001d7a0: 656e 7620 5445 5354 5f45 4e56 3d22 6865  env TEST_ENV="he
+0001d7b0: 6c6c 6f20 776f 726c 6422 202d 2d20 2228  llo world" -- "(
+0001d7c0: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
+0001d7d0: 545f 454e 565c 5c22 205d 5d20 2626 205b  T_ENV\\" ]] && [
+0001d7e0: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
+0001d7f0: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
+0001d800: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
+0001d810: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
+0001d820: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
+0001d830: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+0001d840: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+0001d850: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001d860: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+0001d870: 4954 7d20 7c20 6772 6570 207b 6e61 6d65  IT} | grep {name
+0001d880: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
+0001d890: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
+0001d8a0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+0001d8b0: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+0001d8c0: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
+0001d8d0: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
+0001d8e0: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
+0001d8f0: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
+0001d900: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
+0001d910: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
+0001d920: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
+0001d930: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+0001d940: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0001d950: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001d960: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+0001d970: 7469 6e67 2065 6e76 202d 2d2d 2d2d 2d2d  ting env -------
+0001d980: 2d2d 2d0a 6465 6620 7465 7374 5f69 6e6c  ---.def test_inl
+0001d990: 696e 655f 656e 7628 6765 6e65 7269 635f  ine_env(generic_
+0001d9a0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+0001d9b0: 2022 2222 5465 7374 2065 6e76 2222 220a   """Test env""".
+0001d9c0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001d9d0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0001d9e0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001d9f0: 2020 2020 2020 2020 2774 6573 742d 696e          'test-in
+0001da00: 6c69 6e65 2d65 6e76 272c 0a20 2020 2020  line-env',.     
+0001da10: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0001da20: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
+0001da30: 207b 6e61 6d65 7d20 2d79 202d 2d63 6c6f   {name} -y --clo
+0001da40: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+0001da50: 647d 202d 2d65 6e76 2054 4553 545f 454e  d} --env TEST_EN
+0001da60: 563d 2268 656c 6c6f 2077 6f72 6c64 2220  V="hello world" 
+0001da70: 2d2d 2022 285b 5b20 2120 2d7a 205c 5c22  -- "([[ ! -z \\"
+0001da80: 5c24 5445 5354 5f45 4e56 5c5c 2220 5d5d  \$TEST_ENV\\" ]]
+0001da90: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+0001daa0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f49  $SKYPILOT_NODE_I
+0001dab0: 5053 5c5c 2220 5d5d 2026 2620 5b5b 2021  PS\\" ]] && [[ !
+0001dac0: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+0001dad0: 545f 4e4f 4445 5f52 414e 4b5c 5c22 205d  T_NODE_RANK\\" ]
+0001dae0: 5d29 207c 7c20 6578 6974 2031 2227 2c0a  ]) || exit 1"',.
+0001daf0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001db00: 6570 2032 3027 2c0a 2020 2020 2020 2020  ep 20',.        
+0001db10: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0001db20: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0001db30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001db40: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0001db50: 202d 2d65 6e76 2054 4553 545f 454e 5632   --env TEST_ENV2
+0001db60: 3d22 7375 6363 6573 7322 2022 285b 5b20  ="success" "([[ 
+0001db70: 2120 2d7a 205c 5c22 5c24 5445 5354 5f45  ! -z \\"\$TEST_E
+0001db80: 4e56 325c 5c22 205d 5d20 2626 205b 5b20  NV2\\" ]] && [[ 
+0001db90: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+0001dba0: 4f54 5f4e 4f44 455f 4950 535c 5c22 205d  OT_NODE_IPS\\" ]
+0001dbb0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+0001dbc0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+0001dbd0: 5241 4e4b 5c5c 2220 5d5d 2920 7c7c 2065  RANK\\" ]]) || e
+0001dbe0: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
+0001dbf0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0001dc00: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+0001dc10: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
+0001dc20: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0001dc30: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0001dc40: 2020 2020 2020 5f67 6574 5f74 696d 656f        _get_timeo
+0001dc50: 7574 2867 656e 6572 6963 5f63 6c6f 7564  ut(generic_cloud
+0001dc60: 292c 0a20 2020 2029 0a20 2020 2072 756e  ),.    ).    run
+0001dc70: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0001dc80: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+0001dc90: 6573 7469 6e67 2065 6e76 2066 696c 6520  esting env file 
+0001dca0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a64 6566 2074  ----------.def t
+0001dcb0: 6573 745f 696e 6c69 6e65 5f65 6e76 5f66  est_inline_env_f
+0001dcc0: 696c 6528 6765 6e65 7269 635f 636c 6f75  ile(generic_clou
+0001dcd0: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+0001dce0: 5465 7374 2065 6e76 2222 220a 2020 2020  Test env""".    
+0001dcf0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0001dd00: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0001dd10: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0001dd20: 2020 2020 2774 6573 742d 696e 6c69 6e65      'test-inline
+0001dd30: 2d65 6e76 2d66 696c 6527 2c0a 2020 2020  -env-file',.    
+0001dd40: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001dd50: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0001dd60: 6320 7b6e 616d 657d 202d 7920 2d2d 636c  c {name} -y --cl
+0001dd70: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+0001dd80: 7564 7d20 2d2d 656e 7620 5445 5354 5f45  ud} --env TEST_E
+0001dd90: 4e56 3d22 6865 6c6c 6f20 776f 726c 6422  NV="hello world"
+0001dda0: 202d 2d20 2228 5b5b 2021 202d 7a20 5c5c   -- "([[ ! -z \\
+0001ddb0: 225c 2454 4553 545f 454e 565c 5c22 205d  "\$TEST_ENV\\" ]
+0001ddc0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+0001ddd0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+0001dde0: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
+0001ddf0: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+0001de00: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
+0001de10: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
+0001de20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001de30: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0001de40: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0001de50: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0001de60: 6563 207b 6e61 6d65 7d20 2d2d 656e 762d  ec {name} --env-
+0001de70: 6669 6c65 2065 7861 6d70 6c65 732f 7361  file examples/sa
+0001de80: 6d70 6c65 5f64 6f74 656e 7620 2228 5b5b  mple_dotenv "([[
+0001de90: 2021 202d 7a20 5c5c 225c 2454 4553 545f   ! -z \\"\$TEST_
+0001dea0: 454e 5632 5c5c 2220 5d5d 2026 2620 5b5b  ENV2\\" ]] && [[
+0001deb0: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
+0001dec0: 4c4f 545f 4e4f 4445 5f49 5053 5c5c 2220  LOT_NODE_IPS\\" 
+0001ded0: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
+0001dee0: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
+0001def0: 5f52 414e 4b5c 5c22 205d 5d29 207c 7c20  _RANK\\" ]]) || 
+0001df00: 6578 6974 2031 2227 2c0a 2020 2020 2020  exit 1"',.      
+0001df10: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0001df20: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+0001df30: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
+0001df40: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0001df50: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0001df60: 2020 2020 2020 205f 6765 745f 7469 6d65         _get_time
+0001df70: 6f75 7428 6765 6e65 7269 635f 636c 6f75  out(generic_clou
+0001df80: 6429 2c0a 2020 2020 290a 2020 2020 7275  d),.    ).    ru
+0001df90: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0001dfa0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+0001dfb0: 5465 7374 696e 6720 6375 7374 6f6d 2069  Testing custom i
+0001dfc0: 6d61 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a  mage ----------.
+0001dfd0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+0001dfe0: 0a64 6566 2074 6573 745f 6177 735f 6375  .def test_aws_cu
+0001dff0: 7374 6f6d 5f69 6d61 6765 2829 3a0a 2020  stom_image():.  
+0001e000: 2020 2222 2254 6573 7420 4157 5320 6375    """Test AWS cu
+0001e010: 7374 6f6d 2069 6d61 6765 2222 220a 2020  stom image""".  
+0001e020: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0001e030: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0001e040: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0001e050: 2020 2020 2020 2774 6573 742d 6177 732d        'test-aws-
+0001e060: 6375 7374 6f6d 2d69 6d61 6765 272c 0a20  custom-image',. 
+0001e070: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0001e080: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0001e090: 6820 2d63 207b 6e61 6d65 7d20 2d2d 7265  h -c {name} --re
+0001e0a0: 7472 792d 756e 7469 6c2d 7570 202d 7920  try-until-up -y 
+0001e0b0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+0001e0c0: 2f74 6573 745f 6375 7374 6f6d 5f69 6d61  /test_custom_ima
+0001e0d0: 6765 2e79 616d 6c20 2d2d 636c 6f75 6420  ge.yaml --cloud 
+0001e0e0: 6177 7320 2d2d 7265 6769 6f6e 2075 732d  aws --region us-
+0001e0f0: 6561 7374 2d32 202d 2d69 6d61 6765 2d69  east-2 --image-i
+0001e100: 6420 616d 692d 3036 3264 6464 3930 6662  d ami-062ddd90fb
+0001e110: 3666 3832 3637 6127 2c20 2023 204e 7669  6f8267a',  # Nvi
+0001e120: 6469 6120 696d 6167 650a 2020 2020 2020  dia image.      
+0001e130: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0001e140: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+0001e150: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
+0001e160: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0001e170: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0001e180: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
+0001e190: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+0001e1a0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001e1b0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0001e1c0: 6172 6b2e 6b75 6265 726e 6574 6573 0a40  ark.kubernetes.@
+0001e1d0: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+0001e1e0: 6d65 7472 697a 6528 0a20 2020 2022 696d  metrize(.    "im
+0001e1f0: 6167 655f 6964 222c 0a20 2020 205b 0a20  age_id",.    [. 
+0001e200: 2020 2020 2020 2022 646f 636b 6572 3a6e         "docker:n
+0001e210: 7669 6469 612f 6375 6461 3a31 312e 382e  vidia/cuda:11.8.
+0001e220: 302d 6465 7665 6c2d 7562 756e 7475 3138  0-devel-ubuntu18
+0001e230: 2e30 3422 2c0a 2020 2020 2020 2020 2264  .04",.        "d
+0001e240: 6f63 6b65 723a 7562 756e 7475 3a31 382e  ocker:ubuntu:18.
+0001e250: 3034 222c 0a20 2020 2020 2020 2023 2054  04",.        # T
+0001e260: 6573 7420 696d 6167 6520 7769 7468 2070  est image with p
+0001e270: 7974 686f 6e20 332e 3131 2069 6e73 7461  ython 3.11 insta
+0001e280: 6c6c 6564 2062 7920 6465 6661 756c 742e  lled by default.
+0001e290: 0a20 2020 2020 2020 2022 646f 636b 6572  .        "docker
+0001e2a0: 3a63 6f6e 7469 6e75 756d 696f 2f6d 696e  :continuumio/min
+0001e2b0: 6963 6f6e 6461 3322 2c0a 2020 2020 5d29  iconda3",.    ])
+0001e2c0: 0a64 6566 2074 6573 745f 6b75 6265 726e  .def test_kubern
+0001e2d0: 6574 6573 5f63 7573 746f 6d5f 696d 6167  etes_custom_imag
+0001e2e0: 6528 696d 6167 655f 6964 293a 0a20 2020  e(image_id):.   
+0001e2f0: 2022 2222 5465 7374 204b 7562 6572 6e65   """Test Kuberne
+0001e300: 7465 7320 6375 7374 6f6d 2069 6d61 6765  tes custom image
+0001e310: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+0001e320: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0001e330: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0001e340: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
+0001e350: 742d 6b75 6265 726e 6574 6573 2d63 7573  t-kubernetes-cus
+0001e360: 746f 6d2d 696d 6167 6527 2c0a 2020 2020  tom-image',.    
+0001e370: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001e380: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0001e390: 6320 7b6e 616d 657d 202d 2d72 6574 7279  c {name} --retry
+0001e3a0: 2d75 6e74 696c 2d75 7020 2d79 2074 6573  -until-up -y tes
+0001e3b0: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
+0001e3c0: 7374 5f63 7573 746f 6d5f 696d 6167 652e  st_custom_image.
+0001e3d0: 7961 6d6c 202d 2d63 6c6f 7564 206b 7562  yaml --cloud kub
+0001e3e0: 6572 6e65 7465 7320 2d2d 696d 6167 652d  ernetes --image-
+0001e3f0: 6964 207b 696d 6167 655f 6964 7d20 2d2d  id {image_id} --
+0001e400: 7265 6769 6f6e 204e 6f6e 6520 2d2d 6770  region None --gp
+0001e410: 7573 2054 343a 3127 2c0a 2020 2020 2020  us T4:1',.      
+0001e420: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0001e430: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+0001e440: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+0001e450: 2023 2054 7279 2065 7865 6320 746f 2072   # Try exec to r
+0001e460: 756e 2061 6761 696e 2061 6e64 2063 6865  un again and che
+0001e470: 636b 2069 6620 7468 6520 6c6f 6773 2061  ck if the logs a
+0001e480: 7265 2070 7269 6e74 6564 0a20 2020 2020  re printed.     
+0001e490: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0001e4a0: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
+0001e4b0: 6573 745f 7961 6d6c 732f 7465 7374 5f63  est_yamls/test_c
+0001e4c0: 7573 746f 6d5f 696d 6167 652e 7961 6d6c  ustom_image.yaml
+0001e4d0: 202d 2d63 6c6f 7564 206b 7562 6572 6e65   --cloud kuberne
+0001e4e0: 7465 7320 2d2d 696d 6167 652d 6964 207b  tes --image-id {
+0001e4f0: 696d 6167 655f 6964 7d20 2d2d 7265 6769  image_id} --regi
+0001e500: 6f6e 204e 6f6e 6520 2d2d 6770 7573 2054  on None --gpus T
+0001e510: 343a 3120 7c20 6772 6570 2022 4865 6c6c  4:1 | grep "Hell
+0001e520: 6f20 3130 3022 272c 0a20 2020 2020 2020  o 100"',.       
+0001e530: 2020 2020 2023 204d 616b 6520 7375 7265       # Make sure
+0001e540: 2073 7368 2069 7320 776f 726b 696e 6720   ssh is working 
+0001e550: 7769 7468 2063 7573 746f 6d20 7573 6572  with custom user
+0001e560: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
+0001e570: 2066 2773 7368 207b 6e61 6d65 7d20 6563   f'ssh {name} ec
+0001e580: 686f 2068 6920 7c20 6772 6570 2068 6927  ho hi | grep hi'
+0001e590: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0001e5a0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0001e5b0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0001e5c0: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
+0001e5d0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0001e5e0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001e5f0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0001e600: 2e73 6c6f 770a 6465 6620 7465 7374 5f61  .slow.def test_a
+0001e610: 7a75 7265 5f73 7461 7274 5f73 746f 705f  zure_start_stop_
+0001e620: 7477 6f5f 6e6f 6465 7328 293a 0a20 2020  two_nodes():.   
+0001e630: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001e640: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001e650: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001e660: 2020 2020 2027 617a 7572 652d 7374 6172       'azure-star
+0001e670: 742d 7374 6f70 2d74 776f 2d6e 6f64 6573  t-stop-two-nodes
+0001e680: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0001e690: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0001e6a0: 6175 6e63 6820 2d2d 6e75 6d2d 6e6f 6465  aunch --num-node
+0001e6b0: 733d 3220 2d79 202d 6320 7b6e 616d 657d  s=2 -y -c {name}
+0001e6c0: 2065 7861 6d70 6c65 732f 617a 7572 655f   examples/azure_
+0001e6d0: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
+0001e6e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001e6f0: 736b 7920 6578 6563 202d 2d6e 756d 2d6e  sky exec --num-n
+0001e700: 6f64 6573 3d32 207b 6e61 6d65 7d20 6578  odes=2 {name} ex
+0001e710: 616d 706c 6573 2f61 7a75 7265 5f73 7461  amples/azure_sta
+0001e720: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
+0001e730: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001e740: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+0001e750: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+0001e760: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+0001e770: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+0001e780: 2020 2066 2773 6b79 2073 746f 7020 2d79     f'sky stop -y
+0001e790: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+0001e7a0: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
+0001e7b0: 7420 2d79 207b 6e61 6d65 7d27 2c0a 2020  t -y {name}',.  
+0001e7c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001e7d0: 6578 6563 202d 2d6e 756d 2d6e 6f64 6573  exec --num-nodes
+0001e7e0: 3d32 207b 6e61 6d65 7d20 6578 616d 706c  =2 {name} exampl
+0001e7f0: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
+0001e800: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
+0001e810: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0001e820: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+0001e830: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+0001e840: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+0001e850: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+0001e860: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0001e870: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0001e880: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
+0001e890: 2a20 3630 2c20 2023 2033 3020 6d69 6e73  * 60,  # 30 mins
+0001e8a0: 2020 2869 7420 7461 6b65 7320 6172 6f75    (it takes arou
+0001e8b0: 6e64 207e 3233 206d 696e 7329 0a20 2020  nd ~23 mins).   
+0001e8c0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0001e8d0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+0001e8e0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+0001e8f0: 2065 6e76 2066 6f72 2064 6973 6b20 7469   env for disk ti
+0001e900: 6572 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  er ----------.@p
+0001e910: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
+0001e920: 6566 2074 6573 745f 6177 735f 6469 736b  ef test_aws_disk
+0001e930: 5f74 6965 7228 293a 0a0a 2020 2020 6465  _tier():..    de
+0001e940: 6620 5f67 6574 5f61 7773 5f71 7565 7279  f _get_aws_query
+0001e950: 5f63 6f6d 6d61 6e64 2872 6567 696f 6e2c  _command(region,
+0001e960: 2069 6e73 7461 6e63 655f 6964 2c20 6669   instance_id, fi
+0001e970: 656c 642c 2065 7870 6563 7465 6429 3a0a  eld, expected):.
+0001e980: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+0001e990: 6627 6177 7320 6563 3220 6465 7363 7269  f'aws ec2 descri
+0001e9a0: 6265 2d76 6f6c 756d 6573 202d 2d72 6567  be-volumes --reg
+0001e9b0: 696f 6e20 7b72 6567 696f 6e7d 2027 0a20  ion {region} '. 
+0001e9c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001e9d0: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
+0001e9e0: 6174 7461 6368 6d65 6e74 2e69 6e73 7461  attachment.insta
+0001e9f0: 6e63 652d 6964 2c56 616c 7565 733d 7b69  nce-id,Values={i
+0001ea00: 6e73 7461 6e63 655f 6964 7d20 270a 2020  nstance_id} '.  
+0001ea10: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001ea20: 2d2d 7175 6572 7920 566f 6c75 6d65 735b  --query Volumes[
+0001ea30: 2a5d 2e7b 6669 656c 647d 207c 2067 7265  *].{field} | gre
+0001ea40: 7020 7b65 7870 6563 7465 647d 203b 2027  p {expected} ; '
+0001ea50: 290a 0a20 2020 2066 6f72 2064 6973 6b5f  )..    for disk_
+0001ea60: 7469 6572 2069 6e20 6c69 7374 2872 6573  tier in list(res
+0001ea70: 6f75 7263 6573 5f75 7469 6c73 2e44 6973  ources_utils.Dis
+0001ea80: 6b54 6965 7229 3a0a 2020 2020 2020 2020  kTier):.        
+0001ea90: 7370 6563 7320 3d20 4157 532e 5f67 6574  specs = AWS._get
+0001eaa0: 5f64 6973 6b5f 7370 6563 7328 6469 736b  _disk_specs(disk
+0001eab0: 5f74 6965 7229 0a20 2020 2020 2020 206e  _tier).        n
+0001eac0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0001ead0: 6572 5f6e 616d 6528 2920 2b20 272d 2720  er_name() + '-' 
+0001eae0: 2b20 6469 736b 5f74 6965 722e 7661 6c75  + disk_tier.valu
+0001eaf0: 650a 2020 2020 2020 2020 6e61 6d65 5f6f  e.        name_o
+0001eb00: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
+0001eb10: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
+0001eb20: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+0001eb30: 6428 0a20 2020 2020 2020 2020 2020 206e  d(.            n
+0001eb40: 616d 652c 2073 6b79 2e41 5753 2e6d 6178  ame, sky.AWS.max
+0001eb50: 5f63 6c75 7374 6572 5f6e 616d 655f 6c65  _cluster_name_le
+0001eb60: 6e67 7468 2829 290a 2020 2020 2020 2020  ngth()).        
+0001eb70: 7265 6769 6f6e 203d 2027 7573 2d65 6173  region = 'us-eas
+0001eb80: 742d 3227 0a20 2020 2020 2020 2074 6573  t-2'.        tes
+0001eb90: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0001eba0: 2020 2020 2020 2761 7773 2d64 6973 6b2d        'aws-disk-
+0001ebb0: 7469 6572 2d27 202b 2064 6973 6b5f 7469  tier-' + disk_ti
+0001ebc0: 6572 2e76 616c 7565 2c0a 2020 2020 2020  er.value,.      
+0001ebd0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0001ebe0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0001ebf0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0001ec00: 7d20 2d2d 636c 6f75 6420 6177 7320 2d2d  } --cloud aws --
+0001ec10: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+0001ec20: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001ec30: 2020 6627 2d2d 6469 736b 2d74 6965 7220    f'--disk-tier 
+0001ec40: 7b64 6973 6b5f 7469 6572 2e76 616c 7565  {disk_tier.value
+0001ec50: 7d20 6563 686f 2022 6865 6c6c 6f20 736b  } echo "hello sk
+0001ec60: 7922 272c 0a20 2020 2020 2020 2020 2020  y"',.           
+0001ec70: 2020 2020 2066 2769 643d 6061 7773 2065       f'id=`aws e
+0001ec80: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
+0001ec90: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+0001eca0: 7265 6769 6f6e 7d20 2d2d 6669 6c74 6572  region} --filter
+0001ecb0: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
+0001ecc0: 2020 2020 6627 4e61 6d65 3d74 6167 3a72      f'Name=tag:r
+0001ecd0: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
+0001ece0: 5661 6c75 6573 3d7b 6e61 6d65 5f6f 6e5f  Values={name_on_
+0001ecf0: 636c 6f75 647d 202d 2d71 7565 7279 2027  cloud} --query '
+0001ed00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ed10: 2066 2752 6573 6572 7661 7469 6f6e 735b   f'Reservations[
+0001ed20: 5d2e 496e 7374 616e 6365 735b 5d2e 496e  ].Instances[].In
+0001ed30: 7374 616e 6365 4964 202d 2d6f 7574 7075  stanceId --outpu
+0001ed40: 7420 7465 7874 603b 2027 202b 0a20 2020  t text`; ' +.   
+0001ed50: 2020 2020 2020 2020 2020 2020 205f 6765               _ge
+0001ed60: 745f 6177 735f 7175 6572 795f 636f 6d6d  t_aws_query_comm
+0001ed70: 616e 6428 7265 6769 6f6e 2c20 2724 6964  and(region, '$id
+0001ed80: 272c 2027 566f 6c75 6d65 5479 7065 272c  ', 'VolumeType',
+0001ed90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edb0: 2020 2020 2020 2020 7370 6563 735b 2764          specs['d
+0001edc0: 6973 6b5f 7469 6572 275d 2920 2b0a 2020  isk_tier']) +.  
+0001edd0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+0001ede0: 2720 6966 2064 6973 6b5f 7469 6572 203d  ' if disk_tier =
+0001edf0: 3d20 7265 736f 7572 6365 735f 7574 696c  = resources_util
+0001ee00: 732e 4469 736b 5469 6572 2e4c 4f57 2065  s.DiskTier.LOW e
+0001ee10: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+0001ee20: 2020 2020 2028 5f67 6574 5f61 7773 5f71       (_get_aws_q
+0001ee30: 7565 7279 5f63 6f6d 6d61 6e64 2872 6567  uery_command(reg
+0001ee40: 696f 6e2c 2027 2469 6427 2c20 2749 6f70  ion, '$id', 'Iop
+0001ee50: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+0001ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee70: 2020 2020 2020 2020 2020 2020 2073 7065               spe
+0001ee80: 6373 5b27 6469 736b 5f69 6f70 7327 5d29  cs['disk_iops'])
+0001ee90: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
+0001eea0: 2020 2020 205f 6765 745f 6177 735f 7175       _get_aws_qu
+0001eeb0: 6572 795f 636f 6d6d 616e 6428 7265 6769  ery_command(regi
+0001eec0: 6f6e 2c20 2724 6964 272c 2027 5468 726f  on, '$id', 'Thro
+0001eed0: 7567 6870 7574 272c 0a20 2020 2020 2020  ughput',.       
+0001eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef00: 2020 7370 6563 735b 2764 6973 6b5f 7468    specs['disk_th
+0001ef10: 726f 7567 6870 7574 275d 2929 292c 0a20  roughput']))),. 
+0001ef20: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+0001ef30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001ef40: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0001ef50: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
+0001ef60: 656f 7574 3d31 3020 2a20 3630 2c20 2023  eout=10 * 60,  #
+0001ef70: 2031 3020 6d69 6e73 2020 2869 7420 7461   10 mins  (it ta
+0001ef80: 6b65 7320 6172 6f75 6e64 207e 3620 6d69  kes around ~6 mi
+0001ef90: 6e73 290a 2020 2020 2020 2020 290a 2020  ns).        ).  
+0001efa0: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
+0001efb0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+0001efc0: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
+0001efd0: 7465 7374 5f67 6370 5f64 6973 6b5f 7469  test_gcp_disk_ti
+0001efe0: 6572 2829 3a0a 2020 2020 666f 7220 6469  er():.    for di
+0001eff0: 736b 5f74 6965 7220 696e 206c 6973 7428  sk_tier in list(
+0001f000: 7265 736f 7572 6365 735f 7574 696c 732e  resources_utils.
+0001f010: 4469 736b 5469 6572 293a 0a20 2020 2020  DiskTier):.     
+0001f020: 2020 2074 7970 6520 3d20 4743 502e 5f67     type = GCP._g
+0001f030: 6574 5f64 6973 6b5f 7479 7065 2864 6973  et_disk_type(dis
+0001f040: 6b5f 7469 6572 290a 2020 2020 2020 2020  k_tier).        
+0001f050: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0001f060: 7465 725f 6e61 6d65 2829 202b 2027 2d27  ter_name() + '-'
+0001f070: 202b 2064 6973 6b5f 7469 6572 2e76 616c   + disk_tier.val
+0001f080: 7565 0a20 2020 2020 2020 206e 616d 655f  ue.        name_
+0001f090: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
+0001f0a0: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
+0001f0b0: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+0001f0c0: 7564 280a 2020 2020 2020 2020 2020 2020  ud(.            
+0001f0d0: 6e61 6d65 2c20 736b 792e 4743 502e 6d61  name, sky.GCP.ma
+0001f0e0: 785f 636c 7573 7465 725f 6e61 6d65 5f6c  x_cluster_name_l
+0001f0f0: 656e 6774 6828 2929 0a20 2020 2020 2020  ength()).       
+0001f100: 2072 6567 696f 6e20 3d20 2775 732d 7765   region = 'us-we
+0001f110: 7374 3227 0a20 2020 2020 2020 2074 6573  st2'.        tes
+0001f120: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0001f130: 2020 2020 2020 2767 6370 2d64 6973 6b2d        'gcp-disk-
+0001f140: 7469 6572 2d27 202b 2064 6973 6b5f 7469  tier-' + disk_ti
+0001f150: 6572 2e76 616c 7565 2c0a 2020 2020 2020  er.value,.      
+0001f160: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0001f170: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0001f180: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0001f190: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
+0001f1a0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+0001f1b0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001f1c0: 2020 6627 2d2d 6469 736b 2d74 6965 7220    f'--disk-tier 
+0001f1d0: 7b64 6973 6b5f 7469 6572 2e76 616c 7565  {disk_tier.value
+0001f1e0: 7d20 6563 686f 2022 6865 6c6c 6f20 736b  } echo "hello sk
+0001f1f0: 7922 272c 0a20 2020 2020 2020 2020 2020  y"',.           
+0001f200: 2020 2020 2066 276e 616d 653d 6067 636c       f'name=`gcl
+0001f210: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
+0001f220: 616e 6365 7320 6c69 7374 202d 2d66 696c  ances list --fil
+0001f230: 7465 723d 270a 2020 2020 2020 2020 2020  ter='.          
+0001f240: 2020 2020 2020 6627 226c 6162 656c 732e        f'"labels.
+0001f250: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+0001f260: 3a7b 6e61 6d65 5f6f 6e5f 636c 6f75 647d  :{name_on_cloud}
+0001f270: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
+0001f280: 2020 2020 272d 2d66 6f72 6d61 743d 2276      '--format="v
+0001f290: 616c 7565 286e 616d 6529 2260 3b20 270a  alue(name)"`; '.
+0001f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f2b0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
+0001f2c0: 2064 6973 6b73 206c 6973 7420 2d2d 6669   disks list --fi
+0001f2d0: 6c74 6572 3d22 6e61 6d65 3d24 6e61 6d65  lter="name=$name
+0001f2e0: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
+0001f2f0: 2020 2020 6627 2d2d 666f 726d 6174 3d22      f'--format="
+0001f300: 7661 6c75 6528 7479 7065 2922 207c 2067  value(type)" | g
+0001f310: 7265 7020 7b74 7970 657d 2027 0a20 2020  rep {type} '.   
+0001f320: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+0001f330: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0001f340: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0001f350: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
+0001f360: 7574 3d36 202a 2036 302c 2020 2320 3620  ut=6 * 60,  # 6 
+0001f370: 6d69 6e73 2020 2869 7420 7461 6b65 7320  mins  (it takes 
+0001f380: 6172 6f75 6e64 207e 3320 6d69 6e73 290a  around ~3 mins).
+0001f390: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001f3a0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001f3b0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0001f3c0: 6172 6b2e 617a 7572 650a 6465 6620 7465  ark.azure.def te
+0001f3d0: 7374 5f61 7a75 7265 5f64 6973 6b5f 7469  st_azure_disk_ti
+0001f3e0: 6572 2829 3a0a 2020 2020 666f 7220 6469  er():.    for di
+0001f3f0: 736b 5f74 6965 7220 696e 206c 6973 7428  sk_tier in list(
+0001f400: 7265 736f 7572 6365 735f 7574 696c 732e  resources_utils.
+0001f410: 4469 736b 5469 6572 293a 0a20 2020 2020  DiskTier):.     
+0001f420: 2020 2069 6620 6469 736b 5f74 6965 7220     if disk_tier 
+0001f430: 3d3d 2072 6573 6f75 7263 6573 5f75 7469  == resources_uti
+0001f440: 6c73 2e44 6973 6b54 6965 722e 4849 4748  ls.DiskTier.HIGH
+0001f450: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001f460: 417a 7572 6520 646f 6573 206e 6f74 2073  Azure does not s
+0001f470: 7570 706f 7274 2068 6967 6820 6469 736b  upport high disk
+0001f480: 2074 6965 722e 0a20 2020 2020 2020 2020   tier..         
+0001f490: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0001f4a0: 2020 2020 7479 7065 203d 2041 7a75 7265      type = Azure
+0001f4b0: 2e5f 6765 745f 6469 736b 5f74 7970 6528  ._get_disk_type(
+0001f4c0: 6469 736b 5f74 6965 7229 0a20 2020 2020  disk_tier).     
+0001f4d0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0001f4e0: 6c75 7374 6572 5f6e 616d 6528 2920 2b20  luster_name() + 
+0001f4f0: 272d 2720 2b20 6469 736b 5f74 6965 722e  '-' + disk_tier.
+0001f500: 7661 6c75 650a 2020 2020 2020 2020 6e61  value.        na
+0001f510: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
+0001f520: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
+0001f530: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+0001f540: 636c 6f75 6428 0a20 2020 2020 2020 2020  cloud(.         
+0001f550: 2020 206e 616d 652c 2073 6b79 2e41 7a75     name, sky.Azu
+0001f560: 7265 2e6d 6178 5f63 6c75 7374 6572 5f6e  re.max_cluster_n
+0001f570: 616d 655f 6c65 6e67 7468 2829 290a 2020  ame_length()).  
+0001f580: 2020 2020 2020 7265 6769 6f6e 203d 2027        region = '
+0001f590: 7765 7374 7573 3227 0a20 2020 2020 2020  westus2'.       
+0001f5a0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0001f5b0: 2020 2020 2020 2020 2020 2761 7a75 7265            'azure
+0001f5c0: 2d64 6973 6b2d 7469 6572 2d27 202b 2064  -disk-tier-' + d
+0001f5d0: 6973 6b5f 7469 6572 2e76 616c 7565 2c0a  isk_tier.value,.
+0001f5e0: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+0001f5f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001f600: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0001f610: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+0001f620: 617a 7572 6520 2d2d 7265 6769 6f6e 207b  azure --region {
+0001f630: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+0001f640: 2020 2020 2020 2020 2020 6627 2d2d 6469            f'--di
+0001f650: 736b 2d74 6965 7220 7b64 6973 6b5f 7469  sk-tier {disk_ti
+0001f660: 6572 2e76 616c 7565 7d20 6563 686f 2022  er.value} echo "
+0001f670: 6865 6c6c 6f20 736b 7922 272c 0a20 2020  hello sky"',.   
+0001f680: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
+0001f690: 7a20 7265 736f 7572 6365 206c 6973 7420  z resource list 
+0001f6a0: 2d2d 7461 6720 7261 792d 636c 7573 7465  --tag ray-cluste
+0001f6b0: 722d 6e61 6d65 3d7b 6e61 6d65 5f6f 6e5f  r-name={name_on_
+0001f6c0: 636c 6f75 647d 202d 2d71 7565 7279 2027  cloud} --query '
+0001f6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f6e0: 2066 2722 5b3f 7479 7065 3d3d 5c27 4d69   f'"[?type==\'Mi
+0001f6f0: 6372 6f73 6f66 742e 436f 6d70 7574 652f  crosoft.Compute/
+0001f700: 6469 736b 735c 275d 2e73 6b75 2e6e 616d  disks\'].sku.nam
+0001f710: 6522 2027 0a20 2020 2020 2020 2020 2020  e" '.           
+0001f720: 2020 2020 2066 272d 2d6f 7574 7075 7420       f'--output 
+0001f730: 7473 7620 7c20 6772 6570 207b 7479 7065  tsv | grep {type
+0001f740: 7d27 0a20 2020 2020 2020 2020 2020 205d  }'.            ]
+0001f750: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001f760: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0001f770: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+0001f780: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+0001f790: 2c20 2023 2032 3020 6d69 6e73 2020 2869  ,  # 20 mins  (i
+0001f7a0: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
+0001f7b0: 3132 206d 696e 7329 0a20 2020 2020 2020  12 mins).       
+0001f7c0: 2029 0a20 2020 2020 2020 2072 756e 5f6f   ).        run_o
+0001f7d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001f7e0: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
+0001f7f0: 7265 0a64 6566 2074 6573 745f 617a 7572  re.def test_azur
+0001f800: 655f 6265 7374 5f74 6965 725f 6661 696c  e_best_tier_fail
+0001f810: 6f76 6572 2829 3a0a 2020 2020 7479 7065  over():.    type
+0001f820: 203d 2041 7a75 7265 2e5f 6765 745f 6469   = Azure._get_di
+0001f830: 736b 5f74 7970 6528 7265 736f 7572 6365  sk_type(resource
+0001f840: 735f 7574 696c 732e 4469 736b 5469 6572  s_utils.DiskTier
+0001f850: 2e4c 4f57 290a 2020 2020 6e61 6d65 203d  .LOW).    name =
+0001f860: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0001f870: 6d65 2829 0a20 2020 206e 616d 655f 6f6e  me().    name_on
+0001f880: 5f63 6c6f 7564 203d 2063 6f6d 6d6f 6e5f  _cloud = common_
+0001f890: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
+0001f8a0: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
+0001f8b0: 280a 2020 2020 2020 2020 6e61 6d65 2c20  (.        name, 
+0001f8c0: 736b 792e 417a 7572 652e 6d61 785f 636c  sky.Azure.max_cl
+0001f8d0: 7573 7465 725f 6e61 6d65 5f6c 656e 6774  uster_name_lengt
+0001f8e0: 6828 2929 0a20 2020 2072 6567 696f 6e20  h()).    region 
+0001f8f0: 3d20 2777 6573 7475 7332 270a 2020 2020  = 'westus2'.    
+0001f900: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001f910: 2020 2020 2027 617a 7572 652d 6265 7374       'azure-best
+0001f920: 2d74 6965 722d 6661 696c 6f76 6572 272c  -tier-failover',
+0001f930: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001f940: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0001f950: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+0001f960: 202d 2d63 6c6f 7564 2061 7a75 7265 202d   --cloud azure -
+0001f970: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+0001f980: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+0001f990: 272d 2d64 6973 6b2d 7469 6572 2062 6573  '--disk-tier bes
+0001f9a0: 7420 2d2d 696e 7374 616e 6365 2d74 7970  t --instance-typ
+0001f9b0: 6520 5374 616e 6461 7264 5f44 385f 7635  e Standard_D8_v5
+0001f9c0: 2065 6368 6f20 2268 656c 6c6f 2073 6b79   echo "hello sky
+0001f9d0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001f9e0: 6627 617a 2072 6573 6f75 7263 6520 6c69  f'az resource li
+0001f9f0: 7374 202d 2d74 6167 2072 6179 2d63 6c75  st --tag ray-clu
+0001fa00: 7374 6572 2d6e 616d 653d 7b6e 616d 655f  ster-name={name_
+0001fa10: 6f6e 5f63 6c6f 7564 7d20 2d2d 7175 6572  on_cloud} --quer
+0001fa20: 7920 270a 2020 2020 2020 2020 2020 2020  y '.            
+0001fa30: 6627 225b 3f74 7970 653d 3d5c 274d 6963  f'"[?type==\'Mic
+0001fa40: 726f 736f 6674 2e43 6f6d 7075 7465 2f64  rosoft.Compute/d
+0001fa50: 6973 6b73 5c27 5d2e 736b 752e 6e61 6d65  isks\'].sku.name
+0001fa60: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
+0001fa70: 6627 2d2d 6f75 7470 7574 2074 7376 207c  f'--output tsv |
+0001fa80: 2067 7265 7020 7b74 7970 657d 272c 0a20   grep {type}',. 
+0001fa90: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+0001faa0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+0001fab0: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+0001fac0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+0001fad0: 2c20 2023 2032 3020 6d69 6e73 2020 2869  ,  # 20 mins  (i
+0001fae0: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
+0001faf0: 3132 206d 696e 7329 0a20 2020 2029 0a20  12 mins).    ). 
+0001fb00: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0001fb10: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0001fb20: 2054 6573 7469 6e67 205a 6572 6f20 5175   Testing Zero Qu
+0001fb30: 6f74 6120 4661 696c 6f76 6572 202d 2d2d  ota Failover ---
+0001fb40: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0001fb50: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
+0001fb60: 735f 7a65 726f 5f71 756f 7461 5f66 6169  s_zero_quota_fai
+0001fb70: 6c6f 7665 7228 293a 0a0a 2020 2020 6e61  lover():..    na
+0001fb80: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+0001fb90: 725f 6e61 6d65 2829 0a20 2020 2072 6567  r_name().    reg
+0001fba0: 696f 6e20 3d20 6765 745f 6177 735f 7265  ion = get_aws_re
+0001fbb0: 6769 6f6e 5f66 6f72 5f71 756f 7461 5f66  gion_for_quota_f
+0001fbc0: 6169 6c6f 7665 7228 290a 0a20 2020 2069  ailover()..    i
+0001fbd0: 6620 6e6f 7420 7265 6769 6f6e 3a0a 2020  f not region:.  
+0001fbe0: 2020 2020 2020 7079 7465 7374 2e78 6661        pytest.xfa
+0001fbf0: 696c 280a 2020 2020 2020 2020 2020 2020  il(.            
+0001fc00: 2755 6e61 626c 6520 746f 2074 6573 7420  'Unable to test 
+0001fc10: 7a65 726f 2071 756f 7461 2066 6169 6c6f  zero quota failo
+0001fc20: 7665 7220 6f70 7469 6d69 7a61 7469 6f6e  ver optimization
+0001fc30: 20e2 8094 2071 756f 7461 7320 270a 2020   ... quotas '.  
+0001fc40: 2020 2020 2020 2020 2020 2766 6f72 2045            'for E
+0001fc50: 4332 2050 3320 696e 7374 616e 6365 7320  C2 P3 instances 
+0001fc60: 7765 7265 2066 6f75 6e64 206f 6e20 616c  were found on al
+0001fc70: 6c20 4157 5320 7265 6769 6f6e 732e 2049  l AWS regions. I
+0001fc80: 7320 7468 6973 2027 0a20 2020 2020 2020  s this '.       
+0001fc90: 2020 2020 2027 6578 7065 6374 6564 2066       'expected f
+0001fca0: 6f72 2079 6f75 7220 6163 636f 756e 743f  or your account?
+0001fcb0: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
+0001fcc0: 6e0a 0a20 2020 2074 6573 7420 3d20 5465  n..    test = Te
+0001fcd0: 7374 280a 2020 2020 2020 2020 2761 7773  st(.        'aws
+0001fce0: 2d7a 6572 6f2d 7175 6f74 612d 6661 696c  -zero-quota-fail
+0001fcf0: 6f76 6572 272c 0a20 2020 2020 2020 205b  over',.        [
+0001fd00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001fd10: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0001fd20: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
+0001fd30: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
+0001fd40: 696f 6e7d 202d 2d67 7075 7320 5631 3030  ion} --gpus V100
+0001fd50: 3a38 202d 2d75 7365 2d73 706f 7420 7c20  :8 --use-spot | 
+0001fd60: 6772 6570 2022 466f 756e 6420 6e6f 2071  grep "Found no q
+0001fd70: 756f 7461 2227 2c0a 2020 2020 2020 2020  uota"',.        
+0001fd80: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+0001fd90: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+0001fda0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+0001fdb0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0001fdc0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+0001fdd0: 700a 6465 6620 7465 7374 5f67 6370 5f7a  p.def test_gcp_z
+0001fde0: 6572 6f5f 7175 6f74 615f 6661 696c 6f76  ero_quota_failov
+0001fdf0: 6572 2829 3a0a 0a20 2020 206e 616d 6520  er():..    name 
+0001fe00: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0001fe10: 616d 6528 290a 2020 2020 7265 6769 6f6e  ame().    region
+0001fe20: 203d 2067 6574 5f67 6370 5f72 6567 696f   = get_gcp_regio
+0001fe30: 6e5f 666f 725f 7175 6f74 615f 6661 696c  n_for_quota_fail
+0001fe40: 6f76 6572 2829 0a0a 2020 2020 6966 206e  over()..    if n
+0001fe50: 6f74 2072 6567 696f 6e3a 0a20 2020 2020  ot region:.     
+0001fe60: 2020 2070 7974 6573 742e 7866 6169 6c28     pytest.xfail(
+0001fe70: 0a20 2020 2020 2020 2020 2020 2027 556e  .            'Un
+0001fe80: 6162 6c65 2074 6f20 7465 7374 207a 6572  able to test zer
+0001fe90: 6f20 7175 6f74 6120 6661 696c 6f76 6572  o quota failover
+0001fea0: 206f 7074 696d 697a 6174 696f 6e20 e280   optimization ..
+0001feb0: 9420 7175 6f74 6173 2027 0a20 2020 2020  . quotas '.     
+0001fec0: 2020 2020 2020 2027 666f 7220 4131 3030         'for A100
+0001fed0: 2d38 3047 4220 4750 5573 2077 6572 6520  -80GB GPUs were 
+0001fee0: 666f 756e 6420 6f6e 2061 6c6c 2047 4350  found on all GCP
+0001fef0: 2072 6567 696f 6e73 2e20 4973 2074 6869   regions. Is thi
+0001ff00: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
+0001ff10: 2765 7870 6563 7465 6420 666f 7220 796f  'expected for yo
+0001ff20: 7572 2061 6363 6f75 6e74 3f27 290a 2020  ur account?').  
+0001ff30: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0001ff40: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0001ff50: 2020 2020 2020 2027 6763 702d 7a65 726f         'gcp-zero
+0001ff60: 2d71 756f 7461 2d66 6169 6c6f 7665 7227  -quota-failover'
+0001ff70: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0001ff80: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0001ff90: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0001ffa0: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
+0001ffb0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+0001ffc0: 2d2d 6770 7573 2041 3130 302d 3830 4742  --gpus A100-80GB
+0001ffd0: 3a31 202d 2d75 7365 2d73 706f 7420 7c20  :1 --use-spot | 
+0001ffe0: 6772 6570 2022 466f 756e 6420 6e6f 2071  grep "Found no q
+0001fff0: 756f 7461 2227 2c0a 2020 2020 2020 2020  uota"',.        
+00020000: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00020010: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00020020: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00020030: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00020040: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00020050: 7374 696e 6720 736b 7973 6572 7665 202d  sting skyserve -
+00020060: 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a 6465 6620  ---------...def 
+00020070: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+00020080: 6528 2920 2d3e 2073 7472 3a0a 2020 2020  e() -> str:.    
+00020090: 2222 2252 6574 7572 6e73 2061 2075 7365  """Returns a use
+000200a0: 722d 756e 6971 7565 2073 6572 7669 6365  r-unique service
+000200b0: 206e 616d 6520 666f 7220 6561 6368 2074   name for each t
+000200c0: 6573 745f 736b 7973 6572 7665 5f3c 6e61  est_skyserve_<na
+000200d0: 6d65 3e28 292e 0a0a 2020 2020 4d75 7374  me>()...    Must
+000200e0: 2062 6520 6361 6c6c 6564 2066 726f 6d20   be called from 
+000200f0: 6561 6368 2074 6573 745f 736b 7973 6572  each test_skyser
+00020100: 7665 5f3c 6e61 6d65 3e28 292e 0a20 2020  ve_<name>()..   
+00020110: 2022 2222 0a20 2020 2063 616c 6c65 725f   """.    caller_
+00020120: 6675 6e63 5f6e 616d 6520 3d20 696e 7370  func_name = insp
+00020130: 6563 742e 7374 6163 6b28 295b 315d 5b33  ect.stack()[1][3
+00020140: 5d0a 2020 2020 7465 7374 5f6e 616d 6520  ].    test_name 
+00020150: 3d20 6361 6c6c 6572 5f66 756e 635f 6e61  = caller_func_na
+00020160: 6d65 2e72 6570 6c61 6365 2827 5f27 2c20  me.replace('_', 
+00020170: 272d 2729 2e72 6570 6c61 6365 2827 7465  '-').replace('te
+00020180: 7374 2d27 2c20 2774 2d27 290a 2020 2020  st-', 't-').    
+00020190: 7465 7374 5f6e 616d 6520 3d20 7465 7374  test_name = test
+000201a0: 5f6e 616d 652e 7265 706c 6163 6528 2773  _name.replace('s
+000201b0: 6b79 7365 7276 652d 272c 2027 7373 2d27  kyserve-', 'ss-'
+000201c0: 290a 2020 2020 7465 7374 5f6e 616d 6520  ).    test_name 
+000201d0: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+000201e0: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+000201f0: 5f6f 6e5f 636c 6f75 6428 7465 7374 5f6e  _on_cloud(test_n
+00020200: 616d 652c 2032 3429 0a20 2020 2072 6574  ame, 24).    ret
+00020210: 7572 6e20 6627 7b74 6573 745f 6e61 6d65  urn f'{test_name
+00020220: 7d2d 7b74 6573 745f 6964 7d27 0a0a 0a23  }-{test_id}'...#
+00020230: 2057 6520 6368 6563 6b20 7468 6520 6f75   We check the ou
+00020240: 7470 7574 206f 6620 7468 6520 736b 7973  tput of the skys
+00020250: 6572 7665 2073 6572 7669 6365 2074 6f20  erve service to 
+00020260: 7365 6520 6966 2069 7420 6973 2072 6561  see if it is rea
+00020270: 6479 2e20 4f75 7470 7574 206f 660a 2320  dy. Output of.# 
+00020280: 6052 4550 4c49 4341 5360 2069 7320 696e  `REPLICAS` is in
+00020290: 2074 6865 2066 6f72 6d20 6f66 2060 312f   the form of `1/
+000202a0: 3260 2077 6865 7265 2074 6865 2066 6972  2` where the fir
+000202b0: 7374 206e 756d 6265 7220 6973 2074 6865  st number is the
+000202c0: 206e 756d 6265 7220 6f66 0a23 2072 6561   number of.# rea
+000202d0: 6479 2072 6570 6c69 6361 7320 616e 6420  dy replicas and 
+000202e0: 7468 6520 7365 636f 6e64 206e 756d 6265  the second numbe
+000202f0: 7220 6973 2074 6865 206e 756d 6265 7220  r is the number 
+00020300: 6f66 2074 6f74 616c 2072 6570 6c69 6361  of total replica
+00020310: 732e 2057 650a 2320 6772 6570 2073 7563  s. We.# grep suc
+00020320: 6820 666f 726d 6174 2074 6f20 656e 7375  h format to ensu
+00020330: 7265 2074 6861 7420 7468 6520 7365 7276  re that the serv
+00020340: 6963 6520 6973 2072 6561 6479 2c20 616e  ice is ready, an
+00020350: 6420 6561 726c 7920 6578 6974 2069 6620  d early exit if 
+00020360: 616e 790a 2320 6661 696c 7572 6520 6465  any.# failure de
+00020370: 7465 6374 6564 2e20 496e 2074 6865 2065  tected. In the e
+00020380: 6e64 2077 6520 736c 6565 7020 666f 720a  nd we sleep for.
+00020390: 2320 7365 7276 652e 4c42 5f43 4f4e 5452  # serve.LB_CONTR
+000203a0: 4f4c 4c45 525f 5359 4e43 5f49 4e54 4552  OLLER_SYNC_INTER
+000203b0: 5641 4c5f 5345 434f 4e44 5320 746f 206d  VAL_SECONDS to m
+000203c0: 616b 6520 7375 7265 206c 6f61 6420 6261  ake sure load ba
+000203d0: 6c61 6e63 6572 2068 6176 650a 2320 656e  lancer have.# en
+000203e0: 6f75 6768 2074 696d 6520 746f 2073 796e  ough time to syn
+000203f0: 6320 7769 7468 2074 6865 2063 6f6e 7472  c with the contr
+00020400: 6f6c 6c65 7220 616e 6420 6765 7420 616c  oller and get al
+00020410: 6c20 7265 6164 7920 7265 706c 6963 6120  l ready replica 
+00020420: 4950 732e 0a5f 5345 5256 455f 5741 4954  IPs.._SERVE_WAIT
+00020430: 5f55 4e54 494c 5f52 4541 4459 203d 2028  _UNTIL_READY = (
+00020440: 0a20 2020 2027 7b7b 2077 6869 6c65 2074  .    '{{ while t
+00020450: 7275 653b 2064 6f27 0a20 2020 2027 2020  rue; do'.    '  
+00020460: 2020 2073 3d24 2873 6b79 2073 6572 7665     s=$(sky serve
+00020470: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
+00020480: 2065 6368 6f20 2224 7322 3b27 0a20 2020   echo "$s";'.   
+00020490: 2027 2020 2020 2065 6368 6f20 2224 7322   '     echo "$s"
+000204a0: 207c 2067 7265 7020 2d71 2022 7b72 6570   | grep -q "{rep
+000204b0: 6c69 6361 5f6e 756d 7d2f 7b72 6570 6c69  lica_num}/{repli
+000204c0: 6361 5f6e 756d 7d22 2026 2620 6272 6561  ca_num}" && brea
+000204d0: 6b3b 270a 2020 2020 2720 2020 2020 6563  k;'.    '     ec
+000204e0: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
+000204f0: 7120 2246 4149 4c45 4422 2026 2620 6578  q "FAILED" && ex
+00020500: 6974 2031 3b27 0a20 2020 2027 2020 2020  it 1;'.    '    
+00020510: 2073 6c65 6570 2031 303b 270a 2020 2020   sleep 10;'.    
+00020520: 2720 646f 6e65 3b20 7d7d 3b20 6563 686f  ' done; }}; echo
+00020530: 2022 476f 7420 7365 7276 6963 6520 7374   "Got service st
+00020540: 6174 7573 2024 7322 3b27 0a20 2020 2066  atus $s";'.    f
+00020550: 2773 6c65 6570 207b 7365 7276 652e 4c42  'sleep {serve.LB
+00020560: 5f43 4f4e 5452 4f4c 4c45 525f 5359 4e43  _CONTROLLER_SYNC
+00020570: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
+00020580: 5320 2b20 327d 3b27 290a 5f49 505f 5245  S + 2};')._IP_RE
+00020590: 4745 5820 3d20 7227 285b 302d 395d 7b31  GEX = r'([0-9]{1
+000205a0: 2c33 7d5c 2e29 7b33 7d5b 302d 395d 7b31  ,3}\.){3}[0-9]{1
+000205b0: 2c33 7d27 0a5f 4157 4b5f 414c 4c5f 4c49  ,3}'._AWK_ALL_LI
+000205c0: 4e45 535f 4245 4c4f 575f 5245 504c 4943  NES_BELOW_REPLIC
+000205d0: 4153 203d 2072 272f 5265 706c 6963 6173  AS = r'/Replicas
+000205e0: 2f7b 666c 6167 3d31 3b20 6e65 7874 7d20  /{flag=1; next} 
+000205f0: 666c 6167 270a 5f53 4552 5649 4345 5f4c  flag'._SERVICE_L
+00020600: 4155 4e43 4849 4e47 5f53 5441 5455 535f  AUNCHING_STATUS_
+00020610: 5245 4745 5820 3d20 2750 524f 5649 5349  REGEX = 'PROVISI
+00020620: 4f4e 494e 475c 7c53 5441 5254 494e 4727  ONING\|STARTING'
+00020630: 0a23 2053 696e 6365 2077 6520 646f 6e27  .# Since we don'
+00020640: 7420 616c 6c6f 7720 7465 726d 696e 6174  t allow terminat
+00020650: 6520 7468 6520 7365 7276 6963 6520 6966  e the service if
+00020660: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
+00020670: 6973 2049 4e49 542c 0a23 2077 6869 6368  is INIT,.# which
+00020680: 2069 7320 636f 6d6d 6f6e 2066 6f72 2073   is common for s
+00020690: 696d 756c 7461 6e65 6f75 7320 7079 7465  imultaneous pyte
+000206a0: 7374 2c20 7765 206e 6565 6420 746f 2077  st, we need to w
+000206b0: 6169 7420 756e 7469 6c20 7468 650a 2320  ait until the.# 
+000206c0: 636f 6e74 726f 6c6c 6572 2069 7320 5550  controller is UP
+000206d0: 2062 6566 6f72 6520 7765 2063 616e 2074   before we can t
+000206e0: 6572 6d69 6e61 7465 2074 6865 2073 6572  erminate the ser
+000206f0: 7669 6365 2e0a 2320 5468 6520 7465 6172  vice..# The tear
+00020700: 646f 776e 2063 6f6d 6d61 6e64 2068 6173  down command has
+00020710: 2061 2031 302d 6d69 6e73 2074 696d 656f   a 10-mins timeo
+00020720: 7574 2c20 736f 2077 6520 646f 6e27 7420  ut, so we don't 
+00020730: 6e65 6564 2074 6f20 646f 0a23 2074 6865  need to do.# the
+00020740: 2074 696d 656f 7574 2068 6572 652e 2053   timeout here. S
+00020750: 6565 2069 6d70 6c65 6d65 6e74 6174 696f  ee implementatio
+00020760: 6e20 6f66 2072 756e 5f6f 6e65 5f74 6573  n of run_one_tes
+00020770: 7428 2920 666f 7220 6465 7461 696c 732e  t() for details.
+00020780: 0a5f 5445 4152 444f 574e 5f53 4552 5649  ._TEARDOWN_SERVI
+00020790: 4345 203d 2028 0a20 2020 2027 2866 6f72  CE = (.    '(for
+000207a0: 2069 2069 6e20 6073 6571 2031 2032 3060   i in `seq 1 20`
+000207b0: 3b20 646f 270a 2020 2020 2720 2020 2020  ; do'.    '     
+000207c0: 733d 2428 736b 7920 7365 7276 6520 646f  s=$(sky serve do
+000207d0: 776e 202d 7920 7b6e 616d 657d 293b 270a  wn -y {name});'.
+000207e0: 2020 2020 2720 2020 2020 6563 686f 2022      '     echo "
+000207f0: 5472 7969 6e67 2074 6f20 7465 726d 696e  Trying to termin
+00020800: 6174 6520 7b6e 616d 657d 223b 270a 2020  ate {name}";'.  
+00020810: 2020 2720 2020 2020 6563 686f 2022 2473    '     echo "$s
+00020820: 223b 270a 2020 2020 2720 2020 2020 6563  ";'.    '     ec
+00020830: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
+00020840: 7120 2273 6368 6564 756c 6564 2074 6f20  q "scheduled to 
+00020850: 6265 2074 6572 6d69 6e61 7465 645c 7c4e  be terminated\|N
+00020860: 6f20 7365 7276 6963 6520 746f 2074 6572  o service to ter
+00020870: 6d69 6e61 7465 2220 2626 2062 7265 616b  minate" && break
+00020880: 3b27 0a20 2020 2027 2020 2020 2073 6c65  ;'.    '     sle
+00020890: 6570 2031 303b 270a 2020 2020 2720 2020  ep 10;'.    '   
+000208a0: 2020 5b20 2469 202d 6571 2032 3020 5d20    [ $i -eq 20 ] 
+000208b0: 2626 2065 6368 6f20 2246 6169 6c65 6420  && echo "Failed 
+000208c0: 746f 2074 6572 6d69 6e61 7465 2073 6572  to terminate ser
+000208d0: 7669 6365 207b 6e61 6d65 7d22 3b27 0a20  vice {name}";'. 
+000208e0: 2020 2027 646f 6e65 2927 290a 0a5f 5345     'done)').._SE
+000208f0: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
+00020900: 5420 3d20 280a 2020 2020 2765 7870 6f72  T = (.    'expor
+00020910: 7420 4f52 4947 494e 5f53 4b59 5049 4c4f  t ORIGIN_SKYPILO
+00020920: 545f 4445 4255 473d 2453 4b59 5049 4c4f  T_DEBUG=$SKYPILO
+00020930: 545f 4445 4255 473b 2065 7870 6f72 7420  T_DEBUG; export 
+00020940: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+00020950: 3b20 270a 2020 2020 2765 6e64 706f 696e  ; '.    'endpoin
+00020960: 743d 2428 736b 7920 7365 7276 6520 7374  t=$(sky serve st
+00020970: 6174 7573 202d 2d65 6e64 706f 696e 7420  atus --endpoint 
+00020980: 7b6e 616d 657d 293b 2027 0a20 2020 2027  {name}); '.    '
+00020990: 756e 7469 6c20 2120 6563 686f 2022 2465  until ! echo "$e
+000209a0: 6e64 706f 696e 7422 207c 2067 7265 7020  ndpoint" | grep 
+000209b0: 2243 6f6e 7472 6f6c 6c65 7220 6973 2069  "Controller is i
+000209c0: 6e69 7469 616c 697a 696e 6722 3b20 270a  nitializing"; '.
+000209d0: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
+000209e0: 6974 696e 6720 666f 7220 7365 7276 6520  iting for serve 
+000209f0: 656e 6470 6f69 6e74 2074 6f20 6265 2072  endpoint to be r
+00020a00: 6561 6479 2e2e 2e22 3b20 270a 2020 2020  eady..."; '.    
+00020a10: 2773 6c65 6570 2035 3b20 656e 6470 6f69  'sleep 5; endpoi
+00020a20: 6e74 3d24 2873 6b79 2073 6572 7665 2073  nt=$(sky serve s
+00020a30: 7461 7475 7320 2d2d 656e 6470 6f69 6e74  tatus --endpoint
+00020a40: 207b 6e61 6d65 7d29 3b20 646f 6e65 3b20   {name}); done; 
+00020a50: 270a 2020 2020 2765 7870 6f72 7420 534b  '.    'export SK
+00020a60: 5950 494c 4f54 5f44 4542 5547 3d24 4f52  YPILOT_DEBUG=$OR
+00020a70: 4947 494e 5f53 4b59 5049 4c4f 545f 4445  IGIN_SKYPILOT_DE
+00020a80: 4255 473b 2065 6368 6f20 2224 656e 6470  BUG; echo "$endp
+00020a90: 6f69 6e74 2227 290a 0a5f 5345 5256 455f  oint"').._SERVE_
+00020aa0: 5354 4154 5553 5f57 4149 5420 3d20 2827  STATUS_WAIT = ('
+00020ab0: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
+00020ac0: 6174 7573 207b 6e61 6d65 7d29 3b20 270a  atus {name}); '.
+00020ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ae0: 2020 2020 2020 2775 6e74 696c 2021 2065        'until ! e
+00020af0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00020b00: 2243 6f6e 7472 6f6c 6c65 7220 6973 2069  "Controller is i
+00020b10: 6e69 7469 616c 697a 696e 672e 223b 2027  nitializing."; '
+00020b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020b30: 2020 2020 2020 2027 646f 2065 6368 6f20         'do echo 
+00020b40: 2257 6169 7469 6e67 2066 6f72 2073 6572  "Waiting for ser
+00020b50: 7665 2073 7461 7475 7320 746f 2062 6520  ve status to be 
+00020b60: 7265 6164 792e 2e2e 223b 2027 0a20 2020  ready..."; '.   
+00020b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b80: 2020 2027 736c 6565 7020 353b 2073 3d24     'sleep 5; s=$
+00020b90: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+00020ba0: 7320 7b6e 616d 657d 293b 2064 6f6e 653b  s {name}); done;
+00020bb0: 2065 6368 6f20 2224 7322 2729 0a0a 0a64   echo "$s"')...d
+00020bc0: 6566 205f 6765 745f 7265 706c 6963 615f  ef _get_replica_
+00020bd0: 6970 286e 616d 653a 2073 7472 2c20 7265  ip(name: str, re
+00020be0: 706c 6963 615f 6964 3a20 696e 7429 202d  plica_id: int) -
+00020bf0: 3e20 7374 723a 0a20 2020 2072 6574 7572  > str:.    retur
+00020c00: 6e20 2866 2769 707b 7265 706c 6963 615f  n (f'ip{replica_
+00020c10: 6964 7d3d 2428 6563 686f 2022 2473 2220  id}=$(echo "$s" 
+00020c20: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+00020c30: 6627 6177 6b20 227b 5f41 574b 5f41 4c4c  f'awk "{_AWK_ALL
+00020c40: 5f4c 494e 4553 5f42 454c 4f57 5f52 4550  _LINES_BELOW_REP
+00020c50: 4c49 4341 537d 2220 7c20 270a 2020 2020  LICAS}" | '.    
+00020c60: 2020 2020 2020 2020 6627 6772 6570 202d          f'grep -
+00020c70: 4520 227b 6e61 6d65 7d5c 732b 7b72 6570  E "{name}\s+{rep
+00020c80: 6c69 6361 5f69 647d 2220 7c20 270a 2020  lica_id}" | '.  
+00020c90: 2020 2020 2020 2020 2020 6627 6772 6570            f'grep
+00020ca0: 202d 456f 2022 7b5f 4950 5f52 4547 4558   -Eo "{_IP_REGEX
+00020cb0: 7d22 2927 290a 0a0a 6465 6620 5f67 6574  }")')...def _get
+00020cc0: 5f73 6b79 7365 7276 655f 6874 7470 5f74  _skyserve_http_t
+00020cd0: 6573 7428 6e61 6d65 3a20 7374 722c 2063  est(name: str, c
+00020ce0: 6c6f 7564 3a20 7374 722c 0a20 2020 2020  loud: str,.     
+00020cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020d00: 2020 2020 2020 2074 696d 656f 7574 5f6d         timeout_m
+00020d10: 696e 7574 6573 3a20 696e 7429 202d 3e20  inutes: int) -> 
+00020d20: 5465 7374 3a0a 2020 2020 7465 7374 203d  Test:.    test =
+00020d30: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
+00020d40: 2774 6573 742d 736b 7973 6572 7665 2d7b  'test-skyserve-{
+00020d50: 636c 6f75 642e 7265 706c 6163 6528 225f  cloud.replace("_
+00020d60: 222c 2022 2d22 297d 272c 0a20 2020 2020  ", "-")}',.     
+00020d70: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00020d80: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
+00020d90: 2d6e 207b 6e61 6d65 7d20 2d79 2074 6573  -n {name} -y tes
+00020da0: 7473 2f73 6b79 7365 7276 652f 6874 7470  ts/skyserve/http
+00020db0: 2f7b 636c 6f75 647d 2e79 616d 6c27 2c0a  /{cloud}.yaml',.
+00020dc0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00020dd0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00020de0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00020df0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00020e00: 6d3d 3229 2c0a 2020 2020 2020 2020 2020  m=2),.          
+00020e10: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00020e20: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00020e30: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00020e40: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
+00020e50: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
+00020e60: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
+00020e70: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
+00020e80: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00020e90: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
+00020ea0: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
+00020eb0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+00020ec0: 2020 2074 696d 656f 7574 3d74 696d 656f     timeout=timeo
+00020ed0: 7574 5f6d 696e 7574 6573 202a 2036 302c  ut_minutes * 60,
+00020ee0: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
+00020ef0: 6e20 7465 7374 0a0a 0a64 6566 205f 6368  n test...def _ch
+00020f00: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00020f10: 7461 7475 7328 6e61 6d65 3a20 7374 722c  tatus(name: str,
+00020f20: 2063 6865 636b 5f74 7570 6c65 733a 204c   check_tuples: L
+00020f30: 6973 745b 5475 706c 655b 696e 742c 2062  ist[Tuple[int, b
+00020f40: 6f6f 6c2c 0a20 2020 2020 2020 2020 2020  ool,.           
+00020f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f80: 2020 2020 2020 7374 725d 5d29 202d 3e20        str]]) -> 
+00020f90: 7374 723a 0a20 2020 2022 2222 4368 6563  str:.    """Chec
+00020fa0: 6b20 7265 706c 6963 6173 2720 7374 6174  k replicas' stat
+00020fb0: 7573 2061 6e64 2063 6f75 6e74 2069 6e20  us and count in 
+00020fc0: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
+00020fd0: 0a0a 2020 2020 5765 2077 696c 6c20 6368  ..    We will ch
+00020fe0: 6563 6b20 7643 5055 3d32 2c20 6173 2061  eck vCPU=2, as a
+00020ff0: 6c6c 206f 7572 2074 6573 7473 2075 7365  ll our tests use
+00021000: 2076 4350 553d 322e 0a20 2020 200a 2020   vCPU=2..    .  
+00021010: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00021020: 6e61 6d65 3a20 7468 6520 6e61 6d65 206f  name: the name o
+00021030: 6620 7468 6520 7365 7276 6963 650a 2020  f the service.  
+00021040: 2020 2020 2020 6368 6563 6b5f 7475 706c        check_tupl
+00021050: 6573 3a20 4120 6c69 7374 206f 6620 7265  es: A list of re
+00021060: 706c 6963 6120 7072 6f70 6572 7479 2074  plica property t
+00021070: 6f20 6368 6563 6b2e 2045 6163 6820 7475  o check. Each tu
+00021080: 706c 6520 6973 0a20 2020 2020 2020 2020  ple is.         
+00021090: 2020 2028 636f 756e 742c 2069 735f 7370     (count, is_sp
+000210a0: 6f74 2c20 7374 6174 7573 290a 2020 2020  ot, status).    
+000210b0: 2222 220a 2020 2020 6368 6563 6b5f 636d  """.    check_cm
+000210c0: 6420 3d20 2727 0a20 2020 2066 6f72 2063  d = ''.    for c
+000210d0: 6865 636b 5f74 7570 6c65 2069 6e20 6368  heck_tuple in ch
+000210e0: 6563 6b5f 7475 706c 6573 3a0a 2020 2020  eck_tuples:.    
+000210f0: 2020 2020 636f 756e 742c 2069 735f 7370      count, is_sp
+00021100: 6f74 2c20 7374 6174 7573 203d 2063 6865  ot, status = che
+00021110: 636b 5f74 7570 6c65 0a20 2020 2020 2020  ck_tuple.       
+00021120: 2072 6573 6f75 7263 655f 7374 7220 3d20   resource_str = 
+00021130: 2727 0a20 2020 2020 2020 2069 6620 7374  ''.        if st
+00021140: 6174 7573 206e 6f74 2069 6e20 5b27 5045  atus not in ['PE
+00021150: 4e44 494e 4727 2c20 2753 4855 5454 494e  NDING', 'SHUTTIN
+00021160: 475f 444f 574e 270a 2020 2020 2020 2020  G_DOWN'.        
+00021170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021180: 205d 2061 6e64 206e 6f74 2073 7461 7475   ] and not statu
+00021190: 732e 7374 6172 7473 7769 7468 2827 4641  s.startswith('FA
+000211a0: 494c 4544 2729 3a0a 2020 2020 2020 2020  ILED'):.        
+000211b0: 2020 2020 7370 6f74 5f73 7472 203d 2027      spot_str = '
+000211c0: 270a 2020 2020 2020 2020 2020 2020 6966  '.            if
+000211d0: 2069 735f 7370 6f74 3a0a 2020 2020 2020   is_spot:.      
+000211e0: 2020 2020 2020 2020 2020 7370 6f74 5f73            spot_s
+000211f0: 7472 203d 2027 5c5b 5370 6f74 5c5d 270a  tr = '\[Spot\]'.
+00021200: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+00021210: 7572 6365 5f73 7472 203d 2066 2728 7b73  urce_str = f'({s
+00021220: 706f 745f 7374 727d 7643 5055 3d32 2927  pot_str}vCPU=2)'
+00021230: 0a20 2020 2020 2020 2063 6865 636b 5f63  .        check_c
+00021240: 6d64 202b 3d20 2866 2720 6563 686f 2022  md += (f' echo "
+00021250: 2473 2220 7c20 6772 6570 2022 7b72 6573  $s" | grep "{res
+00021260: 6f75 7263 655f 7374 727d 2220 7c20 270a  ource_str}" | '.
+00021270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021280: 2020 2020 2020 6627 6772 6570 2022 7b73        f'grep "{s
+00021290: 7461 7475 737d 2220 7c20 7763 202d 6c20  tatus}" | wc -l 
+000212a0: 7c20 6772 6570 207b 636f 756e 747d 207c  | grep {count} |
+000212b0: 7c20 6578 6974 2031 3b27 290a 2020 2020  | exit 1;').    
+000212c0: 7265 7475 726e 2028 6627 7b5f 5345 5256  return (f'{_SERV
+000212d0: 455f 5354 4154 5553 5f57 4149 542e 666f  E_STATUS_WAIT.fo
+000212e0: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+000212f0: 3b20 6563 686f 2022 2473 223b 2027 202b  ; echo "$s"; ' +
+00021300: 2063 6865 636b 5f63 6d64 290a 0a0a 6465   check_cmd)...de
+00021310: 6620 5f63 6865 636b 5f73 6572 7669 6365  f _check_service
+00021320: 5f76 6572 7369 6f6e 2873 6572 7669 6365  _version(service
+00021330: 5f6e 616d 653a 2073 7472 2c20 7665 7273  _name: str, vers
+00021340: 696f 6e3a 2073 7472 2920 2d3e 2073 7472  ion: str) -> str
+00021350: 3a0a 2020 2020 2320 4772 6570 2074 6865  :.    # Grep the
+00021360: 206c 696e 6573 2062 6566 6f72 6520 2753   lines before 'S
+00021370: 6572 7669 6365 2052 6570 6c69 6361 7327  ervice Replicas'
+00021380: 2061 6e64 2063 6865 636b 2069 6620 7468   and check if th
+00021390: 6520 7365 7276 6963 6520 7665 7273 696f  e service versio
+000213a0: 6e0a 2020 2020 2320 6973 2063 6f72 7265  n.    # is corre
+000213b0: 6374 2e0a 2020 2020 7265 7475 726e 2028  ct..    return (
+000213c0: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
+000213d0: 6570 202d 4231 3030 3020 2253 6572 7669  ep -B1000 "Servi
+000213e0: 6365 2052 6570 6c69 6361 7322 207c 2027  ce Replicas" | '
+000213f0: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
+00021400: 7265 7020 2d45 2022 7b73 6572 7669 6365  rep -E "{service
+00021410: 5f6e 616d 657d 5c73 2b7b 7665 7273 696f  _name}\s+{versio
+00021420: 6e7d 2220 7c7c 2065 7869 7420 313b 2027  n}" || exit 1; '
+00021430: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00021440: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
+00021450: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+00021460: 5f73 6b79 7365 7276 655f 6763 705f 6874  _skyserve_gcp_ht
+00021470: 7470 2829 3a0a 2020 2020 2222 2254 6573  tp():.    """Tes
+00021480: 7420 736b 7973 6572 7665 206f 6e20 4743  t skyserve on GC
+00021490: 5022 2222 0a20 2020 206e 616d 6520 3d20  P""".    name = 
+000214a0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+000214b0: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
+000214c0: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
+000214d0: 705f 7465 7374 286e 616d 652c 2027 6763  p_test(name, 'gc
+000214e0: 7027 2c20 3230 290a 2020 2020 7275 6e5f  p', 20).    run_
+000214f0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00021500: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+00021510: 730a 4070 7974 6573 742e 6d61 726b 2e73  s.@pytest.mark.s
+00021520: 6572 7665 0a64 6566 2074 6573 745f 736b  erve.def test_sk
+00021530: 7973 6572 7665 5f61 7773 5f68 7474 7028  yserve_aws_http(
+00021540: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
+00021550: 6b79 7365 7276 6520 6f6e 2041 5753 2222  kyserve on AWS""
+00021560: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+00021570: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
+00021580: 0a20 2020 2074 6573 7420 3d20 5f67 6574  .    test = _get
+00021590: 5f73 6b79 7365 7276 655f 6874 7470 5f74  _skyserve_http_t
+000215a0: 6573 7428 6e61 6d65 2c20 2761 7773 272c  est(name, 'aws',
+000215b0: 2032 3029 0a20 2020 2072 756e 5f6f 6e65   20).    run_one
+000215c0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+000215d0: 7974 6573 742e 6d61 726b 2e61 7a75 7265  ytest.mark.azure
+000215e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
+000215f0: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
+00021600: 7365 7276 655f 617a 7572 655f 6874 7470  serve_azure_http
+00021610: 2829 3a0a 2020 2020 2222 2254 6573 7420  ():.    """Test 
+00021620: 736b 7973 6572 7665 206f 6e20 417a 7572  skyserve on Azur
+00021630: 6522 2222 0a20 2020 206e 616d 6520 3d20  e""".    name = 
+00021640: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+00021650: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
+00021660: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
+00021670: 705f 7465 7374 286e 616d 652c 2027 617a  p_test(name, 'az
+00021680: 7572 6527 2c20 3330 290a 2020 2020 7275  ure', 30).    ru
+00021690: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000216a0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000216b0: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
+000216c0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+000216d0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+000216e0: 7665 5f6c 6c6d 2867 656e 6572 6963 5f63  ve_llm(generic_c
+000216f0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00021700: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
+00021710: 2077 6974 6820 7265 616c 204c 4c4d 2075   with real LLM u
+00021720: 7365 6361 7365 2222 220a 2020 2020 6e61  secase""".    na
+00021730: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
+00021740: 655f 6e61 6d65 2829 0a0a 2020 2020 6465  e_name()..    de
+00021750: 6620 6765 6e65 7261 7465 5f6c 6c6d 5f74  f generate_llm_t
+00021760: 6573 745f 636f 6d6d 616e 6428 7072 6f6d  est_command(prom
+00021770: 7074 3a20 7374 722c 2065 7870 6563 7465  pt: str, expecte
+00021780: 645f 6f75 7470 7574 3a20 7374 7229 202d  d_output: str) -
+00021790: 3e20 7374 723a 0a20 2020 2020 2020 2070  > str:.        p
+000217a0: 726f 6d70 7420 3d20 7368 6c65 782e 7175  rompt = shlex.qu
+000217b0: 6f74 6528 7072 6f6d 7074 290a 2020 2020  ote(prompt).    
+000217c0: 2020 2020 6578 7065 6374 6564 5f6f 7574      expected_out
+000217d0: 7075 7420 3d20 7368 6c65 782e 7175 6f74  put = shlex.quot
+000217e0: 6528 6578 7065 6374 6564 5f6f 7574 7075  e(expected_outpu
+000217f0: 7429 0a20 2020 2020 2020 2072 6574 7572  t).        retur
+00021800: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
+00021810: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
+00021820: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
+00021830: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
+00021840: 2020 2020 2020 2020 2020 2770 7974 686f            'pytho
+00021850: 6e20 7465 7374 732f 736b 7973 6572 7665  n tests/skyserve
+00021860: 2f6c 6c6d 2f67 6574 5f72 6573 706f 6e73  /llm/get_respons
+00021870: 652e 7079 202d 2d65 6e64 706f 696e 7420  e.py --endpoint 
+00021880: 2465 6e64 706f 696e 7420 270a 2020 2020  $endpoint '.    
+00021890: 2020 2020 2020 2020 6627 2d2d 7072 6f6d          f'--prom
+000218a0: 7074 207b 7072 6f6d 7074 7d20 7c20 6772  pt {prompt} | gr
+000218b0: 6570 207b 6578 7065 6374 6564 5f6f 7574  ep {expected_out
+000218c0: 7075 747d 2729 0a0a 2020 2020 7769 7468  put}')..    with
+000218d0: 206f 7065 6e28 2774 6573 7473 2f73 6b79   open('tests/sky
+000218e0: 7365 7276 652f 6c6c 6d2f 7072 6f6d 7074  serve/llm/prompt
+000218f0: 5f6f 7574 7075 742e 6a73 6f6e 272c 2027  _output.json', '
+00021900: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
+00021910: 2020 656e 636f 6469 6e67 3d27 7574 662d    encoding='utf-
+00021920: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
+00021930: 2020 7072 6f6d 7074 326f 7574 7075 7420    prompt2output 
+00021940: 3d20 6a73 6f6e 2e6c 6f61 6428 6629 0a0a  = json.load(f)..
+00021950: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00021960: 0a20 2020 2020 2020 2066 2774 6573 742d  .        f'test-
+00021970: 736b 7973 6572 7665 2d6c 6c6d 272c 0a20  skyserve-llm',. 
+00021980: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00021990: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+000219a0: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
+000219b0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+000219c0: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
+000219d0: 6b79 7365 7276 652f 6c6c 6d2f 7365 7276  kyserve/llm/serv
+000219e0: 6963 652e 7961 6d6c 272c 0a20 2020 2020  ice.yaml',.     
+000219f0: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
+00021a00: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
+00021a10: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
+00021a20: 2072 6570 6c69 6361 5f6e 756d 3d31 292c   replica_num=1),
+00021a30: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
+00021a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021a50: 6765 6e65 7261 7465 5f6c 6c6d 5f74 6573  generate_llm_tes
+00021a60: 745f 636f 6d6d 616e 6428 7072 6f6d 7074  t_command(prompt
+00021a70: 2c20 6f75 7470 7574 290a 2020 2020 2020  , output).      
+00021a80: 2020 2020 2020 2020 2020 666f 7220 7072            for pr
+00021a90: 6f6d 7074 2c20 6f75 7470 7574 2069 6e20  ompt, output in 
+00021aa0: 7072 6f6d 7074 326f 7574 7075 742e 6974  prompt2output.it
+00021ab0: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
+00021ac0: 2020 5d2c 0a20 2020 2020 2020 205d 2c0a    ],.        ],.
+00021ad0: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
+00021ae0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
+00021af0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
+00021b00: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
+00021b10: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+00021b20: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00021b30: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00021b40: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+00021b50: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+00021b60: 745f 736b 7973 6572 7665 5f73 706f 745f  t_skyserve_spot_
+00021b70: 7265 636f 7665 7279 2829 3a0a 2020 2020  recovery():.    
+00021b80: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+00021b90: 6963 655f 6e61 6d65 2829 0a20 2020 207a  ice_name().    z
+00021ba0: 6f6e 6520 3d20 2775 732d 6365 6e74 7261  one = 'us-centra
+00021bb0: 6c31 2d61 270a 0a20 2020 2074 6573 7420  l1-a'..    test 
+00021bc0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00021bd0: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
+00021be0: 7370 6f74 2d72 6563 6f76 6572 792d 6763  spot-recovery-gc
+00021bf0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+00021c00: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00021c10: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
+00021c20: 657d 202d 7920 7465 7374 732f 736b 7973  e} -y tests/skys
+00021c30: 6572 7665 2f73 706f 742f 7265 636f 7665  erve/spot/recove
+00021c40: 7279 2e79 616d 6c27 2c0a 2020 2020 2020  ry.yaml',.      
+00021c50: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+00021c60: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00021c70: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00021c80: 7265 706c 6963 615f 6e75 6d3d 3129 2c0a  replica_num=1),.
+00021c90: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00021ca0: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00021cb0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00021cc0: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
+00021cd0: 2020 2020 2020 2763 7572 6c20 2d4c 2068        'curl -L h
+00021ce0: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
+00021cf0: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
+00021d00: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
+00021d10: 2020 2020 2020 2020 205f 7465 726d 696e           _termin
+00021d20: 6174 655f 6763 705f 7265 706c 6963 6128  ate_gcp_replica(
+00021d30: 6e61 6d65 2c20 7a6f 6e65 2c20 3129 2c0a  name, zone, 1),.
+00021d40: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00021d50: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00021d60: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00021d70: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00021d80: 6d3d 3129 2c0a 2020 2020 2020 2020 2020  m=1),.          
+00021d90: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00021da0: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00021db0: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00021dc0: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
+00021dd0: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
+00021de0: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
+00021df0: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
+00021e00: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00021e10: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
+00021e20: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
+00021e30: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+00021e40: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00021e50: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00021e60: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00021e70: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00021e80: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
+00021e90: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00021ea0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+00021eb0: 7665 5f62 6173 655f 6f6e 6465 6d61 6e64  ve_base_ondemand
+00021ec0: 5f66 616c 6c62 6163 6b28 6765 6e65 7269  _fallback(generi
+00021ed0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00021ee0: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00021ef0: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+00021f00: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00021f10: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
+00021f20: 7973 6572 7665 2d62 6173 652d 6f6e 6465  yserve-base-onde
+00021f30: 6d61 6e64 2d66 616c 6c62 6163 6b27 2c0a  mand-fallback',.
+00021f40: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00021f50: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00021f60: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
+00021f70: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00021f80: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00021f90: 736b 7973 6572 7665 2f73 706f 742f 6261  skyserve/spot/ba
+00021fa0: 7365 5f6f 6e64 656d 616e 645f 6661 6c6c  se_ondemand_fall
+00021fb0: 6261 636b 2e79 616d 6c27 2c0a 2020 2020  back.yaml',.    
+00021fc0: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00021fd0: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00021fe0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00021ff0: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
+00022000: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
+00022010: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+00022020: 7374 6174 7573 286e 616d 652c 205b 2831  status(name, [(1
+00022030: 2c20 5472 7565 2c20 2752 4541 4459 2729  , True, 'READY')
+00022040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022060: 2020 2020 2020 2020 2020 2020 2020 2831                (1
+00022070: 2c20 4661 6c73 652c 2027 5245 4144 5927  , False, 'READY'
+00022080: 295d 292c 0a20 2020 2020 2020 205d 2c0a  )]),.        ],.
+00022090: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
+000220a0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
+000220b0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
+000220c0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+000220d0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+000220e0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000220f0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00022100: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+00022110: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+00022120: 745f 736b 7973 6572 7665 5f64 796e 616d  t_skyserve_dynam
+00022130: 6963 5f6f 6e64 656d 616e 645f 6661 6c6c  ic_ondemand_fall
+00022140: 6261 636b 2829 3a0a 2020 2020 6e61 6d65  back():.    name
+00022150: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00022160: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
+00022170: 3d20 2775 732d 6365 6e74 7261 6c31 2d61  = 'us-central1-a
+00022180: 270a 0a20 2020 2074 6573 7420 3d20 5465  '..    test = Te
+00022190: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+000221a0: 7374 2d73 6b79 7365 7276 652d 6479 6e61  st-skyserve-dyna
+000221b0: 6d69 632d 6f6e 6465 6d61 6e64 2d66 616c  mic-ondemand-fal
+000221c0: 6c62 6163 6b27 2c0a 2020 2020 2020 2020  lback',.        
+000221d0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000221e0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+000221f0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+00022200: 6370 202d 7920 7465 7374 732f 736b 7973  cp -y tests/skys
+00022210: 6572 7665 2f73 706f 742f 6479 6e61 6d69  erve/spot/dynami
+00022220: 635f 6f6e 6465 6d61 6e64 5f66 616c 6c62  c_ondemand_fallb
+00022230: 6163 6b2e 7961 6d6c 272c 0a20 2020 2020  ack.yaml',.     
+00022240: 2020 2020 2020 2066 2773 6c65 6570 2034         f'sleep 4
+00022250: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00022260: 2320 3220 6f6e 2d64 656d 616e 6420 2870  # 2 on-demand (p
+00022270: 726f 7669 7369 6f6e 696e 6729 202b 2032  rovisioning) + 2
+00022280: 2053 706f 7420 2870 726f 7669 7369 6f6e   Spot (provision
+00022290: 696e 6729 2e0a 2020 2020 2020 2020 2020  ing)..          
+000222a0: 2020 6627 7b5f 5345 5256 455f 5354 4154    f'{_SERVE_STAT
+000222b0: 5553 5f57 4149 542e 666f 726d 6174 286e  US_WAIT.format(n
+000222c0: 616d 653d 6e61 6d65 297d 3b20 6563 686f  ame=name)}; echo
+000222d0: 2022 2473 223b 270a 2020 2020 2020 2020   "$s";'.        
+000222e0: 2020 2020 2765 6368 6f20 2224 7322 207c      'echo "$s" |
+000222f0: 2067 7265 7020 2d71 2022 302f 3422 207c   grep -q "0/4" |
+00022300: 7c20 6578 6974 2031 272c 0a20 2020 2020  | exit 1',.     
+00022310: 2020 2020 2020 2023 2057 6169 7420 666f         # Wait fo
+00022320: 7220 7468 6520 7072 6f76 6973 696f 6e69  r the provisioni
+00022330: 6e67 2073 7461 7274 730a 2020 2020 2020  ng starts.      
+00022340: 2020 2020 2020 6627 736c 6565 7020 3430        f'sleep 40
+00022350: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00022360: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
+00022370: 5f73 7461 7475 7328 6e61 6d65 2c20 5b0a  _status(name, [.
+00022380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022390: 2832 2c20 5472 7565 2c20 5f53 4552 5649  (2, True, _SERVI
+000223a0: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
+000223b0: 5455 535f 5245 4745 5820 2b20 275c 7c52  TUS_REGEX + '\|R
+000223c0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+000223d0: 2020 2020 2020 2020 2832 2c20 4661 6c73          (2, Fals
+000223e0: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
+000223f0: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
+00022400: 4558 202b 2027 5c7c 5348 5554 5449 4e47  EX + '\|SHUTTING
+00022410: 5f44 4f57 4e27 290a 2020 2020 2020 2020  _DOWN').        
+00022420: 2020 2020 5d29 2c0a 0a20 2020 2020 2020      ]),..       
+00022430: 2020 2020 2023 2057 6169 7420 756e 7469       # Wait unti
+00022440: 6c20 3220 7370 6f74 2069 6e73 7461 6e63  l 2 spot instanc
+00022450: 6573 2061 7265 2072 6561 6479 2e0a 2020  es are ready..  
+00022460: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00022470: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00022480: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+00022490: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+000224a0: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
+000224b0: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+000224c0: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
+000224d0: 2832 2c20 5472 7565 2c20 2752 4541 4459  (2, True, 'READY
+000224e0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+000224f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022510: 2830 2c20 4661 6c73 652c 2027 2729 5d29  (0, False, '')])
+00022520: 2c0a 2020 2020 2020 2020 2020 2020 5f74  ,.            _t
+00022530: 6572 6d69 6e61 7465 5f67 6370 5f72 6570  erminate_gcp_rep
+00022540: 6c69 6361 286e 616d 652c 207a 6f6e 652c  lica(name, zone,
+00022550: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
+00022560: 2066 2773 6c65 6570 2034 3027 2c0a 2020   f'sleep 40',.  
+00022570: 2020 2020 2020 2020 2020 2320 3120 6f6e            # 1 on
+00022580: 2d64 656d 616e 6420 2870 726f 7669 7369  -demand (provisi
+00022590: 6f6e 696e 6729 202b 2031 2053 706f 7420  oning) + 1 Spot 
+000225a0: 2872 6561 6479 2920 2b20 3120 7370 6f74  (ready) + 1 spot
+000225b0: 2028 7072 6f76 6973 696f 6e69 6e67 292e   (provisioning).
+000225c0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000225d0: 5f53 4552 5645 5f53 5441 5455 535f 5741  _SERVE_STATUS_WA
+000225e0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+000225f0: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
+00022600: 2020 2020 2027 6563 686f 2022 2473 2220       'echo "$s" 
+00022610: 7c20 6772 6570 202d 7120 2231 2f33 2227  | grep -q "1/3"'
+00022620: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
+00022630: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+00022640: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
+00022650: 2020 2020 2020 2020 6e61 6d65 2c20 5b28          name, [(
+00022660: 312c 2054 7275 652c 2027 5245 4144 5927  1, True, 'READY'
+00022670: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00022680: 2020 2020 2020 2020 2020 2831 2c20 5472            (1, Tr
+00022690: 7565 2c20 5f53 4552 5649 4345 5f4c 4155  ue, _SERVICE_LAU
+000226a0: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
+000226b0: 4745 5829 2c0a 2020 2020 2020 2020 2020  GEX),.          
+000226c0: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+000226d0: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
+000226e0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
+000226f0: 535f 5245 4745 5829 5d29 2c0a 0a20 2020  S_REGEX)]),..   
+00022700: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
+00022710: 756e 7469 6c20 3220 7370 6f74 2069 6e73  until 2 spot ins
+00022720: 7461 6e63 6573 2061 7265 2072 6561 6479  tances are ready
+00022730: 2e0a 2020 2020 2020 2020 2020 2020 5f53  ..            _S
+00022740: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
+00022750: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
+00022760: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
+00022770: 6e75 6d3d 3229 2c0a 2020 2020 2020 2020  num=2),.        
+00022780: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
+00022790: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+000227a0: 652c 205b 2832 2c20 5472 7565 2c20 2752  e, [(2, True, 'R
+000227b0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+000227c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000227d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000227e0: 2020 2020 2830 2c20 4661 6c73 652c 2027      (0, False, '
+000227f0: 2729 5d29 2c0a 2020 2020 2020 2020 5d2c  ')]),.        ],
+00022800: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00022810: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00022820: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00022830: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00022840: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00022850: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00022860: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00022870: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
+00022880: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+00022890: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
+000228a0: 7365 7276 655f 7573 6572 5f62 7567 5f72  serve_user_bug_r
+000228b0: 6573 7461 7274 2867 656e 6572 6963 5f63  estart(generic_c
+000228c0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+000228d0: 2222 2254 6573 7473 2074 6861 7420 7765  """Tests that we
+000228e0: 2072 6573 7461 7274 2074 6865 2073 6572   restart the ser
+000228f0: 7669 6365 2061 6674 6572 2075 7365 7220  vice after user 
+00022900: 6275 672e 2222 220a 2020 2020 2320 544f  bug.""".    # TO
+00022910: 444f 287a 6877 7529 3a20 7468 6973 2062  DO(zhwu): this b
+00022920: 6568 6176 696f 7220 6e65 6564 7320 736f  ehavior needs so
+00022930: 6d65 2072 6574 6869 6e6b 696e 672e 0a20  me rethinking.. 
+00022940: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00022950: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+00022960: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00022970: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
+00022980: 7973 6572 7665 2d75 7365 722d 6275 672d  yserve-user-bug-
+00022990: 7265 7374 6172 7427 2c0a 2020 2020 2020  restart',.      
+000229a0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+000229b0: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
+000229c0: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
+000229d0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+000229e0: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
+000229f0: 7665 2f72 6573 7461 7274 2f75 7365 725f  ve/restart/user_
+00022a00: 6275 672e 7961 6d6c 272c 0a20 2020 2020  bug.yaml',.     
+00022a10: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00022a20: 2073 6572 7665 2073 7461 7475 7320 7b6e   serve status {n
+00022a30: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+00022a40: 3b27 0a20 2020 2020 2020 2020 2020 2027  ;'.            '
+00022a50: 756e 7469 6c20 6563 686f 2022 2473 2220  until echo "$s" 
+00022a60: 7c20 6772 6570 202d 4120 3130 3020 2253  | grep -A 100 "S
+00022a70: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
+00022a80: 207c 2067 7265 7020 2253 4855 5454 494e   | grep "SHUTTIN
+00022a90: 475f 444f 574e 223b 2027 0a20 2020 2020  G_DOWN"; '.     
+00022aa0: 2020 2020 2020 2027 646f 2065 6368 6f20         'do echo 
+00022ab0: 2257 6169 7469 6e67 2066 6f72 2066 6972  "Waiting for fir
+00022ac0: 7374 2073 6572 7669 6365 2074 6f20 6265  st service to be
+00022ad0: 2053 4855 5454 494e 4720 444f 574e 2e2e   SHUTTING DOWN..
+00022ae0: 2e22 3b20 270a 2020 2020 2020 2020 2020  ."; '.          
+00022af0: 2020 6627 736c 6565 7020 353b 2073 3d24    f'sleep 5; s=$
+00022b00: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+00022b10: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
+00022b20: 2224 7322 3b20 646f 6e65 3b20 272c 0a20  "$s"; done; ',. 
+00022b30: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00022b40: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+00022b50: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
+00022b60: 2224 7322 3b27 0a20 2020 2020 2020 2020  "$s";'.         
+00022b70: 2020 2027 756e 7469 6c20 6563 686f 2022     'until echo "
+00022b80: 2473 2220 7c20 6772 6570 202d 4120 3130  $s" | grep -A 10
+00022b90: 3020 2253 6572 7669 6365 2052 6570 6c69  0 "Service Repli
+00022ba0: 6361 7322 207c 2067 7265 7020 2246 4149  cas" | grep "FAI
+00022bb0: 4c45 4422 3b20 270a 2020 2020 2020 2020  LED"; '.        
+00022bc0: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
+00022bd0: 6974 696e 6720 666f 7220 6669 7273 7420  iting for first 
+00022be0: 7365 7276 6963 6520 746f 2062 6520 4641  service to be FA
+00022bf0: 494c 4544 2e2e 2e22 3b20 270a 2020 2020  ILED..."; '.    
+00022c00: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
+00022c10: 353b 2073 3d24 2873 6b79 2073 6572 7665  5; s=$(sky serve
+00022c20: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
+00022c30: 2065 6368 6f20 2224 7322 3b20 646f 6e65   echo "$s"; done
+00022c40: 3b20 6563 686f 2022 2473 223b 2027 0a20  ; echo "$s"; '. 
+00022c50: 2020 2020 2020 2020 2020 202b 205f 6368             + _ch
+00022c60: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00022c70: 7461 7475 7328 6e61 6d65 2c20 5b28 312c  tatus(name, [(1,
+00022c80: 2054 7275 652c 2027 4641 494c 4544 2729   True, 'FAILED')
+00022c90: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
+00022ca0: 2023 2055 7365 7220 6275 6720 6661 696c   # User bug fail
+00022cb0: 7572 6520 7769 6c6c 2063 6175 7365 206e  ure will cause n
+00022cc0: 6f20 6675 7274 6865 7220 7363 616c 696e  o further scalin
+00022cd0: 672e 0a20 2020 2020 2020 2020 2020 2066  g..            f
+00022ce0: 2765 6368 6f20 2224 7322 207c 2067 7265  'echo "$s" | gre
+00022cf0: 7020 2d41 2031 3030 2022 5365 7276 6963  p -A 100 "Servic
+00022d00: 6520 5265 706c 6963 6173 2220 7c20 6772  e Replicas" | gr
+00022d10: 6570 2022 7b6e 616d 657d 2220 7c20 7763  ep "{name}" | wc
+00022d20: 202d 6c20 7c20 6772 6570 2031 3b20 270a   -l | grep 1; '.
+00022d30: 2020 2020 2020 2020 2020 2020 6627 6563              f'ec
+00022d40: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
+00022d50: 4220 3130 3020 224e 4f5f 5245 504c 4943  B 100 "NO_REPLIC
+00022d60: 4122 207c 2067 7265 7020 2230 2f30 2227  A" | grep "0/0"'
+00022d70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00022d80: 736b 7920 7365 7276 6520 7570 6461 7465  sky serve update
+00022d90: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00022da0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00022db0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00022dc0: 652f 6175 746f 5f72 6573 7461 7274 2e79  e/auto_restart.y
+00022dd0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00022de0: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00022df0: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00022e00: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00022e10: 2020 2020 2020 2020 2020 2020 2775 6e74              'unt
+00022e20: 696c 2063 7572 6c20 2d4c 2068 7474 703a  il curl -L http:
+00022e30: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
+00022e40: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
+00022e50: 2068 6572 6521 223b 2064 6f20 736c 6565   here!"; do slee
+00022e60: 7020 323b 2064 6f6e 653b 2073 6c65 6570  p 2; done; sleep
+00022e70: 2032 3b20 270a 2020 2020 2020 2020 2020   2; '.          
+00022e80: 2020 2b20 5f63 6865 636b 5f72 6570 6c69    + _check_repli
+00022e90: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+00022ea0: 652c 205b 2831 2c20 4661 6c73 652c 2027  e, [(1, False, '
+00022eb0: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
+00022ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ee0: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
+00022ef0: 2c20 2746 4149 4c45 4427 295d 292c 0a20  , 'FAILED')]),. 
+00022f00: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00022f10: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
+00022f20: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
+00022f30: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+00022f40: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
+00022f50: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00022f60: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00022f70: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
+00022f80: 650a 4070 7974 6573 742e 6d61 726b 2e6e  e.@pytest.mark.n
+00022f90: 6f5f 6b75 6265 726e 6574 6573 0a64 6566  o_kubernetes.def
+00022fa0: 2074 6573 745f 736b 7973 6572 7665 5f6c   test_skyserve_l
+00022fb0: 6f61 645f 6261 6c61 6e63 6572 2867 656e  oad_balancer(gen
+00022fc0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00022fd0: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
+00022fe0: 7973 6572 7665 206c 6f61 6420 6261 6c61  yserve load bala
+00022ff0: 6e63 6572 2072 6f75 6e64 2d72 6f62 696e  ncer round-robin
+00023000: 2070 6f6c 6963 7922 2222 0a20 2020 206e   policy""".    n
+00023010: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+00023020: 6365 5f6e 616d 6528 290a 2020 2020 7465  ce_name().    te
+00023030: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00023040: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00023050: 7665 2d6c 6f61 642d 6261 6c61 6e63 6572  ve-load-balancer
+00023060: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00023070: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00023080: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
+00023090: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+000230a0: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
+000230b0: 7473 2f73 6b79 7365 7276 652f 6c6f 6164  ts/skyserve/load
+000230c0: 5f62 616c 616e 6365 722f 7365 7276 6963  _balancer/servic
+000230d0: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
+000230e0: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
+000230f0: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
+00023100: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
+00023110: 6570 6c69 6361 5f6e 756d 3d33 292c 0a20  eplica_num=3),. 
+00023120: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00023130: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
+00023140: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+00023150: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
+00023160: 2020 2020 2066 277b 5f53 4552 5645 5f53       f'{_SERVE_S
+00023170: 5441 5455 535f 5741 4954 2e66 6f72 6d61  TATUS_WAIT.forma
+00023180: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
+00023190: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000231a0: 5f67 6574 5f72 6570 6c69 6361 5f69 7028  _get_replica_ip(
+000231b0: 6e61 6d65 2c20 3129 7d3b 2027 0a20 2020  name, 1)}; '.   
+000231c0: 2020 2020 2020 2020 2066 277b 5f67 6574           f'{_get
+000231d0: 5f72 6570 6c69 6361 5f69 7028 6e61 6d65  _replica_ip(name
+000231e0: 2c20 3229 7d3b 207b 5f67 6574 5f72 6570  , 2)}; {_get_rep
+000231f0: 6c69 6361 5f69 7028 6e61 6d65 2c20 3329  lica_ip(name, 3)
+00023200: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+00023210: 2027 7079 7468 6f6e 2074 6573 7473 2f73   'python tests/s
+00023220: 6b79 7365 7276 652f 6c6f 6164 5f62 616c  kyserve/load_bal
+00023230: 616e 6365 722f 7465 7374 5f72 6f75 6e64  ancer/test_round
+00023240: 5f72 6f62 696e 2e70 7920 270a 2020 2020  _robin.py '.    
+00023250: 2020 2020 2020 2020 272d 2d65 6e64 706f          '--endpo
+00023260: 696e 7420 2465 6e64 706f 696e 7420 2d2d  int $endpoint --
+00023270: 7265 706c 6963 612d 6e75 6d20 3320 2d2d  replica-num 3 --
+00023280: 7265 706c 6963 612d 6970 7320 2469 7031  replica-ips $ip1
+00023290: 2024 6970 3220 2469 7033 272c 0a20 2020   $ip2 $ip3',.   
+000232a0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000232b0: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
+000232c0: 452e 666f 726d 6174 286e 616d 653d 6e61  E.format(name=na
+000232d0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+000232e0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+000232f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00023300: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00023310: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
+00023320: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
+00023330: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00023340: 5f6b 7562 6572 6e65 7465 730a 6465 6620  _kubernetes.def 
+00023350: 7465 7374 5f73 6b79 7365 7276 655f 6175  test_skyserve_au
+00023360: 746f 5f72 6573 7461 7274 2829 3a0a 2020  to_restart():.  
+00023370: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
+00023380: 7665 2077 6974 6820 6175 746f 2072 6573  ve with auto res
+00023390: 7461 7274 2222 220a 2020 2020 6e61 6d65  tart""".    name
+000233a0: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+000233b0: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
+000233c0: 3d20 2775 732d 6365 6e74 7261 6c31 2d61  = 'us-central1-a
+000233d0: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
+000233e0: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
+000233f0: 742d 736b 7973 6572 7665 2d61 7574 6f2d  t-skyserve-auto-
+00023400: 7265 7374 6172 7427 2c0a 2020 2020 2020  restart',.      
+00023410: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00023420: 2320 544f 444f 2874 6961 6e29 3a20 7765  # TODO(tian): we
+00023430: 2063 616e 2064 796e 616d 6963 616c 6c79   can dynamically
+00023440: 2067 656e 6572 6174 6520 5941 4d4c 2066   generate YAML f
+00023450: 726f 6d20 7465 6d70 6c61 7465 2074 6f0a  rom template to.
+00023460: 2020 2020 2020 2020 2020 2020 2320 6176              # av
+00023470: 6f69 6420 6d61 696e 7461 696e 696e 6720  oid maintaining 
+00023480: 746f 6f20 6d61 6e79 2059 414d 4c20 6669  too many YAML fi
+00023490: 6c65 730a 2020 2020 2020 2020 2020 2020  les.            
+000234a0: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
+000234b0: 6e20 7b6e 616d 657d 202d 7920 7465 7374  n {name} -y test
+000234c0: 732f 736b 7973 6572 7665 2f61 7574 6f5f  s/skyserve/auto_
+000234d0: 7265 7374 6172 742e 7961 6d6c 272c 0a20  restart.yaml',. 
+000234e0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+000234f0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+00023500: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+00023510: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+00023520: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
+00023530: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+00023540: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+00023550: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
+00023560: 2020 2020 2020 2020 2020 2027 6375 726c             'curl
+00023570: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
+00023580: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
+00023590: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+000235a0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000235b0: 736c 6565 7020 666f 7220 3230 2073 6563  sleep for 20 sec
+000235c0: 6f6e 6473 2028 696e 6974 6961 6c20 6465  onds (initial de
+000235d0: 6c61 7929 2074 6f20 6d61 6b65 2073 7572  lay) to make sur
+000235e0: 6520 6974 2077 696c 6c0a 2020 2020 2020  e it will.      
+000235f0: 2020 2020 2020 2320 6265 2072 6573 7461        # be resta
+00023600: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
+00023610: 2066 2773 6c65 6570 2032 3027 2c0a 2020   f'sleep 20',.  
+00023620: 2020 2020 2020 2020 2020 5f74 6572 6d69            _termi
+00023630: 6e61 7465 5f67 6370 5f72 6570 6c69 6361  nate_gcp_replica
+00023640: 286e 616d 652c 207a 6f6e 652c 2031 292c  (name, zone, 1),
+00023650: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+00023660: 6169 7420 666f 7220 636f 6e73 6563 7574  ait for consecut
+00023670: 6976 6520 6661 696c 7572 6520 7469 6d65  ive failure time
+00023680: 6f75 7420 7061 7373 6564 2e0a 2020 2020  out passed..    
+00023690: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+000236a0: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
+000236b0: 7573 696e 6720 7370 6f74 2c20 6974 2077  using spot, it w
+000236c0: 6f6e 2774 2063 6865 636b 2074 6865 2063  on't check the c
+000236d0: 6c75 7374 6572 2073 7461 7475 730a 2020  luster status.  
+000236e0: 2020 2020 2020 2020 2020 2320 6f6e 2074            # on t
+000236f0: 6865 2063 6c6f 7564 2028 7369 6e63 6520  he cloud (since 
+00023700: 6d61 6e75 616c 2073 6875 7464 6f77 6e20  manual shutdown 
+00023710: 6973 206e 6f74 2061 2063 6f6d 6d6f 6e20  is not a common 
+00023720: 6265 6861 7669 6f72 2061 6e64 2073 7563  behavior and suc
+00023730: 680a 2020 2020 2020 2020 2020 2020 2320  h.            # 
+00023740: 7175 6572 6965 7320 7461 6b65 7320 6120  queries takes a 
+00023750: 6c6f 7420 6f66 2074 696d 6529 2e20 496e  lot of time). In
+00023760: 7374 6561 642c 2077 6520 7468 696e 6b20  stead, we think 
+00023770: 636f 6e74 696e 756f 7573 2033 206d 696e  continuous 3 min
+00023780: 2070 726f 6265 0a20 2020 2020 2020 2020   probe.         
+00023790: 2020 2023 2066 6169 6c75 7265 2069 7320     # failure is 
+000237a0: 6e6f 7420 6120 7465 6d70 6f72 6172 7920  not a temporary 
+000237b0: 7072 6f62 6c65 6d20 6275 7420 696e 6465  problem but inde
+000237c0: 6564 2061 2066 6169 6c75 7265 2e0a 2020  ed a failure..  
+000237d0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+000237e0: 2031 3830 272c 0a20 2020 2020 2020 2020   180',.         
+000237f0: 2020 2023 2057 6520 6361 6e6e 6f74 2075     # We cannot u
+00023800: 7365 205f 5345 5256 455f 5741 4954 5f55  se _SERVE_WAIT_U
+00023810: 4e54 494c 5f52 4541 4459 3b20 7468 6572  NTIL_READY; ther
+00023820: 6520 7769 6c6c 2062 6520 6120 696e 7465  e will be a inte
+00023830: 726d 6564 6961 7465 2074 696d 650a 2020  rmediate time.  
+00023840: 2020 2020 2020 2020 2020 2320 7468 6174            # that
+00023850: 2074 6865 206f 7574 7075 7420 6f66 2060   the output of `
+00023860: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
+00023870: 6020 7368 6f77 7320 4641 494c 4544 2061  ` shows FAILED a
+00023880: 6e64 2074 6869 7320 7374 6174 7573 2077  nd this status w
+00023890: 696c 6c0a 2020 2020 2020 2020 2020 2020  ill.            
+000238a0: 2320 6361 7573 6520 5f53 4552 5645 5f57  # cause _SERVE_W
+000238b0: 4149 545f 554e 5449 4c5f 5245 4144 5920  AIT_UNTIL_READY 
+000238c0: 746f 2065 6172 6c79 2071 7569 742e 0a20  to early quit.. 
+000238d0: 2020 2020 2020 2020 2020 2027 2877 6869             '(whi
+000238e0: 6c65 2074 7275 653b 2064 6f27 0a20 2020  le true; do'.   
+000238f0: 2020 2020 2020 2020 2066 2720 2020 206f           f'    o
+00023900: 7574 7075 743d 2428 736b 7920 7365 7276  utput=$(sky serv
+00023910: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
+00023920: 3b27 0a20 2020 2020 2020 2020 2020 2027  ;'.            '
+00023930: 2020 2020 2065 6368 6f20 2224 6f75 7470       echo "$outp
+00023940: 7574 2220 7c20 6772 6570 202d 7120 2231  ut" | grep -q "1
+00023950: 2f31 2220 2626 2062 7265 616b 3b27 0a20  /1" && break;'. 
+00023960: 2020 2020 2020 2020 2020 2027 2020 2020             '    
+00023970: 2073 6c65 6570 2031 303b 270a 2020 2020   sleep 10;'.    
+00023980: 2020 2020 2020 2020 6627 646f 6e65 293b          f'done);
+00023990: 2073 6c65 6570 207b 7365 7276 652e 4c42   sleep {serve.LB
+000239a0: 5f43 4f4e 5452 4f4c 4c45 525f 5359 4e43  _CONTROLLER_SYNC
+000239b0: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
+000239c0: 537d 3b27 2c0a 2020 2020 2020 2020 2020  S};',.          
+000239d0: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+000239e0: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+000239f0: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00023a00: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
+00023a10: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
+00023a20: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
+00023a30: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
+00023a40: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00023a50: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
+00023a60: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
+00023a70: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+00023a80: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00023a90: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00023aa0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00023ab0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00023ac0: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
+00023ad0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00023ae0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+00023af0: 7665 5f63 616e 6365 6c28 6765 6e65 7269  ve_cancel(generi
+00023b00: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00023b10: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+00023b20: 7276 6520 7769 7468 2063 616e 6365 6c22  rve with cancel"
+00023b30: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+00023b40: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
+00023b50: 290a 0a20 2020 2074 6573 7420 3d20 5465  )..    test = Te
+00023b60: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+00023b70: 7374 2d73 6b79 7365 7276 652d 6361 6e63  st-skyserve-canc
+00023b80: 656c 272c 0a20 2020 2020 2020 205b 0a20  el',.        [. 
+00023b90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00023ba0: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
+00023bb0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00023bc0: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
+00023bd0: 6573 7473 2f73 6b79 7365 7276 652f 6361  ests/skyserve/ca
+00023be0: 6e63 656c 2f63 616e 6365 6c2e 7961 6d6c  ncel/cancel.yaml
+00023bf0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00023c00: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
+00023c10: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
+00023c20: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
+00023c30: 5f6e 756d 3d31 292c 0a20 2020 2020 2020  _num=1),.       
+00023c40: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+00023c50: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+00023c60: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+00023c70: 2070 7974 686f 6e33 2027 0a20 2020 2020   python3 '.     
+00023c80: 2020 2020 2020 2027 7465 7374 732f 736b         'tests/sk
+00023c90: 7973 6572 7665 2f63 616e 6365 6c2f 7365  yserve/cancel/se
+00023ca0: 6e64 5f63 616e 6365 6c5f 7265 7175 6573  nd_cancel_reques
+00023cb0: 742e 7079 2027 0a20 2020 2020 2020 2020  t.py '.         
+00023cc0: 2020 2027 2d2d 656e 6470 6f69 6e74 2024     '--endpoint $
+00023cd0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00023ce0: 2252 6571 7565 7374 2077 6173 2063 616e  "Request was can
+00023cf0: 6365 6c6c 6564 2227 2c0a 2020 2020 2020  celled"',.      
+00023d00: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+00023d10: 7365 7276 6520 6c6f 6773 207b 6e61 6d65  serve logs {name
+00023d20: 7d20 3120 2d2d 6e6f 2d66 6f6c 6c6f 7729  } 1 --no-follow)
+00023d30: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00023d40: 2775 6e74 696c 2021 2065 6368 6f20 2224  'until ! echo "$
+00023d50: 7322 207c 2067 7265 7020 2250 6c65 6173  s" | grep "Pleas
+00023d60: 6520 7761 6974 2066 6f72 2074 6865 2063  e wait for the c
+00023d70: 6f6e 7472 6f6c 6c65 7220 746f 2062 6522  ontroller to be"
+00023d80: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00023d90: 2764 6f20 6563 686f 2022 5761 6974 696e  'do echo "Waitin
+00023da0: 6720 666f 7220 7365 7276 6520 6c6f 6773  g for serve logs
+00023db0: 223b 2073 6c65 6570 2031 303b 2027 0a20  "; sleep 10; '. 
+00023dc0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00023dd0: 2873 6b79 2073 6572 7665 206c 6f67 7320  (sky serve logs 
+00023de0: 7b6e 616d 657d 2031 202d 2d6e 6f2d 666f  {name} 1 --no-fo
+00023df0: 6c6c 6f77 293b 2064 6f6e 653b 2027 0a20  llow); done; '. 
+00023e00: 2020 2020 2020 2020 2020 2027 6563 686f             'echo
+00023e10: 2022 2473 223b 2065 6368 6f20 2224 7322   "$s"; echo "$s"
+00023e20: 207c 2067 7265 7020 2243 6c69 656e 7420   | grep "Client 
+00023e30: 6469 7363 6f6e 6e65 6374 6564 2c20 7374  disconnected, st
+00023e40: 6f70 7069 6e67 2063 6f6d 7075 7461 7469  opping computati
+00023e50: 6f6e 2227 2c0a 2020 2020 2020 2020 5d2c  on"',.        ],
+00023e60: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00023e70: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00023e80: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00023e90: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00023ea0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00023eb0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00023ec0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00023ed0: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
+00023ee0: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+00023ef0: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
+00023f00: 7365 7276 655f 7570 6461 7465 2867 656e  serve_update(gen
+00023f10: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00023f20: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
+00023f30: 7973 6572 7665 2077 6974 6820 7570 6461  yserve with upda
+00023f40: 7465 2222 220a 2020 2020 6e61 6d65 203d  te""".    name =
+00023f50: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+00023f60: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00023f70: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
+00023f80: 7465 7374 2d73 6b79 7365 7276 652d 7570  test-skyserve-up
+00023f90: 6461 7465 272c 0a20 2020 2020 2020 205b  date',.        [
+00023fa0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00023fb0: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
+00023fc0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00023fd0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
+00023fe0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+00023ff0: 7570 6461 7465 2f6f 6c64 2e79 616d 6c27  update/old.yaml'
+00024000: 2c0a 2020 2020 2020 2020 2020 2020 5f53  ,.            _S
+00024010: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
+00024020: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
+00024030: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
+00024040: 6e75 6d3d 3229 2c0a 2020 2020 2020 2020  num=2),.        
+00024050: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
+00024060: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
+00024070: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+00024080: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+00024090: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+000240a0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
+000240b0: 7265 2227 2c0a 2020 2020 2020 2020 2020  re"',.          
+000240c0: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
+000240d0: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
+000240e0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+000240f0: 7564 7d20 2d2d 6d6f 6465 2062 6c75 655f  ud} --mode blue_
+00024100: 6772 6565 6e20 2d79 2074 6573 7473 2f73  green -y tests/s
+00024110: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
+00024120: 6577 2e79 616d 6c27 2c0a 2020 2020 2020  ew.yaml',.      
+00024130: 2020 2020 2020 2320 736c 6565 7020 6265        # sleep be
+00024140: 666f 7265 2075 7064 6174 6520 6973 2072  fore update is r
+00024150: 6567 6973 7465 7265 642e 0a20 2020 2020  egistered..     
+00024160: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+00024170: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00024180: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00024190: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+000241a0: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+000241b0: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
+000241c0: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+000241d0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+000241e0: 2248 692c 206e 6577 2053 6b79 5069 6c6f  "Hi, new SkyPilo
+000241f0: 7420 6865 7265 2122 3b20 646f 2073 6c65  t here!"; do sle
+00024200: 6570 2032 3b20 646f 6e65 3b27 0a20 2020  ep 2; done;'.   
+00024210: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
+00024220: 7375 7265 2074 6865 2074 7261 6666 6963  sure the traffic
+00024230: 2069 7320 6e6f 7420 6d69 7865 640a 2020   is not mixed.  
+00024240: 2020 2020 2020 2020 2020 2763 7572 6c20            'curl 
+00024250: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
+00024260: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+00024270: 6e65 7720 536b 7950 696c 6f74 2068 6572  new SkyPilot her
+00024280: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
+00024290: 2023 2054 6865 206c 6174 6573 7420 3220   # The latest 2 
+000242a0: 7665 7273 696f 6e20 7368 6f75 6c64 2062  version should b
+000242b0: 6520 5245 4144 5920 616e 6420 7468 6520  e READY and the 
+000242c0: 6f6c 6465 7220 7665 7273 696f 6e73 2073  older versions s
+000242d0: 686f 756c 6420 6265 2073 6875 7474 696e  hould be shuttin
+000242e0: 6720 646f 776e 0a20 2020 2020 2020 2020  g down.         
+000242f0: 2020 2028 5f63 6865 636b 5f72 6570 6c69     (_check_repli
+00024300: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+00024310: 652c 205b 2832 2c20 4661 6c73 652c 2027  e, [(2, False, '
+00024320: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
+00024330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024350: 2020 2020 2020 2832 2c20 4661 6c73 652c        (2, False,
+00024360: 2027 5348 5554 5449 4e47 5f44 4f57 4e27   'SHUTTING_DOWN'
+00024370: 295d 2920 2b0a 2020 2020 2020 2020 2020  )]) +.          
+00024380: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+00024390: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+000243a0: 2232 2229 292c 0a20 2020 2020 2020 205d  "2")),.        ]
+000243b0: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+000243c0: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+000243d0: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+000243e0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+000243f0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00024400: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00024410: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00024420: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
+00024430: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+00024440: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+00024450: 7973 6572 7665 5f72 6f6c 6c69 6e67 5f75  yserve_rolling_u
+00024460: 7064 6174 6528 6765 6e65 7269 635f 636c  pdate(generic_cl
+00024470: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+00024480: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
+00024490: 7769 7468 2072 6f6c 6c69 6e67 2075 7064  with rolling upd
+000244a0: 6174 6522 2222 0a20 2020 206e 616d 6520  ate""".    name 
+000244b0: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+000244c0: 616d 6528 290a 2020 2020 7369 6e67 6c65  ame().    single
+000244d0: 5f6e 6577 5f72 6570 6c69 6361 203d 205f  _new_replica = _
+000244e0: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
+000244f0: 5f73 7461 7475 7328 0a20 2020 2020 2020  _status(.       
+00024500: 206e 616d 652c 205b 2832 2c20 4661 6c73   name, [(2, Fals
+00024510: 652c 2027 5245 4144 5927 292c 2028 312c  e, 'READY'), (1,
+00024520: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
+00024530: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
+00024540: 535f 5245 4745 5829 2c0a 2020 2020 2020  S_REGEX),.      
+00024550: 2020 2020 2020 2020 2028 312c 2046 616c           (1, Fal
+00024560: 7365 2c20 2753 4855 5454 494e 475f 444f  se, 'SHUTTING_DO
+00024570: 574e 2729 5d29 0a20 2020 2074 6573 7420  WN')]).    test 
+00024580: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00024590: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
+000245a0: 726f 6c6c 696e 672d 7570 6461 7465 272c  rolling-update',
+000245b0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+000245c0: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+000245d0: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+000245e0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+000245f0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+00024600: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+00024610: 2f6f 6c64 2e79 616d 6c27 2c0a 2020 2020  /old.yaml',.    
+00024620: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00024630: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00024640: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00024650: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
+00024660: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00024670: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00024680: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00024690: 653d 6e61 6d65 297d 3b20 6375 726c 202d  e=name)}; curl -
+000246a0: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
+000246b0: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
+000246c0: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
+000246d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000246e0: 7920 7365 7276 6520 7570 6461 7465 207b  y serve update {
+000246f0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00024700: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
+00024710: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+00024720: 7570 6461 7465 2f6e 6577 2e79 616d 6c27  update/new.yaml'
+00024730: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00024740: 4d61 6b65 2073 7572 6520 7468 6520 7472  Make sure the tr
+00024750: 6166 6669 6320 6973 206d 6978 6564 2061  affic is mixed a
+00024760: 6372 6f73 7320 7477 6f20 7665 7273 696f  cross two versio
+00024770: 6e73 2c20 7468 6520 7265 706c 6963 6173  ns, the replicas
+00024780: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
+00024790: 6974 6820 6576 656e 2069 6420 7769 6c6c  ith even id will
+000247a0: 2073 6c65 6570 2036 3020 7365 636f 6e64   sleep 60 second
+000247b0: 7320 6265 666f 7265 2062 6569 6e67 2072  s before being r
+000247c0: 6561 6479 2c20 736f 2077 650a 2020 2020  eady, so we.    
+000247d0: 2020 2020 2020 2020 2320 7368 6f75 6c64          # should
+000247e0: 2062 6520 6162 6c65 2074 6f20 6765 7420   be able to get 
+000247f0: 6f62 7365 7276 6520 7468 6520 7065 7269  observe the peri
+00024800: 6f64 2074 6861 7420 7468 6520 7472 6166  od that the traf
+00024810: 6669 6320 6973 206d 6978 6564 0a20 2020  fic is mixed.   
+00024820: 2020 2020 2020 2020 2023 2061 6372 6f73           # acros
+00024830: 7320 7477 6f20 7665 7273 696f 6e73 2e0a  s two versions..
+00024840: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00024850: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00024860: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00024870: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
+00024880: 2020 2020 2020 2775 6e74 696c 2063 7572        'until cur
+00024890: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
+000248a0: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
+000248b0: 2c20 6e65 7720 536b 7950 696c 6f74 2068  , new SkyPilot h
+000248c0: 6572 6521 223b 2064 6f20 736c 6565 7020  ere!"; do sleep 
+000248d0: 323b 2064 6f6e 653b 2073 6c65 6570 2032  2; done; sleep 2
+000248e0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+000248f0: 2320 5468 6520 6c61 7465 7374 2076 6572  # The latest ver
+00024900: 7369 6f6e 2073 686f 756c 6420 6861 7665  sion should have
+00024910: 206f 6e65 2052 4541 4459 2061 6e64 2074   one READY and t
+00024920: 6865 206f 6e65 206f 6620 7468 6520 6f6c  he one of the ol
+00024930: 6465 7220 7665 7273 696f 6e73 2073 686f  der versions sho
+00024940: 756c 6420 6265 2073 6875 7474 696e 6720  uld be shutting 
+00024950: 646f 776e 0a20 2020 2020 2020 2020 2020  down.           
+00024960: 2066 277b 7369 6e67 6c65 5f6e 6577 5f72   f'{single_new_r
+00024970: 6570 6c69 6361 7d20 7b5f 6368 6563 6b5f  eplica} {_check_
+00024980: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
+00024990: 6e61 6d65 2c20 2231 2c32 2229 7d20 270a  name, "1,2")} '.
+000249a0: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
+000249b0: 6563 6b20 7468 6520 6f75 7470 7574 2066  eck the output f
+000249c0: 726f 6d20 7468 6520 6f6c 6420 7665 7273  rom the old vers
+000249d0: 696f 6e2c 2069 6d6d 6564 6961 7465 6c79  ion, immediately
+000249e0: 2061 6674 6572 2074 6865 0a20 2020 2020   after the.     
+000249f0: 2020 2020 2020 2023 206f 7574 7075 7420         # output 
+00024a00: 6672 6f6d 2074 6865 206e 6577 2076 6572  from the new ver
+00024a10: 7369 6f6e 2061 7070 6561 7273 2e20 5468  sion appears. Th
+00024a20: 6973 2069 7320 6775 6172 616e 7465 6564  is is guaranteed
+00024a30: 2062 7920 7468 650a 2020 2020 2020 2020   by the.        
+00024a40: 2020 2020 2320 726f 756e 6420 726f 6269      # round robi
+00024a50: 6e20 6c6f 6164 2062 616c 616e 6369 6e67  n load balancing
+00024a60: 2070 6f6c 6963 792e 0a20 2020 2020 2020   policy..       
+00024a70: 2020 2020 2023 2054 4f44 4f28 7a68 7775       # TODO(zhwu
+00024a80: 293a 2077 6520 7368 6f75 6c64 2068 6176  ): we should hav
+00024a90: 6520 6120 6d6f 7265 2067 656e 6572 616c  e a more general
+00024aa0: 697a 6564 2077 6179 2066 6f72 2063 6865  ized way for che
+00024ab0: 636b 696e 6720 7468 650a 2020 2020 2020  cking the.      
+00024ac0: 2020 2020 2020 2320 6d69 7865 6420 7665        # mixed ve
+00024ad0: 7273 696f 6e20 6f66 2072 6570 6c69 6361  rsion of replica
+00024ae0: 7320 746f 2061 766f 6964 2064 6570 656e  s to avoid depen
+00024af0: 6469 6e67 206f 6e20 7468 6520 7370 6563  ding on the spec
+00024b00: 6966 6963 0a20 2020 2020 2020 2020 2020  ific.           
+00024b10: 2023 2072 6f75 6e64 2072 6f62 696e 206c   # round robin l
+00024b20: 6f61 6420 6261 6c61 6e63 696e 6720 706f  oad balancing po
+00024b30: 6c69 6379 2e0a 2020 2020 2020 2020 2020  licy..          
+00024b40: 2020 2763 7572 6c20 2d4c 2068 7474 703a    'curl -L http:
+00024b50: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
+00024b60: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
+00024b70: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
+00024b80: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+00024b90: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+00024ba0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+00024bb0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00024bc0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
+00024bd0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00024be0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00024bf0: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
+00024c00: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+00024c10: 726e 6574 6573 0a64 6566 2074 6573 745f  rnetes.def test_
+00024c20: 736b 7973 6572 7665 5f66 6173 745f 7570  skyserve_fast_up
+00024c30: 6461 7465 2867 656e 6572 6963 5f63 6c6f  date(generic_clo
+00024c40: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+00024c50: 2254 6573 7420 736b 7973 6572 7665 2077  "Test skyserve w
+00024c60: 6974 6820 6661 7374 2075 7064 6174 6520  ith fast update 
+00024c70: 2849 6e63 7265 6d65 6e74 2076 6572 7369  (Increment versi
+00024c80: 6f6e 206f 6620 6f6c 6420 7265 706c 6963  on of old replic
+00024c90: 6173 2922 2222 0a20 2020 206e 616d 6520  as)""".    name 
+00024ca0: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00024cb0: 616d 6528 290a 0a20 2020 2074 6573 7420  ame()..    test 
+00024cc0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00024cd0: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
+00024ce0: 6661 7374 2d75 7064 6174 6527 2c0a 2020  fast-update',.  
+00024cf0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00024d00: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+00024d10: 7570 202d 6e20 7b6e 616d 657d 202d 7920  up -n {name} -y 
+00024d20: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00024d30: 5f63 6c6f 7564 7d20 7465 7374 732f 736b  _cloud} tests/sk
+00024d40: 7973 6572 7665 2f75 7064 6174 652f 6275  yserve/update/bu
+00024d50: 6d70 5f76 6572 7369 6f6e 5f62 6566 6f72  mp_version_befor
+00024d60: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
+00024d70: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
+00024d80: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
+00024d90: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
+00024da0: 6570 6c69 6361 5f6e 756d 3d32 292c 0a20  eplica_num=2),. 
+00024db0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00024dc0: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
+00024dd0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+00024de0: 616d 6529 7d3b 2063 7572 6c20 2d4c 2068  ame)}; curl -L h
+00024df0: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
+00024e00: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
+00024e10: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
+00024e20: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00024e30: 6572 7665 2075 7064 6174 6520 7b6e 616d  erve update {nam
+00024e40: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00024e50: 7269 635f 636c 6f75 647d 202d 2d6d 6f64  ric_cloud} --mod
+00024e60: 6520 626c 7565 5f67 7265 656e 202d 7920  e blue_green -y 
+00024e70: 7465 7374 732f 736b 7973 6572 7665 2f75  tests/skyserve/u
+00024e80: 7064 6174 652f 6275 6d70 5f76 6572 7369  pdate/bump_versi
+00024e90: 6f6e 5f61 6674 6572 2e79 616d 6c27 2c0a  on_after.yaml',.
+00024ea0: 2020 2020 2020 2020 2020 2020 2320 736c              # sl
+00024eb0: 6565 7020 746f 2077 6169 7420 666f 7220  eep to wait for 
+00024ec0: 7570 6461 7465 2074 6f20 6265 2072 6567  update to be reg
+00024ed0: 6973 7465 7265 642e 0a20 2020 2020 2020  istered..       
+00024ee0: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
+00024ef0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00024f00: 3220 6f6e 2d64 6561 6d6e 6420 2872 6561  2 on-deamnd (rea
+00024f10: 6479 2920 2b20 3120 6f6e 2d64 656d 616e  dy) + 1 on-deman
+00024f20: 6420 2870 726f 7669 7369 6f6e 696e 6729  d (provisioning)
+00024f30: 2e0a 2020 2020 2020 2020 2020 2020 280a  ..            (.
+00024f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024f50: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+00024f60: 6e5f 7374 6174 7573 280a 2020 2020 2020  n_status(.      
+00024f70: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+00024f80: 6d65 2c20 5b28 322c 2046 616c 7365 2c20  me, [(2, False, 
+00024f90: 2752 4541 4459 2729 2c0a 2020 2020 2020  'READY'),.      
+00024fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024fb0: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
+00024fc0: 5f53 4552 5649 4345 5f4c 4155 4e43 4849  _SERVICE_LAUNCHI
+00024fd0: 4e47 5f53 5441 5455 535f 5245 4745 5829  NG_STATUS_REGEX)
+00024fe0: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
+00024ff0: 2020 2020 2023 2046 6173 7420 7570 6461       # Fast upda
+00025000: 7465 2077 696c 6c20 6469 7265 6374 6c79  te will directly
+00025010: 2068 6176 6520 7468 6520 6c61 7465 7374   have the latest
+00025020: 2076 6572 7369 6f6e 2072 6561 6479 2e0a   version ready..
+00025030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025040: 5f63 6865 636b 5f73 6572 7669 6365 5f76  _check_service_v
+00025050: 6572 7369 6f6e 286e 616d 652c 2022 3222  ersion(name, "2"
+00025060: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00025070: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
+00025080: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
+00025090: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
+000250a0: 615f 6e75 6d3d 3329 202b 0a20 2020 2020  a_num=3) +.     
+000250b0: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
+000250c0: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+000250d0: 6d65 2c20 2232 2229 2c0a 2020 2020 2020  me, "2"),.      
+000250e0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+000250f0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+00025100: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+00025110: 3b20 6375 726c 202d 4c20 6874 7470 3a2f  ; curl -L http:/
+00025120: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
+00025130: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
+00025140: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
+00025150: 2020 2020 2320 5465 7374 2072 6f6c 6c69      # Test rolli
+00025160: 6e67 2075 7064 6174 650a 2020 2020 2020  ng update.      
+00025170: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00025180: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
+00025190: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+000251a0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+000251b0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+000251c0: 2f62 756d 705f 7665 7273 696f 6e5f 6265  /bump_version_be
+000251d0: 666f 7265 2e79 616d 6c27 2c0a 2020 2020  fore.yaml',.    
+000251e0: 2020 2020 2020 2020 2320 736c 6565 7020          # sleep 
+000251f0: 746f 2077 6169 7420 666f 7220 7570 6461  to wait for upda
+00025200: 7465 2074 6f20 6265 2072 6567 6973 7465  te to be registe
+00025210: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
+00025220: 2027 736c 6565 7020 3330 272c 0a20 2020   'sleep 30',.   
+00025230: 2020 2020 2020 2020 2023 2032 206f 6e2d           # 2 on-
+00025240: 6465 616d 6e64 2028 7265 6164 7929 202b  deamnd (ready) +
+00025250: 2031 206f 6e2d 6465 6d61 6e64 2028 7368   1 on-demand (sh
+00025260: 7574 7469 6e67 2064 6f77 6e29 2e0a 2020  utting down)..  
+00025270: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00025280: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
+00025290: 7573 286e 616d 652c 205b 2832 2c20 4661  us(name, [(2, Fa
+000252a0: 6c73 652c 2027 5245 4144 5927 292c 0a20  lse, 'READY'),. 
+000252b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000252c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000252d0: 2020 2020 2020 2020 2020 2028 312c 2046             (1, F
+000252e0: 616c 7365 2c20 2753 4855 5454 494e 475f  alse, 'SHUTTING_
+000252f0: 444f 574e 2729 5d29 2c0a 2020 2020 2020  DOWN')]),.      
+00025300: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+00025310: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00025320: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00025330: 7265 706c 6963 615f 6e75 6d3d 3229 202b  replica_num=2) +
+00025340: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00025350: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
+00025360: 696f 6e28 6e61 6d65 2c20 2233 2229 2c0a  ion(name, "3"),.
+00025370: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00025380: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00025390: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+000253a0: 6e61 6d65 297d 3b20 6375 726c 202d 4c20  name)}; curl -L 
+000253b0: 6874 7470 3a2f 2f24 656e 6470 6f69 6e74  http://$endpoint
+000253c0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
+000253d0: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
+000253e0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000253f0: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
+00025400: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
+00025410: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+00025420: 6d65 6f75 743d 3330 202a 2036 302c 0a20  meout=30 * 60,. 
+00025430: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00025440: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00025450: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
+00025460: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00025470: 5f6b 7562 6572 6e65 7465 730a 6465 6620  _kubernetes.def 
+00025480: 7465 7374 5f73 6b79 7365 7276 655f 7570  test_skyserve_up
+00025490: 6461 7465 5f61 7574 6f73 6361 6c65 2867  date_autoscale(g
+000254a0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+000254b0: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
+000254c0: 736b 7973 6572 7665 2075 7064 6174 6520  skyserve update 
+000254d0: 7769 7468 2061 7574 6f73 6361 6c65 2222  with autoscale""
+000254e0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+000254f0: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
+00025500: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00025510: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
+00025520: 2d73 6b79 7365 7276 652d 7570 6461 7465  -skyserve-update
+00025530: 2d61 7574 6f73 6361 6c65 272c 0a20 2020  -autoscale',.   
+00025540: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00025550: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
+00025560: 7020 2d6e 207b 6e61 6d65 7d20 2d2d 636c  p -n {name} --cl
+00025570: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00025580: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
+00025590: 7365 7276 652f 7570 6461 7465 2f6e 756d  serve/update/num
+000255a0: 5f6d 696e 5f74 776f 2e79 616d 6c27 2c0a  _min_two.yaml',.
+000255b0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+000255c0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+000255d0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+000255e0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+000255f0: 6d3d 3229 202b 0a20 2020 2020 2020 2020  m=2) +.         
+00025600: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+00025610: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+00025620: 2231 2229 2c0a 2020 2020 2020 2020 2020  "1"),.          
+00025630: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00025640: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00025650: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00025660: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
+00025670: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
+00025680: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
+00025690: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
+000256a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000256b0: 2773 6b79 2073 6572 7665 2075 7064 6174  'sky serve updat
+000256c0: 6520 7b6e 616d 657d 202d 2d63 6c6f 7564  e {name} --cloud
+000256d0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+000256e0: 202d 2d6d 6f64 6520 626c 7565 5f67 7265   --mode blue_gre
+000256f0: 656e 202d 7920 7465 7374 732f 736b 7973  en -y tests/skys
+00025700: 6572 7665 2f75 7064 6174 652f 6e75 6d5f  erve/update/num_
+00025710: 6d69 6e5f 6f6e 652e 7961 6d6c 272c 0a20  min_one.yaml',. 
+00025720: 2020 2020 2020 2020 2020 2023 2073 6c65             # sle
+00025730: 6570 2062 6566 6f72 6520 7570 6461 7465  ep before update
+00025740: 2069 7320 7265 6769 7374 6572 6564 2e0a   is registered..
+00025750: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00025760: 6570 2032 3027 2c0a 2020 2020 2020 2020  ep 20',.        
+00025770: 2020 2020 2320 5469 6d65 6f75 7420 7769      # Timeout wi
+00025780: 6c6c 2062 6520 7472 6967 6765 7265 6420  ll be triggered 
+00025790: 7768 656e 2075 7064 6174 6520 6661 696c  when update fail
+000257a0: 732e 0a20 2020 2020 2020 2020 2020 205f  s..            _
+000257b0: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
+000257c0: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
+000257d0: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
+000257e0: 5f6e 756d 3d31 2920 2b0a 2020 2020 2020  _num=1) +.      
+000257f0: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
+00025800: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
+00025810: 652c 2022 3222 292c 0a20 2020 2020 2020  e, "2"),.       
+00025820: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+00025830: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+00025840: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+00025850: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00025860: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+00025870: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00025880: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
+00025890: 7265 2122 272c 0a20 2020 2020 2020 2020  re!"',.         
+000258a0: 2020 2023 2052 6f6c 6c69 6e67 2055 7064     # Rolling Upd
+000258b0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+000258c0: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
+000258d0: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
+000258e0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+000258f0: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
+00025900: 7276 652f 7570 6461 7465 2f6e 756d 5f6d  rve/update/num_m
+00025910: 696e 5f74 776f 2e79 616d 6c27 2c0a 2020  in_two.yaml',.  
+00025920: 2020 2020 2020 2020 2020 2320 736c 6565            # slee
+00025930: 7020 6265 666f 7265 2075 7064 6174 6520  p before update 
+00025940: 6973 2072 6567 6973 7465 7265 642e 0a20  is registered.. 
+00025950: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00025960: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
+00025970: 2020 2023 2054 696d 656f 7574 2077 696c     # Timeout wil
+00025980: 6c20 6265 2074 7269 6767 6572 6564 2077  l be triggered w
+00025990: 6865 6e20 7570 6461 7465 2066 6169 6c73  hen update fails
+000259a0: 2e0a 2020 2020 2020 2020 2020 2020 5f53  ..            _S
+000259b0: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
+000259c0: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
+000259d0: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
+000259e0: 6e75 6d3d 3229 202b 0a20 2020 2020 2020  num=2) +.       
+000259f0: 2020 2020 205f 6368 6563 6b5f 7365 7276       _check_serv
+00025a00: 6963 655f 7665 7273 696f 6e28 6e61 6d65  ice_version(name
+00025a10: 2c20 2233 2229 2c0a 2020 2020 2020 2020  , "3"),.        
+00025a20: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
+00025a30: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
+00025a40: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+00025a50: 270a 2020 2020 2020 2020 2020 2020 2763  '.            'c
+00025a60: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
+00025a70: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+00025a80: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
+00025a90: 6521 2227 2c0a 2020 2020 2020 2020 5d2c  e!"',.        ],
+00025aa0: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00025ab0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00025ac0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00025ad0: 2020 2020 2020 7469 6d65 6f75 743d 3330        timeout=30
+00025ae0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00025af0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00025b00: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00025b10: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
+00025b20: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+00025b30: 6528 276d 6f64 6527 2c20 5b27 726f 6c6c  e('mode', ['roll
+00025b40: 696e 6727 2c20 2762 6c75 655f 6772 6565  ing', 'blue_gree
+00025b50: 6e27 5d29 0a40 7079 7465 7374 2e6d 6172  n']).@pytest.mar
+00025b60: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
+00025b70: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
+00025b80: 655f 6e65 775f 6175 746f 7363 616c 6572  e_new_autoscaler
+00025b90: 5f75 7064 6174 6528 6d6f 6465 3a20 7374  _update(mode: st
+00025ba0: 722c 2067 656e 6572 6963 5f63 6c6f 7564  r, generic_cloud
+00025bb0: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
+00025bc0: 6573 7420 736b 7973 6572 7665 2077 6974  est skyserve wit
+00025bd0: 6820 7570 6461 7465 2074 6861 7420 6368  h update that ch
+00025be0: 616e 6765 7320 6175 746f 7363 616c 6572  anges autoscaler
+00025bf0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+00025c00: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
+00025c10: 2829 202b 206d 6f64 650a 0a20 2020 2066  () + mode..    f
+00025c20: 6f75 725f 7370 6f74 5f75 705f 636d 6420  our_spot_up_cmd 
+00025c30: 3d20 5f63 6865 636b 5f72 6570 6c69 6361  = _check_replica
+00025c40: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
+00025c50: 205b 2834 2c20 5472 7565 2c20 2752 4541   [(4, True, 'REA
+00025c60: 4459 2729 5d29 0a20 2020 2075 7064 6174  DY')]).    updat
+00025c70: 655f 6368 6563 6b20 3d20 5b66 2775 6e74  e_check = [f'unt
+00025c80: 696c 2028 7b66 6f75 725f 7370 6f74 5f75  il ({four_spot_u
+00025c90: 705f 636d 647d 293b 2064 6f20 736c 6565  p_cmd}); do slee
+00025ca0: 7020 353b 2064 6f6e 653b 2073 6c65 6570  p 5; done; sleep
+00025cb0: 2031 303b 275d 0a20 2020 2069 6620 6d6f   10;'].    if mo
+00025cc0: 6465 203d 3d20 2772 6f6c 6c69 6e67 273a  de == 'rolling':
+00025cd0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00025ce0: 2072 6f6c 6c69 6e67 2075 7064 6174 652c   rolling update,
+00025cf0: 2069 7420 7769 6c6c 2074 6572 6d69 6e61   it will termina
+00025d00: 7465 206f 6e65 206f 6620 7468 6520 6f6c  te one of the ol
+00025d10: 6420 6f6e 2d64 656d 616e 640a 2020 2020  d on-demand.    
+00025d20: 2020 2020 2320 696e 7374 616e 6365 732c      # instances,
+00025d30: 206f 6e63 6520 7468 6572 6520 6172 6520   once there are 
+00025d40: 3420 7370 6f74 2069 6e73 7461 6e63 6520  4 spot instance 
+00025d50: 7265 6164 792e 0a20 2020 2020 2020 2075  ready..        u
+00025d60: 7064 6174 655f 6368 6563 6b20 2b3d 205b  pdate_check += [
+00025d70: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00025d80: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00025d90: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
+00025da0: 2020 2020 2020 206e 616d 652c 205b 2831         name, [(1
+00025db0: 2c20 4661 6c73 652c 205f 5345 5256 4943  , False, _SERVIC
+00025dc0: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
+00025dd0: 5553 5f52 4547 4558 292c 0a20 2020 2020  US_REGEX),.     
+00025de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025df0: 2020 2831 2c20 4661 6c73 652c 2027 5348    (1, False, 'SH
+00025e00: 5554 5449 4e47 5f44 4f57 4e27 292c 2028  UTTING_DOWN'), (
+00025e10: 312c 2046 616c 7365 2c20 2752 4541 4459  1, False, 'READY
+00025e20: 2729 5d29 202b 0a20 2020 2020 2020 2020  ')]) +.         
+00025e30: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+00025e40: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+00025e50: 2231 2c32 2229 2c0a 2020 2020 2020 2020  "1,2"),.        
+00025e60: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
+00025e70: 2020 2020 2320 4368 6563 6b20 626c 7565      # Check blue
+00025e80: 2067 7265 656e 2075 7064 6174 652c 2069   green update, i
+00025e90: 7420 7769 6c6c 206b 6565 7020 626f 7468  t will keep both
+00025ea0: 206f 6c64 206f 6e2d 6465 6d61 6e64 2069   old on-demand i
+00025eb0: 6e73 7461 6e63 6573 0a20 2020 2020 2020  nstances.       
+00025ec0: 2023 2072 756e 6e69 6e67 2c20 6f6e 6365   # running, once
+00025ed0: 2074 6865 7265 2061 7265 2034 2073 706f   there are 4 spo
+00025ee0: 7420 696e 7374 616e 6365 2072 6561 6479  t instance ready
+00025ef0: 2e0a 2020 2020 2020 2020 7570 6461 7465  ..        update
+00025f00: 5f63 6865 636b 202b 3d20 5b0a 2020 2020  _check += [.    
+00025f10: 2020 2020 2020 2020 5f63 6865 636b 5f72          _check_r
+00025f20: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
+00025f30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00025f40: 2020 6e61 6d65 2c20 5b28 312c 2046 616c    name, [(1, Fal
+00025f50: 7365 2c20 5f53 4552 5649 4345 5f4c 4155  se, _SERVICE_LAU
+00025f60: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
+00025f70: 4745 5829 2c0a 2020 2020 2020 2020 2020  GEX),.          
+00025f80: 2020 2020 2020 2020 2020 2020 2028 322c               (2,
+00025f90: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
+00025fa0: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
+00025fb0: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
+00025fc0: 7665 7273 696f 6e28 6e61 6d65 2c20 2231  version(name, "1
+00025fd0: 2229 2c0a 2020 2020 2020 2020 5d0a 2020  "),.        ].  
+00025fe0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00025ff0: 2020 2020 2020 2027 7465 7374 2d73 6b79         'test-sky
+00026000: 7365 7276 652d 6e65 772d 6175 746f 7363  serve-new-autosc
+00026010: 616c 6572 2d75 7064 6174 6527 2c0a 2020  aler-update',.  
+00026020: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00026030: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+00026040: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
+00026050: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00026060: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
+00026070: 7973 6572 7665 2f75 7064 6174 652f 6e65  yserve/update/ne
+00026080: 775f 6175 746f 7363 616c 6572 5f62 6566  w_autoscaler_bef
+00026090: 6f72 652e 7961 6d6c 272c 0a20 2020 2020  ore.yaml',.     
+000260a0: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
+000260b0: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
+000260c0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
+000260d0: 2072 6570 6c69 6361 5f6e 756d 3d32 2920   replica_num=2) 
+000260e0: 2b0a 2020 2020 2020 2020 2020 2020 5f63  +.            _c
+000260f0: 6865 636b 5f73 6572 7669 6365 5f76 6572  heck_service_ver
+00026100: 7369 6f6e 286e 616d 652c 2022 3122 292c  sion(name, "1"),
+00026110: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00026120: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+00026130: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
+00026140: 3d6e 616d 6529 7d3b 2027 0a20 2020 2020  =name)}; '.     
+00026150: 2020 2020 2020 2027 733d 2428 6375 726c         's=$(curl
+00026160: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
+00026170: 6f69 6e74 293b 2065 6368 6f20 2224 7322  oint); echo "$s"
+00026180: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
+00026190: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
+000261a0: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
+000261b0: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+000261c0: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
+000261d0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+000261e0: 636c 6f75 647d 202d 2d6d 6f64 6520 7b6d  cloud} --mode {m
+000261f0: 6f64 657d 202d 7920 7465 7374 732f 736b  ode} -y tests/sk
+00026200: 7973 6572 7665 2f75 7064 6174 652f 6e65  yserve/update/ne
+00026210: 775f 6175 746f 7363 616c 6572 5f61 6674  w_autoscaler_aft
+00026220: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
+00026230: 2020 2020 2020 2320 5761 6974 2066 6f72        # Wait for
+00026240: 2075 7064 6174 6520 746f 2062 6520 7265   update to be re
+00026250: 6769 7374 6572 6564 0a20 2020 2020 2020  gistered.       
+00026260: 2020 2020 2066 2773 6c65 6570 2031 3230       f'sleep 120
+00026270: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00026280: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
+00026290: 5f73 7461 7475 7328 0a20 2020 2020 2020  _status(.       
+000262a0: 2020 2020 2020 2020 206e 616d 652c 205b           name, [
+000262b0: 2834 2c20 5472 7565 2c20 5f53 4552 5649  (4, True, _SERVI
+000262c0: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
+000262d0: 5455 535f 5245 4745 5820 2b20 275c 7c52  TUS_REGEX + '\|R
+000262e0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+000262f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00026300: 312c 2046 616c 7365 2c20 5f53 4552 5649  1, False, _SERVI
+00026310: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
+00026320: 5455 535f 5245 4745 5829 2c0a 2020 2020  TUS_REGEX),.    
+00026330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026340: 2020 2028 322c 2046 616c 7365 2c20 2752     (2, False, 'R
+00026350: 4541 4459 2729 5d29 2c0a 2020 2020 2020  EADY')]),.      
+00026360: 2020 2020 2020 2a75 7064 6174 655f 6368        *update_ch
+00026370: 6563 6b2c 0a20 2020 2020 2020 2020 2020  eck,.           
+00026380: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
+00026390: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
+000263a0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
+000263b0: 6361 5f6e 756d 3d35 292c 0a20 2020 2020  ca_num=5),.     
+000263c0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
+000263d0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
+000263e0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+000263f0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+00026400: 2027 6375 726c 202d 4c20 6874 7470 3a2f   'curl -L http:/
+00026410: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
+00026420: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
+00026430: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
+00026440: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
+00026450: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+00026460: 652c 205b 2834 2c20 5472 7565 2c20 2752  e, [(4, True, 'R
+00026470: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+00026480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000264a0: 2020 2020 2831 2c20 4661 6c73 652c 2027      (1, False, '
+000264b0: 5245 4144 5927 295d 292c 0a20 2020 2020  READY')]),.     
+000264c0: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
+000264d0: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
+000264e0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+000264f0: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
+00026500: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+00026510: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00026520: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00026530: 7374 2e6d 6172 6b2e 7365 7276 650a 6465  st.mark.serve.de
+00026540: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
+00026550: 6661 696c 7572 6573 2867 656e 6572 6963  failures(generic
+00026560: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00026570: 2020 2222 2254 6573 7420 7265 706c 6963    """Test replic
+00026580: 6120 6661 696c 7572 6520 7374 6174 7573  a failure status
+00026590: 6573 2222 220a 2020 2020 6e61 6d65 203d  es""".    name =
+000265a0: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+000265b0: 6d65 2829 0a0a 2020 2020 7465 7374 203d  me()..    test =
+000265c0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+000265d0: 7465 7374 2d73 6b79 7365 7276 652d 6661  test-skyserve-fa
+000265e0: 696c 7572 6573 272c 0a20 2020 2020 2020  ilures',.       
+000265f0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00026600: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+00026610: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00026620: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00026630: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00026640: 652f 6661 696c 7572 6573 2f69 6e69 7469  e/failures/initi
+00026650: 616c 5f64 656c 6179 2e79 616d 6c27 2c0a  al_delay.yaml',.
+00026660: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00026670: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
+00026680: 7573 207b 6e61 6d65 7d29 3b20 270a 2020  us {name}); '.  
+00026690: 2020 2020 2020 2020 2020 6627 756e 7469            f'unti
+000266a0: 6c20 6563 686f 2022 2473 2220 7c20 6772  l echo "$s" | gr
+000266b0: 6570 2022 4641 494c 4544 5f49 4e49 5449  ep "FAILED_INITI
+000266c0: 414c 5f44 454c 4159 223b 2064 6f20 270a  AL_DELAY"; do '.
+000266d0: 2020 2020 2020 2020 2020 2020 2765 6368              'ech
+000266e0: 6f20 2257 6169 7469 6e67 2066 6f72 2072  o "Waiting for r
+000266f0: 6570 6c69 6361 2074 6f20 6265 2066 6169  eplica to be fai
+00026700: 6c65 642e 2e2e 223b 2073 6c65 6570 2035  led..."; sleep 5
+00026710: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00026720: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
+00026730: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
+00026740: 6563 686f 2022 2473 223b 2064 6f6e 653b  echo "$s"; done;
+00026750: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00026760: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
+00026770: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
+00026780: 5f53 5441 5455 535f 5741 4954 2e66 6f72  _STATUS_WAIT.for
+00026790: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+000267a0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+000267b0: 7020 227b 6e61 6d65 7d22 207c 2067 7265  p "{name}" | gre
+000267c0: 7020 2246 4149 4c45 445f 494e 4954 4941  p "FAILED_INITIA
+000267d0: 4c5f 4445 4c41 5922 207c 2077 6320 2d6c  L_DELAY" | wc -l
+000267e0: 207c 2067 7265 7020 323b 2027 0a20 2020   | grep 2; '.   
+000267f0: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
+00026800: 7375 7265 206e 6f20 6e65 7720 7265 706c  sure no new repl
+00026810: 6963 6173 2061 7265 2073 7461 7274 6564  icas are started
+00026820: 2066 6f72 2065 6172 6c79 2066 6169 6c75   for early failu
+00026830: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
+00026840: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
+00026850: 6570 202d 4120 3130 3020 2253 6572 7669  ep -A 100 "Servi
+00026860: 6365 2052 6570 6c69 6361 7322 207c 2067  ce Replicas" | g
+00026870: 7265 7020 227b 6e61 6d65 7d22 207c 2077  rep "{name}" | w
+00026880: 6320 2d6c 207c 2067 7265 7020 323b 272c  c -l | grep 2;',
+00026890: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000268a0: 6b79 2073 6572 7665 2075 7064 6174 6520  ky serve update 
+000268b0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+000268c0: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+000268d0: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+000268e0: 2f66 6169 6c75 7265 732f 7072 6f62 696e  /failures/probin
+000268f0: 672e 7961 6d6c 272c 0a20 2020 2020 2020  g.yaml',.       
+00026900: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
+00026910: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00026920: 657d 293b 2027 0a20 2020 2020 2020 2020  e}); '.         
+00026930: 2020 2023 2057 6169 7420 666f 7220 7265     # Wait for re
+00026940: 706c 6963 6120 746f 2062 6520 7265 6164  plica to be read
+00026950: 792e 0a20 2020 2020 2020 2020 2020 2066  y..            f
+00026960: 2775 6e74 696c 2065 6368 6f20 2224 7322  'until echo "$s"
+00026970: 207c 2067 7265 7020 2252 4541 4459 223b   | grep "READY";
+00026980: 2064 6f20 270a 2020 2020 2020 2020 2020   do '.          
+00026990: 2020 2765 6368 6f20 2257 6169 7469 6e67    'echo "Waiting
+000269a0: 2066 6f72 2072 6570 6c69 6361 2074 6f20   for replica to 
+000269b0: 6265 2066 6169 6c65 642e 2e2e 223b 2073  be failed..."; s
+000269c0: 6c65 6570 2035 3b20 270a 2020 2020 2020  leep 5; '.      
+000269d0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+000269e0: 7365 7276 6520 7374 6174 7573 207b 6e61  serve status {na
+000269f0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+00026a00: 2064 6f6e 653b 272c 0a20 2020 2020 2020   done;',.       
+00026a10: 2020 2020 2023 2057 6169 7420 666f 7220       # Wait for 
+00026a20: 7265 706c 6963 6120 746f 2063 6861 6e67  replica to chang
+00026a30: 6520 746f 2046 4149 4c45 445f 5052 4f42  e to FAILED_PROB
+00026a40: 494e 470a 2020 2020 2020 2020 2020 2020  ING.            
+00026a50: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
+00026a60: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
+00026a70: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00026a80: 756e 7469 6c20 6563 686f 2022 2473 2220  until echo "$s" 
+00026a90: 7c20 6772 6570 2022 4641 494c 4544 5f50  | grep "FAILED_P
+00026aa0: 524f 4249 4e47 223b 2064 6f20 270a 2020  ROBING"; do '.  
+00026ab0: 2020 2020 2020 2020 2020 2765 6368 6f20            'echo 
+00026ac0: 2257 6169 7469 6e67 2066 6f72 2072 6570  "Waiting for rep
+00026ad0: 6c69 6361 2074 6f20 6265 2066 6169 6c65  lica to be faile
+00026ae0: 642e 2e2e 223b 2073 6c65 6570 2035 3b20  d..."; sleep 5; 
+00026af0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00026b00: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
+00026b10: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
+00026b20: 686f 2022 2473 223b 2064 6f6e 653b 2720  ho "$s"; done;' 
+00026b30: 2b0a 2020 2020 2020 2020 2020 2020 5f63  +.            _c
+00026b40: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+00026b50: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
+00026b60: 2020 2020 2020 2020 6e61 6d65 2c20 5b28          name, [(
+00026b70: 312c 2046 616c 7365 2c20 2746 4149 4c45  1, False, 'FAILE
+00026b80: 445f 5052 4f42 494e 4727 292c 0a20 2020  D_PROBING'),.   
+00026b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ba0: 2020 2020 2831 2c20 4661 6c73 652c 205f      (1, False, _
+00026bb0: 5345 5256 4943 455f 4c41 554e 4348 494e  SERVICE_LAUNCHIN
+00026bc0: 475f 5354 4154 5553 5f52 4547 4558 295d  G_STATUS_REGEX)]
+00026bd0: 292c 0a20 2020 2020 2020 2020 2020 2023  ),.            #
+00026be0: 2054 4f44 4f28 7a68 7775 293a 2061 6464   TODO(zhwu): add
+00026bf0: 2074 6573 7420 666f 7220 4641 494c 4544   test for FAILED
+00026c00: 5f50 524f 5649 5349 4f4e 0a20 2020 2020  _PROVISION.     
+00026c10: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
+00026c20: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
+00026c30: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00026c40: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
+00026c50: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+00026c60: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00026c70: 7374 2874 6573 7429 0a0a 0a23 2054 4f44  st(test)...# TOD
+00026c80: 4f28 5a69 6d69 6e67 2c20 5469 616e 293a  O(Ziming, Tian):
+00026c90: 2041 6464 2074 6573 7473 2066 6f72 2061   Add tests for a
+00026ca0: 7574 6f73 6361 6c69 6e67 2e0a 0a0a 2320  utoscaling....# 
+00026cb0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+00026cc0: 7573 6572 2072 6179 2063 6c75 7374 6572  user ray cluster
+00026cd0: 202d 2d2d 2d2d 2d2d 2d0a 6465 6620 7465   --------.def te
+00026ce0: 7374 5f75 7365 725f 7261 795f 636c 7573  st_user_ray_clus
+00026cf0: 7465 7228 6765 6e65 7269 635f 636c 6f75  ter(generic_clou
+00026d00: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+00026d10: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00026d20: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00026d30: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00026d40: 2027 7573 6572 2d72 6179 2d63 6c75 7374   'user-ray-clust
+00026d50: 6572 272c 0a20 2020 2020 2020 205b 0a20  er',.        [. 
+00026d60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00026d70: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00026d80: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00026d90: 6e65 7269 635f 636c 6f75 647d 2022 7261  neric_cloud} "ra
+00026da0: 7920 7374 6172 7420 2d2d 6865 6164 2227  y start --head"'
+00026db0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00026dc0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00026dd0: 2265 6368 6f20 6869 2227 2c0a 2020 2020  "echo hi"',.    
+00026de0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00026df0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00026e00: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00026e10: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00026e20: 2d72 207b 6e61 6d65 7d20 7c20 6772 6570  -r {name} | grep
+00026e30: 2055 5027 2c0a 2020 2020 2020 2020 2020   UP',.          
+00026e40: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00026e50: 6d65 7d20 2265 6368 6f20 6279 6522 272c  me} "echo bye"',
+00026e60: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00026e70: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+00026e80: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00026e90: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00026ea0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00026eb0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00026ec0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00026ed0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2054  t)...# ------- T
+00026ee0: 6573 7469 6e67 2074 6865 2063 6f72 6520  esting the core 
+00026ef0: 4150 4920 2d2d 2d2d 2d2d 2d2d 0a23 204d  API --------.# M
+00026f00: 6f73 7420 6f66 2074 6865 2063 6f72 6520  ost of the core 
+00026f10: 4150 4973 2068 6176 6520 6265 656e 2074  APIs have been t
+00026f20: 6573 7465 6420 696e 2074 6865 2043 4c49  ested in the CLI
+00026f30: 2074 6573 7473 2e0a 2320 5468 6573 6520   tests..# These 
+00026f40: 7465 7374 7320 6172 6520 666f 7220 7465  tests are for te
+00026f50: 7374 696e 6720 7468 6520 7265 7475 726e  sting the return
+00026f60: 2076 616c 7565 206f 6620 7468 6520 4150   value of the AP
+00026f70: 4973 206e 6f74 2066 756c 6c79 2075 7365  Is not fully use
+00026f80: 6420 696e 2043 4c49 2e0a 0a0a 4070 7974  d in CLI....@pyt
+00026f90: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
+00026fa0: 2074 6573 745f 636f 7265 5f61 7069 5f73   test_core_api_s
+00026fb0: 6b79 5f6c 6175 6e63 685f 6578 6563 2829  ky_launch_exec()
+00026fc0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00026fd0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00026fe0: 0a20 2020 2074 6173 6b20 3d20 736b 792e  .    task = sky.
+00026ff0: 5461 736b 2872 756e 3d22 7768 6f61 6d69  Task(run="whoami
+00027000: 2229 0a20 2020 2074 6173 6b2e 7365 745f  ").    task.set_
+00027010: 7265 736f 7572 6365 7328 736b 792e 5265  resources(sky.Re
+00027020: 736f 7572 6365 7328 636c 6f75 643d 736b  sources(cloud=sk
+00027030: 792e 4743 5028 2929 290a 2020 2020 6a6f  y.GCP())).    jo
+00027040: 625f 6964 2c20 6861 6e64 6c65 203d 2073  b_id, handle = s
+00027050: 6b79 2e6c 6175 6e63 6828 7461 736b 2c20  ky.launch(task, 
+00027060: 636c 7573 7465 725f 6e61 6d65 3d6e 616d  cluster_name=nam
+00027070: 6529 0a20 2020 2061 7373 6572 7420 6a6f  e).    assert jo
+00027080: 625f 6964 203d 3d20 310a 2020 2020 6173  b_id == 1.    as
+00027090: 7365 7274 2068 616e 646c 6520 6973 206e  sert handle is n
+000270a0: 6f74 204e 6f6e 650a 2020 2020 6173 7365  ot None.    asse
+000270b0: 7274 2068 616e 646c 652e 636c 7573 7465  rt handle.cluste
+000270c0: 725f 6e61 6d65 203d 3d20 6e61 6d65 0a20  r_name == name. 
+000270d0: 2020 2061 7373 6572 7420 6861 6e64 6c65     assert handle
+000270e0: 2e6c 6175 6e63 6865 645f 7265 736f 7572  .launched_resour
+000270f0: 6365 732e 636c 6f75 642e 6973 5f73 616d  ces.cloud.is_sam
+00027100: 655f 636c 6f75 6428 736b 792e 4743 5028  e_cloud(sky.GCP(
+00027110: 2929 0a20 2020 206a 6f62 5f69 645f 6578  )).    job_id_ex
+00027120: 6563 2c20 6861 6e64 6c65 5f65 7865 6320  ec, handle_exec 
+00027130: 3d20 736b 792e 6578 6563 2874 6173 6b2c  = sky.exec(task,
+00027140: 2063 6c75 7374 6572 5f6e 616d 653d 6e61   cluster_name=na
+00027150: 6d65 290a 2020 2020 6173 7365 7274 206a  me).    assert j
+00027160: 6f62 5f69 645f 6578 6563 203d 3d20 320a  ob_id_exec == 2.
+00027170: 2020 2020 6173 7365 7274 2068 616e 646c      assert handl
+00027180: 655f 6578 6563 2069 7320 6e6f 7420 4e6f  e_exec is not No
+00027190: 6e65 0a20 2020 2061 7373 6572 7420 6861  ne.    assert ha
+000271a0: 6e64 6c65 5f65 7865 632e 636c 7573 7465  ndle_exec.cluste
+000271b0: 725f 6e61 6d65 203d 3d20 6e61 6d65 0a20  r_name == name. 
+000271c0: 2020 2061 7373 6572 7420 6861 6e64 6c65     assert handle
+000271d0: 5f65 7865 632e 6c61 756e 6368 6564 5f72  _exec.launched_r
+000271e0: 6573 6f75 7263 6573 2e63 6c6f 7564 2e69  esources.cloud.i
+000271f0: 735f 7361 6d65 5f63 6c6f 7564 2873 6b79  s_same_cloud(sky
+00027200: 2e47 4350 2829 290a 2020 2020 2320 466f  .GCP()).    # Fo
+00027210: 7220 6475 6d6d 7920 7461 736b 2028 692e  r dummy task (i.
+00027220: 652e 2074 6173 6b2e 7275 6e20 6973 204e  e. task.run is N
+00027230: 6f6e 6529 2c20 7468 6520 6a6f 6220 776f  one), the job wo
+00027240: 6e27 7420 6265 2073 7562 6d69 7474 6564  n't be submitted
+00027250: 2e0a 2020 2020 6475 6d6d 795f 7461 736b  ..    dummy_task
+00027260: 203d 2073 6b79 2e54 6173 6b28 290a 2020   = sky.Task().  
+00027270: 2020 6a6f 625f 6964 5f64 756d 6d79 2c20    job_id_dummy, 
+00027280: 5f20 3d20 736b 792e 6578 6563 2864 756d  _ = sky.exec(dum
+00027290: 6d79 5f74 6173 6b2c 2063 6c75 7374 6572  my_task, cluster
+000272a0: 5f6e 616d 653d 6e61 6d65 290a 2020 2020  _name=name).    
+000272b0: 6173 7365 7274 206a 6f62 5f69 645f 6475  assert job_id_du
+000272c0: 6d6d 7920 6973 204e 6f6e 650a 2020 2020  mmy is None.    
+000272d0: 736b 792e 646f 776e 286e 616d 6529 0a0a  sky.down(name)..
+000272e0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+000272f0: 7374 696e 6720 5374 6f72 6167 6520 2d2d  sting Storage --
+00027300: 2d2d 2d2d 2d2d 2d2d 0a63 6c61 7373 2054  --------.class T
+00027310: 6573 7453 746f 7261 6765 5769 7468 4372  estStorageWithCr
+00027320: 6564 656e 7469 616c 733a 0a20 2020 2022  edentials:.    "
+00027330: 2222 5374 6f72 6167 6520 7465 7374 7320  ""Storage tests 
+00027340: 7768 6963 6820 7265 7175 6972 6520 6372  which require cr
+00027350: 6564 656e 7469 616c 7320 616e 6420 6e65  edentials and ne
+00027360: 7477 6f72 6b20 636f 6e6e 6563 7469 6f6e  twork connection
+00027370: 2222 220a 0a20 2020 2041 5753 5f49 4e56  """..    AWS_INV
+00027380: 414c 4944 5f4e 414d 4553 203d 205b 0a20  ALID_NAMES = [. 
+00027390: 2020 2020 2020 2027 6162 272c 2020 2320         'ab',  # 
+000273a0: 6c65 7373 2074 6861 6e20 3320 6368 6172  less than 3 char
+000273b0: 6163 7465 7273 0a20 2020 2020 2020 2027  acters.        '
+000273c0: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
+000273d0: 7172 7374 7576 7778 797a 6162 6364 6566  qrstuvwxyzabcdef
+000273e0: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
+000273f0: 7778 797a 6162 6364 6566 6768 696a 6b6c  wxyzabcdefghijkl
+00027400: 6d6e 6f70 7172 7374 7576 7778 797a 3127  mnopqrstuvwxyz1'
+00027410: 2c0a 2020 2020 2020 2020 2320 6d6f 7265  ,.        # more
+00027420: 2074 6861 6e20 3633 2063 6861 7261 6374   than 63 charact
+00027430: 6572 730a 2020 2020 2020 2020 2741 6263  ers.        'Abc
+00027440: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
+00027450: 7320 616e 2075 7070 6572 6361 7365 206c  s an uppercase l
+00027460: 6574 7465 720a 2020 2020 2020 2020 2761  etter.        'a
+00027470: 6263 2064 6566 272c 2020 2320 636f 6e74  bc def',  # cont
+00027480: 6169 6e73 2061 2073 7061 6365 0a20 2020  ains a space.   
+00027490: 2020 2020 2027 6162 632e 2e64 6566 272c       'abc..def',
+000274a0: 2020 2320 7477 6f20 6164 6a61 6365 6e74    # two adjacent
+000274b0: 2070 6572 696f 6473 0a20 2020 2020 2020   periods.       
+000274c0: 2027 3139 322e 3136 382e 352e 3427 2c20   '192.168.5.4', 
+000274d0: 2023 2066 6f72 6d61 7474 6564 2061 7320   # formatted as 
+000274e0: 616e 2049 5020 6164 6472 6573 730a 2020  an IP address.  
+000274f0: 2020 2020 2020 2778 6e2d 2d62 7563 6b65        'xn--bucke
+00027500: 7427 2c20 2023 2073 7461 7274 7320 7769  t',  # starts wi
+00027510: 7468 2027 786e 2d2d 2720 7072 6566 6978  th 'xn--' prefix
+00027520: 0a20 2020 2020 2020 2027 6275 636b 6574  .        'bucket
+00027530: 2d73 3361 6c69 6173 272c 2020 2320 656e  -s3alias',  # en
+00027540: 6473 2077 6974 6820 272d 7333 616c 6961  ds with '-s3alia
+00027550: 7327 2073 7566 6669 780a 2020 2020 2020  s' suffix.      
+00027560: 2020 2762 7563 6b65 742d 2d6f 6c2d 7333    'bucket--ol-s3
+00027570: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
+00027580: 272d 2d6f 6c2d 7333 2720 7375 6666 6978  '--ol-s3' suffix
+00027590: 0a20 2020 2020 2020 2027 2e61 6263 272c  .        '.abc',
+000275a0: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
+000275b0: 6120 646f 740a 2020 2020 2020 2020 2761  a dot.        'a
+000275c0: 6263 2e27 2c20 2023 2065 6e64 7320 7769  bc.',  # ends wi
+000275d0: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
+000275e0: 2027 2d61 6263 272c 2020 2320 7374 6172   '-abc',  # star
+000275f0: 7473 2077 6974 6820 6120 6879 7068 656e  ts with a hyphen
+00027600: 0a20 2020 2020 2020 2027 6162 632d 272c  .        'abc-',
+00027610: 2020 2320 656e 6473 2077 6974 6820 6120    # ends with a 
+00027620: 6879 7068 656e 0a20 2020 205d 0a0a 2020  hyphen.    ]..  
+00027630: 2020 4743 535f 494e 5641 4c49 445f 4e41    GCS_INVALID_NA
+00027640: 4d45 5320 3d20 5b0a 2020 2020 2020 2020  MES = [.        
+00027650: 2761 6227 2c20 2023 206c 6573 7320 7468  'ab',  # less th
+00027660: 616e 2033 2063 6861 7261 6374 6572 730a  an 3 characters.
+00027670: 2020 2020 2020 2020 2761 6263 6465 6667          'abcdefg
+00027680: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
+00027690: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
+000276a0: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
+000276b0: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+000276c0: 7475 7677 7879 7a31 272c 0a20 2020 2020  tuvwxyz1',.     
+000276d0: 2020 2023 206d 6f72 6520 7468 616e 2036     # more than 6
+000276e0: 3320 6368 6172 6163 7465 7273 2028 7769  3 characters (wi
+000276f0: 7468 6f75 7420 646f 7473 290a 2020 2020  thout dots).    
+00027700: 2020 2020 2741 6263 6465 6627 2c20 2023      'Abcdef',  #
+00027710: 2063 6f6e 7461 696e 7320 616e 2075 7070   contains an upp
+00027720: 6572 6361 7365 206c 6574 7465 720a 2020  ercase letter.  
+00027730: 2020 2020 2020 2761 6263 2064 6566 272c        'abc def',
+00027740: 2020 2320 636f 6e74 6169 6e73 2061 2073    # contains a s
+00027750: 7061 6365 0a20 2020 2020 2020 2027 6162  pace.        'ab
+00027760: 632e 2e64 6566 272c 2020 2320 7477 6f20  c..def',  # two 
+00027770: 6164 6a61 6365 6e74 2070 6572 696f 6473  adjacent periods
+00027780: 0a20 2020 2020 2020 2027 6162 635f 2e64  .        'abc_.d
+00027790: 6566 2e67 6869 2e6a 6b6c 6d6e 6f70 7172  ef.ghi.jklmnopqr
+000277a0: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
+000277b0: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
+000277c0: 797a 6162 6364 6566 6768 696a 6b6c 6d6e  yzabcdefghijklmn
+000277d0: 6f70 7172 7374 7576 7778 797a 3127 0a20  opqrstuvwxyz1'. 
+000277e0: 2020 2020 2020 2023 204d 6f72 6520 7468         # More th
+000277f0: 616e 2036 3320 6368 6172 6163 7465 7273  an 63 characters
+00027800: 2062 6574 7765 656e 2064 6f74 730a 2020   between dots.  
+00027810: 2020 2020 2020 2761 6263 5f2e 6465 662e        'abc_.def.
+00027820: 6768 692e 6a6b 6c6d 6e6f 7071 7273 7475  ghi.jklmnopqrstu
+00027830: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
+00027840: 6c6d 6e6f 7071 6667 6869 6a6b 6c6d 6e6f  lmnopqfghijklmno
+00027850: 7071 7273 7475 7677 2720 2a20 352c 0a20  pqrstuvw' * 5,. 
+00027860: 2020 2020 2020 2023 206d 6f72 6520 7468         # more th
+00027870: 616e 2032 3232 2063 6861 7261 6374 6572  an 222 character
+00027880: 7320 2877 6974 6820 646f 7473 290a 2020  s (with dots).  
+00027890: 2020 2020 2020 2731 3932 2e31 3638 2e35        '192.168.5
+000278a0: 2e34 272c 2020 2320 666f 726d 6174 7465  .4',  # formatte
+000278b0: 6420 6173 2061 6e20 4950 2061 6464 7265  d as an IP addre
+000278c0: 7373 0a20 2020 2020 2020 2027 676f 6f67  ss.        'goog
+000278d0: 6275 636b 6574 272c 2020 2320 7374 6172  bucket',  # star
+000278e0: 7473 2077 6974 6820 2767 6f6f 6727 2070  ts with 'goog' p
+000278f0: 7265 6669 780a 2020 2020 2020 2020 2767  refix.        'g
+00027900: 6f6f 676c 6562 7563 6b65 7427 2c20 2023  ooglebucket',  #
+00027910: 2063 6f6e 7461 696e 7320 2767 6f6f 676c   contains 'googl
+00027920: 6527 0a20 2020 2020 2020 2027 6730 3067  e'.        'g00g
+00027930: 6c65 6275 636b 6574 272c 2020 2320 7661  lebucket',  # va
+00027940: 7269 616e 7420 6f66 2027 676f 6f67 6c65  riant of 'google
+00027950: 270a 2020 2020 2020 2020 2767 6f30 676c  '.        'go0gl
+00027960: 6562 7563 6b65 7427 2c20 2023 2076 6172  ebucket',  # var
+00027970: 6961 6e74 206f 6620 2767 6f6f 676c 6527  iant of 'google'
+00027980: 0a20 2020 2020 2020 2027 6730 6f67 6c65  .        'g0ogle
+00027990: 6275 636b 6574 272c 2020 2320 7661 7269  bucket',  # vari
+000279a0: 616e 7420 6f66 2027 676f 6f67 6c65 270a  ant of 'google'.
+000279b0: 2020 2020 2020 2020 272e 6162 6327 2c20          '.abc', 
+000279c0: 2023 2073 7461 7274 7320 7769 7468 2061   # starts with a
+000279d0: 2064 6f74 0a20 2020 2020 2020 2027 6162   dot.        'ab
+000279e0: 632e 272c 2020 2320 656e 6473 2077 6974  c.',  # ends wit
+000279f0: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
+00027a00: 275f 6162 6327 2c20 2023 2073 7461 7274  '_abc',  # start
+00027a10: 7320 7769 7468 2061 6e20 756e 6465 7273  s with an unders
+00027a20: 636f 7265 0a20 2020 2020 2020 2027 6162  core.        'ab
+00027a30: 635f 272c 2020 2320 656e 6473 2077 6974  c_',  # ends wit
+00027a40: 6820 616e 2075 6e64 6572 7363 6f72 650a  h an underscore.
+00027a50: 2020 2020 5d0a 0a20 2020 2049 424d 5f49      ]..    IBM_I
+00027a60: 4e56 414c 4944 5f4e 414d 4553 203d 205b  NVALID_NAMES = [
+00027a70: 0a20 2020 2020 2020 2027 6162 272c 2020  .        'ab',  
+00027a80: 2320 6c65 7373 2074 6861 6e20 3320 6368  # less than 3 ch
+00027a90: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
+00027aa0: 2027 6162 6364 6566 6768 696a 6b6c 6d6e   'abcdefghijklmn
+00027ab0: 6f70 7172 7374 7576 7778 797a 6162 6364  opqrstuvwxyzabcd
+00027ac0: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
+00027ad0: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
+00027ae0: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
+00027af0: 3127 2c0a 2020 2020 2020 2020 2320 6d6f  1',.        # mo
+00027b00: 7265 2074 6861 6e20 3633 2063 6861 7261  re than 63 chara
+00027b10: 6374 6572 730a 2020 2020 2020 2020 2741  cters.        'A
+00027b20: 6263 6465 6627 2c20 2023 2063 6f6e 7461  bcdef',  # conta
+00027b30: 696e 7320 616e 2075 7070 6572 6361 7365  ins an uppercase
+00027b40: 206c 6574 7465 720a 2020 2020 2020 2020   letter.        
+00027b50: 2761 6263 2064 6566 272c 2020 2320 636f  'abc def',  # co
+00027b60: 6e74 6169 6e73 2061 2073 7061 6365 0a20  ntains a space. 
+00027b70: 2020 2020 2020 2027 6162 632e 2e64 6566         'abc..def
+00027b80: 272c 2020 2320 7477 6f20 6164 6a61 6365  ',  # two adjace
+00027b90: 6e74 2070 6572 696f 6473 0a20 2020 2020  nt periods.     
+00027ba0: 2020 2027 3139 322e 3136 382e 352e 3427     '192.168.5.4'
+00027bb0: 2c20 2023 2066 6f72 6d61 7474 6564 2061  ,  # formatted a
+00027bc0: 7320 616e 2049 5020 6164 6472 6573 730a  s an IP address.
+00027bd0: 2020 2020 2020 2020 2778 6e2d 2d62 7563          'xn--buc
+00027be0: 6b65 7427 2c20 2023 2073 7461 7274 7320  ket',  # starts 
+00027bf0: 7769 7468 2027 786e 2d2d 2720 7072 6566  with 'xn--' pref
+00027c00: 6978 0a20 2020 2020 2020 2027 2e61 6263  ix.        '.abc
+00027c10: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
+00027c20: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
+00027c30: 2761 6263 2e27 2c20 2023 2065 6e64 7320  'abc.',  # ends 
+00027c40: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
+00027c50: 2020 2027 2d61 6263 272c 2020 2320 7374     '-abc',  # st
+00027c60: 6172 7473 2077 6974 6820 6120 6879 7068  arts with a hyph
+00027c70: 656e 0a20 2020 2020 2020 2027 6162 632d  en.        'abc-
+00027c80: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
+00027c90: 6120 6879 7068 656e 0a20 2020 2020 2020  a hyphen.       
+00027ca0: 2027 612e 2d62 6327 2c20 2023 2063 6f6e   'a.-bc',  # con
+00027cb0: 7461 696e 7320 7468 6520 7365 7175 656e  tains the sequen
+00027cc0: 6365 2027 2e2d 270a 2020 2020 2020 2020  ce '.-'.        
+00027cd0: 2761 2d2e 6263 272c 2020 2320 636f 6e74  'a-.bc',  # cont
+00027ce0: 6169 6e73 2074 6865 2073 6571 7565 6e63  ains the sequenc
+00027cf0: 6520 272d 2e27 0a20 2020 2020 2020 2027  e '-.'.        '
+00027d00: 6126 6263 2720 2023 2063 6f6e 7461 696e  a&bc'  # contain
+00027d10: 7320 7370 6563 6961 6c20 6368 6172 6163  s special charac
+00027d20: 7465 7273 0a20 2020 2020 2020 2027 6162  ters.        'ab
+00027d30: 5e63 2720 2023 2063 6f6e 7461 696e 7320  ^c'  # contains 
+00027d40: 7370 6563 6961 6c20 6368 6172 6163 7465  special characte
+00027d50: 7273 0a20 2020 205d 0a20 2020 2047 4954  rs.    ].    GIT
+00027d60: 4947 4e4f 5245 5f53 594e 435f 5445 5354  IGNORE_SYNC_TEST
+00027d70: 5f44 4952 5f53 5452 5543 5455 5245 203d  _DIR_STRUCTURE =
+00027d80: 207b 0a20 2020 2020 2020 2027 646f 7562   {.        'doub
+00027d90: 6c65 5f61 7374 6572 6973 6b27 3a20 7b0a  le_asterisk': {.
+00027da0: 2020 2020 2020 2020 2020 2020 2764 6f75              'dou
+00027db0: 626c 655f 6173 7465 7269 736b 5f65 7863  ble_asterisk_exc
+00027dc0: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
+00027dd0: 2020 2020 2020 2020 2020 2764 6f75 626c            'doubl
+00027de0: 655f 6173 7465 7269 736b 5f65 7863 6c75  e_asterisk_exclu
+00027df0: 6465 645f 6469 7227 3a20 7b0a 2020 2020  ded_dir': {.    
+00027e00: 2020 2020 2020 2020 2020 2020 2764 6972              'dir
+00027e10: 5f65 7863 6c75 6465 6427 3a20 4e6f 6e65  _excluded': None
+00027e20: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
+00027e30: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+00027e40: 2020 2020 2764 6f75 626c 655f 6173 7465      'double_aste
+00027e50: 7269 736b 5f70 6172 656e 7427 3a20 7b0a  risk_parent': {.
+00027e60: 2020 2020 2020 2020 2020 2020 2770 6172              'par
+00027e70: 656e 7427 3a20 7b0a 2020 2020 2020 2020  ent': {.        
+00027e80: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
+00027e90: 636c 7564 6564 2e74 7874 273a 204e 6f6e  cluded.txt': Non
+00027ea0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00027eb0: 2020 2027 6368 696c 6427 3a20 7b0a 2020     'child': {.  
+00027ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ed0: 2020 2764 6f75 626c 655f 6173 7465 7269    'double_asteri
+00027ee0: 736b 5f70 6172 656e 745f 6368 696c 645f  sk_parent_child_
+00027ef0: 6578 636c 7564 6564 2e74 7874 273a 204e  excluded.txt': N
+00027f00: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00027f10: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00027f20: 2020 2020 2020 2020 2764 6f75 626c 655f          'double_
+00027f30: 6173 7465 7269 736b 5f70 6172 656e 745f  asterisk_parent_
+00027f40: 6578 636c 7564 6564 2e74 7874 273a 204e  excluded.txt': N
+00027f50: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00027f60: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
+00027f70: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
+00027f80: 2e6c 6f67 273a 204e 6f6e 652c 0a20 2020  .log': None,.   
+00027f90: 2020 2020 2027 6578 636c 7564 6564 5f64       'excluded_d
+00027fa0: 6972 273a 207b 0a20 2020 2020 2020 2020  ir': {.         
+00027fb0: 2020 2027 6578 636c 7564 6564 2e74 7874     'excluded.txt
+00027fc0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+00027fd0: 2020 2020 2027 6e65 7374 6564 5f65 7863       'nested_exc
+00027fe0: 6c75 6465 6427 3a20 7b0a 2020 2020 2020  luded': {.      
+00027ff0: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
+00028000: 6465 6427 3a20 4e6f 6e65 2c0a 2020 2020  ded': None,.    
+00028010: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00028020: 2020 207d 2c0a 2020 2020 2020 2020 2765     },.        'e
+00028030: 7870 2d31 273a 207b 0a20 2020 2020 2020  xp-1': {.       
+00028040: 2020 2020 2027 6265 5f65 7863 6c75 6465       'be_exclude
+00028050: 6427 3a20 4e6f 6e65 2c0a 2020 2020 2020  d': None,.      
+00028060: 2020 7d2c 0a20 2020 2020 2020 2027 6578    },.        'ex
+00028070: 702d 3227 3a20 7b0a 2020 2020 2020 2020  p-2': {.        
+00028080: 2020 2020 2762 655f 6578 636c 7564 6564      'be_excluded
+00028090: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+000280a0: 207d 2c0a 2020 2020 2020 2020 2766 726f   },.        'fro
+000280b0: 6e74 5f73 6c61 7368 5f65 7863 6c75 6465  nt_slash_exclude
+000280c0: 6427 3a20 4e6f 6e65 2c0a 2020 2020 2020  d': None,.      
+000280d0: 2020 2769 6e63 6c75 6465 642e 6c6f 6727    'included.log'
+000280e0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+000280f0: 2769 6e63 6c75 6465 642e 7478 7427 3a20  'included.txt': 
+00028100: 4e6f 6e65 2c0a 2020 2020 2020 2020 2769  None,.        'i
+00028110: 6e63 6c75 6465 5f64 6972 273a 207b 0a20  nclude_dir': {. 
+00028120: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
+00028130: 7564 6564 2e6c 6f67 273a 204e 6f6e 652c  uded.log': None,
+00028140: 0a20 2020 2020 2020 2020 2020 2027 696e  .            'in
+00028150: 636c 7564 6564 2e6c 6f67 273a 204e 6f6e  cluded.log': Non
+00028160: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
+00028170: 2020 2020 2020 276e 6573 7465 645f 646f        'nested_do
+00028180: 7562 6c65 5f61 7374 6572 6973 6b27 3a20  uble_asterisk': 
+00028190: 7b0a 2020 2020 2020 2020 2020 2020 276f  {.            'o
+000281a0: 6e65 273a 207b 0a20 2020 2020 2020 2020  ne': {.         
+000281b0: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
+000281c0: 6c75 6465 2e74 7874 273a 204e 6f6e 652c  lude.txt': None,
+000281d0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+000281e0: 2020 2020 2020 2020 2020 2020 2774 776f              'two
+000281f0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00028200: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
+00028210: 6465 2e74 7874 273a 204e 6f6e 652c 0a20  de.txt': None,. 
+00028220: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00028230: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00028240: 2027 6e65 7374 6564 5f77 696c 6463 6172   'nested_wildcar
+00028250: 645f 6469 7227 3a20 7b0a 2020 2020 2020  d_dir': {.      
+00028260: 2020 2020 2020 276d 6f6e 6461 7927 3a20        'monday': 
+00028270: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00028280: 2020 2761 6c73 6f5f 6578 636c 7564 652e    'also_exclude.
+00028290: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
+000282a0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+000282b0: 2020 2020 2020 2027 7475 6573 6461 7927         'tuesday'
+000282c0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+000282d0: 2020 2020 2761 6c73 6f5f 6578 636c 7564      'also_exclud
+000282e0: 652e 7478 7427 3a20 4e6f 6e65 2c0a 2020  e.txt': None,.  
+000282f0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00028300: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00028310: 276e 6f5f 736c 6173 685f 6578 636c 7564  'no_slash_exclud
+00028320: 6564 273a 204e 6f6e 652c 0a20 2020 2020  ed': None,.     
+00028330: 2020 2027 6e6f 5f73 6c61 7368 5f74 6573     'no_slash_tes
+00028340: 7473 273a 207b 0a20 2020 2020 2020 2020  ts': {.         
+00028350: 2020 2027 6e6f 5f73 6c61 7368 5f65 7863     'no_slash_exc
+00028360: 6c75 6465 6427 3a20 7b0a 2020 2020 2020  luded': {.      
+00028370: 2020 2020 2020 2020 2020 2761 6c73 6f5f            'also_
+00028380: 6578 636c 7564 6564 2e74 7874 273a 204e  excluded.txt': N
+00028390: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+000283a0: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
+000283b0: 2020 2020 2020 2027 7175 6573 7469 6f6e         'question
+000283c0: 5f6d 6172 6b27 3a20 7b0a 2020 2020 2020  _mark': {.      
+000283d0: 2020 2020 2020 2765 7863 6c75 6465 6431        'excluded1
+000283e0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
+000283f0: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
+00028400: 6564 402e 7478 7427 3a20 4e6f 6e65 2c0a  ed@.txt': None,.
+00028410: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00028420: 2020 2027 7371 7561 7265 5f62 7261 636b     'square_brack
+00028430: 6574 273a 207b 0a20 2020 2020 2020 2020  et': {.         
+00028440: 2020 2027 6578 636c 7564 6564 312e 7478     'excluded1.tx
+00028450: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00028460: 2020 7d2c 0a20 2020 2020 2020 2027 7371    },.        'sq
+00028470: 7561 7265 5f62 7261 636b 6574 5f61 6c70  uare_bracket_alp
+00028480: 6861 273a 207b 0a20 2020 2020 2020 2020  ha': {.         
+00028490: 2020 2027 6578 636c 7564 6564 7a2e 7478     'excludedz.tx
+000284a0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+000284b0: 2020 7d2c 0a20 2020 2020 2020 2027 7371    },.        'sq
+000284c0: 7561 7265 5f62 7261 636b 6574 5f65 7863  uare_bracket_exc
+000284d0: 6c61 273a 207b 0a20 2020 2020 2020 2020  la': {.         
+000284e0: 2020 2027 6578 636c 7564 6564 322e 7478     'excluded2.tx
+000284f0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00028500: 2020 2020 2020 2765 7863 6c75 6465 6440        'excluded@
+00028510: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
+00028520: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00028530: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
+00028540: 7369 6e67 6c65 273a 207b 0a20 2020 2020  single': {.     
+00028550: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
+00028560: 302e 7478 7427 3a20 4e6f 6e65 2c0a 2020  0.txt': None,.  
+00028570: 2020 2020 2020 7d2c 0a20 2020 207d 0a0a        },.    }..
+00028580: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+00028590: 640a 2020 2020 6465 6620 6372 6561 7465  d.    def create
+000285a0: 5f64 6972 5f73 7472 7563 7475 7265 2862  _dir_structure(b
+000285b0: 6173 655f 7061 7468 2c20 7374 7275 6374  ase_path, struct
+000285c0: 7572 6529 3a0a 2020 2020 2020 2020 2320  ure):.        # 
+000285d0: 6372 6561 7465 7320 6120 6769 7665 6e20  creates a given 
+000285e0: 6669 6c65 2053 5452 5543 5455 5245 2069  file STRUCTURE i
+000285f0: 6e20 4241 5345 5f50 4154 480a 2020 2020  n BASE_PATH.    
+00028600: 2020 2020 666f 7220 6e61 6d65 2c20 7375      for name, su
+00028610: 6273 7472 7563 7475 7265 2069 6e20 7374  bstructure in st
+00028620: 7275 6374 7572 652e 6974 656d 7328 293a  ructure.items():
+00028630: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+00028640: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+00028650: 2862 6173 655f 7061 7468 2c20 6e61 6d65  (base_path, name
+00028660: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00028670: 2073 7562 7374 7275 6374 7572 6520 6973   substructure is
+00028680: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00028690: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
+000286a0: 6120 6669 6c65 0a20 2020 2020 2020 2020  a file.         
+000286b0: 2020 2020 2020 206f 7065 6e28 7061 7468         open(path
+000286c0: 2c20 2761 272c 2065 6e63 6f64 696e 673d  , 'a', encoding=
+000286d0: 2775 7466 2d38 2729 2e63 6c6f 7365 2829  'utf-8').close()
+000286e0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000286f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00028700: 2020 2023 2043 7265 6174 6520 6120 7375     # Create a su
+00028710: 6264 6972 6563 746f 7279 0a20 2020 2020  bdirectory.     
+00028720: 2020 2020 2020 2020 2020 206f 732e 6d6b             os.mk
+00028730: 6469 7228 7061 7468 290a 2020 2020 2020  dir(path).      
+00028740: 2020 2020 2020 2020 2020 5465 7374 5374            TestSt
+00028750: 6f72 6167 6557 6974 6843 7265 6465 6e74  orageWithCredent
+00028760: 6961 6c73 2e63 7265 6174 655f 6469 725f  ials.create_dir_
+00028770: 7374 7275 6374 7572 6528 0a20 2020 2020  structure(.     
+00028780: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00028790: 6174 682c 2073 7562 7374 7275 6374 7572  ath, substructur
+000287a0: 6529 0a0a 2020 2020 4073 7461 7469 636d  e)..    @staticm
+000287b0: 6574 686f 640a 2020 2020 6465 6620 636c  ethod.    def cl
+000287c0: 695f 6465 6c65 7465 5f63 6d64 2873 746f  i_delete_cmd(sto
+000287d0: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
+000287e0: 6e61 6d65 293a 0a20 2020 2020 2020 2069  name):.        i
+000287f0: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
+00028800: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00028810: 6554 7970 652e 5333 3a0a 2020 2020 2020  eType.S3:.      
+00028820: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
+00028830: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+00028840: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
+00028850: 7475 726e 2066 2761 7773 2073 3320 7262  turn f'aws s3 rb
+00028860: 207b 7572 6c7d 202d 2d66 6f72 6365 270a   {url} --force'.
+00028870: 2020 2020 2020 2020 6966 2073 746f 7265          if store
+00028880: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
+00028890: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
+000288a0: 4353 3a0a 2020 2020 2020 2020 2020 2020  CS:.            
+000288b0: 7572 6c20 3d20 6627 6773 3a2f 2f7b 6275  url = f'gs://{bu
+000288c0: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
+000288d0: 2020 2020 2020 2020 6773 7574 696c 5f61          gsutil_a
+000288e0: 6c69 6173 2c20 616c 6961 735f 6765 6e20  lias, alias_gen 
+000288f0: 3d20 6461 7461 5f75 7469 6c73 2e67 6574  = data_utils.get
+00028900: 5f67 7375 7469 6c5f 636f 6d6d 616e 6428  _gsutil_command(
+00028910: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00028920: 7475 726e 2066 277b 616c 6961 735f 6765  turn f'{alias_ge
+00028930: 6e7d 3b20 7b67 7375 7469 6c5f 616c 6961  n}; {gsutil_alia
+00028940: 737d 2072 6d20 2d72 207b 7572 6c7d 270a  s} rm -r {url}'.
+00028950: 2020 2020 2020 2020 6966 2073 746f 7265          if store
+00028960: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
+00028970: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
+00028980: 323a 0a20 2020 2020 2020 2020 2020 2065  2:.            e
+00028990: 6e64 706f 696e 745f 7572 6c20 3d20 636c  ndpoint_url = cl
+000289a0: 6f75 6466 6c61 7265 2e63 7265 6174 655f  oudflare.create_
+000289b0: 656e 6470 6f69 6e74 2829 0a20 2020 2020  endpoint().     
+000289c0: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
+000289d0: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
+000289e0: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
+000289f0: 6574 7572 6e20 6627 4157 535f 5348 4152  eturn f'AWS_SHAR
+00028a00: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
+00028a10: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
+00028a20: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
+00028a30: 4154 487d 2061 7773 2073 3320 7262 207b  ATH} aws s3 rb {
+00028a40: 7572 6c7d 202d 2d66 6f72 6365 202d 2d65  url} --force --e
+00028a50: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
+00028a60: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
+00028a70: 3d72 3227 0a20 2020 2020 2020 2069 6620  =r2'.        if 
+00028a80: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+00028a90: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00028aa0: 7970 652e 4942 4d3a 0a20 2020 2020 2020  ype.IBM:.       
+00028ab0: 2020 2020 2062 7563 6b65 745f 7263 6c6f       bucket_rclo
+00028ac0: 6e65 5f70 726f 6669 6c65 203d 2052 636c  ne_profile = Rcl
+00028ad0: 6f6e 652e 6765 6e65 7261 7465 5f72 636c  one.generate_rcl
+00028ae0: 6f6e 655f 6275 636b 6574 5f70 726f 6669  one_bucket_profi
+00028af0: 6c65 5f6e 616d 6528 0a20 2020 2020 2020  le_name(.       
+00028b00: 2020 2020 2020 2020 2062 7563 6b65 745f           bucket_
+00028b10: 6e61 6d65 2c20 5263 6c6f 6e65 2e52 636c  name, Rclone.Rcl
+00028b20: 6f6e 6543 6c6f 7564 732e 4942 4d29 0a20  oneClouds.IBM). 
+00028b30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00028b40: 6e20 6627 7263 6c6f 6e65 2070 7572 6765  n f'rclone purge
+00028b50: 207b 6275 636b 6574 5f72 636c 6f6e 655f   {bucket_rclone_
+00028b60: 7072 6f66 696c 657d 3a7b 6275 636b 6574  profile}:{bucket
+00028b70: 5f6e 616d 657d 2026 2620 7263 6c6f 6e65  _name} && rclone
+00028b80: 2063 6f6e 6669 6720 6465 6c65 7465 207b   config delete {
+00028b90: 6275 636b 6574 5f72 636c 6f6e 655f 7072  bucket_rclone_pr
+00028ba0: 6f66 696c 657d 270a 0a20 2020 2040 7374  ofile}'..    @st
+00028bb0: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+00028bc0: 6566 2063 6c69 5f6c 735f 636d 6428 7374  ef cli_ls_cmd(st
+00028bd0: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
+00028be0: 5f6e 616d 652c 2073 7566 6669 783d 2727  _name, suffix=''
+00028bf0: 293a 0a20 2020 2020 2020 2069 6620 7374  ):.        if st
+00028c00: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+00028c10: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00028c20: 652e 5333 3a0a 2020 2020 2020 2020 2020  e.S3:.          
+00028c30: 2020 6966 2073 7566 6669 783a 0a20 2020    if suffix:.   
+00028c40: 2020 2020 2020 2020 2020 2020 2075 726c               url
+00028c50: 203d 2066 2773 333a 2f2f 7b62 7563 6b65   = f's3://{bucke
+00028c60: 745f 6e61 6d65 7d2f 7b73 7566 6669 787d  t_name}/{suffix}
+00028c70: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
+00028c80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00028c90: 2020 2020 7572 6c20 3d20 6627 7333 3a2f      url = f's3:/
+00028ca0: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
+00028cb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00028cc0: 726e 2066 2761 7773 2073 3320 6c73 207b  rn f'aws s3 ls {
+00028cd0: 7572 6c7d 270a 2020 2020 2020 2020 6966  url}'.        if
+00028ce0: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
+00028cf0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00028d00: 5479 7065 2e47 4353 3a0a 2020 2020 2020  Type.GCS:.      
+00028d10: 2020 2020 2020 6966 2073 7566 6669 783a        if suffix:
+00028d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028d30: 2075 726c 203d 2066 2767 733a 2f2f 7b62   url = f'gs://{b
+00028d40: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
+00028d50: 6669 787d 270a 2020 2020 2020 2020 2020  fix}'.          
+00028d60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00028d70: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
+00028d80: 6773 3a2f 2f7b 6275 636b 6574 5f6e 616d  gs://{bucket_nam
+00028d90: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
+00028da0: 7265 7475 726e 2066 2767 7375 7469 6c20  return f'gsutil 
+00028db0: 6c73 207b 7572 6c7d 270a 2020 2020 2020  ls {url}'.      
+00028dc0: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
+00028dd0: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+00028de0: 746f 7265 5479 7065 2e52 323a 0a20 2020  toreType.R2:.   
+00028df0: 2020 2020 2020 2020 2065 6e64 706f 696e           endpoin
+00028e00: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
+00028e10: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
+00028e20: 6e74 2829 0a20 2020 2020 2020 2020 2020  nt().           
+00028e30: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
+00028e40: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
+00028e50: 3d20 6627 7333 3a2f 2f7b 6275 636b 6574  = f's3://{bucket
+00028e60: 5f6e 616d 657d 2f7b 7375 6666 6978 7d27  _name}/{suffix}'
+00028e70: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00028e80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00028e90: 2020 2075 726c 203d 2066 2773 333a 2f2f     url = f's3://
+00028ea0: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
+00028eb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00028ec0: 6e20 6627 4157 535f 5348 4152 4544 5f43  n f'AWS_SHARED_C
+00028ed0: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
+00028ee0: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
+00028ef0: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
+00028f00: 2061 7773 2073 3320 6c73 207b 7572 6c7d   aws s3 ls {url}
+00028f10: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
+00028f20: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
+00028f30: 6669 6c65 3d72 3227 0a20 2020 2020 2020  file=r2'.       
+00028f40: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
+00028f50: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+00028f60: 6f72 6554 7970 652e 4942 4d3a 0a20 2020  oreType.IBM:.   
+00028f70: 2020 2020 2020 2020 2062 7563 6b65 745f           bucket_
+00028f80: 7263 6c6f 6e65 5f70 726f 6669 6c65 203d  rclone_profile =
+00028f90: 2052 636c 6f6e 652e 6765 6e65 7261 7465   Rclone.generate
+00028fa0: 5f72 636c 6f6e 655f 6275 636b 6574 5f70  _rclone_bucket_p
+00028fb0: 726f 6669 6c65 5f6e 616d 6528 0a20 2020  rofile_name(.   
+00028fc0: 2020 2020 2020 2020 2020 2020 2062 7563               buc
+00028fd0: 6b65 745f 6e61 6d65 2c20 5263 6c6f 6e65  ket_name, Rclone
+00028fe0: 2e52 636c 6f6e 6543 6c6f 7564 732e 4942  .RcloneClouds.IB
+00028ff0: 4d29 0a20 2020 2020 2020 2020 2020 2072  M).            r
+00029000: 6574 7572 6e20 6627 7263 6c6f 6e65 206c  eturn f'rclone l
+00029010: 7320 7b62 7563 6b65 745f 7263 6c6f 6e65  s {bucket_rclone
+00029020: 5f70 726f 6669 6c65 7d3a 7b62 7563 6b65  _profile}:{bucke
+00029030: 745f 6e61 6d65 7d2f 7b73 7566 6669 787d  t_name}/{suffix}
+00029040: 270a 0a20 2020 2040 7374 6174 6963 6d65  '..    @staticme
+00029050: 7468 6f64 0a20 2020 2064 6566 2063 6c69  thod.    def cli
+00029060: 5f72 6567 696f 6e5f 636d 6428 7374 6f72  _region_cmd(stor
+00029070: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
+00029080: 616d 6529 3a0a 2020 2020 2020 2020 6966  ame):.        if
+00029090: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
+000290a0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+000290b0: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
+000290c0: 2020 2020 2072 6574 7572 6e20 2827 6177       return ('aw
+000290d0: 7320 7333 6170 6920 6765 742d 6275 636b  s s3api get-buck
+000290e0: 6574 2d6c 6f63 6174 696f 6e20 270a 2020  et-location '.  
 000290f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029100: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-00029110: 653d 736f 7572 6365 2c0a 2020 2020 2020  e=source,.      
-00029120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029140: 2020 2020 7374 6f72 6573 3d73 746f 7265      stores=store
-00029150: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00029160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029170: 2020 2020 2020 2020 2020 2020 2070 6572               per
-00029180: 7369 7374 656e 743d 7065 7273 6973 7465  sistent=persiste
-00029190: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+00029100: 2020 6627 2d2d 6275 636b 6574 207b 6275    f'--bucket {bu
+00029110: 636b 6574 5f6e 616d 657d 202d 2d6f 7574  cket_name} --out
+00029120: 7075 7420 7465 7874 2729 0a20 2020 2020  put text').     
+00029130: 2020 2065 6c69 6620 7374 6f72 655f 7479     elif store_ty
+00029140: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
+00029150: 622e 5374 6f72 6554 7970 652e 4743 533a  b.StoreType.GCS:
+00029160: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00029170: 7572 6e20 2866 2767 7375 7469 6c20 6c73  urn (f'gsutil ls
+00029180: 202d 4c20 2d62 2067 733a 2f2f 7b62 7563   -L -b gs://{buc
+00029190: 6b65 745f 6e61 6d65 7d2f 207c 2027 0a20  ket_name}/ | '. 
 000291a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000291b0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-000291c0: 6465 3d6d 6f64 6529 0a20 2020 2020 2020  de=mode).       
-000291d0: 2079 6965 6c64 2073 746f 7261 6765 5f6f   yield storage_o
-000291e0: 626a 0a20 2020 2020 2020 2068 616e 646c  bj.        handl
-000291f0: 6520 3d20 676c 6f62 616c 5f75 7365 725f  e = global_user_
-00029200: 7374 6174 652e 6765 745f 6861 6e64 6c65  state.get_handle
-00029210: 5f66 726f 6d5f 7374 6f72 6167 655f 6e61  _from_storage_na
-00029220: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
-00029230: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-00029240: 290a 2020 2020 2020 2020 6966 2068 616e  ).        if han
-00029250: 646c 653a 0a20 2020 2020 2020 2020 2020  dle:.           
-00029260: 2023 2049 6620 6861 6e64 6c65 2065 7869   # If handle exi
-00029270: 7374 732c 2064 656c 6574 6520 6d61 6e75  sts, delete manu
-00029280: 616c 6c79 0a20 2020 2020 2020 2020 2020  ally.           
-00029290: 2023 2054 4f44 4f28 726f 6d69 6c62 293a   # TODO(romilb):
-000292a0: 2054 6869 7320 6973 2070 6f74 656e 7469   This is potenti
-000292b0: 616c 6c79 2072 6973 6b79 202d 2069 6620  ally risky - if 
-000292c0: 7468 6520 6465 6c65 7465 206d 6574 686f  the delete metho
-000292d0: 6420 6861 730a 2020 2020 2020 2020 2020  d has.          
-000292e0: 2020 2320 2020 6275 6773 2c20 7468 6973    #   bugs, this
-000292f0: 2063 616e 2063 6175 7365 2072 6573 6f75   can cause resou
-00029300: 7263 6520 6c65 616b 732e 2049 6465 616c  rce leaks. Ideal
-00029310: 6c79 2077 6520 7368 6f75 6c64 206d 616e  ly we should man
-00029320: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
-00029330: 2020 2320 2020 656a 6563 7420 7374 6f72    #   eject stor
-00029340: 6167 6520 6672 6f6d 2067 6c6f 6261 6c5f  age from global_
-00029350: 7573 6572 5f73 7461 7465 2061 6e64 2064  user_state and d
-00029360: 656c 6574 6520 7468 6520 6275 636b 6574  elete the bucket
-00029370: 2075 7369 6e67 0a20 2020 2020 2020 2020   using.         
-00029380: 2020 2023 2020 2062 6f74 6f33 2064 6972     #   boto3 dir
-00029390: 6563 746c 792e 0a20 2020 2020 2020 2020  ectly..         
-000293a0: 2020 2073 746f 7261 6765 5f6f 626a 2e64     storage_obj.d
-000293b0: 656c 6574 6528 290a 0a20 2020 2040 7079  elete()..    @py
-000293c0: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-000293d0: 2064 6566 2074 6d70 5f73 6372 6174 6368   def tmp_scratch
-000293e0: 5f73 746f 7261 6765 5f6f 626a 2873 656c  _storage_obj(sel
-000293f0: 662c 2074 6d70 5f62 7563 6b65 745f 6e61  f, tmp_bucket_na
-00029400: 6d65 293a 0a20 2020 2020 2020 2023 2043  me):.        # C
-00029410: 7265 6174 6573 2061 2073 746f 7261 6765  reates a storage
-00029420: 206f 626a 6563 7420 7769 7468 206e 6f20   object with no 
-00029430: 736f 7572 6365 2074 6f20 6372 6561 7465  source to create
-00029440: 2061 2073 6372 6174 6368 2073 746f 7261   a scratch stora
-00029450: 6765 2e0a 2020 2020 2020 2020 2320 5374  ge..        # St
-00029460: 6f72 6573 206d 7573 7420 6265 2061 6464  ores must be add
-00029470: 6564 2069 6e20 7468 6520 7465 7374 2e0a  ed in the test..
-00029480: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-00029490: 6f6d 2073 656c 662e 7969 656c 645f 7374  om self.yield_st
-000294a0: 6f72 6167 655f 6f62 6a65 6374 286e 616d  orage_object(nam
-000294b0: 653d 746d 705f 6275 636b 6574 5f6e 616d  e=tmp_bucket_nam
-000294c0: 6529 0a0a 2020 2020 4070 7974 6573 742e  e)..    @pytest.
-000294d0: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
-000294e0: 746d 705f 6d75 6c74 6970 6c65 5f73 6372  tmp_multiple_scr
-000294f0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-00029500: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00029510: 2320 4372 6561 7465 7320 6120 6c69 7374  # Creates a list
-00029520: 206f 6620 3520 7374 6f72 6167 6520 6f62   of 5 storage ob
-00029530: 6a65 6374 7320 7769 7468 206e 6f20 736f  jects with no so
-00029540: 7572 6365 2074 6f20 6372 6561 7465 0a20  urce to create. 
-00029550: 2020 2020 2020 2023 206d 756c 7469 706c         # multipl
-00029560: 6520 7363 7261 7463 6820 7374 6f72 6167  e scratch storag
-00029570: 6573 2e0a 2020 2020 2020 2020 2320 5374  es..        # St
-00029580: 6f72 6573 2066 6f72 2065 6163 6820 6f62  ores for each ob
-00029590: 6a65 6374 2069 6e20 7468 6520 6c69 7374  ject in the list
-000295a0: 206d 7573 7420 6265 2061 6464 6564 2069   must be added i
-000295b0: 6e20 7468 6520 7465 7374 2e0a 2020 2020  n the test..    
-000295c0: 2020 2020 7374 6f72 6167 655f 6d75 6c74      storage_mult
-000295d0: 5f6f 626a 203d 205b 5d0a 2020 2020 2020  _obj = [].      
-000295e0: 2020 666f 7220 5f20 696e 2072 616e 6765    for _ in range
-000295f0: 2835 293a 0a20 2020 2020 2020 2020 2020  (5):.           
-00029600: 2074 696d 6573 7461 6d70 203d 2073 7472   timestamp = str
-00029610: 2874 696d 652e 7469 6d65 2829 292e 7265  (time.time()).re
-00029620: 706c 6163 6528 272e 272c 2027 2729 0a20  place('.', ''). 
-00029630: 2020 2020 2020 2020 2020 2073 746f 7265             store
-00029640: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
-00029650: 6962 2e53 746f 7261 6765 286e 616d 653d  ib.Storage(name=
-00029660: 6627 736b 792d 7465 7374 2d7b 7469 6d65  f'sky-test-{time
-00029670: 7374 616d 707d 2729 0a20 2020 2020 2020  stamp}').       
-00029680: 2020 2020 2073 746f 7261 6765 5f6d 756c       storage_mul
-00029690: 745f 6f62 6a2e 6170 7065 6e64 2873 746f  t_obj.append(sto
-000296a0: 7265 5f6f 626a 290a 2020 2020 2020 2020  re_obj).        
-000296b0: 7969 656c 6420 7374 6f72 6167 655f 6d75  yield storage_mu
-000296c0: 6c74 5f6f 626a 0a20 2020 2020 2020 2066  lt_obj.        f
-000296d0: 6f72 2073 746f 7261 6765 5f6f 626a 2069  or storage_obj i
-000296e0: 6e20 7374 6f72 6167 655f 6d75 6c74 5f6f  n storage_mult_o
-000296f0: 626a 3a0a 2020 2020 2020 2020 2020 2020  bj:.            
-00029700: 6861 6e64 6c65 203d 2067 6c6f 6261 6c5f  handle = global_
-00029710: 7573 6572 5f73 7461 7465 2e67 6574 5f68  user_state.get_h
-00029720: 616e 646c 655f 6672 6f6d 5f73 746f 7261  andle_from_stora
-00029730: 6765 5f6e 616d 6528 0a20 2020 2020 2020  ge_name(.       
-00029740: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-00029750: 5f6f 626a 2e6e 616d 6529 0a20 2020 2020  _obj.name).     
-00029760: 2020 2020 2020 2069 6620 6861 6e64 6c65         if handle
-00029770: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00029780: 2020 2320 4966 2068 616e 646c 6520 6578    # If handle ex
-00029790: 6973 7473 2c20 6465 6c65 7465 206d 616e  ists, delete man
-000297a0: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
-000297b0: 2020 2020 2020 2320 544f 444f 2872 6f6d        # TODO(rom
-000297c0: 696c 6229 3a20 5468 6973 2069 7320 706f  ilb): This is po
-000297d0: 7465 6e74 6961 6c6c 7920 7269 736b 7920  tentially risky 
-000297e0: 2d20 6966 2074 6865 2064 656c 6574 6520  - if the delete 
-000297f0: 6d65 7468 6f64 2068 6173 0a20 2020 2020  method has.     
-00029800: 2020 2020 2020 2020 2020 2023 2062 7567             # bug
-00029810: 732c 2074 6869 7320 6361 6e20 6361 7573  s, this can caus
-00029820: 6520 7265 736f 7572 6365 206c 6561 6b73  e resource leaks
-00029830: 2e20 4964 6561 6c6c 7920 7765 2073 686f  . Ideally we sho
-00029840: 756c 6420 6d61 6e75 616c 6c79 0a20 2020  uld manually.   
-00029850: 2020 2020 2020 2020 2020 2020 2023 2065               # e
-00029860: 6a65 6374 2073 746f 7261 6765 2066 726f  ject storage fro
-00029870: 6d20 676c 6f62 616c 5f75 7365 725f 7374  m global_user_st
-00029880: 6174 6520 616e 6420 6465 6c65 7465 2074  ate and delete t
-00029890: 6865 2062 7563 6b65 7420 7573 696e 670a  he bucket using.
-000298a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000298b0: 2320 626f 746f 3320 6469 7265 6374 6c79  # boto3 directly
-000298c0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000298d0: 2020 7374 6f72 6167 655f 6f62 6a2e 6465    storage_obj.de
-000298e0: 6c65 7465 2829 0a0a 2020 2020 4070 7974  lete()..    @pyt
-000298f0: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
-00029900: 6465 6620 746d 705f 6d75 6c74 6970 6c65  def tmp_multiple
-00029910: 5f63 7573 746f 6d5f 736f 7572 6365 5f73  _custom_source_s
-00029920: 746f 7261 6765 5f6f 626a 2873 656c 6629  torage_obj(self)
-00029930: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-00029940: 7465 7320 6120 6c69 7374 206f 6620 7374  tes a list of st
-00029950: 6f72 6167 6520 6f62 6a65 6374 7320 7769  orage objects wi
-00029960: 7468 2063 7573 746f 6d20 736f 7572 6365  th custom source
-00029970: 206e 616d 6573 2074 6f0a 2020 2020 2020   names to.      
-00029980: 2020 2320 6372 6561 7465 206d 756c 7469    # create multi
-00029990: 706c 6520 7363 7261 7463 6820 7374 6f72  ple scratch stor
-000299a0: 6167 6573 2e0a 2020 2020 2020 2020 2320  ages..        # 
-000299b0: 5374 6f72 6573 2066 6f72 2065 6163 6820  Stores for each 
-000299c0: 6f62 6a65 6374 2069 6e20 7468 6520 6c69  object in the li
-000299d0: 7374 206d 7573 7420 6265 2061 6464 6564  st must be added
-000299e0: 2069 6e20 7468 6520 7465 7374 2e0a 2020   in the test..  
-000299f0: 2020 2020 2020 6375 7374 6f6d 5f73 6f75        custom_sou
-00029a00: 7263 655f 6e61 6d65 7320 3d20 5b27 2270  rce_names = ['"p
-00029a10: 6174 6820 5769 7468 2053 7061 6365 7322  ath With Spaces"
-00029a20: 272c 2027 7061 7468 2057 6974 6820 5370  ', 'path With Sp
-00029a30: 6163 6573 275d 0a20 2020 2020 2020 2073  aces'].        s
-00029a40: 746f 7261 6765 5f6d 756c 745f 6f62 6a20  torage_mult_obj 
-00029a50: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00029a60: 206e 616d 6520 696e 2063 7573 746f 6d5f   name in custom_
-00029a70: 736f 7572 6365 5f6e 616d 6573 3a0a 2020  source_names:.  
-00029a80: 2020 2020 2020 2020 2020 7372 635f 7061            src_pa
-00029a90: 7468 203d 206f 732e 7061 7468 2e65 7870  th = os.path.exp
-00029aa0: 616e 6475 7365 7228 6627 7e2f 7b6e 616d  anduser(f'~/{nam
-00029ab0: 657d 2729 0a20 2020 2020 2020 2020 2020  e}').           
-00029ac0: 2070 6174 686c 6962 2e50 6174 6828 7372   pathlib.Path(sr
-00029ad0: 635f 7061 7468 292e 6578 7061 6e64 7573  c_path).expandus
-00029ae0: 6572 2829 2e6d 6b64 6972 2865 7869 7374  er().mkdir(exist
-00029af0: 5f6f 6b3d 5472 7565 290a 2020 2020 2020  _ok=True).      
-00029b00: 2020 2020 2020 7469 6d65 7374 616d 7020        timestamp 
-00029b10: 3d20 7374 7228 7469 6d65 2e74 696d 6528  = str(time.time(
-00029b20: 2929 2e72 6570 6c61 6365 2827 2e27 2c20  )).replace('.', 
-00029b30: 2727 290a 2020 2020 2020 2020 2020 2020  '').            
-00029b40: 7374 6f72 655f 6f62 6a20 3d20 7374 6f72  store_obj = stor
-00029b50: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
-00029b60: 6e61 6d65 3d66 2773 6b79 2d74 6573 742d  name=f'sky-test-
-00029b70: 7b74 696d 6573 7461 6d70 7d27 2c0a 2020  {timestamp}',.  
-00029b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029ba0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00029bb0: 3d73 7263 5f70 6174 6829 0a20 2020 2020  =src_path).     
-00029bc0: 2020 2020 2020 2073 746f 7261 6765 5f6d         storage_m
-00029bd0: 756c 745f 6f62 6a2e 6170 7065 6e64 2873  ult_obj.append(s
-00029be0: 746f 7265 5f6f 626a 290a 2020 2020 2020  tore_obj).      
-00029bf0: 2020 7969 656c 6420 7374 6f72 6167 655f    yield storage_
-00029c00: 6d75 6c74 5f6f 626a 0a20 2020 2020 2020  mult_obj.       
-00029c10: 2066 6f72 2073 746f 7261 6765 5f6f 626a   for storage_obj
-00029c20: 2069 6e20 7374 6f72 6167 655f 6d75 6c74   in storage_mult
-00029c30: 5f6f 626a 3a0a 2020 2020 2020 2020 2020  _obj:.          
-00029c40: 2020 6861 6e64 6c65 203d 2067 6c6f 6261    handle = globa
-00029c50: 6c5f 7573 6572 5f73 7461 7465 2e67 6574  l_user_state.get
-00029c60: 5f68 616e 646c 655f 6672 6f6d 5f73 746f  _handle_from_sto
-00029c70: 7261 6765 5f6e 616d 6528 0a20 2020 2020  rage_name(.     
-00029c80: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-00029c90: 6765 5f6f 626a 2e6e 616d 6529 0a20 2020  ge_obj.name).   
-00029ca0: 2020 2020 2020 2020 2069 6620 6861 6e64           if hand
-00029cb0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-00029cc0: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
-00029cd0: 6465 6c65 7465 2829 0a0a 2020 2020 4070  delete()..    @p
-00029ce0: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-00029cf0: 2020 6465 6620 746d 705f 6c6f 6361 6c5f    def tmp_local_
-00029d00: 7374 6f72 6167 655f 6f62 6a28 7365 6c66  storage_obj(self
-00029d10: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
-00029d20: 652c 2074 6d70 5f73 6f75 7263 6529 3a0a  e, tmp_source):.
-00029d30: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-00029d40: 7320 6120 7465 6d70 6f72 6172 7920 7374  s a temporary st
-00029d50: 6f72 6167 6520 6f62 6a65 6374 2e20 5374  orage object. St
-00029d60: 6f72 6573 206d 7573 7420 6265 2061 6464  ores must be add
-00029d70: 6564 2069 6e20 7468 6520 7465 7374 2e0a  ed in the test..
-00029d80: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-00029d90: 6f6d 2073 656c 662e 7969 656c 645f 7374  om self.yield_st
-00029da0: 6f72 6167 655f 6f62 6a65 6374 286e 616d  orage_object(nam
-00029db0: 653d 746d 705f 6275 636b 6574 5f6e 616d  e=tmp_bucket_nam
-00029dc0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00029dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029df0: 736f 7572 6365 3d74 6d70 5f73 6f75 7263  source=tmp_sourc
-00029e00: 6529 0a0a 2020 2020 4070 7974 6573 742e  e)..    @pytest.
-00029e10: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
-00029e20: 746d 705f 6c6f 6361 6c5f 6c69 7374 5f73  tmp_local_list_s
-00029e30: 746f 7261 6765 5f6f 626a 2873 656c 662c  torage_obj(self,
-00029e40: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
-00029e50: 2c20 746d 705f 736f 7572 6365 293a 0a20  , tmp_source):. 
-00029e60: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-00029e70: 2061 2074 656d 7020 7374 6f72 6167 6520   a temp storage 
-00029e80: 6f62 6a65 6374 2077 6869 6368 2075 7365  object which use
-00029e90: 7320 6120 6c69 7374 206f 6620 7061 7468  s a list of path
-00029ea0: 7320 6173 2073 6f75 7263 652e 0a20 2020  s as source..   
-00029eb0: 2020 2020 2023 2053 746f 7265 7320 6d75       # Stores mu
-00029ec0: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
-00029ed0: 6865 2074 6573 742e 2041 6674 6572 2075  he test. After u
-00029ee0: 706c 6f61 642c 2074 6865 2062 7563 6b65  pload, the bucke
-00029ef0: 7420 7368 6f75 6c64 0a20 2020 2020 2020  t should.       
-00029f00: 2023 2068 6176 6520 7477 6f20 6669 6c65   # have two file
-00029f10: 7320 2d20 2f74 6d70 2d66 696c 6520 616e  s - /tmp-file an
-00029f20: 6420 2f74 6d70 2d73 6f75 7263 652f 746d  d /tmp-source/tm
-00029f30: 702d 6669 6c65 0a20 2020 2020 2020 206c  p-file.        l
-00029f40: 6973 745f 736f 7572 6365 203d 205b 746d  ist_source = [tm
-00029f50: 705f 736f 7572 6365 2c20 746d 705f 736f  p_source, tmp_so
-00029f60: 7572 6365 202b 2027 2f74 6d70 2d66 696c  urce + '/tmp-fil
-00029f70: 6527 5d0a 2020 2020 2020 2020 7969 656c  e'].        yiel
-00029f80: 6420 6672 6f6d 2073 656c 662e 7969 656c  d from self.yiel
-00029f90: 645f 7374 6f72 6167 655f 6f62 6a65 6374  d_storage_object
-00029fa0: 286e 616d 653d 746d 705f 6275 636b 6574  (name=tmp_bucket
-00029fb0: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
+000291b0: 2020 2027 6772 6570 2022 4c6f 6361 7469     'grep "Locati
+000291c0: 6f6e 2063 6f6e 7374 7261 696e 7422 207c  on constraint" |
+000291d0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000291e0: 2020 2020 2020 2027 6177 6b20 5c27 7b70         'awk \'{p
+000291f0: 7269 6e74 2074 6f6c 6f77 6572 2824 4e46  rint tolower($NF
+00029200: 297d 5c27 2729 0a20 2020 2020 2020 2065  )}\'').        e
+00029210: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00029220: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
+00029230: 656e 7465 6445 7272 6f72 2866 2752 6567  entedError(f'Reg
+00029240: 696f 6e20 636f 6d6d 616e 6420 6e6f 7420  ion command not 
+00029250: 696d 706c 656d 656e 7465 6420 666f 7220  implemented for 
+00029260: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00029270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029280: 2020 2020 2020 2020 6627 7b73 746f 7265          f'{store
+00029290: 5f74 7970 657d 2729 0a0a 2020 2020 4073  _type}')..    @s
+000292a0: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+000292b0: 6465 6620 636c 695f 636f 756e 745f 6e61  def cli_count_na
+000292c0: 6d65 5f69 6e5f 6275 636b 6574 2873 746f  me_in_bucket(sto
+000292d0: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
+000292e0: 6e61 6d65 2c20 6669 6c65 5f6e 616d 652c  name, file_name,
+000292f0: 2073 7566 6669 783d 2727 293a 0a20 2020   suffix=''):.   
+00029300: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
+00029310: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
+00029320: 622e 5374 6f72 6554 7970 652e 5333 3a0a  b.StoreType.S3:.
+00029330: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00029340: 7566 6669 783a 0a20 2020 2020 2020 2020  uffix:.         
+00029350: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+00029360: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
+00029370: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
+00029380: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
+00029390: 2d2d 7072 6566 6978 207b 7375 6666 6978  --prefix {suffix
+000293a0: 7d20 2d2d 7175 6572 7920 226c 656e 6774  } --query "lengt
+000293b0: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
+000293c0: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
+000293d0: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
+000293e0: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
+000293f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00029400: 2020 2020 7265 7475 726e 2066 2761 7773      return f'aws
+00029410: 2073 3361 7069 206c 6973 742d 6f62 6a65   s3api list-obje
+00029420: 6374 7320 2d2d 6275 636b 6574 2022 7b62  cts --bucket "{b
+00029430: 7563 6b65 745f 6e61 6d65 7d22 202d 2d71  ucket_name}" --q
+00029440: 7565 7279 2022 6c65 6e67 7468 2843 6f6e  uery "length(Con
+00029450: 7465 6e74 735b 3f63 6f6e 7461 696e 7328  tents[?contains(
+00029460: 4b65 792c 5c27 7b66 696c 655f 6e61 6d65  Key,\'{file_name
+00029470: 7d5c 2729 5d2e 4b65 7929 2227 0a20 2020  }\')].Key)"'.   
+00029480: 2020 2020 2065 6c69 6620 7374 6f72 655f       elif store_
+00029490: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+000294a0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+000294b0: 533a 0a20 2020 2020 2020 2020 2020 2069  S:.            i
+000294c0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
+000294d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000294e0: 2066 2767 7375 7469 6c20 6c73 202d 7220   f'gsutil ls -r 
+000294f0: 6773 3a2f 2f7b 6275 636b 6574 5f6e 616d  gs://{bucket_nam
+00029500: 657d 2f7b 7375 6666 6978 7d20 7c20 6772  e}/{suffix} | gr
+00029510: 6570 2022 7b66 696c 655f 6e61 6d65 7d22  ep "{file_name}"
+00029520: 207c 2077 6320 2d6c 270a 2020 2020 2020   | wc -l'.      
+00029530: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00029540: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00029550: 726e 2066 2767 7375 7469 6c20 6c73 202d  rn f'gsutil ls -
+00029560: 7220 6773 3a2f 2f7b 6275 636b 6574 5f6e  r gs://{bucket_n
+00029570: 616d 657d 207c 2067 7265 7020 227b 6669  ame} | grep "{fi
+00029580: 6c65 5f6e 616d 657d 2220 7c20 7763 202d  le_name}" | wc -
+00029590: 6c27 0a20 2020 2020 2020 2065 6c69 6620  l'.        elif 
+000295a0: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+000295b0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+000295c0: 7970 652e 5232 3a0a 2020 2020 2020 2020  ype.R2:.        
+000295d0: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+000295e0: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+000295f0: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+00029600: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00029610: 7566 6669 783a 0a20 2020 2020 2020 2020  uffix:.         
+00029620: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+00029630: 4157 535f 5348 4152 4544 5f43 5245 4445  AWS_SHARED_CREDE
+00029640: 4e54 4941 4c53 5f46 494c 453d 7b63 6c6f  NTIALS_FILE={clo
+00029650: 7564 666c 6172 652e 5232 5f43 5245 4445  udflare.R2_CREDE
+00029660: 4e54 4941 4c53 5f50 4154 487d 2061 7773  NTIALS_PATH} aws
+00029670: 2073 3361 7069 206c 6973 742d 6f62 6a65   s3api list-obje
+00029680: 6374 7320 2d2d 6275 636b 6574 2022 7b62  cts --bucket "{b
+00029690: 7563 6b65 745f 6e61 6d65 7d22 202d 2d70  ucket_name}" --p
+000296a0: 7265 6669 7820 7b73 7566 6669 787d 202d  refix {suffix} -
+000296b0: 2d71 7565 7279 2022 6c65 6e67 7468 2843  -query "length(C
+000296c0: 6f6e 7465 6e74 735b 3f63 6f6e 7461 696e  ontents[?contain
+000296d0: 7328 4b65 792c 5c27 7b66 696c 655f 6e61  s(Key,\'{file_na
+000296e0: 6d65 7d5c 2729 5d2e 4b65 7929 2220 2d2d  me}\')].Key)" --
+000296f0: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
+00029700: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
+00029710: 653d 7232 270a 2020 2020 2020 2020 2020  e=r2'.          
+00029720: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00029730: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00029740: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
+00029750: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
+00029760: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
+00029770: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
+00029780: 7320 7333 6170 6920 6c69 7374 2d6f 626a  s s3api list-obj
+00029790: 6563 7473 202d 2d62 7563 6b65 7420 227b  ects --bucket "{
+000297a0: 6275 636b 6574 5f6e 616d 657d 2220 2d2d  bucket_name}" --
+000297b0: 7175 6572 7920 226c 656e 6774 6828 436f  query "length(Co
+000297c0: 6e74 656e 7473 5b3f 636f 6e74 6169 6e73  ntents[?contains
+000297d0: 284b 6579 2c5c 277b 6669 6c65 5f6e 616d  (Key,\'{file_nam
+000297e0: 657d 5c27 295d 2e4b 6579 2922 202d 2d65  e}\')].Key)" --e
+000297f0: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
+00029800: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
+00029810: 3d72 3227 0a0a 2020 2020 4073 7461 7469  =r2'..    @stati
+00029820: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
+00029830: 636c 695f 636f 756e 745f 6669 6c65 5f69  cli_count_file_i
+00029840: 6e5f 6275 636b 6574 2873 746f 7265 5f74  n_bucket(store_t
+00029850: 7970 652c 2062 7563 6b65 745f 6e61 6d65  ype, bucket_name
+00029860: 293a 0a20 2020 2020 2020 2069 6620 7374  ):.        if st
+00029870: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+00029880: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00029890: 652e 5333 3a0a 2020 2020 2020 2020 2020  e.S3:.          
+000298a0: 2020 7265 7475 726e 2066 2761 7773 2073    return f'aws s
+000298b0: 3320 6c73 2073 333a 2f2f 7b62 7563 6b65  3 ls s3://{bucke
+000298c0: 745f 6e61 6d65 7d20 2d2d 7265 6375 7273  t_name} --recurs
+000298d0: 6976 6520 7c20 7763 202d 6c27 0a20 2020  ive | wc -l'.   
+000298e0: 2020 2020 2065 6c69 6620 7374 6f72 655f       elif store_
+000298f0: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+00029900: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+00029910: 533a 0a20 2020 2020 2020 2020 2020 2072  S:.            r
+00029920: 6574 7572 6e20 6627 6773 7574 696c 206c  eturn f'gsutil l
+00029930: 7320 2d72 2067 733a 2f2f 7b62 7563 6b65  s -r gs://{bucke
+00029940: 745f 6e61 6d65 7d2f 2a2a 207c 2077 6320  t_name}/** | wc 
+00029950: 2d6c 270a 2020 2020 2020 2020 656c 6966  -l'.        elif
+00029960: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
+00029970: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00029980: 5479 7065 2e52 323a 0a20 2020 2020 2020  Type.R2:.       
+00029990: 2020 2020 2065 6e64 706f 696e 745f 7572       endpoint_ur
+000299a0: 6c20 3d20 636c 6f75 6466 6c61 7265 2e63  l = cloudflare.c
+000299b0: 7265 6174 655f 656e 6470 6f69 6e74 2829  reate_endpoint()
+000299c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000299d0: 7572 6e20 6627 4157 535f 5348 4152 4544  urn f'AWS_SHARED
+000299e0: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
+000299f0: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
+00029a00: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
+00029a10: 487d 2061 7773 2073 3320 6c73 2073 333a  H} aws s3 ls s3:
+00029a20: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d20  //{bucket_name} 
+00029a30: 2d2d 7265 6375 7273 6976 6520 2d2d 656e  --recursive --en
+00029a40: 6470 6f69 6e74 207b 656e 6470 6f69 6e74  dpoint {endpoint
+00029a50: 5f75 726c 7d20 2d2d 7072 6f66 696c 653d  _url} --profile=
+00029a60: 7232 207c 2077 6320 2d6c 270a 0a20 2020  r2 | wc -l'..   
+00029a70: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+00029a80: 0a20 2020 2064 6566 2074 6d70 5f73 6f75  .    def tmp_sou
+00029a90: 7263 6528 7365 6c66 2c20 746d 705f 7061  rce(self, tmp_pa
+00029aa0: 7468 293a 0a20 2020 2020 2020 2023 2043  th):.        # C
+00029ab0: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
+00029ac0: 7279 2064 6972 6563 746f 7279 2077 6974  ry directory wit
+00029ad0: 6820 6120 6669 6c65 2069 6e20 6974 0a20  h a file in it. 
+00029ae0: 2020 2020 2020 2074 6d70 5f64 6972 203d         tmp_dir =
+00029af0: 2074 6d70 5f70 6174 6820 2f20 2774 6d70   tmp_path / 'tmp
+00029b00: 2d73 6f75 7263 6527 0a20 2020 2020 2020  -source'.       
+00029b10: 2074 6d70 5f64 6972 2e6d 6b64 6972 2829   tmp_dir.mkdir()
+00029b20: 0a20 2020 2020 2020 2074 6d70 5f66 696c  .        tmp_fil
+00029b30: 6520 3d20 746d 705f 6469 7220 2f20 2774  e = tmp_dir / 't
+00029b40: 6d70 2d66 696c 6527 0a20 2020 2020 2020  mp-file'.       
+00029b50: 2074 6d70 5f66 696c 652e 7772 6974 655f   tmp_file.write_
+00029b60: 7465 7874 2827 7465 7374 2729 0a20 2020  text('test').   
+00029b70: 2020 2020 2063 6972 636c 655f 6c69 6e6b       circle_link
+00029b80: 203d 2074 6d70 5f64 6972 202f 2027 6369   = tmp_dir / 'ci
+00029b90: 7263 6c65 2d6c 696e 6b27 0a20 2020 2020  rcle-link'.     
+00029ba0: 2020 2063 6972 636c 655f 6c69 6e6b 2e73     circle_link.s
+00029bb0: 796d 6c69 6e6b 5f74 6f28 746d 705f 6469  ymlink_to(tmp_di
+00029bc0: 722c 2074 6172 6765 745f 6973 5f64 6972  r, target_is_dir
+00029bd0: 6563 746f 7279 3d54 7275 6529 0a20 2020  ectory=True).   
+00029be0: 2020 2020 2079 6965 6c64 2073 7472 2874       yield str(t
+00029bf0: 6d70 5f64 6972 290a 0a20 2020 2040 7374  mp_dir)..    @st
+00029c00: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+00029c10: 6566 2067 656e 6572 6174 655f 6275 636b  ef generate_buck
+00029c20: 6574 5f6e 616d 6528 293a 0a20 2020 2020  et_name():.     
+00029c30: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
+00029c40: 656d 706f 7261 7279 2062 7563 6b65 7420  emporary bucket 
+00029c50: 6e61 6d65 0a20 2020 2020 2020 2023 2074  name.        # t
+00029c60: 696d 652e 7469 6d65 2829 2072 6574 7572  ime.time() retur
+00029c70: 6e73 2076 6172 7969 6e67 2070 7265 6369  ns varying preci
+00029c80: 7369 6f6e 206f 6e20 6469 6666 6572 656e  sion on differen
+00029c90: 7420 7379 7374 656d 732c 2073 6f20 7765  t systems, so we
+00029ca0: 0a20 2020 2020 2020 2023 2072 6570 6c61  .        # repla
+00029cb0: 6365 2074 6865 2064 6563 696d 616c 2070  ce the decimal p
+00029cc0: 6f69 6e74 2061 6e64 2075 7365 2077 6861  oint and use wha
+00029cd0: 7465 7665 7220 7072 6563 6973 696f 6e20  tever precision 
+00029ce0: 7765 2063 616e 2067 6574 2e0a 2020 2020  we can get..    
+00029cf0: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
+00029d00: 7374 7228 7469 6d65 2e74 696d 6528 2929  str(time.time())
+00029d10: 2e72 6570 6c61 6365 2827 2e27 2c20 2727  .replace('.', ''
+00029d20: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00029d30: 2066 2773 6b79 2d74 6573 742d 7b74 696d   f'sky-test-{tim
+00029d40: 6573 7461 6d70 7d27 0a0a 2020 2020 4070  estamp}'..    @p
+00029d50: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
+00029d60: 2020 6465 6620 746d 705f 6275 636b 6574    def tmp_bucket
+00029d70: 5f6e 616d 6528 7365 6c66 293a 0a20 2020  _name(self):.   
+00029d80: 2020 2020 2079 6965 6c64 2073 656c 662e       yield self.
+00029d90: 6765 6e65 7261 7465 5f62 7563 6b65 745f  generate_bucket_
+00029da0: 6e61 6d65 2829 0a0a 2020 2020 4073 7461  name()..    @sta
+00029db0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+00029dc0: 6620 7969 656c 645f 7374 6f72 6167 655f  f yield_storage_
+00029dd0: 6f62 6a65 6374 280a 2020 2020 2020 2020  object(.        
+00029de0: 2020 2020 6e61 6d65 3a20 4f70 7469 6f6e      name: Option
+00029df0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+00029e00: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00029e10: 6365 3a20 4f70 7469 6f6e 616c 5b73 746f  ce: Optional[sto
+00029e20: 7261 6765 5f6c 6962 2e50 6174 685d 203d  rage_lib.Path] =
+00029e30: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00029e40: 2020 2073 746f 7265 733a 204f 7074 696f     stores: Optio
+00029e50: 6e61 6c5b 4469 6374 5b73 746f 7261 6765  nal[Dict[storage
+00029e60: 5f6c 6962 2e53 746f 7265 5479 7065 2c0a  _lib.StoreType,.
+00029e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029e90: 2020 7374 6f72 6167 655f 6c69 622e 4162    storage_lib.Ab
+00029ea0: 7374 7261 6374 5374 6f72 655d 5d20 3d20  stractStore]] = 
+00029eb0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00029ec0: 2020 7065 7273 6973 7465 6e74 3a20 4f70    persistent: Op
+00029ed0: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2054  tional[bool] = T
+00029ee0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+00029ef0: 206d 6f64 653a 2073 746f 7261 6765 5f6c   mode: storage_l
+00029f00: 6962 2e53 746f 7261 6765 4d6f 6465 203d  ib.StorageMode =
+00029f10: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00029f20: 7261 6765 4d6f 6465 2e4d 4f55 4e54 293a  rageMode.MOUNT):
+00029f30: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+00029f40: 6573 2061 2074 656d 706f 7261 7279 2073  es a temporary s
+00029f50: 746f 7261 6765 206f 626a 6563 742e 2053  torage object. S
+00029f60: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
+00029f70: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
+00029f80: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+00029f90: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
+00029fa0: 6962 2e53 746f 7261 6765 286e 616d 653d  ib.Storage(name=
+00029fb0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
 00029fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029fe0: 2020 2020 736f 7572 6365 3d6c 6973 745f      source=list_
-00029ff0: 736f 7572 6365 290a 0a20 2020 2040 7079  source)..    @py
-0002a000: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0002a010: 2064 6566 2074 6d70 5f62 756c 6b5f 6465   def tmp_bulk_de
-0002a020: 6c5f 7374 6f72 6167 655f 6f62 6a28 7365  l_storage_obj(se
-0002a030: 6c66 2c20 746d 705f 6275 636b 6574 5f6e  lf, tmp_bucket_n
-0002a040: 616d 6529 3a0a 2020 2020 2020 2020 2320  ame):.        # 
-0002a050: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
-0002a060: 6172 7920 7374 6f72 6167 6520 6f62 6a65  ary storage obje
-0002a070: 6374 2066 6f72 2074 6573 7469 6e67 2062  ct for testing b
-0002a080: 756c 6b20 6465 6c65 7469 6f6e 2e0a 2020  ulk deletion..  
-0002a090: 2020 2020 2020 2320 5374 6f72 6573 206d        # Stores m
-0002a0a0: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
-0002a0b0: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
-0002a0c0: 2020 7769 7468 2074 656d 7066 696c 652e    with tempfile.
-0002a0d0: 5465 6d70 6f72 6172 7944 6972 6563 746f  TemporaryDirecto
-0002a0e0: 7279 2829 2061 7320 746d 7064 6972 3a0a  ry() as tmpdir:.
-0002a0f0: 2020 2020 2020 2020 2020 2020 7375 6270              subp
-0002a100: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0002a110: 7075 7428 6627 6d6b 6469 7220 2d70 207b  put(f'mkdir -p {
-0002a120: 746d 7064 6972 7d2f 666f 6c64 6572 7b7b  tmpdir}/folder{{
-0002a130: 3030 302e 2e32 3535 7d7d 272c 0a20 2020  000..255}}',.   
-0002a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a160: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-0002a170: 2020 2020 2020 2020 2073 7562 7072 6f63           subproc
-0002a180: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002a190: 2866 2774 6f75 6368 207b 746d 7064 6972  (f'touch {tmpdir
-0002a1a0: 7d2f 7465 7374 7b7b 3030 302e 2e32 3535  }/test{{000..255
-0002a1b0: 7d7d 2e74 7874 272c 0a20 2020 2020 2020  }}.txt',.       
-0002a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a1d0: 2020 2020 2020 2020 2020 2020 2073 6865               she
-0002a1e0: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-0002a1f0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0002a200: 6368 6563 6b5f 6f75 7470 7574 280a 2020  check_output(.  
-0002a210: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0002a220: 746f 7563 6820 7b74 6d70 6469 727d 2f66  touch {tmpdir}/f
-0002a230: 6f6c 6465 727b 7b30 3030 2e2e 3235 357d  older{{000..255}
-0002a240: 7d2f 7465 7374 2e74 7874 272c 2073 6865  }/test.txt', she
-0002a250: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-0002a260: 2020 2020 2079 6965 6c64 2066 726f 6d20       yield from 
-0002a270: 7365 6c66 2e79 6965 6c64 5f73 746f 7261  self.yield_stora
-0002a280: 6765 5f6f 626a 6563 7428 6e61 6d65 3d74  ge_object(name=t
-0002a290: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c0a  mp_bucket_name,.
-0002a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a2d0: 2073 6f75 7263 653d 746d 7064 6972 290a   source=tmpdir).
-0002a2e0: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-0002a2f0: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-0002a300: 5f63 6f70 795f 6d6e 745f 6578 6973 7469  _copy_mnt_existi
-0002a310: 6e67 5f73 746f 7261 6765 5f6f 626a 2873  ng_storage_obj(s
-0002a320: 656c 662c 2074 6d70 5f73 6372 6174 6368  elf, tmp_scratch
-0002a330: 5f73 746f 7261 6765 5f6f 626a 293a 0a20  _storage_obj):. 
-0002a340: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002a350: 2061 2063 6f70 7920 6d6f 756e 7420 7374   a copy mount st
-0002a360: 6f72 6167 6520 7768 6963 6820 7265 7573  orage which reus
-0002a370: 6573 2061 6e20 6578 6973 7469 6e67 2073  es an existing s
-0002a380: 746f 7261 6765 206f 626a 6563 742e 0a20  torage object.. 
-0002a390: 2020 2020 2020 2074 6d70 5f73 6372 6174         tmp_scrat
-0002a3a0: 6368 5f73 746f 7261 6765 5f6f 626a 2e61  ch_storage_obj.a
-0002a3b0: 6464 5f73 746f 7265 2873 746f 7261 6765  dd_store(storage
-0002a3c0: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002a3d0: 3329 0a20 2020 2020 2020 2073 746f 7261  3).        stora
-0002a3e0: 6765 5f6e 616d 6520 3d20 746d 705f 7363  ge_name = tmp_sc
-0002a3f0: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
-0002a400: 6a2e 6e61 6d65 0a0a 2020 2020 2020 2020  j.name..        
-0002a410: 2320 5472 7920 746f 2069 6e69 7469 616c  # Try to initial
-0002a420: 697a 6520 616e 6f74 6865 7220 7374 6f72  ize another stor
-0002a430: 6167 6520 7769 7468 2074 6865 2073 746f  age with the sto
-0002a440: 7261 6765 206f 626a 6563 7420 6372 6561  rage object crea
-0002a450: 7465 640a 2020 2020 2020 2020 2320 6162  ted.        # ab
-0002a460: 6f76 652c 2062 7574 206e 6f77 2069 6e20  ove, but now in 
-0002a470: 434f 5059 206d 6f64 652e 2054 6869 7320  COPY mode. This 
-0002a480: 7368 6f75 6c64 2073 7563 6365 6564 2e0a  should succeed..
-0002a490: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-0002a4a0: 6f6d 2073 656c 662e 7969 656c 645f 7374  om self.yield_st
-0002a4b0: 6f72 6167 655f 6f62 6a65 6374 286e 616d  orage_object(nam
-0002a4c0: 653d 7374 6f72 6167 655f 6e61 6d65 2c0a  e=storage_name,.
-0002a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4f0: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0002a500: 653d 7374 6f72 6167 655f 6c69 622e 5374  e=storage_lib.St
-0002a510: 6f72 6167 654d 6f64 652e 434f 5059 290a  orageMode.COPY).
-0002a520: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-0002a530: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-0002a540: 5f67 6974 6967 6e6f 7265 5f73 746f 7261  _gitignore_stora
-0002a550: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
-0002a560: 5f62 7563 6b65 745f 6e61 6d65 2c20 6769  _bucket_name, gi
-0002a570: 7469 676e 6f72 655f 7374 7275 6374 7572  tignore_structur
-0002a580: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
-0002a590: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
-0002a5a0: 7920 7374 6f72 6167 6520 6f62 6a65 6374  y storage object
-0002a5b0: 2066 6f72 2074 6573 7469 6e67 202e 6769   for testing .gi
-0002a5c0: 7469 676e 6f72 6520 6669 6c74 6572 2e0a  tignore filter..
-0002a5d0: 2020 2020 2020 2020 2320 4749 5449 4749          # GITIGI
-0002a5e0: 4e4f 5245 5f53 5452 5543 5455 5245 2069  NORE_STRUCTURE i
-0002a5f0: 7320 7265 7072 6573 656e 7469 6e67 2061  s representing a
-0002a600: 2066 696c 6520 7374 7275 6374 7572 6520   file structure 
-0002a610: 696e 2061 2064 6963 7469 6f6e 6172 790a  in a dictionary.
-0002a620: 2020 2020 2020 2020 2320 666f 726d 6174          # format
-0002a630: 2e20 4372 6561 7465 6420 7374 6f72 6167  . Created storag
-0002a640: 6520 6f62 6a65 6374 2077 696c 6c20 636f  e object will co
-0002a650: 6e74 6169 6e20 7468 6520 6669 6c65 2073  ntain the file s
-0002a660: 7472 7563 7475 7265 2061 6c6f 6e67 0a20  tructure along. 
-0002a670: 2020 2020 2020 2023 2077 6974 6820 2e67         # with .g
-0002a680: 6974 6967 6e6f 7265 2061 6e64 202e 6769  itignore and .gi
-0002a690: 742f 696e 666f 2f65 7863 6c75 6465 2066  t/info/exclude f
-0002a6a0: 696c 6573 2074 6f20 7465 7374 2065 7863  iles to test exc
-0002a6b0: 6c75 6465 2066 696c 7465 722e 0a20 2020  lude filter..   
-0002a6c0: 2020 2020 2023 2053 746f 7265 7320 6d75       # Stores mu
-0002a6d0: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
-0002a6e0: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
-0002a6f0: 2077 6974 6820 7465 6d70 6669 6c65 2e54   with tempfile.T
-0002a700: 656d 706f 7261 7279 4469 7265 6374 6f72  emporaryDirector
-0002a710: 7928 2920 6173 2074 6d70 6469 723a 0a20  y() as tmpdir:. 
-0002a720: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
-0002a730: 6174 6573 2066 696c 6520 7374 7275 6374  ates file struct
-0002a740: 7572 6520 746f 2062 6520 7570 6c6f 6164  ure to be upload
-0002a750: 6564 2069 6e20 7468 6520 5374 6f72 6167  ed in the Storag
-0002a760: 650a 2020 2020 2020 2020 2020 2020 7365  e.            se
-0002a770: 6c66 2e63 7265 6174 655f 6469 725f 7374  lf.create_dir_st
-0002a780: 7275 6374 7572 6528 746d 7064 6972 2c20  ructure(tmpdir, 
-0002a790: 6769 7469 676e 6f72 655f 7374 7275 6374  gitignore_struct
-0002a7a0: 7572 6529 0a0a 2020 2020 2020 2020 2020  ure)..          
-0002a7b0: 2020 2320 4372 6561 7465 202e 6769 7469    # Create .giti
-0002a7c0: 676e 6f72 6520 616e 6420 6c69 7374 2066  gnore and list f
-0002a7d0: 696c 6573 2f64 6972 7320 746f 2062 6520  iles/dirs to be 
-0002a7e0: 6578 636c 7564 6564 2069 6e20 6974 0a20  excluded in it. 
-0002a7f0: 2020 2020 2020 2020 2020 2073 6b79 7069             skypi
-0002a800: 6c6f 745f 7061 7468 203d 206f 732e 7061  lot_path = os.pa
-0002a810: 7468 2e64 6972 6e61 6d65 286f 732e 7061  th.dirname(os.pa
-0002a820: 7468 2e64 6972 6e61 6d65 2873 6b79 2e5f  th.dirname(sky._
-0002a830: 5f66 696c 655f 5f29 290a 2020 2020 2020  _file__)).      
-0002a840: 2020 2020 2020 7465 6d70 5f70 6174 6820        temp_path 
-0002a850: 3d20 6627 7b74 6d70 6469 727d 2f2e 6769  = f'{tmpdir}/.gi
-0002a860: 7469 676e 6f72 6527 0a20 2020 2020 2020  tignore'.       
-0002a870: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
-0002a880: 206f 732e 7061 7468 2e6a 6f69 6e28 736b   os.path.join(sk
-0002a890: 7970 696c 6f74 5f70 6174 682c 2027 7465  ypilot_path, 'te
-0002a8a0: 7374 732f 6769 7469 676e 6f72 655f 7465  sts/gitignore_te
-0002a8b0: 7374 2729 0a20 2020 2020 2020 2020 2020  st').           
-0002a8c0: 2073 6875 7469 6c2e 636f 7079 6669 6c65   shutil.copyfile
-0002a8d0: 2866 696c 655f 7061 7468 2c20 7465 6d70  (file_path, temp
-0002a8e0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-0002a8f0: 2020 2020 2320 4372 6561 7465 202e 6769      # Create .gi
-0002a900: 742f 696e 666f 2f65 7863 6c75 6465 2061  t/info/exclude a
-0002a910: 6e64 206c 6973 7420 6669 6c65 732f 6469  nd list files/di
-0002a920: 7273 2074 6f20 6265 2065 7863 6c75 6465  rs to be exclude
-0002a930: 6420 696e 2069 740a 2020 2020 2020 2020  d in it.        
-0002a940: 2020 2020 7465 6d70 5f70 6174 6820 3d20      temp_path = 
-0002a950: 6627 7b74 6d70 6469 727d 2f2e 6769 742f  f'{tmpdir}/.git/
-0002a960: 696e 666f 2f27 0a20 2020 2020 2020 2020  info/'.         
-0002a970: 2020 206f 732e 6d61 6b65 6469 7273 2874     os.makedirs(t
-0002a980: 656d 705f 7061 7468 290a 2020 2020 2020  emp_path).      
-0002a990: 2020 2020 2020 7465 6d70 5f65 7863 6c75        temp_exclu
-0002a9a0: 6465 5f70 6174 6820 3d20 6f73 2e70 6174  de_path = os.pat
-0002a9b0: 682e 6a6f 696e 2874 656d 705f 7061 7468  h.join(temp_path
-0002a9c0: 2c20 2765 7863 6c75 6465 2729 0a20 2020  , 'exclude').   
-0002a9d0: 2020 2020 2020 2020 2066 696c 655f 7061           file_pa
-0002a9e0: 7468 203d 206f 732e 7061 7468 2e6a 6f69  th = os.path.joi
-0002a9f0: 6e28 736b 7970 696c 6f74 5f70 6174 682c  n(skypilot_path,
-0002aa00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aa20: 2020 2020 2020 2774 6573 7473 2f67 6974        'tests/git
-0002aa30: 5f69 6e66 6f5f 6578 636c 7564 655f 7465  _info_exclude_te
-0002aa40: 7374 2729 0a20 2020 2020 2020 2020 2020  st').           
-0002aa50: 2073 6875 7469 6c2e 636f 7079 6669 6c65   shutil.copyfile
-0002aa60: 2866 696c 655f 7061 7468 2c20 7465 6d70  (file_path, temp
-0002aa70: 5f65 7863 6c75 6465 5f70 6174 6829 0a0a  _exclude_path)..
-0002aa80: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
-0002aa90: 6561 7465 2073 6b79 2053 746f 7261 6765  eate sky Storage
-0002aaa0: 2077 6974 6820 7468 6520 6669 6c65 7320   with the files 
-0002aab0: 6372 6561 7465 640a 2020 2020 2020 2020  created.        
-0002aac0: 2020 2020 7969 656c 6420 6672 6f6d 2073      yield from s
-0002aad0: 656c 662e 7969 656c 645f 7374 6f72 6167  elf.yield_storag
-0002aae0: 655f 6f62 6a65 6374 280a 2020 2020 2020  e_object(.      
-0002aaf0: 2020 2020 2020 2020 2020 6e61 6d65 3d74            name=t
-0002ab00: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c0a  mp_bucket_name,.
-0002ab10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ab20: 736f 7572 6365 3d74 6d70 6469 722c 0a20  source=tmpdir,. 
-0002ab30: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0002ab40: 6f64 653d 7374 6f72 6167 655f 6c69 622e  ode=storage_lib.
-0002ab50: 5374 6f72 6167 654d 6f64 652e 434f 5059  StorageMode.COPY
-0002ab60: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-0002ab70: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-0002ab80: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
-0002ab90: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
-0002aba0: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
-0002abb0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-0002abc0: 706f 7261 7279 2062 7563 6b65 7420 7573  porary bucket us
-0002abd0: 696e 6720 6177 7363 6c69 0a20 2020 2020  ing awscli.     
-0002abe0: 2020 2062 7563 6b65 745f 7572 6920 3d20     bucket_uri = 
-0002abf0: 6627 7333 3a2f 2f7b 746d 705f 6275 636b  f's3://{tmp_buck
-0002ac00: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
-0002ac10: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-0002ac20: 636b 5f63 616c 6c28 5b27 6177 7327 2c20  ck_call(['aws', 
-0002ac30: 2773 3327 2c20 276d 6227 2c20 6275 636b  's3', 'mb', buck
-0002ac40: 6574 5f75 7269 5d29 0a20 2020 2020 2020  et_uri]).       
-0002ac50: 2079 6965 6c64 2074 6d70 5f62 7563 6b65   yield tmp_bucke
-0002ac60: 745f 6e61 6d65 2c20 6275 636b 6574 5f75  t_name, bucket_u
-0002ac70: 7269 0a20 2020 2020 2020 2073 7562 7072  ri.        subpr
-0002ac80: 6f63 6573 732e 6368 6563 6b5f 6361 6c6c  ocess.check_call
-0002ac90: 285b 2761 7773 272c 2027 7333 272c 2027  (['aws', 's3', '
-0002aca0: 7262 272c 2062 7563 6b65 745f 7572 692c  rb', bucket_uri,
-0002acb0: 2027 2d2d 666f 7263 6527 5d29 0a0a 2020   '--force'])..  
-0002acc0: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-0002acd0: 650a 2020 2020 6465 6620 746d 705f 6773  e.    def tmp_gs
-0002ace0: 7574 696c 5f62 7563 6b65 7428 7365 6c66  util_bucket(self
-0002acf0: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
-0002ad00: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
-0002ad10: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
-0002ad20: 7920 6275 636b 6574 2075 7369 6e67 2067  y bucket using g
-0002ad30: 7375 7469 6c0a 2020 2020 2020 2020 6275  sutil.        bu
-0002ad40: 636b 6574 5f75 7269 203d 2066 2767 733a  cket_uri = f'gs:
-0002ad50: 2f2f 7b74 6d70 5f62 7563 6b65 745f 6e61  //{tmp_bucket_na
-0002ad60: 6d65 7d27 0a20 2020 2020 2020 2073 7562  me}'.        sub
-0002ad70: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
-0002ad80: 6c6c 285b 2767 7375 7469 6c27 2c20 276d  ll(['gsutil', 'm
-0002ad90: 6227 2c20 6275 636b 6574 5f75 7269 5d29  b', bucket_uri])
-0002ada0: 0a20 2020 2020 2020 2079 6965 6c64 2074  .        yield t
-0002adb0: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c20  mp_bucket_name, 
-0002adc0: 6275 636b 6574 5f75 7269 0a20 2020 2020  bucket_uri.     
-0002add0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
-0002ade0: 6563 6b5f 6361 6c6c 285b 2767 7375 7469  eck_call(['gsuti
-0002adf0: 6c27 2c20 2772 6d27 2c20 272d 7227 2c20  l', 'rm', '-r', 
-0002ae00: 6275 636b 6574 5f75 7269 5d29 0a0a 2020  bucket_uri])..  
-0002ae10: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-0002ae20: 650a 2020 2020 6465 6620 746d 705f 6177  e.    def tmp_aw
-0002ae30: 7363 6c69 5f62 7563 6b65 745f 7232 2873  scli_bucket_r2(s
-0002ae40: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
-0002ae50: 6e61 6d65 293a 0a20 2020 2020 2020 2023  name):.        #
-0002ae60: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
-0002ae70: 7261 7279 2062 7563 6b65 7420 7573 696e  rary bucket usin
-0002ae80: 6720 6177 7363 6c69 0a20 2020 2020 2020  g awscli.       
-0002ae90: 2065 6e64 706f 696e 745f 7572 6c20 3d20   endpoint_url = 
-0002aea0: 636c 6f75 6466 6c61 7265 2e63 7265 6174  cloudflare.creat
-0002aeb0: 655f 656e 6470 6f69 6e74 2829 0a20 2020  e_endpoint().   
-0002aec0: 2020 2020 2062 7563 6b65 745f 7572 6920       bucket_uri 
-0002aed0: 3d20 6627 7333 3a2f 2f7b 746d 705f 6275  = f's3://{tmp_bu
-0002aee0: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
-0002aef0: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
-0002af00: 6865 636b 5f63 616c 6c28 0a20 2020 2020  heck_call(.     
-0002af10: 2020 2020 2020 2066 2741 5753 5f53 4841         f'AWS_SHA
-0002af20: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
-0002af30: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
-0002af40: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
-0002af50: 5041 5448 7d20 6177 7320 7333 206d 6220  PATH} aws s3 mb 
-0002af60: 7b62 7563 6b65 745f 7572 697d 202d 2d65  {bucket_uri} --e
-0002af70: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
-0002af80: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
-0002af90: 3d72 3227 2c0a 2020 2020 2020 2020 2020  =r2',.          
-0002afa0: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
-0002afb0: 2020 2020 2020 7969 656c 6420 746d 705f        yield tmp_
-0002afc0: 6275 636b 6574 5f6e 616d 652c 2062 7563  bucket_name, buc
-0002afd0: 6b65 745f 7572 690a 2020 2020 2020 2020  ket_uri.        
-0002afe0: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0002aff0: 5f63 616c 6c28 0a20 2020 2020 2020 2020  _call(.         
-0002b000: 2020 2066 2741 5753 5f53 4841 5245 445f     f'AWS_SHARED_
-0002b010: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
-0002b020: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
-0002b030: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
-0002b040: 7d20 6177 7320 7333 2072 6220 7b62 7563  } aws s3 rb {buc
-0002b050: 6b65 745f 7572 697d 202d 2d66 6f72 6365  ket_uri} --force
-0002b060: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
-0002b070: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
-0002b080: 6669 6c65 3d72 3227 2c0a 2020 2020 2020  file=r2',.      
-0002b090: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-0002b0a0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-0002b0b0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-0002b0c0: 6d70 5f69 626d 5f63 6f73 5f62 7563 6b65  mp_ibm_cos_bucke
-0002b0d0: 7428 7365 6c66 2c20 746d 705f 6275 636b  t(self, tmp_buck
-0002b0e0: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
-0002b0f0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
-0002b100: 6d70 6f72 6172 7920 6275 636b 6574 2075  mporary bucket u
-0002b110: 7369 6e67 2049 424d 2043 4f53 2041 5049  sing IBM COS API
-0002b120: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0002b130: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
-0002b140: 6962 2e49 424d 436f 7353 746f 7265 2873  ib.IBMCosStore(s
-0002b150: 6f75 7263 653d 2222 2c20 6e61 6d65 3d74  ource="", name=t
-0002b160: 6d70 5f62 7563 6b65 745f 6e61 6d65 290a  mp_bucket_name).
-0002b170: 2020 2020 2020 2020 7969 656c 6420 746d          yield tm
-0002b180: 705f 6275 636b 6574 5f6e 616d 650a 2020  p_bucket_name.  
-0002b190: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-0002b1a0: 6a2e 6465 6c65 7465 2829 0a0a 2020 2020  j.delete()..    
-0002b1b0: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
-0002b1c0: 2020 2020 6465 6620 746d 705f 7075 626c      def tmp_publ
-0002b1d0: 6963 5f73 746f 7261 6765 5f6f 626a 2873  ic_storage_obj(s
-0002b1e0: 656c 662c 2072 6571 7565 7374 293a 0a20  elf, request):. 
-0002b1f0: 2020 2020 2020 2023 2049 6e69 7469 616c         # Initial
-0002b200: 697a 6573 2061 2073 746f 7261 6765 206f  izes a storage o
-0002b210: 626a 6563 7420 7769 7468 2061 2070 7562  bject with a pub
-0002b220: 6c69 6320 6275 636b 6574 0a20 2020 2020  lic bucket.     
-0002b230: 2020 2073 746f 7261 6765 5f6f 626a 203d     storage_obj =
-0002b240: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0002b250: 7261 6765 2873 6f75 7263 653d 7265 7175  rage(source=requ
-0002b260: 6573 742e 7061 7261 6d29 0a20 2020 2020  est.param).     
-0002b270: 2020 2079 6965 6c64 2073 746f 7261 6765     yield storage
-0002b280: 5f6f 626a 0a20 2020 2020 2020 2023 2054  _obj.        # T
-0002b290: 6869 7320 646f 6573 206e 6f74 2072 6571  his does not req
-0002b2a0: 7569 7265 2061 6e79 2064 656c 6574 696f  uire any deletio
-0002b2b0: 6e20 6c6f 6769 6320 6265 6361 7573 6520  n logic because 
-0002b2c0: 6974 2069 7320 6120 7075 626c 6963 2062  it is a public b
-0002b2d0: 7563 6b65 740a 2020 2020 2020 2020 2320  ucket.        # 
-0002b2e0: 616e 6420 7368 6f75 6c64 206e 6f74 2067  and should not g
-0002b2f0: 6574 2061 6464 6564 2074 6f20 676c 6f62  et added to glob
-0002b300: 616c 5f75 7365 725f 7374 6174 652e 0a0a  al_user_state...
-0002b310: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-0002b320: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
-0002b330: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0002b340: 7061 7261 6d65 7472 697a 6528 2773 746f  parametrize('sto
-0002b350: 7265 5f74 7970 6527 2c20 5b0a 2020 2020  re_type', [.    
-0002b360: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-0002b370: 5374 6f72 6554 7970 652e 5333 2c20 7374  StoreType.S3, st
-0002b380: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002b390: 7970 652e 4743 532c 0a20 2020 2020 2020  ype.GCS,.       
-0002b3a0: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-0002b3b0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002b3c0: 7970 652e 4942 4d2c 206d 6172 6b73 3d70  ype.IBM, marks=p
-0002b3d0: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
-0002b3e0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002b3f0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002b400: 622e 5374 6f72 6554 7970 652e 5232 2c20  b.StoreType.R2, 
-0002b410: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-0002b420: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
-0002b430: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
-0002b440: 745f 6e65 775f 6275 636b 6574 5f63 7265  t_new_bucket_cre
-0002b450: 6174 696f 6e5f 616e 645f 6465 6c65 7469  ation_and_deleti
-0002b460: 6f6e 2873 656c 662c 2074 6d70 5f6c 6f63  on(self, tmp_loc
-0002b470: 616c 5f73 746f 7261 6765 5f6f 626a 2c0a  al_storage_obj,.
-0002b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4a0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0002b4b0: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
-0002b4c0: 2020 2023 2043 7265 6174 6573 2061 206e     # Creates a n
-0002b4d0: 6577 2062 7563 6b65 7420 7769 7468 2061  ew bucket with a
-0002b4e0: 206c 6f63 616c 2073 6f75 7263 652c 2075   local source, u
-0002b4f0: 706c 6f61 6473 2066 696c 6573 2074 6f20  ploads files to 
-0002b500: 6974 0a20 2020 2020 2020 2023 2061 6e64  it.        # and
-0002b510: 2064 656c 6574 6573 2069 742e 0a20 2020   deletes it..   
-0002b520: 2020 2020 2074 6d70 5f6c 6f63 616c 5f73       tmp_local_s
-0002b530: 746f 7261 6765 5f6f 626a 2e61 6464 5f73  torage_obj.add_s
-0002b540: 746f 7265 2873 746f 7265 5f74 7970 6529  tore(store_type)
-0002b550: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
-0002b560: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
-0002b570: 6f20 6368 6563 6b20 6966 2073 746f 7261  o check if stora
-0002b580: 6765 206f 626a 6563 7420 6578 6973 7473  ge object exists
-0002b590: 2069 6e20 7468 6520 6f75 7470 7574 0a20   in the output. 
-0002b5a0: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
-0002b5b0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-0002b5c0: 7470 7574 285b 2773 6b79 272c 2027 7374  tput(['sky', 'st
-0002b5d0: 6f72 6167 6527 2c20 276c 7327 5d29 0a20  orage', 'ls']). 
-0002b5e0: 2020 2020 2020 2061 7373 6572 7420 746d         assert tm
-0002b5f0: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-0002b600: 6f62 6a2e 6e61 6d65 2069 6e20 6f75 742e  obj.name in out.
-0002b610: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-0002b620: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
-0002b630: 6b79 2073 746f 7261 6765 2064 656c 6574  ky storage delet
-0002b640: 6520 746f 2064 656c 6574 6520 7468 6520  e to delete the 
-0002b650: 7374 6f72 6167 6520 6f62 6a65 6374 0a20  storage object. 
-0002b660: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-0002b670: 732e 6368 6563 6b5f 6f75 7470 7574 280a  s.check_output(.
-0002b680: 2020 2020 2020 2020 2020 2020 5b27 736b              ['sk
-0002b690: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
-0002b6a0: 6465 6c65 7465 272c 2074 6d70 5f6c 6f63  delete', tmp_loc
-0002b6b0: 616c 5f73 746f 7261 6765 5f6f 626a 2e6e  al_storage_obj.n
-0002b6c0: 616d 652c 2027 2d2d 7965 7327 5d29 0a0a  ame, '--yes'])..
-0002b6d0: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
-0002b6e0: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
-0002b6f0: 6368 6563 6b20 6966 2073 746f 7261 6765  check if storage
-0002b700: 206f 626a 6563 7420 6973 2064 656c 6574   object is delet
-0002b710: 6564 0a20 2020 2020 2020 206f 7574 203d  ed.        out =
-0002b720: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002b730: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-0002b740: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-0002b750: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
-0002b760: 7420 746d 705f 6c6f 6361 6c5f 7374 6f72  t tmp_local_stor
-0002b770: 6167 655f 6f62 6a2e 6e61 6d65 206e 6f74  age_obj.name not
-0002b780: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-0002b790: 7574 662d 3827 290a 0a20 2020 2040 7079  utf-8')..    @py
-0002b7a0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-0002b7b0: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
-0002b7c0: 6573 742e 6d61 726b 2e78 6469 7374 5f67  est.mark.xdist_g
-0002b7d0: 726f 7570 2827 6d75 6c74 6970 6c65 5f62  roup('multiple_b
-0002b7e0: 7563 6b65 745f 6465 6c65 7469 6f6e 2729  ucket_deletion')
-0002b7f0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002b800: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
-0002b810: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
-0002b820: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0002b830: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
-0002b840: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002b850: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
-0002b860: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002b870: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002b880: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
-0002b890: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
-0002b8a0: 6466 6c61 7265 292c 0a20 2020 2020 2020  dflare),.       
-0002b8b0: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-0002b8c0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002b8d0: 7970 652e 4942 4d2c 206d 6172 6b73 3d70  ype.IBM, marks=p
-0002b8e0: 7974 6573 742e 6d61 726b 2e69 626d 290a  ytest.mark.ibm).
-0002b8f0: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0002b900: 6573 745f 6d75 6c74 6970 6c65 5f62 7563  est_multiple_buc
-0002b910: 6b65 7473 5f63 7265 6174 696f 6e5f 616e  kets_creation_an
-0002b920: 645f 6465 6c65 7469 6f6e 280a 2020 2020  d_deletion(.    
-0002b930: 2020 2020 2020 2020 7365 6c66 2c20 746d          self, tm
-0002b940: 705f 6d75 6c74 6970 6c65 5f73 6372 6174  p_multiple_scrat
-0002b950: 6368 5f73 746f 7261 6765 5f6f 626a 2c20  ch_storage_obj, 
-0002b960: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
-0002b970: 2020 2020 2023 2043 7265 6174 6573 206d       # Creates m
-0002b980: 756c 7469 706c 6520 6e65 7720 6275 636b  ultiple new buck
-0002b990: 6574 7328 3520 6275 636b 6574 7329 2077  ets(5 buckets) w
-0002b9a0: 6974 6820 6120 6c6f 6361 6c20 736f 7572  ith a local sour
-0002b9b0: 6365 0a20 2020 2020 2020 2023 2061 6e64  ce.        # and
-0002b9c0: 2064 656c 6574 6573 2074 6865 6d2e 0a20   deletes them.. 
-0002b9d0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
-0002b9e0: 626a 5f6e 616d 6520 3d20 5b5d 0a20 2020  bj_name = [].   
-0002b9f0: 2020 2020 2066 6f72 2073 746f 7265 5f6f       for store_o
-0002ba00: 626a 2069 6e20 746d 705f 6d75 6c74 6970  bj in tmp_multip
-0002ba10: 6c65 5f73 6372 6174 6368 5f73 746f 7261  le_scratch_stora
-0002ba20: 6765 5f6f 626a 3a0a 2020 2020 2020 2020  ge_obj:.        
-0002ba30: 2020 2020 7374 6f72 655f 6f62 6a2e 6164      store_obj.ad
-0002ba40: 645f 7374 6f72 6528 7374 6f72 655f 7479  d_store(store_ty
-0002ba50: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-0002ba60: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
-0002ba70: 2e61 7070 656e 6428 7374 6f72 655f 6f62  .append(store_ob
-0002ba80: 6a2e 6e61 6d65 290a 0a20 2020 2020 2020  j.name)..       
-0002ba90: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
-0002baa0: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
-0002bab0: 6620 616c 6c20 7374 6f72 6167 6520 6f62  f all storage ob
-0002bac0: 6a65 6374 7320 6578 6973 7473 2069 6e20  jects exists in 
-0002bad0: 7468 650a 2020 2020 2020 2020 2320 6f75  the.        # ou
-0002bae0: 7470 7574 2066 696c 7465 7265 6420 6279  tput filtered by
-0002baf0: 2073 746f 7265 2074 7970 650a 2020 2020   store type.    
-0002bb00: 2020 2020 6f75 745f 616c 6c20 3d20 7375      out_all = su
-0002bb10: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0002bb20: 7574 7075 7428 5b27 736b 7927 2c20 2773  utput(['sky', 's
-0002bb30: 746f 7261 6765 272c 2027 6c73 275d 290a  torage', 'ls']).
-0002bb40: 2020 2020 2020 2020 6f75 7420 3d20 5b0a          out = [.
-0002bb50: 2020 2020 2020 2020 2020 2020 6974 656d              item
-0002bb60: 2e73 706c 6974 2829 5b30 5d0a 2020 2020  .split()[0].    
-0002bb70: 2020 2020 2020 2020 666f 7220 6974 656d          for item
-0002bb80: 2069 6e20 6f75 745f 616c 6c2e 6465 636f   in out_all.deco
-0002bb90: 6465 2827 7574 662d 3827 292e 7370 6c69  de('utf-8').spli
-0002bba0: 746c 696e 6573 2829 0a20 2020 2020 2020  tlines().       
-0002bbb0: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-0002bbc0: 7065 2e76 616c 7565 2069 6e20 6974 656d  pe.value in item
-0002bbd0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-0002bbe0: 2020 2061 7373 6572 7420 616c 6c28 5b69     assert all([i
-0002bbf0: 7465 6d20 696e 206f 7574 2066 6f72 2069  tem in out for i
-0002bc00: 7465 6d20 696e 2073 746f 7261 6765 5f6f  tem in storage_o
-0002bc10: 626a 5f6e 616d 655d 290a 0a20 2020 2020  bj_name])..     
-0002bc20: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
-0002bc30: 7261 6765 2064 656c 6574 6520 616c 6c20  rage delete all 
-0002bc40: 746f 2064 656c 6574 6520 616c 6c20 7374  to delete all st
-0002bc50: 6f72 6167 6520 6f62 6a65 6374 730a 2020  orage objects.  
-0002bc60: 2020 2020 2020 6465 6c65 7465 5f63 6d64        delete_cmd
-0002bc70: 203d 205b 2773 6b79 272c 2027 7374 6f72   = ['sky', 'stor
-0002bc80: 6167 6527 2c20 2764 656c 6574 6527 2c20  age', 'delete', 
-0002bc90: 272d 2d79 6573 275d 0a20 2020 2020 2020  '--yes'].       
-0002bca0: 2064 656c 6574 655f 636d 6420 2b3d 2073   delete_cmd += s
-0002bcb0: 746f 7261 6765 5f6f 626a 5f6e 616d 650a  torage_obj_name.
-0002bcc0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0002bcd0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-0002bce0: 6465 6c65 7465 5f63 6d64 290a 0a20 2020  delete_cmd)..   
-0002bcf0: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
-0002bd00: 746f 7261 6765 206c 7320 746f 2063 6865  torage ls to che
-0002bd10: 636b 2069 6620 616c 6c20 7374 6f72 6167  ck if all storag
-0002bd20: 6520 6f62 6a65 6374 7320 6669 6c74 6572  e objects filter
-0002bd30: 6564 2062 7920 7374 6f72 650a 2020 2020  ed by store.    
-0002bd40: 2020 2020 2320 7479 7065 2061 7265 2064      # type are d
-0002bd50: 656c 6574 6564 0a20 2020 2020 2020 206f  eleted.        o
-0002bd60: 7574 5f61 6c6c 203d 2073 7562 7072 6f63  ut_all = subproc
-0002bd70: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002bd80: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
-0002bd90: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
-0002bda0: 2020 206f 7574 203d 205b 0a20 2020 2020     out = [.     
-0002bdb0: 2020 2020 2020 2069 7465 6d2e 7370 6c69         item.spli
-0002bdc0: 7428 295b 305d 0a20 2020 2020 2020 2020  t()[0].         
-0002bdd0: 2020 2066 6f72 2069 7465 6d20 696e 206f     for item in o
-0002bde0: 7574 5f61 6c6c 2e64 6563 6f64 6528 2775  ut_all.decode('u
-0002bdf0: 7466 2d38 2729 2e73 706c 6974 6c69 6e65  tf-8').splitline
-0002be00: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0002be10: 6966 2073 746f 7265 5f74 7970 652e 7661  if store_type.va
-0002be20: 6c75 6520 696e 2069 7465 6d0a 2020 2020  lue in item.    
-0002be30: 2020 2020 5d0a 2020 2020 2020 2020 6173      ].        as
-0002be40: 7365 7274 2061 6c6c 285b 6974 656d 206e  sert all([item n
-0002be50: 6f74 2069 6e20 6f75 7420 666f 7220 6974  ot in out for it
-0002be60: 656d 2069 6e20 7374 6f72 6167 655f 6f62  em in storage_ob
-0002be70: 6a5f 6e61 6d65 5d29 0a0a 2020 2020 4070  j_name])..    @p
-0002be80: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-0002be90: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-0002bea0: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-0002beb0: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
-0002bec0: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
-0002bed0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002bee0: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
-0002bef0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
-0002bf00: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
-0002bf10: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
-0002bf20: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
-0002bf30: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
-0002bf40: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
-0002bf50: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002bf60: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002bf70: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
-0002bf80: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
-0002bf90: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
-0002bfa0: 2020 2064 6566 2074 6573 745f 7570 6c6f     def test_uplo
-0002bfb0: 6164 5f73 6f75 7263 655f 7769 7468 5f73  ad_source_with_s
-0002bfc0: 7061 6365 7328 7365 6c66 2c20 7374 6f72  paces(self, stor
-0002bfd0: 655f 7479 7065 2c0a 2020 2020 2020 2020  e_type,.        
-0002bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bff0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002c000: 6d70 5f6d 756c 7469 706c 655f 6375 7374  mp_multiple_cust
-0002c010: 6f6d 5f73 6f75 7263 655f 7374 6f72 6167  om_source_storag
-0002c020: 655f 6f62 6a29 3a0a 2020 2020 2020 2020  e_obj):.        
-0002c030: 2320 4372 6561 7465 7320 7477 6f20 6275  # Creates two bu
-0002c040: 636b 6574 7320 7769 7468 2073 7065 6369  ckets with speci
-0002c050: 6669 6564 206c 6f63 616c 2073 6f75 7263  fied local sourc
-0002c060: 6573 0a20 2020 2020 2020 2023 2077 6974  es.        # wit
-0002c070: 6820 7370 6163 6573 2069 6e20 7468 6520  h spaces in the 
-0002c080: 6e61 6d65 0a20 2020 2020 2020 2073 746f  name.        sto
-0002c090: 7261 6765 5f6f 626a 5f6e 616d 6573 203d  rage_obj_names =
-0002c0a0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
-0002c0b0: 7374 6f72 6167 655f 6f62 6a20 696e 2074  storage_obj in t
-0002c0c0: 6d70 5f6d 756c 7469 706c 655f 6375 7374  mp_multiple_cust
-0002c0d0: 6f6d 5f73 6f75 7263 655f 7374 6f72 6167  om_source_storag
-0002c0e0: 655f 6f62 6a3a 0a20 2020 2020 2020 2020  e_obj:.         
-0002c0f0: 2020 2073 746f 7261 6765 5f6f 626a 2e61     storage_obj.a
-0002c100: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-0002c110: 7970 6529 0a20 2020 2020 2020 2020 2020  ype).           
-0002c120: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
-0002c130: 6573 2e61 7070 656e 6428 7374 6f72 6167  es.append(storag
-0002c140: 655f 6f62 6a2e 6e61 6d65 290a 0a20 2020  e_obj.name)..   
-0002c150: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
-0002c160: 746f 7261 6765 206c 7320 746f 2063 6865  torage ls to che
-0002c170: 636b 2069 6620 616c 6c20 7374 6f72 6167  ck if all storag
-0002c180: 6520 6f62 6a65 6374 7320 6578 6973 7473  e objects exists
-0002c190: 2069 6e20 7468 650a 2020 2020 2020 2020   in the.        
-0002c1a0: 2320 6f75 7470 7574 2066 696c 7465 7265  # output filtere
-0002c1b0: 6420 6279 2073 746f 7265 2074 7970 650a  d by store type.
-0002c1c0: 2020 2020 2020 2020 6f75 745f 616c 6c20          out_all 
-0002c1d0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0002c1e0: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-0002c1f0: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-0002c200: 275d 290a 2020 2020 2020 2020 6f75 7420  ']).        out 
-0002c210: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0002c220: 6974 656d 2e73 706c 6974 2829 5b30 5d0a  item.split()[0].
-0002c230: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002c240: 6974 656d 2069 6e20 6f75 745f 616c 6c2e  item in out_all.
-0002c250: 6465 636f 6465 2827 7574 662d 3827 292e  decode('utf-8').
-0002c260: 7370 6c69 746c 696e 6573 2829 0a20 2020  splitlines().   
-0002c270: 2020 2020 2020 2020 2069 6620 7374 6f72           if stor
-0002c280: 655f 7479 7065 2e76 616c 7565 2069 6e20  e_type.value in 
-0002c290: 6974 656d 0a20 2020 2020 2020 205d 0a20  item.        ]. 
-0002c2a0: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
-0002c2b0: 6c28 5b69 7465 6d20 696e 206f 7574 2066  l([item in out f
-0002c2c0: 6f72 2069 7465 6d20 696e 2073 746f 7261  or item in stora
-0002c2d0: 6765 5f6f 626a 5f6e 616d 6573 5d29 0a0a  ge_obj_names])..
-0002c2e0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-0002c2f0: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
-0002c300: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0002c310: 7061 7261 6d65 7472 697a 6528 2773 746f  parametrize('sto
-0002c320: 7265 5f74 7970 6527 2c20 5b0a 2020 2020  re_type', [.    
-0002c330: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-0002c340: 5374 6f72 6554 7970 652e 5333 2c20 7374  StoreType.S3, st
-0002c350: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002c360: 7970 652e 4743 532c 0a20 2020 2020 2020  ype.GCS,.       
-0002c370: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-0002c380: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002c390: 7970 652e 4942 4d2c 206d 6172 6b73 3d70  ype.IBM, marks=p
-0002c3a0: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
-0002c3b0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002c3c0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002c3d0: 622e 5374 6f72 6554 7970 652e 5232 2c20  b.StoreType.R2, 
-0002c3e0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-0002c3f0: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
-0002c400: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
-0002c410: 745f 6275 636b 6574 5f65 7874 6572 6e61  t_bucket_externa
-0002c420: 6c5f 6465 6c65 7469 6f6e 2873 656c 662c  l_deletion(self,
-0002c430: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
-0002c440: 7261 6765 5f6f 626a 2c0a 2020 2020 2020  rage_obj,.      
-0002c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c470: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
-0002c480: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0002c490: 2062 7563 6b65 742c 2064 656c 6574 6573   bucket, deletes
-0002c4a0: 2069 7420 6578 7465 726e 616c 6c79 2075   it externally u
-0002c4b0: 7369 6e67 2063 6c6f 7564 2063 6c69 2063  sing cloud cli c
-0002c4c0: 6f6d 6d61 6e64 730a 2020 2020 2020 2020  ommands.        
-0002c4d0: 2320 616e 6420 7468 656e 2074 7269 6573  # and then tries
-0002c4e0: 2074 6f20 6465 6c65 7465 2069 7420 7573   to delete it us
-0002c4f0: 696e 6720 736b 7920 7374 6f72 6167 6520  ing sky storage 
-0002c500: 6465 6c65 7465 2e0a 2020 2020 2020 2020  delete..        
-0002c510: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
-0002c520: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-0002c530: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
-0002c540: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
-0002c550: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
-0002c560: 6865 636b 2069 6620 7374 6f72 6167 6520  heck if storage 
-0002c570: 6f62 6a65 6374 2065 7869 7374 7320 696e  object exists in
-0002c580: 2074 6865 206f 7574 7075 740a 2020 2020   the output.    
-0002c590: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
-0002c5a0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002c5b0: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
-0002c5c0: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
-0002c5d0: 2020 2020 6173 7365 7274 2074 6d70 5f73      assert tmp_s
-0002c5e0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
-0002c5f0: 626a 2e6e 616d 6520 696e 206f 7574 2e64  bj.name in out.d
-0002c600: 6563 6f64 6528 2775 7466 2d38 2729 0a0a  ecode('utf-8')..
-0002c610: 2020 2020 2020 2020 2320 4465 6c65 7465          # Delete
-0002c620: 2062 7563 6b65 7420 6578 7465 726e 616c   bucket external
-0002c630: 6c79 0a20 2020 2020 2020 2063 6d64 203d  ly.        cmd =
-0002c640: 2073 656c 662e 636c 695f 6465 6c65 7465   self.cli_delete
-0002c650: 5f63 6d64 2873 746f 7265 5f74 7970 652c  _cmd(store_type,
-0002c660: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
-0002c670: 7261 6765 5f6f 626a 2e6e 616d 6529 0a20  rage_obj.name). 
-0002c680: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-0002c690: 732e 6368 6563 6b5f 6f75 7470 7574 2863  s.check_output(c
-0002c6a0: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
-0002c6b0: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
-0002c6c0: 6b79 2073 746f 7261 6765 2064 656c 6574  ky storage delet
-0002c6d0: 6520 746f 2064 656c 6574 6520 7468 6520  e to delete the 
-0002c6e0: 7374 6f72 6167 6520 6f62 6a65 6374 0a20  storage object. 
-0002c6f0: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
-0002c700: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-0002c710: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-0002c720: 2020 5b27 736b 7927 2c20 2773 746f 7261    ['sky', 'stora
-0002c730: 6765 272c 2027 6465 6c65 7465 272c 2074  ge', 'delete', t
-0002c740: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
-0002c750: 6765 5f6f 626a 2e6e 616d 652c 2027 2d2d  ge_obj.name, '--
-0002c760: 7965 7327 5d29 0a20 2020 2020 2020 2023  yes']).        #
-0002c770: 204d 616b 6520 7375 7265 2062 7563 6b65   Make sure bucke
-0002c780: 7420 7761 7320 6e6f 7420 6372 6561 7465  t was not create
-0002c790: 6420 6475 7269 6e67 2064 656c 6574 696f  d during deletio
-0002c7a0: 6e20 2873 6565 2069 7373 7565 2023 3133  n (see issue #13
-0002c7b0: 3232 290a 2020 2020 2020 2020 6173 7365  22).        asse
-0002c7c0: 7274 2027 6372 6561 7465 6427 206e 6f74  rt 'created' not
-0002c7d0: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-0002c7e0: 7574 662d 3827 292e 6c6f 7765 7228 290a  utf-8').lower().
-0002c7f0: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
-0002c800: 6b79 2073 746f 7261 6765 206c 7320 746f  ky storage ls to
-0002c810: 2063 6865 636b 2069 6620 7374 6f72 6167   check if storag
-0002c820: 6520 6f62 6a65 6374 2069 7320 6465 6c65  e object is dele
-0002c830: 7465 640a 2020 2020 2020 2020 6f75 7420  ted.        out 
-0002c840: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0002c850: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-0002c860: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-0002c870: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
-0002c880: 7274 2074 6d70 5f73 6372 6174 6368 5f73  rt tmp_scratch_s
-0002c890: 746f 7261 6765 5f6f 626a 2e6e 616d 6520  torage_obj.name 
-0002c8a0: 6e6f 7420 696e 206f 7574 2e64 6563 6f64  not in out.decod
-0002c8b0: 6528 2775 7466 2d38 2729 0a0a 2020 2020  e('utf-8')..    
-0002c8c0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0002c8d0: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
-0002c8e0: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
-0002c8f0: 6d65 7472 697a 6528 2773 746f 7265 5f74  metrize('store_t
-0002c900: 7970 6527 2c20 5b0a 2020 2020 2020 2020  ype', [.        
-0002c910: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002c920: 6554 7970 652e 5333 2c20 7374 6f72 6167  eType.S3, storag
-0002c930: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002c940: 4743 532c 0a20 2020 2020 2020 2070 7974  GCS,.        pyt
-0002c950: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
-0002c960: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002c970: 4942 4d2c 206d 6172 6b73 3d70 7974 6573  IBM, marks=pytes
-0002c980: 742e 6d61 726b 2e69 626d 292c 0a20 2020  t.mark.ibm),.   
-0002c990: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-0002c9a0: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
-0002c9b0: 6f72 6554 7970 652e 5232 2c20 6d61 726b  oreType.R2, mark
-0002c9c0: 733d 7079 7465 7374 2e6d 6172 6b2e 636c  s=pytest.mark.cl
-0002c9d0: 6f75 6466 6c61 7265 290a 2020 2020 5d29  oudflare).    ])
-0002c9e0: 0a20 2020 2064 6566 2074 6573 745f 6275  .    def test_bu
-0002c9f0: 636b 6574 5f62 756c 6b5f 6465 6c65 7469  cket_bulk_deleti
-0002ca00: 6f6e 2873 656c 662c 2073 746f 7265 5f74  on(self, store_t
-0002ca10: 7970 652c 2074 6d70 5f62 756c 6b5f 6465  ype, tmp_bulk_de
-0002ca20: 6c5f 7374 6f72 6167 655f 6f62 6a29 3a0a  l_storage_obj):.
-0002ca30: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002ca40: 7320 6120 7465 6d70 2066 6f6c 6465 7220  s a temp folder 
-0002ca50: 7769 7468 206f 7665 7220 3235 3620 6669  with over 256 fi
-0002ca60: 6c65 7320 616e 6420 666f 6c64 6572 732c  les and folders,
-0002ca70: 2075 706c 6f61 640a 2020 2020 2020 2020   upload.        
-0002ca80: 2320 6669 6c65 7320 616e 6420 666f 6c64  # files and fold
-0002ca90: 6572 7320 746f 2061 206e 6577 2062 7563  ers to a new buc
-0002caa0: 6b65 742c 2074 6865 6e20 6465 6c65 7465  ket, then delete
-0002cab0: 2062 7563 6b65 742e 0a20 2020 2020 2020   bucket..       
-0002cac0: 2074 6d70 5f62 756c 6b5f 6465 6c5f 7374   tmp_bulk_del_st
-0002cad0: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
-0002cae0: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
-0002caf0: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
-0002cb00: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002cb10: 285b 0a20 2020 2020 2020 2020 2020 2027  ([.            '
-0002cb20: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-0002cb30: 2027 6465 6c65 7465 272c 2074 6d70 5f62   'delete', tmp_b
-0002cb40: 756c 6b5f 6465 6c5f 7374 6f72 6167 655f  ulk_del_storage_
-0002cb50: 6f62 6a2e 6e61 6d65 2c20 272d 2d79 6573  obj.name, '--yes
-0002cb60: 270a 2020 2020 2020 2020 5d29 0a0a 2020  '.        ])..  
-0002cb70: 2020 2020 2020 6f75 7470 7574 203d 2073        output = s
-0002cb80: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002cb90: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
-0002cba0: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
-0002cbb0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002cbc0: 746d 705f 6275 6c6b 5f64 656c 5f73 746f  tmp_bulk_del_sto
-0002cbd0: 7261 6765 5f6f 626a 2e6e 616d 6520 6e6f  rage_obj.name no
-0002cbe0: 7420 696e 206f 7574 7075 742e 6465 636f  t in output.deco
-0002cbf0: 6465 2827 7574 662d 3827 290a 0a20 2020  de('utf-8')..   
-0002cc00: 2040 7079 7465 7374 2e6d 6172 6b2e 6e6f   @pytest.mark.no
-0002cc10: 5f66 6c75 6964 7374 6163 6b0a 2020 2020  _fluidstack.    
-0002cc20: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-0002cc30: 616d 6574 7269 7a65 280a 2020 2020 2020  ametrize(.      
-0002cc40: 2020 2774 6d70 5f70 7562 6c69 635f 7374    'tmp_public_st
-0002cc50: 6f72 6167 655f 6f62 6a2c 2073 746f 7265  orage_obj, store
-0002cc60: 5f74 7970 6527 2c0a 2020 2020 2020 2020  _type',.        
-0002cc70: 5b28 2773 333a 2f2f 7463 6761 2d32 2d6f  [('s3://tcga-2-o
-0002cc80: 7065 6e27 2c20 7374 6f72 6167 655f 6c69  pen', storage_li
-0002cc90: 622e 5374 6f72 6554 7970 652e 5333 292c  b.StoreType.S3),
-0002cca0: 0a20 2020 2020 2020 2020 2827 7333 3a2f  .         ('s3:/
-0002ccb0: 2f64 6967 6974 616c 636f 7270 6f72 6127  /digitalcorpora'
-0002ccc0: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-0002ccd0: 6f72 6554 7970 652e 5333 292c 0a20 2020  oreType.S3),.   
-0002cce0: 2020 2020 2020 2827 6773 3a2f 2f67 6370        ('gs://gcp
-0002ccf0: 2d70 7562 6c69 632d 6461 7461 2d73 656e  -public-data-sen
-0002cd00: 7469 6e65 6c2d 3227 2c20 7374 6f72 6167  tinel-2', storag
-0002cd10: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002cd20: 4743 5329 5d2c 0a20 2020 2020 2020 2069  GCS)],.        i
-0002cd30: 6e64 6972 6563 743d 5b27 746d 705f 7075  ndirect=['tmp_pu
-0002cd40: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
-0002cd50: 275d 290a 2020 2020 6465 6620 7465 7374  ']).    def test
-0002cd60: 5f70 7562 6c69 635f 6275 636b 6574 2873  _public_bucket(s
-0002cd70: 656c 662c 2074 6d70 5f70 7562 6c69 635f  elf, tmp_public_
-0002cd80: 7374 6f72 6167 655f 6f62 6a2c 2073 746f  storage_obj, sto
-0002cd90: 7265 5f74 7970 6529 3a0a 2020 2020 2020  re_type):.      
-0002cda0: 2020 2320 4372 6561 7465 7320 6120 6e65    # Creates a ne
-0002cdb0: 7720 6275 636b 6574 2077 6974 6820 6120  w bucket with a 
-0002cdc0: 7075 626c 6963 2073 6f75 7263 6520 616e  public source an
-0002cdd0: 6420 7665 7269 6669 6573 2074 6861 7420  d verifies that 
-0002cde0: 6974 2069 7320 6e6f 740a 2020 2020 2020  it is not.      
-0002cdf0: 2020 2320 6164 6465 6420 746f 2067 6c6f    # added to glo
-0002ce00: 6261 6c5f 7573 6572 5f73 7461 7465 2e0a  bal_user_state..
-0002ce10: 2020 2020 2020 2020 746d 705f 7075 626c          tmp_publ
-0002ce20: 6963 5f73 746f 7261 6765 5f6f 626a 2e61  ic_storage_obj.a
-0002ce30: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-0002ce40: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
-0002ce50: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0002ce60: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
-0002ce70: 746f 7261 6765 206f 626a 6563 7420 6578  torage object ex
-0002ce80: 6973 7473 2069 6e20 7468 6520 6f75 7470  ists in the outp
-0002ce90: 7574 0a20 2020 2020 2020 206f 7574 203d  ut.        out =
-0002cea0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002ceb0: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-0002cec0: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-0002ced0: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
-0002cee0: 7420 746d 705f 7075 626c 6963 5f73 746f  t tmp_public_sto
-0002cef0: 7261 6765 5f6f 626a 2e6e 616d 6520 6e6f  rage_obj.name no
-0002cf00: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
-0002cf10: 2775 7466 2d38 2729 0a0a 2020 2020 4070  'utf-8')..    @p
-0002cf20: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-0002cf30: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-0002cf40: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-0002cf50: 7472 697a 6528 276e 6f6e 6578 6973 745f  trize('nonexist_
-0002cf60: 6275 636b 6574 5f75 726c 272c 205b 0a20  bucket_url', [. 
-0002cf70: 2020 2020 2020 2027 7333 3a2f 2f7b 7261         's3://{ra
-0002cf80: 6e64 6f6d 5f6e 616d 657d 272c 2027 6773  ndom_name}', 'gs
-0002cf90: 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d 657d  ://{random_name}
-0002cfa0: 272c 0a20 2020 2020 2020 2070 7974 6573  ',.        pytes
-0002cfb0: 742e 7061 7261 6d28 2763 6f73 3a2f 2f75  t.param('cos://u
-0002cfc0: 732d 6561 7374 2f7b 7261 6e64 6f6d 5f6e  s-east/{random_n
-0002cfd0: 616d 657d 272c 206d 6172 6b73 3d70 7974  ame}', marks=pyt
-0002cfe0: 6573 742e 6d61 726b 2e69 626d 292c 0a20  est.mark.ibm),. 
-0002cff0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0002d000: 7261 6d28 2772 323a 2f2f 7b72 616e 646f  ram('r2://{rando
-0002d010: 6d5f 6e61 6d65 7d27 2c20 6d61 726b 733d  m_name}', marks=
-0002d020: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
-0002d030: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
-0002d040: 2020 2064 6566 2074 6573 745f 6e6f 6e65     def test_none
-0002d050: 7869 7374 656e 745f 6275 636b 6574 2873  xistent_bucket(s
-0002d060: 656c 662c 206e 6f6e 6578 6973 745f 6275  elf, nonexist_bu
-0002d070: 636b 6574 5f75 726c 293a 0a20 2020 2020  cket_url):.     
-0002d080: 2020 2023 2041 7474 656d 7074 7320 746f     # Attempts to
-0002d090: 2063 7265 6174 6520 6665 7463 6820 6120   create fetch a 
-0002d0a0: 7374 726f 6167 6520 7769 7468 2061 206e  stroage with a n
-0002d0b0: 6f6e 2d65 7869 7374 656e 7420 736f 7572  on-existent sour
-0002d0c0: 6365 2e0a 2020 2020 2020 2020 2320 4765  ce..        # Ge
-0002d0d0: 6e65 7261 7465 2061 2072 616e 646f 6d20  nerate a random 
-0002d0e0: 6275 636b 6574 206e 616d 6520 616e 6420  bucket name and 
-0002d0f0: 7665 7269 6679 2069 7420 646f 6573 6e27  verify it doesn'
-0002d100: 7420 6578 6973 743a 0a20 2020 2020 2020  t exist:.       
-0002d110: 2072 6574 7279 5f63 6f75 6e74 203d 2030   retry_count = 0
-0002d120: 0a20 2020 2020 2020 2077 6869 6c65 2054  .        while T
-0002d130: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-0002d140: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
-0002d150: 5f6e 616d 6520 3d20 7374 7228 7575 6964  _name = str(uuid
-0002d160: 2e75 7569 6434 2829 290a 2020 2020 2020  .uuid4()).      
-0002d170: 2020 2020 2020 6966 206e 6f6e 6578 6973        if nonexis
-0002d180: 745f 6275 636b 6574 5f75 726c 2e73 7461  t_bucket_url.sta
-0002d190: 7274 7377 6974 6828 2773 3327 293a 0a20  rtswith('s3'):. 
-0002d1a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002d1b0: 6f6d 6d61 6e64 203d 2066 2761 7773 2073  ommand = f'aws s
-0002d1c0: 3361 7069 2068 6561 642d 6275 636b 6574  3api head-bucket
-0002d1d0: 202d 2d62 7563 6b65 7420 7b6e 6f6e 6578   --bucket {nonex
-0002d1e0: 6973 745f 6275 636b 6574 5f6e 616d 657d  ist_bucket_name}
-0002d1f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0002d200: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
-0002d210: 7420 3d20 2734 3034 270a 2020 2020 2020  t = '404'.      
-0002d220: 2020 2020 2020 656c 6966 206e 6f6e 6578        elif nonex
-0002d230: 6973 745f 6275 636b 6574 5f75 726c 2e73  ist_bucket_url.s
-0002d240: 7461 7274 7377 6974 6828 2767 7327 293a  tartswith('gs'):
-0002d250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d260: 2063 6f6d 6d61 6e64 203d 2066 2767 7375   command = f'gsu
-0002d270: 7469 6c20 6c73 207b 6e6f 6e65 7869 7374  til ls {nonexist
-0002d280: 5f62 7563 6b65 745f 7572 6c2e 666f 726d  _bucket_url.form
-0002d290: 6174 2872 616e 646f 6d5f 6e61 6d65 3d6e  at(random_name=n
-0002d2a0: 6f6e 6578 6973 745f 6275 636b 6574 5f6e  onexist_bucket_n
-0002d2b0: 616d 6529 7d27 0a20 2020 2020 2020 2020  ame)}'.         
-0002d2c0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-0002d2d0: 6f75 7470 7574 203d 2027 4275 636b 6574  output = 'Bucket
-0002d2e0: 4e6f 7446 6f75 6e64 4578 6365 7074 696f  NotFoundExceptio
-0002d2f0: 6e27 0a20 2020 2020 2020 2020 2020 2065  n'.            e
-0002d300: 6c69 6620 6e6f 6e65 7869 7374 5f62 7563  lif nonexist_buc
-0002d310: 6b65 745f 7572 6c2e 7374 6172 7473 7769  ket_url.startswi
-0002d320: 7468 2827 7232 2729 3a0a 2020 2020 2020  th('r2'):.      
-0002d330: 2020 2020 2020 2020 2020 656e 6470 6f69            endpoi
-0002d340: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
-0002d350: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
-0002d360: 696e 7428 290a 2020 2020 2020 2020 2020  int().          
-0002d370: 2020 2020 2020 636f 6d6d 616e 6420 3d20        command = 
-0002d380: 6627 4157 535f 5348 4152 4544 5f43 5245  f'AWS_SHARED_CRE
-0002d390: 4445 4e54 4941 4c53 5f46 494c 453d 7b63  DENTIALS_FILE={c
-0002d3a0: 6c6f 7564 666c 6172 652e 5232 5f43 5245  loudflare.R2_CRE
-0002d3b0: 4445 4e54 4941 4c53 5f50 4154 487d 2061  DENTIALS_PATH} a
-0002d3c0: 7773 2073 3361 7069 2068 6561 642d 6275  ws s3api head-bu
-0002d3d0: 636b 6574 202d 2d62 7563 6b65 7420 7b6e  cket --bucket {n
-0002d3e0: 6f6e 6578 6973 745f 6275 636b 6574 5f6e  onexist_bucket_n
-0002d3f0: 616d 657d 202d 2d65 6e64 706f 696e 7420  ame} --endpoint 
-0002d400: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
-0002d410: 2d70 726f 6669 6c65 3d72 3227 0a20 2020  -profile=r2'.   
-0002d420: 2020 2020 2020 2020 2020 2020 2065 7870               exp
-0002d430: 6563 7465 645f 6f75 7470 7574 203d 2027  ected_output = '
-0002d440: 3430 3427 0a20 2020 2020 2020 2020 2020  404'.           
-0002d450: 2065 6c69 6620 6e6f 6e65 7869 7374 5f62   elif nonexist_b
-0002d460: 7563 6b65 745f 7572 6c2e 7374 6172 7473  ucket_url.starts
-0002d470: 7769 7468 2827 636f 7327 293a 0a20 2020  with('cos'):.   
-0002d480: 2020 2020 2020 2020 2020 2020 2023 2055               # U
-0002d490: 7369 6e67 2041 5049 2063 616c 6c73 2c20  sing API calls, 
-0002d4a0: 7369 6e63 6520 7573 696e 6720 7263 6c6f  since using rclo
-0002d4b0: 6e65 2072 6571 7569 7265 7320 6120 7072  ne requires a pr
-0002d4c0: 6f66 696c 6527 7320 6e61 6d65 0a20 2020  ofile's name.   
-0002d4d0: 2020 2020 2020 2020 2020 2020 2074 7279               try
-0002d4e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002d4f0: 2020 2020 2020 6578 7065 6374 6564 5f6f        expected_o
-0002d500: 7574 7075 7420 3d20 636f 6d6d 616e 6420  utput = command 
-0002d510: 3d20 2265 6368 6f22 2020 2320 6176 6f69  = "echo"  # avoi
-0002d520: 6420 756e 7265 6c61 7465 6420 6578 6365  d unrelated exce
-0002d530: 7074 696f 6e20 696e 2063 6173 6520 6f66  ption in case of
-0002d540: 2066 6169 6c75 7265 2e0a 2020 2020 2020   failure..      
-0002d550: 2020 2020 2020 2020 2020 2020 2020 6275                bu
-0002d560: 636b 6574 5f6e 616d 6520 3d20 7572 6c6c  cket_name = urll
-0002d570: 6962 2e70 6172 7365 2e75 726c 7370 6c69  ib.parse.urlspli
-0002d580: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0002d590: 2020 2020 2020 2020 2020 206e 6f6e 6578             nonex
-0002d5a0: 6973 745f 6275 636b 6574 5f75 726c 2e66  ist_bucket_url.f
-0002d5b0: 6f72 6d61 7428 0a20 2020 2020 2020 2020  ormat(.         
-0002d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d5d0: 2020 2072 616e 646f 6d5f 6e61 6d65 3d6e     random_name=n
-0002d5e0: 6f6e 6578 6973 745f 6275 636b 6574 5f6e  onexist_bucket_n
-0002d5f0: 616d 6529 292e 7061 7468 2e73 7472 6970  ame)).path.strip
-0002d600: 2827 2f27 290a 2020 2020 2020 2020 2020  ('/').          
-0002d610: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-0002d620: 203d 2069 626d 2e67 6574 5f63 6f73 5f63   = ibm.get_cos_c
-0002d630: 6c69 656e 7428 2775 732d 6561 7374 2729  lient('us-east')
-0002d640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d650: 2020 2020 2063 6c69 656e 742e 6865 6164       client.head
-0002d660: 5f62 7563 6b65 7428 4275 636b 6574 3d62  _bucket(Bucket=b
-0002d670: 7563 6b65 745f 6e61 6d65 290a 2020 2020  ucket_name).    
-0002d680: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0002d690: 7074 2069 626d 2e69 626d 5f62 6f74 6f63  pt ibm.ibm_botoc
-0002d6a0: 6f72 652e 6578 6365 7074 696f 6e73 2e43  ore.exceptions.C
-0002d6b0: 6c69 656e 7445 7272 6f72 2061 7320 653a  lientError as e:
-0002d6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d6d0: 2020 2020 2069 6620 652e 7265 7370 6f6e       if e.respon
-0002d6e0: 7365 5b27 4572 726f 7227 5d5b 2743 6f64  se['Error']['Cod
-0002d6f0: 6527 5d20 3d3d 2027 3430 3427 3a0a 2020  e'] == '404':.  
-0002d700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d710: 2020 2020 2020 2320 7375 6363 6573 730a        # success.
-0002d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d730: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0002d740: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002d750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d760: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-0002d770: 7228 2755 6e73 7570 706f 7274 6564 2062  r('Unsupported b
-0002d780: 7563 6b65 7420 7479 7065 2027 0a20 2020  ucket type '.   
-0002d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d7a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0002d7b0: 7b6e 6f6e 6578 6973 745f 6275 636b 6574  {nonexist_bucket
-0002d7c0: 5f75 726c 7d27 290a 0a20 2020 2020 2020  _url}')..       
-0002d7d0: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
-0002d7e0: 6275 636b 6574 2065 7869 7374 7320 7573  bucket exists us
-0002d7f0: 696e 6720 7468 6520 636c 693a 0a20 2020  ing the cli:.   
-0002d800: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0002d810: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0002d820: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-0002d830: 6865 636b 5f6f 7574 7075 7428 636f 6d6d  heck_output(comm
-0002d840: 616e 642c 0a20 2020 2020 2020 2020 2020  and,.           
-0002d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d870: 2020 2073 7464 6572 723d 7375 6270 726f     stderr=subpro
-0002d880: 6365 7373 2e53 5444 4f55 542c 0a20 2020  cess.STDOUT,.   
-0002d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d8b0: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
-0002d8c0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-0002d8d0: 2020 2065 7863 6570 7420 7375 6270 726f     except subpro
-0002d8e0: 6365 7373 2e43 616c 6c65 6450 726f 6365  cess.CalledProce
-0002d8f0: 7373 4572 726f 7220 6173 2065 3a0a 2020  ssError as e:.  
-0002d900: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0002d910: 7420 3d20 652e 6f75 7470 7574 0a20 2020  t = e.output.   
-0002d920: 2020 2020 2020 2020 206f 7574 203d 206f           out = o
-0002d930: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-0002d940: 2729 0a20 2020 2020 2020 2020 2020 2069  ').            i
-0002d950: 6620 6578 7065 6374 6564 5f6f 7574 7075  f expected_outpu
-0002d960: 7420 696e 206f 7574 3a0a 2020 2020 2020  t in out:.      
-0002d970: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0002d980: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0002d990: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002d9a0: 2020 7265 7472 795f 636f 756e 7420 2b3d    retry_count +=
-0002d9b0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-0002d9c0: 2020 2069 6620 7265 7472 795f 636f 756e     if retry_coun
-0002d9d0: 7420 3e20 333a 0a20 2020 2020 2020 2020  t > 3:.         
-0002d9e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0002d9f0: 2052 756e 7469 6d65 4572 726f 7228 2755   RuntimeError('U
-0002da00: 6e61 626c 6520 746f 2066 696e 6420 6120  nable to find a 
-0002da10: 6e6f 6e65 7869 7374 656e 7420 6275 636b  nonexistent buck
-0002da20: 6574 2027 0a20 2020 2020 2020 2020 2020  et '.           
-0002da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da40: 2020 2020 2020 2020 2020 2020 2774 6f20              'to 
-0002da50: 7573 652e 2054 6869 7320 6973 2068 6967  use. This is hig
-0002da60: 6c79 2075 6e6c 696b 656c 7920 2d20 270a  ly unlikely - '.
-0002da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da90: 2020 2020 2020 2027 6368 6563 6b20 6966         'check if
-0002daa0: 2074 6865 2074 6573 7473 2061 7265 2063   the tests are c
-0002dab0: 6f72 7265 6374 2e27 290a 0a20 2020 2020  orrect.')..     
-0002dac0: 2020 2077 6974 6820 7079 7465 7374 2e72     with pytest.r
-0002dad0: 6169 7365 7328 0a20 2020 2020 2020 2020  aises(.         
-0002dae0: 2020 2020 2020 2073 6b79 2e65 7863 6570         sky.excep
-0002daf0: 7469 6f6e 732e 5374 6f72 6167 6542 7563  tions.StorageBuc
-0002db00: 6b65 7447 6574 4572 726f 722c 0a20 2020  ketGetError,.   
-0002db10: 2020 2020 2020 2020 2020 2020 206d 6174               mat
-0002db20: 6368 3d27 4174 7465 6d70 7465 6420 746f  ch='Attempted to
-0002db30: 2075 7365 2061 206e 6f6e 2d65 7869 7374   use a non-exist
-0002db40: 656e 7420 6275 636b 6574 2061 7320 6120  ent bucket as a 
-0002db50: 736f 7572 6365 2729 3a0a 2020 2020 2020  source'):.      
-0002db60: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-0002db70: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
-0002db80: 5374 6f72 6167 6528 736f 7572 6365 3d6e  Storage(source=n
-0002db90: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
-0002dba0: 726c 2e66 6f72 6d61 7428 0a20 2020 2020  rl.format(.     
-0002dbb0: 2020 2020 2020 2020 2020 2072 616e 646f             rando
-0002dbc0: 6d5f 6e61 6d65 3d6e 6f6e 6578 6973 745f  m_name=nonexist_
-0002dbd0: 6275 636b 6574 5f6e 616d 6529 290a 0a20  bucket_name)).. 
-0002dbe0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0002dbf0: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
-0002dc00: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-0002dc10: 6172 616d 6574 7269 7a65 2827 7072 6976  arametrize('priv
-0002dc20: 6174 655f 6275 636b 6574 272c 205b 0a20  ate_bucket', [. 
-0002dc30: 2020 2020 2020 2066 2773 333a 2f2f 696d         f's3://im
-0002dc40: 6167 656e 6574 272c 2066 2767 733a 2f2f  agenet', f'gs://
-0002dc50: 696d 6167 656e 6574 272c 0a20 2020 2020  imagenet',.     
-0002dc60: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002dc70: 2763 6f73 3a2f 2f75 732d 6561 7374 2f62  'cos://us-east/b
-0002dc80: 7563 6b65 7431 272c 206d 6172 6b73 3d70  ucket1', marks=p
-0002dc90: 7974 6573 742e 6d61 726b 2e69 626d 290a  ytest.mark.ibm).
-0002dca0: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0002dcb0: 6573 745f 7072 6976 6174 655f 6275 636b  est_private_buck
-0002dcc0: 6574 2873 656c 662c 2070 7269 7661 7465  et(self, private
-0002dcd0: 5f62 7563 6b65 7429 3a0a 2020 2020 2020  _bucket):.      
-0002dce0: 2020 2320 4174 7465 6d70 7473 2074 6f20    # Attempts to 
-0002dcf0: 6163 6365 7373 2070 7269 7661 7465 2062  access private b
-0002dd00: 7563 6b65 7473 206e 6f74 2062 656c 6f6e  uckets not belon
-0002dd10: 6769 6e67 2074 6f20 7468 6520 7573 6572  ging to the user
-0002dd20: 2e0a 2020 2020 2020 2020 2320 5468 6573  ..        # Thes
-0002dd30: 6520 6275 636b 6574 7320 6172 6520 6b6e  e buckets are kn
-0002dd40: 6f77 6e20 746f 2062 6520 7072 6976 6174  own to be privat
-0002dd50: 652c 2062 7574 206d 6179 206e 6565 6420  e, but may need 
-0002dd60: 746f 2062 6520 7570 6461 7465 6420 6966  to be updated if
-0002dd70: 0a20 2020 2020 2020 2023 2074 6865 7920  .        # they 
-0002dd80: 6172 6520 7265 6d6f 7665 6420 6279 2074  are removed by t
-0002dd90: 6865 6972 206f 776e 6572 732e 0a20 2020  heir owners..   
-0002dda0: 2020 2020 2070 7269 7661 7465 5f62 7563       private_buc
-0002ddb0: 6b65 745f 6e61 6d65 203d 2075 726c 6c69  ket_name = urlli
-0002ddc0: 622e 7061 7273 652e 7572 6c73 706c 6974  b.parse.urlsplit
-0002ddd0: 2870 7269 7661 7465 5f62 7563 6b65 7429  (private_bucket)
-0002dde0: 2e6e 6574 6c6f 6320 6966 205c 0a20 2020  .netloc if \.   
-0002ddf0: 2020 2020 2020 2020 2020 2075 726c 6c69             urlli
-0002de00: 622e 7061 7273 652e 7572 6c73 706c 6974  b.parse.urlsplit
-0002de10: 2870 7269 7661 7465 5f62 7563 6b65 7429  (private_bucket)
-0002de20: 2e73 6368 656d 6520 213d 2027 636f 7327  .scheme != 'cos'
-0002de30: 2065 6c73 6520 5c0a 2020 2020 2020 2020   else \.        
-0002de40: 2020 2020 2020 2020 2020 7572 6c6c 6962            urllib
-0002de50: 2e70 6172 7365 2e75 726c 7370 6c69 7428  .parse.urlsplit(
-0002de60: 7072 6976 6174 655f 6275 636b 6574 292e  private_bucket).
-0002de70: 7061 7468 2e73 7472 6970 2827 2f27 290a  path.strip('/').
-0002de80: 2020 2020 2020 2020 7769 7468 2070 7974          with pyt
-0002de90: 6573 742e 7261 6973 6573 280a 2020 2020  est.raises(.    
-0002dea0: 2020 2020 2020 2020 2020 2020 736b 792e              sky.
-0002deb0: 6578 6365 7074 696f 6e73 2e53 746f 7261  exceptions.Stora
-0002dec0: 6765 4275 636b 6574 4765 7445 7272 6f72  geBucketGetError
-0002ded0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002dee0: 2020 6d61 7463 683d 7374 6f72 6167 655f    match=storage_
-0002def0: 6c69 622e 5f42 5543 4b45 545f 4641 494c  lib._BUCKET_FAIL
-0002df00: 5f54 4f5f 434f 4e4e 4543 545f 4d45 5353  _TO_CONNECT_MESS
-0002df10: 4147 452e 666f 726d 6174 280a 2020 2020  AGE.format(.    
-0002df20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002df30: 6e61 6d65 3d70 7269 7661 7465 5f62 7563  name=private_buc
-0002df40: 6b65 745f 6e61 6d65 2929 3a0a 2020 2020  ket_name)):.    
-0002df50: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002df60: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
-0002df70: 622e 5374 6f72 6167 6528 736f 7572 6365  b.Storage(source
-0002df80: 3d70 7269 7661 7465 5f62 7563 6b65 7429  =private_bucket)
-0002df90: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002dfa0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002dfb0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002dfc0: 6b2e 7061 7261 6d65 7472 697a 6528 2765  k.parametrize('e
-0002dfd0: 7874 5f62 7563 6b65 745f 6669 7874 7572  xt_bucket_fixtur
-0002dfe0: 652c 2073 746f 7265 5f74 7970 6527 2c0a  e, store_type',.
-0002dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e000: 2020 2020 2020 2020 2020 2020 205b 2827               [('
-0002e010: 746d 705f 6177 7363 6c69 5f62 7563 6b65  tmp_awscli_bucke
-0002e020: 7427 2c20 7374 6f72 6167 655f 6c69 622e  t', storage_lib.
-0002e030: 5374 6f72 6554 7970 652e 5333 292c 0a20  StoreType.S3),. 
-0002e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e050: 2020 2020 2020 2020 2020 2020 2028 2774               ('t
-0002e060: 6d70 5f67 7375 7469 6c5f 6275 636b 6574  mp_gsutil_bucket
-0002e070: 272c 2073 746f 7261 6765 5f6c 6962 2e53  ', storage_lib.S
-0002e080: 746f 7265 5479 7065 2e47 4353 292c 0a20  toreType.GCS),. 
-0002e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e0a0: 2020 2020 2020 2020 2020 2020 2070 7974               pyt
-0002e0b0: 6573 742e 7061 7261 6d28 2774 6d70 5f69  est.param('tmp_i
-0002e0c0: 626d 5f63 6f73 5f62 7563 6b65 7427 2c0a  bm_cos_bucket',.
-0002e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e0f0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002e100: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002e110: 2e49 424d 2c0a 2020 2020 2020 2020 2020  .IBM,.          
-0002e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e140: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002e150: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
-0002e160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e170: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0002e180: 7261 6d28 2774 6d70 5f61 7773 636c 695f  ram('tmp_awscli_
-0002e190: 6275 636b 6574 5f72 3227 2c0a 2020 2020  bucket_r2',.    
-0002e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e1c0: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
-0002e1d0: 6962 2e53 746f 7265 5479 7065 2e52 322c  ib.StoreType.R2,
-0002e1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e200: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
-0002e210: 733d 7079 7465 7374 2e6d 6172 6b2e 636c  s=pytest.mark.cl
-0002e220: 6f75 6466 6c61 7265 295d 290a 2020 2020  oudflare)]).    
-0002e230: 6465 6620 7465 7374 5f75 706c 6f61 645f  def test_upload_
-0002e240: 746f 5f65 7869 7374 696e 675f 6275 636b  to_existing_buck
-0002e250: 6574 2873 656c 662c 2065 7874 5f62 7563  et(self, ext_buc
-0002e260: 6b65 745f 6669 7874 7572 652c 2072 6571  ket_fixture, req
-0002e270: 7565 7374 2c0a 2020 2020 2020 2020 2020  uest,.          
-0002e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e290: 2020 2020 2020 2020 2020 2020 2074 6d70               tmp
-0002e2a0: 5f73 6f75 7263 652c 2073 746f 7265 5f74  _source, store_t
-0002e2b0: 7970 6529 3a0a 2020 2020 2020 2020 2320  ype):.        # 
-0002e2c0: 5472 6965 7320 7570 6c6f 6164 696e 6720  Tries uploading 
-0002e2d0: 6578 6973 7469 6e67 2066 696c 6573 2074  existing files t
-0002e2e0: 6f20 6e65 776c 7920 6372 6561 7465 6420  o newly created 
-0002e2f0: 6275 636b 6574 2028 6f75 7473 6964 6520  bucket (outside 
-0002e300: 6f66 0a20 2020 2020 2020 2023 2073 6b79  of.        # sky
-0002e310: 2920 616e 6420 7665 7269 6669 6573 2074  ) and verifies t
-0002e320: 6861 7420 6669 6c65 7320 6172 6520 7772  hat files are wr
-0002e330: 6974 7465 6e2e 0a20 2020 2020 2020 2062  itten..        b
-0002e340: 7563 6b65 745f 6e61 6d65 2c20 5f20 3d20  ucket_name, _ = 
-0002e350: 7265 7175 6573 742e 6765 7466 6978 7475  request.getfixtu
-0002e360: 7265 7661 6c75 6528 6578 745f 6275 636b  revalue(ext_buck
-0002e370: 6574 5f66 6978 7475 7265 290a 2020 2020  et_fixture).    
-0002e380: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-0002e390: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0002e3a0: 6f72 6167 6528 6e61 6d65 3d62 7563 6b65  orage(name=bucke
-0002e3b0: 745f 6e61 6d65 2c20 736f 7572 6365 3d74  t_name, source=t
-0002e3c0: 6d70 5f73 6f75 7263 6529 0a20 2020 2020  mp_source).     
-0002e3d0: 2020 2073 746f 7261 6765 5f6f 626a 2e61     storage_obj.a
-0002e3e0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-0002e3f0: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
-0002e400: 4368 6563 6b20 6966 2074 6d70 5f73 6f75  Check if tmp_sou
-0002e410: 7263 652f 746d 702d 6669 6c65 2065 7869  rce/tmp-file exi
-0002e420: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
-0002e430: 7420 7573 696e 6720 6177 7320 636c 690a  t using aws cli.
-0002e440: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-0002e450: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0002e460: 7574 7075 7428 7365 6c66 2e63 6c69 5f6c  utput(self.cli_l
-0002e470: 735f 636d 6428 7374 6f72 655f 7479 7065  s_cmd(store_type
-0002e480: 2c20 6275 636b 6574 5f6e 616d 6529 2c0a  , bucket_name),.
+00029fe0: 736f 7572 6365 3d73 6f75 7263 652c 0a20  source=source,. 
+00029ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a010: 2020 2020 2020 2020 2073 746f 7265 733d           stores=
+0002a020: 7374 6f72 6573 2c0a 2020 2020 2020 2020  stores,.        
+0002a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a050: 2020 7065 7273 6973 7465 6e74 3d70 6572    persistent=per
+0002a060: 7369 7374 656e 742c 0a20 2020 2020 2020  sistent,.       
+0002a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a090: 2020 206d 6f64 653d 6d6f 6465 290a 2020     mode=mode).  
+0002a0a0: 2020 2020 2020 7969 656c 6420 7374 6f72        yield stor
+0002a0b0: 6167 655f 6f62 6a0a 2020 2020 2020 2020  age_obj.        
+0002a0c0: 6861 6e64 6c65 203d 2067 6c6f 6261 6c5f  handle = global_
+0002a0d0: 7573 6572 5f73 7461 7465 2e67 6574 5f68  user_state.get_h
+0002a0e0: 616e 646c 655f 6672 6f6d 5f73 746f 7261  andle_from_stora
+0002a0f0: 6765 5f6e 616d 6528 0a20 2020 2020 2020  ge_name(.       
+0002a100: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0002a110: 2e6e 616d 6529 0a20 2020 2020 2020 2069  .name).        i
+0002a120: 6620 6861 6e64 6c65 3a0a 2020 2020 2020  f handle:.      
+0002a130: 2020 2020 2020 2320 4966 2068 616e 646c        # If handl
+0002a140: 6520 6578 6973 7473 2c20 6465 6c65 7465  e exists, delete
+0002a150: 206d 616e 7561 6c6c 790a 2020 2020 2020   manually.      
+0002a160: 2020 2020 2020 2320 544f 444f 2872 6f6d        # TODO(rom
+0002a170: 696c 6229 3a20 5468 6973 2069 7320 706f  ilb): This is po
+0002a180: 7465 6e74 6961 6c6c 7920 7269 736b 7920  tentially risky 
+0002a190: 2d20 6966 2074 6865 2064 656c 6574 6520  - if the delete 
+0002a1a0: 6d65 7468 6f64 2068 6173 0a20 2020 2020  method has.     
+0002a1b0: 2020 2020 2020 2023 2020 2062 7567 732c         #   bugs,
+0002a1c0: 2074 6869 7320 6361 6e20 6361 7573 6520   this can cause 
+0002a1d0: 7265 736f 7572 6365 206c 6561 6b73 2e20  resource leaks. 
+0002a1e0: 4964 6561 6c6c 7920 7765 2073 686f 756c  Ideally we shoul
+0002a1f0: 6420 6d61 6e75 616c 6c79 0a20 2020 2020  d manually.     
+0002a200: 2020 2020 2020 2023 2020 2065 6a65 6374         #   eject
+0002a210: 2073 746f 7261 6765 2066 726f 6d20 676c   storage from gl
+0002a220: 6f62 616c 5f75 7365 725f 7374 6174 6520  obal_user_state 
+0002a230: 616e 6420 6465 6c65 7465 2074 6865 2062  and delete the b
+0002a240: 7563 6b65 7420 7573 696e 670a 2020 2020  ucket using.    
+0002a250: 2020 2020 2020 2020 2320 2020 626f 746f          #   boto
+0002a260: 3320 6469 7265 6374 6c79 2e0a 2020 2020  3 directly..    
+0002a270: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002a280: 6f62 6a2e 6465 6c65 7465 2829 0a0a 2020  obj.delete()..  
+0002a290: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+0002a2a0: 650a 2020 2020 6465 6620 746d 705f 7363  e.    def tmp_sc
+0002a2b0: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
+0002a2c0: 6a28 7365 6c66 2c20 746d 705f 6275 636b  j(self, tmp_buck
+0002a2d0: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
+0002a2e0: 2020 2320 4372 6561 7465 7320 6120 7374    # Creates a st
+0002a2f0: 6f72 6167 6520 6f62 6a65 6374 2077 6974  orage object wit
+0002a300: 6820 6e6f 2073 6f75 7263 6520 746f 2063  h no source to c
+0002a310: 7265 6174 6520 6120 7363 7261 7463 6820  reate a scratch 
+0002a320: 7374 6f72 6167 652e 0a20 2020 2020 2020  storage..       
+0002a330: 2023 2053 746f 7265 7320 6d75 7374 2062   # Stores must b
+0002a340: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
+0002a350: 6573 742e 0a20 2020 2020 2020 2079 6965  est..        yie
+0002a360: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
+0002a370: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
+0002a380: 7428 6e61 6d65 3d74 6d70 5f62 7563 6b65  t(name=tmp_bucke
+0002a390: 745f 6e61 6d65 290a 0a20 2020 2040 7079  t_name)..    @py
+0002a3a0: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
+0002a3b0: 2064 6566 2074 6d70 5f6d 756c 7469 706c   def tmp_multipl
+0002a3c0: 655f 7363 7261 7463 685f 7374 6f72 6167  e_scratch_storag
+0002a3d0: 655f 6f62 6a28 7365 6c66 293a 0a20 2020  e_obj(self):.   
+0002a3e0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0002a3f0: 206c 6973 7420 6f66 2035 2073 746f 7261   list of 5 stora
+0002a400: 6765 206f 626a 6563 7473 2077 6974 6820  ge objects with 
+0002a410: 6e6f 2073 6f75 7263 6520 746f 2063 7265  no source to cre
+0002a420: 6174 650a 2020 2020 2020 2020 2320 6d75  ate.        # mu
+0002a430: 6c74 6970 6c65 2073 6372 6174 6368 2073  ltiple scratch s
+0002a440: 746f 7261 6765 732e 0a20 2020 2020 2020  torages..       
+0002a450: 2023 2053 746f 7265 7320 666f 7220 6561   # Stores for ea
+0002a460: 6368 206f 626a 6563 7420 696e 2074 6865  ch object in the
+0002a470: 206c 6973 7420 6d75 7374 2062 6520 6164   list must be ad
+0002a480: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
+0002a490: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002a4a0: 5f6d 756c 745f 6f62 6a20 3d20 5b5d 0a20  _mult_obj = []. 
+0002a4b0: 2020 2020 2020 2066 6f72 205f 2069 6e20         for _ in 
+0002a4c0: 7261 6e67 6528 3529 3a0a 2020 2020 2020  range(5):.      
+0002a4d0: 2020 2020 2020 7469 6d65 7374 616d 7020        timestamp 
+0002a4e0: 3d20 7374 7228 7469 6d65 2e74 696d 6528  = str(time.time(
+0002a4f0: 2929 2e72 6570 6c61 6365 2827 2e27 2c20  )).replace('.', 
+0002a500: 2727 290a 2020 2020 2020 2020 2020 2020  '').            
+0002a510: 7374 6f72 655f 6f62 6a20 3d20 7374 6f72  store_obj = stor
+0002a520: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+0002a530: 6e61 6d65 3d66 2773 6b79 2d74 6573 742d  name=f'sky-test-
+0002a540: 7b74 696d 6573 7461 6d70 7d27 290a 2020  {timestamp}').  
+0002a550: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002a560: 655f 6d75 6c74 5f6f 626a 2e61 7070 656e  e_mult_obj.appen
+0002a570: 6428 7374 6f72 655f 6f62 6a29 0a20 2020  d(store_obj).   
+0002a580: 2020 2020 2079 6965 6c64 2073 746f 7261       yield stora
+0002a590: 6765 5f6d 756c 745f 6f62 6a0a 2020 2020  ge_mult_obj.    
+0002a5a0: 2020 2020 666f 7220 7374 6f72 6167 655f      for storage_
+0002a5b0: 6f62 6a20 696e 2073 746f 7261 6765 5f6d  obj in storage_m
+0002a5c0: 756c 745f 6f62 6a3a 0a20 2020 2020 2020  ult_obj:.       
+0002a5d0: 2020 2020 2068 616e 646c 6520 3d20 676c       handle = gl
+0002a5e0: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+0002a5f0: 6765 745f 6861 6e64 6c65 5f66 726f 6d5f  get_handle_from_
+0002a600: 7374 6f72 6167 655f 6e61 6d65 280a 2020  storage_name(.  
+0002a610: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002a620: 6f72 6167 655f 6f62 6a2e 6e61 6d65 290a  orage_obj.name).
+0002a630: 2020 2020 2020 2020 2020 2020 6966 2068              if h
+0002a640: 616e 646c 653a 0a20 2020 2020 2020 2020  andle:.         
+0002a650: 2020 2020 2020 2023 2049 6620 6861 6e64         # If hand
+0002a660: 6c65 2065 7869 7374 732c 2064 656c 6574  le exists, delet
+0002a670: 6520 6d61 6e75 616c 6c79 0a20 2020 2020  e manually.     
+0002a680: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+0002a690: 4f28 726f 6d69 6c62 293a 2054 6869 7320  O(romilb): This 
+0002a6a0: 6973 2070 6f74 656e 7469 616c 6c79 2072  is potentially r
+0002a6b0: 6973 6b79 202d 2069 6620 7468 6520 6465  isky - if the de
+0002a6c0: 6c65 7465 206d 6574 686f 6420 6861 730a  lete method has.
+0002a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6e0: 2320 6275 6773 2c20 7468 6973 2063 616e  # bugs, this can
+0002a6f0: 2063 6175 7365 2072 6573 6f75 7263 6520   cause resource 
+0002a700: 6c65 616b 732e 2049 6465 616c 6c79 2077  leaks. Ideally w
+0002a710: 6520 7368 6f75 6c64 206d 616e 7561 6c6c  e should manuall
+0002a720: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+0002a730: 2020 2320 656a 6563 7420 7374 6f72 6167    # eject storag
+0002a740: 6520 6672 6f6d 2067 6c6f 6261 6c5f 7573  e from global_us
+0002a750: 6572 5f73 7461 7465 2061 6e64 2064 656c  er_state and del
+0002a760: 6574 6520 7468 6520 6275 636b 6574 2075  ete the bucket u
+0002a770: 7369 6e67 0a20 2020 2020 2020 2020 2020  sing.           
+0002a780: 2020 2020 2023 2062 6f74 6f33 2064 6972       # boto3 dir
+0002a790: 6563 746c 792e 0a20 2020 2020 2020 2020  ectly..         
+0002a7a0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0002a7b0: 626a 2e64 656c 6574 6528 290a 0a20 2020  bj.delete()..   
+0002a7c0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002a7d0: 0a20 2020 2064 6566 2074 6d70 5f6d 756c  .    def tmp_mul
+0002a7e0: 7469 706c 655f 6375 7374 6f6d 5f73 6f75  tiple_custom_sou
+0002a7f0: 7263 655f 7374 6f72 6167 655f 6f62 6a28  rce_storage_obj(
+0002a800: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
+0002a810: 2043 7265 6174 6573 2061 206c 6973 7420   Creates a list 
+0002a820: 6f66 2073 746f 7261 6765 206f 626a 6563  of storage objec
+0002a830: 7473 2077 6974 6820 6375 7374 6f6d 2073  ts with custom s
+0002a840: 6f75 7263 6520 6e61 6d65 7320 746f 0a20  ource names to. 
+0002a850: 2020 2020 2020 2023 2063 7265 6174 6520         # create 
+0002a860: 6d75 6c74 6970 6c65 2073 6372 6174 6368  multiple scratch
+0002a870: 2073 746f 7261 6765 732e 0a20 2020 2020   storages..     
+0002a880: 2020 2023 2053 746f 7265 7320 666f 7220     # Stores for 
+0002a890: 6561 6368 206f 626a 6563 7420 696e 2074  each object in t
+0002a8a0: 6865 206c 6973 7420 6d75 7374 2062 6520  he list must be 
+0002a8b0: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002a8c0: 742e 0a20 2020 2020 2020 2063 7573 746f  t..        custo
+0002a8d0: 6d5f 736f 7572 6365 5f6e 616d 6573 203d  m_source_names =
+0002a8e0: 205b 2722 7061 7468 2057 6974 6820 5370   ['"path With Sp
+0002a8f0: 6163 6573 2227 2c20 2770 6174 6820 5769  aces"', 'path Wi
+0002a900: 7468 2053 7061 6365 7327 5d0a 2020 2020  th Spaces'].    
+0002a910: 2020 2020 7374 6f72 6167 655f 6d75 6c74      storage_mult
+0002a920: 5f6f 626a 203d 205b 5d0a 2020 2020 2020  _obj = [].      
+0002a930: 2020 666f 7220 6e61 6d65 2069 6e20 6375    for name in cu
+0002a940: 7374 6f6d 5f73 6f75 7263 655f 6e61 6d65  stom_source_name
+0002a950: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+0002a960: 7263 5f70 6174 6820 3d20 6f73 2e70 6174  rc_path = os.pat
+0002a970: 682e 6578 7061 6e64 7573 6572 2866 277e  h.expanduser(f'~
+0002a980: 2f7b 6e61 6d65 7d27 290a 2020 2020 2020  /{name}').      
+0002a990: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
+0002a9a0: 7468 2873 7263 5f70 6174 6829 2e65 7870  th(src_path).exp
+0002a9b0: 616e 6475 7365 7228 292e 6d6b 6469 7228  anduser().mkdir(
+0002a9c0: 6578 6973 745f 6f6b 3d54 7275 6529 0a20  exist_ok=True). 
+0002a9d0: 2020 2020 2020 2020 2020 2074 696d 6573             times
+0002a9e0: 7461 6d70 203d 2073 7472 2874 696d 652e  tamp = str(time.
+0002a9f0: 7469 6d65 2829 292e 7265 706c 6163 6528  time()).replace(
+0002aa00: 272e 272c 2027 2729 0a20 2020 2020 2020  '.', '').       
+0002aa10: 2020 2020 2073 746f 7265 5f6f 626a 203d       store_obj =
+0002aa20: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002aa30: 7261 6765 286e 616d 653d 6627 736b 792d  rage(name=f'sky-
+0002aa40: 7465 7374 2d7b 7469 6d65 7374 616d 707d  test-{timestamp}
+0002aa50: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aa70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002aa80: 6f75 7263 653d 7372 635f 7061 7468 290a  ource=src_path).
+0002aa90: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002aaa0: 6167 655f 6d75 6c74 5f6f 626a 2e61 7070  age_mult_obj.app
+0002aab0: 656e 6428 7374 6f72 655f 6f62 6a29 0a20  end(store_obj). 
+0002aac0: 2020 2020 2020 2079 6965 6c64 2073 746f         yield sto
+0002aad0: 7261 6765 5f6d 756c 745f 6f62 6a0a 2020  rage_mult_obj.  
+0002aae0: 2020 2020 2020 666f 7220 7374 6f72 6167        for storag
+0002aaf0: 655f 6f62 6a20 696e 2073 746f 7261 6765  e_obj in storage
+0002ab00: 5f6d 756c 745f 6f62 6a3a 0a20 2020 2020  _mult_obj:.     
+0002ab10: 2020 2020 2020 2068 616e 646c 6520 3d20         handle = 
+0002ab20: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
+0002ab30: 652e 6765 745f 6861 6e64 6c65 5f66 726f  e.get_handle_fro
+0002ab40: 6d5f 7374 6f72 6167 655f 6e61 6d65 280a  m_storage_name(.
+0002ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab60: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002ab70: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0002ab80: 2068 616e 646c 653a 0a20 2020 2020 2020   handle:.       
+0002ab90: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+0002aba0: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
+0002abb0: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0002abc0: 7265 0a20 2020 2064 6566 2074 6d70 5f6c  re.    def tmp_l
+0002abd0: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
+0002abe0: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
+0002abf0: 745f 6e61 6d65 2c20 746d 705f 736f 7572  t_name, tmp_sour
+0002ac00: 6365 293a 0a20 2020 2020 2020 2023 2043  ce):.        # C
+0002ac10: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
+0002ac20: 7279 2073 746f 7261 6765 206f 626a 6563  ry storage objec
+0002ac30: 742e 2053 746f 7265 7320 6d75 7374 2062  t. Stores must b
+0002ac40: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
+0002ac50: 6573 742e 0a20 2020 2020 2020 2079 6965  est..        yie
+0002ac60: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
+0002ac70: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
+0002ac80: 7428 6e61 6d65 3d74 6d70 5f62 7563 6b65  t(name=tmp_bucke
+0002ac90: 745f 6e61 6d65 2c0a 2020 2020 2020 2020  t_name,.        
+0002aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002acc0: 2020 2020 2073 6f75 7263 653d 746d 705f       source=tmp_
+0002acd0: 736f 7572 6365 290a 0a20 2020 2040 7079  source)..    @py
+0002ace0: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
+0002acf0: 2064 6566 2074 6d70 5f6c 6f63 616c 5f6c   def tmp_local_l
+0002ad00: 6973 745f 7374 6f72 6167 655f 6f62 6a28  ist_storage_obj(
+0002ad10: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
+0002ad20: 5f6e 616d 652c 2074 6d70 5f73 6f75 7263  _name, tmp_sourc
+0002ad30: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+0002ad40: 6561 7465 7320 6120 7465 6d70 2073 746f  eates a temp sto
+0002ad50: 7261 6765 206f 626a 6563 7420 7768 6963  rage object whic
+0002ad60: 6820 7573 6573 2061 206c 6973 7420 6f66  h uses a list of
+0002ad70: 2070 6174 6873 2061 7320 736f 7572 6365   paths as source
+0002ad80: 2e0a 2020 2020 2020 2020 2320 5374 6f72  ..        # Stor
+0002ad90: 6573 206d 7573 7420 6265 2061 6464 6564  es must be added
+0002ada0: 2069 6e20 7468 6520 7465 7374 2e20 4166   in the test. Af
+0002adb0: 7465 7220 7570 6c6f 6164 2c20 7468 6520  ter upload, the 
+0002adc0: 6275 636b 6574 2073 686f 756c 640a 2020  bucket should.  
+0002add0: 2020 2020 2020 2320 6861 7665 2074 776f        # have two
+0002ade0: 2066 696c 6573 202d 202f 746d 702d 6669   files - /tmp-fi
+0002adf0: 6c65 2061 6e64 202f 746d 702d 736f 7572  le and /tmp-sour
+0002ae00: 6365 2f74 6d70 2d66 696c 650a 2020 2020  ce/tmp-file.    
+0002ae10: 2020 2020 6c69 7374 5f73 6f75 7263 6520      list_source 
+0002ae20: 3d20 5b74 6d70 5f73 6f75 7263 652c 2074  = [tmp_source, t
+0002ae30: 6d70 5f73 6f75 7263 6520 2b20 272f 746d  mp_source + '/tm
+0002ae40: 702d 6669 6c65 275d 0a20 2020 2020 2020  p-file'].       
+0002ae50: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
+0002ae60: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
+0002ae70: 626a 6563 7428 6e61 6d65 3d74 6d70 5f62  bject(name=tmp_b
+0002ae80: 7563 6b65 745f 6e61 6d65 2c0a 2020 2020  ucket_name,.    
+0002ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aeb0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0002aec0: 6c69 7374 5f73 6f75 7263 6529 0a0a 2020  list_source)..  
+0002aed0: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+0002aee0: 650a 2020 2020 6465 6620 746d 705f 6275  e.    def tmp_bu
+0002aef0: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
+0002af00: 626a 2873 656c 662c 2074 6d70 5f62 7563  bj(self, tmp_buc
+0002af10: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
+0002af20: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
+0002af30: 656d 706f 7261 7279 2073 746f 7261 6765  emporary storage
+0002af40: 206f 626a 6563 7420 666f 7220 7465 7374   object for test
+0002af50: 696e 6720 6275 6c6b 2064 656c 6574 696f  ing bulk deletio
+0002af60: 6e2e 0a20 2020 2020 2020 2023 2053 746f  n..        # Sto
+0002af70: 7265 7320 6d75 7374 2062 6520 6164 6465  res must be adde
+0002af80: 6420 696e 2074 6865 2074 6573 742e 0a20  d in the test.. 
+0002af90: 2020 2020 2020 2077 6974 6820 7465 6d70         with temp
+0002afa0: 6669 6c65 2e54 656d 706f 7261 7279 4469  file.TemporaryDi
+0002afb0: 7265 6374 6f72 7928 2920 6173 2074 6d70  rectory() as tmp
+0002afc0: 6469 723a 0a20 2020 2020 2020 2020 2020  dir:.           
+0002afd0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002afe0: 6b5f 6f75 7470 7574 2866 276d 6b64 6972  k_output(f'mkdir
+0002aff0: 202d 7020 7b74 6d70 6469 727d 2f66 6f6c   -p {tmpdir}/fol
+0002b000: 6465 727b 7b30 3030 2e2e 3235 357d 7d27  der{{000..255}}'
+0002b010: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b030: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
+0002b040: 290a 2020 2020 2020 2020 2020 2020 7375  ).            su
+0002b050: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+0002b060: 7574 7075 7428 6627 746f 7563 6820 7b74  utput(f'touch {t
+0002b070: 6d70 6469 727d 2f74 6573 747b 7b30 3030  mpdir}/test{{000
+0002b080: 2e2e 3235 357d 7d2e 7478 7427 2c0a 2020  ..255}}.txt',.  
+0002b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0b0: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
+0002b0c0: 2020 2020 2020 2020 2020 7375 6270 726f            subpro
+0002b0d0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0002b0e0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0002b0f0: 2020 2066 2774 6f75 6368 207b 746d 7064     f'touch {tmpd
+0002b100: 6972 7d2f 666f 6c64 6572 7b7b 3030 302e  ir}/folder{{000.
+0002b110: 2e32 3535 7d7d 2f74 6573 742e 7478 7427  .255}}/test.txt'
+0002b120: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
+0002b130: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+0002b140: 6672 6f6d 2073 656c 662e 7969 656c 645f  from self.yield_
+0002b150: 7374 6f72 6167 655f 6f62 6a65 6374 286e  storage_object(n
+0002b160: 616d 653d 746d 705f 6275 636b 6574 5f6e  ame=tmp_bucket_n
+0002b170: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0002b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1a0: 2020 2020 2020 736f 7572 6365 3d74 6d70        source=tmp
+0002b1b0: 6469 7229 0a0a 2020 2020 4070 7974 6573  dir)..    @pytes
+0002b1c0: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002b1d0: 6620 746d 705f 636f 7079 5f6d 6e74 5f65  f tmp_copy_mnt_e
+0002b1e0: 7869 7374 696e 675f 7374 6f72 6167 655f  xisting_storage_
+0002b1f0: 6f62 6a28 7365 6c66 2c20 746d 705f 7363  obj(self, tmp_sc
+0002b200: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
+0002b210: 6a29 3a0a 2020 2020 2020 2020 2320 4372  j):.        # Cr
+0002b220: 6561 7465 7320 6120 636f 7079 206d 6f75  eates a copy mou
+0002b230: 6e74 2073 746f 7261 6765 2077 6869 6368  nt storage which
+0002b240: 2072 6575 7365 7320 616e 2065 7869 7374   reuses an exist
+0002b250: 696e 6720 7374 6f72 6167 6520 6f62 6a65  ing storage obje
+0002b260: 6374 2e0a 2020 2020 2020 2020 746d 705f  ct..        tmp_
+0002b270: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
+0002b280: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0002b290: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002b2a0: 7970 652e 5333 290a 2020 2020 2020 2020  ype.S3).        
+0002b2b0: 7374 6f72 6167 655f 6e61 6d65 203d 2074  storage_name = t
+0002b2c0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002b2d0: 6765 5f6f 626a 2e6e 616d 650a 0a20 2020  ge_obj.name..   
+0002b2e0: 2020 2020 2023 2054 7279 2074 6f20 696e       # Try to in
+0002b2f0: 6974 6961 6c69 7a65 2061 6e6f 7468 6572  itialize another
+0002b300: 2073 746f 7261 6765 2077 6974 6820 7468   storage with th
+0002b310: 6520 7374 6f72 6167 6520 6f62 6a65 6374  e storage object
+0002b320: 2063 7265 6174 6564 0a20 2020 2020 2020   created.       
+0002b330: 2023 2061 626f 7665 2c20 6275 7420 6e6f   # above, but no
+0002b340: 7720 696e 2043 4f50 5920 6d6f 6465 2e20  w in COPY mode. 
+0002b350: 5468 6973 2073 686f 756c 6420 7375 6363  This should succ
+0002b360: 6565 642e 0a20 2020 2020 2020 2079 6965  eed..        yie
+0002b370: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
+0002b380: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
+0002b390: 7428 6e61 6d65 3d73 746f 7261 6765 5f6e  t(name=storage_n
+0002b3a0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0002b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3d0: 2020 6d6f 6465 3d73 746f 7261 6765 5f6c    mode=storage_l
+0002b3e0: 6962 2e53 746f 7261 6765 4d6f 6465 2e43  ib.StorageMode.C
+0002b3f0: 4f50 5929 0a0a 2020 2020 4070 7974 6573  OPY)..    @pytes
+0002b400: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002b410: 6620 746d 705f 6769 7469 676e 6f72 655f  f tmp_gitignore_
+0002b420: 7374 6f72 6167 655f 6f62 6a28 7365 6c66  storage_obj(self
+0002b430: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
+0002b440: 652c 2067 6974 6967 6e6f 7265 5f73 7472  e, gitignore_str
+0002b450: 7563 7475 7265 293a 0a20 2020 2020 2020  ucture):.       
+0002b460: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0002b470: 706f 7261 7279 2073 746f 7261 6765 206f  porary storage o
+0002b480: 626a 6563 7420 666f 7220 7465 7374 696e  bject for testin
+0002b490: 6720 2e67 6974 6967 6e6f 7265 2066 696c  g .gitignore fil
+0002b4a0: 7465 722e 0a20 2020 2020 2020 2023 2047  ter..        # G
+0002b4b0: 4954 4947 494e 4f52 455f 5354 5255 4354  ITIGINORE_STRUCT
+0002b4c0: 5552 4520 6973 2072 6570 7265 7365 6e74  URE is represent
+0002b4d0: 696e 6720 6120 6669 6c65 2073 7472 7563  ing a file struc
+0002b4e0: 7475 7265 2069 6e20 6120 6469 6374 696f  ture in a dictio
+0002b4f0: 6e61 7279 0a20 2020 2020 2020 2023 2066  nary.        # f
+0002b500: 6f72 6d61 742e 2043 7265 6174 6564 2073  ormat. Created s
+0002b510: 746f 7261 6765 206f 626a 6563 7420 7769  torage object wi
+0002b520: 6c6c 2063 6f6e 7461 696e 2074 6865 2066  ll contain the f
+0002b530: 696c 6520 7374 7275 6374 7572 6520 616c  ile structure al
+0002b540: 6f6e 670a 2020 2020 2020 2020 2320 7769  ong.        # wi
+0002b550: 7468 202e 6769 7469 676e 6f72 6520 616e  th .gitignore an
+0002b560: 6420 2e67 6974 2f69 6e66 6f2f 6578 636c  d .git/info/excl
+0002b570: 7564 6520 6669 6c65 7320 746f 2074 6573  ude files to tes
+0002b580: 7420 6578 636c 7564 6520 6669 6c74 6572  t exclude filter
+0002b590: 2e0a 2020 2020 2020 2020 2320 5374 6f72  ..        # Stor
+0002b5a0: 6573 206d 7573 7420 6265 2061 6464 6564  es must be added
+0002b5b0: 2069 6e20 7468 6520 7465 7374 2e0a 2020   in the test..  
+0002b5c0: 2020 2020 2020 7769 7468 2074 656d 7066        with tempf
+0002b5d0: 696c 652e 5465 6d70 6f72 6172 7944 6972  ile.TemporaryDir
+0002b5e0: 6563 746f 7279 2829 2061 7320 746d 7064  ectory() as tmpd
+0002b5f0: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
+0002b600: 2320 4372 6561 7465 7320 6669 6c65 2073  # Creates file s
+0002b610: 7472 7563 7475 7265 2074 6f20 6265 2075  tructure to be u
+0002b620: 706c 6f61 6465 6420 696e 2074 6865 2053  ploaded in the S
+0002b630: 746f 7261 6765 0a20 2020 2020 2020 2020  torage.         
+0002b640: 2020 2073 656c 662e 6372 6561 7465 5f64     self.create_d
+0002b650: 6972 5f73 7472 7563 7475 7265 2874 6d70  ir_structure(tmp
+0002b660: 6469 722c 2067 6974 6967 6e6f 7265 5f73  dir, gitignore_s
+0002b670: 7472 7563 7475 7265 290a 0a20 2020 2020  tructure)..     
+0002b680: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
+0002b690: 2e67 6974 6967 6e6f 7265 2061 6e64 206c  .gitignore and l
+0002b6a0: 6973 7420 6669 6c65 732f 6469 7273 2074  ist files/dirs t
+0002b6b0: 6f20 6265 2065 7863 6c75 6465 6420 696e  o be excluded in
+0002b6c0: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
+0002b6d0: 736b 7970 696c 6f74 5f70 6174 6820 3d20  skypilot_path = 
+0002b6e0: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
+0002b6f0: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
+0002b700: 736b 792e 5f5f 6669 6c65 5f5f 2929 0a20  sky.__file__)). 
+0002b710: 2020 2020 2020 2020 2020 2074 656d 705f             temp_
+0002b720: 7061 7468 203d 2066 277b 746d 7064 6972  path = f'{tmpdir
+0002b730: 7d2f 2e67 6974 6967 6e6f 7265 270a 2020  }/.gitignore'.  
+0002b740: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
+0002b750: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
+0002b760: 696e 2873 6b79 7069 6c6f 745f 7061 7468  in(skypilot_path
+0002b770: 2c20 2774 6573 7473 2f67 6974 6967 6e6f  , 'tests/gitigno
+0002b780: 7265 5f74 6573 7427 290a 2020 2020 2020  re_test').      
+0002b790: 2020 2020 2020 7368 7574 696c 2e63 6f70        shutil.cop
+0002b7a0: 7966 696c 6528 6669 6c65 5f70 6174 682c  yfile(file_path,
+0002b7b0: 2074 656d 705f 7061 7468 290a 0a20 2020   temp_path)..   
+0002b7c0: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
+0002b7d0: 6520 2e67 6974 2f69 6e66 6f2f 6578 636c  e .git/info/excl
+0002b7e0: 7564 6520 616e 6420 6c69 7374 2066 696c  ude and list fil
+0002b7f0: 6573 2f64 6972 7320 746f 2062 6520 6578  es/dirs to be ex
+0002b800: 636c 7564 6564 2069 6e20 6974 0a20 2020  cluded in it.   
+0002b810: 2020 2020 2020 2020 2074 656d 705f 7061           temp_pa
+0002b820: 7468 203d 2066 277b 746d 7064 6972 7d2f  th = f'{tmpdir}/
+0002b830: 2e67 6974 2f69 6e66 6f2f 270a 2020 2020  .git/info/'.    
+0002b840: 2020 2020 2020 2020 6f73 2e6d 616b 6564          os.maked
+0002b850: 6972 7328 7465 6d70 5f70 6174 6829 0a20  irs(temp_path). 
+0002b860: 2020 2020 2020 2020 2020 2074 656d 705f             temp_
+0002b870: 6578 636c 7564 655f 7061 7468 203d 206f  exclude_path = o
+0002b880: 732e 7061 7468 2e6a 6f69 6e28 7465 6d70  s.path.join(temp
+0002b890: 5f70 6174 682c 2027 6578 636c 7564 6527  _path, 'exclude'
+0002b8a0: 290a 2020 2020 2020 2020 2020 2020 6669  ).            fi
+0002b8b0: 6c65 5f70 6174 6820 3d20 6f73 2e70 6174  le_path = os.pat
+0002b8c0: 682e 6a6f 696e 2873 6b79 7069 6c6f 745f  h.join(skypilot_
+0002b8d0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
+0002b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b8f0: 2020 2020 2020 2020 2020 2027 7465 7374             'test
+0002b900: 732f 6769 745f 696e 666f 5f65 7863 6c75  s/git_info_exclu
+0002b910: 6465 5f74 6573 7427 290a 2020 2020 2020  de_test').      
+0002b920: 2020 2020 2020 7368 7574 696c 2e63 6f70        shutil.cop
+0002b930: 7966 696c 6528 6669 6c65 5f70 6174 682c  yfile(file_path,
+0002b940: 2074 656d 705f 6578 636c 7564 655f 7061   temp_exclude_pa
+0002b950: 7468 290a 0a20 2020 2020 2020 2020 2020  th)..           
+0002b960: 2023 2043 7265 6174 6520 736b 7920 5374   # Create sky St
+0002b970: 6f72 6167 6520 7769 7468 2074 6865 2066  orage with the f
+0002b980: 696c 6573 2063 7265 6174 6564 0a20 2020  iles created.   
+0002b990: 2020 2020 2020 2020 2079 6965 6c64 2066           yield f
+0002b9a0: 726f 6d20 7365 6c66 2e79 6965 6c64 5f73  rom self.yield_s
+0002b9b0: 746f 7261 6765 5f6f 626a 6563 7428 0a20  torage_object(. 
+0002b9c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0002b9d0: 616d 653d 746d 705f 6275 636b 6574 5f6e  ame=tmp_bucket_n
+0002b9e0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+0002b9f0: 2020 2020 2073 6f75 7263 653d 746d 7064       source=tmpd
+0002ba00: 6972 2c0a 2020 2020 2020 2020 2020 2020  ir,.            
+0002ba10: 2020 2020 6d6f 6465 3d73 746f 7261 6765      mode=storage
+0002ba20: 5f6c 6962 2e53 746f 7261 6765 4d6f 6465  _lib.StorageMode
+0002ba30: 2e43 4f50 5929 0a0a 2020 2020 4070 7974  .COPY)..    @pyt
+0002ba40: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002ba50: 6465 6620 746d 705f 6177 7363 6c69 5f62  def tmp_awscli_b
+0002ba60: 7563 6b65 7428 7365 6c66 2c20 746d 705f  ucket(self, tmp_
+0002ba70: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
+0002ba80: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002ba90: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
+0002baa0: 6574 2075 7369 6e67 2061 7773 636c 690a  et using awscli.
+0002bab0: 2020 2020 2020 2020 6275 636b 6574 5f75          bucket_u
+0002bac0: 7269 203d 2066 2773 333a 2f2f 7b74 6d70  ri = f's3://{tmp
+0002bad0: 5f62 7563 6b65 745f 6e61 6d65 7d27 0a20  _bucket_name}'. 
+0002bae0: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0002baf0: 732e 6368 6563 6b5f 6361 6c6c 285b 2761  s.check_call(['a
+0002bb00: 7773 272c 2027 7333 272c 2027 6d62 272c  ws', 's3', 'mb',
+0002bb10: 2062 7563 6b65 745f 7572 695d 290a 2020   bucket_uri]).  
+0002bb20: 2020 2020 2020 7969 656c 6420 746d 705f        yield tmp_
+0002bb30: 6275 636b 6574 5f6e 616d 652c 2062 7563  bucket_name, buc
+0002bb40: 6b65 745f 7572 690a 2020 2020 2020 2020  ket_uri.        
+0002bb50: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002bb60: 5f63 616c 6c28 5b27 6177 7327 2c20 2773  _call(['aws', 's
+0002bb70: 3327 2c20 2772 6227 2c20 6275 636b 6574  3', 'rb', bucket
+0002bb80: 5f75 7269 2c20 272d 2d66 6f72 6365 275d  _uri, '--force']
+0002bb90: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0002bba0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002bbb0: 6d70 5f67 7375 7469 6c5f 6275 636b 6574  mp_gsutil_bucket
+0002bbc0: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
+0002bbd0: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
+0002bbe0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0002bbf0: 706f 7261 7279 2062 7563 6b65 7420 7573  porary bucket us
+0002bc00: 696e 6720 6773 7574 696c 0a20 2020 2020  ing gsutil.     
+0002bc10: 2020 2062 7563 6b65 745f 7572 6920 3d20     bucket_uri = 
+0002bc20: 6627 6773 3a2f 2f7b 746d 705f 6275 636b  f'gs://{tmp_buck
+0002bc30: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
+0002bc40: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0002bc50: 636b 5f63 616c 6c28 5b27 6773 7574 696c  ck_call(['gsutil
+0002bc60: 272c 2027 6d62 272c 2062 7563 6b65 745f  ', 'mb', bucket_
+0002bc70: 7572 695d 290a 2020 2020 2020 2020 7969  uri]).        yi
+0002bc80: 656c 6420 746d 705f 6275 636b 6574 5f6e  eld tmp_bucket_n
+0002bc90: 616d 652c 2062 7563 6b65 745f 7572 690a  ame, bucket_uri.
+0002bca0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
+0002bcb0: 7373 2e63 6865 636b 5f63 616c 6c28 5b27  ss.check_call(['
+0002bcc0: 6773 7574 696c 272c 2027 726d 272c 2027  gsutil', 'rm', '
+0002bcd0: 2d72 272c 2062 7563 6b65 745f 7572 695d  -r', bucket_uri]
+0002bce0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0002bcf0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002bd00: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+0002bd10: 5f72 3228 7365 6c66 2c20 746d 705f 6275  _r2(self, tmp_bu
+0002bd20: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
+0002bd30: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
+0002bd40: 7465 6d70 6f72 6172 7920 6275 636b 6574  temporary bucket
+0002bd50: 2075 7369 6e67 2061 7773 636c 690a 2020   using awscli.  
+0002bd60: 2020 2020 2020 656e 6470 6f69 6e74 5f75        endpoint_u
+0002bd70: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
+0002bd80: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
+0002bd90: 290a 2020 2020 2020 2020 6275 636b 6574  ).        bucket
+0002bda0: 5f75 7269 203d 2066 2773 333a 2f2f 7b74  _uri = f's3://{t
+0002bdb0: 6d70 5f62 7563 6b65 745f 6e61 6d65 7d27  mp_bucket_name}'
+0002bdc0: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
+0002bdd0: 6573 732e 6368 6563 6b5f 6361 6c6c 280a  ess.check_call(.
+0002bde0: 2020 2020 2020 2020 2020 2020 6627 4157              f'AW
+0002bdf0: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
+0002be00: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
+0002be10: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
+0002be20: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
+0002be30: 3320 6d62 207b 6275 636b 6574 5f75 7269  3 mb {bucket_uri
+0002be40: 7d20 2d2d 656e 6470 6f69 6e74 207b 656e  } --endpoint {en
+0002be50: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+0002be60: 6f66 696c 653d 7232 272c 0a20 2020 2020  ofile=r2',.     
+0002be70: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
+0002be80: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
+0002be90: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002bea0: 2c20 6275 636b 6574 5f75 7269 0a20 2020  , bucket_uri.   
+0002beb0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0002bec0: 6368 6563 6b5f 6361 6c6c 280a 2020 2020  check_call(.    
+0002bed0: 2020 2020 2020 2020 6627 4157 535f 5348          f'AWS_SH
+0002bee0: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
+0002bef0: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
+0002bf00: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
+0002bf10: 5f50 4154 487d 2061 7773 2073 3320 7262  _PATH} aws s3 rb
+0002bf20: 207b 6275 636b 6574 5f75 7269 7d20 2d2d   {bucket_uri} --
+0002bf30: 666f 7263 6520 2d2d 656e 6470 6f69 6e74  force --endpoint
+0002bf40: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
+0002bf50: 2d2d 7072 6f66 696c 653d 7232 272c 0a20  --profile=r2',. 
+0002bf60: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+0002bf70: 3d54 7275 6529 0a0a 2020 2020 4070 7974  =True)..    @pyt
+0002bf80: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002bf90: 6465 6620 746d 705f 6962 6d5f 636f 735f  def tmp_ibm_cos_
+0002bfa0: 6275 636b 6574 2873 656c 662c 2074 6d70  bucket(self, tmp
+0002bfb0: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
+0002bfc0: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0002bfd0: 2061 2074 656d 706f 7261 7279 2062 7563   a temporary buc
+0002bfe0: 6b65 7420 7573 696e 6720 4942 4d20 434f  ket using IBM CO
+0002bff0: 5320 4150 490a 2020 2020 2020 2020 7374  S API.        st
+0002c000: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+0002c010: 6167 655f 6c69 622e 4942 4d43 6f73 5374  age_lib.IBMCosSt
+0002c020: 6f72 6528 736f 7572 6365 3d22 222c 206e  ore(source="", n
+0002c030: 616d 653d 746d 705f 6275 636b 6574 5f6e  ame=tmp_bucket_n
+0002c040: 616d 6529 0a20 2020 2020 2020 2079 6965  ame).        yie
+0002c050: 6c64 2074 6d70 5f62 7563 6b65 745f 6e61  ld tmp_bucket_na
+0002c060: 6d65 0a20 2020 2020 2020 2073 746f 7261  me.        stora
+0002c070: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
+0002c080: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0002c090: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0002c0a0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
+0002c0b0: 6f62 6a28 7365 6c66 2c20 7265 7175 6573  obj(self, reques
+0002c0c0: 7429 3a0a 2020 2020 2020 2020 2320 496e  t):.        # In
+0002c0d0: 6974 6961 6c69 7a65 7320 6120 7374 6f72  itializes a stor
+0002c0e0: 6167 6520 6f62 6a65 6374 2077 6974 6820  age object with 
+0002c0f0: 6120 7075 626c 6963 2062 7563 6b65 740a  a public bucket.
+0002c100: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002c110: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
+0002c120: 622e 5374 6f72 6167 6528 736f 7572 6365  b.Storage(source
+0002c130: 3d72 6571 7565 7374 2e70 6172 616d 290a  =request.param).
+0002c140: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
+0002c150: 6f72 6167 655f 6f62 6a0a 2020 2020 2020  orage_obj.      
+0002c160: 2020 2320 5468 6973 2064 6f65 7320 6e6f    # This does no
+0002c170: 7420 7265 7175 6972 6520 616e 7920 6465  t require any de
+0002c180: 6c65 7469 6f6e 206c 6f67 6963 2062 6563  letion logic bec
+0002c190: 6175 7365 2069 7420 6973 2061 2070 7562  ause it is a pub
+0002c1a0: 6c69 6320 6275 636b 6574 0a20 2020 2020  lic bucket.     
+0002c1b0: 2020 2023 2061 6e64 2073 686f 756c 6420     # and should 
+0002c1c0: 6e6f 7420 6765 7420 6164 6465 6420 746f  not get added to
+0002c1d0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
+0002c1e0: 7465 2e0a 0a20 2020 2040 7079 7465 7374  te...    @pytest
+0002c1f0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+0002c200: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
+0002c210: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+0002c220: 2827 7374 6f72 655f 7479 7065 272c 205b  ('store_type', [
+0002c230: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002c240: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+0002c250: 332c 2073 746f 7261 6765 5f6c 6962 2e53  3, storage_lib.S
+0002c260: 746f 7265 5479 7065 2e47 4353 2c0a 2020  toreType.GCS,.  
+0002c270: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+0002c280: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
+0002c290: 746f 7265 5479 7065 2e49 424d 2c20 6d61  toreType.IBM, ma
+0002c2a0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+0002c2b0: 6962 6d29 2c0a 2020 2020 2020 2020 7079  ibm),.        py
+0002c2c0: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
+0002c2d0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002c2e0: 2e52 322c 206d 6172 6b73 3d70 7974 6573  .R2, marks=pytes
+0002c2f0: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+0002c300: 6529 0a20 2020 205d 290a 2020 2020 6465  e).    ]).    de
+0002c310: 6620 7465 7374 5f6e 6577 5f62 7563 6b65  f test_new_bucke
+0002c320: 745f 6372 6561 7469 6f6e 5f61 6e64 5f64  t_creation_and_d
+0002c330: 656c 6574 696f 6e28 7365 6c66 2c20 746d  eletion(self, tm
+0002c340: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
+0002c350: 6f62 6a2c 0a20 2020 2020 2020 2020 2020  obj,.           
+0002c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c380: 2020 2073 746f 7265 5f74 7970 6529 3a0a     store_type):.
+0002c390: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002c3a0: 7320 6120 6e65 7720 6275 636b 6574 2077  s a new bucket w
+0002c3b0: 6974 6820 6120 6c6f 6361 6c20 736f 7572  ith a local sour
+0002c3c0: 6365 2c20 7570 6c6f 6164 7320 6669 6c65  ce, uploads file
+0002c3d0: 7320 746f 2069 740a 2020 2020 2020 2020  s to it.        
+0002c3e0: 2320 616e 6420 6465 6c65 7465 7320 6974  # and deletes it
+0002c3f0: 2e0a 2020 2020 2020 2020 746d 705f 6c6f  ..        tmp_lo
+0002c400: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
+0002c410: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
+0002c420: 7479 7065 290a 0a20 2020 2020 2020 2023  type)..        #
+0002c430: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002c440: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002c450: 7374 6f72 6167 6520 6f62 6a65 6374 2065  storage object e
+0002c460: 7869 7374 7320 696e 2074 6865 206f 7574  xists in the out
+0002c470: 7075 740a 2020 2020 2020 2020 6f75 7420  put.        out 
+0002c480: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+0002c490: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
+0002c4a0: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
+0002c4b0: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
+0002c4c0: 7274 2074 6d70 5f6c 6f63 616c 5f73 746f  rt tmp_local_sto
+0002c4d0: 7261 6765 5f6f 626a 2e6e 616d 6520 696e  rage_obj.name in
+0002c4e0: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+0002c4f0: 2d38 2729 0a0a 2020 2020 2020 2020 2320  -8')..        # 
+0002c500: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
+0002c510: 6465 6c65 7465 2074 6f20 6465 6c65 7465  delete to delete
+0002c520: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
+0002c530: 6563 740a 2020 2020 2020 2020 7375 6270  ect.        subp
+0002c540: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002c550: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
+0002c560: 205b 2773 6b79 272c 2027 7374 6f72 6167   ['sky', 'storag
+0002c570: 6527 2c20 2764 656c 6574 6527 2c20 746d  e', 'delete', tm
+0002c580: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
+0002c590: 6f62 6a2e 6e61 6d65 2c20 272d 2d79 6573  obj.name, '--yes
+0002c5a0: 275d 290a 0a20 2020 2020 2020 2023 2052  '])..        # R
+0002c5b0: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
+0002c5c0: 7320 746f 2063 6865 636b 2069 6620 7374  s to check if st
+0002c5d0: 6f72 6167 6520 6f62 6a65 6374 2069 7320  orage object is 
+0002c5e0: 6465 6c65 7465 640a 2020 2020 2020 2020  deleted.        
+0002c5f0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+0002c600: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
+0002c610: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
+0002c620: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
+0002c630: 6173 7365 7274 2074 6d70 5f6c 6f63 616c  assert tmp_local
+0002c640: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0002c650: 6520 6e6f 7420 696e 206f 7574 2e64 6563  e not in out.dec
+0002c660: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
+0002c670: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
+0002c680: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
+0002c690: 2040 7079 7465 7374 2e6d 6172 6b2e 7864   @pytest.mark.xd
+0002c6a0: 6973 745f 6772 6f75 7028 276d 756c 7469  ist_group('multi
+0002c6b0: 706c 655f 6275 636b 6574 5f64 656c 6574  ple_bucket_delet
+0002c6c0: 696f 6e27 290a 2020 2020 4070 7974 6573  ion').    @pytes
+0002c6d0: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+0002c6e0: 7a65 2827 7374 6f72 655f 7479 7065 272c  ze('store_type',
+0002c6f0: 205b 0a20 2020 2020 2020 2073 746f 7261   [.        stora
+0002c700: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002c710: 2e53 332c 2073 746f 7261 6765 5f6c 6962  .S3, storage_lib
+0002c720: 2e53 746f 7265 5479 7065 2e47 4353 2c0a  .StoreType.GCS,.
+0002c730: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
+0002c740: 6172 616d 2873 746f 7261 6765 5f6c 6962  aram(storage_lib
+0002c750: 2e53 746f 7265 5479 7065 2e52 322c 206d  .StoreType.R2, m
+0002c760: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+0002c770: 2e63 6c6f 7564 666c 6172 6529 2c0a 2020  .cloudflare),.  
+0002c780: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+0002c790: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
+0002c7a0: 746f 7265 5479 7065 2e49 424d 2c20 6d61  toreType.IBM, ma
+0002c7b0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+0002c7c0: 6962 6d29 0a20 2020 205d 290a 2020 2020  ibm).    ]).    
+0002c7d0: 6465 6620 7465 7374 5f6d 756c 7469 706c  def test_multipl
+0002c7e0: 655f 6275 636b 6574 735f 6372 6561 7469  e_buckets_creati
+0002c7f0: 6f6e 5f61 6e64 5f64 656c 6574 696f 6e28  on_and_deletion(
+0002c800: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002c810: 662c 2074 6d70 5f6d 756c 7469 706c 655f  f, tmp_multiple_
+0002c820: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
+0002c830: 6f62 6a2c 2073 746f 7265 5f74 7970 6529  obj, store_type)
+0002c840: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002c850: 7465 7320 6d75 6c74 6970 6c65 206e 6577  tes multiple new
+0002c860: 2062 7563 6b65 7473 2835 2062 7563 6b65   buckets(5 bucke
+0002c870: 7473 2920 7769 7468 2061 206c 6f63 616c  ts) with a local
+0002c880: 2073 6f75 7263 650a 2020 2020 2020 2020   source.        
+0002c890: 2320 616e 6420 6465 6c65 7465 7320 7468  # and deletes th
+0002c8a0: 656d 2e0a 2020 2020 2020 2020 7374 6f72  em..        stor
+0002c8b0: 6167 655f 6f62 6a5f 6e61 6d65 203d 205b  age_obj_name = [
+0002c8c0: 5d0a 2020 2020 2020 2020 666f 7220 7374  ].        for st
+0002c8d0: 6f72 655f 6f62 6a20 696e 2074 6d70 5f6d  ore_obj in tmp_m
+0002c8e0: 756c 7469 706c 655f 7363 7261 7463 685f  ultiple_scratch_
+0002c8f0: 7374 6f72 6167 655f 6f62 6a3a 0a20 2020  storage_obj:.   
+0002c900: 2020 2020 2020 2020 2073 746f 7265 5f6f           store_o
+0002c910: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+0002c920: 7265 5f74 7970 6529 0a20 2020 2020 2020  re_type).       
+0002c930: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0002c940: 5f6e 616d 652e 6170 7065 6e64 2873 746f  _name.append(sto
+0002c950: 7265 5f6f 626a 2e6e 616d 6529 0a0a 2020  re_obj.name)..  
+0002c960: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
+0002c970: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
+0002c980: 6563 6b20 6966 2061 6c6c 2073 746f 7261  eck if all stora
+0002c990: 6765 206f 626a 6563 7473 2065 7869 7374  ge objects exist
+0002c9a0: 7320 696e 2074 6865 0a20 2020 2020 2020  s in the.       
+0002c9b0: 2023 206f 7574 7075 7420 6669 6c74 6572   # output filter
+0002c9c0: 6564 2062 7920 7374 6f72 6520 7479 7065  ed by store type
+0002c9d0: 0a20 2020 2020 2020 206f 7574 5f61 6c6c  .        out_all
+0002c9e0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+0002c9f0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
+0002ca00: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
+0002ca10: 7327 5d29 0a20 2020 2020 2020 206f 7574  s']).        out
+0002ca20: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0002ca30: 2069 7465 6d2e 7370 6c69 7428 295b 305d   item.split()[0]
+0002ca40: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0002ca50: 2069 7465 6d20 696e 206f 7574 5f61 6c6c   item in out_all
+0002ca60: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002ca70: 2e73 706c 6974 6c69 6e65 7328 290a 2020  .splitlines().  
+0002ca80: 2020 2020 2020 2020 2020 6966 2073 746f            if sto
+0002ca90: 7265 5f74 7970 652e 7661 6c75 6520 696e  re_type.value in
+0002caa0: 2069 7465 6d0a 2020 2020 2020 2020 5d0a   item.        ].
+0002cab0: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
+0002cac0: 6c6c 285b 6974 656d 2069 6e20 6f75 7420  ll([item in out 
+0002cad0: 666f 7220 6974 656d 2069 6e20 7374 6f72  for item in stor
+0002cae0: 6167 655f 6f62 6a5f 6e61 6d65 5d29 0a0a  age_obj_name])..
+0002caf0: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+0002cb00: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
+0002cb10: 2061 6c6c 2074 6f20 6465 6c65 7465 2061   all to delete a
+0002cb20: 6c6c 2073 746f 7261 6765 206f 626a 6563  ll storage objec
+0002cb30: 7473 0a20 2020 2020 2020 2064 656c 6574  ts.        delet
+0002cb40: 655f 636d 6420 3d20 5b27 736b 7927 2c20  e_cmd = ['sky', 
+0002cb50: 2773 746f 7261 6765 272c 2027 6465 6c65  'storage', 'dele
+0002cb60: 7465 272c 2027 2d2d 7965 7327 5d0a 2020  te', '--yes'].  
+0002cb70: 2020 2020 2020 6465 6c65 7465 5f63 6d64        delete_cmd
+0002cb80: 202b 3d20 7374 6f72 6167 655f 6f62 6a5f   += storage_obj_
+0002cb90: 6e61 6d65 0a20 2020 2020 2020 2073 7562  name.        sub
+0002cba0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+0002cbb0: 7470 7574 2864 656c 6574 655f 636d 6429  tput(delete_cmd)
+0002cbc0: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
+0002cbd0: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
+0002cbe0: 6f20 6368 6563 6b20 6966 2061 6c6c 2073  o check if all s
+0002cbf0: 746f 7261 6765 206f 626a 6563 7473 2066  torage objects f
+0002cc00: 696c 7465 7265 6420 6279 2073 746f 7265  iltered by store
+0002cc10: 0a20 2020 2020 2020 2023 2074 7970 6520  .        # type 
+0002cc20: 6172 6520 6465 6c65 7465 640a 2020 2020  are deleted.    
+0002cc30: 2020 2020 6f75 745f 616c 6c20 3d20 7375      out_all = su
+0002cc40: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+0002cc50: 7574 7075 7428 5b27 736b 7927 2c20 2773  utput(['sky', 's
+0002cc60: 746f 7261 6765 272c 2027 6c73 275d 290a  torage', 'ls']).
+0002cc70: 2020 2020 2020 2020 6f75 7420 3d20 5b0a          out = [.
+0002cc80: 2020 2020 2020 2020 2020 2020 6974 656d              item
+0002cc90: 2e73 706c 6974 2829 5b30 5d0a 2020 2020  .split()[0].    
+0002cca0: 2020 2020 2020 2020 666f 7220 6974 656d          for item
+0002ccb0: 2069 6e20 6f75 745f 616c 6c2e 6465 636f   in out_all.deco
+0002ccc0: 6465 2827 7574 662d 3827 292e 7370 6c69  de('utf-8').spli
+0002ccd0: 746c 696e 6573 2829 0a20 2020 2020 2020  tlines().       
+0002cce0: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
+0002ccf0: 7065 2e76 616c 7565 2069 6e20 6974 656d  pe.value in item
+0002cd00: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
+0002cd10: 2020 2061 7373 6572 7420 616c 6c28 5b69     assert all([i
+0002cd20: 7465 6d20 6e6f 7420 696e 206f 7574 2066  tem not in out f
+0002cd30: 6f72 2069 7465 6d20 696e 2073 746f 7261  or item in stora
+0002cd40: 6765 5f6f 626a 5f6e 616d 655d 290a 0a20  ge_obj_name]).. 
+0002cd50: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+0002cd60: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
+0002cd70: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
+0002cd80: 6172 616d 6574 7269 7a65 2827 7374 6f72  arametrize('stor
+0002cd90: 655f 7479 7065 272c 205b 0a20 2020 2020  e_type', [.     
+0002cda0: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
+0002cdb0: 746f 7265 5479 7065 2e53 332c 2073 746f  toreType.S3, sto
+0002cdc0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002cdd0: 7065 2e47 4353 2c0a 2020 2020 2020 2020  pe.GCS,.        
+0002cde0: 7079 7465 7374 2e70 6172 616d 2873 746f  pytest.param(sto
+0002cdf0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002ce00: 7065 2e49 424d 2c20 6d61 726b 733d 7079  pe.IBM, marks=py
+0002ce10: 7465 7374 2e6d 6172 6b2e 6962 6d29 2c0a  test.mark.ibm),.
+0002ce20: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
+0002ce30: 6172 616d 2873 746f 7261 6765 5f6c 6962  aram(storage_lib
+0002ce40: 2e53 746f 7265 5479 7065 2e52 322c 206d  .StoreType.R2, m
+0002ce50: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+0002ce60: 2e63 6c6f 7564 666c 6172 6529 0a20 2020  .cloudflare).   
+0002ce70: 205d 290a 2020 2020 6465 6620 7465 7374   ]).    def test
+0002ce80: 5f75 706c 6f61 645f 736f 7572 6365 5f77  _upload_source_w
+0002ce90: 6974 685f 7370 6163 6573 2873 656c 662c  ith_spaces(self,
+0002cea0: 2073 746f 7265 5f74 7970 652c 0a20 2020   store_type,.   
+0002ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ced0: 2020 2020 746d 705f 6d75 6c74 6970 6c65      tmp_multiple
+0002cee0: 5f63 7573 746f 6d5f 736f 7572 6365 5f73  _custom_source_s
+0002cef0: 746f 7261 6765 5f6f 626a 293a 0a20 2020  torage_obj):.   
+0002cf00: 2020 2020 2023 2043 7265 6174 6573 2074       # Creates t
+0002cf10: 776f 2062 7563 6b65 7473 2077 6974 6820  wo buckets with 
+0002cf20: 7370 6563 6966 6965 6420 6c6f 6361 6c20  specified local 
+0002cf30: 736f 7572 6365 730a 2020 2020 2020 2020  sources.        
+0002cf40: 2320 7769 7468 2073 7061 6365 7320 696e  # with spaces in
+0002cf50: 2074 6865 206e 616d 650a 2020 2020 2020   the name.      
+0002cf60: 2020 7374 6f72 6167 655f 6f62 6a5f 6e61    storage_obj_na
+0002cf70: 6d65 7320 3d20 5b5d 0a20 2020 2020 2020  mes = [].       
+0002cf80: 2066 6f72 2073 746f 7261 6765 5f6f 626a   for storage_obj
+0002cf90: 2069 6e20 746d 705f 6d75 6c74 6970 6c65   in tmp_multiple
+0002cfa0: 5f63 7573 746f 6d5f 736f 7572 6365 5f73  _custom_source_s
+0002cfb0: 746f 7261 6765 5f6f 626a 3a0a 2020 2020  torage_obj:.    
+0002cfc0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002cfd0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0002cfe0: 6f72 655f 7479 7065 290a 2020 2020 2020  ore_type).      
+0002cff0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0002d000: 6a5f 6e61 6d65 732e 6170 7065 6e64 2873  j_names.append(s
+0002d010: 746f 7261 6765 5f6f 626a 2e6e 616d 6529  torage_obj.name)
+0002d020: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
+0002d030: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
+0002d040: 6f20 6368 6563 6b20 6966 2061 6c6c 2073  o check if all s
+0002d050: 746f 7261 6765 206f 626a 6563 7473 2065  torage objects e
+0002d060: 7869 7374 7320 696e 2074 6865 0a20 2020  xists in the.   
+0002d070: 2020 2020 2023 206f 7574 7075 7420 6669       # output fi
+0002d080: 6c74 6572 6564 2062 7920 7374 6f72 6520  ltered by store 
+0002d090: 7479 7065 0a20 2020 2020 2020 206f 7574  type.        out
+0002d0a0: 5f61 6c6c 203d 2073 7562 7072 6f63 6573  _all = subproces
+0002d0b0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0002d0c0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0002d0d0: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0002d0e0: 206f 7574 203d 205b 0a20 2020 2020 2020   out = [.       
+0002d0f0: 2020 2020 2069 7465 6d2e 7370 6c69 7428       item.split(
+0002d100: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+0002d110: 2066 6f72 2069 7465 6d20 696e 206f 7574   for item in out
+0002d120: 5f61 6c6c 2e64 6563 6f64 6528 2775 7466  _all.decode('utf
+0002d130: 2d38 2729 2e73 706c 6974 6c69 6e65 7328  -8').splitlines(
+0002d140: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0002d150: 2073 746f 7265 5f74 7970 652e 7661 6c75   store_type.valu
+0002d160: 6520 696e 2069 7465 6d0a 2020 2020 2020  e in item.      
+0002d170: 2020 5d0a 2020 2020 2020 2020 6173 7365    ].        asse
+0002d180: 7274 2061 6c6c 285b 6974 656d 2069 6e20  rt all([item in 
+0002d190: 6f75 7420 666f 7220 6974 656d 2069 6e20  out for item in 
+0002d1a0: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
+0002d1b0: 735d 290a 0a20 2020 2040 7079 7465 7374  s])..    @pytest
+0002d1c0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+0002d1d0: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
+0002d1e0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+0002d1f0: 2827 7374 6f72 655f 7479 7065 272c 205b  ('store_type', [
+0002d200: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002d210: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+0002d220: 332c 2073 746f 7261 6765 5f6c 6962 2e53  3, storage_lib.S
+0002d230: 746f 7265 5479 7065 2e47 4353 2c0a 2020  toreType.GCS,.  
+0002d240: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+0002d250: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
+0002d260: 746f 7265 5479 7065 2e49 424d 2c20 6d61  toreType.IBM, ma
+0002d270: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+0002d280: 6962 6d29 2c0a 2020 2020 2020 2020 7079  ibm),.        py
+0002d290: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
+0002d2a0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002d2b0: 2e52 322c 206d 6172 6b73 3d70 7974 6573  .R2, marks=pytes
+0002d2c0: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+0002d2d0: 6529 0a20 2020 205d 290a 2020 2020 6465  e).    ]).    de
+0002d2e0: 6620 7465 7374 5f62 7563 6b65 745f 6578  f test_bucket_ex
+0002d2f0: 7465 726e 616c 5f64 656c 6574 696f 6e28  ternal_deletion(
+0002d300: 7365 6c66 2c20 746d 705f 7363 7261 7463  self, tmp_scratc
+0002d310: 685f 7374 6f72 6167 655f 6f62 6a2c 0a20  h_storage_obj,. 
+0002d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d340: 2020 2020 2073 746f 7265 5f74 7970 6529       store_type)
+0002d350: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002d360: 7465 7320 6120 6275 636b 6574 2c20 6465  tes a bucket, de
+0002d370: 6c65 7465 7320 6974 2065 7874 6572 6e61  letes it externa
+0002d380: 6c6c 7920 7573 696e 6720 636c 6f75 6420  lly using cloud 
+0002d390: 636c 6920 636f 6d6d 616e 6473 0a20 2020  cli commands.   
+0002d3a0: 2020 2020 2023 2061 6e64 2074 6865 6e20       # and then 
+0002d3b0: 7472 6965 7320 746f 2064 656c 6574 6520  tries to delete 
+0002d3c0: 6974 2075 7369 6e67 2073 6b79 2073 746f  it using sky sto
+0002d3d0: 7261 6765 2064 656c 6574 652e 0a20 2020  rage delete..   
+0002d3e0: 2020 2020 2074 6d70 5f73 6372 6174 6368       tmp_scratch
+0002d3f0: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
+0002d400: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
+0002d410: 6529 0a0a 2020 2020 2020 2020 2320 5275  e)..        # Ru
+0002d420: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
+0002d430: 2074 6f20 6368 6563 6b20 6966 2073 746f   to check if sto
+0002d440: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
+0002d450: 7473 2069 6e20 7468 6520 6f75 7470 7574  ts in the output
+0002d460: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
+0002d470: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0002d480: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
+0002d490: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
+0002d4a0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0002d4b0: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
+0002d4c0: 6167 655f 6f62 6a2e 6e61 6d65 2069 6e20  age_obj.name in 
+0002d4d0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+0002d4e0: 3827 290a 0a20 2020 2020 2020 2023 2044  8')..        # D
+0002d4f0: 656c 6574 6520 6275 636b 6574 2065 7874  elete bucket ext
+0002d500: 6572 6e61 6c6c 790a 2020 2020 2020 2020  ernally.        
+0002d510: 636d 6420 3d20 7365 6c66 2e63 6c69 5f64  cmd = self.cli_d
+0002d520: 656c 6574 655f 636d 6428 7374 6f72 655f  elete_cmd(store_
+0002d530: 7479 7065 2c20 746d 705f 7363 7261 7463  type, tmp_scratc
+0002d540: 685f 7374 6f72 6167 655f 6f62 6a2e 6e61  h_storage_obj.na
+0002d550: 6d65 290a 2020 2020 2020 2020 7375 6270  me).        subp
+0002d560: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002d570: 7075 7428 636d 642c 2073 6865 6c6c 3d54  put(cmd, shell=T
+0002d580: 7275 6529 0a0a 2020 2020 2020 2020 2320  rue)..        # 
+0002d590: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
+0002d5a0: 6465 6c65 7465 2074 6f20 6465 6c65 7465  delete to delete
+0002d5b0: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
+0002d5c0: 6563 740a 2020 2020 2020 2020 6f75 7420  ect.        out 
+0002d5d0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+0002d5e0: 636b 5f6f 7574 7075 7428 0a20 2020 2020  ck_output(.     
+0002d5f0: 2020 2020 2020 205b 2773 6b79 272c 2027         ['sky', '
+0002d600: 7374 6f72 6167 6527 2c20 2764 656c 6574  storage', 'delet
+0002d610: 6527 2c20 746d 705f 7363 7261 7463 685f  e', tmp_scratch_
+0002d620: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002d630: 2c20 272d 2d79 6573 275d 290a 2020 2020  , '--yes']).    
+0002d640: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
+0002d650: 6275 636b 6574 2077 6173 206e 6f74 2063  bucket was not c
+0002d660: 7265 6174 6564 2064 7572 696e 6720 6465  reated during de
+0002d670: 6c65 7469 6f6e 2028 7365 6520 6973 7375  letion (see issu
+0002d680: 6520 2331 3332 3229 0a20 2020 2020 2020  e #1322).       
+0002d690: 2061 7373 6572 7420 2763 7265 6174 6564   assert 'created
+0002d6a0: 2720 6e6f 7420 696e 206f 7574 2e64 6563  ' not in out.dec
+0002d6b0: 6f64 6528 2775 7466 2d38 2729 2e6c 6f77  ode('utf-8').low
+0002d6c0: 6572 2829 0a0a 2020 2020 2020 2020 2320  er()..        # 
+0002d6d0: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
+0002d6e0: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
+0002d6f0: 746f 7261 6765 206f 626a 6563 7420 6973  torage object is
+0002d700: 2064 656c 6574 6564 0a20 2020 2020 2020   deleted.       
+0002d710: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0002d720: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0002d730: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0002d740: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0002d750: 2061 7373 6572 7420 746d 705f 7363 7261   assert tmp_scra
+0002d760: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
+0002d770: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
+0002d780: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
+0002d790: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0002d7a0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
+0002d7b0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+0002d7c0: 2e70 6172 616d 6574 7269 7a65 2827 7374  .parametrize('st
+0002d7d0: 6f72 655f 7479 7065 272c 205b 0a20 2020  ore_type', [.   
+0002d7e0: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+0002d7f0: 2e53 746f 7265 5479 7065 2e53 332c 2073  .StoreType.S3, s
+0002d800: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002d810: 5479 7065 2e47 4353 2c0a 2020 2020 2020  Type.GCS,.      
+0002d820: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
+0002d830: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002d840: 5479 7065 2e49 424d 2c20 6d61 726b 733d  Type.IBM, marks=
+0002d850: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
+0002d860: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
+0002d870: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
+0002d880: 6962 2e53 746f 7265 5479 7065 2e52 322c  ib.StoreType.R2,
+0002d890: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0002d8a0: 726b 2e63 6c6f 7564 666c 6172 6529 0a20  rk.cloudflare). 
+0002d8b0: 2020 205d 290a 2020 2020 6465 6620 7465     ]).    def te
+0002d8c0: 7374 5f62 7563 6b65 745f 6275 6c6b 5f64  st_bucket_bulk_d
+0002d8d0: 656c 6574 696f 6e28 7365 6c66 2c20 7374  eletion(self, st
+0002d8e0: 6f72 655f 7479 7065 2c20 746d 705f 6275  ore_type, tmp_bu
+0002d8f0: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
+0002d900: 626a 293a 0a20 2020 2020 2020 2023 2043  bj):.        # C
+0002d910: 7265 6174 6573 2061 2074 656d 7020 666f  reates a temp fo
+0002d920: 6c64 6572 2077 6974 6820 6f76 6572 2032  lder with over 2
+0002d930: 3536 2066 696c 6573 2061 6e64 2066 6f6c  56 files and fol
+0002d940: 6465 7273 2c20 7570 6c6f 6164 0a20 2020  ders, upload.   
+0002d950: 2020 2020 2023 2066 696c 6573 2061 6e64       # files and
+0002d960: 2066 6f6c 6465 7273 2074 6f20 6120 6e65   folders to a ne
+0002d970: 7720 6275 636b 6574 2c20 7468 656e 2064  w bucket, then d
+0002d980: 656c 6574 6520 6275 636b 6574 2e0a 2020  elete bucket..  
+0002d990: 2020 2020 2020 746d 705f 6275 6c6b 5f64        tmp_bulk_d
+0002d9a0: 656c 5f73 746f 7261 6765 5f6f 626a 2e61  el_storage_obj.a
+0002d9b0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
+0002d9c0: 7970 6529 0a0a 2020 2020 2020 2020 7375  ype)..        su
+0002d9d0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+0002d9e0: 7574 7075 7428 5b0a 2020 2020 2020 2020  utput([.        
+0002d9f0: 2020 2020 2773 6b79 272c 2027 7374 6f72      'sky', 'stor
+0002da00: 6167 6527 2c20 2764 656c 6574 6527 2c20  age', 'delete', 
+0002da10: 746d 705f 6275 6c6b 5f64 656c 5f73 746f  tmp_bulk_del_sto
+0002da20: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
+0002da30: 2d2d 7965 7327 0a20 2020 2020 2020 205d  --yes'.        ]
+0002da40: 290a 0a20 2020 2020 2020 206f 7574 7075  )..        outpu
+0002da50: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+0002da60: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
+0002da70: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002da80: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
+0002da90: 7365 7274 2074 6d70 5f62 756c 6b5f 6465  sert tmp_bulk_de
+0002daa0: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
+0002dab0: 6d65 206e 6f74 2069 6e20 6f75 7470 7574  me not in output
+0002dac0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002dad0: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+0002dae0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+0002daf0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0002db00: 6b2e 7061 7261 6d65 7472 697a 6528 0a20  k.parametrize(. 
+0002db10: 2020 2020 2020 2027 746d 705f 7075 626c         'tmp_publ
+0002db20: 6963 5f73 746f 7261 6765 5f6f 626a 2c20  ic_storage_obj, 
+0002db30: 7374 6f72 655f 7479 7065 272c 0a20 2020  store_type',.   
+0002db40: 2020 2020 205b 2827 7333 3a2f 2f74 6367       [('s3://tcg
+0002db50: 612d 322d 6f70 656e 272c 2073 746f 7261  a-2-open', stora
+0002db60: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002db70: 2e53 3329 2c0a 2020 2020 2020 2020 2028  .S3),.         (
+0002db80: 2773 333a 2f2f 6469 6769 7461 6c63 6f72  's3://digitalcor
+0002db90: 706f 7261 272c 2073 746f 7261 6765 5f6c  pora', storage_l
+0002dba0: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
+0002dbb0: 2c0a 2020 2020 2020 2020 2028 2767 733a  ,.         ('gs:
+0002dbc0: 2f2f 6763 702d 7075 626c 6963 2d64 6174  //gcp-public-dat
+0002dbd0: 612d 7365 6e74 696e 656c 2d32 272c 2073  a-sentinel-2', s
+0002dbe0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002dbf0: 5479 7065 2e47 4353 295d 2c0a 2020 2020  Type.GCS)],.    
+0002dc00: 2020 2020 696e 6469 7265 6374 3d5b 2774      indirect=['t
+0002dc10: 6d70 5f70 7562 6c69 635f 7374 6f72 6167  mp_public_storag
+0002dc20: 655f 6f62 6a27 5d29 0a20 2020 2064 6566  e_obj']).    def
+0002dc30: 2074 6573 745f 7075 626c 6963 5f62 7563   test_public_buc
+0002dc40: 6b65 7428 7365 6c66 2c20 746d 705f 7075  ket(self, tmp_pu
+0002dc50: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
+0002dc60: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
+0002dc70: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0002dc80: 2061 206e 6577 2062 7563 6b65 7420 7769   a new bucket wi
+0002dc90: 7468 2061 2070 7562 6c69 6320 736f 7572  th a public sour
+0002dca0: 6365 2061 6e64 2076 6572 6966 6965 7320  ce and verifies 
+0002dcb0: 7468 6174 2069 7420 6973 206e 6f74 0a20  that it is not. 
+0002dcc0: 2020 2020 2020 2023 2061 6464 6564 2074         # added t
+0002dcd0: 6f20 676c 6f62 616c 5f75 7365 725f 7374  o global_user_st
+0002dce0: 6174 652e 0a20 2020 2020 2020 2074 6d70  ate..        tmp
+0002dcf0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
+0002dd00: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0002dd10: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+0002dd20: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002dd30: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
+0002dd40: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
+0002dd50: 6374 2065 7869 7374 7320 696e 2074 6865  ct exists in the
+0002dd60: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0002dd70: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+0002dd80: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
+0002dd90: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
+0002dda0: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
+0002ddb0: 6173 7365 7274 2074 6d70 5f70 7562 6c69  assert tmp_publi
+0002ddc0: 635f 7374 6f72 6167 655f 6f62 6a2e 6e61  c_storage_obj.na
+0002ddd0: 6d65 206e 6f74 2069 6e20 6f75 742e 6465  me not in out.de
+0002dde0: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
+0002ddf0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+0002de00: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
+0002de10: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
+0002de20: 6172 616d 6574 7269 7a65 2827 6e6f 6e65  arametrize('none
+0002de30: 7869 7374 5f62 7563 6b65 745f 7572 6c27  xist_bucket_url'
+0002de40: 2c20 5b0a 2020 2020 2020 2020 2773 333a  , [.        's3:
+0002de50: 2f2f 7b72 616e 646f 6d5f 6e61 6d65 7d27  //{random_name}'
+0002de60: 2c20 2767 733a 2f2f 7b72 616e 646f 6d5f  , 'gs://{random_
+0002de70: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+0002de80: 7079 7465 7374 2e70 6172 616d 2827 636f  pytest.param('co
+0002de90: 733a 2f2f 7573 2d65 6173 742f 7b72 616e  s://us-east/{ran
+0002dea0: 646f 6d5f 6e61 6d65 7d27 2c20 6d61 726b  dom_name}', mark
+0002deb0: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
+0002dec0: 6d29 2c0a 2020 2020 2020 2020 7079 7465  m),.        pyte
+0002ded0: 7374 2e70 6172 616d 2827 7232 3a2f 2f7b  st.param('r2://{
+0002dee0: 7261 6e64 6f6d 5f6e 616d 657d 272c 206d  random_name}', m
+0002def0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+0002df00: 2e63 6c6f 7564 666c 6172 6529 0a20 2020  .cloudflare).   
+0002df10: 205d 290a 2020 2020 6465 6620 7465 7374   ]).    def test
+0002df20: 5f6e 6f6e 6578 6973 7465 6e74 5f62 7563  _nonexistent_buc
+0002df30: 6b65 7428 7365 6c66 2c20 6e6f 6e65 7869  ket(self, nonexi
+0002df40: 7374 5f62 7563 6b65 745f 7572 6c29 3a0a  st_bucket_url):.
+0002df50: 2020 2020 2020 2020 2320 4174 7465 6d70          # Attemp
+0002df60: 7473 2074 6f20 6372 6561 7465 2066 6574  ts to create fet
+0002df70: 6368 2061 2073 7472 6f61 6765 2077 6974  ch a stroage wit
+0002df80: 6820 6120 6e6f 6e2d 6578 6973 7465 6e74  h a non-existent
+0002df90: 2073 6f75 7263 652e 0a20 2020 2020 2020   source..       
+0002dfa0: 2023 2047 656e 6572 6174 6520 6120 7261   # Generate a ra
+0002dfb0: 6e64 6f6d 2062 7563 6b65 7420 6e61 6d65  ndom bucket name
+0002dfc0: 2061 6e64 2076 6572 6966 7920 6974 2064   and verify it d
+0002dfd0: 6f65 736e 2774 2065 7869 7374 3a0a 2020  oesn't exist:.  
+0002dfe0: 2020 2020 2020 7265 7472 795f 636f 756e        retry_coun
+0002dff0: 7420 3d20 300a 2020 2020 2020 2020 7768  t = 0.        wh
+0002e000: 696c 6520 5472 7565 3a0a 2020 2020 2020  ile True:.      
+0002e010: 2020 2020 2020 6e6f 6e65 7869 7374 5f62        nonexist_b
+0002e020: 7563 6b65 745f 6e61 6d65 203d 2073 7472  ucket_name = str
+0002e030: 2875 7569 642e 7575 6964 3428 2929 0a20  (uuid.uuid4()). 
+0002e040: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0002e050: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+0002e060: 6c2e 7374 6172 7473 7769 7468 2827 7333  l.startswith('s3
+0002e070: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+0002e080: 2020 2020 636f 6d6d 616e 6420 3d20 6627      command = f'
+0002e090: 6177 7320 7333 6170 6920 6865 6164 2d62  aws s3api head-b
+0002e0a0: 7563 6b65 7420 2d2d 6275 636b 6574 207b  ucket --bucket {
+0002e0b0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+0002e0c0: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
+0002e0d0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+0002e0e0: 6f75 7470 7574 203d 2027 3430 3427 0a20  output = '404'. 
+0002e0f0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0002e100: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+0002e110: 7572 6c2e 7374 6172 7473 7769 7468 2827  url.startswith('
+0002e120: 6773 2729 3a0a 2020 2020 2020 2020 2020  gs'):.          
+0002e130: 2020 2020 2020 636f 6d6d 616e 6420 3d20        command = 
+0002e140: 6627 6773 7574 696c 206c 7320 7b6e 6f6e  f'gsutil ls {non
+0002e150: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
+0002e160: 2e66 6f72 6d61 7428 7261 6e64 6f6d 5f6e  .format(random_n
+0002e170: 616d 653d 6e6f 6e65 7869 7374 5f62 7563  ame=nonexist_buc
+0002e180: 6b65 745f 6e61 6d65 297d 270a 2020 2020  ket_name)}'.    
+0002e190: 2020 2020 2020 2020 2020 2020 6578 7065              expe
+0002e1a0: 6374 6564 5f6f 7574 7075 7420 3d20 2742  cted_output = 'B
+0002e1b0: 7563 6b65 744e 6f74 466f 756e 6445 7863  ucketNotFoundExc
+0002e1c0: 6570 7469 6f6e 270a 2020 2020 2020 2020  eption'.        
+0002e1d0: 2020 2020 656c 6966 206e 6f6e 6578 6973      elif nonexis
+0002e1e0: 745f 6275 636b 6574 5f75 726c 2e73 7461  t_bucket_url.sta
+0002e1f0: 7274 7377 6974 6828 2772 3227 293a 0a20  rtswith('r2'):. 
+0002e200: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002e210: 6e64 706f 696e 745f 7572 6c20 3d20 636c  ndpoint_url = cl
+0002e220: 6f75 6466 6c61 7265 2e63 7265 6174 655f  oudflare.create_
+0002e230: 656e 6470 6f69 6e74 2829 0a20 2020 2020  endpoint().     
+0002e240: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+0002e250: 6e64 203d 2066 2741 5753 5f53 4841 5245  nd = f'AWS_SHARE
+0002e260: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
+0002e270: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
+0002e280: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
+0002e290: 5448 7d20 6177 7320 7333 6170 6920 6865  TH} aws s3api he
+0002e2a0: 6164 2d62 7563 6b65 7420 2d2d 6275 636b  ad-bucket --buck
+0002e2b0: 6574 207b 6e6f 6e65 7869 7374 5f62 7563  et {nonexist_buc
+0002e2c0: 6b65 745f 6e61 6d65 7d20 2d2d 656e 6470  ket_name} --endp
+0002e2d0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
+0002e2e0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
+0002e2f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0002e300: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
+0002e310: 7420 3d20 2734 3034 270a 2020 2020 2020  t = '404'.      
+0002e320: 2020 2020 2020 656c 6966 206e 6f6e 6578        elif nonex
+0002e330: 6973 745f 6275 636b 6574 5f75 726c 2e73  ist_bucket_url.s
+0002e340: 7461 7274 7377 6974 6828 2763 6f73 2729  tartswith('cos')
+0002e350: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002e360: 2020 2320 5573 696e 6720 4150 4920 6361    # Using API ca
+0002e370: 6c6c 732c 2073 696e 6365 2075 7369 6e67  lls, since using
+0002e380: 2072 636c 6f6e 6520 7265 7175 6972 6573   rclone requires
+0002e390: 2061 2070 726f 6669 6c65 2773 206e 616d   a profile's nam
+0002e3a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0002e3b0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0002e3c0: 2020 2020 2020 2020 2020 2065 7870 6563             expec
+0002e3d0: 7465 645f 6f75 7470 7574 203d 2063 6f6d  ted_output = com
+0002e3e0: 6d61 6e64 203d 2022 6563 686f 2220 2023  mand = "echo"  #
+0002e3f0: 2061 766f 6964 2075 6e72 656c 6174 6564   avoid unrelated
+0002e400: 2065 7863 6570 7469 6f6e 2069 6e20 6361   exception in ca
+0002e410: 7365 206f 6620 6661 696c 7572 652e 0a20  se of failure.. 
+0002e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e430: 2020 2062 7563 6b65 745f 6e61 6d65 203d     bucket_name =
+0002e440: 2075 726c 6c69 622e 7061 7273 652e 7572   urllib.parse.ur
+0002e450: 6c73 706c 6974 280a 2020 2020 2020 2020  lsplit(.        
+0002e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e470: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+0002e480: 7572 6c2e 666f 726d 6174 280a 2020 2020  url.format(.    
 0002e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4b0: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-0002e4c0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0002e4d0: 2027 746d 702d 6669 6c65 2720 696e 206f   'tmp-file' in o
-0002e4e0: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-0002e4f0: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
-0002e500: 2020 2746 696c 6520 6e6f 7420 666f 756e    'File not foun
-0002e510: 6420 696e 2062 7563 6b65 7420 2d20 6f75  d in bucket - ou
-0002e520: 7470 7574 2077 6173 203a 207b 7d27 2e66  tput was : {}'.f
-0002e530: 6f72 6d61 7428 6f75 742e 6465 636f 6465  ormat(out.decode
-0002e540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e580: 2028 2775 7466 2d38 2729 290a 0a20 2020   ('utf-8'))..   
-0002e590: 2020 2020 2023 2043 6865 636b 2073 796d       # Check sym
-0002e5a0: 6c69 6e6b 7320 2d20 7379 6d6c 696e 6b73  links - symlinks
-0002e5b0: 2064 6f6e 2774 2067 6574 2063 6f70 6965   don't get copie
-0002e5c0: 6420 6279 2073 6b79 2073 746f 7261 6765  d by sky storage
-0002e5d0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002e5e0: 2870 6174 686c 6962 2e50 6174 6828 746d  (pathlib.Path(tm
-0002e5f0: 705f 736f 7572 6365 2920 2f20 2763 6972  p_source) / 'cir
-0002e600: 636c 652d 6c69 6e6b 2729 2e69 735f 7379  cle-link').is_sy
-0002e610: 6d6c 696e 6b28 292c 2028 0a20 2020 2020  mlink(), (.     
-0002e620: 2020 2020 2020 2027 6369 7263 6c65 2d6c         'circle-l
-0002e630: 696e 6b20 7761 7320 6e6f 7420 666f 756e  ink was not foun
-0002e640: 6420 696e 2074 6865 2075 706c 6f61 6420  d in the upload 
-0002e650: 736f 7572 6365 202d 2027 0a20 2020 2020  source - '.     
-0002e660: 2020 2020 2020 2027 6172 6520 7468 6520         'are the 
-0002e670: 7465 7374 2066 6978 7475 7265 7320 636f  test fixtures co
-0002e680: 7272 6563 743f 2729 0a20 2020 2020 2020  rrect?').       
-0002e690: 2061 7373 6572 7420 2763 6972 636c 652d   assert 'circle-
-0002e6a0: 6c69 6e6b 2720 6e6f 7420 696e 206f 7574  link' not in out
-0002e6b0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0002e6c0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-0002e6d0: 2753 796d 6c69 6e6b 2066 6f75 6e64 2069  'Symlink found i
-0002e6e0: 6e20 6275 636b 6574 202d 206c 7320 6f75  n bucket - ls ou
-0002e6f0: 7470 7574 2077 6173 203a 207b 7d27 2e66  tput was : {}'.f
-0002e700: 6f72 6d61 7428 0a20 2020 2020 2020 2020  ormat(.         
-0002e710: 2020 2020 2020 206f 7574 2e64 6563 6f64         out.decod
-0002e720: 6528 2775 7466 2d38 2729 2929 0a0a 2020  e('utf-8')))..  
-0002e730: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
-0002e740: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
-0002e750: 6563 6b20 6966 2073 746f 7261 6765 206f  eck if storage o
-0002e760: 626a 6563 7420 6578 6973 7473 2069 6e20  bject exists in 
-0002e770: 7468 6520 6f75 7470 7574 2e0a 2020 2020  the output..    
-0002e780: 2020 2020 2320 4974 2073 686f 756c 6420      # It should 
-0002e790: 6e6f 7420 6578 6973 7420 6265 6361 7573  not exist becaus
-0002e7a0: 6520 7468 6520 6275 636b 6574 2077 6173  e the bucket was
-0002e7b0: 2063 7265 6174 6564 2065 7874 6572 6e61   created externa
-0002e7c0: 6c6c 792e 0a20 2020 2020 2020 206f 7574  lly..        out
-0002e7d0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002e7e0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-0002e7f0: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-0002e800: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-0002e810: 6572 7420 7374 6f72 6167 655f 6f62 6a2e  ert storage_obj.
-0002e820: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
-0002e830: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-0002e840: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002e850: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
-0002e860: 2020 2020 6465 6620 7465 7374 5f63 6f70      def test_cop
-0002e870: 795f 6d6f 756e 745f 6578 6973 7469 6e67  y_mount_existing
-0002e880: 5f73 746f 7261 6765 2873 656c 662c 0a20  _storage(self,. 
-0002e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e8b0: 2020 2020 2020 2020 746d 705f 636f 7079          tmp_copy
-0002e8c0: 5f6d 6e74 5f65 7869 7374 696e 675f 7374  _mnt_existing_st
-0002e8d0: 6f72 6167 655f 6f62 6a29 3a0a 2020 2020  orage_obj):.    
-0002e8e0: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002e8f0: 6275 636b 6574 2077 6974 6820 6e6f 2073  bucket with no s
-0002e900: 6f75 7263 6520 696e 204d 4f55 4e54 206d  ource in MOUNT m
-0002e910: 6f64 6520 2865 6d70 7479 2062 7563 6b65  ode (empty bucke
-0002e920: 7429 2c20 616e 640a 2020 2020 2020 2020  t), and.        
-0002e930: 2320 7468 656e 2074 7269 6573 2074 6f20  # then tries to 
-0002e940: 6c6f 6164 2074 6865 2073 616d 6520 7374  load the same st
-0002e950: 6f72 6167 6520 696e 2043 4f50 5920 6d6f  orage in COPY mo
-0002e960: 6465 2e0a 2020 2020 2020 2020 746d 705f  de..        tmp_
-0002e970: 636f 7079 5f6d 6e74 5f65 7869 7374 696e  copy_mnt_existin
-0002e980: 675f 7374 6f72 6167 655f 6f62 6a2e 6164  g_storage_obj.ad
-0002e990: 645f 7374 6f72 6528 7374 6f72 6167 655f  d_store(storage_
-0002e9a0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0002e9b0: 290a 2020 2020 2020 2020 7374 6f72 6167  ).        storag
-0002e9c0: 655f 6e61 6d65 203d 2074 6d70 5f63 6f70  e_name = tmp_cop
-0002e9d0: 795f 6d6e 745f 6578 6973 7469 6e67 5f73  y_mnt_existing_s
-0002e9e0: 746f 7261 6765 5f6f 626a 2e6e 616d 650a  torage_obj.name.
-0002e9f0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-0002ea00: 2060 736b 7920 7374 6f72 6167 6520 6c73   `sky storage ls
-0002ea10: 6020 746f 2065 6e73 7572 6520 7374 6f72  ` to ensure stor
-0002ea20: 6167 6520 6f62 6a65 6374 2065 7869 7374  age object exist
-0002ea30: 730a 2020 2020 2020 2020 6f75 7420 3d20  s.        out = 
-0002ea40: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0002ea50: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
-0002ea60: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
-0002ea70: 292e 6465 636f 6465 2827 7574 662d 3827  ).decode('utf-8'
-0002ea80: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0002ea90: 2073 746f 7261 6765 5f6e 616d 6520 696e   storage_name in
-0002eaa0: 206f 7574 2c20 6627 5374 6f72 6167 6520   out, f'Storage 
-0002eab0: 7b73 746f 7261 6765 5f6e 616d 657d 206e  {storage_name} n
-0002eac0: 6f74 2066 6f75 6e64 2069 6e20 736b 7920  ot found in sky 
-0002ead0: 7374 6f72 6167 6520 6c73 2e27 0a0a 2020  storage ls.'..  
-0002eae0: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
-0002eaf0: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
-0002eb00: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
-0002eb10: 7261 6d65 7472 697a 6528 2773 746f 7265  rametrize('store
-0002eb20: 5f74 7970 6527 2c20 5b0a 2020 2020 2020  _type', [.      
-0002eb30: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
-0002eb40: 6f72 6554 7970 652e 5333 2c20 7374 6f72  oreType.S3, stor
-0002eb50: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002eb60: 652e 4743 532c 0a20 2020 2020 2020 2070  e.GCS,.        p
-0002eb70: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
-0002eb80: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002eb90: 652e 4942 4d2c 206d 6172 6b73 3d70 7974  e.IBM, marks=pyt
-0002eba0: 6573 742e 6d61 726b 2e69 626d 292c 0a20  est.mark.ibm),. 
-0002ebb0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0002ebc0: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
-0002ebd0: 5374 6f72 6554 7970 652e 5232 2c20 6d61  StoreType.R2, ma
-0002ebe0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-0002ebf0: 636c 6f75 6466 6c61 7265 290a 2020 2020  cloudflare).    
-0002ec00: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
-0002ec10: 6c69 7374 5f73 6f75 7263 6528 7365 6c66  list_source(self
-0002ec20: 2c20 746d 705f 6c6f 6361 6c5f 6c69 7374  , tmp_local_list
-0002ec30: 5f73 746f 7261 6765 5f6f 626a 2c20 7374  _storage_obj, st
-0002ec40: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
-0002ec50: 2020 2023 2055 7365 7320 6120 6c69 7374     # Uses a list
-0002ec60: 2069 6e20 7468 6520 736f 7572 6365 2066   in the source f
-0002ec70: 6965 6c64 2074 6f20 7370 6563 6966 7920  ield to specify 
-0002ec80: 6120 6669 6c65 2061 6e64 2061 2064 6972  a file and a dir
-0002ec90: 6563 746f 7279 2074 6f0a 2020 2020 2020  ectory to.      
-0002eca0: 2020 2320 6265 2075 706c 6f61 6465 6420    # be uploaded 
-0002ecb0: 746f 2074 6865 2073 746f 7261 6765 206f  to the storage o
-0002ecc0: 626a 6563 742e 0a20 2020 2020 2020 2074  bject..        t
-0002ecd0: 6d70 5f6c 6f63 616c 5f6c 6973 745f 7374  mp_local_list_st
-0002ece0: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
-0002ecf0: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
-0002ed00: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-0002ed10: 2069 6620 746d 702d 6669 6c65 2065 7869   if tmp-file exi
-0002ed20: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
-0002ed30: 7420 726f 6f74 2075 7369 6e67 2063 6c69  t root using cli
-0002ed40: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-0002ed50: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002ed60: 6f75 7470 7574 2873 656c 662e 636c 695f  output(self.cli_
-0002ed70: 6c73 5f63 6d64 280a 2020 2020 2020 2020  ls_cmd(.        
-0002ed80: 2020 2020 7374 6f72 655f 7479 7065 2c20      store_type, 
-0002ed90: 746d 705f 6c6f 6361 6c5f 6c69 7374 5f73  tmp_local_list_s
-0002eda0: 746f 7261 6765 5f6f 626a 2e6e 616d 6529  torage_obj.name)
-0002edb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002edd0: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
-0002ede0: 7565 290a 2020 2020 2020 2020 6173 7365  ue).        asse
-0002edf0: 7274 2027 746d 702d 6669 6c65 2720 696e  rt 'tmp-file' in
-0002ee00: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
-0002ee10: 2d38 2729 2c20 5c0a 2020 2020 2020 2020  -8'), \.        
-0002ee20: 2020 2020 2746 696c 6520 6e6f 7420 666f      'File not fo
-0002ee30: 756e 6420 696e 2062 7563 6b65 7420 2d20  und in bucket - 
-0002ee40: 6f75 7470 7574 2077 6173 203a 207b 7d27  output was : {}'
-0002ee50: 2e66 6f72 6d61 7428 6f75 742e 6465 636f  .format(out.deco
-0002ee60: 6465 0a20 2020 2020 2020 2020 2020 2020  de.             
-0002ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eea0: 2020 2028 2775 7466 2d38 2729 290a 0a20     ('utf-8')).. 
-0002eeb0: 2020 2020 2020 2023 2043 6865 636b 2069         # Check i
-0002eec0: 6620 746d 702d 6669 6c65 2065 7869 7374  f tmp-file exist
-0002eed0: 7320 696e 2074 6865 2062 7563 6b65 742f  s in the bucket/
-0002eee0: 746d 702d 736f 7572 6365 2075 7369 6e67  tmp-source using
-0002eef0: 2063 6c69 0a20 2020 2020 2020 206f 7574   cli.        out
-0002ef00: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002ef10: 6563 6b5f 6f75 7470 7574 2873 656c 662e  eck_output(self.
-0002ef20: 636c 695f 6c73 5f63 6d64 280a 2020 2020  cli_ls_cmd(.    
-0002ef30: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
-0002ef40: 7065 2c20 746d 705f 6c6f 6361 6c5f 6c69  pe, tmp_local_li
-0002ef50: 7374 5f73 746f 7261 6765 5f6f 626a 2e6e  st_storage_obj.n
-0002ef60: 616d 652c 2027 746d 702d 736f 7572 6365  ame, 'tmp-source
-0002ef70: 2f27 292c 0a20 2020 2020 2020 2020 2020  /'),.           
-0002ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ef90: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
-0002efa0: 3d54 7275 6529 0a20 2020 2020 2020 2061  =True).        a
-0002efb0: 7373 6572 7420 2774 6d70 2d66 696c 6527  ssert 'tmp-file'
-0002efc0: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-0002efd0: 7574 662d 3827 292c 205c 0a20 2020 2020  utf-8'), \.     
-0002efe0: 2020 2020 2020 2027 4669 6c65 206e 6f74         'File not
-0002eff0: 2066 6f75 6e64 2069 6e20 6275 636b 6574   found in bucket
-0002f000: 202d 206f 7574 7075 7420 7761 7320 3a20   - output was : 
-0002f010: 7b7d 272e 666f 726d 6174 286f 7574 2e64  {}'.format(out.d
-0002f020: 6563 6f64 650a 2020 2020 2020 2020 2020  ecode.          
+0002e4a0: 2020 2020 2020 2020 7261 6e64 6f6d 5f6e          random_n
+0002e4b0: 616d 653d 6e6f 6e65 7869 7374 5f62 7563  ame=nonexist_buc
+0002e4c0: 6b65 745f 6e61 6d65 2929 2e70 6174 682e  ket_name)).path.
+0002e4d0: 7374 7269 7028 272f 2729 0a20 2020 2020  strip('/').     
+0002e4e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002e4f0: 6c69 656e 7420 3d20 6962 6d2e 6765 745f  lient = ibm.get_
+0002e500: 636f 735f 636c 6965 6e74 2827 7573 2d65  cos_client('us-e
+0002e510: 6173 7427 290a 2020 2020 2020 2020 2020  ast').          
+0002e520: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+0002e530: 2e68 6561 645f 6275 636b 6574 2842 7563  .head_bucket(Buc
+0002e540: 6b65 743d 6275 636b 6574 5f6e 616d 6529  ket=bucket_name)
+0002e550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e560: 2065 7863 6570 7420 6962 6d2e 6962 6d5f   except ibm.ibm_
+0002e570: 626f 746f 636f 7265 2e65 7863 6570 7469  botocore.excepti
+0002e580: 6f6e 732e 436c 6965 6e74 4572 726f 7220  ons.ClientError 
+0002e590: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+0002e5a0: 2020 2020 2020 2020 2020 6966 2065 2e72            if e.r
+0002e5b0: 6573 706f 6e73 655b 2745 7272 6f72 275d  esponse['Error']
+0002e5c0: 5b27 436f 6465 275d 203d 3d20 2734 3034  ['Code'] == '404
+0002e5d0: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+0002e5e0: 2020 2020 2020 2020 2020 2023 2073 7563             # suc
+0002e5f0: 6365 7373 0a20 2020 2020 2020 2020 2020  cess.           
+0002e600: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0002e610: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
+0002e620: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0002e630: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+0002e640: 6545 7272 6f72 2827 556e 7375 7070 6f72  eError('Unsuppor
+0002e650: 7465 6420 6275 636b 6574 2074 7970 6520  ted bucket type 
+0002e660: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0002e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e680: 2020 2066 277b 6e6f 6e65 7869 7374 5f62     f'{nonexist_b
+0002e690: 7563 6b65 745f 7572 6c7d 2729 0a0a 2020  ucket_url}')..  
+0002e6a0: 2020 2020 2020 2020 2020 2320 4368 6563            # Chec
+0002e6b0: 6b20 6966 2062 7563 6b65 7420 6578 6973  k if bucket exis
+0002e6c0: 7473 2075 7369 6e67 2074 6865 2063 6c69  ts using the cli
+0002e6d0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+0002e6e0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0002e6f0: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
+0002e700: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+0002e710: 2863 6f6d 6d61 6e64 2c0a 2020 2020 2020  (command,.      
+0002e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e740: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
+0002e750: 7562 7072 6f63 6573 732e 5354 444f 5554  ubprocess.STDOUT
+0002e760: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e790: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+0002e7a0: 2020 2020 2020 2020 6578 6365 7074 2073          except s
+0002e7b0: 7562 7072 6f63 6573 732e 4361 6c6c 6564  ubprocess.Called
+0002e7c0: 5072 6f63 6573 7345 7272 6f72 2061 7320  ProcessError as 
+0002e7d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002e7e0: 2020 206f 7574 203d 2065 2e6f 7574 7075     out = e.outpu
+0002e7f0: 740a 2020 2020 2020 2020 2020 2020 6f75  t.            ou
+0002e800: 7420 3d20 6f75 742e 6465 636f 6465 2827  t = out.decode('
+0002e810: 7574 662d 3827 290a 2020 2020 2020 2020  utf-8').        
+0002e820: 2020 2020 6966 2065 7870 6563 7465 645f      if expected_
+0002e830: 6f75 7470 7574 2069 6e20 6f75 743a 0a20  output in out:. 
+0002e840: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0002e850: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+0002e860: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002e870: 2020 2020 2020 2072 6574 7279 5f63 6f75         retry_cou
+0002e880: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+0002e890: 2020 2020 2020 2020 6966 2072 6574 7279          if retry
+0002e8a0: 5f63 6f75 6e74 203e 2033 3a0a 2020 2020  _count > 3:.    
+0002e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e8c0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
+0002e8d0: 6f72 2827 556e 6162 6c65 2074 6f20 6669  or('Unable to fi
+0002e8e0: 6e64 2061 206e 6f6e 6578 6973 7465 6e74  nd a nonexistent
+0002e8f0: 2062 7563 6b65 7420 270a 2020 2020 2020   bucket '.      
+0002e900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e920: 2027 746f 2075 7365 2e20 5468 6973 2069   'to use. This i
+0002e930: 7320 6869 676c 7920 756e 6c69 6b65 6c79  s higly unlikely
+0002e940: 202d 2027 0a20 2020 2020 2020 2020 2020   - '.           
+0002e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e960: 2020 2020 2020 2020 2020 2020 2763 6865              'che
+0002e970: 636b 2069 6620 7468 6520 7465 7374 7320  ck if the tests 
+0002e980: 6172 6520 636f 7272 6563 742e 2729 0a0a  are correct.')..
+0002e990: 2020 2020 2020 2020 7769 7468 2070 7974          with pyt
+0002e9a0: 6573 742e 7261 6973 6573 280a 2020 2020  est.raises(.    
+0002e9b0: 2020 2020 2020 2020 2020 2020 736b 792e              sky.
+0002e9c0: 6578 6365 7074 696f 6e73 2e53 746f 7261  exceptions.Stora
+0002e9d0: 6765 4275 636b 6574 4765 7445 7272 6f72  geBucketGetError
+0002e9e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002e9f0: 2020 6d61 7463 683d 2741 7474 656d 7074    match='Attempt
+0002ea00: 6564 2074 6f20 7573 6520 6120 6e6f 6e2d  ed to use a non-
+0002ea10: 6578 6973 7465 6e74 2062 7563 6b65 7420  existent bucket 
+0002ea20: 6173 2061 2073 6f75 7263 6527 293a 0a20  as a source'):. 
+0002ea30: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0002ea40: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
+0002ea50: 5f6c 6962 2e53 746f 7261 6765 2873 6f75  _lib.Storage(sou
+0002ea60: 7263 653d 6e6f 6e65 7869 7374 5f62 7563  rce=nonexist_buc
+0002ea70: 6b65 745f 7572 6c2e 666f 726d 6174 280a  ket_url.format(.
+0002ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ea90: 7261 6e64 6f6d 5f6e 616d 653d 6e6f 6e65  random_name=none
+0002eaa0: 7869 7374 5f62 7563 6b65 745f 6e61 6d65  xist_bucket_name
+0002eab0: 2929 0a0a 2020 2020 4070 7974 6573 742e  ))..    @pytest.
+0002eac0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+0002ead0: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
+0002eae0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+0002eaf0: 2770 7269 7661 7465 5f62 7563 6b65 7427  'private_bucket'
+0002eb00: 2c20 5b0a 2020 2020 2020 2020 6627 7333  , [.        f's3
+0002eb10: 3a2f 2f69 6d61 6765 6e65 7427 2c20 6627  ://imagenet', f'
+0002eb20: 6773 3a2f 2f69 6d61 6765 6e65 7427 2c0a  gs://imagenet',.
+0002eb30: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
+0002eb40: 6172 616d 2827 636f 733a 2f2f 7573 2d65  aram('cos://us-e
+0002eb50: 6173 742f 6275 636b 6574 3127 2c20 6d61  ast/bucket1', ma
+0002eb60: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+0002eb70: 6962 6d29 0a20 2020 205d 290a 2020 2020  ibm).    ]).    
+0002eb80: 6465 6620 7465 7374 5f70 7269 7661 7465  def test_private
+0002eb90: 5f62 7563 6b65 7428 7365 6c66 2c20 7072  _bucket(self, pr
+0002eba0: 6976 6174 655f 6275 636b 6574 293a 0a20  ivate_bucket):. 
+0002ebb0: 2020 2020 2020 2023 2041 7474 656d 7074         # Attempt
+0002ebc0: 7320 746f 2061 6363 6573 7320 7072 6976  s to access priv
+0002ebd0: 6174 6520 6275 636b 6574 7320 6e6f 7420  ate buckets not 
+0002ebe0: 6265 6c6f 6e67 696e 6720 746f 2074 6865  belonging to the
+0002ebf0: 2075 7365 722e 0a20 2020 2020 2020 2023   user..        #
+0002ec00: 2054 6865 7365 2062 7563 6b65 7473 2061   These buckets a
+0002ec10: 7265 206b 6e6f 776e 2074 6f20 6265 2070  re known to be p
+0002ec20: 7269 7661 7465 2c20 6275 7420 6d61 7920  rivate, but may 
+0002ec30: 6e65 6564 2074 6f20 6265 2075 7064 6174  need to be updat
+0002ec40: 6564 2069 660a 2020 2020 2020 2020 2320  ed if.        # 
+0002ec50: 7468 6579 2061 7265 2072 656d 6f76 6564  they are removed
+0002ec60: 2062 7920 7468 6569 7220 6f77 6e65 7273   by their owners
+0002ec70: 2e0a 2020 2020 2020 2020 7072 6976 6174  ..        privat
+0002ec80: 655f 6275 636b 6574 5f6e 616d 6520 3d20  e_bucket_name = 
+0002ec90: 7572 6c6c 6962 2e70 6172 7365 2e75 726c  urllib.parse.url
+0002eca0: 7370 6c69 7428 7072 6976 6174 655f 6275  split(private_bu
+0002ecb0: 636b 6574 292e 6e65 746c 6f63 2069 6620  cket).netloc if 
+0002ecc0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+0002ecd0: 7572 6c6c 6962 2e70 6172 7365 2e75 726c  urllib.parse.url
+0002ece0: 7370 6c69 7428 7072 6976 6174 655f 6275  split(private_bu
+0002ecf0: 636b 6574 292e 7363 6865 6d65 2021 3d20  cket).scheme != 
+0002ed00: 2763 6f73 2720 656c 7365 205c 0a20 2020  'cos' else \.   
+0002ed10: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0002ed20: 726c 6c69 622e 7061 7273 652e 7572 6c73  rllib.parse.urls
+0002ed30: 706c 6974 2870 7269 7661 7465 5f62 7563  plit(private_buc
+0002ed40: 6b65 7429 2e70 6174 682e 7374 7269 7028  ket).path.strip(
+0002ed50: 272f 2729 0a20 2020 2020 2020 2077 6974  '/').        wit
+0002ed60: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
+0002ed70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ed80: 2073 6b79 2e65 7863 6570 7469 6f6e 732e   sky.exceptions.
+0002ed90: 5374 6f72 6167 6542 7563 6b65 7447 6574  StorageBucketGet
+0002eda0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+0002edb0: 2020 2020 2020 206d 6174 6368 3d73 746f         match=sto
+0002edc0: 7261 6765 5f6c 6962 2e5f 4255 434b 4554  rage_lib._BUCKET
+0002edd0: 5f46 4149 4c5f 544f 5f43 4f4e 4e45 4354  _FAIL_TO_CONNECT
+0002ede0: 5f4d 4553 5341 4745 2e66 6f72 6d61 7428  _MESSAGE.format(
+0002edf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ee00: 2020 2020 206e 616d 653d 7072 6976 6174       name=privat
+0002ee10: 655f 6275 636b 6574 5f6e 616d 6529 293a  e_bucket_name)):
+0002ee20: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002ee30: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
+0002ee40: 6765 5f6c 6962 2e53 746f 7261 6765 2873  ge_lib.Storage(s
+0002ee50: 6f75 7263 653d 7072 6976 6174 655f 6275  ource=private_bu
+0002ee60: 636b 6574 290a 0a20 2020 2040 7079 7465  cket)..    @pyte
+0002ee70: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+0002ee80: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
+0002ee90: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+0002eea0: 7a65 2827 6578 745f 6275 636b 6574 5f66  ze('ext_bucket_f
+0002eeb0: 6978 7475 7265 2c20 7374 6f72 655f 7479  ixture, store_ty
+0002eec0: 7065 272c 0a20 2020 2020 2020 2020 2020  pe',.           
+0002eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eee0: 2020 5b28 2774 6d70 5f61 7773 636c 695f    [('tmp_awscli_
+0002eef0: 6275 636b 6574 272c 2073 746f 7261 6765  bucket', storage
+0002ef00: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+0002ef10: 3329 2c0a 2020 2020 2020 2020 2020 2020  3),.            
+0002ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ef30: 2020 2827 746d 705f 6773 7574 696c 5f62    ('tmp_gsutil_b
+0002ef40: 7563 6b65 7427 2c20 7374 6f72 6167 655f  ucket', storage_
+0002ef50: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002ef60: 5329 2c0a 2020 2020 2020 2020 2020 2020  S),.            
+0002ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ef80: 2020 7079 7465 7374 2e70 6172 616d 2827    pytest.param('
+0002ef90: 746d 705f 6962 6d5f 636f 735f 6275 636b  tmp_ibm_cos_buck
+0002efa0: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
+0002efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002efd0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002efe0: 6554 7970 652e 4942 4d2c 0a20 2020 2020  eType.IBM,.     
+0002eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f010: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+0002f020: 7374 2e6d 6172 6b2e 6962 6d29 2c0a 2020  st.mark.ibm),.  
 0002f030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f060: 2020 2020 2020 2827 7574 662d 3827 2929        ('utf-8'))
-0002f070: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002f080: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002f090: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002f0a0: 6b2e 7061 7261 6d65 7472 697a 6528 2769  k.parametrize('i
-0002f0b0: 6e76 616c 6964 5f6e 616d 655f 6c69 7374  nvalid_name_list
-0002f0c0: 2c20 7374 6f72 655f 7479 7065 272c 0a20  , store_type',. 
+0002f040: 2020 2020 2020 2020 2020 2020 7079 7465              pyte
+0002f050: 7374 2e70 6172 616d 2827 746d 705f 6177  st.param('tmp_aw
+0002f060: 7363 6c69 5f62 7563 6b65 745f 7232 272c  scli_bucket_r2',
+0002f070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f090: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002f0a0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002f0b0: 652e 5232 2c0a 2020 2020 2020 2020 2020  e.R2,.          
+0002f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f0e0: 2020 2020 2020 2020 2020 2020 5b28 4157              [(AW
-0002f0f0: 535f 494e 5641 4c49 445f 4e41 4d45 532c  S_INVALID_NAMES,
-0002f100: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0002f110: 7265 5479 7065 2e53 3329 2c0a 2020 2020  reType.S3),.    
-0002f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f130: 2020 2020 2020 2020 2020 2847 4353 5f49            (GCS_I
-0002f140: 4e56 414c 4944 5f4e 414d 4553 2c20 7374  NVALID_NAMES, st
-0002f150: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002f160: 7970 652e 4743 5329 2c0a 2020 2020 2020  ype.GCS),.      
-0002f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f180: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-0002f190: 6172 616d 2849 424d 5f49 4e56 414c 4944  aram(IBM_INVALID
-0002f1a0: 5f4e 414d 4553 2c0a 2020 2020 2020 2020  _NAMES,.        
-0002f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f1d0: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
-0002f1e0: 746f 7265 5479 7065 2e49 424d 2c0a 2020  toreType.IBM,.  
-0002f1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f210: 2020 2020 2020 2020 206d 6172 6b73 3d70           marks=p
-0002f220: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
-0002f230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f240: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0002f250: 7974 6573 742e 7061 7261 6d28 4157 535f  ytest.param(AWS_
-0002f260: 494e 5641 4c49 445f 4e41 4d45 532c 0a20  INVALID_NAMES,. 
-0002f270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f290: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0002f2a0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002f2b0: 5232 2c0a 2020 2020 2020 2020 2020 2020  R2,.            
-0002f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2d0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0002f2e0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0002f2f0: 2e63 6c6f 7564 666c 6172 6529 5d29 0a20  .cloudflare)]). 
-0002f300: 2020 2064 6566 2074 6573 745f 696e 7661     def test_inva
-0002f310: 6c69 645f 6e61 6d65 7328 7365 6c66 2c20  lid_names(self, 
-0002f320: 696e 7661 6c69 645f 6e61 6d65 5f6c 6973  invalid_name_lis
-0002f330: 742c 2073 746f 7265 5f74 7970 6529 3a0a  t, store_type):.
-0002f340: 2020 2020 2020 2020 2320 5573 6573 2061          # Uses a
-0002f350: 206c 6973 7420 696e 2074 6865 2073 6f75   list in the sou
-0002f360: 7263 6520 6669 656c 6420 746f 2073 7065  rce field to spe
-0002f370: 6369 6679 2061 2066 696c 6520 616e 6420  cify a file and 
-0002f380: 6120 6469 7265 6374 6f72 7920 746f 0a20  a directory to. 
-0002f390: 2020 2020 2020 2023 2062 6520 7570 6c6f         # be uplo
-0002f3a0: 6164 6564 2074 6f20 7468 6520 7374 6f72  aded to the stor
-0002f3b0: 6167 6520 6f62 6a65 6374 2e0a 2020 2020  age object..    
-0002f3c0: 2020 2020 666f 7220 6e61 6d65 2069 6e20      for name in 
-0002f3d0: 696e 7661 6c69 645f 6e61 6d65 5f6c 6973  invalid_name_lis
-0002f3e0: 743a 0a20 2020 2020 2020 2020 2020 2077  t:.            w
-0002f3f0: 6974 6820 7079 7465 7374 2e72 6169 7365  ith pytest.raise
-0002f400: 7328 736b 792e 6578 6365 7074 696f 6e73  s(sky.exceptions
-0002f410: 2e53 746f 7261 6765 4e61 6d65 4572 726f  .StorageNameErro
-0002f420: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0002f430: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-0002f440: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0002f450: 6f72 6167 6528 6e61 6d65 3d6e 616d 6529  orage(name=name)
-0002f460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f470: 2073 746f 7261 6765 5f6f 626a 2e61 6464   storage_obj.add
-0002f480: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
-0002f490: 6529 0a0a 2020 2020 4070 7974 6573 742e  e)..    @pytest.
-0002f4a0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-0002f4b0: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
-0002f4c0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-0002f4d0: 0a20 2020 2020 2020 2027 6769 7469 676e  .        'gitign
-0002f4e0: 6f72 655f 7374 7275 6374 7572 652c 2073  ore_structure, s
-0002f4f0: 746f 7265 5f74 7970 6527 2c0a 2020 2020  tore_type',.    
-0002f500: 2020 2020 5b28 4749 5449 474e 4f52 455f      [(GITIGNORE_
-0002f510: 5359 4e43 5f54 4553 545f 4449 525f 5354  SYNC_TEST_DIR_ST
-0002f520: 5255 4354 5552 452c 2073 746f 7261 6765  RUCTURE, storage
-0002f530: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002f540: 3329 2c0a 2020 2020 2020 2020 2028 4749  3),.         (GI
-0002f550: 5449 474e 4f52 455f 5359 4e43 5f54 4553  TIGNORE_SYNC_TES
-0002f560: 545f 4449 525f 5354 5255 4354 5552 452c  T_DIR_STRUCTURE,
-0002f570: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0002f580: 7265 5479 7065 2e47 4353 292c 0a20 2020  reType.GCS),.   
-0002f590: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
-0002f5a0: 616d 2847 4954 4947 4e4f 5245 5f53 594e  am(GITIGNORE_SYN
-0002f5b0: 435f 5445 5354 5f44 4952 5f53 5452 5543  C_TEST_DIR_STRUC
-0002f5c0: 5455 5245 2c0a 2020 2020 2020 2020 2020  TURE,.          
-0002f5d0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002f5e0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002f5f0: 652e 5232 2c0a 2020 2020 2020 2020 2020  e.R2,.          
-0002f600: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
-0002f610: 733d 7079 7465 7374 2e6d 6172 6b2e 636c  s=pytest.mark.cl
-0002f620: 6f75 6466 6c61 7265 295d 290a 2020 2020  oudflare)]).    
-0002f630: 6465 6620 7465 7374 5f65 7863 6c75 6465  def test_exclude
-0002f640: 645f 6669 6c65 5f63 6c6f 7564 5f73 746f  d_file_cloud_sto
-0002f650: 7261 6765 5f75 706c 6f61 645f 636f 7079  rage_upload_copy
-0002f660: 2873 656c 662c 2067 6974 6967 6e6f 7265  (self, gitignore
-0002f670: 5f73 7472 7563 7475 7265 2c0a 2020 2020  _structure,.    
-0002f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f6b0: 2073 746f 7265 5f74 7970 652c 0a20 2020   store_type,.   
-0002f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f6f0: 2020 746d 705f 6769 7469 676e 6f72 655f    tmp_gitignore_
-0002f700: 7374 6f72 6167 655f 6f62 6a29 3a0a 2020  storage_obj):.  
-0002f710: 2020 2020 2020 2320 7465 7374 7320 6966        # tests if
-0002f720: 2066 696c 6573 2069 6e63 6c75 6465 6420   files included 
-0002f730: 696e 202e 6769 7469 676e 6f72 6520 616e  in .gitignore an
-0002f740: 6420 2e67 6974 2f69 6e66 6f2f 6578 636c  d .git/info/excl
-0002f750: 7564 6520 6172 650a 2020 2020 2020 2020  ude are.        
-0002f760: 2320 6578 636c 7564 6564 2066 726f 6d20  # excluded from 
-0002f770: 6265 696e 6720 7472 616e 7366 6572 7265  being transferre
-0002f780: 6420 746f 2053 746f 7261 6765 0a0a 2020  d to Storage..  
-0002f790: 2020 2020 2020 746d 705f 6769 7469 676e        tmp_gitign
-0002f7a0: 6f72 655f 7374 6f72 6167 655f 6f62 6a2e  ore_storage_obj.
-0002f7b0: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-0002f7c0: 7479 7065 290a 0a20 2020 2020 2020 2075  type)..        u
-0002f7d0: 706c 6f61 645f 6669 6c65 5f6e 616d 6520  pload_file_name 
-0002f7e0: 3d20 2769 6e63 6c75 6465 6427 0a20 2020  = 'included'.   
-0002f7f0: 2020 2020 2023 2043 6f75 6e74 2074 6865       # Count the
-0002f800: 206e 756d 6265 7220 6f66 2066 696c 6573   number of files
-0002f810: 2077 6974 6820 7468 6520 6769 7665 6e20   with the given 
-0002f820: 6669 6c65 206e 616d 650a 2020 2020 2020  file name.      
-0002f830: 2020 7570 5f63 6d64 203d 2073 656c 662e    up_cmd = self.
-0002f840: 636c 695f 636f 756e 745f 6e61 6d65 5f69  cli_count_name_i
-0002f850: 6e5f 6275 636b 6574 2873 746f 7265 5f74  n_bucket(store_t
-0002f860: 7970 652c 205c 0a20 2020 2020 2020 2020  ype, \.         
-0002f870: 2020 2074 6d70 5f67 6974 6967 6e6f 7265     tmp_gitignore
-0002f880: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-0002f890: 652c 2066 696c 655f 6e61 6d65 3d75 706c  e, file_name=upl
-0002f8a0: 6f61 645f 6669 6c65 5f6e 616d 6529 0a20  oad_file_name). 
-0002f8b0: 2020 2020 2020 2067 6974 5f65 7863 6c75         git_exclu
-0002f8c0: 6465 5f63 6d64 203d 2073 656c 662e 636c  de_cmd = self.cl
-0002f8d0: 695f 636f 756e 745f 6e61 6d65 5f69 6e5f  i_count_name_in_
-0002f8e0: 6275 636b 6574 2873 746f 7265 5f74 7970  bucket(store_typ
-0002f8f0: 652c 205c 0a20 2020 2020 2020 2020 2020  e, \.           
-0002f900: 2074 6d70 5f67 6974 6967 6e6f 7265 5f73   tmp_gitignore_s
-0002f910: 746f 7261 6765 5f6f 626a 2e6e 616d 652c  torage_obj.name,
-0002f920: 2066 696c 655f 6e61 6d65 3d27 2e67 6974   file_name='.git
-0002f930: 2729 0a20 2020 2020 2020 2063 6e74 5f6e  ').        cnt_n
-0002f940: 756d 5f66 696c 655f 636d 6420 3d20 7365  um_file_cmd = se
-0002f950: 6c66 2e63 6c69 5f63 6f75 6e74 5f66 696c  lf.cli_count_fil
-0002f960: 655f 696e 5f62 7563 6b65 7428 0a20 2020  e_in_bucket(.   
-0002f970: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
-0002f980: 7970 652c 2074 6d70 5f67 6974 6967 6e6f  ype, tmp_gitigno
-0002f990: 7265 5f73 746f 7261 6765 5f6f 626a 2e6e  re_storage_obj.n
-0002f9a0: 616d 6529 0a0a 2020 2020 2020 2020 7570  ame)..        up
-0002f9b0: 5f6f 7574 7075 7420 3d20 7375 6270 726f  _output = subpro
-0002f9c0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002f9d0: 7428 7570 5f63 6d64 2c20 7368 656c 6c3d  t(up_cmd, shell=
-0002f9e0: 5472 7565 290a 2020 2020 2020 2020 6769  True).        gi
-0002f9f0: 745f 6578 636c 7564 655f 6f75 7470 7574  t_exclude_output
-0002fa00: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002fa10: 6563 6b5f 6f75 7470 7574 2867 6974 5f65  eck_output(git_e
-0002fa20: 7863 6c75 6465 5f63 6d64 2c0a 2020 2020  xclude_cmd,.    
-0002fa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fa60: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-0002fa70: 2020 2020 2063 6e74 5f6f 7574 7075 7420       cnt_output 
-0002fa80: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0002fa90: 636b 5f6f 7574 7075 7428 636e 745f 6e75  ck_output(cnt_nu
-0002faa0: 6d5f 6669 6c65 5f63 6d64 2c20 7368 656c  m_file_cmd, shel
-0002fab0: 6c3d 5472 7565 290a 0a20 2020 2020 2020  l=True)..       
-0002fac0: 2061 7373 6572 7420 2733 2720 696e 2075   assert '3' in u
-0002fad0: 705f 6f75 7470 7574 2e64 6563 6f64 6528  p_output.decode(
-0002fae0: 2775 7466 2d38 2729 2c20 5c0a 2020 2020  'utf-8'), \.    
-0002faf0: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
-0002fb00: 6573 2074 6f20 6265 2069 6e63 6c75 6465  es to be include
-0002fb10: 6420 6172 6520 6e6f 7420 636f 6d70 6c65  d are not comple
-0002fb20: 7465 6c79 2075 706c 6f61 6465 642e 270a  tely uploaded.'.
-0002fb30: 2020 2020 2020 2020 2320 3120 6973 2072          # 1 is r
-0002fb40: 6561 6420 6173 202e 6769 7469 676e 6f72  ead as .gitignor
-0002fb50: 6520 6973 2075 706c 6f61 6465 640a 2020  e is uploaded.  
-0002fb60: 2020 2020 2020 6173 7365 7274 2027 3127        assert '1'
-0002fb70: 2069 6e20 6769 745f 6578 636c 7564 655f   in git_exclude_
-0002fb80: 6f75 7470 7574 2e64 6563 6f64 6528 2775  output.decode('u
-0002fb90: 7466 2d38 2729 2c20 5c0a 2020 2020 2020  tf-8'), \.      
-0002fba0: 2020 2020 2020 2020 2027 2e67 6974 2064           '.git d
-0002fbb0: 6972 6563 746f 7279 2073 686f 756c 6420  irectory should 
-0002fbc0: 6e6f 7420 6265 2075 706c 6f61 6465 642e  not be uploaded.
-0002fbd0: 270a 2020 2020 2020 2020 2320 3420 6669  '.        # 4 fi
-0002fbe0: 6c65 7320 696e 636c 7564 6520 2e67 6974  les include .git
-0002fbf0: 6967 6e6f 7265 2c20 696e 636c 7564 6564  ignore, included
-0002fc00: 2e6c 6f67 2c20 696e 636c 7564 6564 2e74  .log, included.t
-0002fc10: 7874 2c20 696e 636c 7564 655f 6469 722f  xt, include_dir/
-0002fc20: 696e 636c 7564 6564 2e6c 6f67 0a20 2020  included.log.   
-0002fc30: 2020 2020 2061 7373 6572 7420 2734 2720       assert '4' 
-0002fc40: 696e 2063 6e74 5f6f 7574 7075 742e 6465  in cnt_output.de
-0002fc50: 636f 6465 2827 7574 662d 3827 292c 205c  code('utf-8'), \
-0002fc60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fc70: 2753 6f6d 6520 6974 656d 7320 6c69 7374  'Some items list
-0002fc80: 6564 2069 6e20 2e67 6974 6967 6e6f 7265  ed in .gitignore
-0002fc90: 2061 6e64 202e 6769 742f 696e 666f 2f65   and .git/info/e
-0002fca0: 7863 6c75 6465 2061 7265 206e 6f74 2065  xclude are not e
-0002fcb0: 7863 6c75 6465 642e 270a 0a20 2020 2040  xcluded.'..    @
-0002fcc0: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
-0002fcd0: 6d65 7472 697a 6528 2765 7874 5f62 7563  metrize('ext_buc
-0002fce0: 6b65 745f 6669 7874 7572 652c 2073 746f  ket_fixture, sto
-0002fcf0: 7265 5f74 7970 6527 2c0a 2020 2020 2020  re_type',.      
-0002fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd10: 2020 2020 2020 205b 2827 746d 705f 6177         [('tmp_aw
-0002fd20: 7363 6c69 5f62 7563 6b65 7427 2c20 7374  scli_bucket', st
-0002fd30: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002fd40: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
+0002f0e0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0002f0f0: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
+0002f100: 0a20 2020 2064 6566 2074 6573 745f 7570  .    def test_up
+0002f110: 6c6f 6164 5f74 6f5f 6578 6973 7469 6e67  load_to_existing
+0002f120: 5f62 7563 6b65 7428 7365 6c66 2c20 6578  _bucket(self, ex
+0002f130: 745f 6275 636b 6574 5f66 6978 7475 7265  t_bucket_fixture
+0002f140: 2c20 7265 7175 6573 742c 0a20 2020 2020  , request,.     
+0002f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f170: 2020 746d 705f 736f 7572 6365 2c20 7374    tmp_source, st
+0002f180: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
+0002f190: 2020 2023 2054 7269 6573 2075 706c 6f61     # Tries uploa
+0002f1a0: 6469 6e67 2065 7869 7374 696e 6720 6669  ding existing fi
+0002f1b0: 6c65 7320 746f 206e 6577 6c79 2063 7265  les to newly cre
+0002f1c0: 6174 6564 2062 7563 6b65 7420 286f 7574  ated bucket (out
+0002f1d0: 7369 6465 206f 660a 2020 2020 2020 2020  side of.        
+0002f1e0: 2320 736b 7929 2061 6e64 2076 6572 6966  # sky) and verif
+0002f1f0: 6965 7320 7468 6174 2066 696c 6573 2061  ies that files a
+0002f200: 7265 2077 7269 7474 656e 2e0a 2020 2020  re written..    
+0002f210: 2020 2020 6275 636b 6574 5f6e 616d 652c      bucket_name,
+0002f220: 205f 203d 2072 6571 7565 7374 2e67 6574   _ = request.get
+0002f230: 6669 7874 7572 6576 616c 7565 2865 7874  fixturevalue(ext
+0002f240: 5f62 7563 6b65 745f 6669 7874 7572 6529  _bucket_fixture)
+0002f250: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002f260: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
+0002f270: 6962 2e53 746f 7261 6765 286e 616d 653d  ib.Storage(name=
+0002f280: 6275 636b 6574 5f6e 616d 652c 2073 6f75  bucket_name, sou
+0002f290: 7263 653d 746d 705f 736f 7572 6365 290a  rce=tmp_source).
+0002f2a0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002f2b0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0002f2c0: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+0002f2d0: 2020 2023 2043 6865 636b 2069 6620 746d     # Check if tm
+0002f2e0: 705f 736f 7572 6365 2f74 6d70 2d66 696c  p_source/tmp-fil
+0002f2f0: 6520 6578 6973 7473 2069 6e20 7468 6520  e exists in the 
+0002f300: 6275 636b 6574 2075 7369 6e67 2061 7773  bucket using aws
+0002f310: 2063 6c69 0a20 2020 2020 2020 206f 7574   cli.        out
+0002f320: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+0002f330: 6563 6b5f 6f75 7470 7574 2873 656c 662e  eck_output(self.
+0002f340: 636c 695f 6c73 5f63 6d64 2873 746f 7265  cli_ls_cmd(store
+0002f350: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
+0002f360: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
+0002f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f380: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+0002f390: 3d54 7275 6529 0a20 2020 2020 2020 2061  =True).        a
+0002f3a0: 7373 6572 7420 2774 6d70 2d66 696c 6527  ssert 'tmp-file'
+0002f3b0: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
+0002f3c0: 7574 662d 3827 292c 205c 0a20 2020 2020  utf-8'), \.     
+0002f3d0: 2020 2020 2020 2027 4669 6c65 206e 6f74         'File not
+0002f3e0: 2066 6f75 6e64 2069 6e20 6275 636b 6574   found in bucket
+0002f3f0: 202d 206f 7574 7075 7420 7761 7320 3a20   - output was : 
+0002f400: 7b7d 272e 666f 726d 6174 286f 7574 2e64  {}'.format(out.d
+0002f410: 6563 6f64 650a 2020 2020 2020 2020 2020  ecode.          
+0002f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f450: 2020 2020 2020 2827 7574 662d 3827 2929        ('utf-8'))
+0002f460: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
+0002f470: 6b20 7379 6d6c 696e 6b73 202d 2073 796d  k symlinks - sym
+0002f480: 6c69 6e6b 7320 646f 6e27 7420 6765 7420  links don't get 
+0002f490: 636f 7069 6564 2062 7920 736b 7920 7374  copied by sky st
+0002f4a0: 6f72 6167 650a 2020 2020 2020 2020 6173  orage.        as
+0002f4b0: 7365 7274 2028 7061 7468 6c69 622e 5061  sert (pathlib.Pa
+0002f4c0: 7468 2874 6d70 5f73 6f75 7263 6529 202f  th(tmp_source) /
+0002f4d0: 2027 6369 7263 6c65 2d6c 696e 6b27 292e   'circle-link').
+0002f4e0: 6973 5f73 796d 6c69 6e6b 2829 2c20 280a  is_symlink(), (.
+0002f4f0: 2020 2020 2020 2020 2020 2020 2763 6972              'cir
+0002f500: 636c 652d 6c69 6e6b 2077 6173 206e 6f74  cle-link was not
+0002f510: 2066 6f75 6e64 2069 6e20 7468 6520 7570   found in the up
+0002f520: 6c6f 6164 2073 6f75 7263 6520 2d20 270a  load source - '.
+0002f530: 2020 2020 2020 2020 2020 2020 2761 7265              'are
+0002f540: 2074 6865 2074 6573 7420 6669 7874 7572   the test fixtur
+0002f550: 6573 2063 6f72 7265 6374 3f27 290a 2020  es correct?').  
+0002f560: 2020 2020 2020 6173 7365 7274 2027 6369        assert 'ci
+0002f570: 7263 6c65 2d6c 696e 6b27 206e 6f74 2069  rcle-link' not i
+0002f580: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
+0002f590: 662d 3827 292c 2028 0a20 2020 2020 2020  f-8'), (.       
+0002f5a0: 2020 2020 2027 5379 6d6c 696e 6b20 666f       'Symlink fo
+0002f5b0: 756e 6420 696e 2062 7563 6b65 7420 2d20  und in bucket - 
+0002f5c0: 6c73 206f 7574 7075 7420 7761 7320 3a20  ls output was : 
+0002f5d0: 7b7d 272e 666f 726d 6174 280a 2020 2020  {}'.format(.    
+0002f5e0: 2020 2020 2020 2020 2020 2020 6f75 742e              out.
+0002f5f0: 6465 636f 6465 2827 7574 662d 3827 2929  decode('utf-8'))
+0002f600: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
+0002f610: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
+0002f620: 746f 2063 6865 636b 2069 6620 7374 6f72  to check if stor
+0002f630: 6167 6520 6f62 6a65 6374 2065 7869 7374  age object exist
+0002f640: 7320 696e 2074 6865 206f 7574 7075 742e  s in the output.
+0002f650: 0a20 2020 2020 2020 2023 2049 7420 7368  .        # It sh
+0002f660: 6f75 6c64 206e 6f74 2065 7869 7374 2062  ould not exist b
+0002f670: 6563 6175 7365 2074 6865 2062 7563 6b65  ecause the bucke
+0002f680: 7420 7761 7320 6372 6561 7465 6420 6578  t was created ex
+0002f690: 7465 726e 616c 6c79 2e0a 2020 2020 2020  ternally..      
+0002f6a0: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
+0002f6b0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0002f6c0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0002f6d0: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
+0002f6e0: 2020 6173 7365 7274 2073 746f 7261 6765    assert storage
+0002f6f0: 5f6f 626a 2e6e 616d 6520 6e6f 7420 696e  _obj.name not in
+0002f700: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+0002f710: 2d38 2729 0a0a 2020 2020 4070 7974 6573  -8')..    @pytes
+0002f720: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+0002f730: 7461 636b 0a20 2020 2064 6566 2074 6573  tack.    def tes
+0002f740: 745f 636f 7079 5f6d 6f75 6e74 5f65 7869  t_copy_mount_exi
+0002f750: 7374 696e 675f 7374 6f72 6167 6528 7365  sting_storage(se
+0002f760: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+0002f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f780: 2020 2020 2020 2020 2020 2020 2074 6d70               tmp
+0002f790: 5f63 6f70 795f 6d6e 745f 6578 6973 7469  _copy_mnt_existi
+0002f7a0: 6e67 5f73 746f 7261 6765 5f6f 626a 293a  ng_storage_obj):
+0002f7b0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0002f7c0: 6573 2061 2062 7563 6b65 7420 7769 7468  es a bucket with
+0002f7d0: 206e 6f20 736f 7572 6365 2069 6e20 4d4f   no source in MO
+0002f7e0: 554e 5420 6d6f 6465 2028 656d 7074 7920  UNT mode (empty 
+0002f7f0: 6275 636b 6574 292c 2061 6e64 0a20 2020  bucket), and.   
+0002f800: 2020 2020 2023 2074 6865 6e20 7472 6965       # then trie
+0002f810: 7320 746f 206c 6f61 6420 7468 6520 7361  s to load the sa
+0002f820: 6d65 2073 746f 7261 6765 2069 6e20 434f  me storage in CO
+0002f830: 5059 206d 6f64 652e 0a20 2020 2020 2020  PY mode..       
+0002f840: 2074 6d70 5f63 6f70 795f 6d6e 745f 6578   tmp_copy_mnt_ex
+0002f850: 6973 7469 6e67 5f73 746f 7261 6765 5f6f  isting_storage_o
+0002f860: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+0002f870: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002f880: 7065 2e53 3329 0a20 2020 2020 2020 2073  pe.S3).        s
+0002f890: 746f 7261 6765 5f6e 616d 6520 3d20 746d  torage_name = tm
+0002f8a0: 705f 636f 7079 5f6d 6e74 5f65 7869 7374  p_copy_mnt_exist
+0002f8b0: 696e 675f 7374 6f72 6167 655f 6f62 6a2e  ing_storage_obj.
+0002f8c0: 6e61 6d65 0a0a 2020 2020 2020 2020 2320  name..        # 
+0002f8d0: 4368 6563 6b20 6073 6b79 2073 746f 7261  Check `sky stora
+0002f8e0: 6765 206c 7360 2074 6f20 656e 7375 7265  ge ls` to ensure
+0002f8f0: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+0002f900: 6578 6973 7473 0a20 2020 2020 2020 206f  exists.        o
+0002f910: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+0002f920: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
+0002f930: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+0002f940: 276c 7327 5d29 2e64 6563 6f64 6528 2775  'ls']).decode('u
+0002f950: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
+0002f960: 7373 6572 7420 7374 6f72 6167 655f 6e61  ssert storage_na
+0002f970: 6d65 2069 6e20 6f75 742c 2066 2753 746f  me in out, f'Sto
+0002f980: 7261 6765 207b 7374 6f72 6167 655f 6e61  rage {storage_na
+0002f990: 6d65 7d20 6e6f 7420 666f 756e 6420 696e  me} not found in
+0002f9a0: 2073 6b79 2073 746f 7261 6765 206c 732e   sky storage ls.
+0002f9b0: 270a 0a20 2020 2040 7079 7465 7374 2e6d  '..    @pytest.m
+0002f9c0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0002f9d0: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
+0002f9e0: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
+0002f9f0: 7374 6f72 655f 7479 7065 272c 205b 0a20  store_type', [. 
+0002fa00: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
+0002fa10: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
+0002fa20: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002fa30: 7265 5479 7065 2e47 4353 2c0a 2020 2020  reType.GCS,.    
+0002fa40: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
+0002fa50: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
+0002fa60: 7265 5479 7065 2e49 424d 2c20 6d61 726b  reType.IBM, mark
+0002fa70: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
+0002fa80: 6d29 2c0a 2020 2020 2020 2020 7079 7465  m),.        pyte
+0002fa90: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
+0002faa0: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
+0002fab0: 322c 206d 6172 6b73 3d70 7974 6573 742e  2, marks=pytest.
+0002fac0: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
+0002fad0: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
+0002fae0: 7465 7374 5f6c 6973 745f 736f 7572 6365  test_list_source
+0002faf0: 2873 656c 662c 2074 6d70 5f6c 6f63 616c  (self, tmp_local
+0002fb00: 5f6c 6973 745f 7374 6f72 6167 655f 6f62  _list_storage_ob
+0002fb10: 6a2c 2073 746f 7265 5f74 7970 6529 3a0a  j, store_type):.
+0002fb20: 2020 2020 2020 2020 2320 5573 6573 2061          # Uses a
+0002fb30: 206c 6973 7420 696e 2074 6865 2073 6f75   list in the sou
+0002fb40: 7263 6520 6669 656c 6420 746f 2073 7065  rce field to spe
+0002fb50: 6369 6679 2061 2066 696c 6520 616e 6420  cify a file and 
+0002fb60: 6120 6469 7265 6374 6f72 7920 746f 0a20  a directory to. 
+0002fb70: 2020 2020 2020 2023 2062 6520 7570 6c6f         # be uplo
+0002fb80: 6164 6564 2074 6f20 7468 6520 7374 6f72  aded to the stor
+0002fb90: 6167 6520 6f62 6a65 6374 2e0a 2020 2020  age object..    
+0002fba0: 2020 2020 746d 705f 6c6f 6361 6c5f 6c69      tmp_local_li
+0002fbb0: 7374 5f73 746f 7261 6765 5f6f 626a 2e61  st_storage_obj.a
+0002fbc0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
+0002fbd0: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
+0002fbe0: 4368 6563 6b20 6966 2074 6d70 2d66 696c  Check if tmp-fil
+0002fbf0: 6520 6578 6973 7473 2069 6e20 7468 6520  e exists in the 
+0002fc00: 6275 636b 6574 2072 6f6f 7420 7573 696e  bucket root usin
+0002fc10: 6720 636c 690a 2020 2020 2020 2020 6f75  g cli.        ou
+0002fc20: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+0002fc30: 6865 636b 5f6f 7574 7075 7428 7365 6c66  heck_output(self
+0002fc40: 2e63 6c69 5f6c 735f 636d 6428 0a20 2020  .cli_ls_cmd(.   
+0002fc50: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
+0002fc60: 7970 652c 2074 6d70 5f6c 6f63 616c 5f6c  ype, tmp_local_l
+0002fc70: 6973 745f 7374 6f72 6167 655f 6f62 6a2e  ist_storage_obj.
+0002fc80: 6e61 6d65 292c 0a20 2020 2020 2020 2020  name),.         
+0002fc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fca0: 2020 2020 2020 2020 2020 2020 2073 6865               she
+0002fcb0: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
+0002fcc0: 2061 7373 6572 7420 2774 6d70 2d66 696c   assert 'tmp-fil
+0002fcd0: 6527 2069 6e20 6f75 742e 6465 636f 6465  e' in out.decode
+0002fce0: 2827 7574 662d 3827 292c 205c 0a20 2020  ('utf-8'), \.   
+0002fcf0: 2020 2020 2020 2020 2027 4669 6c65 206e           'File n
+0002fd00: 6f74 2066 6f75 6e64 2069 6e20 6275 636b  ot found in buck
+0002fd10: 6574 202d 206f 7574 7075 7420 7761 7320  et - output was 
+0002fd20: 3a20 7b7d 272e 666f 726d 6174 286f 7574  : {}'.format(out
+0002fd30: 2e64 6563 6f64 650a 2020 2020 2020 2020  .decode.        
+0002fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd60: 2020 2020 2020 2028 2774 6d70 5f67 7375         ('tmp_gsu
-0002fd70: 7469 6c5f 6275 636b 6574 272c 2073 746f  til_bucket', sto
-0002fd80: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002fd90: 7065 2e47 4353 292c 0a20 2020 2020 2020  pe.GCS),.       
-0002fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fdb0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0002fdc0: 7261 6d28 2774 6d70 5f61 7773 636c 695f  ram('tmp_awscli_
-0002fdd0: 6275 636b 6574 5f72 3227 2c0a 2020 2020  bucket_r2',.    
-0002fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fe00: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
-0002fe10: 6962 2e53 746f 7265 5479 7065 2e52 322c  ib.StoreType.R2,
-0002fe20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fe40: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
-0002fe50: 733d 7079 7465 7374 2e6d 6172 6b2e 636c  s=pytest.mark.cl
-0002fe60: 6f75 6466 6c61 7265 295d 290a 2020 2020  oudflare)]).    
-0002fe70: 6465 6620 7465 7374 5f65 7874 6572 6e61  def test_externa
-0002fe80: 6c6c 795f 6372 6561 7465 645f 6275 636b  lly_created_buck
-0002fe90: 6574 5f6d 6f75 6e74 5f77 6974 686f 7574  et_mount_without
-0002fea0: 5f73 6f75 7263 6528 0a20 2020 2020 2020  _source(.       
-0002feb0: 2020 2020 2073 656c 662c 2065 7874 5f62       self, ext_b
-0002fec0: 7563 6b65 745f 6669 7874 7572 652c 2072  ucket_fixture, r
-0002fed0: 6571 7565 7374 2c20 7374 6f72 655f 7479  equest, store_ty
-0002fee0: 7065 293a 0a20 2020 2020 2020 2023 204e  pe):.        # N
-0002fef0: 6f6e 2d73 6b79 206d 616e 6167 6564 2062  on-sky managed b
-0002ff00: 7563 6b65 7473 2862 7563 6b65 7473 2063  uckets(buckets c
-0002ff10: 7265 6174 6564 206f 7574 7369 6465 206f  reated outside o
-0002ff20: 6620 536b 7970 696c 6f74 2043 4c49 290a  f Skypilot CLI).
-0002ff30: 2020 2020 2020 2020 2320 6172 6520 616c          # are al
-0002ff40: 6c6f 7765 6420 746f 2062 6520 4d4f 554e  lowed to be MOUN
-0002ff50: 5465 6420 6279 2073 7065 6369 6679 696e  Ted by specifyin
-0002ff60: 6720 7468 6520 5552 4920 6f66 2074 6865  g the URI of the
-0002ff70: 2062 7563 6b65 7420 746f 0a20 2020 2020   bucket to.     
-0002ff80: 2020 2023 2073 6f75 7263 6520 6669 656c     # source fiel
-0002ff90: 6420 6f6e 6c79 2e20 5768 656e 2069 7420  d only. When it 
-0002ffa0: 6973 2061 7474 656d 7074 6564 2062 7920  is attempted by 
-0002ffb0: 7370 6563 6966 7969 6e67 2074 6865 206e  specifying the n
-0002ffc0: 616d 6520 6f66 0a20 2020 2020 2020 2023  ame of.        #
-0002ffd0: 2074 6865 2062 7563 6b65 7420 6f6e 6c79   the bucket only
-0002ffe0: 2c20 6974 2073 686f 756c 6420 6572 726f  , it should erro
-0002fff0: 7220 6f75 742e 0a20 2020 2020 2020 2023  r out..        #
-00030000: 0a20 2020 2020 2020 2023 2054 4f44 4f28  .        # TODO(
-00030010: 646f 796f 756e 6729 3a20 4164 6420 7465  doyoung): Add te
-00030020: 7374 2066 6f72 2049 424d 2043 4f53 2e20  st for IBM COS. 
-00030030: 4375 7272 656e 746c 792c 2074 6869 7320  Currently, this 
-00030040: 6973 2062 6c6f 636b 6564 0a20 2020 2020  is blocked.     
-00030050: 2020 2023 2061 7320 7263 6c6f 6e65 2075     # as rclone u
-00030060: 7365 6420 746f 2069 6e74 6572 6163 7420  sed to interact 
-00030070: 7769 7468 2049 424d 2043 4f53 2064 6f65  with IBM COS doe
-00030080: 7320 6e6f 7420 7375 7070 6f72 7420 6665  s not support fe
-00030090: 6174 7572 6520 746f 0a20 2020 2020 2020  ature to.       
-000300a0: 2023 2063 7265 6174 6520 6120 6275 636b   # create a buck
-000300b0: 6574 2c20 616e 6420 7468 6520 6962 6d63  et, and the ibmc
-000300c0: 6c6f 7564 2043 4c49 2069 7320 6e6f 7420  loud CLI is not 
-000300d0: 7375 7070 6f72 7465 6420 696e 2053 6b79  supported in Sky
-000300e0: 7069 6c6f 742e 0a20 2020 2020 2020 2023  pilot..        #
-000300f0: 2045 6974 6865 7220 6f66 2074 6865 2066   Either of the f
-00030100: 6561 7475 7265 2069 7320 6e65 6365 7373  eature is necess
-00030110: 6172 7920 746f 2073 696d 756c 6174 6520  ary to simulate 
-00030120: 616e 2065 7874 6572 6e61 6c20 6275 636b  an external buck
-00030130: 6574 0a20 2020 2020 2020 2023 2063 7265  et.        # cre
-00030140: 6174 696f 6e20 666f 7220 4942 4d20 434f  ation for IBM CO
-00030150: 532e 0a20 2020 2020 2020 2023 2068 7474  S..        # htt
-00030160: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-00030170: 736b 7970 696c 6f74 2d6f 7267 2f73 6b79  skypilot-org/sky
-00030180: 7069 6c6f 742f 7075 6c6c 2f31 3936 362f  pilot/pull/1966/
-00030190: 6669 6c65 7323 7231 3235 3334 3339 3833  files#r125343983
-000301a0: 370a 0a20 2020 2020 2020 2065 7874 5f62  7..        ext_b
-000301b0: 7563 6b65 745f 6e61 6d65 2c20 6578 745f  ucket_name, ext_
-000301c0: 6275 636b 6574 5f75 7269 203d 2072 6571  bucket_uri = req
-000301d0: 7565 7374 2e67 6574 6669 7874 7572 6576  uest.getfixturev
-000301e0: 616c 7565 280a 2020 2020 2020 2020 2020  alue(.          
-000301f0: 2020 6578 745f 6275 636b 6574 5f66 6978    ext_bucket_fix
-00030200: 7475 7265 290a 2020 2020 2020 2020 2320  ture).        # 
-00030210: 696e 7661 6c69 6420 7370 6563 0a20 2020  invalid spec.   
-00030220: 2020 2020 2077 6974 6820 7079 7465 7374       with pytest
-00030230: 2e72 6169 7365 7328 736b 792e 6578 6365  .raises(sky.exce
-00030240: 7074 696f 6e73 2e53 746f 7261 6765 5370  ptions.StorageSp
-00030250: 6563 4572 726f 7229 2061 7320 653a 0a20  ecError) as e:. 
-00030260: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-00030270: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
-00030280: 5f6c 6962 2e53 746f 7261 6765 280a 2020  _lib.Storage(.  
-00030290: 2020 2020 2020 2020 2020 2020 2020 6e61                na
-000302a0: 6d65 3d65 7874 5f62 7563 6b65 745f 6e61  me=ext_bucket_na
-000302b0: 6d65 2c20 6d6f 6465 3d73 746f 7261 6765  me, mode=storage
-000302c0: 5f6c 6962 2e53 746f 7261 6765 4d6f 6465  _lib.StorageMode
-000302d0: 2e4d 4f55 4e54 290a 2020 2020 2020 2020  .MOUNT).        
-000302e0: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
-000302f0: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-00030300: 7479 7065 290a 0a20 2020 2020 2020 2061  type)..        a
-00030310: 7373 6572 7420 2741 7474 656d 7074 6564  ssert 'Attempted
-00030320: 2074 6f20 6d6f 756e 7420 6120 6e6f 6e2d   to mount a non-
-00030330: 736b 7920 6d61 6e61 6765 6420 6275 636b  sky managed buck
-00030340: 6574 2720 696e 2073 7472 2865 290a 0a20  et' in str(e).. 
-00030350: 2020 2020 2020 2023 2076 616c 6964 2073         # valid s
-00030360: 7065 630a 2020 2020 2020 2020 7374 6f72  pec.        stor
-00030370: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-00030380: 655f 6c69 622e 5374 6f72 6167 6528 736f  e_lib.Storage(so
-00030390: 7572 6365 3d65 7874 5f62 7563 6b65 745f  urce=ext_bucket_
-000303a0: 7572 692c 0a20 2020 2020 2020 2020 2020  uri,.           
-000303b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000303c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000303d0: 6f64 653d 7374 6f72 6167 655f 6c69 622e  ode=storage_lib.
-000303e0: 5374 6f72 6167 654d 6f64 652e 4d4f 554e  StorageMode.MOUN
-000303f0: 5429 0a20 2020 2020 2020 2068 616e 646c  T).        handl
-00030400: 6520 3d20 676c 6f62 616c 5f75 7365 725f  e = global_user_
-00030410: 7374 6174 652e 6765 745f 6861 6e64 6c65  state.get_handle
-00030420: 5f66 726f 6d5f 7374 6f72 6167 655f 6e61  _from_storage_na
-00030430: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
-00030440: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-00030450: 290a 2020 2020 2020 2020 6966 2068 616e  ).        if han
-00030460: 646c 653a 0a20 2020 2020 2020 2020 2020  dle:.           
-00030470: 2073 746f 7261 6765 5f6f 626a 2e64 656c   storage_obj.del
-00030480: 6574 6528 290a 0a20 2020 2040 7079 7465  ete()..    @pyte
-00030490: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-000304a0: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
-000304b0: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
-000304c0: 7a65 2827 7265 6769 6f6e 272c 205b 0a20  ze('region', [. 
-000304d0: 2020 2020 2020 2027 6170 2d6e 6f72 7468         'ap-north
-000304e0: 6561 7374 2d31 272c 2027 6170 2d6e 6f72  east-1', 'ap-nor
-000304f0: 7468 6561 7374 2d32 272c 2027 6170 2d6e  theast-2', 'ap-n
-00030500: 6f72 7468 6561 7374 2d33 272c 2027 6170  ortheast-3', 'ap
-00030510: 2d73 6f75 7468 2d31 272c 0a20 2020 2020  -south-1',.     
-00030520: 2020 2027 6170 2d73 6f75 7468 6561 7374     'ap-southeast
-00030530: 2d31 272c 2027 6170 2d73 6f75 7468 6561  -1', 'ap-southea
-00030540: 7374 2d32 272c 2027 6575 2d63 656e 7472  st-2', 'eu-centr
-00030550: 616c 2d31 272c 2027 6575 2d6e 6f72 7468  al-1', 'eu-north
-00030560: 2d31 272c 0a20 2020 2020 2020 2027 6575  -1',.        'eu
-00030570: 2d77 6573 742d 3127 2c20 2765 752d 7765  -west-1', 'eu-we
-00030580: 7374 2d32 272c 2027 6575 2d77 6573 742d  st-2', 'eu-west-
-00030590: 3327 2c20 2773 612d 6561 7374 2d31 272c  3', 'sa-east-1',
-000305a0: 2027 7573 2d65 6173 742d 3127 2c0a 2020   'us-east-1',.  
-000305b0: 2020 2020 2020 2775 732d 6561 7374 2d32        'us-east-2
-000305c0: 272c 2027 7573 2d77 6573 742d 3127 2c20  ', 'us-west-1', 
-000305d0: 2775 732d 7765 7374 2d32 270a 2020 2020  'us-west-2'.    
-000305e0: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
-000305f0: 6177 735f 7265 6769 6f6e 7328 7365 6c66  aws_regions(self
-00030600: 2c20 746d 705f 6c6f 6361 6c5f 7374 6f72  , tmp_local_stor
-00030610: 6167 655f 6f62 6a2c 2072 6567 696f 6e29  age_obj, region)
-00030620: 3a0a 2020 2020 2020 2020 2320 5468 6973  :.        # This
-00030630: 2074 6573 7473 2063 7265 6174 696f 6e20   tests creation 
-00030640: 616e 6420 7570 6c6f 6164 2074 6f20 6275  and upload to bu
-00030650: 636b 6574 2069 6e20 616c 6c20 4157 5320  cket in all AWS 
-00030660: 7333 2072 6567 696f 6e73 0a20 2020 2020  s3 regions.     
-00030670: 2020 2023 2054 6f20 7465 7374 2066 756c     # To test ful
-00030680: 6c20 6675 6e63 7469 6f6e 616c 6974 792c  l functionality,
-00030690: 2075 7365 2074 6573 745f 7370 6f74 5f73   use test_spot_s
-000306a0: 746f 7261 6765 2061 626f 7665 2e0a 2020  torage above..  
-000306b0: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
-000306c0: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
-000306d0: 746f 7265 5479 7065 2e53 330a 2020 2020  toreType.S3.    
-000306e0: 2020 2020 746d 705f 6c6f 6361 6c5f 7374      tmp_local_st
-000306f0: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
-00030700: 6f72 6528 7374 6f72 655f 7479 7065 2c20  ore(store_type, 
-00030710: 7265 6769 6f6e 3d72 6567 696f 6e29 0a20  region=region). 
-00030720: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
-00030730: 6d65 203d 2074 6d70 5f6c 6f63 616c 5f73  me = tmp_local_s
-00030740: 746f 7261 6765 5f6f 626a 2e6e 616d 650a  torage_obj.name.
-00030750: 0a20 2020 2020 2020 2023 2043 6f6e 6669  .        # Confi
-00030760: 726d 2074 6861 7420 7468 6520 6275 636b  rm that the buck
-00030770: 6574 2077 6173 2063 7265 6174 6564 2069  et was created i
-00030780: 6e20 7468 6520 636f 7272 6563 7420 7265  n the correct re
-00030790: 6769 6f6e 0a20 2020 2020 2020 2072 6567  gion.        reg
-000307a0: 696f 6e5f 636d 6420 3d20 7365 6c66 2e63  ion_cmd = self.c
-000307b0: 6c69 5f72 6567 696f 6e5f 636d 6428 7374  li_region_cmd(st
-000307c0: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
-000307d0: 5f6e 616d 6529 0a20 2020 2020 2020 206f  _name).        o
-000307e0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-000307f0: 6368 6563 6b5f 6f75 7470 7574 2872 6567  check_output(reg
-00030800: 696f 6e5f 636d 642c 2073 6865 6c6c 3d54  ion_cmd, shell=T
-00030810: 7275 6529 0a20 2020 2020 2020 206f 7574  rue).        out
-00030820: 7075 7420 3d20 6f75 742e 6465 636f 6465  put = out.decode
-00030830: 2827 7574 662d 3827 290a 2020 2020 2020  ('utf-8').      
-00030840: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
-00030850: 745f 7265 6769 6f6e 203d 2072 6567 696f  t_region = regio
-00030860: 6e0a 2020 2020 2020 2020 6966 2072 6567  n.        if reg
-00030870: 696f 6e20 3d3d 2027 7573 2d65 6173 742d  ion == 'us-east-
-00030880: 3127 3a0a 2020 2020 2020 2020 2020 2020  1':.            
-00030890: 6578 7065 6374 6564 5f6f 7574 7075 745f  expected_output_
-000308a0: 7265 6769 6f6e 203d 2027 4e6f 6e65 2720  region = 'None' 
-000308b0: 2023 2075 732d 6561 7374 2d31 2069 7320   # us-east-1 is 
-000308c0: 7468 6520 6465 6661 756c 7420 7265 6769  the default regi
-000308d0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-000308e0: 7420 6578 7065 6374 6564 5f6f 7574 7075  t expected_outpu
-000308f0: 745f 7265 6769 6f6e 2069 6e20 6f75 742e  t_region in out.
-00030900: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
-00030910: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
-00030920: 2742 7563 6b65 7420 7761 7320 6e6f 7420  'Bucket was not 
-00030930: 666f 756e 6420 696e 2072 6567 696f 6e20  found in region 
-00030940: 7b72 6567 696f 6e7d 202d 2027 0a20 2020  {region} - '.   
-00030950: 2020 2020 2020 2020 2066 276f 7574 7075           f'outpu
-00030960: 7420 6f66 207b 7265 6769 6f6e 5f63 6d64  t of {region_cmd
-00030970: 7d20 7761 733a 207b 6f75 7470 7574 7d27  } was: {output}'
-00030980: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
-00030990: 636b 2069 6620 746d 705f 736f 7572 6365  ck if tmp_source
-000309a0: 2f74 6d70 2d66 696c 6520 6578 6973 7473  /tmp-file exists
-000309b0: 2069 6e20 7468 6520 6275 636b 6574 2075   in the bucket u
-000309c0: 7369 6e67 2063 6c69 0a20 2020 2020 2020  sing cli.       
-000309d0: 206c 735f 636d 6420 3d20 7365 6c66 2e63   ls_cmd = self.c
-000309e0: 6c69 5f6c 735f 636d 6428 7374 6f72 655f  li_ls_cmd(store_
-000309f0: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-00030a00: 6529 0a20 2020 2020 2020 206f 7574 203d  e).        out =
-00030a10: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00030a20: 6b5f 6f75 7470 7574 286c 735f 636d 642c  k_output(ls_cmd,
-00030a30: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-00030a40: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
-00030a50: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-00030a60: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00030a70: 2027 746d 702d 6669 6c65 2720 696e 206f   'tmp-file' in o
-00030a80: 7574 7075 742c 2028 0a20 2020 2020 2020  utput, (.       
-00030a90: 2020 2020 2066 2774 6d70 2d66 696c 6520       f'tmp-file 
-00030aa0: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
-00030ab0: 6b65 7420 2d20 6f75 7470 7574 206f 6620  ket - output of 
-00030ac0: 7b6c 735f 636d 647d 2077 6173 3a20 7b6f  {ls_cmd} was: {o
-00030ad0: 7574 7075 747d 2729 0a0a 2020 2020 4070  utput}')..    @p
-00030ae0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-00030af0: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-00030b00: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-00030b10: 7472 697a 6528 2772 6567 696f 6e27 2c20  trize('region', 
-00030b20: 5b0a 2020 2020 2020 2020 276e 6f72 7468  [.        'north
-00030b30: 616d 6572 6963 612d 6e6f 7274 6865 6173  america-northeas
-00030b40: 7431 272c 2027 6e6f 7274 6861 6d65 7269  t1', 'northameri
-00030b50: 6361 2d6e 6f72 7468 6561 7374 3227 2c20  ca-northeast2', 
-00030b60: 2775 732d 6365 6e74 7261 6c31 272c 0a20  'us-central1',. 
-00030b70: 2020 2020 2020 2027 7573 2d65 6173 7431         'us-east1
-00030b80: 272c 2027 7573 2d65 6173 7434 272c 2027  ', 'us-east4', '
-00030b90: 7573 2d65 6173 7435 272c 2027 7573 2d73  us-east5', 'us-s
-00030ba0: 6f75 7468 3127 2c20 2775 732d 7765 7374  outh1', 'us-west
-00030bb0: 3127 2c20 2775 732d 7765 7374 3227 2c0a  1', 'us-west2',.
-00030bc0: 2020 2020 2020 2020 2775 732d 7765 7374          'us-west
-00030bd0: 3327 2c20 2775 732d 7765 7374 3427 2c20  3', 'us-west4', 
-00030be0: 2773 6f75 7468 616d 6572 6963 612d 6561  'southamerica-ea
-00030bf0: 7374 3127 2c20 2773 6f75 7468 616d 6572  st1', 'southamer
-00030c00: 6963 612d 7765 7374 3127 2c0a 2020 2020  ica-west1',.    
-00030c10: 2020 2020 2765 7572 6f70 652d 6365 6e74      'europe-cent
-00030c20: 7261 6c32 272c 2027 6575 726f 7065 2d6e  ral2', 'europe-n
-00030c30: 6f72 7468 3127 2c20 2765 7572 6f70 652d  orth1', 'europe-
-00030c40: 736f 7574 6877 6573 7431 272c 2027 6575  southwest1', 'eu
-00030c50: 726f 7065 2d77 6573 7431 272c 0a20 2020  rope-west1',.   
-00030c60: 2020 2020 2027 6575 726f 7065 2d77 6573       'europe-wes
-00030c70: 7432 272c 2027 6575 726f 7065 2d77 6573  t2', 'europe-wes
-00030c80: 7433 272c 2027 6575 726f 7065 2d77 6573  t3', 'europe-wes
-00030c90: 7434 272c 2027 6575 726f 7065 2d77 6573  t4', 'europe-wes
-00030ca0: 7436 272c 0a20 2020 2020 2020 2027 6575  t6',.        'eu
-00030cb0: 726f 7065 2d77 6573 7438 272c 2027 6575  rope-west8', 'eu
-00030cc0: 726f 7065 2d77 6573 7439 272c 2027 6575  rope-west9', 'eu
-00030cd0: 726f 7065 2d77 6573 7431 3027 2c20 2765  rope-west10', 'e
-00030ce0: 7572 6f70 652d 7765 7374 3132 272c 0a20  urope-west12',. 
-00030cf0: 2020 2020 2020 2027 6173 6961 2d65 6173         'asia-eas
-00030d00: 7431 272c 2027 6173 6961 2d65 6173 7432  t1', 'asia-east2
-00030d10: 272c 2027 6173 6961 2d6e 6f72 7468 6561  ', 'asia-northea
-00030d20: 7374 3127 2c20 2761 7369 612d 6e6f 7274  st1', 'asia-nort
-00030d30: 6865 6173 7432 272c 0a20 2020 2020 2020  heast2',.       
-00030d40: 2027 6173 6961 2d6e 6f72 7468 6561 7374   'asia-northeast
-00030d50: 3327 2c20 2761 7369 612d 736f 7574 6865  3', 'asia-southe
-00030d60: 6173 7431 272c 2027 6173 6961 2d73 6f75  ast1', 'asia-sou
-00030d70: 7468 3127 2c20 2761 7369 612d 736f 7574  th1', 'asia-sout
-00030d80: 6832 272c 0a20 2020 2020 2020 2027 6173  h2',.        'as
-00030d90: 6961 2d73 6f75 7468 6561 7374 3227 2c20  ia-southeast2', 
-00030da0: 276d 652d 6365 6e74 7261 6c31 272c 2027  'me-central1', '
-00030db0: 6d65 2d63 656e 7472 616c 3227 2c20 276d  me-central2', 'm
-00030dc0: 652d 7765 7374 3127 2c0a 2020 2020 2020  e-west1',.      
-00030dd0: 2020 2761 7573 7472 616c 6961 2d73 6f75    'australia-sou
-00030de0: 7468 6561 7374 3127 2c20 2761 7573 7472  theast1', 'austr
-00030df0: 616c 6961 2d73 6f75 7468 6561 7374 3227  alia-southeast2'
-00030e00: 2c20 2761 6672 6963 612d 736f 7574 6831  , 'africa-south1
-00030e10: 270a 2020 2020 5d29 0a20 2020 2064 6566  '.    ]).    def
-00030e20: 2074 6573 745f 6763 735f 7265 6769 6f6e   test_gcs_region
-00030e30: 7328 7365 6c66 2c20 746d 705f 6c6f 6361  s(self, tmp_loca
-00030e40: 6c5f 7374 6f72 6167 655f 6f62 6a2c 2072  l_storage_obj, r
-00030e50: 6567 696f 6e29 3a0a 2020 2020 2020 2020  egion):.        
-00030e60: 2320 5468 6973 2074 6573 7473 2063 7265  # This tests cre
-00030e70: 6174 696f 6e20 616e 6420 7570 6c6f 6164  ation and upload
-00030e80: 2074 6f20 6275 636b 6574 2069 6e20 616c   to bucket in al
-00030e90: 6c20 4743 5320 7265 6769 6f6e 730a 2020  l GCS regions.  
-00030ea0: 2020 2020 2020 2320 546f 2074 6573 7420        # To test 
-00030eb0: 6675 6c6c 2066 756e 6374 696f 6e61 6c69  full functionali
-00030ec0: 7479 2c20 7573 6520 7465 7374 5f73 706f  ty, use test_spo
-00030ed0: 745f 7374 6f72 6167 6520 6162 6f76 652e  t_storage above.
-00030ee0: 0a20 2020 2020 2020 2073 746f 7265 5f74  .        store_t
-00030ef0: 7970 6520 3d20 7374 6f72 6167 655f 6c69  ype = storage_li
-00030f00: 622e 5374 6f72 6554 7970 652e 4743 530a  b.StoreType.GCS.
-00030f10: 2020 2020 2020 2020 746d 705f 6c6f 6361          tmp_loca
-00030f20: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6164  l_storage_obj.ad
-00030f30: 645f 7374 6f72 6528 7374 6f72 655f 7479  d_store(store_ty
-00030f40: 7065 2c20 7265 6769 6f6e 3d72 6567 696f  pe, region=regio
-00030f50: 6e29 0a20 2020 2020 2020 2062 7563 6b65  n).        bucke
-00030f60: 745f 6e61 6d65 203d 2074 6d70 5f6c 6f63  t_name = tmp_loc
-00030f70: 616c 5f73 746f 7261 6765 5f6f 626a 2e6e  al_storage_obj.n
-00030f80: 616d 650a 0a20 2020 2020 2020 2023 2043  ame..        # C
-00030f90: 6f6e 6669 726d 2074 6861 7420 7468 6520  onfirm that the 
-00030fa0: 6275 636b 6574 2077 6173 2063 7265 6174  bucket was creat
-00030fb0: 6564 2069 6e20 7468 6520 636f 7272 6563  ed in the correc
-00030fc0: 7420 7265 6769 6f6e 0a20 2020 2020 2020  t region.       
-00030fd0: 2072 6567 696f 6e5f 636d 6420 3d20 7365   region_cmd = se
-00030fe0: 6c66 2e63 6c69 5f72 6567 696f 6e5f 636d  lf.cli_region_cm
-00030ff0: 6428 7374 6f72 655f 7479 7065 2c20 6275  d(store_type, bu
-00031000: 636b 6574 5f6e 616d 6529 0a20 2020 2020  cket_name).     
-00031010: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-00031020: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-00031030: 2872 6567 696f 6e5f 636d 642c 2073 6865  (region_cmd, she
-00031040: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-00031050: 206f 7574 7075 7420 3d20 6f75 742e 6465   output = out.de
-00031060: 636f 6465 2827 7574 662d 3827 290a 2020  code('utf-8').  
-00031070: 2020 2020 2020 6173 7365 7274 2072 6567        assert reg
-00031080: 696f 6e20 696e 206f 7574 2e64 6563 6f64  ion in out.decod
-00031090: 6528 2775 7466 2d38 2729 2c20 280a 2020  e('utf-8'), (.  
-000310a0: 2020 2020 2020 2020 2020 6627 4275 636b            f'Buck
-000310b0: 6574 2077 6173 206e 6f74 2066 6f75 6e64  et was not found
-000310c0: 2069 6e20 7265 6769 6f6e 207b 7265 6769   in region {regi
-000310d0: 6f6e 7d20 2d20 270a 2020 2020 2020 2020  on} - '.        
-000310e0: 2020 2020 6627 6f75 7470 7574 206f 6620      f'output of 
-000310f0: 7b72 6567 696f 6e5f 636d 647d 2077 6173  {region_cmd} was
-00031100: 3a20 7b6f 7574 7075 747d 2729 0a0a 2020  : {output}')..  
-00031110: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
-00031120: 2074 6d70 5f73 6f75 7263 652f 746d 702d   tmp_source/tmp-
-00031130: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
-00031140: 6865 2062 7563 6b65 7420 7573 696e 6720  he bucket using 
-00031150: 636c 690a 2020 2020 2020 2020 6c73 5f63  cli.        ls_c
-00031160: 6d64 203d 2073 656c 662e 636c 695f 6c73  md = self.cli_ls
-00031170: 5f63 6d64 2873 746f 7265 5f74 7970 652c  _cmd(store_type,
-00031180: 2062 7563 6b65 745f 6e61 6d65 290a 2020   bucket_name).  
-00031190: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
-000311a0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-000311b0: 7075 7428 6c73 5f63 6d64 2c20 7368 656c  put(ls_cmd, shel
-000311c0: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
-000311d0: 6f75 7470 7574 203d 206f 7574 2e64 6563  output = out.dec
-000311e0: 6f64 6528 2775 7466 2d38 2729 0a20 2020  ode('utf-8').   
-000311f0: 2020 2020 2061 7373 6572 7420 2774 6d70       assert 'tmp
-00031200: 2d66 696c 6527 2069 6e20 6f75 7470 7574  -file' in output
-00031210: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00031220: 6627 746d 702d 6669 6c65 206e 6f74 2066  f'tmp-file not f
-00031230: 6f75 6e64 2069 6e20 6275 636b 6574 202d  ound in bucket -
-00031240: 206f 7574 7075 7420 6f66 207b 6c73 5f63   output of {ls_c
-00031250: 6d64 7d20 7761 733a 207b 6f75 7470 7574  md} was: {output
-00031260: 7d27 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  }')...# --------
-00031270: 2d2d 2054 6573 7469 6e67 2059 414d 4c20  -- Testing YAML 
-00031280: 5370 6563 7320 2d2d 2d2d 2d2d 2d2d 2d2d  Specs ----------
-00031290: 0a23 204f 7572 2073 6b79 2073 746f 7261  .# Our sky stora
-000312a0: 6765 2072 6571 7569 7265 7320 6372 6564  ge requires cred
-000312b0: 656e 7469 616c 7320 746f 2063 6865 636b  entials to check
-000312c0: 2074 6865 2062 7563 6b65 7420 6578 6973   the bucket exis
-000312d0: 7461 6e63 6520 7768 656e 0a23 206c 6f61  tance when.# loa
-000312e0: 6469 6e67 2061 2074 6173 6b20 6672 6f6d  ding a task from
-000312f0: 2074 6865 2079 616d 6c20 6669 6c65 2c20   the yaml file, 
-00031300: 736f 2077 6520 6361 6e6e 6f74 206d 616b  so we cannot mak
-00031310: 6520 6974 2061 2075 6e69 7420 7465 7374  e it a unit test
-00031320: 2e0a 636c 6173 7320 5465 7374 5961 6d6c  ..class TestYaml
-00031330: 5370 6563 733a 0a20 2020 2023 2054 4f44  Specs:.    # TOD
-00031340: 4f28 7a68 7775 293a 2041 6464 2074 6573  O(zhwu): Add tes
-00031350: 7420 666f 7220 6074 6f5f 7961 6d6c 5f63  t for `to_yaml_c
-00031360: 6f6e 6669 6760 2066 6f72 2074 6865 2053  onfig` for the S
-00031370: 746f 7261 6765 206f 626a 6563 742e 0a20  torage object.. 
-00031380: 2020 2023 2020 5765 2073 686f 756c 6420     #  We should 
-00031390: 6e6f 7420 7573 6520 6065 7861 6d70 6c65  not use `example
-000313a0: 732f 7374 6f72 6167 655f 6465 6d6f 2e79  s/storage_demo.y
-000313b0: 616d 6c60 2068 6572 652c 2073 696e 6365  aml` here, since
-000313c0: 2069 7420 7265 7175 6972 6573 0a20 2020   it requires.   
-000313d0: 2023 2020 7573 6572 7320 746f 2065 6e73   #  users to ens
-000313e0: 7572 6520 6275 636b 6574 206e 616d 6573  ure bucket names
-000313f0: 2074 6f20 6e6f 7420 6578 6973 7420 616e   to not exist an
-00031400: 642f 6f72 2062 6520 756e 6971 7565 2e0a  d/or be unique..
-00031410: 2020 2020 5f54 4553 545f 5941 4d4c 5f50      _TEST_YAML_P
-00031420: 4154 4853 203d 205b 0a20 2020 2020 2020  ATHS = [.       
-00031430: 2027 6578 616d 706c 6573 2f6d 696e 696d   'examples/minim
-00031440: 616c 2e79 616d 6c27 2c20 2765 7861 6d70  al.yaml', 'examp
-00031450: 6c65 732f 6d61 6e61 6765 645f 7370 6f74  les/managed_spot
-00031460: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00031470: 2765 7861 6d70 6c65 732f 7573 696e 675f  'examples/using_
-00031480: 6669 6c65 5f6d 6f75 6e74 732e 7961 6d6c  file_mounts.yaml
-00031490: 272c 2027 6578 616d 706c 6573 2f72 6573  ', 'examples/res
-000314a0: 6e65 745f 6170 702e 7961 6d6c 272c 0a20  net_app.yaml',. 
-000314b0: 2020 2020 2020 2027 6578 616d 706c 6573         'examples
-000314c0: 2f6d 756c 7469 5f68 6f73 746e 616d 652e  /multi_hostname.
-000314d0: 7961 6d6c 270a 2020 2020 5d0a 0a20 2020  yaml'.    ]..   
-000314e0: 2064 6566 205f 6973 5f64 6963 745f 7375   def _is_dict_su
-000314f0: 6273 6574 2873 656c 662c 2064 312c 2064  bset(self, d1, d
-00031500: 3229 3a0a 2020 2020 2020 2020 2222 2243  2):.        """C
-00031510: 6865 636b 2069 6620 6431 2069 7320 7468  heck if d1 is th
-00031520: 6520 7375 6273 6574 206f 6620 6432 2e22  e subset of d2."
-00031530: 2222 0a20 2020 2020 2020 2066 6f72 206b  "".        for k
-00031540: 2c20 7620 696e 2064 312e 6974 656d 7328  , v in d1.items(
-00031550: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00031560: 6620 6b20 6e6f 7420 696e 2064 323a 0a20  f k not in d2:. 
-00031570: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00031580: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-00031590: 6c69 7374 2920 6f72 2069 7369 6e73 7461  list) or isinsta
-000315a0: 6e63 6528 762c 2064 6963 7429 3a0a 2020  nce(v, dict):.  
-000315b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315c0: 2020 6173 7365 7274 206c 656e 2876 2920    assert len(v) 
-000315d0: 3d3d 2030 2c20 286b 2c20 7629 0a20 2020  == 0, (k, v).   
-000315e0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-000315f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00031600: 2020 2020 2020 2061 7373 6572 7420 4661         assert Fa
-00031610: 6c73 652c 2028 6b2c 2076 290a 2020 2020  lse, (k, v).    
-00031620: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00031630: 6e73 7461 6e63 6528 762c 2064 6963 7429  nstance(v, dict)
-00031640: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00031650: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00031660: 6e63 6528 6432 5b6b 5d2c 2064 6963 7429  nce(d2[k], dict)
-00031670: 2c20 286b 2c20 762c 2064 3229 0a20 2020  , (k, v, d2).   
-00031680: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00031690: 662e 5f69 735f 6469 6374 5f73 7562 7365  f._is_dict_subse
-000316a0: 7428 762c 2064 325b 6b5d 290a 2020 2020  t(v, d2[k]).    
-000316b0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-000316c0: 6e73 7461 6e63 6528 762c 2073 7472 293a  nstance(v, str):
-000316d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000316e0: 2069 6620 6b20 3d3d 2027 6163 6365 6c65   if k == 'accele
-000316f0: 7261 746f 7273 273a 0a20 2020 2020 2020  rators':.       
-00031700: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00031710: 6f75 7263 6573 203d 2073 6b79 2e52 6573  ources = sky.Res
-00031720: 6f75 7263 6573 2829 0a20 2020 2020 2020  ources().       
-00031730: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00031740: 6f75 7263 6573 2e5f 7365 745f 6163 6365  ources._set_acce
-00031750: 6c65 7261 746f 7273 2876 2c20 4e6f 6e65  lerators(v, None
-00031760: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00031770: 2020 2020 2020 6173 7365 7274 2072 6573        assert res
-00031780: 6f75 7263 6573 2e61 6363 656c 6572 6174  ources.accelerat
-00031790: 6f72 7320 3d3d 2064 325b 6b5d 2c20 286b  ors == d2[k], (k
-000317a0: 2c20 762c 2064 3229 0a20 2020 2020 2020  , v, d2).       
-000317b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000317c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000317d0: 2020 2061 7373 6572 7420 762e 6c6f 7765     assert v.lowe
-000317e0: 7228 2920 3d3d 2064 325b 6b5d 2e6c 6f77  r() == d2[k].low
-000317f0: 6572 2829 2c20 286b 2c20 762c 2064 325b  er(), (k, v, d2[
-00031800: 6b5d 290a 2020 2020 2020 2020 2020 2020  k]).            
-00031810: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00031820: 2020 2020 2020 6173 7365 7274 2076 203d        assert v =
-00031830: 3d20 6432 5b6b 5d2c 2028 6b2c 2076 2c20  = d2[k], (k, v, 
-00031840: 6432 5b6b 5d29 0a0a 2020 2020 6465 6620  d2[k])..    def 
-00031850: 5f63 6865 636b 5f65 7175 6976 616c 656e  _check_equivalen
-00031860: 7428 7365 6c66 2c20 7961 6d6c 5f70 6174  t(self, yaml_pat
-00031870: 6829 3a0a 2020 2020 2020 2020 2222 2243  h):.        """C
-00031880: 6865 636b 2069 6620 7468 6520 7961 6d6c  heck if the yaml
-00031890: 2069 7320 6571 7569 7661 6c65 6e74 2061   is equivalent a
-000318a0: 6674 6572 206c 6f61 6420 616e 6420 6475  fter load and du
-000318b0: 6d70 2061 6761 696e 2e22 2222 0a20 2020  mp again.""".   
-000318c0: 2020 2020 206f 7269 6769 6e5f 7461 736b       origin_task
-000318d0: 5f63 6f6e 6669 6720 3d20 636f 6d6d 6f6e  _config = common
-000318e0: 5f75 7469 6c73 2e72 6561 645f 7961 6d6c  _utils.read_yaml
-000318f0: 2879 616d 6c5f 7061 7468 290a 0a20 2020  (yaml_path)..   
-00031900: 2020 2020 2074 6173 6b20 3d20 736b 792e       task = sky.
-00031910: 5461 736b 2e66 726f 6d5f 7961 6d6c 2879  Task.from_yaml(y
-00031920: 616d 6c5f 7061 7468 290a 2020 2020 2020  aml_path).      
-00031930: 2020 6e65 775f 7461 736b 5f63 6f6e 6669    new_task_confi
-00031940: 6720 3d20 7461 736b 2e74 6f5f 7961 6d6c  g = task.to_yaml
-00031950: 5f63 6f6e 6669 6728 290a 2020 2020 2020  _config().      
-00031960: 2020 2320 6431 203c 3d20 6432 0a20 2020    # d1 <= d2.   
-00031970: 2020 2020 2070 7269 6e74 286f 7269 6769       print(origi
-00031980: 6e5f 7461 736b 5f63 6f6e 6669 672c 206e  n_task_config, n
-00031990: 6577 5f74 6173 6b5f 636f 6e66 6967 290a  ew_task_config).
-000319a0: 2020 2020 2020 2020 7365 6c66 2e5f 6973          self._is
-000319b0: 5f64 6963 745f 7375 6273 6574 286f 7269  _dict_subset(ori
-000319c0: 6769 6e5f 7461 736b 5f63 6f6e 6669 672c  gin_task_config,
-000319d0: 206e 6577 5f74 6173 6b5f 636f 6e66 6967   new_task_config
-000319e0: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
-000319f0: 6c6f 6164 5f64 756d 705f 7961 6d6c 5f63  load_dump_yaml_c
-00031a00: 6f6e 6669 675f 6571 7569 7661 6c65 6e74  onfig_equivalent
-00031a10: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00031a20: 2222 2254 6573 7420 6966 2074 6865 2079  """Test if the y
-00031a30: 616d 6c20 636f 6e66 6967 2069 7320 6571  aml config is eq
-00031a40: 7569 7661 6c65 6e74 2061 6674 6572 206c  uivalent after l
-00031a50: 6f61 6420 616e 6420 6475 6d70 2061 6761  oad and dump aga
-00031a60: 696e 2e22 2222 0a20 2020 2020 2020 2070  in.""".        p
-00031a70: 6174 686c 6962 2e50 6174 6828 277e 2f64  athlib.Path('~/d
-00031a80: 6174 6173 6574 7327 292e 6578 7061 6e64  atasets').expand
-00031a90: 7573 6572 2829 2e6d 6b64 6972 2865 7869  user().mkdir(exi
-00031aa0: 7374 5f6f 6b3d 5472 7565 290a 2020 2020  st_ok=True).    
-00031ab0: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
-00031ac0: 2827 7e2f 746d 7066 696c 6527 292e 6578  ('~/tmpfile').ex
-00031ad0: 7061 6e64 7573 6572 2829 2e74 6f75 6368  panduser().touch
-00031ae0: 2829 0a20 2020 2020 2020 2070 6174 686c  ().        pathl
-00031af0: 6962 2e50 6174 6828 277e 2f2e 7373 6827  ib.Path('~/.ssh'
-00031b00: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
-00031b10: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
-00031b20: 7565 290a 2020 2020 2020 2020 7061 7468  ue).        path
-00031b30: 6c69 622e 5061 7468 2827 7e2f 2e73 7368  lib.Path('~/.ssh
-00031b40: 2f69 645f 7273 612e 7075 6227 292e 6578  /id_rsa.pub').ex
-00031b50: 7061 6e64 7573 6572 2829 2e74 6f75 6368  panduser().touch
-00031b60: 2829 0a20 2020 2020 2020 2070 6174 686c  ().        pathl
-00031b70: 6962 2e50 6174 6828 277e 2f74 6d70 2d77  ib.Path('~/tmp-w
-00031b80: 6f72 6b64 6972 2729 2e65 7870 616e 6475  orkdir').expandu
-00031b90: 7365 7228 292e 6d6b 6469 7228 6578 6973  ser().mkdir(exis
-00031ba0: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
-00031bb0: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
-00031bc0: 277e 2f44 6f77 6e6c 6f61 6473 2f74 7075  '~/Downloads/tpu
-00031bd0: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
-00031be0: 6d6b 6469 7228 7061 7265 6e74 733d 5472  mkdir(parents=Tr
-00031bf0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-00031c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031c20: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00031c30: 7869 7374 5f6f 6b3d 5472 7565 290a 2020  xist_ok=True).  
-00031c40: 2020 2020 2020 666f 7220 7961 6d6c 5f70        for yaml_p
-00031c50: 6174 6820 696e 2073 656c 662e 5f54 4553  ath in self._TES
-00031c60: 545f 5941 4d4c 5f50 4154 4853 3a0a 2020  T_YAML_PATHS:.  
-00031c70: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00031c80: 6368 6563 6b5f 6571 7569 7661 6c65 6e74  check_equivalent
-00031c90: 2879 616d 6c5f 7061 7468 290a 0a0a 2320  (yaml_path)...# 
-00031ca0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-00031cb0: 6e67 204d 756c 7469 706c 6520 4163 6365  ng Multiple Acce
-00031cc0: 6c65 7261 746f 7273 202d 2d2d 2d2d 2d2d  lerators -------
-00031cd0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00031ce0: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-00031cf0: 2320 466c 7569 6473 7461 636b 2064 6f65  # Fluidstack doe
-00031d00: 7320 6e6f 7420 7375 7070 6f72 7420 4b38  s not support K8
-00031d10: 3020 6770 7573 2066 6f72 206e 6f77 0a40  0 gpus for now.@
-00031d20: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
-00031d30: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
-00031d40: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
-00031d50: 2073 7570 706f 7274 204b 3830 2067 7075   support K80 gpu
-00031d60: 730a 6465 6620 7465 7374 5f6d 756c 7469  s.def test_multi
-00031d70: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
-00031d80: 5f6f 7264 6572 6564 2829 3a0a 2020 2020  _ordered():.    
-00031d90: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00031da0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00031db0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00031dc0: 2020 2020 276d 756c 7469 706c 652d 6163      'multiple-ac
-00031dd0: 6365 6c65 7261 746f 7273 2d6f 7264 6572  celerators-order
-00031de0: 6564 272c 0a20 2020 2020 2020 205b 0a20  ed',.        [. 
-00031df0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00031e00: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00031e10: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00031e20: 7961 6d6c 732f 7465 7374 5f6d 756c 7469  yamls/test_multi
-00031e30: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
-00031e40: 5f6f 7264 6572 6564 2e79 616d 6c20 7c20  _ordered.yaml | 
-00031e50: 6772 6570 2022 5573 696e 6720 7573 6572  grep "Using user
-00031e60: 2d73 7065 6369 6669 6564 2061 6363 656c  -specified accel
-00031e70: 6572 6174 6f72 7320 6c69 7374 2227 2c0a  erators list"',.
-00031e80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00031e90: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00031ea0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00031eb0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00031ec0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00031ed0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00031ee0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00031ef0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00031f00: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-00031f10: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00031f20: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00031f30: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-00031f40: 7461 636b 2020 2320 466c 7569 6473 7461  tack  # Fluidsta
-00031f50: 636b 2068 6173 206c 6f77 2061 7661 696c  ck has low avail
-00031f60: 6162 696c 6974 7920 666f 7220 5434 2047  ability for T4 G
-00031f70: 5055 730a 4070 7974 6573 742e 6d61 726b  PUs.@pytest.mark
-00031f80: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
-00031f90: 2320 5061 7065 7273 7061 6365 2064 6f65  # Paperspace doe
-00031fa0: 7320 6e6f 7420 7375 7070 6f72 7420 5434  s not support T4
-00031fb0: 2047 5055 730a 6465 6620 7465 7374 5f6d   GPUs.def test_m
-00031fc0: 756c 7469 706c 655f 6163 6365 6c65 7261  ultiple_accelera
-00031fd0: 746f 7273 5f6f 7264 6572 6564 5f77 6974  tors_ordered_wit
-00031fe0: 685f 6465 6661 756c 7428 293a 0a20 2020  h_default():.   
-00031ff0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00032000: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00032010: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00032020: 2020 2020 2027 6d75 6c74 6970 6c65 2d61       'multiple-a
-00032030: 6363 656c 6572 6174 6f72 732d 6f72 6465  ccelerators-orde
-00032040: 7265 6427 2c0a 2020 2020 2020 2020 5b0a  red',.        [.
-00032050: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00032060: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00032070: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00032080: 5f79 616d 6c73 2f74 6573 745f 6d75 6c74  _yamls/test_mult
-00032090: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
-000320a0: 735f 6f72 6465 7265 645f 7769 7468 5f64  s_ordered_with_d
-000320b0: 6566 6175 6c74 2e79 616d 6c20 7c20 6772  efault.yaml | gr
-000320c0: 6570 2022 5573 696e 6720 7573 6572 2d73  ep "Using user-s
-000320d0: 7065 6369 6669 6564 2061 6363 656c 6572  pecified acceler
-000320e0: 6174 6f72 7320 6c69 7374 2227 2c0a 2020  ators list"',.  
-000320f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00032100: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00032110: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00032120: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-00032130: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-00032140: 2020 6627 736b 7920 7374 6174 7573 207b    f'sky status {
-00032150: 6e61 6d65 7d20 7c20 6772 6570 2053 706f  name} | grep Spo
-00032160: 7427 2c0a 2020 2020 2020 2020 5d2c 0a20  t',.        ],. 
-00032170: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00032180: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00032190: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-000321a0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-000321b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-000321c0: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
-000321d0: 7374 6163 6b20 6861 7320 6c6f 7720 6176  stack has low av
-000321e0: 6169 6c61 6269 6c69 7479 2066 6f72 2054  ailability for T
-000321f0: 3420 4750 5573 0a40 7079 7465 7374 2e6d  4 GPUs.@pytest.m
-00032200: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
-00032210: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
-00032220: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00032230: 2054 3420 4750 5573 0a64 6566 2074 6573   T4 GPUs.def tes
-00032240: 745f 6d75 6c74 6970 6c65 5f61 6363 656c  t_multiple_accel
-00032250: 6572 6174 6f72 735f 756e 6f72 6465 7265  erators_unordere
-00032260: 6428 293a 0a20 2020 206e 616d 6520 3d20  d():.    name = 
-00032270: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00032280: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00032290: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
-000322a0: 6c74 6970 6c65 2d61 6363 656c 6572 6174  ltiple-accelerat
-000322b0: 6f72 732d 756e 6f72 6465 7265 6427 2c0a  ors-unordered',.
-000322c0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-000322d0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000322e0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-000322f0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00032300: 2f74 6573 745f 6d75 6c74 6970 6c65 5f61  /test_multiple_a
-00032310: 6363 656c 6572 6174 6f72 735f 756e 6f72  ccelerators_unor
-00032320: 6465 7265 642e 7961 6d6c 272c 0a20 2020  dered.yaml',.   
-00032330: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00032340: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00032350: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00032360: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00032370: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-00032380: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00032390: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000323a0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-000323b0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000323c0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-000323d0: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
-000323e0: 6473 7461 636b 2068 6173 206c 6f77 2061  dstack has low a
-000323f0: 7661 696c 6162 696c 6974 7920 666f 7220  vailability for 
-00032400: 5434 2047 5055 730a 4070 7974 6573 742e  T4 GPUs.@pytest.
-00032410: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
-00032420: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
-00032430: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00032440: 7420 5434 2047 5055 730a 6465 6620 7465  t T4 GPUs.def te
-00032450: 7374 5f6d 756c 7469 706c 655f 6163 6365  st_multiple_acce
-00032460: 6c65 7261 746f 7273 5f75 6e6f 7264 6572  lerators_unorder
-00032470: 6564 5f77 6974 685f 6465 6661 756c 7428  ed_with_default(
-00032480: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00032490: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-000324a0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-000324b0: 7428 0a20 2020 2020 2020 2027 6d75 6c74  t(.        'mult
-000324c0: 6970 6c65 2d61 6363 656c 6572 6174 6f72  iple-accelerator
-000324d0: 732d 756e 6f72 6465 7265 6427 2c0a 2020  s-unordered',.  
-000324e0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000324f0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00032500: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
-00032510: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-00032520: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
-00032530: 656c 6572 6174 6f72 735f 756e 6f72 6465  elerators_unorde
-00032540: 7265 645f 7769 7468 5f64 6566 6175 6c74  red_with_default
-00032550: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00032560: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00032570: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-00032580: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00032590: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-000325a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000325b0: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-000325c0: 7c20 6772 6570 2053 706f 7427 2c0a 2020  | grep Spot',.  
-000325d0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-000325e0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-000325f0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00032600: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00032610: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00032620: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-00032630: 6b20 2023 2052 6571 7569 7265 7320 6f74  k  # Requires ot
-00032640: 6865 7220 636c 6f75 6473 2074 6f20 6265  her clouds to be
-00032650: 2065 6e61 626c 6564 0a64 6566 2074 6573   enabled.def tes
-00032660: 745f 6d75 6c74 6970 6c65 5f72 6573 6f75  t_multiple_resou
-00032670: 7263 6573 2829 3a0a 2020 2020 6e61 6d65  rces():.    name
-00032680: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00032690: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-000326a0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-000326b0: 276d 756c 7469 706c 652d 7265 736f 7572  'multiple-resour
-000326c0: 6365 7327 2c0a 2020 2020 2020 2020 5b0a  ces',.        [.
-000326d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000326e0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000326f0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00032700: 5f79 616d 6c73 2f74 6573 745f 6d75 6c74  _yamls/test_mult
-00032710: 6970 6c65 5f72 6573 6f75 7263 6573 2e79  iple_resources.y
-00032720: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00032730: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00032740: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00032750: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00032760: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00032770: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00032780: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00032790: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-000327a0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-000327b0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-000327c0: 2d2d 2d20 536b 7920 4265 6e63 686d 6172  --- Sky Benchmar
-000327d0: 6b20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  k ----------.@py
-000327e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-000327f0: 6964 7374 6163 6b20 2023 2052 6571 7569  idstack  # Requi
-00032800: 7265 7320 6f74 6865 7220 636c 6f75 6473  res other clouds
-00032810: 2074 6f20 6265 2065 6e61 626c 6564 0a40   to be enabled.@
-00032820: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
-00032830: 6170 6572 7370 6163 6520 2023 2052 6571  aperspace  # Req
-00032840: 7569 7265 7320 6f74 6865 7220 636c 6f75  uires other clou
-00032850: 6473 2074 6f20 6265 2065 6e61 626c 6564  ds to be enabled
-00032860: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00032870: 5f6b 7562 6572 6e65 7465 730a 6465 6620  _kubernetes.def 
-00032880: 7465 7374 5f73 6b79 5f62 656e 6368 2867  test_sky_bench(g
-00032890: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-000328a0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-000328b0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000328c0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-000328d0: 7374 280a 2020 2020 2020 2020 2773 6b79  st(.        'sky
-000328e0: 2d62 656e 6368 272c 0a20 2020 2020 2020  -bench',.       
-000328f0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00032900: 2773 6b79 2062 656e 6368 206c 6175 6e63  'sky bench launc
-00032910: 6820 2d79 202d 6220 7b6e 616d 657d 202d  h -y -b {name} -
-00032920: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00032930: 636c 6f75 647d 202d 6930 2074 6573 7473  cloud} -i0 tests
-00032940: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00032950: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00032960: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
-00032970: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00032980: 6627 736b 7920 6265 6e63 6820 7368 6f77  f'sky bench show
-00032990: 207b 6e61 6d65 7d20 7c20 6772 6570 2073   {name} | grep s
-000329a0: 6b79 2d62 656e 6368 2d7b 6e61 6d65 7d20  ky-bench-{name} 
-000329b0: 7c20 6772 6570 2046 494e 4953 4845 4427  | grep FINISHED'
-000329c0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-000329d0: 2020 2020 2066 2773 6b79 2062 656e 6368       f'sky bench
-000329e0: 2064 6f77 6e20 7b6e 616d 657d 202d 793b   down {name} -y;
-000329f0: 2073 6b79 2062 656e 6368 2064 656c 6574   sky bench delet
-00032a00: 6520 7b6e 616d 657d 202d 7927 2c0a 2020  e {name} -y',.  
-00032a10: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00032a20: 7465 7374 2874 6573 7429 0a              test(test).
+0002fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fd70: 2020 2020 2020 2020 2827 7574 662d 3827          ('utf-8'
+0002fd80: 2929 0a0a 2020 2020 2020 2020 2320 4368  ))..        # Ch
+0002fd90: 6563 6b20 6966 2074 6d70 2d66 696c 6520  eck if tmp-file 
+0002fda0: 6578 6973 7473 2069 6e20 7468 6520 6275  exists in the bu
+0002fdb0: 636b 6574 2f74 6d70 2d73 6f75 7263 6520  cket/tmp-source 
+0002fdc0: 7573 696e 6720 636c 690a 2020 2020 2020  using cli.      
+0002fdd0: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
+0002fde0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0002fdf0: 7365 6c66 2e63 6c69 5f6c 735f 636d 6428  self.cli_ls_cmd(
+0002fe00: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002fe10: 7265 5f74 7970 652c 2074 6d70 5f6c 6f63  re_type, tmp_loc
+0002fe20: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
+0002fe30: 6f62 6a2e 6e61 6d65 2c20 2774 6d70 2d73  obj.name, 'tmp-s
+0002fe40: 6f75 7263 652f 2729 2c0a 2020 2020 2020  ource/'),.      
+0002fe50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe70: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+0002fe80: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
+0002fe90: 6669 6c65 2720 696e 206f 7574 2e64 6563  file' in out.dec
+0002fea0: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
+0002feb0: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
+0002fec0: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
+0002fed0: 7563 6b65 7420 2d20 6f75 7470 7574 2077  ucket - output w
+0002fee0: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
+0002fef0: 6f75 742e 6465 636f 6465 0a20 2020 2020  out.decode.     
+0002ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff30: 2020 2020 2020 2020 2020 2028 2775 7466             ('utf
+0002ff40: 2d38 2729 290a 0a20 2020 2040 7079 7465  -8'))..    @pyte
+0002ff50: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+0002ff60: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
+0002ff70: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+0002ff80: 7a65 2827 696e 7661 6c69 645f 6e61 6d65  ze('invalid_name
+0002ff90: 5f6c 6973 742c 2073 746f 7265 5f74 7970  _list, store_typ
+0002ffa0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+0002ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ffc0: 205b 2841 5753 5f49 4e56 414c 4944 5f4e   [(AWS_INVALID_N
+0002ffd0: 414d 4553 2c20 7374 6f72 6167 655f 6c69  AMES, storage_li
+0002ffe0: 622e 5374 6f72 6554 7970 652e 5333 292c  b.StoreType.S3),
+0002fff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030000: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00030010: 4743 535f 494e 5641 4c49 445f 4e41 4d45  GCS_INVALID_NAME
+00030020: 532c 2073 746f 7261 6765 5f6c 6962 2e53  S, storage_lib.S
+00030030: 746f 7265 5479 7065 2e47 4353 292c 0a20  toreType.GCS),. 
+00030040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030050: 2020 2020 2020 2020 2020 2020 2070 7974               pyt
+00030060: 6573 742e 7061 7261 6d28 4942 4d5f 494e  est.param(IBM_IN
+00030070: 5641 4c49 445f 4e41 4d45 532c 0a20 2020  VALID_NAMES,.   
+00030080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000300a0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+000300b0: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+000300c0: 4d2c 0a20 2020 2020 2020 2020 2020 2020  M,.             
+000300d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000300e0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+000300f0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+00030100: 6962 6d29 2c0a 2020 2020 2020 2020 2020  ibm),.          
+00030110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030120: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
+00030130: 2841 5753 5f49 4e56 414c 4944 5f4e 414d  (AWS_INVALID_NAM
+00030140: 4553 2c0a 2020 2020 2020 2020 2020 2020  ES,.            
+00030150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030160: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00030170: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00030180: 5479 7065 2e52 322c 0a20 2020 2020 2020  Type.R2,.       
+00030190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301b0: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
+000301c0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+000301d0: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
+000301e0: 5f69 6e76 616c 6964 5f6e 616d 6573 2873  _invalid_names(s
+000301f0: 656c 662c 2069 6e76 616c 6964 5f6e 616d  elf, invalid_nam
+00030200: 655f 6c69 7374 2c20 7374 6f72 655f 7479  e_list, store_ty
+00030210: 7065 293a 0a20 2020 2020 2020 2023 2055  pe):.        # U
+00030220: 7365 7320 6120 6c69 7374 2069 6e20 7468  ses a list in th
+00030230: 6520 736f 7572 6365 2066 6965 6c64 2074  e source field t
+00030240: 6f20 7370 6563 6966 7920 6120 6669 6c65  o specify a file
+00030250: 2061 6e64 2061 2064 6972 6563 746f 7279   and a directory
+00030260: 2074 6f0a 2020 2020 2020 2020 2320 6265   to.        # be
+00030270: 2075 706c 6f61 6465 6420 746f 2074 6865   uploaded to the
+00030280: 2073 746f 7261 6765 206f 626a 6563 742e   storage object.
+00030290: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
+000302a0: 6520 696e 2069 6e76 616c 6964 5f6e 616d  e in invalid_nam
+000302b0: 655f 6c69 7374 3a0a 2020 2020 2020 2020  e_list:.        
+000302c0: 2020 2020 7769 7468 2070 7974 6573 742e      with pytest.
+000302d0: 7261 6973 6573 2873 6b79 2e65 7863 6570  raises(sky.excep
+000302e0: 7469 6f6e 732e 5374 6f72 6167 654e 616d  tions.StorageNam
+000302f0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00030300: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+00030310: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
+00030320: 6962 2e53 746f 7261 6765 286e 616d 653d  ib.Storage(name=
+00030330: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00030340: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+00030350: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+00030360: 655f 7479 7065 290a 0a20 2020 2040 7079  e_type)..    @py
+00030370: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00030380: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
+00030390: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+000303a0: 7269 7a65 280a 2020 2020 2020 2020 2767  rize(.        'g
+000303b0: 6974 6967 6e6f 7265 5f73 7472 7563 7475  itignore_structu
+000303c0: 7265 2c20 7374 6f72 655f 7479 7065 272c  re, store_type',
+000303d0: 0a20 2020 2020 2020 205b 2847 4954 4947  .        [(GITIG
+000303e0: 4e4f 5245 5f53 594e 435f 5445 5354 5f44  NORE_SYNC_TEST_D
+000303f0: 4952 5f53 5452 5543 5455 5245 2c20 7374  IR_STRUCTURE, st
+00030400: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00030410: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
+00030420: 2020 2847 4954 4947 4e4f 5245 5f53 594e    (GITIGNORE_SYN
+00030430: 435f 5445 5354 5f44 4952 5f53 5452 5543  C_TEST_DIR_STRUC
+00030440: 5455 5245 2c20 7374 6f72 6167 655f 6c69  TURE, storage_li
+00030450: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
+00030460: 2c0a 2020 2020 2020 2020 2070 7974 6573  ,.         pytes
+00030470: 742e 7061 7261 6d28 4749 5449 474e 4f52  t.param(GITIGNOR
+00030480: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
+00030490: 5354 5255 4354 5552 452c 0a20 2020 2020  STRUCTURE,.     
+000304a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000304b0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+000304c0: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
+000304d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000304e0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+000304f0: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
+00030500: 0a20 2020 2064 6566 2074 6573 745f 6578  .    def test_ex
+00030510: 636c 7564 6564 5f66 696c 655f 636c 6f75  cluded_file_clou
+00030520: 645f 7374 6f72 6167 655f 7570 6c6f 6164  d_storage_upload
+00030530: 5f63 6f70 7928 7365 6c66 2c20 6769 7469  _copy(self, giti
+00030540: 676e 6f72 655f 7374 7275 6374 7572 652c  gnore_structure,
+00030550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030580: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
+00030590: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000305a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305c0: 2020 2020 2020 2074 6d70 5f67 6974 6967         tmp_gitig
+000305d0: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
+000305e0: 293a 0a20 2020 2020 2020 2023 2074 6573  ):.        # tes
+000305f0: 7473 2069 6620 6669 6c65 7320 696e 636c  ts if files incl
+00030600: 7564 6564 2069 6e20 2e67 6974 6967 6e6f  uded in .gitigno
+00030610: 7265 2061 6e64 202e 6769 742f 696e 666f  re and .git/info
+00030620: 2f65 7863 6c75 6465 2061 7265 0a20 2020  /exclude are.   
+00030630: 2020 2020 2023 2065 7863 6c75 6465 6420       # excluded 
+00030640: 6672 6f6d 2062 6569 6e67 2074 7261 6e73  from being trans
+00030650: 6665 7272 6564 2074 6f20 5374 6f72 6167  ferred to Storag
+00030660: 650a 0a20 2020 2020 2020 2074 6d70 5f67  e..        tmp_g
+00030670: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
+00030680: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
+00030690: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
+000306a0: 2020 2020 7570 6c6f 6164 5f66 696c 655f      upload_file_
+000306b0: 6e61 6d65 203d 2027 696e 636c 7564 6564  name = 'included
+000306c0: 270a 2020 2020 2020 2020 2320 436f 756e  '.        # Coun
+000306d0: 7420 7468 6520 6e75 6d62 6572 206f 6620  t the number of 
+000306e0: 6669 6c65 7320 7769 7468 2074 6865 2067  files with the g
+000306f0: 6976 656e 2066 696c 6520 6e61 6d65 0a20  iven file name. 
+00030700: 2020 2020 2020 2075 705f 636d 6420 3d20         up_cmd = 
+00030710: 7365 6c66 2e63 6c69 5f63 6f75 6e74 5f6e  self.cli_count_n
+00030720: 616d 655f 696e 5f62 7563 6b65 7428 7374  ame_in_bucket(st
+00030730: 6f72 655f 7479 7065 2c20 5c0a 2020 2020  ore_type, \.    
+00030740: 2020 2020 2020 2020 746d 705f 6769 7469          tmp_giti
+00030750: 676e 6f72 655f 7374 6f72 6167 655f 6f62  gnore_storage_ob
+00030760: 6a2e 6e61 6d65 2c20 6669 6c65 5f6e 616d  j.name, file_nam
+00030770: 653d 7570 6c6f 6164 5f66 696c 655f 6e61  e=upload_file_na
+00030780: 6d65 290a 2020 2020 2020 2020 6769 745f  me).        git_
+00030790: 6578 636c 7564 655f 636d 6420 3d20 7365  exclude_cmd = se
+000307a0: 6c66 2e63 6c69 5f63 6f75 6e74 5f6e 616d  lf.cli_count_nam
+000307b0: 655f 696e 5f62 7563 6b65 7428 7374 6f72  e_in_bucket(stor
+000307c0: 655f 7479 7065 2c20 5c0a 2020 2020 2020  e_type, \.      
+000307d0: 2020 2020 2020 746d 705f 6769 7469 676e        tmp_gitign
+000307e0: 6f72 655f 7374 6f72 6167 655f 6f62 6a2e  ore_storage_obj.
+000307f0: 6e61 6d65 2c20 6669 6c65 5f6e 616d 653d  name, file_name=
+00030800: 272e 6769 7427 290a 2020 2020 2020 2020  '.git').        
+00030810: 636e 745f 6e75 6d5f 6669 6c65 5f63 6d64  cnt_num_file_cmd
+00030820: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
+00030830: 745f 6669 6c65 5f69 6e5f 6275 636b 6574  t_file_in_bucket
+00030840: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+00030850: 6f72 655f 7479 7065 2c20 746d 705f 6769  ore_type, tmp_gi
+00030860: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
+00030870: 6f62 6a2e 6e61 6d65 290a 0a20 2020 2020  obj.name)..     
+00030880: 2020 2075 705f 6f75 7470 7574 203d 2073     up_output = s
+00030890: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+000308a0: 6f75 7470 7574 2875 705f 636d 642c 2073  output(up_cmd, s
+000308b0: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
+000308c0: 2020 2067 6974 5f65 7863 6c75 6465 5f6f     git_exclude_o
+000308d0: 7574 7075 7420 3d20 7375 6270 726f 6365  utput = subproce
+000308e0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+000308f0: 6769 745f 6578 636c 7564 655f 636d 642c  git_exclude_cmd,
+00030900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030930: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
+00030940: 290a 2020 2020 2020 2020 636e 745f 6f75  ).        cnt_ou
+00030950: 7470 7574 203d 2073 7562 7072 6f63 6573  tput = subproces
+00030960: 732e 6368 6563 6b5f 6f75 7470 7574 2863  s.check_output(c
+00030970: 6e74 5f6e 756d 5f66 696c 655f 636d 642c  nt_num_file_cmd,
+00030980: 2073 6865 6c6c 3d54 7275 6529 0a0a 2020   shell=True)..  
+00030990: 2020 2020 2020 6173 7365 7274 2027 3327        assert '3'
+000309a0: 2069 6e20 7570 5f6f 7574 7075 742e 6465   in up_output.de
+000309b0: 636f 6465 2827 7574 662d 3827 292c 205c  code('utf-8'), \
+000309c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000309d0: 2027 4669 6c65 7320 746f 2062 6520 696e   'Files to be in
+000309e0: 636c 7564 6564 2061 7265 206e 6f74 2063  cluded are not c
+000309f0: 6f6d 706c 6574 656c 7920 7570 6c6f 6164  ompletely upload
+00030a00: 6564 2e27 0a20 2020 2020 2020 2023 2031  ed.'.        # 1
+00030a10: 2069 7320 7265 6164 2061 7320 2e67 6974   is read as .git
+00030a20: 6967 6e6f 7265 2069 7320 7570 6c6f 6164  ignore is upload
+00030a30: 6564 0a20 2020 2020 2020 2061 7373 6572  ed.        asser
+00030a40: 7420 2731 2720 696e 2067 6974 5f65 7863  t '1' in git_exc
+00030a50: 6c75 6465 5f6f 7574 7075 742e 6465 636f  lude_output.deco
+00030a60: 6465 2827 7574 662d 3827 292c 205c 0a20  de('utf-8'), \. 
+00030a70: 2020 2020 2020 2020 2020 2020 2020 272e                '.
+00030a80: 6769 7420 6469 7265 6374 6f72 7920 7368  git directory sh
+00030a90: 6f75 6c64 206e 6f74 2062 6520 7570 6c6f  ould not be uplo
+00030aa0: 6164 6564 2e27 0a20 2020 2020 2020 2023  aded.'.        #
+00030ab0: 2034 2066 696c 6573 2069 6e63 6c75 6465   4 files include
+00030ac0: 202e 6769 7469 676e 6f72 652c 2069 6e63   .gitignore, inc
+00030ad0: 6c75 6465 642e 6c6f 672c 2069 6e63 6c75  luded.log, inclu
+00030ae0: 6465 642e 7478 742c 2069 6e63 6c75 6465  ded.txt, include
+00030af0: 5f64 6972 2f69 6e63 6c75 6465 642e 6c6f  _dir/included.lo
+00030b00: 670a 2020 2020 2020 2020 6173 7365 7274  g.        assert
+00030b10: 2027 3427 2069 6e20 636e 745f 6f75 7470   '4' in cnt_outp
+00030b20: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00030b30: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
+00030b40: 2020 2020 2027 536f 6d65 2069 7465 6d73       'Some items
+00030b50: 206c 6973 7465 6420 696e 202e 6769 7469   listed in .giti
+00030b60: 676e 6f72 6520 616e 6420 2e67 6974 2f69  gnore and .git/i
+00030b70: 6e66 6f2f 6578 636c 7564 6520 6172 6520  nfo/exclude are 
+00030b80: 6e6f 7420 6578 636c 7564 6564 2e27 0a0a  not excluded.'..
+00030b90: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+00030ba0: 2e70 6172 616d 6574 7269 7a65 2827 6578  .parametrize('ex
+00030bb0: 745f 6275 636b 6574 5f66 6978 7475 7265  t_bucket_fixture
+00030bc0: 2c20 7374 6f72 655f 7479 7065 272c 0a20  , store_type',. 
+00030bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030be0: 2020 2020 2020 2020 2020 2020 5b28 2774              [('t
+00030bf0: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+00030c00: 272c 2073 746f 7261 6765 5f6c 6962 2e53  ', storage_lib.S
+00030c10: 746f 7265 5479 7065 2e53 3329 2c0a 2020  toreType.S3),.  
+00030c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c30: 2020 2020 2020 2020 2020 2020 2827 746d              ('tm
+00030c40: 705f 6773 7574 696c 5f62 7563 6b65 7427  p_gsutil_bucket'
+00030c50: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+00030c60: 6f72 6554 7970 652e 4743 5329 2c0a 2020  oreType.GCS),.  
+00030c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c80: 2020 2020 2020 2020 2020 2020 7079 7465              pyte
+00030c90: 7374 2e70 6172 616d 2827 746d 705f 6177  st.param('tmp_aw
+00030ca0: 7363 6c69 5f62 7563 6b65 745f 7232 272c  scli_bucket_r2',
+00030cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cd0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+00030ce0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00030cf0: 652e 5232 2c0a 2020 2020 2020 2020 2020  e.R2,.          
+00030d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d20: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+00030d30: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
+00030d40: 0a20 2020 2064 6566 2074 6573 745f 6578  .    def test_ex
+00030d50: 7465 726e 616c 6c79 5f63 7265 6174 6564  ternally_created
+00030d60: 5f62 7563 6b65 745f 6d6f 756e 745f 7769  _bucket_mount_wi
+00030d70: 7468 6f75 745f 736f 7572 6365 280a 2020  thout_source(.  
+00030d80: 2020 2020 2020 2020 2020 7365 6c66 2c20            self, 
+00030d90: 6578 745f 6275 636b 6574 5f66 6978 7475  ext_bucket_fixtu
+00030da0: 7265 2c20 7265 7175 6573 742c 2073 746f  re, request, sto
+00030db0: 7265 5f74 7970 6529 3a0a 2020 2020 2020  re_type):.      
+00030dc0: 2020 2320 4e6f 6e2d 736b 7920 6d61 6e61    # Non-sky mana
+00030dd0: 6765 6420 6275 636b 6574 7328 6275 636b  ged buckets(buck
+00030de0: 6574 7320 6372 6561 7465 6420 6f75 7473  ets created outs
+00030df0: 6964 6520 6f66 2053 6b79 7069 6c6f 7420  ide of Skypilot 
+00030e00: 434c 4929 0a20 2020 2020 2020 2023 2061  CLI).        # a
+00030e10: 7265 2061 6c6c 6f77 6564 2074 6f20 6265  re allowed to be
+00030e20: 204d 4f55 4e54 6564 2062 7920 7370 6563   MOUNTed by spec
+00030e30: 6966 7969 6e67 2074 6865 2055 5249 206f  ifying the URI o
+00030e40: 6620 7468 6520 6275 636b 6574 2074 6f0a  f the bucket to.
+00030e50: 2020 2020 2020 2020 2320 736f 7572 6365          # source
+00030e60: 2066 6965 6c64 206f 6e6c 792e 2057 6865   field only. Whe
+00030e70: 6e20 6974 2069 7320 6174 7465 6d70 7465  n it is attempte
+00030e80: 6420 6279 2073 7065 6369 6679 696e 6720  d by specifying 
+00030e90: 7468 6520 6e61 6d65 206f 660a 2020 2020  the name of.    
+00030ea0: 2020 2020 2320 7468 6520 6275 636b 6574      # the bucket
+00030eb0: 206f 6e6c 792c 2069 7420 7368 6f75 6c64   only, it should
+00030ec0: 2065 7272 6f72 206f 7574 2e0a 2020 2020   error out..    
+00030ed0: 2020 2020 230a 2020 2020 2020 2020 2320      #.        # 
+00030ee0: 544f 444f 2864 6f79 6f75 6e67 293a 2041  TODO(doyoung): A
+00030ef0: 6464 2074 6573 7420 666f 7220 4942 4d20  dd test for IBM 
+00030f00: 434f 532e 2043 7572 7265 6e74 6c79 2c20  COS. Currently, 
+00030f10: 7468 6973 2069 7320 626c 6f63 6b65 640a  this is blocked.
+00030f20: 2020 2020 2020 2020 2320 6173 2072 636c          # as rcl
+00030f30: 6f6e 6520 7573 6564 2074 6f20 696e 7465  one used to inte
+00030f40: 7261 6374 2077 6974 6820 4942 4d20 434f  ract with IBM CO
+00030f50: 5320 646f 6573 206e 6f74 2073 7570 706f  S does not suppo
+00030f60: 7274 2066 6561 7475 7265 2074 6f0a 2020  rt feature to.  
+00030f70: 2020 2020 2020 2320 6372 6561 7465 2061        # create a
+00030f80: 2062 7563 6b65 742c 2061 6e64 2074 6865   bucket, and the
+00030f90: 2069 626d 636c 6f75 6420 434c 4920 6973   ibmcloud CLI is
+00030fa0: 206e 6f74 2073 7570 706f 7274 6564 2069   not supported i
+00030fb0: 6e20 536b 7970 696c 6f74 2e0a 2020 2020  n Skypilot..    
+00030fc0: 2020 2020 2320 4569 7468 6572 206f 6620      # Either of 
+00030fd0: 7468 6520 6665 6174 7572 6520 6973 206e  the feature is n
+00030fe0: 6563 6573 7361 7279 2074 6f20 7369 6d75  ecessary to simu
+00030ff0: 6c61 7465 2061 6e20 6578 7465 726e 616c  late an external
+00031000: 2062 7563 6b65 740a 2020 2020 2020 2020   bucket.        
+00031010: 2320 6372 6561 7469 6f6e 2066 6f72 2049  # creation for I
+00031020: 424d 2043 4f53 2e0a 2020 2020 2020 2020  BM COS..        
+00031030: 2320 6874 7470 733a 2f2f 6769 7468 7562  # https://github
+00031040: 2e63 6f6d 2f73 6b79 7069 6c6f 742d 6f72  .com/skypilot-or
+00031050: 672f 736b 7970 696c 6f74 2f70 756c 6c2f  g/skypilot/pull/
+00031060: 3139 3636 2f66 696c 6573 2372 3132 3533  1966/files#r1253
+00031070: 3433 3938 3337 0a0a 2020 2020 2020 2020  439837..        
+00031080: 6578 745f 6275 636b 6574 5f6e 616d 652c  ext_bucket_name,
+00031090: 2065 7874 5f62 7563 6b65 745f 7572 6920   ext_bucket_uri 
+000310a0: 3d20 7265 7175 6573 742e 6765 7466 6978  = request.getfix
+000310b0: 7475 7265 7661 6c75 6528 0a20 2020 2020  turevalue(.     
+000310c0: 2020 2020 2020 2065 7874 5f62 7563 6b65         ext_bucke
+000310d0: 745f 6669 7874 7572 6529 0a20 2020 2020  t_fixture).     
+000310e0: 2020 2023 2069 6e76 616c 6964 2073 7065     # invalid spe
+000310f0: 630a 2020 2020 2020 2020 7769 7468 2070  c.        with p
+00031100: 7974 6573 742e 7261 6973 6573 2873 6b79  ytest.raises(sky
+00031110: 2e65 7863 6570 7469 6f6e 732e 5374 6f72  .exceptions.Stor
+00031120: 6167 6553 7065 6345 7272 6f72 2920 6173  ageSpecError) as
+00031130: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+00031140: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
+00031150: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+00031160: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00031170: 2020 206e 616d 653d 6578 745f 6275 636b     name=ext_buck
+00031180: 6574 5f6e 616d 652c 206d 6f64 653d 7374  et_name, mode=st
+00031190: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+000311a0: 654d 6f64 652e 4d4f 554e 5429 0a20 2020  eMode.MOUNT).   
+000311b0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+000311c0: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
+000311d0: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
+000311e0: 2020 2020 6173 7365 7274 2027 4174 7465      assert 'Atte
+000311f0: 6d70 7465 6420 746f 206d 6f75 6e74 2061  mpted to mount a
+00031200: 206e 6f6e 2d73 6b79 206d 616e 6167 6564   non-sky managed
+00031210: 2062 7563 6b65 7427 2069 6e20 7374 7228   bucket' in str(
+00031220: 6529 0a0a 2020 2020 2020 2020 2320 7661  e)..        # va
+00031230: 6c69 6420 7370 6563 0a20 2020 2020 2020  lid spec.       
+00031240: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
+00031250: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
+00031260: 6765 2873 6f75 7263 653d 6578 745f 6275  ge(source=ext_bu
+00031270: 636b 6574 5f75 7269 2c0a 2020 2020 2020  cket_uri,.      
+00031280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312a0: 2020 2020 6d6f 6465 3d73 746f 7261 6765      mode=storage
+000312b0: 5f6c 6962 2e53 746f 7261 6765 4d6f 6465  _lib.StorageMode
+000312c0: 2e4d 4f55 4e54 290a 2020 2020 2020 2020  .MOUNT).        
+000312d0: 6861 6e64 6c65 203d 2067 6c6f 6261 6c5f  handle = global_
+000312e0: 7573 6572 5f73 7461 7465 2e67 6574 5f68  user_state.get_h
+000312f0: 616e 646c 655f 6672 6f6d 5f73 746f 7261  andle_from_stora
+00031300: 6765 5f6e 616d 6528 0a20 2020 2020 2020  ge_name(.       
+00031310: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+00031320: 2e6e 616d 6529 0a20 2020 2020 2020 2069  .name).        i
+00031330: 6620 6861 6e64 6c65 3a0a 2020 2020 2020  f handle:.      
+00031340: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+00031350: 6a2e 6465 6c65 7465 2829 0a0a 2020 2020  j.delete()..    
+00031360: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00031370: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00031380: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00031390: 6d65 7472 697a 6528 2772 6567 696f 6e27  metrize('region'
+000313a0: 2c20 5b0a 2020 2020 2020 2020 2761 702d  , [.        'ap-
+000313b0: 6e6f 7274 6865 6173 742d 3127 2c20 2761  northeast-1', 'a
+000313c0: 702d 6e6f 7274 6865 6173 742d 3227 2c20  p-northeast-2', 
+000313d0: 2761 702d 6e6f 7274 6865 6173 742d 3327  'ap-northeast-3'
+000313e0: 2c20 2761 702d 736f 7574 682d 3127 2c0a  , 'ap-south-1',.
+000313f0: 2020 2020 2020 2020 2761 702d 736f 7574          'ap-sout
+00031400: 6865 6173 742d 3127 2c20 2761 702d 736f  heast-1', 'ap-so
+00031410: 7574 6865 6173 742d 3227 2c20 2765 752d  utheast-2', 'eu-
+00031420: 6365 6e74 7261 6c2d 3127 2c20 2765 752d  central-1', 'eu-
+00031430: 6e6f 7274 682d 3127 2c0a 2020 2020 2020  north-1',.      
+00031440: 2020 2765 752d 7765 7374 2d31 272c 2027    'eu-west-1', '
+00031450: 6575 2d77 6573 742d 3227 2c20 2765 752d  eu-west-2', 'eu-
+00031460: 7765 7374 2d33 272c 2027 7361 2d65 6173  west-3', 'sa-eas
+00031470: 742d 3127 2c20 2775 732d 6561 7374 2d31  t-1', 'us-east-1
+00031480: 272c 0a20 2020 2020 2020 2027 7573 2d65  ',.        'us-e
+00031490: 6173 742d 3227 2c20 2775 732d 7765 7374  ast-2', 'us-west
+000314a0: 2d31 272c 2027 7573 2d77 6573 742d 3227  -1', 'us-west-2'
+000314b0: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
+000314c0: 7465 7374 5f61 7773 5f72 6567 696f 6e73  test_aws_regions
+000314d0: 2873 656c 662c 2074 6d70 5f6c 6f63 616c  (self, tmp_local
+000314e0: 5f73 746f 7261 6765 5f6f 626a 2c20 7265  _storage_obj, re
+000314f0: 6769 6f6e 293a 0a20 2020 2020 2020 2023  gion):.        #
+00031500: 2054 6869 7320 7465 7374 7320 6372 6561   This tests crea
+00031510: 7469 6f6e 2061 6e64 2075 706c 6f61 6420  tion and upload 
+00031520: 746f 2062 7563 6b65 7420 696e 2061 6c6c  to bucket in all
+00031530: 2041 5753 2073 3320 7265 6769 6f6e 730a   AWS s3 regions.
+00031540: 2020 2020 2020 2020 2320 546f 2074 6573          # To tes
+00031550: 7420 6675 6c6c 2066 756e 6374 696f 6e61  t full functiona
+00031560: 6c69 7479 2c20 7573 6520 7465 7374 5f73  lity, use test_s
+00031570: 706f 745f 7374 6f72 6167 6520 6162 6f76  pot_storage abov
+00031580: 652e 0a20 2020 2020 2020 2073 746f 7265  e..        store
+00031590: 5f74 7970 6520 3d20 7374 6f72 6167 655f  _type = storage_
+000315a0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+000315b0: 0a20 2020 2020 2020 2074 6d70 5f6c 6f63  .        tmp_loc
+000315c0: 616c 5f73 746f 7261 6765 5f6f 626a 2e61  al_storage_obj.a
+000315d0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
+000315e0: 7970 652c 2072 6567 696f 6e3d 7265 6769  ype, region=regi
+000315f0: 6f6e 290a 2020 2020 2020 2020 6275 636b  on).        buck
+00031600: 6574 5f6e 616d 6520 3d20 746d 705f 6c6f  et_name = tmp_lo
+00031610: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
+00031620: 6e61 6d65 0a0a 2020 2020 2020 2020 2320  name..        # 
+00031630: 436f 6e66 6972 6d20 7468 6174 2074 6865  Confirm that the
+00031640: 2062 7563 6b65 7420 7761 7320 6372 6561   bucket was crea
+00031650: 7465 6420 696e 2074 6865 2063 6f72 7265  ted in the corre
+00031660: 6374 2072 6567 696f 6e0a 2020 2020 2020  ct region.      
+00031670: 2020 7265 6769 6f6e 5f63 6d64 203d 2073    region_cmd = s
+00031680: 656c 662e 636c 695f 7265 6769 6f6e 5f63  elf.cli_region_c
+00031690: 6d64 2873 746f 7265 5f74 7970 652c 2062  md(store_type, b
+000316a0: 7563 6b65 745f 6e61 6d65 290a 2020 2020  ucket_name).    
+000316b0: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+000316c0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+000316d0: 7428 7265 6769 6f6e 5f63 6d64 2c20 7368  t(region_cmd, sh
+000316e0: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
+000316f0: 2020 6f75 7470 7574 203d 206f 7574 2e64    output = out.d
+00031700: 6563 6f64 6528 2775 7466 2d38 2729 0a20  ecode('utf-8'). 
+00031710: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+00031720: 6f75 7470 7574 5f72 6567 696f 6e20 3d20  output_region = 
+00031730: 7265 6769 6f6e 0a20 2020 2020 2020 2069  region.        i
+00031740: 6620 7265 6769 6f6e 203d 3d20 2775 732d  f region == 'us-
+00031750: 6561 7374 2d31 273a 0a20 2020 2020 2020  east-1':.       
+00031760: 2020 2020 2065 7870 6563 7465 645f 6f75       expected_ou
+00031770: 7470 7574 5f72 6567 696f 6e20 3d20 274e  tput_region = 'N
+00031780: 6f6e 6527 2020 2320 7573 2d65 6173 742d  one'  # us-east-
+00031790: 3120 6973 2074 6865 2064 6566 6175 6c74  1 is the default
+000317a0: 2072 6567 696f 6e0a 2020 2020 2020 2020   region.        
+000317b0: 6173 7365 7274 2065 7870 6563 7465 645f  assert expected_
+000317c0: 6f75 7470 7574 5f72 6567 696f 6e20 696e  output_region in
+000317d0: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+000317e0: 2d38 2729 2c20 280a 2020 2020 2020 2020  -8'), (.        
+000317f0: 2020 2020 6627 4275 636b 6574 2077 6173      f'Bucket was
+00031800: 206e 6f74 2066 6f75 6e64 2069 6e20 7265   not found in re
+00031810: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d20  gion {region} - 
+00031820: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00031830: 6f75 7470 7574 206f 6620 7b72 6567 696f  output of {regio
+00031840: 6e5f 636d 647d 2077 6173 3a20 7b6f 7574  n_cmd} was: {out
+00031850: 7075 747d 2729 0a0a 2020 2020 2020 2020  put}')..        
+00031860: 2320 4368 6563 6b20 6966 2074 6d70 5f73  # Check if tmp_s
+00031870: 6f75 7263 652f 746d 702d 6669 6c65 2065  ource/tmp-file e
+00031880: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
+00031890: 6b65 7420 7573 696e 6720 636c 690a 2020  ket using cli.  
+000318a0: 2020 2020 2020 6c73 5f63 6d64 203d 2073        ls_cmd = s
+000318b0: 656c 662e 636c 695f 6c73 5f63 6d64 2873  elf.cli_ls_cmd(s
+000318c0: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
+000318d0: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
+000318e0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+000318f0: 2e63 6865 636b 5f6f 7574 7075 7428 6c73  .check_output(ls
+00031900: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
+00031910: 290a 2020 2020 2020 2020 6f75 7470 7574  ).        output
+00031920: 203d 206f 7574 2e64 6563 6f64 6528 2775   = out.decode('u
+00031930: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
+00031940: 7373 6572 7420 2774 6d70 2d66 696c 6527  ssert 'tmp-file'
+00031950: 2069 6e20 6f75 7470 7574 2c20 280a 2020   in output, (.  
+00031960: 2020 2020 2020 2020 2020 6627 746d 702d            f'tmp-
+00031970: 6669 6c65 206e 6f74 2066 6f75 6e64 2069  file not found i
+00031980: 6e20 6275 636b 6574 202d 206f 7574 7075  n bucket - outpu
+00031990: 7420 6f66 207b 6c73 5f63 6d64 7d20 7761  t of {ls_cmd} wa
+000319a0: 733a 207b 6f75 7470 7574 7d27 290a 0a20  s: {output}').. 
+000319b0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+000319c0: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
+000319d0: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
+000319e0: 6172 616d 6574 7269 7a65 2827 7265 6769  arametrize('regi
+000319f0: 6f6e 272c 205b 0a20 2020 2020 2020 2027  on', [.        '
+00031a00: 6e6f 7274 6861 6d65 7269 6361 2d6e 6f72  northamerica-nor
+00031a10: 7468 6561 7374 3127 2c20 276e 6f72 7468  theast1', 'north
+00031a20: 616d 6572 6963 612d 6e6f 7274 6865 6173  america-northeas
+00031a30: 7432 272c 2027 7573 2d63 656e 7472 616c  t2', 'us-central
+00031a40: 3127 2c0a 2020 2020 2020 2020 2775 732d  1',.        'us-
+00031a50: 6561 7374 3127 2c20 2775 732d 6561 7374  east1', 'us-east
+00031a60: 3427 2c20 2775 732d 6561 7374 3527 2c20  4', 'us-east5', 
+00031a70: 2775 732d 736f 7574 6831 272c 2027 7573  'us-south1', 'us
+00031a80: 2d77 6573 7431 272c 2027 7573 2d77 6573  -west1', 'us-wes
+00031a90: 7432 272c 0a20 2020 2020 2020 2027 7573  t2',.        'us
+00031aa0: 2d77 6573 7433 272c 2027 7573 2d77 6573  -west3', 'us-wes
+00031ab0: 7434 272c 2027 736f 7574 6861 6d65 7269  t4', 'southameri
+00031ac0: 6361 2d65 6173 7431 272c 2027 736f 7574  ca-east1', 'sout
+00031ad0: 6861 6d65 7269 6361 2d77 6573 7431 272c  hamerica-west1',
+00031ae0: 0a20 2020 2020 2020 2027 6575 726f 7065  .        'europe
+00031af0: 2d63 656e 7472 616c 3227 2c20 2765 7572  -central2', 'eur
+00031b00: 6f70 652d 6e6f 7274 6831 272c 2027 6575  ope-north1', 'eu
+00031b10: 726f 7065 2d73 6f75 7468 7765 7374 3127  rope-southwest1'
+00031b20: 2c20 2765 7572 6f70 652d 7765 7374 3127  , 'europe-west1'
+00031b30: 2c0a 2020 2020 2020 2020 2765 7572 6f70  ,.        'europ
+00031b40: 652d 7765 7374 3227 2c20 2765 7572 6f70  e-west2', 'europ
+00031b50: 652d 7765 7374 3327 2c20 2765 7572 6f70  e-west3', 'europ
+00031b60: 652d 7765 7374 3427 2c20 2765 7572 6f70  e-west4', 'europ
+00031b70: 652d 7765 7374 3627 2c0a 2020 2020 2020  e-west6',.      
+00031b80: 2020 2765 7572 6f70 652d 7765 7374 3827    'europe-west8'
+00031b90: 2c20 2765 7572 6f70 652d 7765 7374 3927  , 'europe-west9'
+00031ba0: 2c20 2765 7572 6f70 652d 7765 7374 3130  , 'europe-west10
+00031bb0: 272c 2027 6575 726f 7065 2d77 6573 7431  ', 'europe-west1
+00031bc0: 3227 2c0a 2020 2020 2020 2020 2761 7369  2',.        'asi
+00031bd0: 612d 6561 7374 3127 2c20 2761 7369 612d  a-east1', 'asia-
+00031be0: 6561 7374 3227 2c20 2761 7369 612d 6e6f  east2', 'asia-no
+00031bf0: 7274 6865 6173 7431 272c 2027 6173 6961  rtheast1', 'asia
+00031c00: 2d6e 6f72 7468 6561 7374 3227 2c0a 2020  -northeast2',.  
+00031c10: 2020 2020 2020 2761 7369 612d 6e6f 7274        'asia-nort
+00031c20: 6865 6173 7433 272c 2027 6173 6961 2d73  heast3', 'asia-s
+00031c30: 6f75 7468 6561 7374 3127 2c20 2761 7369  outheast1', 'asi
+00031c40: 612d 736f 7574 6831 272c 2027 6173 6961  a-south1', 'asia
+00031c50: 2d73 6f75 7468 3227 2c0a 2020 2020 2020  -south2',.      
+00031c60: 2020 2761 7369 612d 736f 7574 6865 6173    'asia-southeas
+00031c70: 7432 272c 2027 6d65 2d63 656e 7472 616c  t2', 'me-central
+00031c80: 3127 2c20 276d 652d 6365 6e74 7261 6c32  1', 'me-central2
+00031c90: 272c 2027 6d65 2d77 6573 7431 272c 0a20  ', 'me-west1',. 
+00031ca0: 2020 2020 2020 2027 6175 7374 7261 6c69         'australi
+00031cb0: 612d 736f 7574 6865 6173 7431 272c 2027  a-southeast1', '
+00031cc0: 6175 7374 7261 6c69 612d 736f 7574 6865  australia-southe
+00031cd0: 6173 7432 272c 2027 6166 7269 6361 2d73  ast2', 'africa-s
+00031ce0: 6f75 7468 3127 0a20 2020 205d 290a 2020  outh1'.    ]).  
+00031cf0: 2020 6465 6620 7465 7374 5f67 6373 5f72    def test_gcs_r
+00031d00: 6567 696f 6e73 2873 656c 662c 2074 6d70  egions(self, tmp
+00031d10: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+00031d20: 626a 2c20 7265 6769 6f6e 293a 0a20 2020  bj, region):.   
+00031d30: 2020 2020 2023 2054 6869 7320 7465 7374       # This test
+00031d40: 7320 6372 6561 7469 6f6e 2061 6e64 2075  s creation and u
+00031d50: 706c 6f61 6420 746f 2062 7563 6b65 7420  pload to bucket 
+00031d60: 696e 2061 6c6c 2047 4353 2072 6567 696f  in all GCS regio
+00031d70: 6e73 0a20 2020 2020 2020 2023 2054 6f20  ns.        # To 
+00031d80: 7465 7374 2066 756c 6c20 6675 6e63 7469  test full functi
+00031d90: 6f6e 616c 6974 792c 2075 7365 2074 6573  onality, use tes
+00031da0: 745f 7370 6f74 5f73 746f 7261 6765 2061  t_spot_storage a
+00031db0: 626f 7665 2e0a 2020 2020 2020 2020 7374  bove..        st
+00031dc0: 6f72 655f 7479 7065 203d 2073 746f 7261  ore_type = stora
+00031dd0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00031de0: 2e47 4353 0a20 2020 2020 2020 2074 6d70  .GCS.        tmp
+00031df0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+00031e00: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+00031e10: 7265 5f74 7970 652c 2072 6567 696f 6e3d  re_type, region=
+00031e20: 7265 6769 6f6e 290a 2020 2020 2020 2020  region).        
+00031e30: 6275 636b 6574 5f6e 616d 6520 3d20 746d  bucket_name = tm
+00031e40: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
+00031e50: 6f62 6a2e 6e61 6d65 0a0a 2020 2020 2020  obj.name..      
+00031e60: 2020 2320 436f 6e66 6972 6d20 7468 6174    # Confirm that
+00031e70: 2074 6865 2062 7563 6b65 7420 7761 7320   the bucket was 
+00031e80: 6372 6561 7465 6420 696e 2074 6865 2063  created in the c
+00031e90: 6f72 7265 6374 2072 6567 696f 6e0a 2020  orrect region.  
+00031ea0: 2020 2020 2020 7265 6769 6f6e 5f63 6d64        region_cmd
+00031eb0: 203d 2073 656c 662e 636c 695f 7265 6769   = self.cli_regi
+00031ec0: 6f6e 5f63 6d64 2873 746f 7265 5f74 7970  on_cmd(store_typ
+00031ed0: 652c 2062 7563 6b65 745f 6e61 6d65 290a  e, bucket_name).
+00031ee0: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
+00031ef0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+00031f00: 7574 7075 7428 7265 6769 6f6e 5f63 6d64  utput(region_cmd
+00031f10: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
+00031f20: 2020 2020 2020 6f75 7470 7574 203d 206f        output = o
+00031f30: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00031f40: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
+00031f50: 7420 7265 6769 6f6e 2069 6e20 6f75 742e  t region in out.
+00031f60: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
+00031f70: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
+00031f80: 2742 7563 6b65 7420 7761 7320 6e6f 7420  'Bucket was not 
+00031f90: 666f 756e 6420 696e 2072 6567 696f 6e20  found in region 
+00031fa0: 7b72 6567 696f 6e7d 202d 2027 0a20 2020  {region} - '.   
+00031fb0: 2020 2020 2020 2020 2066 276f 7574 7075           f'outpu
+00031fc0: 7420 6f66 207b 7265 6769 6f6e 5f63 6d64  t of {region_cmd
+00031fd0: 7d20 7761 733a 207b 6f75 7470 7574 7d27  } was: {output}'
+00031fe0: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
+00031ff0: 636b 2069 6620 746d 705f 736f 7572 6365  ck if tmp_source
+00032000: 2f74 6d70 2d66 696c 6520 6578 6973 7473  /tmp-file exists
+00032010: 2069 6e20 7468 6520 6275 636b 6574 2075   in the bucket u
+00032020: 7369 6e67 2063 6c69 0a20 2020 2020 2020  sing cli.       
+00032030: 206c 735f 636d 6420 3d20 7365 6c66 2e63   ls_cmd = self.c
+00032040: 6c69 5f6c 735f 636d 6428 7374 6f72 655f  li_ls_cmd(store_
+00032050: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
+00032060: 6529 0a20 2020 2020 2020 206f 7574 203d  e).        out =
+00032070: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+00032080: 6b5f 6f75 7470 7574 286c 735f 636d 642c  k_output(ls_cmd,
+00032090: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
+000320a0: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
+000320b0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+000320c0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+000320d0: 2027 746d 702d 6669 6c65 2720 696e 206f   'tmp-file' in o
+000320e0: 7574 7075 742c 2028 0a20 2020 2020 2020  utput, (.       
+000320f0: 2020 2020 2066 2774 6d70 2d66 696c 6520       f'tmp-file 
+00032100: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
+00032110: 6b65 7420 2d20 6f75 7470 7574 206f 6620  ket - output of 
+00032120: 7b6c 735f 636d 647d 2077 6173 3a20 7b6f  {ls_cmd} was: {o
+00032130: 7574 7075 747d 2729 0a0a 0a23 202d 2d2d  utput}')...# ---
+00032140: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+00032150: 5941 4d4c 2053 7065 6373 202d 2d2d 2d2d  YAML Specs -----
+00032160: 2d2d 2d2d 2d0a 2320 4f75 7220 736b 7920  -----.# Our sky 
+00032170: 7374 6f72 6167 6520 7265 7175 6972 6573  storage requires
+00032180: 2063 7265 6465 6e74 6961 6c73 2074 6f20   credentials to 
+00032190: 6368 6563 6b20 7468 6520 6275 636b 6574  check the bucket
+000321a0: 2065 7869 7374 616e 6365 2077 6865 6e0a   existance when.
+000321b0: 2320 6c6f 6164 696e 6720 6120 7461 736b  # loading a task
+000321c0: 2066 726f 6d20 7468 6520 7961 6d6c 2066   from the yaml f
+000321d0: 696c 652c 2073 6f20 7765 2063 616e 6e6f  ile, so we canno
+000321e0: 7420 6d61 6b65 2069 7420 6120 756e 6974  t make it a unit
+000321f0: 2074 6573 742e 0a63 6c61 7373 2054 6573   test..class Tes
+00032200: 7459 616d 6c53 7065 6373 3a0a 2020 2020  tYamlSpecs:.    
+00032210: 2320 544f 444f 287a 6877 7529 3a20 4164  # TODO(zhwu): Ad
+00032220: 6420 7465 7374 2066 6f72 2060 746f 5f79  d test for `to_y
+00032230: 616d 6c5f 636f 6e66 6967 6020 666f 7220  aml_config` for 
+00032240: 7468 6520 5374 6f72 6167 6520 6f62 6a65  the Storage obje
+00032250: 6374 2e0a 2020 2020 2320 2057 6520 7368  ct..    #  We sh
+00032260: 6f75 6c64 206e 6f74 2075 7365 2060 6578  ould not use `ex
+00032270: 616d 706c 6573 2f73 746f 7261 6765 5f64  amples/storage_d
+00032280: 656d 6f2e 7961 6d6c 6020 6865 7265 2c20  emo.yaml` here, 
+00032290: 7369 6e63 6520 6974 2072 6571 7569 7265  since it require
+000322a0: 730a 2020 2020 2320 2075 7365 7273 2074  s.    #  users t
+000322b0: 6f20 656e 7375 7265 2062 7563 6b65 7420  o ensure bucket 
+000322c0: 6e61 6d65 7320 746f 206e 6f74 2065 7869  names to not exi
+000322d0: 7374 2061 6e64 2f6f 7220 6265 2075 6e69  st and/or be uni
+000322e0: 7175 652e 0a20 2020 205f 5445 5354 5f59  que..    _TEST_Y
+000322f0: 414d 4c5f 5041 5448 5320 3d20 5b0a 2020  AML_PATHS = [.  
+00032300: 2020 2020 2020 2765 7861 6d70 6c65 732f        'examples/
+00032310: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 2027  minimal.yaml', '
+00032320: 6578 616d 706c 6573 2f6d 616e 6167 6564  examples/managed
+00032330: 5f73 706f 742e 7961 6d6c 272c 0a20 2020  _spot.yaml',.   
+00032340: 2020 2020 2027 6578 616d 706c 6573 2f75       'examples/u
+00032350: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
+00032360: 2e79 616d 6c27 2c20 2765 7861 6d70 6c65  .yaml', 'example
+00032370: 732f 7265 736e 6574 5f61 7070 2e79 616d  s/resnet_app.yam
+00032380: 6c27 2c0a 2020 2020 2020 2020 2765 7861  l',.        'exa
+00032390: 6d70 6c65 732f 6d75 6c74 695f 686f 7374  mples/multi_host
+000323a0: 6e61 6d65 2e79 616d 6c27 0a20 2020 205d  name.yaml'.    ]
+000323b0: 0a0a 2020 2020 6465 6620 5f69 735f 6469  ..    def _is_di
+000323c0: 6374 5f73 7562 7365 7428 7365 6c66 2c20  ct_subset(self, 
+000323d0: 6431 2c20 6432 293a 0a20 2020 2020 2020  d1, d2):.       
+000323e0: 2022 2222 4368 6563 6b20 6966 2064 3120   """Check if d1 
+000323f0: 6973 2074 6865 2073 7562 7365 7420 6f66  is the subset of
+00032400: 2064 322e 2222 220a 2020 2020 2020 2020   d2.""".        
+00032410: 666f 7220 6b2c 2076 2069 6e20 6431 2e69  for k, v in d1.i
+00032420: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00032430: 2020 2020 6966 206b 206e 6f74 2069 6e20      if k not in 
+00032440: 6432 3a0a 2020 2020 2020 2020 2020 2020  d2:.            
+00032450: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00032460: 6528 762c 206c 6973 7429 206f 7220 6973  e(v, list) or is
+00032470: 696e 7374 616e 6365 2876 2c20 6469 6374  instance(v, dict
+00032480: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00032490: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
+000324a0: 6e28 7629 203d 3d20 302c 2028 6b2c 2076  n(v) == 0, (k, v
+000324b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000324c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000324d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000324e0: 7274 2046 616c 7365 2c20 286b 2c20 7629  rt False, (k, v)
+000324f0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00032500: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
+00032510: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+00032520: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00032530: 696e 7374 616e 6365 2864 325b 6b5d 2c20  instance(d2[k], 
+00032540: 6469 6374 292c 2028 6b2c 2076 2c20 6432  dict), (k, v, d2
+00032550: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00032560: 2020 7365 6c66 2e5f 6973 5f64 6963 745f    self._is_dict_
+00032570: 7375 6273 6574 2876 2c20 6432 5b6b 5d29  subset(v, d2[k])
+00032580: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00032590: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
+000325a0: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
+000325b0: 2020 2020 2020 6966 206b 203d 3d20 2761        if k == 'a
+000325c0: 6363 656c 6572 6174 6f72 7327 3a0a 2020  ccelerators':.  
+000325d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000325e0: 2020 7265 736f 7572 6365 7320 3d20 736b    resources = sk
+000325f0: 792e 5265 736f 7572 6365 7328 290a 2020  y.Resources().  
+00032600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032610: 2020 7265 736f 7572 6365 732e 5f73 6574    resources._set
+00032620: 5f61 6363 656c 6572 6174 6f72 7328 762c  _accelerators(v,
+00032630: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
+00032640: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00032650: 7420 7265 736f 7572 6365 732e 6163 6365  t resources.acce
+00032660: 6c65 7261 746f 7273 203d 3d20 6432 5b6b  lerators == d2[k
+00032670: 5d2c 2028 6b2c 2076 2c20 6432 290a 2020  ], (k, v, d2).  
+00032680: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00032690: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000326a0: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
+000326b0: 2e6c 6f77 6572 2829 203d 3d20 6432 5b6b  .lower() == d2[k
+000326c0: 5d2e 6c6f 7765 7228 292c 2028 6b2c 2076  ].lower(), (k, v
+000326d0: 2c20 6432 5b6b 5d29 0a20 2020 2020 2020  , d2[k]).       
+000326e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000326f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00032700: 7420 7620 3d3d 2064 325b 6b5d 2c20 286b  t v == d2[k], (k
+00032710: 2c20 762c 2064 325b 6b5d 290a 0a20 2020  , v, d2[k])..   
+00032720: 2064 6566 205f 6368 6563 6b5f 6571 7569   def _check_equi
+00032730: 7661 6c65 6e74 2873 656c 662c 2079 616d  valent(self, yam
+00032740: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
+00032750: 2022 2222 4368 6563 6b20 6966 2074 6865   """Check if the
+00032760: 2079 616d 6c20 6973 2065 7175 6976 616c   yaml is equival
+00032770: 656e 7420 6166 7465 7220 6c6f 6164 2061  ent after load a
+00032780: 6e64 2064 756d 7020 6167 6169 6e2e 2222  nd dump again.""
+00032790: 220a 2020 2020 2020 2020 6f72 6967 696e  ".        origin
+000327a0: 5f74 6173 6b5f 636f 6e66 6967 203d 2063  _task_config = c
+000327b0: 6f6d 6d6f 6e5f 7574 696c 732e 7265 6164  ommon_utils.read
+000327c0: 5f79 616d 6c28 7961 6d6c 5f70 6174 6829  _yaml(yaml_path)
+000327d0: 0a0a 2020 2020 2020 2020 7461 736b 203d  ..        task =
+000327e0: 2073 6b79 2e54 6173 6b2e 6672 6f6d 5f79   sky.Task.from_y
+000327f0: 616d 6c28 7961 6d6c 5f70 6174 6829 0a20  aml(yaml_path). 
+00032800: 2020 2020 2020 206e 6577 5f74 6173 6b5f         new_task_
+00032810: 636f 6e66 6967 203d 2074 6173 6b2e 746f  config = task.to
+00032820: 5f79 616d 6c5f 636f 6e66 6967 2829 0a20  _yaml_config(). 
+00032830: 2020 2020 2020 2023 2064 3120 3c3d 2064         # d1 <= d
+00032840: 320a 2020 2020 2020 2020 7072 696e 7428  2.        print(
+00032850: 6f72 6967 696e 5f74 6173 6b5f 636f 6e66  origin_task_conf
+00032860: 6967 2c20 6e65 775f 7461 736b 5f63 6f6e  ig, new_task_con
+00032870: 6669 6729 0a20 2020 2020 2020 2073 656c  fig).        sel
+00032880: 662e 5f69 735f 6469 6374 5f73 7562 7365  f._is_dict_subse
+00032890: 7428 6f72 6967 696e 5f74 6173 6b5f 636f  t(origin_task_co
+000328a0: 6e66 6967 2c20 6e65 775f 7461 736b 5f63  nfig, new_task_c
+000328b0: 6f6e 6669 6729 0a0a 2020 2020 6465 6620  onfig)..    def 
+000328c0: 7465 7374 5f6c 6f61 645f 6475 6d70 5f79  test_load_dump_y
+000328d0: 616d 6c5f 636f 6e66 6967 5f65 7175 6976  aml_config_equiv
+000328e0: 616c 656e 7428 7365 6c66 293a 0a20 2020  alent(self):.   
+000328f0: 2020 2020 2022 2222 5465 7374 2069 6620       """Test if 
+00032900: 7468 6520 7961 6d6c 2063 6f6e 6669 6720  the yaml config 
+00032910: 6973 2065 7175 6976 616c 656e 7420 6166  is equivalent af
+00032920: 7465 7220 6c6f 6164 2061 6e64 2064 756d  ter load and dum
+00032930: 7020 6167 6169 6e2e 2222 220a 2020 2020  p again.""".    
+00032940: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+00032950: 2827 7e2f 6461 7461 7365 7473 2729 2e65  ('~/datasets').e
+00032960: 7870 616e 6475 7365 7228 292e 6d6b 6469  xpanduser().mkdi
+00032970: 7228 6578 6973 745f 6f6b 3d54 7275 6529  r(exist_ok=True)
+00032980: 0a20 2020 2020 2020 2070 6174 686c 6962  .        pathlib
+00032990: 2e50 6174 6828 277e 2f74 6d70 6669 6c65  .Path('~/tmpfile
+000329a0: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
+000329b0: 746f 7563 6828 290a 2020 2020 2020 2020  touch().        
+000329c0: 7061 7468 6c69 622e 5061 7468 2827 7e2f  pathlib.Path('~/
+000329d0: 2e73 7368 2729 2e65 7870 616e 6475 7365  .ssh').expanduse
+000329e0: 7228 292e 6d6b 6469 7228 6578 6973 745f  r().mkdir(exist_
+000329f0: 6f6b 3d54 7275 6529 0a20 2020 2020 2020  ok=True).       
+00032a00: 2070 6174 686c 6962 2e50 6174 6828 277e   pathlib.Path('~
+00032a10: 2f2e 7373 682f 6964 5f72 7361 2e70 7562  /.ssh/id_rsa.pub
+00032a20: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
+00032a30: 746f 7563 6828 290a 2020 2020 2020 2020  touch().        
+00032a40: 7061 7468 6c69 622e 5061 7468 2827 7e2f  pathlib.Path('~/
+00032a50: 746d 702d 776f 726b 6469 7227 292e 6578  tmp-workdir').ex
+00032a60: 7061 6e64 7573 6572 2829 2e6d 6b64 6972  panduser().mkdir
+00032a70: 2865 7869 7374 5f6f 6b3d 5472 7565 290a  (exist_ok=True).
+00032a80: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
+00032a90: 5061 7468 2827 7e2f 446f 776e 6c6f 6164  Path('~/Download
+00032aa0: 732f 7470 7527 292e 6578 7061 6e64 7573  s/tpu').expandus
+00032ab0: 6572 2829 2e6d 6b64 6972 2870 6172 656e  er().mkdir(paren
+00032ac0: 7473 3d54 7275 652c 0a20 2020 2020 2020  ts=True,.       
+00032ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b00: 2020 2020 6578 6973 745f 6f6b 3d54 7275      exist_ok=Tru
+00032b10: 6529 0a20 2020 2020 2020 2066 6f72 2079  e).        for y
+00032b20: 616d 6c5f 7061 7468 2069 6e20 7365 6c66  aml_path in self
+00032b30: 2e5f 5445 5354 5f59 414d 4c5f 5041 5448  ._TEST_YAML_PATH
+00032b40: 533a 0a20 2020 2020 2020 2020 2020 2073  S:.            s
+00032b50: 656c 662e 5f63 6865 636b 5f65 7175 6976  elf._check_equiv
+00032b60: 616c 656e 7428 7961 6d6c 5f70 6174 6829  alent(yaml_path)
+00032b70: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00032b80: 5465 7374 696e 6720 4d75 6c74 6970 6c65  Testing Multiple
+00032b90: 2041 6363 656c 6572 6174 6f72 7320 2d2d   Accelerators --
+00032ba0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00032bb0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+00032bc0: 6163 6b20 2023 2046 6c75 6964 7374 6163  ack  # Fluidstac
+00032bd0: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
+00032be0: 7274 204b 3830 2067 7075 7320 666f 7220  rt K80 gpus for 
+00032bf0: 6e6f 770a 4070 7974 6573 742e 6d61 726b  now.@pytest.mark
+00032c00: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
+00032c10: 2320 5061 7065 7273 7061 6365 2064 6f65  # Paperspace doe
+00032c20: 7320 6e6f 7420 7375 7070 6f72 7420 4b38  s not support K8
+00032c30: 3020 6770 7573 0a64 6566 2074 6573 745f  0 gpus.def test_
+00032c40: 6d75 6c74 6970 6c65 5f61 6363 656c 6572  multiple_acceler
+00032c50: 6174 6f72 735f 6f72 6465 7265 6428 293a  ators_ordered():
+00032c60: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00032c70: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00032c80: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00032c90: 0a20 2020 2020 2020 2027 6d75 6c74 6970  .        'multip
+00032ca0: 6c65 2d61 6363 656c 6572 6174 6f72 732d  le-accelerators-
+00032cb0: 6f72 6465 7265 6427 2c0a 2020 2020 2020  ordered',.      
+00032cc0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00032cd0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00032ce0: 2d63 207b 6e61 6d65 7d20 7465 7374 732f  -c {name} tests/
+00032cf0: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
+00032d00: 6d75 6c74 6970 6c65 5f61 6363 656c 6572  multiple_acceler
+00032d10: 6174 6f72 735f 6f72 6465 7265 642e 7961  ators_ordered.ya
+00032d20: 6d6c 207c 2067 7265 7020 2255 7369 6e67  ml | grep "Using
+00032d30: 2075 7365 722d 7370 6563 6966 6965 6420   user-specified 
+00032d40: 6163 6365 6c65 7261 746f 7273 206c 6973  accelerators lis
+00032d50: 7422 272c 0a20 2020 2020 2020 2020 2020  t"',.           
+00032d60: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00032d70: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+00032d80: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00032d90: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00032da0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00032db0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00032dc0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+00032dd0: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
+00032de0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00032df0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00032e00: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+00032e10: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
+00032e20: 6964 7374 6163 6b20 6861 7320 6c6f 7720  idstack has low 
+00032e30: 6176 6169 6c61 6269 6c69 7479 2066 6f72  availability for
+00032e40: 2054 3420 4750 5573 0a40 7079 7465 7374   T4 GPUs.@pytest
+00032e50: 2e6d 6172 6b2e 6e6f 5f70 6170 6572 7370  .mark.no_papersp
+00032e60: 6163 6520 2023 2050 6170 6572 7370 6163  ace  # Paperspac
+00032e70: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
+00032e80: 7274 2054 3420 4750 5573 0a64 6566 2074  rt T4 GPUs.def t
+00032e90: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+00032ea0: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+00032eb0: 645f 7769 7468 5f64 6566 6175 6c74 2829  d_with_default()
+00032ec0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00032ed0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00032ee0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00032ef0: 280a 2020 2020 2020 2020 276d 756c 7469  (.        'multi
+00032f00: 706c 652d 6163 6365 6c65 7261 746f 7273  ple-accelerators
+00032f10: 2d6f 7264 6572 6564 272c 0a20 2020 2020  -ordered',.     
+00032f20: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00032f30: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00032f40: 202d 6320 7b6e 616d 657d 2074 6573 7473   -c {name} tests
+00032f50: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
+00032f60: 5f6d 756c 7469 706c 655f 6163 6365 6c65  _multiple_accele
+00032f70: 7261 746f 7273 5f6f 7264 6572 6564 5f77  rators_ordered_w
+00032f80: 6974 685f 6465 6661 756c 742e 7961 6d6c  ith_default.yaml
+00032f90: 207c 2067 7265 7020 2255 7369 6e67 2075   | grep "Using u
+00032fa0: 7365 722d 7370 6563 6966 6965 6420 6163  ser-specified ac
+00032fb0: 6365 6c65 7261 746f 7273 206c 6973 7422  celerators list"
+00032fc0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00032fd0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00032fe0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00032ff0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00033000: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00033010: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00033020: 7475 7320 7b6e 616d 657d 207c 2067 7265  tus {name} | gre
+00033030: 7020 5370 6f74 272c 0a20 2020 2020 2020  p Spot',.       
+00033040: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00033050: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00033060: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00033070: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00033080: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
+00033090: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
+000330a0: 466c 7569 6473 7461 636b 2068 6173 206c  Fluidstack has l
+000330b0: 6f77 2061 7661 696c 6162 696c 6974 7920  ow availability 
+000330c0: 666f 7220 5434 2047 5055 730a 4070 7974  for T4 GPUs.@pyt
+000330d0: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
+000330e0: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
+000330f0: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
+00033100: 7070 6f72 7420 5434 2047 5055 730a 6465  pport T4 GPUs.de
+00033110: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
+00033120: 6163 6365 6c65 7261 746f 7273 5f75 6e6f  accelerators_uno
+00033130: 7264 6572 6564 2829 3a0a 2020 2020 6e61  rdered():.    na
+00033140: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00033150: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00033160: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00033170: 2020 276d 756c 7469 706c 652d 6163 6365    'multiple-acce
+00033180: 6c65 7261 746f 7273 2d75 6e6f 7264 6572  lerators-unorder
+00033190: 6564 272c 0a20 2020 2020 2020 205b 0a20  ed',.        [. 
+000331a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000331b0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+000331c0: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
+000331d0: 7961 6d6c 732f 7465 7374 5f6d 756c 7469  yamls/test_multi
+000331e0: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
+000331f0: 5f75 6e6f 7264 6572 6564 2e79 616d 6c27  _unordered.yaml'
+00033200: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00033210: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00033220: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+00033230: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+00033240: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+00033250: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00033260: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00033270: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00033280: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00033290: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000332a0: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+000332b0: 2046 6c75 6964 7374 6163 6b20 6861 7320   Fluidstack has 
+000332c0: 6c6f 7720 6176 6169 6c61 6269 6c69 7479  low availability
+000332d0: 2066 6f72 2054 3420 4750 5573 0a40 7079   for T4 GPUs.@py
+000332e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+000332f0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+00033300: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+00033310: 7570 706f 7274 2054 3420 4750 5573 0a64  upport T4 GPUs.d
+00033320: 6566 2074 6573 745f 6d75 6c74 6970 6c65  ef test_multiple
+00033330: 5f61 6363 656c 6572 6174 6f72 735f 756e  _accelerators_un
+00033340: 6f72 6465 7265 645f 7769 7468 5f64 6566  ordered_with_def
+00033350: 6175 6c74 2829 3a0a 2020 2020 6e61 6d65  ault():.    name
+00033360: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00033370: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00033380: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00033390: 276d 756c 7469 706c 652d 6163 6365 6c65  'multiple-accele
+000333a0: 7261 746f 7273 2d75 6e6f 7264 6572 6564  rators-unordered
+000333b0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000333c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000333d0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+000333e0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+000333f0: 6d6c 732f 7465 7374 5f6d 756c 7469 706c  mls/test_multipl
+00033400: 655f 6163 6365 6c65 7261 746f 7273 5f75  e_accelerators_u
+00033410: 6e6f 7264 6572 6564 5f77 6974 685f 6465  nordered_with_de
+00033420: 6661 756c 742e 7961 6d6c 272c 0a20 2020  fault.yaml',.   
+00033430: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00033440: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00033450: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00033460: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00033470: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+00033480: 2066 2773 6b79 2073 7461 7475 7320 7b6e   f'sky status {n
+00033490: 616d 657d 207c 2067 7265 7020 5370 6f74  ame} | grep Spot
+000334a0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+000334b0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+000334c0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+000334d0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+000334e0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+000334f0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+00033500: 6473 7461 636b 2020 2320 5265 7175 6972  dstack  # Requir
+00033510: 6573 206f 7468 6572 2063 6c6f 7564 7320  es other clouds 
+00033520: 746f 2062 6520 656e 6162 6c65 640a 6465  to be enabled.de
+00033530: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
+00033540: 7265 736f 7572 6365 7328 293a 0a20 2020  resources():.   
+00033550: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00033560: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00033570: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00033580: 2020 2020 2027 6d75 6c74 6970 6c65 2d72       'multiple-r
+00033590: 6573 6f75 7263 6573 272c 0a20 2020 2020  esources',.     
+000335a0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+000335b0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+000335c0: 202d 6320 7b6e 616d 657d 2074 6573 7473   -c {name} tests
+000335d0: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
+000335e0: 5f6d 756c 7469 706c 655f 7265 736f 7572  _multiple_resour
+000335f0: 6365 732e 7961 6d6c 272c 0a20 2020 2020  ces.yaml',.     
+00033600: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00033610: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00033620: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00033630: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00033640: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+00033650: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00033660: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00033670: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00033680: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00033690: 2d2d 2d2d 2d2d 2d2d 2053 6b79 2042 656e  -------- Sky Ben
+000336a0: 6368 6d61 726b 202d 2d2d 2d2d 2d2d 2d2d  chmark ---------
+000336b0: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
+000336c0: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
+000336d0: 5265 7175 6972 6573 206f 7468 6572 2063  Requires other c
+000336e0: 6c6f 7564 7320 746f 2062 6520 656e 6162  louds to be enab
+000336f0: 6c65 640a 4070 7974 6573 742e 6d61 726b  led.@pytest.mark
+00033700: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
+00033710: 2320 5265 7175 6972 6573 206f 7468 6572  # Requires other
+00033720: 2063 6c6f 7564 7320 746f 2062 6520 656e   clouds to be en
+00033730: 6162 6c65 640a 4070 7974 6573 742e 6d61  abled.@pytest.ma
+00033740: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00033750: 0a64 6566 2074 6573 745f 736b 795f 6265  .def test_sky_be
+00033760: 6e63 6828 6765 6e65 7269 635f 636c 6f75  nch(generic_clou
+00033770: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+00033780: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00033790: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+000337a0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+000337b0: 2027 736b 792d 6265 6e63 6827 2c0a 2020   'sky-bench',.  
+000337c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000337d0: 2020 2020 6627 736b 7920 6265 6e63 6820      f'sky bench 
+000337e0: 6c61 756e 6368 202d 7920 2d62 207b 6e61  launch -y -b {na
+000337f0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00033800: 6572 6963 5f63 6c6f 7564 7d20 2d69 3020  eric_cloud} -i0 
+00033810: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00033820: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00033830: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00033840: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
+00033850: 2020 2020 2066 2773 6b79 2062 656e 6368       f'sky bench
+00033860: 2073 686f 7720 7b6e 616d 657d 207c 2067   show {name} | g
+00033870: 7265 7020 736b 792d 6265 6e63 682d 7b6e  rep sky-bench-{n
+00033880: 616d 657d 207c 2067 7265 7020 4649 4e49  ame} | grep FINI
+00033890: 5348 4544 272c 0a20 2020 2020 2020 205d  SHED',.        ]
+000338a0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+000338b0: 6265 6e63 6820 646f 776e 207b 6e61 6d65  bench down {name
+000338c0: 7d20 2d79 3b20 736b 7920 6265 6e63 6820  } -y; sky bench 
+000338d0: 6465 6c65 7465 207b 6e61 6d65 7d20 2d79  delete {name} -y
+000338e0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+000338f0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
```

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_spot_serve.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_spot_serve.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_storage.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_wheels.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20240406/tests/test_yaml_parser.py` & `skypilot-nightly-1.0.0.dev20240407/tests/test_yaml_parser.py`

 * *Files identical despite different names*

